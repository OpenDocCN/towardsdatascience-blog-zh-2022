<html>
<head>
<title>Deploy Cloud Functions on GCP with Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform在GCP上部署云功能</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploy-cloud-functions-on-gcp-with-terraform-111a1c4a9a88#2022-01-21">https://towardsdatascience.com/deploy-cloud-functions-on-gcp-with-terraform-111a1c4a9a88#2022-01-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""><h1 id="b2ec" class="pw-post-title ir is it bd iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp bi translated">使用Terraform在GCP上部署云功能</h1></div><div class=""><h2 id="3ca6" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在本教程中，您将使用Terraform部署一个由云存储事件触发的简单云功能</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/169b1e95c99705a9e4a046ce39e55708.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wcwFOWKmhINgS0cK2eIn6A.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由<a class="ae ky" href="https://pixabay.com/users/geralt-9301/" rel="noopener ugc nofollow" target="_blank">geralt</a><strong class="bd kz">|</strong><a class="ae ky" href="https://pixabay.com/illustrations/smartphone-control-city-industry-4-6265047/" rel="noopener ugc nofollow" target="_blank">Pixabay</a>提供</p></figure><p id="f72f" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated"><a class="ae ky" href="https://cloud.google.com/functions/docs/writing" rel="noopener ugc nofollow" target="_blank"> <strong class="lc iu">云功能</strong> </a>是可扩展的“现收现付”功能即服务(FaaS)来自<a class="ae ky" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank">谷歌云平台</a> (GCP)运行您的代码，无需服务器管理。</p><p id="f47a" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">云函数可以用<a class="ae ky" href="https://nodejs.org/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>，<a class="ae ky" href="https://python.org/" rel="noopener ugc nofollow" target="_blank"> Python </a>，<a class="ae ky" href="https://golang.org/" rel="noopener ugc nofollow" target="_blank"> Go </a>，<a class="ae ky" href="https://www.java.com/" rel="noopener ugc nofollow" target="_blank"> Java </a>，<a class="ae ky" href="https://dotnet.microsoft.com/languages" rel="noopener ugc nofollow" target="_blank">编写。NET </a>、<a class="ae ky" href="https://www.ruby-lang.org/en/" rel="noopener ugc nofollow" target="_blank"> Ruby </a>和<a class="ae ky" href="https://www.php.net/" rel="noopener ugc nofollow" target="_blank"> PHP </a>编程语言。为了可读性，本教程将包含一个用<strong class="lc iu"> Python </strong>编写的云函数。但是请随意选择您喜欢的编程语言。</p><p id="8dc5" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated"><a class="ae ky" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="lc iu"> Terraform </strong> </a>是一款基础设施即代码(IaC)开发工具，允许您安全、可重复且高效地构建、更改和版本化基础设施。它将云API(GCP、AWS、Azure等)编译成声明性的配置文件。</p><p id="1fc3" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在本教程结束时，你将有一个云功能，一旦一个文件被上传到谷歌云存储桶触发。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="3ccc" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">先决条件</h1><p id="49f6" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">要学习本教程，您需要:</p><ul class=""><li id="92aa" class="na nb it lc b ld le lg lh lj nc ln nd lr ne lv nf ng nh ni bi translated">在你的本地机器上安装了。</li><li id="d491" class="na nb it lc b ld nj lg nk lj nl ln nm lr nn lv nf ng nh ni bi translated"><a class="ae ky" href="https://cloud.google.com/sdk/docs/install" rel="noopener ugc nofollow" target="_blank"> Google Cloud SDK在你的本地机器上安装了</a>。</li><li id="d48b" class="na nb it lc b ld nj lg nk lj nl ln nm lr nn lv nf ng nh ni bi translated">一个<a class="ae ky" href="https://cloud.google.com/resource-manager/docs/creating-managing-projects" rel="noopener ugc nofollow" target="_blank">谷歌云平台项目</a>建立并附属于一个<a class="ae ky" href="https://cloud.google.com/billing/docs/how-to/modify-project" rel="noopener ugc nofollow" target="_blank">计费账户</a>。确保云函数<a class="ae ky" href="https://cloud.google.com/service-usage/docs/enable-disable" rel="noopener ugc nofollow" target="_blank"> API已启用</a>。</li></ul><p id="8555" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">然后，您可以在您的终端中运行<code class="fe no np nq nr b">gcloud auth application-default login</code>的本地机器上通过GCP认证。</p><h1 id="c478" class="md me it bd mf mg ns mi mj mk nt mm mn jz nu ka mp kc nv kd mr kf nw kg mt mu bi translated">目标</h1><p id="2e6f" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">本教程的目标是使用Terraform在GCP项目中进行部署:</p><ul class=""><li id="2f05" class="na nb it lc b ld le lg lh lj nc ln nd lr ne lv nf ng nh ni bi translated">上传文件的桶。</li><li id="79aa" class="na nb it lc b ld nj lg nk lj nl ln nm lr nn lv nf ng nh ni bi translated">一个存储云函数源代码的桶。</li><li id="ff23" class="na nb it lc b ld nj lg nk lj nl ln nm lr nn lv nf ng nh ni bi translated">每次将文件上传到第一个存储桶时触发的云函数，其源代码在第二个存储桶中。</li></ul></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="667f" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">项目结构</h1><p id="3a22" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">您可以创建一个新文件夹，我将它命名为<code class="fe no np nq nr b">cloud_function_project</code>，但是请随意选择一个对您来说方便的名称。</p><p id="4ad7" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">然后创建如下定义的文件。暂时将它们留空，随着教程的继续，您将完成它们。</p><pre class="kj kk kl km gt nx nr ny nz aw oa bi"><span id="8efa" class="ob me it nr b gy oc od l oe of">.cloud_function_project/<br/>│<!-- --> <br/>├── terraform/<br/>│    │<br/>│    ├── backend.tf<br/>│    ├── function.tf<br/>│    ├── main.tf<br/>│    ├── storage.tf<br/>│    └── variables.tf<br/>│<br/>└── src/<br/>     │<br/>     ├── main.py<!-- --> <br/>  <!-- -->   └── requirements.txt</span></pre><p id="8774" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在您开始归档不同的文件之前，我们将快速浏览一下每个文件的作用。</p><p id="ad63" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated"><code class="fe no np nq nr b">src</code>文件夹包含云函数的源代码。它是Python特有的结构。</p><ul class=""><li id="6709" class="na nb it lc b ld le lg lh lj nc ln nd lr ne lv nf ng nh ni bi translated"><code class="fe no np nq nr b">main.py</code>:云函数的源代码。</li><li id="8178" class="na nb it lc b ld nj lg nk lj nl ln nm lr nn lv nf ng nh ni bi translated"><code class="fe no np nq nr b">requirements.txt</code>:运行<code class="fe no np nq nr b">main.py</code>需要的python库列表。(在本教程中您不需要它)</li></ul><p id="d844" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated"><code class="fe no np nq nr b">terraform</code>文件夹包含要部署的环境的配置文件。</p><ul class=""><li id="62ef" class="na nb it lc b ld le lg lh lj nc ln nd lr ne lv nf ng nh ni bi translated"><code class="fe no np nq nr b">backend.tf</code>:声明<a class="ae ky" href="https://www.terraform.io/language/settings/backends" rel="noopener ugc nofollow" target="_blank">地形后端</a>。</li><li id="8174" class="na nb it lc b ld nj lg nk lj nl ln nm lr nn lv nf ng nh ni bi translated"><code class="fe no np nq nr b">main.tf</code>:环境的主要声明。</li><li id="a20a" class="na nb it lc b ld nj lg nk lj nl ln nm lr nn lv nf ng nh ni bi translated"><code class="fe no np nq nr b">variables.tf</code>:变量的定义。</li><li id="2478" class="na nb it lc b ld nj lg nk lj nl ln nm lr nn lv nf ng nh ni bi translated"><code class="fe no np nq nr b">storage.tf</code>:Google云存储桶的声明。</li><li id="c25b" class="na nb it lc b ld nj lg nk lj nl ln nm lr nn lv nf ng nh ni bi translated"><code class="fe no np nq nr b">function.tf</code>:云函数声明。</li></ul></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="628e" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">创建云函数</h1><p id="0cbd" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">编写和运行云函数不是本教程的重要部分。您将部署一个函数，该函数将记录一些关于已经上传到bucket中的文件的有用信息，以便进行跟踪。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure><blockquote class="oi oj ok"><p id="2c68" class="la lb ol lc b ld le ju lf lg lh jx li om lk ll lm on lo lp lq oo ls lt lu lv im bi translated"><strong class="lc iu">注意:</strong>该功能没有需求，所以<code class="fe no np nq nr b">requirements.txt</code>为空。<br/> <strong class="lc iu">注意:</strong>这是一个Python云函数，所以你可以根据你选择的编程语言改变代码源。</p></blockquote></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="b644" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">创建地形基础设施</h1><h2 id="cead" class="ob me it bd mf op oq dn mj or os dp mn lj ot ou mp ln ov ow mr lr ox oy mt oz bi translated">后端</h2><p id="f963" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">通过指定Terraform后端开始声明您的环境。您可以选择<code class="fe no np nq nr b"><a class="ae ky" href="https://www.terraform.io/language/settings/backends/local" rel="noopener ugc nofollow" target="_blank">local</a></code>，这意味着所有的状态文件都将存储在本地目录中。你也可以选择一个<code class="fe no np nq nr b"><a class="ae ky" href="https://www.terraform.io/language/settings/backends/gcs" rel="noopener ugc nofollow" target="_blank">gcs</a></code>后端，但是让我们保持简单。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure><h2 id="6ecb" class="ob me it bd mf op oq dn mj or os dp mn lj ot ou mp ln ov ow mr lr ox oy mt oz bi translated">变量</h2><p id="a119" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">声明Terraform文件中使用的变量。您需要根据您想要在其中部署资源的项目的ID来更改<code class="fe no np nq nr b">project_id</code>变量。当然，你也可以更换<code class="fe no np nq nr b">region</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure><h2 id="b3ae" class="ob me it bd mf op oq dn mj or os dp mn lj ot ou mp ln ov ow mr lr ox oy mt oz bi translated">主要的</h2><p id="05cd" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">声明与google <a class="ae ky" href="https://www.terraform.io/language/providers" rel="noopener ugc nofollow" target="_blank">提供者</a>的连接。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure><h2 id="340c" class="ob me it bd mf op oq dn mj or os dp mn lj ot ou mp ln ov ow mr lr ox oy mt oz bi translated">谷歌云存储</h2><p id="17e0" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">声明两个Google云存储桶，分别存储云函数的代码和上传文件。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure><blockquote class="oi oj ok"><p id="c5b9" class="la lb ol lc b ld le ju lf lg lh jx li om lk ll lm on lo lp lq oo ls lt lu lv im bi translated"><strong class="lc iu">注意:</strong>桶名以<code class="fe no np nq nr b">project_id</code>为前缀，因为桶必须有唯一的名称。</p></blockquote><h2 id="2a5d" class="ob me it bd mf op oq dn mj or os dp mn lj ot ou mp ln ov ow mr lr ox oy mt oz bi translated">谷歌云功能</h2><p id="f8ee" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">最后一步:声明云函数。这需要将源代码压缩成zip文件，并上传到bucket中进行存储。然后在用Terraform创建云函数时可以访问源代码。</p><blockquote class="oi oj ok"><p id="a238" class="la lb ol lc b ld le ju lf lg lh jx li om lk ll lm on lo lp lq oo ls lt lu lv im bi translated"><strong class="lc iu">注意:</strong>文件有点长，所以可以随意查看注释来理解逻辑。</p></blockquote><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="9047" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">部署环境</h1><p id="9405" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">一切准备就绪，可以部署了。在您的终端中找到项目的根目录，然后找到<code class="fe no np nq nr b">terraform</code>文件夹的根目录。</p><pre class="kj kk kl km gt nx nr ny nz aw oa bi"><span id="2238" class="ob me it nr b gy oc od l oe of">$ cd ./terraform</span></pre><p id="42d7" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">初始化您的代码以下载代码中提到的需求。</p><pre class="kj kk kl km gt nx nr ny nz aw oa bi"><span id="59af" class="ob me it nr b gy oc od l oe of">$ terraform init</span></pre><p id="517c" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">查看更改。</p><pre class="kj kk kl km gt nx nr ny nz aw oa bi"><span id="e0b8" class="ob me it nr b gy oc od l oe of">$ terraform plan</span></pre><p id="c699" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">接受变更并将其应用于实际的基础设施。</p><pre class="kj kk kl km gt nx nr ny nz aw oa bi"><span id="f34e" class="ob me it nr b gy oc od l oe of">$ terraform apply</span></pre></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="0c0e" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">测试您的云功能</h1><p id="bde4" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">测试一切工作正常:</p><ul class=""><li id="2315" class="na nb it lc b ld le lg lh lj nc ln nd lr ne lv nf ng nh ni bi translated">打开<a class="ae ky" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">谷歌云控制台</a>并连接到你的项目。</li><li id="d79e" class="na nb it lc b ld nj lg nk lj nl ln nm lr nn lv nf ng nh ni bi translated">进入<a class="ae ky" href="https://console.cloud.google.com/storage/browser" rel="noopener ugc nofollow" target="_blank">谷歌云存储浏览器</a>。</li><li id="c7e2" class="na nb it lc b ld nj lg nk lj nl ln nm lr nn lv nf ng nh ni bi translated">您可以看到<code class="fe no np nq nr b">&lt;YOUR-PROJECT-ID&gt;-function</code>和<code class="fe no np nq nr b">&lt;YOUR-PROJECT-ID&gt;-input</code>铲斗。点击名为<code class="fe no np nq nr b">&lt;YOUR-PROJECT-ID&gt;-input</code>的桶，将任意文件上传到其中，触发云功能。</li><li id="3cf7" class="na nb it lc b ld nj lg nk lj nl ln nm lr nn lv nf ng nh ni bi translated">要验证它是否有效，请访问您的<a class="ae ky" href="https://console.cloud.google.com/functions/list" rel="noopener ugc nofollow" target="_blank">云功能列表</a>。这里应该有一个名为<code class="fe no np nq nr b">function-trigger-on-gcs</code>的云函数。点击它的名称并转到<code class="fe no np nq nr b">LOGS</code>选项卡，查看它是由您上传的文件触发的。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pa"><img src="../Images/a41213d2ce618721d92c099fba464fc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eGtKKRvZfNm6mIdQlVXisA.png"/></div></div></figure><blockquote class="oi oj ok"><p id="cd08" class="la lb ol lc b ld le ju lf lg lh jx li om lk ll lm on lo lp lq oo ls lt lu lv im bi translated"><strong class="lc iu">知识就是分享。</strong> <br/> <strong class="lc iu">支持</strong>我，一键获取<a class="ae ky" href="https://axel-thevenot.medium.com/membership" rel="noopener"> <strong class="lc iu">中我所有文章的<strong class="lc iu">访问</strong>。</strong></a></p></blockquote><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pa"><img src="../Images/94e903d7d66ff043ca9645dbc42c33bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y7Q5U2MjIji7pvt6DRzq3A.png"/></div></div></figure><h1 id="a94a" class="md me it bd mf mg ns mi mj mk nt mm mn jz nu ka mp kc nv kd mr kf nw kg mt mu bi translated">更进一步</h1><p id="8e41" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">我希望你喜欢这篇部署云功能的简短教程。可以应用许多改进。您可以:</p><ul class=""><li id="2630" class="na nb it lc b ld le lg lh lj nc ln nd lr ne lv nf ng nh ni bi translated">设置一个<a class="ae ky" href="https://cloud.google.com/iam/docs/policies" rel="noopener ugc nofollow" target="_blank"> IAM策略</a>。</li><li id="2c4e" class="na nb it lc b ld nj lg nk lj nl ln nm lr nn lv nf ng nh ni bi translated">添加变量并将该代码转换成可重复使用的<a class="ae ky" href="https://learn.hashicorp.com/tutorials/terraform/module" rel="noopener ugc nofollow" target="_blank">地形模块</a>。</li><li id="2a79" class="na nb it lc b ld nj lg nk lj nl ln nm lr nn lv nf ng nh ni bi translated">将部署集成到<a class="ae ky" href="https://cloud.google.com/build" rel="noopener ugc nofollow" target="_blank">云构建</a>流程中，以实现持续部署。</li><li id="5eec" class="na nb it lc b ld nj lg nk lj nl ln nm lr nn lv nf ng nh ni bi translated">还有很多…</li></ul></div></div>    
</body>
</html>