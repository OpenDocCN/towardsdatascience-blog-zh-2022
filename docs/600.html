<html>
<head>
<title>End-to-End BigQuery Machine Learning</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">端到端BigQuery机器学习</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/end-to-end-bigquery-machine-learning-e7e6e2e83b34#2022-01-20">https://towardsdatascience.com/end-to-end-bigquery-machine-learning-e7e6e2e83b34#2022-01-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""><h1 id="cba7" class="pw-post-title ir is it bd iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp bi translated">端到端BigQuery机器学习</h1></div><div class=""><h2 id="6b28" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用Google Cloud BigQuery参加Kaggle竞赛</h2></div><p id="ce65" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我将向您展示如何仅使用BigQuery和Kaggle API 来预测泰坦尼克号灾难<strong class="kk iu">的幸存者。自从我遇到BigQuery，我就成了它的粉丝。它很容易使用，超级快，超级便宜——如果你用得好的话…</strong></p><p id="e9a0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">它不仅可以进行Pb级的复杂分析，还可以运行一些机器学习模型，所有这些都来自SQL。我不建议你对所有的工作都这样做，但对于某些任务，<strong class="kk iu"> BigQuery是机器学习的理想选择，因为它的语法简单，成本低</strong>，而且因为它是一个<strong class="kk iu">完全托管的服务</strong>，你不需要担心它在哪里运行或者如何运行。</p><p id="79ad" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将执行以下操作:</p><ol class=""><li id="b991" class="le lf it kk b kl km ko kp kr lg kv lh kz li ld lj lk ll lm bi translated">使用CLI工具从Kaggle下载数据集</li><li id="52dc" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld lj lk ll lm bi translated">将其作为BigQuery表上传</li><li id="f6cf" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld lj lk ll lm bi translated">将数据分为训练和测试</li><li id="eaa4" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld lj lk ll lm bi translated">训练逻辑回归模型</li><li id="0cc9" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld lj lk ll lm bi translated">向Kaggle提交预测</li><li id="df01" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld lj lk ll lm bi translated">在竞争中获得第一名——可能不会😅</li></ol><blockquote class="ls"><p id="4b48" class="lt lu it bd lv lw lx ly lz ma mb ld dk translated">要获得所有媒体文章的完整信息，包括我的文章，请考虑在此订阅<a class="ae mc" href="https://niczky12.medium.com/membership" rel="noopener"/>。</p></blockquote><h1 id="178c" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">准备好</h1><figure class="mw mx my mz gt na gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi mv"><img src="../Images/90d902cf95c3ff44895ae95e9815ad64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2Zb_Ip_jrcNSF55cbPGBHA.jpeg"/></div></div><p class="nh ni gj gh gi nj nk bd b be z dk translated">杰里米·贝赞格在<a class="ae mc" href="https://unsplash.com/s/photos/install?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="5dab" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">既然我们将使用BigQuery，为什么需要安装任何东西呢？你所需要的只是一个<strong class="kk iu">浏览器和一个谷歌账户</strong>——哦，还有鼠标和键盘，你仍然需要做一些打字工作！</p><p id="e6b1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">第一步是登录<a class="ae mc" href="https://colab.research.google.com" rel="noopener ugc nofollow" target="_blank"> Google Colab </a>。这是谷歌的一项免费服务，你可以在云端运行一些笔记本。我们将使用它从Kaggle获取数据——是的，您需要一个帐户——并调用Google Cloud APIs与BigQuery进行交互。</p><p id="8074" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，您需要Kaggle API密钥。查看文档<a class="ae mc" href="https://www.kaggle.com/docs/api" rel="noopener ugc nofollow" target="_blank">的<code class="fe nl nm nn no b">Authentication</code>部分，这里是</a>关于如何获得带有密钥的json文件。我们会将这些上传到collab:</p><figure class="mw mx my mz gt na"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="bba3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在Colab中运行这段代码后，您会看到一个弹出按钮，要求上传文件。确保选择从Kaggle下载的<code class="fe nl nm nn no b">kaggle.json</code>文件。</p><p id="9b4b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">嘿，很快，你可以使用Kaggle命令行界面:</p><figure class="mw mx my mz gt na gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nr"><img src="../Images/11af8b74839130080a4659d7feb7e1df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xfhkpS5YsU4o2AAqHya5NQ.png"/></div></div><p class="nh ni gj gh gi nj nk bd b be z dk translated">作者截图</p></figure><p id="37ac" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们还需要<strong class="kk iu">向Google Cloud </strong>认证我们的Google Colab会话。如果我们想使用BigQuery，这是必要的。幸运的是，已经预装了一个超级简单的助手库:</p><figure class="mw mx my mz gt na"><div class="bz fp l di"><div class="np nq l"/></div><p class="nh ni gj gh gi nj nk bd b be z dk translated">请按照屏幕上的指示操作</p></figure><p id="9583" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果我们能够调用一些BigQuery神奇的函数并引用正确的项目id，那也是很有帮助的:</p><figure class="mw mx my mz gt na"><div class="bz fp l di"><div class="np nq l"/></div></figure><blockquote class="ns nt nu"><p id="021b" class="ki kj nv kk b kl km ju kn ko kp jx kq nw ks kt ku nx kw kx ky ny la lb lc ld im bi translated">❗️如果你不确定如何在BigQuery中创建数据集，请查看这篇文章。</p></blockquote><p id="cbf9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">安装完成！✅</p><h1 id="9ec2" class="md me it bd mf mg mh mi mj mk ml mm mn jz nz ka mp kc oa kd mr kf ob kg mt mu bi translated">获取一些数据</h1><p id="bbd5" class="pw-post-body-paragraph ki kj it kk b kl oc ju kn ko od jx kq kr oe kt ku kv of kx ky kz og lb lc ld im bi translated">现在我们在云端有了一台电脑，接入了Google Cloud，还有Kaggle的API，但是我们<strong class="kk iu">在BigQuery里还是没有数据。</strong>我们如何将Kaggle的数据导入BigQuery？当然是通过调用Kaggle API。下面几行代码将下载<code class="fe nl nm nn no b">titanic</code>数据集，并将其作为csv文件保存在我们的Colab机器上。有关数据集的更多信息，请查看Kaggle 上的<a class="ae mc" href="https://www.kaggle.com/c/titanic/data" rel="noopener ugc nofollow" target="_blank">细节。我们还可以使用Pandas的<code class="fe nl nm nn no b">to_gbq()</code>将文件作为表格上传到BigQuery。</a></p><figure class="mw mx my mz gt na"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="1bec" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以使用<code class="fe nl nm nn no b">%%bigquery</code> ipython魔术直接从Colab查询BigQuery。</p><figure class="mw mx my mz gt na"><div class="bz fp l di"><div class="np nq l"/></div></figure><figure class="mw mx my mz gt na gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi oh"><img src="../Images/87b2a92bb401aa0af2e0f5d48e48f75c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OPw9oUGDBJmNC4ocfANg_w.png"/></div></div><p class="nh ni gj gh gi nj nk bd b be z dk translated">作者截图</p></figure><p id="cd49" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">不要忘记<strong class="kk iu">也保存测试数据</strong>，这是我们将要做的预测:</p><figure class="mw mx my mz gt na"><div class="bz fp l di"><div class="np nq l"/></div></figure><h1 id="ae00" class="md me it bd mf mg mh mi mj mk ml mm mn jz nz ka mp kc oa kd mr kf ob kg mt mu bi translated">分割数据集</h1><figure class="mw mx my mz gt na gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi oi"><img src="../Images/d7179b405d3f7e4b2fa49a53f52d020a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*37paUA_5LNTWQG4isLA_Mg.jpeg"/></div></div><p class="nh ni gj gh gi nj nk bd b be z dk translated">照片由<a class="ae mc" href="https://unsplash.com/@jo_coenen?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">乔·科恩拍摄——工作室在<a class="ae mc" href="https://unsplash.com/s/photos/split?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上干燥2.6 </a></p></figure><p id="b7c0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">任何像样的ML书籍或课程都会告诉你应该将数据分成训练和测试数据集(你也可以为超参数调整做一个评估集)。用Python做到这一点很容易。你抓取sklearn，然后做一个<code class="fe nl nm nn no b">train_test_split()</code>，它甚至保持两个数据集的类标签分布相同。为了在BigQuery 中做到这一点，我们需要一些技巧，但不要太复杂。</p><p id="376b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，我们需要创建一个<strong class="kk iu">可重复的随机排序</strong>。我已经写了<a class="ae mc" rel="noopener" target="_blank" href="/advanced-random-sampling-in-bigquery-sql-7d4483b580bb">关于这个</a>，但是主要结论是<code class="fe nl nm nn no b">FARM_FINGERPRINT</code>是你的朋友。如果你需要一个不同的种子，在把它们传递给函数之前，先把你的字符串加盐，也就是说，给你散列的每个id添加一个字符串。这里有一个例子:</p><figure class="mw mx my mz gt na"><div class="bz fp l di"><div class="np nq l"/></div></figure><figure class="mw mx my mz gt na gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/8a0e2be18b7fbf2b2b83e5d32f5b8f70.png" data-original-src="https://miro.medium.com/v2/resize:fit:964/format:webp/1*y1x5Z6AQuQdSRfrdwt4BLQ.png"/></div><p class="nh ni gj gh gi nj nk bd b be z dk translated">作者截图</p></figure><p id="1951" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">正如您所看到的，对于相同的输入，我们得到相同的散列，并且我们可以通过添加不同的salt字符串来得到新的散列。这对我们的乘客点餐来说再好不过了。</p><p id="f7b7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">❗️如果您需要复习BigQuery中的采样，请查看这篇文章:</p><div class="ok ol gp gr om on"><a rel="noopener follow" target="_blank" href="/advanced-random-sampling-in-bigquery-sql-7d4483b580bb"><div class="oo ab fo"><div class="op ab oq cl cj or"><h2 class="bd iu gy z fp os fr fs ot fu fw is bi translated">BigQuery SQL中的高级随机采样</h2><div class="ou l"><h3 class="bd b gy z fp os fr fs ot fu fw dk translated">了解如何以可重现的方式对BigQuery表中的行进行采样</h3></div><div class="ov l"><p class="bd b dl z fp os fr fs ot fu fw dk translated">towardsdatascience.com</p></div></div><div class="ow l"><div class="ox l oy oz pa ow pb nf on"/></div></div></a></div><p id="abdb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们需要挑选80%的幸存乘客和80%的死亡乘客进入我们的训练集。其他人都将在测试集中结束。我们可以通过使用<code class="fe nl nm nn no b">PERCENTILE_CONT</code>分析功能来实现。这个<strong class="kk iu">将我们的散列整数转换成百分位数</strong>，所以如果这个百分位数小于0.80，那么就意味着你是前80%乘客中的一员。</p><p id="664a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">以下是完整的问题，包括两个步骤——如果有不清楚的地方，请在评论中提问:</p><figure class="mw mx my mz gt na"><div class="bz fp l di"><div class="np nq l"/></div></figure><figure class="mw mx my mz gt na gh gi paragraph-image"><div class="gh gi pc"><img src="../Images/505ee5f211a67c9b52ec10eae347006c.png" data-original-src="https://miro.medium.com/v2/resize:fit:500/format:webp/1*XcCLBCnIMxn7ui-aPcQg4A.png"/></div><p class="nh ni gj gh gi nj nk bd b be z dk translated">作者截图</p></figure><p id="f212" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">感觉检查:110 / (110 + 439) ≈ 0.2 ✅</p><p id="f96b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们将新数据集保存到两个分区中，一个用于训练，一个用于测试:</p><figure class="mw mx my mz gt na"><div class="bz fp l di"><div class="np nq l"/></div></figure><blockquote class="ns nt nu"><p id="8b8a" class="ki kj nv kk b kl km ju kn ko kp jx kq nw ks kt ku nx kw kx ky ny la lb lc ld im bi translated">请注意，我们可以为<a class="ae mc" href="https://googleapis.dev/python/bigquery/latest/magics.html#module-google.cloud.bigquery.magics.magics" rel="noopener ugc nofollow" target="_blank"> BigQuery magic </a>使用<code class="fe nl nm nn no b">--destination_table</code>参数，但是我们不能指定分区范围。或者，我们可以使用<a class="ae mc" href="https://googleapis.dev/python/bigquery/latest/generated/google.cloud.bigquery.job.QueryJob.html#google-cloud-bigquery-job-queryjob" rel="noopener ugc nofollow" target="_blank"> BigQuery Python SDK </a>将结果保存为表格。</p></blockquote><p id="50c3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nl nm nn no b">partition by</code>子句是一个巧妙的技巧，它将我们的训练集从测试集中分离出来并节省资金。基本上，如果你通过过滤<code class="fe nl nm nn no b">isTrain</code>来查询这个表，那么BigQuery会知道不同分区的确切位置，并且你只需要为你选择的分区付费。您可以通过跳转到BigQuery UI并查看查询大小估计来确认这一点:</p><figure class="mw mx my mz gt na gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi pd"><img src="../Images/6e383e5d06cb9a7a7027e1fd976de93d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*3flz5ZoAw7KElOeMuHwuRg.gif"/></div></div><p class="nh ni gj gh gi nj nk bd b be z dk translated">注意右上角不断变化的KiBs作者截屏</p></figure><blockquote class="ns nt nu"><p id="e7ef" class="ki kj nv kk b kl km ju kn ko kp jx kq nw ks kt ku nx kw kx ky ny la lb lc ld im bi translated">💰对于较大的数据集，这个技巧可以让你在较小的数据集上进行训练，而不需要两个不同的表，从而为你节省很多钱。</p></blockquote><h1 id="5abc" class="md me it bd mf mg mh mi mj mk ml mm mn jz nz ka mp kc oa kd mr kf ob kg mt mu bi translated">逻辑回归</h1><figure class="mw mx my mz gt na gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi pe"><img src="../Images/be15bd2655f56f06fb5251a8d39eda26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IY7IxRo2W_Ysr0wQ18q6Yw.jpeg"/></div></div><p class="nh ni gj gh gi nj nk bd b be z dk translated">训练时间到了！—<a class="ae mc" href="https://unsplash.com/@karsten116?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">karst en wine geart</a>在<a class="ae mc" href="https://unsplash.com/s/photos/training?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="d924" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在是时候训练一些模型了。我们将从训练一个逻辑回归模型开始，我将尽力解释所有的参数。由于这仍然是BQ，我们<strong class="kk iu">需要一些SQL来创建一个新的模型对象</strong>:</p><figure class="mw mx my mz gt na"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="b33c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是一步步发生的事情:</p><ul class=""><li id="7ca8" class="le lf it kk b kl km ko kp kr lg kv lh kz li ld pf lk ll lm bi translated">我们的模型将被称为<code class="fe nl nm nn no b">ds.titanic_baseline</code>。请注意，这看起来与任何其他表名完全一样</li><li id="7d0d" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld pf lk ll lm bi translated"><code class="fe nl nm nn no b">OPTIONS</code>会告诉BQ创建什么模型，标签是什么等。</li><li id="6626" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld pf lk ll lm bi translated"><code class="fe nl nm nn no b">SELECT</code>将告诉BQ从哪个数据集训练模型。我们基本上是从准备好的表中选择所有的东西，减去<code class="fe nl nm nn no b">passengerid</code>，并且我们也将<code class="fe nl nm nn no b">isTrain</code>转换为布尔值，因为我们将在该列上分割我们的训练集和测试集。</li></ul><p id="986f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在<code class="fe nl nm nn no b">OPTIONS</code>里面发生了很多事情:</p><ul class=""><li id="aedc" class="le lf it kk b kl km ko kp kr lg kv lh kz li ld pf lk ll lm bi translated"><code class="fe nl nm nn no b">MODEL_TYPE</code>告诉BQ使用什么型号系列。这可以是逻辑回归、线性回归、k均值聚类、时间序列模型、提升树甚至AutoML。<a class="ae mc" href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-e2e-journey" rel="noopener ugc nofollow" target="_blank">此处阅读更多内容</a>。</li><li id="35f6" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld pf lk ll lm bi translated"><code class="fe nl nm nn no b">INPUT_LABEL_COLS</code>是包含我们标签的列的列表。在我们的例子中，这告诉我们谁幸存，谁没有。</li><li id="baac" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld pf lk ll lm bi translated"><code class="fe nl nm nn no b">DATA_SPLIT_METHOD</code>和<code class="fe nl nm nn no b">DATA_SPLIT_COLS</code>齐头并进。我们想自己拆分数据，为此我们使用了<code class="fe nl nm nn no b">isTrain</code>列。</li><li id="0400" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld pf lk ll lm bi translated"><code class="fe nl nm nn no b">EARLY_STOP</code>如果测试集(isTrain = 0)误差没有减少，告诉BQ停止训练。</li><li id="8db7" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld pf lk ll lm bi translated"><code class="fe nl nm nn no b">L2_REG</code>是我们模型的L2正则化参数。这有助于我们不过度拟合数据。随意尝试不同的值，找到最适合自己的模型。</li></ul><p id="fae7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">训练完模型后，您可以<strong class="kk iu">进入BigQuery UI </strong>并检查模型训练的情况:</p><figure class="mw mx my mz gt na gh gi paragraph-image"><div class="gh gi pg"><img src="../Images/db7ce3297e7a91d12ef8a0ec0b700dde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*c7gBKxXBO6FOUmhELTBOGQ.gif"/></div><p class="nh ni gj gh gi nj nk bd b be z dk translated">BigQuery UI模型训练—作者截屏</p></figure><blockquote class="ns nt nu"><p id="58ed" class="ki kj nv kk b kl km ju kn ko kp jx kq nw ks kt ku nx kw kx ky ny la lb lc ld im bi translated">一定要四处看看，因为那里有相当多的信息！</p></blockquote><h1 id="e2ac" class="md me it bd mf mg mh mi mj mk ml mm mn jz nz ka mp kc oa kd mr kf ob kg mt mu bi translated">臣服于Kaggle</h1><p id="0010" class="pw-post-body-paragraph ki kj it kk b kl oc ju kn ko od jx kq kr oe kt ku kv of kx ky kz og lb lc ld im bi translated">我们有了一个模型和一套测试设备，现在是<strong class="kk iu">打分的时候了，享受我们Kaggle提交的荣耀</strong>。</p><p id="770b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了给我们的测试集打分，我们需要<code class="fe nl nm nn no b">ML.PREDICT</code>方法。这将为数据集的每一行提供一个结构数组。是的，我知道<strong class="kk iu">结构数组</strong>，那是什么鬼东西，对吧？</p><p id="b05a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是为多类模型设计的，所以数组中每个标签有一个元素，然后标签作为结构的第一部分，预测概率作为第二部分。为了解开所有这些，我们需要在数组列上使用<code class="fe nl nm nn no b">CROSS JOIN</code>和<code class="fe nl nm nn no b">UNNEST</code>:</p><figure class="mw mx my mz gt na"><div class="bz fp l di"><div class="np nq l"/></div><p class="nh ni gj gh gi nj nk bd b be z dk translated">请务必阅读上面的评论，因为它们解释了正在发生的事情</p></figure><figure class="mw mx my mz gt na gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi ph"><img src="../Images/a479c97bd09a7054d983a214a2adf19c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eRaayGqF4BJLJlhHw7ZIPA.png"/></div></div><p class="nh ni gj gh gi nj nk bd b be z dk translated">如果一切顺利，我们应该会在最后得到一堆预测的“问题”——作者截图</p></figure><p id="b24c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Kaggle希望我们<strong class="kk iu">提交一个包含两列的csv文件</strong>——一列用于乘客id，一列用于预测类别(1或0)。因此，我们将选择一个阈值，我使用0.4，并将1分配给所有乘客，分配给高于该阈值的所有乘客，将0分配给其他所有人。我们可以使用Python的BigQuery客户端SDK来完成这项工作:</p><figure class="mw mx my mz gt na"><div class="bz fp l di"><div class="np nq l"/></div><p class="nh ni gj gh gi nj nk bd b be z dk translated">您还可以使用<a class="ae mc" href="https://googleapis.dev/python/bigquery/2.0.0/magics.html" rel="noopener ugc nofollow" target="_blank"> %%bigquery魔法来保存结果</a></p></figure><p id="1a91" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">剩下的就是把这个数据帧保存为csv格式，然后上传到Kaggle:</p><figure class="mw mx my mz gt na"><div class="bz fp l di"><div class="np nq l"/></div></figure><figure class="mw mx my mz gt na gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi pi"><img src="../Images/a96298b98a05d072f311566b362611e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JFu0gGMBcmErbrx3J20Mjw.png"/></div></div><p class="nh ni gj gh gi nj nk bd b be z dk translated">作者截图</p></figure><p id="603b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">以上给了我一个扎实的0.75作为比赛中的分数。这不是很好，但这是一个好的开始！</p><h1 id="ce13" class="md me it bd mf mg mh mi mj mk ml mm mn jz nz ka mp kc oa kd mr kf ob kg mt mu bi translated">越来越花哨</h1><figure class="mw mx my mz gt na gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi pj"><img src="../Images/6fc13ab0fe5bc932f3fe57c51239b474.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MJGRmYS-5G-jEdiyGHLrBA.jpeg"/></div></div><p class="nh ni gj gh gi nj nk bd b be z dk translated">加布里埃拉·克莱尔·马里诺在<a class="ae mc" href="https://unsplash.com/s/photos/fancy?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="65bc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">本教程到此结束，但是<strong class="kk iu">我邀请您尝试</strong>Google Cloud big query的更多特性。例如:</p><ul class=""><li id="c260" class="le lf it kk b kl km ko kp kr lg kv lh kz li ld pf lk ll lm bi translated">如果我们把L2正则化参数改成别的什么呢？</li><li id="b706" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld pf lk ll lm bi translated">我们能不能用<code class="fe nl nm nn no b">TRANSFORM</code>从这些栏目中创造出更多的特色，也许年龄应该分时段，或者票价应该有所不同？(<a class="ae mc" href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-preprocessing-functions" rel="noopener ugc nofollow" target="_blank">文档此处</a>)</li><li id="c98e" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld pf lk ll lm bi translated">如果我们用<strong class="kk iu">助推树</strong> : <code class="fe nl nm nn no b">MODEL_TYPE='BOOSTED_TREE_CLASSIFIER’</code>会怎么样？</li></ul><p id="9aff" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于其中的一些代码，请查看用于本文的<a class="ae mc" href="https://github.com/niczky12/medium/blob/master/tech/bigquery/ML_with_Google_BigQuery_Kaggle_Titanic_end_to_end.ipynb" rel="noopener ugc nofollow" target="_blank">笔记本。</a></p><blockquote class="ls"><p id="0e87" class="lt lu it bd lv lw pk pl pm pn po ld dk translated">感谢您花时间阅读本文！我主要写的是数据科学工具和Julia，所以如果你喜欢这篇文章，请随意订阅！</p></blockquote></div><div class="ab cl pp pq hx pr" role="separator"><span class="ps bw bk pt pu pv"/><span class="ps bw bk pt pu pv"/><span class="ps bw bk pt pu"/></div><div class="im in io ip iq"><div class="mw mx my mz gt on"><a rel="noopener follow" target="_blank" href="/loops-in-bigquery-db137e128d2d"><div class="oo ab fo"><div class="op ab oq cl cj or"><h2 class="bd iu gy z fp os fr fs ot fu fw is bi translated">BigQuery中的循环</h2><div class="ou l"><h3 class="bd b gy z fp os fr fs ot fu fw dk translated">了解如何使用BigQuery脚本来计算斐波那契数</h3></div><div class="ov l"><p class="bd b dl z fp os fr fs ot fu fw dk translated">towardsdatascience.com</p></div></div><div class="ow l"><div class="pw l oy oz pa ow pb nf on"/></div></div></a></div><div class="ok ol gp gr om on"><a rel="noopener follow" target="_blank" href="/load-files-faster-into-bigquery-94355c4c086a"><div class="oo ab fo"><div class="op ab oq cl cj or"><h2 class="bd iu gy z fp os fr fs ot fu fw is bi translated">将文件更快地加载到BigQuery中</h2><div class="ou l"><h3 class="bd b gy z fp os fr fs ot fu fw dk translated">针对摄取的CSV、GZIP、AVRO和拼花文件类型进行基准测试</h3></div><div class="ov l"><p class="bd b dl z fp os fr fs ot fu fw dk translated">towardsdatascience.com</p></div></div><div class="ow l"><div class="px l oy oz pa ow pb nf on"/></div></div></a></div><div class="ok ol gp gr om on"><a rel="noopener follow" target="_blank" href="/advanced-random-sampling-in-bigquery-sql-7d4483b580bb"><div class="oo ab fo"><div class="op ab oq cl cj or"><h2 class="bd iu gy z fp os fr fs ot fu fw is bi translated">BigQuery SQL中的高级随机采样</h2><div class="ou l"><h3 class="bd b gy z fp os fr fs ot fu fw dk translated">了解如何以可重现的方式对BigQuery表中的行进行采样</h3></div><div class="ov l"><p class="bd b dl z fp os fr fs ot fu fw dk translated">towardsdatascience.com</p></div></div><div class="ow l"><div class="ox l oy oz pa ow pb nf on"/></div></div></a></div></div></div>    
</body>
</html>