<html>
<head>
<title>An Unexpected Lesson with Calculating Currency Conversions in DAX</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在DAX中计算货币转换的意外教训</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/an-unexpected-lesson-with-calculating-currency-conversions-in-dax-58014260a98#2022-01-07">https://towardsdatascience.com/an-unexpected-lesson-with-calculating-currency-conversions-in-dax-58014260a98#2022-01-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""><h1 id="0459" class="pw-post-title ir is it bd iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp bi translated">在DAX中计算货币转换的意外教训</h1></div><div class=""><h2 id="6f3a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated"><em class="ki">货币兑换是常见的报告要求。在实现该解决方案时，我意外地学到了Power BI中的数据建模。</em></h2></div><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/101c4e48ca16e5068a9a472b0000bc6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qoeDkXW3-yiY43_g"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">约翰·麦克阿瑟在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="e2b9" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">介绍</h1><p id="a8ad" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">在进行货币换算时，您必须有一个特定时期的换算率列表。该期间可以是每日或每月的平均汇率或每月的最后(收盘)汇率。</p><p id="e970" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">你可以从你的国家银行网上获得这样的名单。</p><p id="412a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">就我而言，我住在德国，在瑞士工作；我观察了<a class="ae kz" href="https://www.ecb.europa.eu/stats/policy_and_exchange_rates/euro_reference_exchange_rates/html/index.en.html" rel="noopener ugc nofollow" target="_blank">欧洲中央银行</a>和<a class="ae kz" href="https://data.snb.ch/en/publishingSet/A" rel="noopener ugc nofollow" target="_blank">瑞士国家银行</a> (SNB)。</p><p id="963b" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在那里，你可以免费下载一套完整的汇率Excel文件或CSV文件。</p><p id="c61a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">根据要求，我必须从SNB获取汇率。不幸的是，导出的数据只包含月平均和每月收盘汇率。</p><p id="4def" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">因为我需要每日汇率，所以我使用了我以前的一篇文章中描述的技巧来填补时间序列数据中的空白:</p><div class="mt mu gp gr mv mw"><a href="https://medium.com/codex/fill-gaps-in-time-series-with-this-simple-trick-in-sql-81ac655e5ad7" rel="noopener follow" target="_blank"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd iu gy z fp nb fr fs nc fu fw is bi translated">用这个简单的SQL技巧填补时间序列中的空白</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">基于时间的数据可能包含间隙。当您必须处理这些数据时，这种差距可能会导致问题。这里有一个技巧来填充…</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">medium.com</p></div></div><div class="nf l"><div class="ng l nh ni nj nf nk kt mw"/></div></div></a></div><p id="2e12" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">将费率表导入Power BI后，我编写了计算结果的方法。</p><p id="ff20" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">以下三种方法从简单到复杂。</p><p id="5785" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在我的开发工作中，我遇到了意想不到的困难，这使我在研究满足特定需求的最后一种方法时获得了新的知识。</p><h1 id="9607" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">案例1 —一种来源货币兑换多种货币</h1><p id="3552" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">在本例中，我们有一个Transaction- (Fact-)表，其中包含以美元表示的值。然后，我们有一个货币兑换率表，它包括从美元到所有其他货币的每日兑换率。</p><p id="91e4" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">数据模型如下:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nl"><img src="../Images/69e64c195e7e392cf0ee2b2c71b61083.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7jyHqk15DIRR-7D4qaUxxQ.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图1 —简单转换的数据模型(由作者提供)</p></figure><p id="9181" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我将使用同样的原理来模拟第三个也是最后一个解决方案。</p><p id="831a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">因为我总是需要每期一个兑换率，所以在查看月度或年度数据时，我必须汇总每日兑换率。</p><p id="51d2" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">出于这个原因，我需要首先创建一个平均比率指标:</p><pre class="kk kl km kn gt nm nn no np aw nq bi"><span id="d496" class="nr lb it nn b gy ns nt l nu nv">Average Rate = AVERAGE(‘Exchange Rate’[Average_Rate])</span></pre><p id="a810" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">现在，我可以使用以下方法来计算转化率:</p><pre class="kk kl km kn gt nm nn no np aw nq bi"><span id="6d02" class="nr lb it nn b gy ns nt l nu nv">Online Sales Currency =</span><span id="cc9c" class="nr lb it nn b gy nw nt l nu nv">VAR SalesUSD =<br/>    CALCULATE([Online Sales (By Order Date)]<br/>              ,REMOVEFILTERS(‘Currency’)<br/>              )</span><span id="2a20" class="nr lb it nn b gy nw nt l nu nv">VAR ExchangeRate = SELECTEDVALUE(‘Exchange Rate’[Average_Rate])</span><span id="4314" class="nr lb it nn b gy nw nt l nu nv">RETURN<br/>     SalesUSD * ExchangeRate</span></pre><p id="77a1" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我必须在CALCULATE()中使用REMOVEFILTERS('Currency ')来确保目标货币选择不会过滤在线销售表。</p><p id="2f5b" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">或者，可以禁用货币和在线销售表之间的关系。</p><p id="b055" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">这种简单的方法有一些缺点:</p><ol class=""><li id="819f" class="nx ny it lu b lv mo ly mp mb nz mf oa mj ob mn oc od oe of bi translated">该度量计算所选期间的平均汇率。这在结果的计算中引入了误差</li><li id="4e79" class="nx ny it lu b lv og ly oh mb oi mf oj mj ok mn oc od oe of bi translated">该指标不考虑缺失率</li><li id="a95d" class="nx ny it lu b lv og ly oh mb oi mf oj mj ok mn oc od oe of bi translated">这种方法只适用于一个方向和一种货币。</li></ol><h1 id="e160" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">案例2 —多种货币对多种货币</h1><p id="fb45" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">SQLBI的人写了一篇关于货币兑换作为DAX模式的文章。</p><p id="2b0c" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">他们的解决方案涵盖了第一种情况的所有问题:</p><ul class=""><li id="f49e" class="nx ny it lu b lv mo ly mp mb nz mf oa mj ob mn ol od oe of bi translated">将每日交易映射到相应的每日汇率</li><li id="9290" class="nx ny it lu b lv og ly oh mb oi mf oj mj ok mn ol od oe of bi translated">考虑缺失率</li><li id="6885" class="nx ny it lu b lv og ly oh mb oi mf oj mj ok mn ol od oe of bi translated">使用多种来源和目标货币的能力</li></ul><p id="5941" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在此重复细节毫无意义，因为文章和视频包含非常详细的解决方案描述。</p><p id="905a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">您可以在下面的参考资料部分找到这篇文章和相应的视频。</p><h1 id="40be" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">案例3 —使用过渡货币</h1><p id="805a" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">在我的情况下，我有以下数据和要求:</p><ul class=""><li id="a2d2" class="nx ny it lu b lv mo ly mp mb nz mf oa mj ob mn ol od oe of bi translated">我的数据是欧元货币</li><li id="b89d" class="nx ny it lu b lv og ly oh mb oi mf oj mj ok mn ol od oe of bi translated">我有一个以瑞士法郎为基础货币的兑换率表</li><li id="ebdf" class="nx ny it lu b lv og ly oh mb oi mf oj mj ok mn ol od oe of bi translated">我需要主要以瑞士法郎报告我的数据</li><li id="404e" class="nx ny it lu b lv og ly oh mb oi mf oj mj ok mn ol od oe of bi translated">我也必须能够用美元分析数据</li></ul><p id="654c" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">因为输入货币是固定的，所以我不需要两个货币汇率表，如第二个案例中的DAX模式解决方案之一所示。</p><p id="c96d" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">当我想计算结果时，我首先要用欧元乘以欧元的汇率，得到瑞士法郎的值。然后，我可以将结果除以目标货币的汇率，得到最终结果。</p><p id="f8ef" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我用与第一种情况略有不同的逻辑实现了下面的中间方法。嵌入了对逻辑的解释作为注释:</p><pre class="kk kl km kn gt nm nn no np aw nq bi"><span id="56d4" class="nr lb it nn b gy ns nt l nu nv">Cost (Currency) =</span><span id="ea73" class="nr lb it nn b gy nw nt l nu nv">// Step 1: Get the last date with an Exchange-Rate in the actual period<br/>VAR LastExchRate = CALCULATE(<br/>         LASTNONBLANK(‘Date’[Date], MIN(‘Exchange Rates’[Value]) )<br/>         )</span><span id="b83d" class="nr lb it nn b gy nw nt l nu nv">// Step 2: Get the last Exchange-Rate for Euros<br/>VAR ExchRateEUR = CALCULATE(AVERAGE(‘Exchange Rates’[Value])<br/>                              ,REMOVEFILTERS(‘Currencies’)<br/>                              ,’Currencies’[CurrencyCode] = “EUR1”<br/>                              ,’Date’[Date] = LastExchRate<br/>                              )</span><span id="9dd5" class="nr lb it nn b gy nw nt l nu nv">// Step 3: Convert the Cost in EURO to CHF<br/>// The Reason for the REMOVEFILTERS() is the same as explained in the first case<br/>VAR CostCHF = CALCULATE([Cost (EUR)] * ExchRateEUR<br/>                         ,REMOVEFILTERS(‘Currencies’)<br/>                         )</span><span id="e04e" class="nr lb it nn b gy nw nt l nu nv">// Step 4: Get the current Currency Code<br/>VAR SelectedCurr = SELECTEDVALUE(‘Currencies’[CurrencyCode])</span><span id="5599" class="nr lb it nn b gy nw nt l nu nv">// Step 5: Calculate the Result using the Cost in CHF and the Rate of the current Currency Code<br/>// The Formula to calculate the result is: (CostEuro * RateEUR =&gt; CHF) / RateSelectedCurrency<br/>VAR Result = CALCULATE(DIVIDE ( CostCHF<br/>                                , AVERAGE(‘Exchange Rates’[Value])<br/>                                )<br/>                          ,’Currencies’[CurrencyCode] = SelectedCurr<br/>                          ,’Date’[Date] = LastExchRate<br/>                          )</span><span id="3347" class="nr lb it nn b gy nw nt l nu nv">RETURN<br/>// Return the Result from Step 5 only when one Currency is selected.<br/>// If no specific Currency is selected, the return Blank<br/>IF ( HASONEVALUE(‘Currencies’[CurrencyCode])<br/>                  ,SWITCH ( SelectedCurr<br/>                            ,”EUR1", [Cost (EUR)]<br/>                            ,”CHF1", CostCHF<br/>                            ,Result)<br/>                  , BLANK()<br/>                  )</span></pre><p id="5be6" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">正如你在评论中看到的，我得到的是当期的最后一个汇率，而不是计算实际期间的平均汇率。</p><p id="1313" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">这样做的原因是，用这种方法验证结果很简单，因为我只需获得特定时期的最新汇率，就可以检查汇总结果(例如月和年)是否正确。</p><p id="4554" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">无论如何，我必须在步骤2中聚合汇率，因为CALCULATE只能使用一个聚合表达式作为第一个参数。但是，由于我将汇率限制在实际期间的最后一天，因此平均值()没有影响。</p><p id="4427" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我需要IF()中的开关()来检查:</p><ul class=""><li id="e700" class="nx ny it lu b lv mo ly mp mb nz mf oa mj ob mn ol od oe of bi translated">当前货币是欧元，返回以欧元表示的值</li><li id="bc01" class="nx ny it lu b lv og ly oh mb oi mf oj mj ok mn ol od oe of bi translated">当前货币为瑞士法郎，返回以瑞士法郎表示的值</li><li id="7ae6" class="nx ny it lu b lv og ly oh mb oi mf oj mj ok mn ol od oe of bi translated">否则，返回计算结果</li></ul><p id="c95f" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">下一步是通过实现DAX模式解决方案中描述的方法来改进代码。</p><p id="6d83" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">最后的措施如下:</p><pre class="kk kl km kn gt nm nn no np aw nq bi"><span id="403e" class="nr lb it nn b gy ns nt l nu nv">Cost (Currency) =</span><span id="6c0c" class="nr lb it nn b gy nw nt l nu nv">// Step 1:<br/>// Get the Rates for each row in the Data table for CHF (The bridge/intermediary) currency<br/>// As the Data currency is EURO, I have to take the rate for EURO to be able the calculate the value in CHF<br/>VAR AggregatedValue_CHF =<br/>                  CALCULATETABLE (<br/>                      ADDCOLUMNS(<br/>                        SUMMARIZE(‘Azure_UsageDetails’<br/>                                          ,‘Date’[Date])<br/>                        ,“RateEUR”<br/>                        ,CALCULATE(<br/>                          SELECTEDVALUE( ‘Exchange Rates’[Value] ))<br/>                        , “Cost_EUR”, [Cost (EUR)]<br/>                        ),<br/>                      ‘Currencies’[CurrencyCode] = “EUR1”<br/>                      )</span><span id="4f91" class="nr lb it nn b gy nw nt l nu nv">// Step 2:<br/>// Get the Rates for each row in the Data table for the selected currency<br/>VAR AggregatedValue_EUR =<br/>                 ADDCOLUMNS(<br/>                     SUMMARIZE(‘Azure_UsageDetails’<br/>                       ,‘Date’[Date])<br/>                       ,“Rate”<br/>                        ,CALCULATE(<br/>                          SELECTEDVALUE( ‘Exchange Rates’[Value] ) )</span><span id="e073" class="nr lb it nn b gy nw nt l nu nv">                       ,“Cost_EUR”, [Cost (EUR)]<br/>                     )</span><span id="a9e6" class="nr lb it nn b gy nw nt l nu nv">// Step 3:<br/>// Combine both tables into one to be able to perform the correct currency conversion<br/>VAR Cost_Rates = NATURALINNERJOIN(AggregatedValue_CHF,<br/>                                  AggregatedValue_EUR)</span><span id="93c2" class="nr lb it nn b gy nw nt l nu nv">// Step 4:<br/>// Perform the actual currency conversion with the use of the intermediary currency<br/>VAR Result = SUMX(Cost_Rates<br/>                   ,DIVIDE(([Cost (EUR)] * [RateEUR]), [Rate])<br/>                   )</span><span id="eed4" class="nr lb it nn b gy nw nt l nu nv">// Step 5:<br/>// Get the CurrencyCode of the actual currency<br/>VAR SelectedCurr = SELECTEDVALUE(‘Currencies’[CurrencyCode])</span><span id="4836" class="nr lb it nn b gy nw nt l nu nv">RETURN<br/>// Step 6:<br/>// Return the Result from Step 5 only when one Currency is selected.<br/>// If no specific Currency is selected, the return is the Value in EURO<br/>IF ( HASONEVALUE(‘Currencies’[CurrencyCode])<br/>                  // Step 7:<br/>                  // Check if the Currency is either CHF or EURO<br/>                  // if the selected curreny is one of these, use the existing measures to get the result<br/>                  ,SWITCH ( SelectedCurr<br/>                             ,”EUR1", [Cost (EUR)]<br/>                             ,”CHF1", [Cost (CHF)]<br/>                             ,Result)<br/>                  , [Cost (EUR)]<br/>                  )</span></pre><p id="93e7" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">前两个步骤生成两个表，其中包含数据表中每一行的相应汇率。一个表格包含将欧元转换为瑞士法郎(CHF)的兑换率。另一个从实际的过滤上下文中获取转换率(例如USD或AUD)。</p><p id="bf52" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">第三步将两个表合并成一个表，如下所示:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi om"><img src="../Images/17fc8869daa09702f1f3f3597298c447.png" data-original-src="https://miro.medium.com/v2/resize:fit:848/format:webp/1*8arzUbr6IQ-H6A3kUlF3zg.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图2 —样本组合数据(非实际数据)(作者提供的数据)</p></figure><p id="d4bb" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">现在，我可以使用步骤4中的公式来计算结果。</p><p id="061c" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">第四步和第五步与第一步相同，用于解决这种情况。这一步控制输出。</p><p id="8d63" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">成本(瑞士法郎)衡量标准具有以下代码:</p><pre class="kk kl km kn gt nm nn no np aw nq bi"><span id="e600" class="nr lb it nn b gy ns nt l nu nv">Cost (CHF) =<br/>    VAR AggregatedValue_CHF =<br/>            CALCULATETABLE (<br/>               ADDCOLUMNS(<br/>                    SUMMARIZE(‘Azure_UsageDetails’<br/>                               ,‘Date’[Date])<br/>                    , “Rate”<br/>                    ,CALCULATE(<br/>                          SELECTEDVALUE( ‘Exchange Rates’[Value] ) )<br/>                    ,“Cost_EUR”, [Cost (EUR)]<br/>               ),<br/>               ‘Currencies’[CurrencyCode] = “EUR1”<br/>             )</span><span id="0274" class="nr lb it nn b gy nw nt l nu nv">VAR Result = CALCULATE(<br/>                    SUMX(AggregatedValue_CHF<br/>                         ,[Cost (EUR)] * [Rate]<br/>                         )<br/>                    ,’Currencies’[CurrencyCode] = “CHF1”<br/>                    )</span><span id="0f41" class="nr lb it nn b gy nw nt l nu nv">RETURN<br/>     Result</span></pre><p id="a7ee" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">乍一看，这种方法效率很低，因为它几乎只使用公式引擎:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi on"><img src="../Images/443ce3b3c8c8f8a50d7de14266525e71.png" data-original-src="https://miro.medium.com/v2/resize:fit:396/format:webp/1*0QYrv3Bv3z23v0YvPaeMdw.png"/></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图3 —货币兑换的服务器计时(由作者提供)</p></figure><p id="8601" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我将它用于一个只有32，000行的小型数据集。</p><p id="5afc" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我检查了由SQLBI提供的解决方案中的计时。当您使用月费率而不是日费率时，性能会稍好一些。当你可以忍受不太精确的月汇率时，用月汇率计算可能是一个可行的解决方案。</p><p id="6842" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在任何情况下，你都需要用你的数据来评估性能，以了解性能是否对你有利。</p><p id="7fed" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">180 ms的响应时间对于我的数据集来说已经足够好了。</p><p id="0eb7" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">然后，我在拥有6400万行的大型数据集上测试了相同的度量。结果令人惊讶:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/1f74b38faa3bf767a6f082d0fa2eefc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:392/format:webp/1*SGof6zDcGd_6mkB54nb95A.png"/></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图4 —带有大型事实表的货币兑换的服务器计时(由作者提供)</p></figure><p id="bb2d" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">存储引擎执行71.8 %的工作，并行度为3.4(在四核笔记本电脑上)。测量在不到1.5秒后返回结果。<br/>这一测量得出的结论是，该解决方案可以很好地适应数据量。</p><p id="f0e2" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">结果如下所示，仅选择了瑞士法郎、欧元和美元:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi op"><img src="../Images/199ab6250e96aadc7f93bf592e90e29e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1012/format:webp/1*nDpvc8a68vcdkzQfUftYmQ.png"/></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图5 —货币转换的结果(作者提供的数字)</p></figure><p id="7822" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">正如开始提到的，在解决这个挑战时，我学到了一些意想不到的东西。</p><p id="2340" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">当您查看开始时使用的数据模型时，在货币表和事实表之间有两条路径:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi oq"><img src="../Images/c883638496119e50aa3d6bd83afc20ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bSCquE6SsdBYUI_KtCKETg.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图6 —不明确的路径(作者提供的图片)</p></figure><p id="3a3e" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">这两条路给我的测量带来了问题。</p><p id="2cd0" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">这种不确定性来自于在货币表中选择一种货币来过滤事实表中的数据。</p><p id="ebbd" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">该筛选器导致一个空结果，因为事实表只包含欧元货币的值。</p><p id="a859" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我无法将remove filters(' currences ')添加到度量中(步骤1和2)，因为我需要选定的货币来获得正确的兑换率。</p><p id="4aa7" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">解决这个问题的唯一方法是禁用货币和事实表之间的关系。这种改变并没有改变结果:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi or"><img src="../Images/eabb78ac49ee035a3b5540c9cf02d4e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5b4haVVZOq3BqM5Hd67evA.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图7 —修正的数据模型(由作者提供)</p></figure><p id="aad1" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">这种行为是出乎意料的，因为我在其他货币转换项目中使用了这种建模技术。</p><h1 id="9ae4" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">结论</h1><p id="4f64" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">货币兑换的计算可能是一个棘手的挑战。</p><p id="a13a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">第一种情况下的解决方案很简单，但是它有一些缺点，因为它通过使用平均转换率返回不精确的数据。</p><p id="fadf" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">DAX Pattern网站上显示的解决方案非常好，因为它们使用每日或每月汇率来计算正确的结果。此外，这些解决方案还包含对缺失比率等的检查。</p><p id="5c29" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在大多数情况下，您可以使用这里显示的解决方案。</p><p id="306c" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我根据自己的具体需求和可用数据创建了自己的解决方案。</p><p id="ddcb" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">但是，尽管这个解决方案很特别，我还是学到了一些宝贵的经验:</p><ul class=""><li id="2354" class="nx ny it lu b lv mo ly mp mb nz mf oa mj ob mn ol od oe of bi translated">确保数据模型不包含任何潜在的模糊关系</li><li id="b5bf" class="nx ny it lu b lv og ly oh mb oi mf oj mj ok mn ol od oe of bi translated">根据不同值的数量和许多其他因素，解决方案在处理大量数据时会表现得更好</li><li id="abc2" class="nx ny it lu b lv og ly oh mb oi mf oj mj ok mn ol od oe of bi translated">当创建一个复杂的解决方案时，从一个易于测试的解决方案开始。然后，使用第一个版本来验证后续版本的结果，这需要复杂的查询或对照源数据进行检查</li></ul><p id="384d" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">任何方法的下一步都是创建一个计算组。但是，不可能为整个数据模型开发一个计算项，因为第二种和第三种情况的解决方案在一个事实表上迭代。因此，您必须为每个事实表创建一个计算项。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi os"><img src="../Images/039cb36780270874656f98d04b43c3db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aCgZWX43h4147S1m"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">照片由<a class="ae kz" href="https://unsplash.com/@timmossholder?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">蒂姆·莫斯霍尔德</a>在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h1 id="d722" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">参考</h1><p id="6d30" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">你可以在这里找到上面提到的SQLBI文章:<a class="ae kz" href="https://www.daxpatterns.com/currency-conversion/" rel="noopener ugc nofollow" target="_blank">货币转换— DAX模式</a></p><p id="4432" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">相应视频在SQLBI YouTube频道:</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="ot ou l"/></div></figure><p id="d8b2" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我在第一个示例中使用了Contoso示例数据集，就像我在以前的文章中一样。你可以从微软<a class="ae kz" href="https://www.microsoft.com/en-us/download/details.aspx?id=18279" rel="noopener ugc nofollow" target="_blank">这里</a>免费下载ContosoRetailDW数据集。</p><p id="b6f3" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">Contoso的数据可以在麻省理工学院的许可下自由使用，正如这里的<a class="ae kz" href="https://github.com/microsoft/Power-BI-Embedded-Contoso-Sales-Demo" rel="noopener ugc nofollow" target="_blank">所描述的</a>。</p><p id="7297" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">第三个示例中使用的数据集包含来自我的Azure云订阅的实际使用数据，这些数据被导入到Power BI中。</p><div class="mt mu gp gr mv mw"><a href="https://medium.com/@salvatorecagliari/membership" rel="noopener follow" target="_blank"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd iu gy z fp nb fr fs nc fu fw is bi translated">通过我的推荐链接加入Medium-Salvatore Cagliari</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">medium.com</p></div></div><div class="nf l"><div class="ov l nh ni nj nf nk kt mw"/></div></div></a></div></div></div>    
</body>
</html>