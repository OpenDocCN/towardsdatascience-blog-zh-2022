<html>
<head>
<title>Creating Sentinel 2 (Truly) Cloudless Mosaics with Microsoft Planetary Computer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用微软行星计算机创建哨兵2号(真正的)无云镶嵌图</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/creating-sentinel-2-truly-cloudless-mosaics-with-microsoft-planetary-computer-7392a2c0d96c#2022-01-27">https://towardsdatascience.com/creating-sentinel-2-truly-cloudless-mosaics-with-microsoft-planetary-computer-7392a2c0d96c#2022-01-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""><h1 id="16dc" class="pw-post-title ir is it bd iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp bi translated">用微软行星计算机创建哨兵2号(真正的)无云镶嵌图</h1></div><div class=""><h2 id="9518" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用GEE的S2无云图层，在微软行星计算机上有效地遮蔽云(和云的阴影)</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/69cf7c6740e99e9adb61b0ff0a84d790.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*D95-Np9zQrhfbYTA"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">美国宇航局在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><h1 id="2c5a" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">介绍</h1><p id="bd80" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在地理空间领域，微软行星计算公司是久负盛名的谷歌地球引擎的有力竞争者。无需下载每张图像即可访问数Pb卫星信息的可能性以及由<strong class="lt iu"> Dask clusters </strong>提供的计算能力是开发区域/全球应用和研究的一大变革。行星计算机仍处于预览阶段(需要访问请求)，但使用其计算中心与开源工具如<strong class="lt iu"> XARRAY </strong>和<strong class="lt iu"> STAC </strong>的可能性是优于谷歌专有API的一个优势(IMHO)。</p><p id="9155" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">另一个优点是，我们不必像在<strong class="lt iu"> GEE </strong>中那样受大小约束的困扰，大小约束会阻止我们轻松地访问Numpy数组格式的值。好吧，我知道GEE的概念是不同的，这意味着迫使人们在服务器端运行计算(使用惰性数组的概念)，但有时直接访问数据更容易。在Planetary Computer中，甚至可以使用“自制”下载器直接从微软的目录中下载全部资产(更多内容将在以后的文章中介绍)。</p><p id="7879" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">不利的一面是，数据集目录不像在谷歌的竞争对手那里找到的那样广泛。在处理光学(哨兵2号)影像时，有一件事真的很重要:云层遮罩。</p><p id="5c2b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在微软的官方无云镶嵌教程(<a class="ae ky" href="https://planetarycomputer.microsoft.com/docs/tutorials/cloudless-mosaic-sentinel2/" rel="noopener ugc nofollow" target="_blank">这里是</a>)中，他们陈述了以下内容:<em class="ms">“在云是短暂的假设下，合成图像不应该包含(许多)云，因为它们不应该是许多图像在该点的中间像素值。”。那是…呃…不完全是我们所期待的。</em>在L2A S2影像中总会有场景分类图层——SCL图层，但之前用过<strong class="lt iu"> Sen2Cor </strong>的人都知道这不是精度最好的。<strong class="lt iu"> Baetens et al. (2019) </strong>在这个课题上带来了全面的比较。</p><p id="a459" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这又把我们带回了我们的故事:如果我们运行在微软的行星计算机上，我们如何才能有效地从哨兵2的图像中去除云。正如在行星计算机范例GitHub知识库中提到的(这里是<a class="ae ky" href="https://github.com/microsoft/PlanetaryComputerExamples/issues/68" rel="noopener ugc nofollow" target="_blank">这里是</a>)这是他们正在做的事情，但是在那之前…</p><h1 id="cfe4" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">S2无云算法</h1><p id="58be" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">S2无云包是Sinergise开发的机器学习云检测算法，在GitHub上有售(<a class="ae ky" href="https://github.com/sentinel-hub/sentinelhub-py" rel="noopener ugc nofollow" target="_blank">此处</a>)。欧空局正在使用这种算法，它最近作为一张云概率图被列入了GEE的目录。因此，我们可以直接从GEE访问概率图，而不是为每个场景运行训练好的算法。这些问题是:</p><ul class=""><li id="9bef" class="mt mu it lt b lu mn lx mo ma mv me mw mi mx mm my mz na nb bi translated">我们想使用行星计算机，但我们不在地球环境中！而且，</li><li id="11e8" class="mt mu it lt b lu nc lx nd ma ne me nf mi ng mm my mz na nb bi translated">云影呢？</li></ul><p id="1259" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">为了解决前面提到的两点，我结合使用了geeS2Downloader包(关于这个故事的更多信息<a class="ae ky" href="https://medium.com/analytics-vidhya/how-to-download-assets-from-google-earth-engine-gee-and-overcome-the-size-limitations-45b7c9ebe389" rel="noopener">这里</a>)和GEE的页面上提供的教程Sentinel-2 Cloud Masking with S2 Cloud less(<a class="ae ky" href="https://developers.google.com/earth-engine/tutorials/community/sentinel-2-s2cloudless" rel="noopener ugc nofollow" target="_blank">这里</a>)。该教程显示了如何根据太阳方位角投影云阴影，以找到实际的地面阴影，geeS2Downloader包使从GEE下载资源更容易，克服了其大小限制。如果看起来太复杂，让我们来看看完整的解决方案…</p><h1 id="beda" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">解决方案</h1><p id="e898" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">让我们首先从微软行星中心的一个空笔记本开始，安装依赖项。在这种情况下，我们将需要两个未预装在PC(行星计算机)中的软件包和一个用于更快可视化的可选软件包:</p><ul class=""><li id="b011" class="mt mu it lt b lu mn lx mo ma mv me mw mi mx mm my mz na nb bi translated">earthengine-api:从谷歌地球引擎访问资产。</li><li id="8eed" class="mt mu it lt b lu nc lx nd ma ne me nf mi ng mm my mz na nb bi translated">geeS2Downloader:从GEE下载资产。</li><li id="0a30" class="mt mu it lt b lu nc lx nd ma ne me nf mi ng mm my mz na nb bi translated">Geemap:来自吴秋生教授的伟大软件包，它的最新版本也可以在微软的个人电脑上运行。</li></ul><p id="29e9" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">初始化后，我们将通过<strong class="lt iu"> TILE_ID </strong>和<strong class="lt iu">日期</strong>搜索特定的图块。为此，我们将使用一个名为<code class="fe nj nk nl nm b">search_tiles</code>的函数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><pre class="kj kk kl km gt np nm nq nr aw ns bi"><span id="44ce" class="nt la it nm b gy nu nv l nw nx">&lt;Item id=S2B_MSIL2A_20181214T133219_R081_T22KFV_20201008T100849&gt;</span></pre><p id="90af" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">然后，我们需要在GEE中得到相应的云概率图。另外，为了投射阴影，我们也需要完整的S2图像。为此，我们将创建一个名为<code class="fe nj nk nl nm b">get_gee_img </code>的新函数，它将负责在给定STAC商品的情况下定位GEE目录中的图像。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="26d7" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在是时候看看我们用<strong class="lt iu"> Geemap </strong>下载的图片了:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/036f861cfbdd483e8f1f4f96d9be0d11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bcjph2IyQovAfJKXXnt6VA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">代码输出。图片作者。</p></figure><p id="e199" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">正如我们所看到的，云被正确识别，但我们仍然需要摆脱阴影。为此，我们将创建一个受GEE教程启发的函数<code class="fe nj nk nl nm b">create_cloud_mask</code>。它将扩大最终蒙版与50米的缓冲区，并重新调整到20米的分辨率。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><pre class="kj kk kl km gt np nm nq nr aw ns bi"><span id="6d0c" class="nt la it nm b gy nu nv l nw nx">{'type': 'Image',<br/> 'bands': [{'id': 'cloudmask',<br/>   'data_type': {'type': 'PixelType', 'precision': 'int', 'min': 0, 'max': 1},<br/>   'dimensions': [5490, 5490],<br/>   'crs': 'EPSG:32722',<br/>   'crs_transform': [20, 0, 600000, 0, -20, 7500040]}]}</span></pre><p id="4c10" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">正如我们可以从代码的输出中看到的，掩码似乎是用20m正确创建的，正如预期的那样。要在geemap上显示它，我们只需使用以下命令添加该层:</p><pre class="kj kk kl km gt np nm nq nr aw ns bi"><span id="8782" class="nt la it nm b gy nu nv l nw nx">Map.addLayer(mask.selfMask(), {'min': 0, 'max': 1, 'palette': ['orange']}, 'Final Mask', True, 0.5)</span></pre><p id="b66d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这是最终的蒙版输出。请注意，我们不仅有云彩，还有阴影(橙色)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/cade2dd3fd3b7e9c617b326c05c8b043.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5BTnVHH5l2TpgJgxLJ5LMg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">代码输出。图片作者。</p></figure><h2 id="debc" class="nt la it bd lb oa ob dn lf oc od dp lj ma oe of ll me og oh ln mi oi oj lp ok bi translated">将掩模下载到PC</h2><p id="c52b" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">现在我们已经在GEE中处理了遮罩，是时候下载它了，看看它是否正确地符合我们的原始图像。为此，我们将使用<strong class="lt iu"> geeS2Downloader </strong>包。这个软件包将根据GEE的限制自动分割蒙版并重建最终的矩阵。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/2089ec6e2b5219d0118471791d92e22f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1332/format:webp/1*JKKU_eYQQmn0l0HLnW9U-A.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">代码输出。图片作者。</p></figure><h2 id="87b8" class="nt la it bd lb oa ob dn lf oc od dp lj ma oe of ll me og oh ln mi oi oj lp ok bi translated">显示结果</h2><p id="ce1d" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">现在，让我们显示最终结果，以与PC中的图像进行比较。代替<strong class="lt iu"> geemap </strong>，我们将使用普通的Matplotlib来完成这个任务。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/ef04baed6e60fcda7875b3022619a082.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2etDsg95SHBJtwpRgc_IFg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">代码输出。图片作者。</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi on"><img src="../Images/b0ec8a551ba468c0d035d716e8645059.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0CYa0NHGurbYYXo6kNQRvA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">放大输出。图片作者。</p></figure><h1 id="214f" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">结论</h1><p id="d34e" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">正如我们在这个故事中看到的，将谷歌地球引擎和微软行星计算机的资产结合起来，从两个平台中提取精华是可能的。虽然微软的个人电脑不包括可靠的云端层，但这是我为了继续我的项目而创建的一个变通办法。在未来，我预计这种变通办法将不再是必要的。直到那里，希望它能帮助我们中的一些人！</p><p id="5eef" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">谢谢，下一个故事再见！</p><h1 id="856c" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">保持联系</h1><p id="b7a2" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated"><em class="ms">如果你喜欢这篇文章，并想继续无限制地阅读/学习这些和其他故事，考虑成为</em> <a class="ae ky" href="https://cordmaur.medium.com/membership" rel="noopener"> <em class="ms">中等会员</em> </a> <em class="ms">。你也可以在https://cordmaur.carrd.co/</em><a class="ae ky" href="https://cordmaur.carrd.co/" rel="noopener ugc nofollow" target="_blank"/>查看我的作品集。</p><div class="oo op gp gr oq or"><a href="https://cordmaur.medium.com/membership" rel="noopener follow" target="_blank"><div class="os ab fo"><div class="ot ab ou cl cj ov"><h2 class="bd iu gy z fp ow fr fs ox fu fw is bi translated">通过我的推荐链接加入媒体-毛里西奥·科代罗</h2><div class="oy l"><h3 class="bd b gy z fp ow fr fs ox fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="oz l"><p class="bd b dl z fp ow fr fs ox fu fw dk translated">cordmaur.medium.com</p></div></div><div class="pa l"><div class="pb l pc pd pe pa pf ks or"/></div></div></a></div><h1 id="6477" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated"><strong class="ak">参考</strong></h1><p id="3ad3" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">Baetens，l .，Desjardins，c .，Hagolle，o .，2019。使用有监督的主动学习程序生成的参考云掩膜对从MAJA、Sen2Cor和FMask处理器获得的哥白尼Sentinel-2云掩膜的验证。遥感11433。<a class="ae ky" href="https://doi.org/10.3390/rs11040433" rel="noopener ugc nofollow" target="_blank">https://doi.org/10.3390/rs11040433</a></p></div></div>    
</body>
</html>