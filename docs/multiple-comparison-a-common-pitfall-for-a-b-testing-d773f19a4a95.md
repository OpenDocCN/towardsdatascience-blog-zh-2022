# 多重比较:A/B 测试的常见陷阱

> 原文：<https://towardsdatascience.com/multiple-comparison-a-common-pitfall-for-a-b-testing-d773f19a4a95>

## **实验和因果推断**

# **多重比较:A/B 测试的常见陷阱**

## 数据科学家很酷！

![](img/525b86a624c02576225ce62ecf4c7596.png)

埃里克·普劳泽特在 [Unsplash](https://unsplash.com/s/photos/multiple?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上拍摄的照片

# **简介**

科技行业最近的一个趋势是，公司越来越多地诉诸科学方法来指导决策。特别是，他们对产品发布和创新采取严格的测试策略。潜在的想法是:

> 每当有疑问时，A/B 就测试它。

为了满足大规模测试需求，科技公司建立了需要卓越工程技术的内部实验平台。例如， [Google](https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/36500.pdf) 构建了一个重叠测试基础设施，支持数百甚至数千个并发实验。微软开发了一个自动触发系统，如果有任何事情出错，它会提醒实验所有者。 [Airbnb](https://medium.com/airbnb-engineering/how-airbnb-achieved-metric-consistency-at-scale-f23cc53dea70) 创建了一个指标存储库，其中包含数以千计的指标，可以轻松提取并进行实时监控。

这些例子表明，我们需要一个强大的工程团队来构建和维护所有这些基础设施，这给人留下了一个错误的印象，即实验可以仅由平台工程师和数据工程师完成，而无需数据科学家的帮助。令我惊讶的是，这是业内相当普遍的误解。

在这篇博文中，我们通过一个典型的实验设置，看看如果团队中没有合格的数据科学家或统计学家，事情会变得多么糟糕。

# **为什么要进行假设检验？**

在我们正式开始之前，让我们试着回答这个问题:

> 为什么我们需要假设检验？

在线实验的核心思想是从有限的样本中推断总体参数。我们对样本数据进行统计测试，并决定治疗组和对照组之间的差异是实际改善还是仅仅由于随机性。

在任何测试场景下，都不可能完全消除不确定因素。没有 100%的把握，因为随机性带来的意外因素总是存在的。相反，我们可以通过赋值来量化不确定性的水平，这就是为什么统计学家创造了阿尔法水平(又名。假阳性率)。

对于任何实验平台来说，准确评估 FPR 的水平至关重要。太高的 FPR 使平台无用，因为它总是发射错误的信号，我们不知道什么时候是真信号，什么时候是假信号。

![](img/a480c96a15d0da98ea36b22805c2bc6e.png)

[穆利亚迪](https://unsplash.com/@mullyadii?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)在 [Unsplash](https://unsplash.com/s/photos/many?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上的照片

# **为什么多重测试是个问题**

这是一个典型的 A/B 测试用例:产品经理希望了解一个新功能将如何影响整体评估标准(例如，保留)和用户参与度的多个方面，包括购物车添加率、平均会话持续时间、每日活跃用户数、回头客数量和客户满意度得分。此外，她关注网站性能，选择跳出率、会话崩溃率、网站加载时间、功耗指标和收入作为护栏指标。实验中共有 10 个指标。

实验小组建立了一个实验。3 周后，她收集了足够的数据，并对新产品充满信心，因为结果返回了几个小 P 值。那么，让我们推出新功能。

> 有问题吗？

是的，膨胀的 FPR 有一个大问题。具体来说，在多重假设检验中观察到至少一个假阳性的概率，家族误差率(FWER)显著增加。

下面是一个粗略的计算:将 alpha 级别设置为 5%。

1.  *单次检测的假阳性率:0.05*
2.  *单次测试第一类错误不落的概率:1 — 0.05*
3.  *10 次测试中第一类错误的不落概率:(1 — 0.05) ⁰*
4.  *10 次测试至少犯一次 1 型错误的概率:1 — (1 — 0.05) ⁰ =0.40，或 40%。*

上述过程表明，我们至少会在 40%的时间里观察到一个假阳性，即使没有实际差异。

作为第一个旁注，对 5%的 alpha 水平的正确解释是，如果我们重复重新运行实验，我们会错误地拒绝 5%的无效假设，即使没有差异。

第二点要注意的是，A/A 测试是一项实验，我们对两组患者进行相同的治疗条件。据估计，任何单个 A/A 测试的 FPR 应接近标称 alpha 水平(如 5%)，多个 A/A 测试的 p 值的最终分布应遵循均匀分布。如果你想了解更多关于 A/A 测试和它们潜在的重要性，看看这篇文章。

到目前为止，你可能同意没有适当的统计调整的多重假设检验会增加 FWER，这总是发出错误的信号。

在下一节中，我们将深入研究三种流行的统计调整。

![](img/da6348cec0ca27489925f50dc37fd9d2.png)

本·哈里特在 [Unsplash](https://unsplash.com/s/photos/many?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上拍摄的照片

## **解决方案 1: Bonferroni 校正**

让我们从最简单的 Bonferroni 校正(BC)开始。BC 方法将α水平除以比较次数，即 *α/n.* 如果我们将α/n 乘以比较次数 n，BC 方法将 FWER 保持在α。

在我们的示例中，我们对 10 个指标进行了多次比较。默认情况下，我们选择 0.05 作为单独的 alpha 级别。使用 BC 方法，我们将 0.05 除以比较次数:0.05/10 = 0.005。如果我们想要得到任何有统计学意义的结果，相应的 p 值必须小于 0.005。

正如所见，我们已经将拒绝标准从 0.05 降低到 0.005，使得拒绝零假设变得更加困难。这种方法经常被批评为过于保守和缺乏统计能力。BC 方法以假阴性为代价降低了假阳性。

当然，这种方法有几个优点。例如，它是通用的，适用于所使用的任何检验统计量，与 p 值无关，或 H0 的性质( [James 等人 2021，统计学习介绍](https://web.stanford.edu/~hastie/ISLRv2_website.pdf))。

## **解决方案 2:霍尔姆-邦费罗尼**

由于其保守性，BC 方法在实践中很少使用，统计学家已经提出了一种改进的版本，称为 **Holm-Bonferroni 方法。**它也控制 FWER，但通过对 p 值进行排序并调整每个无效假设的拒绝标准。这两种方法的最大区别在于，与 BC 方法不同，H-B 程序的拒绝阈值取决于所有 p 值。

就能力而言，H-B 比 Bonferroni 方法更加强大:它拒绝的无效假设至少与 BC 一样多。如果你使用 Bonferroni，考虑转换到 Holm 的程序，因为它总是优于。

## **方案三:本杰明-霍赫伯格**

与控制 FWER 的 Bonferroni 家族不同，Yoav Benjamini 和 Yosef Hochberg 提出了一种称为 Benjamini-Hochberg 程序的新方法，该方法控制**错误发现率(FDR)** ，该错误发现率被定义为所有发现(显著结果)中错误阳性的比例。比如你做了 100 个有意义的结果，其中 5 个是错误发现(或者错误拒绝)；罗斯福是 5%。

这里有一个 FDR 和 FWER 的简单比较:

> FWER:测试中至少有一个或多个假阳性的概率。
> 
> FDR:错误发现占发现总数的百分比。

在生产中，FDR 提供了比 FWER 更直观的解释。错误发现在整个发现中所占的比例，这对业务人员来说有直观的意义。

相比之下，Benjamini-Hochberg 在假阳性率附近提供了较弱的保证，但是比 BC 显著降低了假阴性率。Benjamini-Hochberg 在生产中的 I 型和 II 型误差之间提供了一个更好的折衷。

Medium 最近推出了作家伙伴计划，支持像我这样的普通作家。如果你还不是订户，通过下面的链接注册，我会收到一部分会员费。

[](https://leihua-ye.medium.com/membership) [## 阅读叶雷华博士研究员(以及其他成千上万的媒体作家)的每一个故事

### 作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…

leihua-ye.medium.com](https://leihua-ye.medium.com/membership) 

# **外卖**

*   由于假设检验的随机性，我们希望考虑抽样方差，并评估出现这种极端数据分布的概率。
*   一种常见的方法是使用假阳性率。
*   然而，没有适当调整的多重比较会增加累积的α水平，使 A/B 测试变得无用。
*   这篇文章认为 Benjamini-Hochberg 方法是平衡假阳性和假阴性的“最佳”方法。
*   这并不意味着 Benjamini-Hochberg 程序是一个适合所有情况的解决方案。您可能需要选择另一种适合您特定需求的校正方法。
*   最后，数据科学家超级酷。

# 喜欢读这本书吗？

> 请在 [LinkedIn](https://www.linkedin.com/in/leihuaye/) 和 [YouTube](https://www.youtube.com/channel/UCBBu2nqs6iZPyNSgMjXUGPg) 上找到我。
> 
> 还有，看看我其他关于人工智能和机器学习的帖子。