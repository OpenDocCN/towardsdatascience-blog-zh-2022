<html>
<head>
<title>Advanced Code Documentation with Coverage and Unit Tests — Part 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">包含覆盖率和单元测试的高级代码文档—第3部分</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/advanced-code-documentation-with-coverage-and-unit-tests-part-3-3f7b698497fb#2022-01-30">https://towardsdatascience.com/advanced-code-documentation-with-coverage-and-unit-tests-part-3-3f7b698497fb#2022-01-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""><h1 id="2bde" class="pw-post-title ir is it bd iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp bi translated">包含覆盖率和单元测试的高级代码文档—第3部分</h1></div><div class=""><h2 id="4b87" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">评估文档的完整性并对文档字符串执行单元测试——使用和不使用Sphinx</h2></div><p id="88ba" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> <em class="le">更新</em> </strong> <em class="le">:本文是系列文章的一部分。查看</em> <a class="ae lf" rel="noopener" target="_blank" href="/advanced-code-documentation-beyond-comments-and-docstrings-2cc5b2ace28a"> <em class="le">第一部分</em> </a>，<a class="ae lf" rel="noopener" target="_blank" href="/advanced-code-documentation-with-sphinx-part-2-32c82860a535"> <em class="le">第二部分</em> </a> <em class="le">！</em></p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lg"><img src="../Images/e421f60f4f59e29e2ec1c37f753aa772.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5a1SWmrvzSTI4Fih"/></div></div><p class="ls lt gj gh gi lu lv bd b be z dk translated">尼克·莫里森在<a class="ae lf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="a9db" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">第一篇文章展示了<a class="ae lf" rel="noopener" target="_blank" href="/advanced-code-documentation-beyond-comments-and-docstrings-2cc5b2ace28a">如何设置、定制和部署Sphinx文档</a>，第二篇文章提到了<a class="ae lf" rel="noopener" target="_blank" href="/advanced-code-documentation-with-sphinx-part-2-32c82860a535">使用Sphinx扩展来处理更复杂的项目结构、合并多种文件类型和添加徽章</a>。只要您的代码库中有某种形式的文档字符串，这一切都可以工作，但是您如何真正知道您的文档字符串是否足够好呢？本文将介绍对文档字符串执行单元测试的方法，并检查文档字符串的覆盖率——使用和不使用Sphinx都可以。</p><h1 id="3ed4" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">目录</h1><ul class=""><li id="f436" class="mo mp it kk b kl mq ko mr kr ms kv mt kz mu ld mv mw mx my bi translated"><a class="ae lf" href="https://medium.com/p/3f7b698497fb/#40c6" rel="noopener">文档字符串的覆盖测试—使用Sphinx </a></li><li id="0caa" class="mo mp it kk b kl mz ko na kr nb kv nc kz nd ld mv mw mx my bi translated"><a class="ae lf" href="https://medium.com/p/3f7b698497fb/#7037" rel="noopener">文档字符串的覆盖测试—无Sphinx </a></li><li id="2d74" class="mo mp it kk b kl mz ko na kr nb kv nc kz nd ld mv mw mx my bi translated"><a class="ae lf" href="https://medium.com/p/3f7b698497fb/#8e00" rel="noopener">文档字符串的单元测试</a></li><li id="a8c0" class="mo mp it kk b kl mz ko na kr nb kv nc kz nd ld mv mw mx my bi translated"><a class="ae lf" href="https://medium.com/p/3f7b698497fb/#23c9" rel="noopener">访问编写函数的文件串</a></li></ul></div><div class="ab cl ne nf hx ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="im in io ip iq"><h1 id="44c1" class="lw lx it bd ly lz nl mb mc md nm mf mg jz nn ka mi kc no kd mk kf np kg mm mn bi translated">使用Sphinx对文档字符串进行覆盖率测试</h1><blockquote class="nq nr ns"><p id="0236" class="ki kj le kk b kl km ju kn ko kp jx kq nt ks kt ku nu kw kx ky nv la lb lc ld im bi translated">覆盖率是指包含文档的范围(类、函数、模块)的比例。良好的覆盖率意味着代码库得到了很好的解释。</p></blockquote><p id="4a5b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">可以使用我在第二篇文章中提到的<a class="ae lf" rel="noopener" target="_blank" href="/advanced-code-documentation-with-sphinx-part-2-32c82860a535"> Sphinx扩展来检查文档字符串的覆盖率。简单回顾一下，扩展允许您添加特性或修改Sphinx布局。用于检查覆盖率的Sphinx扩展不需要安装额外的Python包，只需将<code class="fe nw nx ny nz b">sphinx.ext.coverage</code>添加到<code class="fe nw nx ny nz b">conf.py</code>文件的扩展列表中，并在命令提示符下运行下面一行，</a></p><pre class="lh li lj lk gt oa nz ob oc aw od bi"><span id="208e" class="oe lx it nz b gy of og l oh oi">$ sphinx-build -v -b coverage docs/source docs/build/coverage</span></pre><p id="ea20" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了分解上面的命令，<code class="fe nw nx ny nz b">-v</code>增加了详细度，将额外的日志打印到控制台，<code class="fe nw nx ny nz b">-b coverage</code>在<code class="fe nw nx ny nz b">conf.py</code>所在的源目录<code class="fe nw nx ny nz b">docs/source</code>中运行覆盖构建器，覆盖结果将保存到输出目录<code class="fe nw nx ny nz b">docs/build/coverage</code>。</p><p id="53e7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我特意留下了一个没有docstrings的函数，覆盖结果可以在<code class="fe nw nx ny nz b">/docs/build/coverage/python.txt</code>中找到，如下所示，</p><pre class="lh li lj lk gt oa nz ob oc aw od bi"><span id="3b1d" class="oe lx it nz b gy of og l oh oi">Undocumented Python objects<br/>===========================<br/>sample_function<br/>---------------<br/>Functions:<br/> * sample_function_no_docstring</span></pre><p id="37b5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">注意</strong>:如果覆盖率测试没有成功标记没有文档字符串的函数，检查您的<code class="fe nw nx ny nz b">.rst</code>文件中是否有<code class="fe nw nx ny nz b">:undoc-members:</code>并删除这一行。</p><p id="3b26" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">注意</strong>:如果您收到<code class="fe nw nx ny nz b">No module named ..; .. is not a package</code>警告等警告，请检查您的<code class="fe nw nx ny nz b">.rst</code>文件。确保您指向的是Python文件，而不是Python文件中的函数。</p><h1 id="7037" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">不使用Sphinx的文档字符串覆盖测试</h1><p id="78e7" class="pw-post-body-paragraph ki kj it kk b kl mq ju kn ko mr jx kq kr oj kt ku kv ok kx ky kz ol lb lc ld im bi translated">如果您的Python包不支持Sphinx，您仍然可以使用<code class="fe nw nx ny nz b">docstr-coverage</code> Python包检查您的代码库的覆盖率，安装该包并在命令提示符下运行下面一行，</p><pre class="lh li lj lk gt oa nz ob oc aw od bi"><span id="abe7" class="oe lx it nz b gy of og l oh oi">docstr-coverage . --skip-file-doc --exclude ".*/docs"</span></pre><p id="049d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了分解上面的命令，<code class="fe nw nx ny nz b">.</code>表示当前目录，这是代码库的位置，<code class="fe nw nx ny nz b">--skip-file-doc</code>忽略检查每个文件顶部的文档字符串，<code class="fe nw nx ny nz b">--exclude ".*/docs"</code>添加排除路径以避免运行覆盖测试。</p><p id="5b67" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">和以前一样，我特意留下了一个没有文档字符串的函数，覆盖率结果如下所示</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi om"><img src="../Images/158178b7d010b9fbc958ab8270c670dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wDkP4ENh-mBymT0euvGWTQ.png"/></div></div><p class="ls lt gj gh gi lu lv bd b be z dk translated">覆盖率测试结果-作者图片</p></figure><p id="2ac4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">也就是说，文档字符串覆盖只是覆盖测试的一个方面，还有其他的代码覆盖测试，它们关注函数覆盖(检查冗余函数)、语句覆盖(检查冗余语句)、条件覆盖(检查冗余if-else语句)，等等。</p><h1 id="8e00" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">文档字符串的单元测试</h1><p id="3662" class="pw-post-body-paragraph ki kj it kk b kl mq ju kn ko mr jx kq kr oj kt ku kv ok kx ky kz ol lb lc ld im bi translated">代码覆盖率度量可能与项目的整体代码质量相关，但不能正确测试代码库，而代码库是通过单元测试来实现的。</p><blockquote class="nq nr ns"><p id="e769" class="ki kj le kk b kl km ju kn ko kp jx kq nt ks kt ku nu kw kx ky nv la lb lc ld im bi translated">单元测试是测试一个单元或代码库中可以逻辑隔离的最小代码段，这在测试驱动开发(TDD)中至关重要。它允许在开发周期的早期发现实现中的错误。</p></blockquote><p id="f8be" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">正如我们正在讨论的文档主题，简单的测试可以用函数docstring编写，并使用内置Python库的<code class="fe nw nx ny nz b">doctest</code> Python包进行测试。</p><p id="52ff" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">用函数docstring编写的测试信息丰富，因为它向用户展示了如何使用样本输入和预期输出与函数进行交互。然后用<code class="fe nw nx ny nz b">doctest</code>完成，它能够测试预期的返回值和预期的错误。</p><p id="ba49" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了举例说明，我编写了一个简单的函数，将两个数相加。为了简单起见，我删除了docstring中定义函数描述、参数和返回值的部分。您也可以通过复制代码并使用<code class="fe nw nx ny nz b">python sample_doctest.py -v</code>在命令提示符下运行Python文件来尝试，其中<code class="fe nw nx ny nz b">-v</code>增加了冗长性。</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="on oo l"/></div></figure><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi op"><img src="../Images/9a6c4eccb17c52e0e7516c87c048d395.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*70gn-KRRfCzHU0-n7P7Y-A.png"/></div></div><p class="ls lt gj gh gi lu lv bd b be z dk translated">单元测试结果-作者图片</p></figure><p id="badf" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">警告</strong>:使用<code class="fe nw nx ny nz b">doctest</code>作为单元测试的手段不如流行的Python框架如<code class="fe nw nx ny nz b">unittest</code>或<code class="fe nw nx ny nz b">pytest</code>强大。</p><h1 id="23c9" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">访问编写函数的文档字符串</h1><p id="c675" class="pw-post-body-paragraph ki kj it kk b kl mq ju kn ko mr jx kq kr oj kt ku kv ok kx ky kz ol lb lc ld im bi translated">由于我们总是可以调用打印出文档字符串信息的<code class="fe nw nx ny nz b">help(<em class="le">function_name</em>)</code>,所以很少使用访问编写函数的文档字符串。但是，如果我们需要将编写的函数的文档字符串检索到一个字符串变量中，有两种方法可以做到这一点，即使用<code class="fe nw nx ny nz b">inspect</code>内置Python库或访问函数的<code class="fe nw nx ny nz b">__doc__</code>属性。</p><pre class="lh li lj lk gt oa nz ob oc aw od bi"><span id="9f1e" class="oe lx it nz b gy of og l oh oi">import inspect<br/><em class="le">function_name</em>.__doc__  # will have indent<br/>inspect.getdoc(<em class="le">function_name</em>)  # will not have indent</span></pre></div><div class="ab cl ne nf hx ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="im in io ip iq"><p id="3554" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">希望你已经学会了一些有用的方法来检查、测试你的文档字符串并与之交互。我希望这一系列文章已经充分介绍了关于docstring和文档的主题。如果有其他有趣的方面，请留下您的评论。</p><p id="911f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">感谢您的阅读！如果你喜欢这篇文章，请随意分享。</strong></p></div><div class="ab cl ne nf hx ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="im in io ip iq"><h1 id="24dc" class="lw lx it bd ly lz nl mb mc md nm mf mg jz nn ka mi kc no kd mk kf np kg mm mn bi translated">相关链接</h1><p id="2393" class="pw-post-body-paragraph ki kj it kk b kl mq ju kn ko mr jx kq kr oj kt ku kv ok kx ky kz ol lb lc ld im bi translated"><code class="fe nw nx ny nz b">sphinx.ext.coverage</code>文档:<a class="ae lf" href="https://www.sphinx-doc.org/en/master/usage/extensions/coverage.html" rel="noopener ugc nofollow" target="_blank">https://www . sphinx-doc . org/en/master/usage/extensions/coverage . html</a></p><p id="0fae" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nw nx ny nz b">docstr-coverage</code>文档:<a class="ae lf" href="https://pypi.org/project/docstr-coverage/" rel="noopener ugc nofollow" target="_blank">https://pypi.org/project/docstr-coverage/</a></p><p id="7697" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nw nx ny nz b">doctest</code>文件:【https://docs.python.org/3/library/doctest.html T21】</p><p id="153d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nw nx ny nz b">inspect</code>文件:<a class="ae lf" href="https://docs.python.org/3/library/inspect.html" rel="noopener ugc nofollow" target="_blank">https://docs.python.org/3/library/inspect.html</a></p></div></div>    
</body>
</html>