<html>
<head>
<title>Tutorial — Basic Kubeflow Pipeline From Scratch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">教程—从零开始的基本Kubeflow管道</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/tutorial-basic-kubeflow-pipeline-from-scratch-5f0350dc1905#2022-01-26">https://towardsdatascience.com/tutorial-basic-kubeflow-pipeline-from-scratch-5f0350dc1905#2022-01-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""><h1 id="b35e" class="pw-post-title io ip iq bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">教程—从零开始的基本Kubeflow管道</h1></div><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/c1a77d427a012a29adcebd87c582b4bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wBaI1v-BUuUo4DZl"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">来源:Hanna Morris 在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="039e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Kubeflow是一个机器学习工具包，便于在Kubernetes上部署机器学习项目。尽管最近，Kubeflow越来越多地出现在科技公司的堆栈中，由于项目档案的稀缺，新手开始使用它可能会非常困难。</p><p id="706f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">即使Kubeflow的文档远不缺乏，但当您从头创建机器学习管道时，有一只援助之手总是有帮助的。我会尽我所能成为那只援助之手。</p><p id="f321" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本指南中，我们将介绍建立一个正常运行的管道所需的每一个步骤。您将学习如何:</p><ul class=""><li id="9668" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">创建一个Kuberneter集群</li><li id="93d8" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">安装Kubeflow</li><li id="8c22" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">创建容器注册表</li><li id="d04b" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">构建一个容器映像，并将其推送到您的注册表中</li><li id="d34d" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">让Kubeflow访问您的S3桶</li><li id="ae7d" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">用输入和输出工件创建Kubeflow组件</li><li id="87e5" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">创建一个Kubeflow管道，上传并运行它</li></ul><h1 id="0bb4" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">AWS —弹性Kubernetes服务</h1><p id="b239" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">在这里，我将重点关注使用<a class="ae kc" href="https://aws.amazon.com/eks/" rel="noopener ugc nofollow" target="_blank"> AWS EKS </a>从零开始创建一个管道，这是一个创建Kubernetes集群的服务，就像<a class="ae kc" href="https://cloud.google.com/kubernetes-engine" rel="noopener ugc nofollow" target="_blank">谷歌的GKE </a>。</p><h1 id="8cc3" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">创建一个EKS集群并安装Kubeflow</h1><p id="6b5a" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">虽然您可以通过在搜索栏上键入“EKS”并选择“弹性Kubernetes服务”<strong class="kf ir">来从AWS管理控制台创建EKS集群，但我强烈建议您遵循本</strong> <a class="ae kc" href="https://www.kubeflow.org/docs/distributions/aws/deploy/install-kubeflow/" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> Kubeflow指南</strong> </a>，其中包括集群创建步骤，直接从您的计算机终端的命令行完成。遵循这一点将确保您的集群具有正确的设置，以便稍后安装Kubeflow。</p><p id="f61c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">确保不要错过以下先决条件:</p><ul class=""><li id="86a3" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">安装<a class="ae kc" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl" rel="noopener ugc nofollow" target="_blank"> kubectl </a></li><li id="8200" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">安装<a class="ae kc" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html" rel="noopener ugc nofollow" target="_blank"> AWS命令行界面</a> (CLI)</li><li id="c7bd" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">通过运行以下命令配置AWS CLI:<code class="fe ms mt mu mv b">aws configure</code>。</li><li id="af50" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">输入您的访问密钥(<a class="ae kc" href="https://docs.aws.amazon.com/general/latest/gr/aws-sec-cred-types.html#access-keys-and-secret-access-keys" rel="noopener ugc nofollow" target="_blank">访问密钥ID和秘密访问密钥</a>)。</li><li id="959e" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">输入您的首选AWS区域和默认输出选项。</li><li id="c0b1" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">安装<a class="ae kc" href="https://github.com/weaveworks/eksctl" rel="noopener ugc nofollow" target="_blank"> eksctl </a>和<a class="ae kc" href="https://docs.aws.amazon.com/eks/latest/userguide/install-aws-iam-authenticator.html" rel="noopener ugc nofollow" target="_blank"> aws-iam认证器</a>。</li></ul><p id="2eee" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请不要犹豫更改您的AWS区域(如“eu-west-1”)并选择更强大的EC2实例。我个人选择的是p2.xlarge实例。<br/>例如，我的配置是:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="be03" class="ne lq iq mv b gy nf ng l nh ni">export AWS_CLUSTER_NAME<strong class="mv ir">=</strong>kubeflow-demo<br/>export AWS_REGION<strong class="mv ir">=</strong>eu-west-1<br/>export K8S_VERSION<strong class="mv ir">=</strong>1.18<br/>export EC2_INSTANCE_TYPE<strong class="mv ir">=</strong>p2.xlarge</span></pre><p id="43f3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">截至2022年1月，Kubeflow无法在最新版本的Kubernetes上正确安装。<strong class="kf ir">我强烈建议保持K8S_VERSION为1.18。</strong></p><p id="de4d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您已经按照指南阅读了“访问Kubeflow central dashboard”一章，那么命令<code class="fe ms mt mu mv b">kubectl get ingress -n istio-system</code>应该会返回一个如下所示的地址:<br/> <code class="fe ms mt mu mv b">123-istiosystem-istio-2af2-4567.us-west-2.elb.amazonaws.com</code> <br/>将这个地址复制并粘贴到您的浏览器中。如指南中所述，如果您正在使用基本身份验证，则凭证是您在配置文件中指定的凭证，或者是默认凭证(<code class="fe ms mt mu mv b">admin@kubeflow.org</code> : <code class="fe ms mt mu mv b">12341234</code>)。</p><p id="f982" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您现在应该可以访问您的Kubeflow中央仪表盘:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nj"><img src="../Images/1a1f40319f7e32f3b1d87cc1a52161b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M7Yo1AuR_7dvfjDZ0P1BKQ.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">Kubeflow中央仪表盘。作者图片</p></figure><h1 id="9e9c" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">创建容器注册表</h1><p id="68d6" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">使用Kubernetes意味着使用容器图像，所以让我们离开仪表板，创建一个容器注册中心。</p><p id="e858" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">回到你的AWS管理控制台，在搜索栏中输入“ECR”并点击“弹性容器注册”。从那里，选择左侧栏上的“存储库”，然后单击“创建存储库”。</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/ea82e5ede36bd5cdd82d9f82219e2972.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s3l_jwc6Wve897R96aidag.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">ECR菜单。作者图片</p></figure><p id="1044" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建后，一个新的存储库将出现在您的菜单上。请注意，它有一个类似这样的URI:<br/><code class="fe ms mt mu mv b">&lt;ID&gt;.dkr.ecr.&lt;REGION&gt;.amazonaws.com/&lt;REGISTRY_NAME&gt;</code><br/>其中&lt; ID &gt;是您的帐户ID，&lt; REGION &gt;是您的注册表所在的区域(例如eu-west-1)，而&lt; REGITSTRY_NAME &gt;是您在创建注册表时给它起的名字。</p><p id="97a2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">每个存储库都有一个URI，你放在上面的每个图像也是如此。这是我们在本文后面研究组件创建时需要的链接。</p><h1 id="004b" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">检查您的集群的工作节点是否可以访问ECR</h1><p id="ae74" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">在AWS管理控制台上转到EKS，选择“集群”。单击您之前创建的群集，转到“配置”选项卡，然后转到“计算”子选项卡:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/4f4902665c2b34e0ddfba5abc589686d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xHwAZrPlbfaymZmx9552-w.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">您应该会看到这样的节点组。作者图片</p></figure><p id="8a57" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">单击您的节点组，在“详细信息”选项卡上，单击“节点IAM角色ARN”。这将打开节点的IAM管理控制台。请确保附加了“amazonec 2 containerregistryreadonly”策略。如果没有，请单击“附加策略”进行添加:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/128faaf8693ff89a2475b4283afc6259.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HobHEcSgsYur39qa9ji1IQ.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">作者图片</p></figure><h1 id="9e6c" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">安装Docker</h1><p id="62e3" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">如果您已经安装了Docker，请转到下一部分。如果没有，进入<a class="ae kc" href="https://docs.docker.com/desktop/" rel="noopener ugc nofollow" target="_blank"> Docker主页，安装Docker桌面</a>。</p><p id="3dfd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在Linux或Mac上，最简单的方法是在终端上键入命令<br/> <code class="fe ms mt mu mv b">brew install Docker</code>。</p><h1 id="ae11" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">创建一个容器</h1><p id="0087" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">在您的计算机上，创建一个文件夹，您将在该文件夹中工作。如果你想对你的作品进行版本控制，它可以是一个GitHub存储库文件夹。</p><p id="d362" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建一个文件，命名为“Dockerfile”。在linux和mac上，您可以为此键入<code class="fe ms mt mu mv b">touch Dockerfile</code>命令。用任何你想要的IDE打开它，甚至是记事本(Windows)或文本编辑(Mac)。</p><p id="002a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在docker文件中，我们将声明一个父映像(这里我将使用ubuntu:20.04)，安装pip，然后安装一些运行脚本所需的包。我们的docker文件将如下所示:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="6eeb" class="ne lq iq mv b gy nf ng l nh ni">FROM ubuntu:20.04<br/>RUN set -xe \<br/> &amp;&amp; apt-get update -y \<br/> &amp;&amp; apt-get install -y python3-pip \<br/> &amp;&amp; apt install -y python-is-python3<br/>RUN pip3 — no-cache-dir install numpy scikit-learn pandas boto3</span></pre><p id="f150" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在用这个命令构建一个图像，并把<image_name>改成你想给图像起的任何名字。不要忘记结尾的点！</image_name></p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="8a88" class="ne lq iq mv b gy nf ng l nh ni">docker build -t &lt;image_name&gt; .</span></pre><h1 id="5c55" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">将您的映像推送到您的容器注册表中</h1><p id="897e" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">检索一个认证令牌，并向您的注册表认证您的Docker客户端。使用AWS CLI:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="b015" class="ne lq iq mv b gy nf ng l nh ni">aws ecr-public get-login-password --region &lt;REGION&gt;| docker login --username AWS --password-stdin &lt;ECR_URI&gt;</span></pre><p id="caf6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将<region>更改为您的存储库的区域(例如eu-west-1)，并且<ecr_uri>应该是这样的:<br/> <code class="fe ms mt mu mv b">&lt;ACCOUNT_ID&gt;.dkr.ecr.&lt;REGION&gt;.amazonaws.com</code>用于私有注册中心，<br/> <code class="fe ms mt mu mv b">public.ecr.aws/&lt;REGISTRY_ID&gt;/</code>用于公共注册中心</ecr_uri></region></p><p id="f7d3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，标记您的映像，以便您可以将映像推送到此存储库:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="a0f0" class="ne lq iq mv b gy nf ng l nh ni">docker tag &lt;image_name&gt;:latest &lt;ECR_URI&gt;/&lt;REGISTRY_NAME&gt;:latest</span></pre><p id="e67d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">运行以下命令将该映像推送到新创建的AWS存储库:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="35a9" class="ne lq iq mv b gy nf ng l nh ni">docker push &lt;ECR_URI&gt;/&lt;REGISTRY_NAME&gt;:latest</span></pre><p id="a331" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您有任何问题，您可以通过点击“查看推送命令”在注册表的菜单上获得所有命令</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nn"><img src="../Images/f31ff35b584de4f90f71bf6b0b3b61f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zg_6VhuCC0MZvuKaIbBizA.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">作者图片</p></figure><h1 id="4d60" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">在S3上设置测试数据集</h1><p id="59e5" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">我们的基本管道将从从S3下载压缩数据集开始。<br/>我们将使用这个<a class="ae kc" href="https://www.kaggle.com/olistbr/brazilian-ecommerce" rel="noopener ugc nofollow" target="_blank"> kaggle数据集</a>作为例子，但是任何压缩的csv文件都可以。</p><p id="43eb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在AWS管理控制台上，在搜索栏上键入“S3”以访问该服务，然后单击“创建存储桶”。一旦创建，点击你的桶，上传你的zip文件。</p><h1 id="3895" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">让库伯弗洛进入S3</h1><p id="f57c" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">回到你的Kubeflow中央仪表盘，点击“笔记本服务器”，然后点击“新服务器”。这可能需要几分钟时间。</p><p id="479a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建完成后，单击“Connect”打开Jupyterlab并打开一个终端实例。<br/>键入<code class="fe ms mt mu mv b">aws configure</code>并键入您在步骤1的先决条件中所做的凭证，以便从您的Kubeflow实例登录到aws。这将使您能够从脚本中访问S3存储桶。</p><h1 id="af40" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">测试你是否可以访问S3</h1><p id="3815" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">在Jupyterlab上，打开一个新笔记本。</p><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="9bad" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这个代码片段中，<bucket_name>是您的存储桶的名称。<br/>如果您运行此单元格，您应该会看到您的zip文件，以及任何其他子文件夹中的任何其他文件。如果您想要浏览特定的子文件夹，请将第三行更改为:<br/> <code class="fe ms mt mu mv b">contents = conn.list_objects(Bucket=&lt;bucket_name&gt;, <br/> Prefix=&lt;subfolder_name&gt;)['Contents']</code></bucket_name></p><h1 id="964a" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">创建Kubeflow管道</h1><p id="63f0" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">我们将做一个简单的管道，从我们的S3桶中下载我们的zip文件，将解压后的csv文件上传到桶中，并读取其中一个包含熊猫的数据集</p><h2 id="323e" class="ne lq iq bd lr nq nr dn lv ns nt dp lz ko nu nv md ks nw nx mh kw ny nz ml oa bi translated">第一步。创建python函数</h2><p id="5195" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">我们将创建解压缩函数:</p><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="96a9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后是阅读器功能:</p><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="3a8d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们的管道中，“csv_s3_reader()”的“csv_path”参数将是“unzip_func()”的输出字符串。<br/>您现在可以测试您的功能是否正常。</p><h2 id="20ff" class="ne lq iq bd lr nq nr dn lv ns nt dp lz ko nu nv md ks nw nx mh kw ny nz ml oa bi translated">第二步。将python函数重新格式化为组件函数</h2><p id="6d89" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">为了让Kubeflow能够理解它们，我们将这些函数重写如下:</p><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="5995" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如您所见，您需要为函数声明每个参数的类型。由于Kubeflow管道处理工件，而不是返回一个对象，我们的行为就像我们在磁盘上写它一样，只是我们给出的不是路径，而是一个comp。输出路径()对象。</p><p id="d87a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，如果你想写一个熊猫数据帧到你的计算机上，你应该写<code class="fe ms mt mu mv b">df.to_csv(path_name)</code>。在Kubeflow中，这变成了<code class="fe ms mt mu mv b">df.to_csv(output_path_object)</code>，其中<code class="fe ms mt mu mv b">output_path_object</code>在函数的参数中定义为<code class="fe ms mt mu mv b">comp.OutputPath(‘CSV')</code>。</p><p id="bacc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以用同样的方式处理Kubeflow输入，方法是读取<code class="fe ms mt mu mv b">comp.InputPath()</code>对象，就好像它们是写在您的磁盘上一样。</p><p id="a775" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可能已经注意到这些函数内部有导入，我们在讨论组件时很快就会谈到这一点。</p><h2 id="2773" class="ne lq iq bd lr nq nr dn lv ns nt dp lz ko nu nv md ks nw nx mh kw ny nz ml oa bi translated">第三步。将功能转换为组件</h2><p id="c3dc" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">您可以用<code class="fe ms mt mu mv b">kfp.components.create_components_from_func</code>从一个函数创建一个组件，我们将向它传递两个参数:要转换的函数和调用组件时应该运行的基本映像:</p><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="df3e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这就是为什么一些包被导入到函数中的原因。例如，<code class="fe ms mt mu mv b">boto3</code>并不像<code class="fe ms mt mu mv b">kfp</code>那样安装在Kubeflow的环境中。所以过早导入会返回错误；它应该被导入到函数中，因为它将在安装了<code class="fe ms mt mu mv b">boto3</code>的容器映像上运行。</p><h2 id="ecb7" class="ne lq iq bd lr nq nr dn lv ns nt dp lz ko nu nv md ks nw nx mh kw ny nz ml oa bi translated">第四步。创建管道</h2><p id="f51c" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">管道描述了要调用的一系列组件和传递它们的参数。它采用一个带有<code class="fe ms mt mu mv b">kfp.dsl.pipeline()</code> <br/>装饰器的函数的形式。</p><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="no np l"/></div></figure><h2 id="d960" class="ne lq iq bd lr nq nr dn lv ns nt dp lz ko nu nv md ks nw nx mh kw ny nz ml oa bi translated">第五步。完整管道</h2><p id="97d9" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">整个管道应该是这样的。复制并粘贴到Jupyter笔记本单元格中，不要忘记根据您的桶名和容器图像更改某些行URIs:</p><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="61fe" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mv b">%%writefile ./test_pipeline.py</code>行意味着运行该单元会将该脚本保存为您当前目录中的test_pipeline.py。</p><p id="293e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，使用jupyter笔记本上的以下命令将python管道转换为YAML:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="5159" class="ne lq iq mv b gy nf ng l nh ni">%%sh<br/>dsl-compile --py test_pipeline.py --output test_pipeline.yaml</span></pre><h1 id="369c" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">上传管道至库贝弗洛</h1><p id="5e5d" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">在库贝弗洛的中央仪表板上，转到“管道”并单击“上传管道”</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ob"><img src="../Images/7cae8a1b258d726985ef0aecadcf209a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3dGhPw_gAWE0pYXkhq5GwA.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">管道创建菜单。作者图片</p></figure><p id="e7b5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">给你的管道一个名称和一个描述，选择“上传一个文件”，并上传你新创建的YAML文件。点击“创建”。您应该在管道列表中看到您的管道。选择它，您将看到如下图:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oc"><img src="../Images/6f8bfd0ffd92c8bf59e389b44c01f6cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tepGtt5ALFLtODw87vSX-w.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">管道摘要。作者图片</p></figure><h1 id="5820" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">运行管道</h1><p id="6032" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">点击“创建运行”。您将需要选择或创建一个实验来运行您的管道。您还需要指定管道的参数，这些参数是您在<code class="fe ms mt mu mv b">unzip_and_read_pipeline</code>函数中定义的。</p><p id="2140" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">请注意，字符串参数的指定必须不带引号</strong>。<code class="fe ms mt mu mv b">my_bucket_name</code>将被正确处理，而<code class="fe ms mt mu mv b">'my_bucket_name'</code>不会！</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi od"><img src="../Images/13797ef6535cb78eaa228f0799878936.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S427vwTBfZF_21qPdf2qpw.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">启动菜单。作者图片</p></figure><p id="9eac" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">开始你的实验。</p><p id="92dc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果一切顺利，运行成功，您将看到结果屏幕:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oe"><img src="../Images/a206acbc33f579af61ca20218e5b88d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6nGLyQUxZeite1NaEeHCBg.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">实验总结。作者图片</p></figure><p id="9cf2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您点击任何任务，您将能够看到它的日志、输入参数以及输入和输出工件。</p><p id="dcf2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里，第二个任务不是很有用，但是您可以添加一些数据预处理说明来返回一个清理过的csv文件。</p><p id="faf5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就在那里！一个基本的库贝弗洛管道！</p><p id="3189" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通常，您希望避免将所有的功能都写在jupyter笔记本中，而是将它们放在GitHub存储库中。</p><p id="d972" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">GitHub Actions允许您构建一个容器映像并将其推送到ECR，ECR包含您的所有脚本，您可以在以后构建管道时导入这些脚本。</p></div></div>    
</body>
</html>