<html>
<head>
<title>Four Custom SHAP Plots</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">四个自定义SHAP图</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/four-custom-shap-plots-8605d73b4570#2022-01-03">https://towardsdatascience.com/four-custom-shap-plots-8605d73b4570#2022-01-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""><h1 id="d2db" class="pw-post-title ir is it bd iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp bi translated">四个自定义SHAP图</h1></div><div class=""><h2 id="88ec" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">超越Python包，创建SHAP值的定制可视化</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e8f2f35769a1cdeb632c225a9f807168.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_8JOEHnp4VZiUjKh7aqAnQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:作者</p></figure><p id="90c2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">SHAP值是理解模型如何进行预测的重要工具。SHAP软件包提供了许多可视化，使这个过程更加容易。话虽如此，我们不必完全依赖这个一揽子方案。通过创建我们自己的SHAP图，我们可以进一步了解模型是如何工作的。在这篇文章中，我们将解释四个定制的SHAP情节，以及你能从中学到什么。你可以在<a class="ae lu" href="https://github.com/conorosully/medium-articles/blob/master/src/shap_custom.ipynb" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到用来创建图的代码。</p><p id="f056" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你刚到SHAP，那么看看<strong class="la iu">下面的<strong class="la iu">视频</strong>。</strong>如果你想要更多，那就来看看我的<a class="ae lu" href="https://adataodyssey.com/courses/shap-with-python/" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu"> SHAP课程</strong> </a> <strong class="la iu">。</strong>注册我的<a class="ae lu" href="https://mailchi.mp/aa82a5ce1dc0/signup" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu">简讯</strong> </a>:)即可免费获取</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="b5fc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">讨论的一个图是图1中的瀑布图。这是可视化单个预测的SHAP值的好方法。你的模型做出的每一个预测都会有自己的瀑布图。它可用于准确解释每个特征对最终预测的影响。例如，这只鲍鱼的壳重使预测的年轮数减少了1.82。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lx"><img src="../Images/a5bcaeeaa8f5c3147833619a68255ebf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1322/format:webp/1*7dwToLGpWD9GWEWjO5lDgA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图1:使用鲍鱼数据集和XGBoost创建的瀑布图</p></figure><p id="6469" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了创建这个图，我们首先必须使用SHAP包计算SHAP值。然后，我们将这些值传递给提供的瀑布图函数。还有许多其他可用的情节，但我们不一定要使用它们。一旦我们有了SHAP价值观，我们就可以自由地创造我们自己的观想。现在，让我们开始我们的第一个。</p><h1 id="07fd" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated"><strong class="ak">地块1: SHAP对比热图</strong></h1><p id="0ff6" class="pw-post-body-paragraph ky kz it la b lb mq ju ld le mr jx lg lh ms lj lk ll mt ln lo lp mu lr ls lt im bi translated">正如我们在瀑布图中看到的，对于给定的预测，模型中的每个要素都有一个SHAP值。我们能够计算出这些SHAP值在所有预测中的相关性。对每一个成对的特征组合都这样做，我们可以构建一个如图2所示的SHAP相关热图。这里我们可以看到，例如，鲍鱼壳的<strong class="la iu">直径</strong>和<strong class="la iu">高度</strong>的SHAP值的相关性为0.4。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mv"><img src="../Images/145599485844d29e01f1ce847ef81c3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eGzohV8qWxcM_vr00xmGpA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图2: SHAP相关矩阵</p></figure><p id="87f3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们可以将其与图3所示的标准关联热图进行比较。这是使用特征值创建的，可以告诉我们这些特征是否相关。换句话说，它可以告诉我们两个特征是否倾向于向相同或相反的方向移动。另一方面，SHAP值给出了要素对预测的贡献。因此，SHAP相关将告诉我们两个特征是否倾向于在相同的方向上移动预测。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mw"><img src="../Images/d046e1e7673b09efc94098fab39ec3ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1bBuq8dEQviV5EPlByNgNg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图3:标准相关矩阵</p></figure><p id="d929" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们已经可以看到一些不同之处。请注意，在图3中，总重量和去皮重量呈正相关(1)。相比之下，这些特征的SHAP值是负相关的(-0.5)。即使这些特征以相同的方向移动，它们的贡献也倾向于以相反的方向移动预测。直觉上，这似乎很奇怪。一个潜在的原因是这两个特征之间存在相互作用。</p><p id="1f1a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">另一个区别是SHAP相关可以计算连续变量和分类变量。这是因为SHAP值将始终是连续的，无论它们是针对哪个要素计算的。这就是为什么三个二元变量(即性别。我，性。m和性。f)包括在SHAP关联热图中，但不包括在标准关联热图中。</p><h1 id="6e5c" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">图<strong class="ak"> 2:调整后的瀑布图</strong></h1><p id="1bc5" class="pw-post-body-paragraph ky kz it la b lb mq ju ld le mr jx lg lh ms lj lk ll mt ln lo lp mu lr ls lt im bi translated">下一个情节更多的是对现有的SHAP情节的补充。在本文的开始，在图1中，我们看到了一个瀑布图。通过包含一些附加信息，我们可以了解更多关于预测的信息。查看图4，我们添加了鲍鱼的实际环数(即y=7)。我们还为每个特性添加了一个分布图。红线给出了该特征的平均值。虚线给出了用于进行预测的实际特征值。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mx"><img src="../Images/001b4274169b57cacc3d572c2a5cdeaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NhHl-xjuCEj4U2QADsxCHA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图4:带有特性分布的瀑布图</p></figure><p id="9f0b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">图5是可视化该信息的另一种方式。这里，特征被颜色块包围，颜色由特征的值决定。我们坚持SHAP一揽子方案使用的惯例。如果某个特性的值相对于该特性的平均值较低，则该块会更蓝。如果特征值较高，该块将为红色。在图4中，我们可以看到大多数特征值都低于平均值(即红线左侧)。这对应于您在图5中看到的所有蓝色块。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi my"><img src="../Images/87f5c57204107b2d2a907f51fd86fccb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mZsmXjtPtiY3SRmVvQCP8g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图5:带有特征颜色的瀑布图</p></figure><p id="6819" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">通过在上面的图中包括实际的年轮数y，我们可以看到这个模型对这种鲍鱼有多精确。如果我们看到预测值与实际值非常不同，我们对SHAP值的解释可能会改变。在我们的例子中，预测值与实际值非常接近。如果它们不同，我们可以查看瀑布图，以了解是否有任何特征导致了不正确的预测。</p><p id="b3cb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">通过包括分布图或色块，我们给出了特征值的上下文。这让我们能够更全面地解释为什么模型会做出这样的预测。在我们看到哪个因素对预测贡献最大之前。现在，我们可以开始理解为什么这个特性如此重要。为了更好地理解这一点，我们来举一个银行业的例子。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/2b742b886c11b01f9517eafe8cec2976.png" data-original-src="https://miro.medium.com/v2/resize:fit:512/format:webp/1*RI39dea1C1Z4BMcKQ5xBnQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:<a class="ae lu" href="https://www.flaticon.com/premium-icon/bankruptcy_2979948?term=bankruptcy&amp;page=1&amp;position=4&amp;page=1&amp;position=4&amp;related_id=2979948&amp;origin=search" rel="noopener ugc nofollow" target="_blank"> flaticon </a></p></figure><p id="a061" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">假设我们建立一个用于接受/拒绝贷款申请的模型。月收入可能是一个重要因素。随着这一特征的减少，你更有可能拖欠贷款。假设模型拒绝了一个应用程序。在我们能够说“我们拒绝了你的申请，你的月收入是这个决定的主要驱动力”之前。现在有了一个调整后的瀑布图，我们可以说，“我们拒绝了你的申请。这是因为你的月收入远低于我们一般客户。”</p><h1 id="0802" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">图3:交互热图</h1><p id="2f66" class="pw-post-body-paragraph ky kz it la b lb mq ju ld le mr jx lg lh ms lj lk ll mt ln lo lp mu lr ls lt im bi translated">接下来我们要看的两个图是SHAP相互作用值的可视化。如果你不熟悉这些，我建议你阅读下面的文章。我们将深入探讨如何解释这些价值。总而言之，对于一个给定的预测，我们将有一个SHAP相互作用值的矩阵。矩阵的对角线给出了主要效应，而非对角线给出了交互效应。每个预测都有一个这样的矩阵。</p><div class="na nb gp gr nc nd"><a rel="noopener follow" target="_blank" href="/analysing-interactions-with-shap-8c4a2bc11c2a"><div class="ne ab fo"><div class="nf ab ng cl cj nh"><h2 class="bd iu gy z fp ni fr fs nj fu fw is bi translated">分析与SHAP的互动</h2><div class="nk l"><h3 class="bd b gy z fp ni fr fs nj fu fw dk translated">使用SHAP Python包来识别和可视化数据中的交互</h3></div><div class="nl l"><p class="bd b dl z fp ni fr fs nj fu fw dk translated">towardsdatascience.com</p></div></div><div class="nm l"><div class="nn l no np nq nm nr ks nd"/></div></div></a></div><p id="6b2c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了创建第三个图，我们首先计算所有相互作用值矩阵中每个细胞的绝对平均值。相互作用的影响减半，因此我们也将非对角线乘以2。然后，我们可以将其显示为热图，如图6所示。热图将围绕对角线对称，因此我们只显示下半部分。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/8a5f962721881931a6e0970ab2fcdf16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qQB-lS3wq-743azbjv7hKQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图6: SHAP互动价值观热图</p></figure><p id="236f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">该图类似于均值SHAP图，因为它可以突出重要的特征。除了现在，我们可以突出重要的主效应和交互效应。例如，我们可以看到，平均主效应对于体验、程度、性能和销售都很大。这告诉我们，这些特征往往会对模型的预测产生重大影响。同样，我们可以看到，体验程度和绩效销售互动的影响是显著的。</p><h1 id="68db" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated"><strong class="ak">剧情4:互动瀑布剧情</strong></h1><p id="3b70" class="pw-post-body-paragraph ky kz it la b lb mq ju ld le mr jx lg lh ms lj lk ll mt ln lo lp mu lr ls lt im bi translated">我们的最后一个图是SHAP互动值的瀑布图。这可以用与普通瀑布图相同的方式来解释。除了现在我们不能看到主效应和交互效应是如何对预测起作用的。例如，体验<strong class="la iu">主效果</strong>增加了35.99美元的预测奖金。类似地，体验度<strong class="la iu">互动效应</strong>增加了13.76美元的预测奖金。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/9ee463eb05c3c81e9bab7c94fdbd644e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y-7UAHpI4-uqWfnJq6mwmQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图7:交互瀑布图</p></figure><p id="db86" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你看看用来创建这个情节的代码，你会发现我们已经相当狡猾。问题是SHAP软件包没有提供一种方法来可视化预测的相互作用值。通过一点工作，我们能够使用为正常SHAP值创建瀑布图的函数。如图8所示，这涉及到将二维矩阵中的交互值转换为一维数组。一旦我们有了这个数组，我们可以把它传递给瀑布函数，SHAP会把它当作一组正常的SHAP值。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/acb2f75c9d7d1861fc757206905f23e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*abJok0ZnZ6MkSgTJ2KFuhw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图8:交互矩阵到交互数组</p></figure></div><div class="ab cl nv nw hx nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="im in io ip iq"><p id="5f88" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">支持我成为我的<a class="ae lu" href="https://conorosullyds.medium.com/membership" rel="noopener"> <strong class="la iu">推荐会员</strong> </a> <strong class="la iu"> :) </strong></p><div class="na nb gp gr nc nd"><a href="https://conorosullyds.medium.com/membership" rel="noopener follow" target="_blank"><div class="ne ab fo"><div class="nf ab ng cl cj nh"><h2 class="bd iu gy z fp ni fr fs nj fu fw is bi translated">通过我的推荐链接加入Medium康纳·奥沙利文</h2><div class="nk l"><h3 class="bd b gy z fp ni fr fs nj fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="nl l"><p class="bd b dl z fp ni fr fs nj fu fw dk translated">conorosullyds.medium.com</p></div></div><div class="nm l"><div class="oc l no np nq nm nr ks nd"/></div></div></a></div><p id="7356" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">|<a class="ae lu" href="https://twitter.com/conorosullyDS" rel="noopener ugc nofollow" target="_blank">Twitter</a>|<a class="ae lu" href="https://www.youtube.com/channel/UChsoWqJbEjBwrn00Zvghi4w" rel="noopener ugc nofollow" target="_blank">YouTube</a>|<a class="ae lu" href="https://mailchi.mp/aa82a5ce1dc0/signup" rel="noopener ugc nofollow" target="_blank">时事通讯</a> —注册免费参加<a class="ae lu" href="https://adataodyssey.com/courses/shap-with-python/" rel="noopener ugc nofollow" target="_blank"> Python SHAP课程</a></p><h2 id="1378" class="od lz it bd ma oe of dn me og oh dp mi lh oi oj mk ll ok ol mm lp om on mo oo bi translated">图像来源</h2><p id="4c46" class="pw-post-body-paragraph ky kz it la b lb mq ju ld le mr jx lg lh ms lj lk ll mt ln lo lp mu lr ls lt im bi translated">所有图片都是我自己的或从<a class="ae lu" href="http://www.flaticon.com/" rel="noopener ugc nofollow" target="_blank">www.flaticon.com</a>获得的。在后者的情况下，我拥有他们的<a class="ae lu" href="https://support.flaticon.com/hc/en-us/articles/202798201-What-are-Flaticon-Premium-licenses-" rel="noopener ugc nofollow" target="_blank">保费计划</a>中定义的“完全许可”。</p><h2 id="5801" class="od lz it bd ma oe of dn me og oh dp mi lh oi oj mk ll ok ol mm lp om on mo oo bi translated">参考</h2><p id="f2bb" class="pw-post-body-paragraph ky kz it la b lb mq ju ld le mr jx lg lh ms lj lk ll mt ln lo lp mu lr ls lt im bi translated">南伦德伯格，<em class="op"> SHAP蟒包</em> (2021) <em class="op">，</em>T22】https://github.com/slundberg/shap</p><p id="8fd0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">南伦德伯格和s .李，<em class="op">解释模型预测的统一方法</em> (2017)，<a class="ae lu" href="https://arxiv.org/pdf/1705.07874.pdf" rel="noopener ugc nofollow" target="_blank">https://arxiv.org/pdf/1705.07874.pdf</a></p></div></div>    
</body>
</html>