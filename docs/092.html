<html>
<head>
<title>How to Use Set Operations in SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在SQL中使用集合运算</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-use-set-operations-in-sql-53d57c4f7b77#2022-01-04">https://towardsdatascience.com/how-to-use-set-operations-in-sql-53d57c4f7b77#2022-01-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""><h1 id="720e" class="pw-post-title ir is it bd iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp bi translated">如何在SQL中使用集合运算</h1></div><div class=""><h2 id="0b1c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解并集、交集和例外运算符</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/fe11008cb71ea7702b411f333ba94284.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oyfxMuG28eTqAyPG"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">雷纳多·凯文在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="d703" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">数据专业人员通常需要从多个来源收集信息。虽然<a class="ae ky" href="https://en.wikipedia.org/wiki/Join_(SQL)" rel="noopener ugc nofollow" target="_blank">连接</a>的概念被广泛教授，并经常出现在面试问题中，但它们的近亲<a class="ae ky" href="https://en.wikipedia.org/wiki/Set_operations_(SQL)" rel="noopener ugc nofollow" target="_blank">集合运算符</a>却不经常受到同样的关注。</p><p id="89ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这两种方法都从多个来源收集数据，可以是子查询表。联接将结果作为新列返回，并要求表之间有一个公共列。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lv"><img src="../Images/fa4883a0ce18b1cbaaeb19b13d2c49c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y44SDRtCh5Gfn6IcWXDDpg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">连接的结果查询将添加新数据作为列。图由作者制作。</p></figure><p id="5fad" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">相比之下，集合运算符将结果作为新行返回，不一定需要表中的任何公共行。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lw"><img src="../Images/2d8a518dbbc14e452426cc3c6fab33ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1046/format:webp/1*nbfhuV2RApzODkwt3ZpZZw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">集合运算符的结果查询将添加新数据作为行。图由作者制作。</p></figure><p id="8f31" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">集合运算符包括UNION (ALL)、INTERSECT和EXCEPT/MINUS。为了演示如何使用它们，将使用两个表生成一个样本数据集:clients和transactions。客户端表将简单地列出一个客户端ID和它们的名称。交易表将包括交易ID、相应的客户ID和交易值。</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="dcca" class="mc md it ly b gy me mf l mg mh">CREATE TABLE clients(<br/>    id INTEGER PRIMARY KEY,<br/>    name CHAR(255)<br/>);</span><span id="65da" class="mc md it ly b gy mi mf l mg mh">CREATE TABLE transactions(<br/>    id INTEGER PRIMARY KEY,<br/>    client_id INTEGER,<br/>    value INTEGER<br/>);</span></pre><h1 id="3c65" class="mj md it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">UNION运算符</h1><p id="577a" class="pw-post-body-paragraph kz la it lb b lc na ju le lf nb jx lh li nc lk ll lm nd lo lp lq ne ls lt lu im bi translated">在形式数学中，<a class="ae ky" href="https://en.wikipedia.org/wiki/Union_(set_theory)" rel="noopener ugc nofollow" target="_blank">并</a>是两个集合的完全组合。类似地，在SQL中，<a class="ae ky" href="https://www.w3schools.com/sql/sql_union.asp" rel="noopener ugc nofollow" target="_blank"> UNION </a>操作符组合两个SELECT语句的结果，并删除任何重复的结果。</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="0487" class="mc md it ly b gy me mf l mg mh">SELECT <em class="nf">column_1</em> FROM <em class="nf">source_1</em></span><span id="04d7" class="mc md it ly b gy mi mf l mg mh">UNION</span><span id="4eb7" class="mc md it ly b gy mi mf l mg mh">SELECT <em class="nf">column_2</em> FROM <em class="nf">source_2;</em></span></pre><p id="8946" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">union操作符的语法非常简单。第一行代码给出了一个SELECT语句，从一个源中提取一列，这个源可以是一个表，也可以是一个子查询。第二行提供了UNION运算符。第三行列出了要与第一个语句合并的下一个SELECT语句。</p><p id="3441" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，两个SELECT语句必须包含相同数量的列。</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="361f" class="mc md it ly b gy me mf l mg mh">SELECT id FROM clients<br/>UNION<br/>SELECT client_id FROM transactions;</span></pre><p id="79c1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在一个简单的例子中，上面的查询返回clients表中的所有id以及transaction表中列出的所有客户端id。默认情况下，UNION运算符将删除两个SELECT语句之间的任何重复项。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/54a78bb7f3bfe08d870e93acd165dd05.png" data-original-src="https://miro.medium.com/v2/resize:fit:118/format:webp/1*BQ6AqaeEj6mNAoutyx5Nwg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">包含所有id的一列</p></figure><p id="b251" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">若要包含重复项，可以改用UNION ALL运算符。它使用完全相同的语法，可以在与UNION运算符相同的上下文中使用。</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="5a96" class="mc md it ly b gy me mf l mg mh">SELECT id FROM clients<br/>UNION ALL<br/>SELECT client_id FROM transactions;</span></pre><p id="6133" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，UNION操作符与所有其他集合操作符一样，不需要select列之间的正式关系。出于实用性考虑，选择了id，但是在UNION中可以用于在同一列中返回客户名称和事务值。</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="fe3d" class="mc md it ly b gy me mf l mg mh">SELECT name FROM clients<br/>UNION<br/>SELECT value FROM transactions;</span></pre><p id="1f8b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然这是有效的语法，但结果的值是可疑的:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/2d2727d9c6c7af847f79acdc96206981.png" data-original-src="https://miro.medium.com/v2/resize:fit:274/format:webp/1*k75QJidJ7k8W54WeYPy1gw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">交易值和客户端名称都显示在同一(截断的)列中。</p></figure><p id="bdb7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">集合操作符组合信息而不考虑关系或缺乏关系的能力为它们提供了很大程度的灵活性，特别是在那些设计不良或维护混乱的数据库中。不幸的是，同样的灵活性也允许无意义的结果。</p><h1 id="486d" class="mj md it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">交集运算符</h1><p id="f25a" class="pw-post-body-paragraph kz la it lb b lc na ju le lf nb jx lh li nc lk ll lm nd lo lp lq ne ls lt lu im bi translated">可以预见的是，<a class="ae ky" href="https://www.geeksforgeeks.org/sql-intersect-clause/" rel="noopener ugc nofollow" target="_blank"> INTERSECT </a>操作符在数据相交的地方连接行。换句话说，它只组合两个查询共有的数据。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/13f3f1d164556ccdf8b96ea8af75ff19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1068/format:webp/1*4DKuFaf2bl-U8oPrRTafWw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">该查询只返回3和4，因为它们在两个表中是相同的。图由作者制作。</p></figure><p id="a5e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">INTERSECT运算符的语法与UNION运算符完全相同。</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="21ad" class="mc md it ly b gy me mf l mg mh">SELECT <em class="nf">column_1</em> FROM <em class="nf">source_1</em></span><span id="21f2" class="mc md it ly b gy mi mf l mg mh">INTERSECT</span><span id="15f3" class="mc md it ly b gy mi mf l mg mh">SELECT <em class="nf">column_2</em> FROM <em class="nf">source_2</em></span></pre><p id="a259" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">像前面一样，第一行和第三行专用于将要组合的SELECT语句。在它们之间，INTERSECT运算符连接它们。</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="bcdf" class="mc md it ly b gy me mf l mg mh">SELECT id FROM clients<br/>WHERE id % 2 = 0</span><span id="ac68" class="mc md it ly b gy mi mf l mg mh">INTERSECT</span><span id="01b8" class="mc md it ly b gy mi mf l mg mh">SELECT client_id FROM transactions<br/>WHERE client_id % 3 = 0;</span></pre><p id="26b9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上面的示例中，第一个SELECT语句查询clients表中所有能被2整除的id。然后，INTERSECT操作符将它与第二个SELECT语句结合起来，后者从transactions表中提取所有可被3整除的客户id。</p><p id="cd77" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，该查询将返回所有可被6整除的客户端id，因为所有可被6整除的数字也可被2和3整除。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/8449b3f739dc309ba9abd64daeae9822.png" data-original-src="https://miro.medium.com/v2/resize:fit:104/format:webp/1*6Z4MDv9XaE7nlb7KuDIpTg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">所有6的倍数的id</p></figure><h1 id="b148" class="mj md it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">EXCEPT运算符</h1><p id="2ab8" class="pw-post-body-paragraph kz la it lb b lc na ju le lf nb jx lh li nc lk ll lm nd lo lp lq ne ls lt lu im bi translated">当INTERSECT查询两个源之间的公共数据时，EXCEPT运算符返回一个源独有的数据。值得注意的是，有些数据库不接受EXCEPT关键字，而是使用MINUS。这两者没有区别，因为它们都具有相同的功能。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/663977a75c0207efe400cebb2239543d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1034/format:webp/1*tCLF1stQa4l8aWysyCb94w.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">该查询返回1和2，因为它们对于表1是唯一的。图由作者制作。</p></figure><p id="157e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">EXCEPT的语法与其他集合运算符完全一样。</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="a67b" class="mc md it ly b gy me mf l mg mh">SELECT <em class="nf">column_1</em> FROM <em class="nf">table_1</em></span><span id="cb87" class="mc md it ly b gy mi mf l mg mh">EXCEPT</span><span id="8624" class="mc md it ly b gy mi mf l mg mh">SELECT <em class="nf">column_2</em> FROM <em class="nf">table_2</em>;</span></pre><p id="1949" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或者，使用减号关键字:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="f46f" class="mc md it ly b gy me mf l mg mh">SELECT <em class="nf">column_1</em> FROM <em class="nf">table_1</em></span><span id="caee" class="mc md it ly b gy mi mf l mg mh">MINUS</span><span id="24fd" class="mc md it ly b gy mi mf l mg mh">SELECT <em class="nf">column_2</em> FROM <em class="nf">table_2</em>;</span></pre><p id="6758" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">举一个具体的例子，可以编写一个简单的查询来确定哪些客户id出现在事务表中，而没有出现在客户表中。在理想情况下，事务表中的客户机ID不会不出现在客户机表中，但是有时糟糕或仓促的设计选择加上糟糕的维护也会产生类似的结果。</p><p id="a4d9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，编写一个快速查询来确定哪些客户机id需要添加到clients表中，这将证明是非常有益的。</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="d98f" class="mc md it ly b gy me mf l mg mh">SELECT client_id FROM transactions<br/>EXCEPT<br/>SELECT id from clients;</span></pre><p id="09b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第一个SELECT语句查询事务表中的所有客户机id，但是EXCEPT语句强制它排除第二个SELECT语句，后者提取clients表中已经存在的所有id。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/b1249128bb9675106d5297705dcf9bb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:268/format:webp/1*t7OtKlSO6jW2IM96tDwehg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">事务中的所有客户端id，但不在客户端中</p></figure><p id="4deb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，结果提供了一个需要添加到clients表中的所有客户机id的列表(以及与数据库管理员关于实施表间关系的对话)。</p><h1 id="9932" class="mj md it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">结论</h1><p id="bd46" class="pw-post-body-paragraph kz la it lb b lc na ju le lf nb jx lh li nc lk ll lm nd lo lp lq ne ls lt lu im bi translated">尽管集合运算符的使用频率不如联接，但它仍然可以通过向结果中添加行来连接数据。忽略数据源之间的任何关系，它们在编写查询时提供了无与伦比的灵活性。由于有大量的用例，它们是SQL中不被重视的部分。</p></div></div>    
</body>
</html>