<html>
<head>
<title>Tips &amp; Tricks of Deploying Deep Learning Webapp on Heroku Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Heroku Cloud上部署深度学习Webapp的技巧和诀窍</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/tips-tricks-of-deploying-deep-learning-webapp-on-heroku-cloud-80ea9063211a#2022-01-10">https://towardsdatascience.com/tips-tricks-of-deploying-deep-learning-webapp-on-heroku-cloud-80ea9063211a#2022-01-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""><h1 id="2178" class="pw-post-title io ip iq bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">在Heroku Cloud上部署深度学习Webapp的技巧和诀窍</h1></div><div class=""><h2 id="0254" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">通过在Heroku服务器上部署基于Tensorflow的图像分类器Streamlit应用程序，我学到了一些东西</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/b2ee4cfa65c83f02de1420625c5b89e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z3fH05duIMwB-HjcJem-QQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="9817" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">Heroku是web开发人员和机器学习爱好者中的一个著名平台。该平台提供了一种部署和维护web应用程序的简单方法，但如果您不熟悉部署深度学习应用程序，您可能会遇到存储和依赖问题。</p><p id="3829" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">本指南将使您的部署过程更加紧凑，这样您就可以专注于创建令人惊叹的web应用程序。我们将学习DVC集成、基于Git和CLI的部署、错误代码H10、使用python包以及优化存储。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="30ba" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">基于Git和CLI的部署</h1><p id="639c" class="pw-post-body-paragraph kv kw iq kx b ky mr jr la lb ms ju ld le mt lg lh li mu lk ll lm mv lo lp lq ij bi translated">Streamlit应用程序可以通过基于Git的GitHub集成或使用Docker来部署。基于Git是在Heroku服务器上部署任何数据应用程序的更快更简单的方法。</p><h2 id="f2b3" class="mw ma iq bd mb mx my dn mf mz na dp mj le nb nc ml li nd ne mn lm nf ng mp nh bi translated"><strong class="ak">简单的基于Git的</strong></h2><p id="ded6" class="pw-post-body-paragraph kv kw iq kx b ky mr jr la lb ms ju ld le mt lg lh li mu lk ll lm mv lo lp lq ij bi translated">可以使用以下方式部署streamlit应用程序:</p><pre class="kg kh ki kj gt ni nj nk nl aw nm bi"><span id="0b27" class="mw ma iq nj b gy nn no l np nq">git remote add heroku https://heroku:$HEROKU_API_KEY@git.heroku.com/&lt;name of your heroku app&gt;.git<br/><br/>git push -f heroku HEAD:master</span></pre><p id="22c6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">为此，您需要:</strong></p><ul class=""><li id="3d32" class="nr ns iq kx b ky kz lb lc le nt li nu lm nv lq nw nx ny nz bi translated">Heroku API密钥</li><li id="26b5" class="nr ns iq kx b ky oa lb ob le oc li od lm oe lq nw nx ny nz bi translated">Heroku App:通过CLI或使用网站。</li><li id="a760" class="nr ns iq kx b ky oa lb ob le oc li od lm oe lq nw nx ny nz bi translated">基于Git的项目</li><li id="e57b" class="nr ns iq kx b ky oa lb ob le oc li od lm oe lq nw nx ny nz bi translated">Procfile</li><li id="e0ce" class="nr ns iq kx b ky oa lb ob le oc li od lm oe lq nw nx ny nz bi translated">Requirements.txt</li></ul><h2 id="ba84" class="mw ma iq bd mb mx my dn mf mz na dp mj le nb nc ml li nd ne mn lm nf ng mp nh bi translated">基于CLI</h2><p id="18df" class="pw-post-body-paragraph kv kw iq kx b ky mr jr la lb ms ju ld le mt lg lh li mu lk ll lm mv lo lp lq ij bi translated">基于CLI的部署是简单易学的。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi of"><img src="../Images/bc4ad779a75a771aa0fd743f598b7184.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3GCNZ_SMxFXBqTG617zH9A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><ol class=""><li id="cb76" class="nr ns iq kx b ky kz lb lc le nt li nu lm nv lq og nx ny nz bi translated">在这里创建一个<strong class="kx ir">免费</strong> Heroku账号<a class="ae lr" href="https://signup.heroku.com/" rel="noopener ugc nofollow" target="_blank">。</a></li><li id="11c0" class="nr ns iq kx b ky oa lb ob le oc li od lm oe lq og nx ny nz bi translated">使用此<a class="ae lr" href="https://devcenter.heroku.com/articles/heroku-cli#download-and-install" rel="noopener ugc nofollow" target="_blank">链接</a>安装Heroku CLI。</li><li id="3b01" class="nr ns iq kx b ky oa lb ob le oc li od lm oe lq og nx ny nz bi translated">克隆远程存储库或使用<code class="fe oh oi oj nj b">git init</code></li><li id="9ae1" class="nr ns iq kx b ky oa lb ob le oc li od lm oe lq og nx ny nz bi translated">类型<code class="fe oh oi oj nj b">heroku login</code>和<code class="fe oh oi oj nj b">heroku create dagshub-pc-app</code>。这将使您登录到服务器并在web服务器上创建一个应用程序。</li><li id="c0f0" class="nr ns iq kx b ky oa lb ob le oc li od lm oe lq og nx ny nz bi translated">现在创建<strong class="kx ir"> Procfile </strong>，其中包含运行应用程序的命令:<code class="fe oh oi oj nj b">web: streamlit run --server.port $PORT streamlit_app.py</code></li><li id="d177" class="nr ns iq kx b ky oa lb ob le oc li od lm oe lq og nx ny nz bi translated">最后，将代码提交并推送到heroku服务器<code class="fe oh oi oj nj b">git push heroku master</code></li></ol><h1 id="56cf" class="lz ma iq bd mb mc ok me mf mg ol mi mj jw om jx ml jz on ka mn kc oo kd mp mq bi translated">港口</h1><p id="901b" class="pw-post-body-paragraph kv kw iq kx b ky mr jr la lb ms ju ld le mt lg lh li mu lk ll lm mv lo lp lq ij bi translated">如果您使用<code class="fe oh oi oj nj b">streamlit run app.py</code>运行应用程序，它将产生一个错误代码<strong class="kx ir"> H10 </strong>，这意味着服务器分配的<strong class="kx ir"> $PORT </strong>未被streamlit应用程序使用。</p><p id="5dca" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">你需要:</strong></p><ul class=""><li id="d5e1" class="nr ns iq kx b ky kz lb lc le nt li nu lm nv lq nw nx ny nz bi translated">使用Heroku CLI设置端口</li></ul><pre class="kg kh ki kj gt ni nj nk nl aw nm bi"><span id="856c" class="mw ma iq nj b gy nn no l np nq">heroku config:set PORT=8080</span></pre><ul class=""><li id="42c7" class="nr ns iq kx b ky kz lb lc le nt li nu lm nv lq nw nx ny nz bi translated">在您的<strong class="kx ir"> Procfile </strong>中进行更改，并在参数<strong class="kx ir">中添加服务器端口。</strong></li></ul><pre class="kg kh ki kj gt ni nj nk nl aw nm bi"><span id="03ac" class="mw ma iq nj b gy nn no l np nq">web: streamlit run --server.port $PORT app.py</span></pre><h1 id="1bc9" class="lz ma iq bd mb mc ok me mf mg ol mi mj jw om jx ml jz on ka mn kc oo kd mp mq bi translated">调整Python包</h1><p id="2f9f" class="pw-post-body-paragraph kv kw iq kx b ky mr jr la lb ms ju ld le mt lg lh li mu lk ll lm mv lo lp lq ij bi translated">这部分花了我两天时间调试，因为Heroku cloud有<strong class="kx ir"> 500MB </strong>的限制，而新的<a class="ae lr" href="https://pypi.org/project/tensorflow/#files" rel="noopener ugc nofollow" target="_blank"> TensorFlow </a>包是<strong class="kx ir"> 489.6MB </strong>。为了避免依赖性和存储问题，我们需要对<strong class="kx ir"> requirements.txt </strong>文件进行更改:</p><ol class=""><li id="2d21" class="nr ns iq kx b ky kz lb lc le nt li nu lm nv lq og nx ny nz bi translated">添加<strong class="kx ir"> tensorflow-cpu </strong>代替tensorflow，这将使段塞大小从765MB减少到400MB。</li><li id="70b9" class="nr ns iq kx b ky oa lb ob le oc li od lm oe lq og nx ny nz bi translated">添加<strong class="kx ir"> opencv-python-headless </strong>代替opencv-python，避免安装外部依赖。这将解决所有cv2错误。</li><li id="bea1" class="nr ns iq kx b ky oa lb ob le oc li od lm oe lq og nx ny nz bi translated">移除除<strong class="kx ir">数字、枕头</strong>和<strong class="kx ir">流线型</strong>之外的所有不必要的包装。</li></ol><h1 id="f995" class="lz ma iq bd mb mc ok me mf mg ol mi mj jw om jx ml jz on ka mn kc oo kd mp mq bi translated">DVC一体化</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi op"><img src="../Images/a115e94ba55b956059e21025b2eaf571.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Km6EEXwm0XDMOKC-E8Mhtw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="a130" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">从DVC服务器成功提取数据需要几个步骤。</p><ol class=""><li id="89da" class="nr ns iq kx b ky kz lb lc le nt li nu lm nv lq og nx ny nz bi translated">首先，我们将安装一个<a class="ae lr" href="https://elements.heroku.com/buildpacks/heroku/heroku-buildpack-apt" rel="noopener ugc nofollow" target="_blank">构建包</a>，它将允许使用Heroku API <code class="fe oh oi oj nj b">heroku buildpacks:<strong class="kx ir">add</strong> --<strong class="kx ir">index</strong> 1 heroku-community/apt</code>安装apt文件</li><li id="f44b" class="nr ns iq kx b ky oa lb ob le oc li od lm oe lq og nx ny nz bi translated">创建一个文件名<strong class="kx ir"> Aptfile </strong>并添加最新的DVC版本<a class="ae lr" href="https://github.com/iterative/dvc/releases/download/2.8.3/dvc_2.8.3_amd64.deb" rel="noopener ugc nofollow" target="_blank">https://github . com/iterative/DVC/releases/download/2 . 8 . 3/DVC _ 2 . 8 . 3 _ amd64 . deb</a></li><li id="641a" class="nr ns iq kx b ky oa lb ob le oc li od lm oe lq og nx ny nz bi translated">在您的<strong class="kx ir"> app.py </strong>文件中添加额外的代码行，以从远程DVC服务器获取数据:</li></ol><pre class="kg kh ki kj gt ni nj nk nl aw nm bi"><span id="59f0" class="mw ma iq nj b gy nn no l np nq"><strong class="nj ir">import</strong> os<br/><br/><strong class="nj ir">if</strong> "DYNO" <strong class="nj ir">in</strong> os.environ <strong class="nj ir">and</strong> os.path.isdir(".dvc"):<br/>    os.system("dvc config core.no_scm true")<br/>    <strong class="nj ir">if</strong> os.system(f"dvc pull") != 0:<br/>        exit("dvc pull failed")<br/>    os.system("rm -r .dvc .apt/usr/lib/dvc")</span></pre><p id="e7fa" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">之后，提交并推送你的代码到Heroku服务器。成功部署后，该应用程序将自动从DVC服务器拉数据。</p><h1 id="873d" class="lz ma iq bd mb mc ok me mf mg ol mi mj jw om jx ml jz on ka mn kc oo kd mp mq bi translated">优化存储</h1><p id="a4fc" class="pw-post-body-paragraph kv kw iq kx b ky mr jr la lb ms ju ld le mt lg lh li mu lk ll lm mv lo lp lq ij bi translated">优化存储有多种方法，最常用的是使用Docker。通过使用docker，你可以绕过500MB的限制，你也可以自由地安装任何第三方集成或软件包。要了解更多关于如何使用docker的信息，请查看本指南。</p><p id="fdff" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">用于优化存储:</strong></p><ul class=""><li id="5503" class="nr ns iq kx b ky kz lb lc le nt li nu lm nv lq nw nx ny nz bi translated">仅在requiremnets.txt中添加模型推理python库</li><li id="620f" class="nr ns iq kx b ky oa lb ob le oc li od lm oe lq nw nx ny nz bi translated">我们可以通过使用<code class="fe oh oi oj nj b">dvc pull {model} {sample_data1} {sample_data2}..</code>从DVC提取选择性数据</li><li id="d7e7" class="nr ns iq kx b ky oa lb ob le oc li od lm oe lq nw nx ny nz bi translated">我们只需要模型推理文件，所以将其余文件添加到<code class="fe oh oi oj nj b">.slugignore</code>中，它的工作方式类似于<code class="fe oh oi oj nj b">.gitignore</code>，以了解更多信息，请查看<a class="ae lr" href="https://devcenter.heroku.com/articles/slug-compiler#ignoring-files-with-slugignore" rel="noopener ugc nofollow" target="_blank"> Slug编译器</a>。</li><li id="8021" class="nr ns iq kx b ky oa lb ob le oc li od lm oe lq nw nx ny nz bi translated">从服务器成功拉取数据后，删除<code class="fe oh oi oj nj b">.dvc</code>和<code class="fe oh oi oj nj b">.apt/usr/lib/dvc </code>目录。</li></ul></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="6209" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">结果</h1><p id="f9d4" class="pw-post-body-paragraph kv kw iq kx b ky mr jr la lb ms ju ld le mt lg lh li mu lk ll lm mv lo lp lq ij bi translated">最初的块大小是850MB，但随着存储和封装的优化，最终的块大小减少到400MB。我们用一个简单的命令解决了错误代码H10，并添加了opencv-python-headless包来解决依赖性问题。本指南旨在解决Heroku服务器初学者面临的一些常见问题。</p><p id="f267" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">基于<a class="ae lr" href="https://devcenter.heroku.com/categories/deploying-with-docker" rel="noopener ugc nofollow" target="_blank"> Docker的</a>部署可以解决很多存储问题，但它带来了复杂性和缓慢的部署过程。您可以使用<code class="fe oh oi oj nj b">heroku container:push web</code>,但在此之前，您需要构建docker，测试它，并在本地解决所有问题，然后才能推送它。这种方法是高级Heroku用户的首选。</p><p id="7a5c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">下一个挑战是用webhook部署您的web应用程序。这将允许您从任何平台自动化整个机器学习生态系统。自动化过程将包括创建一个运行shell命令的简单Flask web服务器。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="7ed8" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">额外资源</h1><ul class=""><li id="34be" class="nr ns iq kx b ky mr lb ms le oq li or lm os lq nw nx ny nz bi translated"><a class="ae lr" href="https://www.r-bloggers.com/2020/12/creating-a-streamlit-web-app-building-with-docker-github-actions-and-hosting-on-heroku/" rel="noopener ugc nofollow" target="_blank">创建一个Streamlit web应用程序，使用Docker + GitHub操作进行构建，并托管在Heroku | R-bloggers上</a></li><li id="3072" class="nr ns iq kx b ky oa lb ob le oc li od lm oe lq nw nx ny nz bi translated"><a class="ae lr" rel="noopener" target="_blank" href="/deploying-an-image-classification-web-app-with-python-3753c46bb79">使用Python部署影像分类Web应用| Ruben Winastwan |面向数据科学</a></li><li id="7db7" class="nr ns iq kx b ky oa lb ob le oc li od lm oe lq nw nx ny nz bi translated"><a class="ae lr" href="https://github.com/GuilhermeBrejeiro/deploy_ML_model_Heroku_FastAPI" rel="noopener ugc nofollow" target="_blank">GuilhermeBrejeiro/deploy _ ML _ model _ Heroku _ FastAPI</a></li><li id="e460" class="nr ns iq kx b ky oa lb ob le oc li od lm oe lq nw nx ny nz bi translated">Heroku CLI | Heroku开发中心</li></ul></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="c800" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="ot">原载于2021年12月24日</em><a class="ae lr" href="https://www.kdnuggets.com/2021/12/tips-tricks-deploying-dl-webapps-heroku.html" rel="noopener ugc nofollow" target="_blank"><em class="ot">K</em>Dnuggets</a><em class="ot">。</em></p></div></div>    
</body>
</html>