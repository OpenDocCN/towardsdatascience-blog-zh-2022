# dbt 中的分期模式、中间模式和集市模式

> 原文：<https://towardsdatascience.com/staging-intermediate-mart-models-dbt-2a759ecc1db1>

## 在数据构建工具(dbt)的上下文中理解登台、中间和集市模型的目的

![](img/b86fcbb3fc5cd9e65c588e3deed0698e.png)

照片由[米利安·耶西耶](https://unsplash.com/@mjessier?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)在 [Unsplash](https://unsplash.com/s/photos/data-model?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上拍摄

在我最近的一篇文章中，我讨论了如何正确地[构建 dbt 项目和数据模型](/dbt-models-structure-c31c8977b5fc)。当没有特定的规则和设计原则时，创建新的数据模型和维护现有的数据模型可能是乏味的任务。对于大多数组织来说，数据模型库可能会快速增长，因此如果管理不当，它可能会变成一片混乱。

正如我们在上一篇文章中讨论的，使用数据构建工具(dbt)构建数据模型的过程包括将模型分成三个主要层，即 **staging** 、 **intermediate** 和 **marts。**在接下来的几节中，我们将深入探讨每一层，并浏览一些有助于区分它们的基本概念。在这个小教程结束的时候，你应该能够告诉你应该在这些层中的哪一层放置新创建的模型(或者可能应该在哪一层插入重构的模型)。

## 分期模型

**staging 层**包含项目的所有独立组件，其他层将使用这些组件来创建更复杂的数据模型。过渡模型应该有一个**一对一的关系**(或映射)到**源** **表**。

因此，重要的是保持它们的简单性，并尽量减少转换。在 staging 层的上下文中可以接受的一些转换类型包括*类型转换*、*列重命名*、*基本计算*(例如 KBs 到 MBs 或 GBs)、*分类*(例如使用`CASE WHEN`语句)。

假设阶段模型对应于我们最终数据模型的初始构建块，我们通常**将它们具体化为视图**。这种策略允许引用 staging 层的任何中间或集市模型访问**新数据**，同时它**节省了我们的空间**并降低了成本。

此外，应该避免**连接**，因为它们可能导致**冗余**或**重复**计算。这样的操作应该在随后的层中执行。

最后，还应该避免**聚合**，因为这种操作会对我们的数据进行分组。这一层的目的是为后续和更复杂的数据模型构建基本的构建模块，因此，我们不希望**限制自己**并可能**失去对有价值的源数据**的访问。

## 中间模型

**中间层**将驻留在 staging 层上的原子构建块集合在一起，以便构建更复杂和更有意义的模型。即使中间模型用于表示对业务方面更有意义的结构，它们**也不应该通过仪表板或应用**直接暴露给最终用户**。**

由于这样的模型对最终用户来说是不可见的，在大多数情况下，**暂时存储** **它们****更有意义。临时模型不是直接在数据库/数据集上创建的，而是将它们的代码插入到模型中，作为[公共表表达式](https://medium.com/towards-data-science/cte-sql-945e4b461de3)引用它们。但是，请注意，在某些情况下，将它们作为视图素材是有意义的。鉴于它们是短暂的，这意味着它们不能被直接选择，因此故障排除变得有点痛苦。此外，通过`run-operation`调用的宏不能引用(即`ref()`短暂模型)。所以由你来决定一个特定的中间模型是应该短暂地物化还是作为一个视图，但是我的建议是从短暂的物化开始，除非这对特定的用例不再起作用。**

**每当您决定将它们具体化为视图时，在[自定义模式](https://docs.getdbt.com/docs/build/custom-schemas)中这样做可能更容易，自定义模式是在您的 dbt 概要文件中定义的主模式之外的模式。**

**现在来看看这种模型的实际用途，如果您仍然不确定是否需要创建一个中间模型，那么请记住，中间层由将不同实体集合在一起的模型组成，以便**吸收来自最终市场模型的** **复杂性**。此外，应该以一种维护甚至促进组件可读性和灵活性的方式使用它们。**

**最后，一个好的经验法则是你在其他模型中引用一个中间模型的频率。如果同一个模型被多个模型引用，那么这意味着我们的设计可能出错了。这种现象通常表明，我们可能不得不考虑将我们的中间模型变成一个宏观模型。**

## **集市模型**

****顶层**应该包括所谓的**集市模型。**换句话说，这是一个所有东西都聚集在一起的地方，业务定义的实体被构建，并通过仪表板或应用程序随时可供最终用户使用。**

**由于这一层包含最终用户正在访问的模型，这意味着性能很重要。因此，**将它们具体化为表格**是有意义的。如果创建一个表需要太多时间(或者可能花费太多)，那么您可能还需要考虑将其配置为一个**增量模型**。**

**注意，集市模型应该相对简单，因此，**应该避免太多的连接**。如果您发现了这种不规则性，那么一个好的做法是后退一步，重新考虑您的设计——在大多数情况下，这种设计缺陷可以在中间层得到纠正。**

## **最后的想法**

**在 dbt 中创建结构良好的项目是非常重要的，因为可靠的设计将帮助您快速增长和维护您的数据模型库，更重要的是，不会一直碰壁。**

**这个过程的一个重要方面是三层设计的定义和实施 dbt 文档中也提出了这一点——包括阶段模型、中间模型和集市模型。概括一下，**

****分期** **车型**应该:**

*   **被具体化为**视图****
*   **仅使用基本转换，如类型转换、列重命名、基本计算和分类**
*   ****避免** **连接**和/或**聚合****

****中级车型**应该:**

*   **短暂地具体化**(或者作为自定义模式中的视图)****
*   ******不向最终用户公开**(通过应用或仪表板)****
*   ****用于隔离复杂的操作****
*   ****不要在一个以上的模型中被重复引用(如果是这种情况，考虑将中间模型变成一个宏)****

******商场型号**应:****

*   ****具体化为**表**或**增量** **模型******
*   ******在单个集市模型中避免过多的连接******

****[**成为会员**](https://gmyrianthous.medium.com/membership) **阅读介质上的每一个故事。你的会员费直接支持我和你看的其他作家。你也可以在媒体上看到所有的故事。******

****[](https://gmyrianthous.medium.com/membership) **** 

******相关文章你可能也喜欢******

****[](/dbt-models-structure-c31c8977b5fc) **** ****[](/install-dbt-1bd6a4259a14) **** ****[](/visual-sql-joins-4e3899d9d46c) ****