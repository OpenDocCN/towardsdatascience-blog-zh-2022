# 探索 Python 类型提示

> 原文：<https://towardsdatascience.com/exploring-python-type-hints-6520f478b6a>

![](img/a1f8a2222d28cd22cfb147bc7d1dfe02.png)

马蒂亚斯·马尔卡在 [Unsplash](https://unsplash.com/s/photos/java-and-python?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上的照片

# 探索 Python 类型提示

## 如何让您的代码经得起未来的考验

我最近在 Python 中发现了一些有趣的功能，我已经开始尝试在日常编程中更多地使用这些功能。在这篇文章中，我想介绍 Python 类型提示，并讨论为什么我认为它们是你编程工作流程中真正强大的补充。

如果你是一个狂热的 Python 用户，你可能会发现最初的类型提示非常奇怪，甚至可能是不和谐的，但是希望在这篇文章结束时，我会让你相信事实并非如此，实际上它们真的可以改善你的代码库，并从长远来看使你的生活更容易。

为了了解它们为什么有用，让我们看下面的代码片段，它定义了一个将两个数相加的函数。我们可以看到，当我们输入一个字符串，并尝试将它与一个整数相加时，我们会得到一个可爱的 TypeError。现在，这是一个超级简单的例子，但是如果我们使用一个更大的代码库，我们可能不会注意到这个错误，直到我们真正尝试运行代码。这通常会很成问题。

```
def add_two_numbers(a, b):
   return a+b>>> add_two_numbers(1, '3')Traceback (most recent call last):File "<stdin>", line 1, in <module>TypeError: unsupported operand type(s) for +: 'int' and 'str'
```

# 静态与动态类型

上面我们提供了一个简单的类型错误的例子。让我们简单讨论一下为什么 Python 中会出现这个问题。为此，我们需要讨论静态和动态类型。如果你曾经使用过像 C 或 Java 这样的编程语言，你会知道你需要为你创建的变量声明数据类型。在 Java 中，我们可以使用下面的代码创建一个字符串变量。这些变量类型不允许改变。也就是说，如果我们试图将一个整型变量重新赋值给字符串变量，我们会得到一个错误。

```
String string_variable;
string_variable = "This is a string";
```

***静态类型*** 的第二个重要方面是当类型错误被捕获时。因为像 java 这样的编程语言是编译的，所以编译器会在运行任何代码之前检查代码的正确性。如果你的代码中有类型错误，那么这就是它们被发现的时候。这提供了一些优于 Python 等解释型语言的优势。特别是，尽早捕捉错误可以避免在调试代码上花费大量时间。

然而 Python 是 ***动态类型化的。这意味着我们不必显式声明我们的变量类型。这也意味着 Python 会在代码运行时检查任何类型错误。例如，如果我们在 if-else 逻辑中嵌入了这些类型的错误，如果条件不满足，它就不会被捕获。以上面的字符串变量为例，如果我们试图给它重新赋值一个 int，代码会运行得很好，我们的 string_variable 现在是 int 类型。***

# 鸭子打字

另一个与动态类型化和 Python 密切相关的概念是 ***duck typing。*** 我听你问鸭子打字到底是什么神？嗯，我同意，这是一个奇怪的名字，但它来自短语:*如果它看起来像鸭子，像鸭子一样游泳，像鸭子一样嘎嘎叫，那么它可能*就是*鸭子。我们不一定关心对象的参数类型，我们关心的是对象的行为。如果它的行为像一只鸭子，那么实际上我们可以认为它是一只鸭子。*

我们举个例子来了解一下鸭子打字是怎么回事。因为我是一名数据科学家，所以我想看一个使用 sklearn 的实际例子。例如，如果我们想在一个建模管道中编码一些定制的转换，我们可以在 sklearn 中创建一个定制的转换器

***“由于 Scikit-Learn 依赖于 duck typing(不是继承)，所以你需要做的就是创建一个类，实现三个方法:fit()(返回自我)、transform()、fit _ transform()”(Geron 2019)。***

下面我们写一个自定义的转换器来估算数字数据。我们可以看到，只要我们实现了 fit 和 transform 方法，这将与 sklearn 完全兼容，并且可以与其他 sklearn 转换器一起用于管道中。这是通过 duck typing 实现的，因为 python 只关心我们的类是否具有与 transformer 相同的行为，也就是说，如果它有 transform 和 fit_transform 方法，那么它就会工作。Btw，下面没有 fit_transform 方法我们从 TransformerMixin 类继承时得到这个方法。[这里的](https://github.com/ageron/handson-ml/issues/391)很好地解释了这种行为。

*注意:这并不意味着所有动态类型的语言都被解释，所有静态类型的语言都被编译。例如，我们可以拥有动态类型的解释语言，尽管据我所知，它们并不常见。*

# 什么是 Python 类型提示，我为什么要关心？

好了，我们已经解释了动态、静态类型和鸭子类型之间的区别，但是为什么这很重要，这和类型提示有什么关系呢？尽管 Python 是一种动态类型语言，但我们可以使用类型提示来获得静态类型语言的一些好处。

类型提示(也称为类型注释)最初是在 [PEP 484](https://www.python.org/dev/peps/pep-0484/) 中引入的，它允许我们模仿静态类型语言的行为。我说 mimic 是因为 python 解释器完全忽略了类型提示。相反，类型提示依赖于用户使用 mypy 之类的工具单独运行检查，稍后会详细介绍。

那么我们实际上如何利用类型提示呢？文档详细介绍了使用类型提示的所有不同方式，但我将讨论一些您最常使用的方式。类型提示的语法非常简单和直观，如果你曾经用静态类型语言编写过代码，那么这对你来说并不陌生。如果您想开始使用类型提示，您将与之交互的主要模块是类型模块。它包含了我们将要用到的许多类型，比如列表、字典和元组等等。下面举个简单的例子，我们声明了一些变量，并说明了库中的一些类型。如果我们看一下 ***process_data*** 中稍微做作的例子，我们可以看到我们有两个输入，一个字符串列表和一个整数列表。我们也知道我们的输出应该是包含字符串和整数的元组列表。在我看来，这使得理解代码变得非常容易，而且实现起来也不需要太多额外的努力。

请注意，我们可以使用嵌套类型提示，这可能非常有用，但如果我们需要两层或三层嵌套，也可能非常笨拙。在这种情况下，我们实际上可以给一个变量分配一个类型提示，如下所示(类型别名)。恰当地使用变量可以大大提高代码的可读性，同时保持类型提示的优势。

```
years = Tuple[str, int]
year_list = List[years]
```

# 重访我们的定制变压器

下面我们更新上面写的代码，加入类型提示。大多数类型提示应该是清楚的。我们可以看到，我们也可以使用来自 pandas 的类型，这显然非常有用，因为 python 中的大多数数据分析都以某种方式使用 pandas。您可能想知道为什么我们将“CustomImputer”作为字符串包含在 fit 方法的返回中。这里有一个很好的理由来讨论。它被称为前向引用，因为我们引用的是尚未创建的类型。将它作为字符串文字包含在内可以解决这个问题。除此之外，代码应该非常清晰，希望比原始代码片段更清晰。

希望您会同意，显式声明数据类型会使代码立即变得更清晰。当我们有大型复杂的代码库时，这样做的优势会更加明显，但是请相信我，如果您需要重构别人的代码或者需要在将来重新访问您自己的代码，您会感谢自己花时间添加类型提示。

# Mypy:静态类型检查器

Mypy 是 Python 的静态类型检查器。它允许我们在实际运行之前检查代码中常见的类型错误。这个库和类型提示结合在一起，将 Java 等静态类型语言的优势带到了 Python 中。

让我们举一个 mypy 文档中概述的非常简单的例子。我们可以定义一个非常简单的函数，它接受一个字符串，并输出 hello，后跟我们的字符串输入。如果我们传入一个字符串并运行类型检查器，我们会正确地看到没有错误。但是，如果我们传递一个 int 或任何其他数据类型，我们会立即看到一个错误消息。同样，当我们处理较大的项目时，这个功能特别有用。

```
def main(name: str) -> str: return 'Hello ' + nameif __name__=='__main__':
    main('John') mypy program.py
>> Success: no issues found in 1 source filedef main(name: str) -> str: return 'Hello ' + nameif __name__=='__main__':
    main(10)mypy program.py
>> program.py:7: error: Argument 1 to "main" has incompatible type "int"; expected "str"
Found 1 error in 1 file (checked 1 source file)
```

mypy 的一个缺点是它不能与外部库一起工作。如果你更倾向于使用 numpy 和 pandas，那么探索一下[数据科学类型](https://pypi.org/project/data-science-types/)和 [pandas-stub](https://pypi.org/project/pandas-stubs/) 可能是值得的，它们允许你运行更多数据科学相关库的类型检查，比如 pandas、numpy 和 matplotlib。然而，数据科学类型库仍在开发中，所以它没有涵盖这些库中可用的所有类型。

```
pip install pandas-stub
pip install data-science-types
```

# 类型提示的优点和缺点

虽然我是类型提示的粉丝，使用它们有很多好处，但是它们也有一些缺点。就优势而言，我认为最大的优势之一是

*   **它迫使你思考你的函数输入和输出:**也就是说，一般来说，它让你更多地思考你的代码以及它是如何被设计使用的。对我来说，更深入地思考我正在编写的代码有助于提高我的编程技能。我认为仅仅这个理由就足够让我们开始使用它们了。

此外，使用类型提示非常重要，这意味着您的代码

*   **清晰的文档。清晰的文档使你的代码更容易阅读，不仅对你自己，对其他人也是如此。如果你曾经接手过别人的代码，并且认为，我不知道这些代码在做什么，你就会明白这有多重要。拥有清晰记录的代码在数据科学中似乎并不常见，但应该如此。**
*   **调试更容易:**如果到现在还不清楚，现在应该清楚了。使用类型提示可以使调试代码中的问题变得容易得多，并且在很多情况下可以完全避免一些错误，特别是在使用像 mypy 这样的静态类型检查器时。

类型提示的另一个优点是，它们

*   **可以逐步实现:**您可能认为，与您习惯的相比，这将在编写代码的时间方面增加大量开销，您可能是对的。好消息是，您不需要一次性重构整个代码库。类型提示可以逐步实现。

好吧，那么缺点是什么？即使你可以逐步实现类型提示，它们仍然可能是一个

*   大量的时间投入:虽然类型提示的基础非常简单，但是还有很多我在这篇文章中没有涉及到的内容。除了学习曲线之外，使用类型提示显然涉及到编写更多的代码，因此最初可能会导致开发时间增加。然而，通过减少调试花费的时间，这可以完全不在现场。我没有这方面的经验证据，但我完全可以相信，特别是对于更大更复杂的项目。
*   **它是否背离了 python 的简单和漂亮？**这与其说是一个明显的缺点，不如说是一个公开的问题，但是那些铁杆 than 爱好者可能不愿意用类型提示来亵渎他们美丽的代码。

# 建议和要点

应该使用类型提示吗？最终这取决于你，但希望这篇文章能给你一些启发，如果你还在犹豫不决，会让你更容易做出决定。就我个人而言，我喜欢类型提示，所以我尽量使用它们。我的建议是，如果你只是在 Jupyter 笔记本上做一些快速和肮脏的数据分析，使用它们的缺点可能大于优点，所以我可能不会打扰。然而，如果你正在做更大的项目和产品代码，我建议你试一试，看看它们是否能改善你的工作流程。

# 资源

*   【https://www.python.org/dev/peps/pep-0484/ 
*   [https://mypy.readthedocs.io/en/stable/introduction.html](https://mypy.readthedocs.io/en/stable/introduction.html)

# 我的其他一些帖子你可能会感兴趣

[](/building-machine-learning-pipelines-using-snowflake-and-dask-10ae5e7fff0f)  [](/lets-build-a-streaming-data-pipeline-e873d671fc57)  [](/a-bayesian-approach-to-time-series-forecasting-d97dd4168cb7) 