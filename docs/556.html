<html>
<head>
<title>Deploying Airflow on Google Kubernetes Engine with Helm</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Helm在Google Kubernetes引擎上部署气流</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploying-airflow-on-google-kubernetes-engine-with-helm-28c3d9f7a26b#2022-01-19">https://towardsdatascience.com/deploying-airflow-on-google-kubernetes-engine-with-helm-28c3d9f7a26b#2022-01-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""><h1 id="1923" class="pw-post-title io ip iq bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">使用Helm在Google Kubernetes引擎上部署气流</h1></div><div class=""><h2 id="f357" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">第一部分:使用Helm配置基本气流部署</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/6af8930d757fc31bac1d3b7fafabd7ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*n0awyZluw9X_rflp"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Reza Rostampisheh 在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="0622" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">目标</h1><p id="5ea8" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">这篇由两部分组成的文章将展示如何使用<a class="ae kv" href="https://airflow.apache.org/docs/helm-chart/stable/index.html" rel="noopener ugc nofollow" target="_blank">官方掌舵图</a>在GCP的Google Kubernetes引擎上部署和配置Apache Airflow。</p><p id="511c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在第一部分中，我们将:</p><ul class=""><li id="7964" class="mp mq iq lq b lr mk lu ml lx mr mb ms mf mt mj mu mv mw mx bi translated">在GKE建立一个Kubernetes集群。</li><li id="e84e" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated">使用Helm和values.yaml文件部署和配置Airflow。</li><li id="a5aa" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated">通过GCP负载均衡器在GKE上公开Airflow web服务器。</li></ul><p id="5543" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在本部分的最后，我们将有一个运行LocalExecutor的Airflow部署和一个通过GCP负载平衡器可访问的Airflow web服务器。但是没有任何匕首。</p><p id="b2ce" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在第二部分，我们将:</p><ul class=""><li id="d565" class="mp mq iq lq b lr mk lu ml lx mr mb ms mf mt mj mu mv mw mx bi translated">使用GKE秘密管理气流连接。</li><li id="d420" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated">通过从工件注册表加载的Docker映像安装气流依赖项和自定义操作符。</li><li id="0166" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated">使用git-sync特性从私有GitHub存储库中自动提取Airflow DAGs。</li><li id="211c" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated">整合谷歌云存储等其他GCP服务。</li></ul><p id="a98e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在第二部分之后，我们将使用一个DAG扩展我们的气流部署，该DAG将每天一批数据写入Google云存储桶。</p><h1 id="3197" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">介绍</h1><p id="668d" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">GCP是气流云提供商的绝佳选择。Apache-airflow-providers-GooglePython包提供了大量的air flow操作符、钩子和传感器。这使得将Airflow与许多GCP服务(如BigQuery和GCS)集成变得轻而易举。</p><p id="a8f6" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">值得注意的是，GCP提供了自己的气流管理部署，名为Cloud Composer。然而，通过管理我们自己在Kubernetes上的部署，我们保持了对底层基础设施的更细粒度的控制。这使我们能够针对特定使用情形优化基础架构，并降低成本。</p><h1 id="0b70" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">先决条件</h1><p id="ca13" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">本文假设您的工作站已经满足了先决条件:</p><ol class=""><li id="5e9b" class="mp mq iq lq b lr mk lu ml lx mr mb ms mf mt mj nd mv mw mx bi translated">一个名为“气流-gke”的GCP项目，有一个活跃的计费帐户(可能有免费试用信贷)。</li><li id="c4d9" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj nd mv mw mx bi translated">CLI工具<code class="fe ne nf ng nh b">gcloud</code>、<code class="fe ne nf ng nh b">kubectl</code>和<code class="fe ne nf ng nh b">helm</code>。</li></ol><p id="a91e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">如果你需要Kubernetes的快速介绍，请观看这个<a class="ae kv" href="https://www.youtube.com/watch?v=4ht22ReBjno" rel="noopener ugc nofollow" target="_blank">轻松视频</a>。</p><h1 id="85e4" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">1.在GKE创建一个库本内特星团</h1><p id="639e" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在GKE上初始化Kubernetes集群之前，我们必须首先在<code class="fe ne nf ng nh b">gcloud</code> CLI中使用项目ID设置项目:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="cb84" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">项目ID可以在GCP仪表板的项目信息面板中找到。您的GCP项目将有一个不同于本文中的项目ID。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/5a90fa225a1281fe5ba0d9f9d42f0b3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/0*iS_5msCncf0jhCsI"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="44f1" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在我们可以创建一个名为<code class="fe ne nf ng nh b">airflow-cluster</code>的集群，带有一个公共端点。你可以自由选择不同的地理区域。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="b4ae" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们将使用<code class="fe ne nf ng nh b">kubectl</code> CLI与我们在GKE新部署的Kubernetes集群进行交互。使用以下命令对该集群验证<code class="fe ne nf ng nh b">kubectl</code>:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="e298" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">最后，我们将使用<code class="fe ne nf ng nh b">kubectl</code> CLI为这个部署创建一个名为<code class="fe ne nf ng nh b">airflow</code>的Kubernetes名称空间。这不是绝对必要的，但是了解一下这个特性是如何工作的是值得的。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="f52d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">不要忘记在下面的<code class="fe ne nf ng nh b">kubectl</code>命令中将名称空间<code class="fe ne nf ng nh b">airflow</code>传递给<code class="fe ne nf ng nh b">--namespace</code>或<code class="fe ne nf ng nh b">-n</code>标志。</p><p id="7fdb" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">浏览到Kubernetes引擎上的<strong class="lq ir">集群</strong>选项卡，查看新创建的集群。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nl"><img src="../Images/8b2304024d0b6c63c2f4d3d7950ae6db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PiIB1kmNkAp_batg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><h1 id="b725" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">2.部署官方的阿帕奇气流舵图</h1><p id="66c1" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">现在，群集已经启动并运行，我们可以使用Helm安装气流。Helm是一个软件包管理器，它将Kubernetes应用程序捆绑到所谓的图表中。阿帕奇气流在2021年7月发布了气流的官方掌舵图。有了这个图表，我们可以相对容易地在我们新创建的Kubernetes集群上引导气流。</p><p id="808d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">首先在您的本地舵库中安装Apache Airflow的官方舵图:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="4d6a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">验证图表是否在您的本地存储库中:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="2d8c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在，只需一个命令，气流就可以部署在GKE上:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ni nj l"/></div></figure><ul class=""><li id="8eb8" class="mp mq iq lq b lr mk lu ml lx mr mb ms mf mt mj mu mv mw mx bi translated">第一个<code class="fe ne nf ng nh b">airflow</code>参数是我们给这个版本起的名字。</li><li id="1150" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated"><code class="fe ne nf ng nh b">apache-airflow/airflow</code>是我们部署的舵图。</li><li id="1502" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated">第二个<code class="fe ne nf ng nh b">airflow</code>参数是我们之前创建的Kubernetes名称空间。</li><li id="ae0c" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated">建议使用<code class="fe ne nf ng nh b">--debug</code>标志来查看进度和发现潜在问题。</li></ul><p id="dbb2" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">通过浏览到Kubernetes引擎上的<strong class="lq ir">服务&amp;入口</strong>选项卡来验证部署。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/14e4388077b9f59d5302536b05d24fb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cUn0pcdZ3vDim4DY"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="7947" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在这里，我们可以看到我们的气流部署的各种服务。默认情况下，舵图表被配置为使用CeleryExecutor，这就是为什么有<code class="fe ne nf ng nh b">airflow-flower</code>和<code class="fe ne nf ng nh b">airflow-redis</code>服务的原因。稍后我们将把它改为LocalExecutor。</p><h1 id="7315" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">3.通过端口转发到ClusterIP服务来访问Airflow web服务器</h1><p id="ac5b" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">默认情况下，Helm chart配置为对<code class="fe ne nf ng nh b">airflow-webserver</code>使用Kubernetes ClusterIP服务，如上图的Type列所示。该服务将请求路由到正确的pod，但没有外部端点。要从群集外部访问它，我们必须将pod的端口8080转发到我们工作站的端口8080:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="29c9" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在可以在<a class="ae kv" href="https://localhost:8080" rel="noopener ugc nofollow" target="_blank"> localhost:8080 </a>上访问网络服务器。默认凭证是用户名<code class="fe ne nf ng nh b">admin</code>和密码<code class="fe ne nf ng nh b">admin</code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/b0f052feb3a2801f2f814e2e040b468e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9j6tVtYHAubjcgaY"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="e7f6" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">每次我们想访问web服务器时都要转发端口，这很不方便。在下一节中，我们将用GCP负载平衡器替换Kubernetes ClusterIP服务，该负载平衡器将向外部公开Airflow web服务器。</p><h1 id="7a72" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">4.配置我们的气流部署</h1><p id="1bdb" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在本节中，我们将通过编辑Helm图表的values.yaml文件来修改部署。将当前部署的默认配置写入名为values.yaml的文件:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="3920" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们将使用该文件来更改部署的两个方面:气流执行器和web服务器服务。为此，请在values.yaml文件中编辑以下值:</p><ol class=""><li id="7fa2" class="mp mq iq lq b lr mk lu ml lx mr mb ms mf mt mj nd mv mw mx bi translated">将202行的<code class="fe ne nf ng nh b">CeleryExecutor</code>换成<code class="fe ne nf ng nh b">LocalExecutor</code>。</li><li id="5e48" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj nd mv mw mx bi translated">用752行的<code class="fe ne nf ng nh b">LoadBalancer</code>替换<code class="fe ne nf ng nh b">ClusterIP</code>服务。</li></ol><p id="737f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">一旦保存，您可以将文件传递给带有<code class="fe ne nf ng nh b">-f</code>标志的<code class="fe ne nf ng nh b">helm</code>命令，当我们<code class="fe ne nf ng nh b">upgrade</code>集群:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="627b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我们再次验证新的部署。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi no"><img src="../Images/fb68b31a79f87c27e45719400d07dded.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aeAAxQ6754_r6zII"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="0735" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">注意到Kubernetes的服务比以前少了吗？这是因为<code class="fe ne nf ng nh b">LocalExecutor</code>不需要Redis代理和Flower UI。因此，GKE删除了这些豆荚，代之以一个<code class="fe ne nf ng nh b">airflow-scheduler</code>服务。</p><p id="0cf6" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">还要注意<code class="fe ne nf ng nh b">airflow-webserver</code>服务现在是一个“外部负载平衡器”类型。GKE发现了从ClusterIP到LoadBalancer的变化，并自动为您创建了这个GCP服务。现在，您可以通过“端点”列中的IP地址访问web服务器。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/a712c6d7208d7b002804e675f7a0517e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6VE389-q60DDXGOA"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="25db" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">目前没有Dag。在本文的第二部分，我们将学习如何添加DAG及其依赖项。</p><h1 id="ab5b" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">结论</h1><p id="5125" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我们现在在GKE有一个功能齐全的气流部署。由于values.yaml文件存储了我们的配置，我们总是可以重新创建它。因此，建议通过命令行(或使用Terraform等工具)设置您的项目，并使用GCP界面来检查我们的工作。</p><p id="4601" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们看到了赫尔姆和GCP是如何在配置Kubernetes时抽象出大量的复杂性的。例如，仅仅用“负载平衡器”替换“集群IP”就足以使GCP加速旋转并为气流网络服务器配置负载平衡器。同样，通过将“CeleryExecutor”更改为“local executor ”, GCP负责终止冗余的flower和redis服务并启动调度程序服务。</p><p id="7d7c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在下一部分中，我们将通过添加DAG来进一步扩展我们的部署。我们将看到Apache-air flow-providers-Google包中的操作者如何轻松地集成各种GCP服务，如GCS。</p></div><div class="ab cl nq nr hu ns" role="separator"><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv"/></div><div class="ij ik il im in"><h1 id="9301" class="kw kx iq bd ky kz nx lb lc ld ny lf lg jw nz jx li jz oa ka lk kc ob kd lm ln bi translated">参考</h1><p id="0c8a" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">朱利安·德·鲁特，巴斯·哈伦斯拉克。(2021).<em class="oc">带阿帕奇气流的数据管道。</em>奥莱利。</p></div></div>    
</body>
</html>