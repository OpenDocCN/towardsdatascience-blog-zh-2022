<html>
<head>
<title>Transformer Unleashed: Deep Forecasting of Multivariate Time Series in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">变形金刚释放:Python中多元时间序列的深度预测</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/transformer-unleashed-deep-forecasting-of-multivariate-time-series-in-python-9ca729dac019#2022-01-05">https://towardsdatascience.com/transformer-unleashed-deep-forecasting-of-multivariate-time-series-in-python-9ca729dac019#2022-01-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="37d3" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">深度预测</h2><div class=""><h1 id="441a" class="pw-post-title jb jc it bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy bi translated">变形金刚释放:Python中多元时间序列的深度预测</h1></div><div class=""><h2 id="2a1b" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">端到端示例:具有复杂季节性的多变量时间序列的概率预测</h2></div><p id="2990" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">大多数经典预测方法仅限于单变量时间序列。只有少数几个接受多元数列，例如SARIMAX。当多种季节性模式也开始发挥作用时，神经网络可以很好地战胜传统方法。</p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div class="gh gi ln"><img src="../Images/e83dfca1408704e942867f19654e235e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*ZJynP4ii_gTYfvPFzHsogg.jpeg"/></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">超级英雄女孩Speed-pix abay上的免费图片</p></figure><p id="64f4" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">在今天的文章中，我们将揭开神经网络预测者中一个相对较新的东西:变压器模型。我们将把它放在一个多变量时间序列上，这个时间序列由三个季节组成:小时、工作日和月。这为神经网络提供了一个适当复杂的时间序列。</p><p id="b41d" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我们将预测西班牙的电价。</p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div class="ab gu cl ma"><img src="../Images/40a70aa4011f7b9a940e90208a26231c.png" data-original-src="https://miro.medium.com/v2/format:webp/1*3CdbhgUKb4fzYHqR2gR1VQ.png"/></div><p class="lv lw gj gh gi lx ly bd b be z dk translated"><a class="ae lz" href="https://www.kaggle.com/nicholasjhana/energy-consumption-generation-prices-and-weather" rel="noopener ugc nofollow" target="_blank">每小时能源需求生成和天气| Kaggle </a>(作者screesnhot)</p></figure><p id="d0c6" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">相关矩阵的屏幕截图显示了影响电价的许多因素。转换者将学习整合其中的相关因素作为协变量(回归变量)。</p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mb"><img src="../Images/30ca108c4a4470904ea337cfa48ca208.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pSo7PD4o2nB2xA8ryyvtkw.png"/></div></div></figure><p id="3e4d" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">下面，观察到的电价的橙色发热曲线告诉我们，涉及到一些季节性模式，但显然不止一种类型，因为我们看到不同振幅的振荡。</p><p id="5dc2" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">蓝色曲线是一种剧透。它揭示了我们将要构建的变压器将能够以合理的精度跟踪和预测锯齿形峰值和谷值。其在测试集上的平均绝对百分比误差小于5%。</p><p id="fae1" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">让我们看看它是如何得到预测的。</p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mg"><img src="../Images/4ce61e8880220113dd7abf98e8df8ab3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4lj6pcWcfH2jSezLdjltZg.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><h1 id="7e43" class="mh mi it bd mj mk ml mm mn mo mp mq mr ki ms kj mt kl mu km mv ko mw kp mx my bi translated">1.概念</h1><h2 id="75a0" class="mz mi it bd mj na nb dn mn nc nd dp mr la ne nf mt le ng nh mv li ni nj mx iz bi translated">1.1变压器神经网络</h2><p id="7bc5" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">2017年的一篇论文，“<a class="ae lz" href="https://arxiv.org/abs/1706.03762" rel="noopener ugc nofollow" target="_blank">注意力是你所需要的一切(arxiv.org)</a>”概述了基于注意力的网络的概念，最初是在自然语言处理的背景下。NLP处理按语法和句法排序的单词序列。基于注意力的网络，又名Transformer，获取输入文本序列，例如英语，并生成输出文本序列，例如西班牙语。时间序列分析使用按时间顺序排列的序列:时间步长。转换器必须从一系列训练观察值中沿着时间轴生成一个预测序列。</p><p id="ee81" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">所谓的<em class="np">注意力头</em>使转换器能够学习输入序列中一个时间步长和每隔一个时间步长之间的关系。在NLP训练中，它可以通过反向传播学会“注意”经常伴随其他单词的单词。这种上下文分析机制使它能够学会将单词与其他单词和序列关联起来。转换器更新其注意力权重，并降低最不相关的备选单词的等级。通过这种方式，它学习语法模式。得分矩阵表示其他单词与所讨论的单词的关联程度。</p><p id="ed30" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">这是我们将从单词序列转移到时间步骤序列的能力。</p><p id="7139" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">你可以在Ketan Doshi撰写的一系列三篇TDS文章中找到关于Transformer架构的更深入的解释:<a class="ae lz" rel="noopener" target="_blank" href="/transformers-explained-visually-part-1-overview-of-functionality-95a6dd460452"> Transformers直观解释| Ketan Doshi |迈向数据科学</a>。</p><h2 id="ff1c" class="mz mi it bd mj na nb dn mn nc nd dp mr la ne nf mt le ng nh mv li ni nj mx iz bi translated">1.2概率预测:分位数回归</h2><p id="50b7" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">确定性预测方法生成点估计值:在每个时间步长上的单个值(通常是平均值)。确定性预测没有揭示不确定的“真实”未来值可能出现的上限和下限。</p><p id="3596" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">概率预测方法在每个时间步计算不止一个样本。神经网络评估一个<em class="np">分位数损失</em>函数，一个传统损失函数的变体。我们将建议我们的转换器使用分位数回归来计算预测百分点。每个百分点代表一个单变量时间序列。分位数对(例如，1%/99%或10%/90%)将中央预测值的曲线括起来。概率图显示了由此产生的不确定性范围。</p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/676edb4327022ee11ac104329e6edcb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/1*b7zotGJvDnfL9vYY46Aa-Q.png"/></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="3d42" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">你可以在上周关于时间融合转换器的文章中找到关于概率预测的其他解释:</p><div class="nr ns gp gr nt nu"><a rel="noopener follow" target="_blank" href="/temporal-fusion-transformer-a-primer-on-deep-forecasting-in-python-4eb37f3f3594"><div class="nv ab fo"><div class="nw ab nx cl cj ny"><h2 class="bd jd gy z fp nz fr fs oa fu fw jc bi translated">时态融合转换器:Python深度预测入门</h2><div class="ob l"><h3 class="bd b gy z fp nz fr fs oa fu fw dk translated">端到端的例子:概率时间序列预测使用TFT，一个基于注意力的神经网络</h3></div><div class="oc l"><p class="bd b dl z fp nz fr fs oa fu fw dk translated">towardsdatascience.com</p></div></div><div class="od l"><div class="oe l of og oh od oi lt nu"/></div></div></a></div><h1 id="68c7" class="mh mi it bd mj mk ml mm mn mo mp mq mr ki ms kj mt kl mu km mv ko mw kp mx my bi translated">2.属国</h1><p id="326f" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">除了我们常用的核心包——pandas、numpy和matplotlib——我们还导入了seaborn的绘图功能，随后是几个<em class="np"> Darts </em>类:Transformer模型和一些用于预处理、评估和绘图的实用程序类。</p><p id="b3fa" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">早期的一篇文章提供了安装Darts包的指导:</p><div class="nr ns gp gr nt nu"><a rel="noopener follow" target="_blank" href="/temporal-loops-intro-to-recurrent-neural-networks-for-time-series-forecasting-in-python-b0398963dc1f"><div class="nv ab fo"><div class="nw ab nx cl cj ny"><h2 class="bd jd gy z fp nz fr fs oa fu fw jc bi translated">时间循环:Python中用于时间序列预测的递归神经网络简介</h2><div class="ob l"><h3 class="bd b gy z fp nz fr fs oa fu fw dk translated">一个关于LSTM，GRU和香草RNNs的教程-由Darts多方法预测库包装</h3></div><div class="oc l"><p class="bd b dl z fp nz fr fs oa fu fw dk translated">towardsdatascience.com</p></div></div><div class="od l"><div class="oj l of og oh od oi lt nu"/></div></div></a></div><p id="ed37" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我还导入了小而有用的<em class="np"> missingno </em>包来可视化任何可能影响源数据的空值。它是一个可选工具:您可以选择删除它的导入行和使用它的Juypter单元格，而不会影响脚本的其余部分。</p><p id="c3c9" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">像往常一样，在安装像PyTorch这样包装大型库的包之前，创建一个新的虚拟环境，就像Darts一样。</p><p id="1ead" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">三个可选的飞镖组件可以单独安装。除了Darts核心库，您还需要darts[torch]组件来处理神经网络。您可以省略另外两个选项:pmdarima和prophet包的Darts包装器。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><h1 id="5049" class="mh mi it bd mj mk ml mm mn mo mp mq mr ki ms kj mt kl mu km mv ko mw kp mx my bi translated">3.控制设置和常量</h1><p id="8473" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">我们设置了许多超参数来配置变压器模型和一些表示附加控制设置的其他常数。</p><p id="a36e" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">在右上方，注意参数<em class="np"> LOAD </em>。</p><ul class=""><li id="5e52" class="om on it kt b ku kv kx ky la oo le op li oq lm or os ot ou bi translated">当它设置为False时，脚本将在训练集上训练一个Transformer模型。</li><li id="9d3d" class="om on it kt b ku ov kx ow la ox le oy li oz lm or os ot ou bi translated">当Load设置为True时，脚本不会重新训练模型。相反，它将从当前的工作目录——您保存Jupyter笔记本的文件夹——加载一个先前保存的Transformer模型。将跳过冗长的培训课程，脚本将继续从加载的模型生成预测。</li><li id="9946" class="om on it kt b ku ov kx ow la ox le oy li oz lm or os ot ou bi translated">一旦训练会话完成，脚本将自动将新训练的模型保存在tar文件中。您可以在第2行修改它的文件名。</li></ul><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="be69" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">变压器的超参数:</p><ul class=""><li id="3015" class="om on it kt b ku kv kx ky la oo le op li oq lm or os ot ou bi translated"><strong class="kt jd">时期</strong>表示训练周期的数量:一次向前传递，随后是整个训练集的一次向后传递。我尝试了50个和100个纪元，最终确定了200个纪元，以达到令人满意的MAPE。通过将训练扩展到400个或更多个纪元，我们可能实现甚至低于4.5%的MAPE。</li><li id="f48c" class="om on it kt b ku ov kx ow la ox le oy li oz lm or os ot ou bi translated"><strong class="kt jd"> INLEN </strong>设置input_chunk_length:输入层的<strong class="kt jd">节点数。我们的时间序列具有每小时一次的频率，因此输入层大小应该至少包含24小时。一般来说，输入块需要足够大，以构成一个完整的季节周期，否则转换器将很难拼凑出季节模式。为了优化内存使用，输入层大小应该表示为2的幂。我用大于32(例如256，足够组成一周的168个小时)的输入块进行的实验在MAPE方面并没有产生更好的结果，但是伴随而来的是更长的训练时间。32是一天24小时之上的下一个二进制上限。</strong></li><li id="1bd0" class="om on it kt b ku ov kx ow la ox le oy li oz lm or os ot ou bi translated"><strong class="kt jd"> VALWAIT </strong>参数告诉转换器在尽可能多的时期之后更新损失函数，而不一定是在每个循环之后。</li><li id="aa5e" class="om on it kt b ku ov kx ow la ox le oy li oz lm or os ot ou bi translated"><strong class="kt jd"> FEAT </strong>设置输入中预期特征的数量，默认为512。我有一个可以接受的只有32的MAPE。对于时间序列分析来说，512看起来有点矫枉过正，可能会让我们面临过度拟合的风险。</li><li id="5a5e" class="om on it kt b ku ov kx ow la ox le oy li oz lm or os ot ou bi translated"><strong class="kt jd"> DIM_FF </strong>缩放前馈网络，默认值= 2048。我把它限制在128维。</li><li id="031c" class="om on it kt b ku ov kx ow la ox le oy li oz lm or os ot ou bi translated"><strong class="kt jd">头数</strong>定义注意头数，默认= 8。今天的例子适用于4，我认为这足以处理三个季节性订单和一个潜在的趋势或周期性组件。</li><li id="2411" class="om on it kt b ku ov kx ow la ox le oy li oz lm or os ot ou bi translated"><strong class="kt jd">编解码层数，</strong>默认= 6。对于大多数时间序列，我不期望需要超过4层来识别趋势和季节模式。过多的层会使模型容易过度拟合。</li><li id="1e87" class="om on it kt b ku ov kx ow la ox le oy li oz lm or os ot ou bi translated">0.1的<strong class="kt jd">丢失率</strong>告诉变压器在一个时期内随机关闭10%的节点。这可以防止网络过于深入地挖掘单个冻结的节点配置。</li><li id="a69f" class="om on it kt b ku ov kx ow la ox le oy li oz lm or os ot ou bi translated">非线性<strong class="kt jd">激活函数ACTF </strong>转换两层之间的吞吐量。我们可以在校正线性单位函数“relu”(默认)和高斯误差线性单位函数“gelu”之间进行选择。更深入的见解，见:<a class="ae lz" rel="noopener" target="_blank" href="/activation-functions-you-might-have-missed-79d72fc080a5">现代激活函数|走向数据科学</a>。</li><li id="69f0" class="om on it kt b ku ov kx ow la ox le oy li oz lm or os ot ou bi translated"><strong class="kt jd">批量大小</strong>表示在更新其权重矩阵之前，转换器将处理的样本数量。大批量可能会导致过度拟合，并可能会碰到系统的内存限制。小批量会导致梯度下降，从而不规则地改变方向。理想情况下，为了优化内存使用，批处理大小应该用2的幂来表示。初始大小32是数据科学来源中最常见的指导。我将批量大小提高了一个档次，超过了24小时:32小时是下一个二进制上限。</li><li id="8ef3" class="om on it kt b ku ov kx ow la ox le oy li oz lm or os ot ou bi translated"><strong class="kt jd"> N_FC，</strong>预测展望期，设置为1小时的时间段，提前1步预测。</li><li id="dc12" class="om on it kt b ku ov kx ow la ox le oy li oz lm or os ot ou bi translated">RAND将<strong class="kt jd">随机种子</strong>设置为一个可以在运行之间重现的值。</li><li id="7d81" class="om on it kt b ku ov kx ow la ox le oy li oz lm or os ot ou bi translated"><strong class="kt jd"> N_SAMPLES </strong>建议概率预测模型对尽可能多的预测值进行采样，以计算分位数。它代表单变量概率时间序列的第二个维度:时间轴上每个时间步长的样本。</li><li id="6b0d" class="om on it kt b ku ov kx ow la ox le oy li oz lm or os ot ou bi translated">FIGSIZE定义了图的默认尺寸<strong class="kt jd">。</strong></li><li id="abd3" class="om on it kt b ku ov kx ow la ox le oy li oz lm or os ot ou bi translated"><strong class="kt jd">分位数</strong>列出了概率预测<em class="np">的<strong class="kt jd">下限和上限</strong>。</em></li><li id="d8be" class="om on it kt b ku ov kx ow la ox le oy li oz lm or os ot ou bi translated">常数<strong class="kt jd"> SPLIT </strong>控制时间序列中用于训练的百分比。</li><li id="8bd2" class="om on it kt b ku ov kx ow la ox le oy li oz lm or os ot ou bi translated"><strong class="kt jd"> N_JOBS </strong>限制脚本可以并行声明的处理器。如果设置为-1，所有处理器都将对其可用。</li></ul><p id="43bb" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">一般来说，我建议最初将变压器的超参数——本质上是它的矩阵大小——设置为比默认值低的值。高默认数字可能源于PyTorch对NLP应用程序的关注。时间序列的特征通常比自然语言问题要少。非常高的设置会导致模型必须处理的矩阵呈指数级增长。过大的模型会增加过度拟合的风险。</p><h1 id="32a8" class="mh mi it bd mj mk ml mm mn mo mp mq mr ki ms kj mt kl mu km mv ko mw kp mx my bi translated">4.数据争论和探索</h1><h2 id="bc11" class="mz mi it bd mj na nb dn mn nc nd dp mr la ne nf mt le ng nh mv li ni nj mx iz bi translated">4.1源数据</h2><p id="bfdc" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">源数据可以在Kaggle上下载，并获得CC0公共域许可:</p><p id="d15e" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated"><a class="ae lz" href="https://www.kaggle.com/nicholasjhana/energy-consumption-generation-prices-and-weather" rel="noopener ugc nofollow" target="_blank">每小时能源需求生成和天气| Kaggle </a></p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div class="ab gu cl ma"><img src="../Images/40a70aa4011f7b9a940e90208a26231c.png" data-original-src="https://miro.medium.com/v2/format:webp/1*3CdbhgUKb4fzYHqR2gR1VQ.png"/></div><p class="lv lw gj gh gi lx ly bd b be z dk translated"><a class="ae lz" href="https://www.kaggle.com/nicholasjhana/energy-consumption-generation-prices-and-weather" rel="noopener ugc nofollow" target="_blank">每小时能源需求生成和天气| Kaggle </a>，作者截图</p></figure><p id="99e2" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">该源文件由两个csv文件组成，一个用于能源数据，另一个用于天气数据。</p><p id="b99b" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">能量文件包含</p><ul class=""><li id="17eb" class="om on it kt b ku kv kx ky la oo le op li oq lm or os ot ou bi translated">2015年至2018年西班牙电价水平的每小时记录，单位为欧元每百万瓦时(€/兆瓦时)；</li><li id="63dc" class="om on it kt b ku ov kx ow la ox le oy li oz lm or os ot ou bi translated">按来源分类的发电量(煤、天然气、风力等。)，以MWh计；</li><li id="d891" class="om on it kt b ku ov kx ow la ox le oy li oz lm or os ot ou bi translated">和能量需求(“负载”)，单位为MWh。</li><li id="cd4b" class="om on it kt b ku ov kx ow la ox le oy li oz lm or os ot ou bi translated">能源数据集由29列35，064行组成。</li></ul><p id="9a32" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">天气文件提供了2015年至2018年期间西班牙五个主要城市的每小时记录。我们没有“平均”的全国范围的天气数据集，因此分别位于伊比利亚半岛中心和对角的五个大都市地区必须作为整个西班牙的代表性样本。天气数据集包含178，000行，大约是能源数据集中的五倍，因为它是在5个城市之间逐项列出的。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi pa"><img src="../Images/9db4d3fb393213b56bf2db6eaa4d50c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UDzcJp6ux_rrIl_HRw0UDA.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi pb"><img src="../Images/6c1fe7baf785a55d7549906ae4e90cc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R6jT-CUCO8C12vMfTHYYgA.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="732c" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">除了发电和变化的需求负荷的影响之外，我们将研究温度、风速或湿度与电价的相关程度。</p><h2 id="c8cb" class="mz mi it bd mj na nb dn mn nc nd dp mr la ne nf mt le ng nh mv li ni nj mx iz bi translated">4.2能源数据</h2><p id="89bc" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">能源数据框架的<em class="np"> info() </em>函数揭示了我们将不得不处理相当多的空白:不包含任何值的列；和其他不提供35，064个非空值的完整补充的列。</p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi pc"><img src="../Images/aacdfd9bec479f707771fcece47cb844.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RFe_Xt_bESwotigdAju-hQ.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="423e" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">在第2行中，我们首先将“time”列转换为datetime变量。</p><p id="a940" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">在第6行检查重复的行，产生一个否定的结果。</p><p id="92da" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我们将日期时间列定义为数据帧的索引。</p><p id="ad67" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">第13行确认了我们不需要将任何非数字变量转换成数字。</p><p id="11bc" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">然后，第17到23行中的函数搜索间隙，如果找到了，就调用<em class="np"> missingno </em>图来可视化它们是如何分布在列和行中的。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi pd"><img src="../Images/f81059a9b5d86f39d67f6c5ed693e016.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jUsKv4LhW9vwHIwVs5-qzg.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="6fb1" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我们观察到两个空的特征列。在右边，我们注意到其他列的个别行中有一些间隙。</p><p id="9c29" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">在删除了第3行到第4行中的两个空列之后，我们在第8行中通过插值来填充剩余的空隙。</p><p id="cd75" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">对第10行中的差距进行最后的检查，确认我们已经成功地处理了所有缺失的值。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi pe"><img src="../Images/a5e2d876844ff05b9869525efda28408.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4Z_rRq6rHeIYeCkNlffmaw.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="213b" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">原始列名包含一些空格和特殊字符。让我们通过重命名这些列来消除它们。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi pf"><img src="../Images/225ac347b7b68cea608dc4b56c595f20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g-1hDwvkzAjWnvTgkIXpmw.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="1567" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">小时价格的线图揭示了一条垂直曲线，该曲线似乎不遵循稳定的长期趋势或单一可识别的季节性，而是围绕€60的平均价格波动。因为我们处理每小时的价格，我们必须假设时间序列服从三个季节性:</p><ul class=""><li id="0c44" class="om on it kt b ku kv kx ky la oo le op li oq lm or os ot ou bi translated">每日<strong class="kt jd">小时</strong>，受白天和营业时间不同用电水平的影响；太阳能的产生仅限于白天</li><li id="0ae3" class="om on it kt b ku ov kx ow la ox le oy li oz lm or os ot ou bi translated">工作日:工作日的用电量会比周末高</li><li id="7493" class="om on it kt b ku ov kx ow la ox le oy li oz lm or os ot ou bi translated"><strong class="kt jd">月份:</strong>季节性需求变化，由温差引起；以及太阳能和风能的季节性波动功率输出</li></ul><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi pg"><img src="../Images/dff14d4cf153d3444dc5b84c7aeb7472.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*naeFNXfQ9gMrsawmjv57jg.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><h2 id="9555" class="mz mi it bd mj na nb dn mn nc nd dp mr la ne nf mt le ng nh mv li ni nj mx iz bi translated">4.3天气数据</h2><p id="69c2" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">天气数据由17个特征列组成。info()函数告诉我们不需要处理任何丢失的值。</p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div class="gh gi ph"><img src="../Images/adb7a0bed9aba52faa34e87a73bb870f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1116/format:webp/1*5s1T65NX1FHIKYMWhoXwqg.png"/></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="d9ae" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我们首先将“dt_iso”列转换为datetime格式，使其与能源数据帧的datetime索引兼容。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi pi"><img src="../Images/3b0d1c341c26b8644061fdf3c14856aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bQ2AIkMnxbB_2eN34N5nEw.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="21ca" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">描述性统计揭示了一些明显代表异常值的值。</p><ul class=""><li id="59b1" class="om on it kt b ku kv kx ky la oo le op li oq lm or os ot ou bi translated">大气压力不可能上升到100万毫巴以上而不压碎甚至一艘核潜艇。</li><li id="1611" class="om on it kt b ku ov kx ow la ox le oy li oz lm or os ot ou bi translated">本世纪西班牙还没有记录到高达133千米/小时的风速。</li></ul><p id="be63" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">温度柱看起来很奇怪，数值超过300度。但是这些值只是用开尔文表示，因此并不意味着明显的异常值。</p><p id="1812" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">在第2行到第3行，我们删除了一些不相关或多余的列——这些列代表了定量列的口头总结；以及在过去3小时内测量的降雨量，这是多余的，只要我们也测量过去一小时的降雨量。</p><p id="420c" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">在第7行到第8行，我们将开尔文转换为摄氏度。</p><p id="4a44" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">第12到19行将数值转换成float32。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="1045" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">接下来，我们需要调查我们在描述性统计表中看到的异常值。</p><p id="4a56" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">2015年2月的几天，大气压力高得令人难以置信。它们的正常范围在1000毫巴左右的狭窄范围内。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div class="gh gi pj"><img src="../Images/60f752779d7e5b177e052393275819b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1192/format:webp/1*V7t5RVvpv5h64f61t9Xy-A.png"/></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="06c0" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">2017年5月11日，风速中出现了一个明显的异常值。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div class="gh gi pk"><img src="../Images/262c422d0951b653fe064699fb103abb.png" data-original-src="https://miro.medium.com/v2/resize:fit:914/format:webp/1*bUP9GxO-OdbxuMRC7v0NIw.png"/></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="0167" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">箱线图可以帮助我们获得异常值的直观线索。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="2baf" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">湿度和温度显示正常模式。最左边的零湿度可能是测量误差。我们可以考虑用相邻的非零值回填或前填来替换零值。但是在这个练习中，我保持它们不变。</p><p id="9205" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">然而，压力和风速的箱线图在标尺的高端隔离了一些严重的异常值。</p><div class="lo lp lq lr gt ab cb"><figure class="pl ls pm pn po pp pq paragraph-image"><img src="../Images/33c26095470aca9033fad30cef3ce616.png" data-original-src="https://miro.medium.com/v2/resize:fit:836/format:webp/1*xfy-OzMmpgPVZb04ULib1Q.jpeg"/></figure><figure class="pl ls pr pn po pp pq paragraph-image"><img src="../Images/76fa53363a7c9ca424f69a66acf8169b.png" data-original-src="https://miro.medium.com/v2/resize:fit:838/format:webp/1*GfaoNlZCBJxwxKgwxnAMIg.jpeg"/></figure></div><div class="ab cb"><figure class="pl ls ps pn po pp pq paragraph-image"><img src="../Images/364d7e4660b19c970f3d7c7a76135009.png" data-original-src="https://miro.medium.com/v2/resize:fit:860/format:webp/1*px6iKznf_3WbCanV9TRumg.jpeg"/></figure><figure class="pl ls pt pn po pp pq paragraph-image"><img src="../Images/9d060208f14e25e86a77e68903c3c470.png" data-original-src="https://miro.medium.com/v2/resize:fit:848/format:webp/1*s1I48ocaAGyBQRfEUh6u3w.jpeg"/><p class="lv lw gj gh gi lx ly bd b be z dk pu di pv pw translated">作者图片</p></figure></div><p id="dc3b" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">或者，我们可以使用seaborn的distplots来识别异常值。</p><p id="e1ad" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">温度曲线显示了一个正常的季节循环，从寒冷的冬天到酷热的夏天。如果不与第三方数据进行比较，我们将无法辨别明显的温和异常值。</p><p id="f3af" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">但是压力和风速分布的极端峰度和偏斜揭示了在它们的右尾部存在异常值。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><div class="lo lp lq lr gt ab cb"><figure class="pl ls px pn po pp pq paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><img src="../Images/1830fbe78ef91da830db7aa7da97ff89.png" data-original-src="https://miro.medium.com/v2/resize:fit:674/format:webp/1*IFlDNfgklmVVkZEbHty_FQ.jpeg"/></div></figure><figure class="pl ls py pn po pp pq paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><img src="../Images/f69a41be46b5c6013e816a177f2e21eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:662/format:webp/1*qJ5bkdPLpizwQ8d0qzzXyg.jpeg"/></div></figure><figure class="pl ls pz pn po pp pq paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><img src="../Images/1a63df342908a9be535e1bb84bf02845.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Ttp_UigQZYndjff2Q7W3wQ.jpeg"/></div><p class="lv lw gj gh gi lx ly bd b be z dk qa di qb pw translated">作者图片</p></figure></div><p id="e8aa" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">为了处理异常值，我在第2行到第5行用null替换了超过所选阈值的值。然后，第6行通过反向插值填充新创建的间隙。</p><p id="9af8" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">合理的阈值基于维基百科的西班牙极端天气日志:<a class="ae lz" href="https://en.wikipedia.org/wiki/List_of_atmospheric_pressure_records_in_Europe#Spain" rel="noopener ugc nofollow" target="_blank">欧洲大气压力记录列表—维基百科</a></p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="e48b" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">替换极值后，我们得到看起来正常的箱线图。</p><div class="lo lp lq lr gt ab cb"><figure class="pl ls qc pn po pp pq paragraph-image"><img src="../Images/65e451980213fb972970e80a3a1edd41.png" data-original-src="https://miro.medium.com/v2/resize:fit:850/format:webp/1*85CZoxMCDQt9R_A7HHIByg.jpeg"/></figure><figure class="pl ls qc pn po pp pq paragraph-image"><img src="../Images/a84fefa93ae4d5daceef52865fa67313.png" data-original-src="https://miro.medium.com/v2/resize:fit:850/format:webp/1*qs301jP8-J3W1LMjl21VQA.jpeg"/><p class="lv lw gj gh gi lx ly bd b be z dk pu di pv pw translated">作者图片</p></figure></div><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi qd"><img src="../Images/f218b5f05c521ff334333909a3802150.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tzoy8szeEl8J3VDMJGVQoA.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="2650" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">能源和天气时间序列具有兼容的日期时间索引。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi qe"><img src="../Images/74f39218a1e48f7f0d77e22569bae349.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WGXouEzFq53MKBbfaPLg_A.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="b892" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">记录了西班牙五个大城市的可用天气数据。</p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi qf"><img src="../Images/b49e75724754d8abb146245586a6619b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c8UVZmCT3fwcmwAdElgOSQ.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="35fa" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">当我们检查重复的城市和日期时间指数对的天气记录时，我们发现它们多达3076个。第4行删除了它们。</p><p id="a231" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">如果在第15行按城市分组，我们会发现每个城市现在有35，064条天气记录，与能源数据集中的记录数量相匹配。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi qg"><img src="../Images/439bc2585a86ced1b10622ed9858b52a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PUJMQpAX0dh36YmALx5wvA.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="ce19" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我们将每个城市的天气记录单独放在一个数据框架中，为能源和天气记录的合并做准备。第2行中的字典理解创建了特定于城市的数据帧。</p><p id="2573" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">城市名作为字典的关键字。例如，当我们选择关键字“Bilbao”时，我们可以从字典中检索巴斯克地区的数据帧。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi qh"><img src="../Images/bbc65c674c1e982c85488f6113c0db40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G3GUtxy9VSveNUwJ-cAzJQ.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><h1 id="fafc" class="mh mi it bd mj mk ml mm mn mo mp mq mr ki ms kj mt kl mu km mv ko mw kp mx my bi translated">5.准备数据</h1><h2 id="c3b9" class="mz mi it bd mj na nb dn mn nc nd dp mr la ne nf mt le ng nh mv li ni nj mx iz bi translated">5.1能源和气象数据的合并</h2><p id="0f2e" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">第3行到第7行中的循环从天气字典中获取特定于城市的数据帧，并通过使用<em class="np"> concat() </em>方法将它们沿着列轴插入到能源数据帧中。第4行到第5行用各自城市的名称标记天气列。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi qi"><img src="../Images/11bf34d7e2cf3b166d4f2d8378b63699.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*754exylm6SCTk4r04Lundg.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="602d" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">得到的数据帧df2有67列。</p><p id="d4ba" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">对空值的检查证实了我们不必处理不匹配。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi qj"><img src="../Images/ab8cc7f2931619a77a04dce8d4f9bb71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GfWgY9lCzICG0WlE1cyIyA.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="5eae" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">在样本外预测中，我们希望估计未来几个小时的电价。值得怀疑的是，历史价格或任何特征变量已经形成了持续数年的模式，并将影响我们12小时后观察的价格。我选择将源数据限制在最后一年的8760小时，即2018年1月至12月。否则，培训时间会成倍增加。训练将需要半天或一夜(我不愿意做出这种牺牲，因为我需要处理器的能力来狂看《无垠》的最后一季)。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi qk"><img src="../Images/8d12dec269af439c01be2c321667ffe9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ncxk5Sxfnd82rZTn5mzzeg.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><h2 id="f4ca" class="mz mi it bd mj na nb dn mn nc nd dp mr la ne nf mt le ng nh mv li ni nj mx iz bi translated">5.2特征提取</h2><h2 id="e843" class="mz mi it bd mj na nb dn mn nc nd dp mr la ne nf mt le ng nh mv li ni nj mx iz bi translated">5.2.1功能与价格的相关性</h2><p id="59d8" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">为了剔除67列中不相关的特性，我们计算与价格水平的相关性。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div class="gh gi ql"><img src="../Images/4866dfecc151545f127de48bc6b39504.png" data-original-src="https://miro.medium.com/v2/resize:fit:558/format:webp/1*FvxQWNaDaWmD1V13xAEd7Q.png"/></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="87b3" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">让我们通过将输出限制为与价格至少有25%相关性的那些来浓缩这66个特征。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div class="gh gi qm"><img src="../Images/74e56be29523e85043a55495575fc7b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:976/format:webp/1*AhC4ooKohwXNsubzHeVtDw.png"/></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="aa3e" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我们得到了一长串28个与电价有中度到高度相关性的特性。其中大部分由城市温度组成，它们彼此高度相关。显然，这些特征之间有相当多的冗余，相关矩阵通过显示温度单元的深红色矩形来强调这一点。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi qn"><img src="../Images/f3df80136305b056102f44a3c39d6d14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OBdrTkxPj7xRvGP96HxfKA.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="aa27" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我们可以在两种方法中选择。</p><p id="5e94" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">第一个是28个与价格至少适度相关的原始特征。另一种方法是主成分分析，将66个特征减少到仅仅是它们的线性组合。</p><p id="c2de" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">两种方法我都试过了。</p><h2 id="ade1" class="mz mi it bd mj na nb dn mn nc nd dp mr la ne nf mt le ng nh mv li ni nj mx iz bi translated">主要成分</h2><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="f927" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">主成分分析表明，将需要多达30个成分来达到高于90%的累积方差比。因此，PCA并没有像我们希望的那样压缩特征列。</p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi qo"><img src="../Images/76a1d215737eb61d3fa34d3b10bc54ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bZeEXZXQXB3DAPiRoMzEQw.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="636a" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">让我们计算它们与价格水平的相关性，并将输出限制在那些与价格水平至少有10%相关性的成分上。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div class="gh gi qp"><img src="../Images/d89b8daf75df8b35893f146861deabbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1190/format:webp/1*poRRl2sKv24pqBFmf_IoKQ.png"/></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="e911" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">只有7个组成部分与电价水平的相关性高于10%。他们的低计数应该更容易训练变压器。</p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi qq"><img src="../Images/0c41f179ca548b0c9c9377f68e0f4750.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J-wbNrC9Ffl8LP1ZK3X8cg.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="175b" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">当变压器使用这些主成分来预测测试集时，它实现了良好的准确性:5.55%的MAPE。但是我决定采用第一种方法:28个相关的特性列，这产生了4.54%的更好的MAPE。</p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi qr"><img src="../Images/66aa7a75d17eee316b236bf3344d8abf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eehrW-rHqNxcorfk3RL-vw.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="b678" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">可能的话，我们可以通过包括一些具有弱相关性(低于10%)的成分来改进基于PCA的方法。但是为了便于解释，我更喜欢使用原始的特性，而不是它们在15或20个组件中不太透明的线性组合。</p><p id="470e" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">在GitHub上，你可以找到我的两种方法的Jupyter笔记本:使用PCA的笔记本和使用原始特性的笔记本。</p><p id="d9e1" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我们将数据帧的宽度缩小到目标变量及其28个最相关的特征列。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/e241411307a1976c716a1b80d0bd7e21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/1*iuRVxn4-t-ZKAvI7RphyRQ.png"/></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><h2 id="685e" class="mz mi it bd mj na nb dn mn nc nd dp mr la ne nf mt le ng nh mv li ni nj mx iz bi translated">5.2日期时间功能</h2><p id="730a" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">接下来，我们将进行一些特性工程，并从datetime索引中派生出额外的时间变量。</p><p id="edaf" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">当我们在单独的列中隔离小时、工作日和月时，转换器会发现更容易识别时间轴上的模式。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="c1d0" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">数据透视表热图展示了工作日之间的不同价格水平以及每月的季节性波动。我们观察到工作日和周末之间的差异，此时电力需求较低；夏末的几个月里，我们看到了最高的价格。</p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div class="gh gi pj"><img src="../Images/3ed4be8e1c975d16cc761500a3ca0055.png" data-original-src="https://miro.medium.com/v2/resize:fit:1192/format:webp/1*RXJ17K5b1Z9LW6QNfxEWhg.png"/></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="3e82" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">第二个数据透视表揭示了白天和夜间的价格变化。下午早些时候可能意味着传统的西班牙午睡，在此期间商业活动的强度会降低。电力需求在下午晚些时候恢复，然后在晚餐时间激增。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div class="gh gi qs"><img src="../Images/d563386c7f813a828fcc90934dae03d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:930/format:webp/1*dkEfWttShuUPHmbVq8SY_Q.png"/></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="4d55" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">这两个热图显示了预测模型必须了解的季节性的三个变量:小时、工作日和月。</p><h2 id="d29a" class="mz mi it bd mj na nb dn mn nc nd dp mr la ne nf mt le ng nh mv li ni nj mx iz bi translated">5.4时间序列对象</h2><h2 id="1432" class="mz mi it bd mj na nb dn mn nc nd dp mr la ne nf mt le ng nh mv li ni nj mx iz bi translated">5.4.1目标时间序列:价格</h2><p id="70ea" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">Darts与<em class="np">时间序列对象</em>一起工作，而不是numpy数组或pandas序列。</p><p id="95a0" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">第8行将dataframe的price列转换为单变量目标时间序列:<em class="np"> ts_P </em>。</p><p id="19ba" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">第10到17行展示了我们可以从任何时间序列对象中获得的一些属性。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi qt"><img src="../Images/92bfbdc69366dd4f7bbbda802e55d6d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dsU6QgQ-Pn38Wz18k9U9BQ.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><h2 id="c69e" class="mz mi it bd mj na nb dn mn nc nd dp mr la ne nf mt le ng nh mv li ni nj mx iz bi translated">特征协变量</h2><p id="55cf" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">接下来，我们将数据帧的特征列转换为时间序列。这些特征被称为目标时间序列的<em class="np">协变量</em>。在回归分析中，我们称它们为自变量或回归变量。变量<em class="np"> ts_covF </em>(“时序:协变特征”)形成一个多元时序对象。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi qu"><img src="../Images/1293f622382e768e5548ff255f6b65b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SK1qcP7ovynsEtpTwmz9YA.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="7998" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">必要时，可以使用以下Darts函数将Darts的时间序列对象转换回numpy数组、pandas系列或dataframes。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi qv"><img src="../Images/9755ca0650949dabb699b800ce8b26bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YvpN_g4QG121QspP0d0-lQ.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div class="gh gi qw"><img src="../Images/c564ad65c264b3ad13d76d0cb93df324.png" data-original-src="https://miro.medium.com/v2/resize:fit:1308/format:webp/1*UVfz6uK7mWp-aC-F2Rhr2Q.png"/></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><h2 id="accc" class="mz mi it bd mj na nb dn mn nc nd dp mr la ne nf mt le ng nh mv li ni nj mx iz bi translated">5.4.3训练集和测试集的准备</h2><p id="8cab" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">我们应用Darts的<em class="np"> split_after() </em>函数来分离训练集和测试集。在Jupyter笔记本的顶部单元格中，我们将常量<em class="np"> SPLIT </em>设置为我们希望为培训保留的百分比。测试集将覆盖2018年11月下旬至12月底之间的875小时或36.5天。</p><p id="bcf9" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我们从电价的目标时间序列ts_P开始。</p><p id="1db8" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">如果神经网络在具有不同量值的张量上训练，它们可能会被引入歧途。因此，我们在第11到12行实例化Darts的Scaler类并使其适合训练时间序列。然后，第13行到第15行对所有三个时间序列应用相同的训练定标器:训练、测试和完整数据集。</p><p id="be26" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">这三个转换后的时间序列被标记为ts_ttrain、ts_ttest和ts_t(“时间序列:转换后的训练集”、“时间序列:转换后的测试集”、“时间序列:转换后的完整序列”)</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div class="gh gi qx"><img src="../Images/9faaa9894a6f9359ae3adcbe1d831733.png" data-original-src="https://miro.medium.com/v2/resize:fit:1356/format:webp/1*UcTn-jKG86FJ0FuxyA6TSw.png"/></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="b1a1" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">接下来，我们在训练集和测试集之间划分特征系列。</p><p id="681e" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我们将一个定标器安装到训练序列中，然后在第4到8行将其应用到训练和测试特性序列中。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi qy"><img src="../Images/d939063ffee8307b9ab60443dd90a4d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y0WTei8wZZVivGNqXXqXYw.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><h2 id="43d9" class="mz mi it bd mj na nb dn mn nc nd dp mr la ne nf mt le ng nh mv li ni nj mx iz bi translated">5.4.4日期时间协变量</h2><p id="23f1" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">现在我们将借助Darts的效用函数导出一些日期时间协变量。考虑到隐藏在源数据中的复杂的季节性成分，它们将使转换器更容易了解时间模式。</p><ul class=""><li id="9f26" class="om on it kt b ku kv kx ky la oo le op li oq lm or os ot ou bi translated">第2行到第4行从时间戳获得小时。请注意，第4行中的<em class="np">“until”</em>参数将范围扩展到2019年1月4日，超过2018年12月31日测试集的结束时间。我们将使用额外的时间戳来准备样本外预测。我们也可以在稍后的阶段创建它们，在训练和测试之后，但是一次性准备所有的日期时间协变量可以节省时间。</li><li id="474e" class="om on it kt b ku ov kx ow la ox le oy li oz lm or os ot ou bi translated">第5行将工作日堆叠到小时。</li><li id="42f5" class="om on it kt b ku ov kx ow la ox le oy li oz lm or os ot ou bi translated">第6行添加月份。</li></ul><p id="0b47" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">这三个组成部分将反映我们在源数据中发现的三个季节性。</p><p id="6926" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">在第9行，一个有用的函数添加了第四个协变量:<em class="np"> add_holidays() </em>接受一个<em class="np"> country_code </em>参数并标记西班牙的公共假日。</p><p id="6989" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">第14行将训练集和测试集之间的协变量分开。</p><p id="858f" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我们还需要缩放这些日期时间协变量，在第18到22行。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi qz"><img src="../Images/9971cdff946c5067c9c28445157aa524.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LH-n6CdZ7C1rNVVQKREJLA.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi ra"><img src="../Images/1ae93529a58b36e1f12f0ee5d1f87c74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9KVVYEatHnUvFNbUTgmoQw.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><h1 id="0bf4" class="mh mi it bd mj mk ml mm mn mo mp mq mr ki ms kj mt kl mu km mv ko mw kp mx my bi translated">6.变压器设置和培训</h1><p id="15f6" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">TransformerModel接受我们在顶部的笔记本单元格中定义的超参数。</p><p id="1bca" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">为了计算一个概率预测，为我们提供预测中心值曲线周围的一组分位数，我们使用参数<em class="np">likelihood = quantier regression</em>运行模型。如果不定义可能性模型，预测将是确定性的:它将返回点估计，而不是将中心点包含在不确定性带之间。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="bcbc" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">在配置模型之后，我们使它适合训练集。</p><p id="22c5" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">或者，如果我们将常量LOAD设置为True，那么我们的脚本会将保存的模型加载到内存中(第2到4行)。保存的模型会保留其训练状态。加载后，我们不需要重新运行耗时的拟合过程，除非我们选择这样做。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><h1 id="3476" class="mh mi it bd mj mk ml mm mn mo mp mq mr ki ms kj mt kl mu km mv ko mw kp mx my bi translated">7.测试:预测测试集</h1><p id="a919" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">当训练完成时，或者先前训练的模型被提取到内存中时，我们可以为测试集生成876小时的预测。</p><p id="de03" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated"><em class="np"> predict() </em>函数将预测范围<em class="np"> n </em>作为其参数:时间步长的数量——这里是我们初始样本内预测的测试集的长度。</p><p id="2b62" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated"><em class="np"> num_samples </em>参数设置预测分位数的百分比。我们在脚本的顶部将其设置为100。请注意，根据我的实验，更多的样本不会显著增加处理时间。分位数损失函数没有太多的计算成本。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="4e81" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">在列表<em class="np">分位数</em>中，我们定义了我们想要获得预测范围的百分比:中心值(中位数)，以及10%/90%、1%/99%和20%/80%对，以及可选的其他分位数。每个分位数代表一个单变量时间序列。</p><p id="3175" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">第28行的list comprehension遍历列表分位数中的百分比，并对每个百分比调用辅助函数<em class="np"> predQ() </em>。然后predQ收集预测分位数，作为新数据帧dfY中的列。</p><p id="669f" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">50%的分位数或中位数值得特别关注。这个中心值代表我们将从确定性预测模型中获得的点估计。我们将其赋给一个单独的时间序列变量ts_q50。</p><p id="a78f" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">性能指标q50_RMSE和q50_MAPE将把这个中间预测ts_q50与测试集的实际价格进行比较。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi rb"><img src="../Images/fba7337d9399c6991901279d6b23cc69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_SaVqR3dkqhqFqPM-20UfQ.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="a2bc" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">上面的截图显示了<em class="np">确定性</em>模型的结果:Transformer模型是在没有要求QuantileRegression的情况下配置的。这就是为什么这些行显示常量值的原因。所有这些都只是反映了平均预测值，而不是分位数。这一点的MAPE估计是令人满意的5.35%。</p><p id="988d" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">下面的截图显示了<em class="np">概率</em>模型:在变压器的设置中，似然性参数被设置为QuantileRegression。现在，每一个时间步长的分位数都因列而异。预测中值的MAPE为4.57。</p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi rc"><img src="../Images/cf1a285c1692edaf6facf041a633dae0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kuacwCSOQJLPdjjmkQrsEA.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="6cb5" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">下一个笔记本单元格绘制预测。它将预测价格中值与测试集的实际价格进行比较。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi rd"><img src="../Images/f1af1ad236637b47243f9a9688e67125.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iRtJPbJCiYWcRj7rVLx5BA.png"/></div></div></figure><h1 id="fdb9" class="mh mi it bd mj mk ml mm mn mo mp mq mr ki ms kj mt kl mu km mv ko mw kp mx my bi translated">8.样本外预测</h1><p id="5bf1" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">最后，我们将为测试期结束后的12小时准备一个样本外预测。</p><p id="010b" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">这要求我们将未来的协变量值输入到<em class="np"> predict() </em>函数中。</p><p id="ae74" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">请记住，在定型模型之前，我们已经将日期时间协变量扩展到了2019–01–04。因此，它们符合要求。</p><p id="138f" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">但是我们仍然需要得到特征协变量的预测，特别是天气变量。</p><p id="77c9" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">如果我们有未来12小时的天气预报，我们可以将这些外源数据加载到内存中，并扩展我们现有的时间序列，<em class="np"> covF </em>。</p><p id="3157" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">没有外部数据，我们将需要准备一个特征变量的预测。我们可以应用一种经典方法来为每个特征变量生成单变量预测:例如，SARIMA、指数平滑或Theta方法。我们还可以为每一个特性安装额外的变压器模型(没有协变量)。</p><p id="1485" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">但让我们在这个练习中保持简单:我们假设2019年1月1日的天气特征和电力需求将遵循与2018年12月31日相同的每小时模式。它们在12月31日的已知值将代表我们对1月1日的模拟天气和负载预测。</p><p id="dec5" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">在第2行中，我们建议模型预测测试集结束后12小时的价格。</p><p id="3bbb" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">该模型没有在测试集上训练，因此其预测范围包括测试集的长度加上额外的小时数(第4行)。</p><p id="d26f" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">9号线使用了<em class="np"> tail() </em>功能的飞镖。tail函数从现有时间序列中提取最后几个时间步长的值。在我们的例子中，它需要测试集的最后24小时。然后<em class="np"> concatenate() </em>函数将这24小时附加到测试集的末尾。这为我们提供了我们需要涵盖2019年1月1日的特征协变量。</p><p id="7d3a" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">第12行将时间和特征协变量组合在一个时间序列对象cov_t_fut中。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi re"><img src="../Images/6db48b8fa7840e2f77b11d1e51c08caf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eZls4xLKmpTaxfalZHVYxA.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="19f6" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated"><em class="np"> predict() </em>函数采用扩展协变量和预测范围n_FC并生成预测。它们涵盖了测试集和2019-01-01:888小时的上午时间。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi rf"><img src="../Images/c17385607b73501a8a083a54cba308c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g_RpsGm8TkUDo2kFtIkwqw.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><p id="a713" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我们重新初始化用于收集测试集预测结果的变量。现在，我们用新的扩展预测的预测分位数填充数据框架dfY。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div class="gh gi rg"><img src="../Images/535df02df4eede7093490531ab613ed5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1330/format:webp/1*0L77A1p70PVVSvzFbnA2mw.png"/></div></figure><p id="2bd3" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">该屏幕截图显示了测试集的第一行和最后一行，后面是12个样本外预测行。</p><p id="bc05" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我们通过绘制预测图来完成今天的练习。折线图显示了对实际价格的复杂季节性模式的合理拟合。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="ok ol l"/></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi rh"><img src="../Images/34c3eaba4d870fb58b64a9db874ca152.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fPYBFEBIOdZb0aVaeVE2EA.png"/></div></div><p class="lv lw gj gh gi lx ly bd b be z dk translated">作者图片</p></figure><h1 id="88a1" class="mh mi it bd mj mk ml mm mn mo mp mq mr ki ms kj mt kl mu km mv ko mw kp mx my bi translated">9.结论</h1><p id="7ecb" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">大多数经典的预测方法都没有扩展到多元时间序列。SARIMAX接受外部回归变量，但难以反映一个以上的季节性顺序。</p><p id="40eb" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">今天的教程演示了当协变量和复杂的季节性开始起作用时，神经网络预测器“变压器”如何发挥作用。</p><p id="840c" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">这两个Jupyter笔记本(使用相关功能或其主要组件)可在GitHub上下载:<a class="ae lz" href="https://github.com/h3ik0th/ES_energy_Transformer" rel="noopener ugc nofollow" target="_blank">h3ik 0th/ES _ energy _ Transformer:Transformer deep forecast(github.com)</a></p><p id="0d6c" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">数据集元数据:<a class="ae lz" href="https://www.kaggle.com/nicholasjhana/energy-consumption-generation-prices-and-weather/metadata" rel="noopener ugc nofollow" target="_blank">每小时能源需求生成和天气| Kaggle </a></p><div class="nr ns gp gr nt nu"><a href="https://medium.com/subscribe/@h3ik0.th" rel="noopener follow" target="_blank"><div class="nv ab fo"><div class="nw ab nx cl cj ny"><h2 class="bd jd gy z fp nz fr fs oa fu fw jc bi translated">每当Heiko Onnen发表文章时，都会收到一封电子邮件。</h2><div class="ob l"><h3 class="bd b gy z fp nz fr fs oa fu fw dk translated">每当Heiko Onnen发表文章时，都会收到一封电子邮件。通过注册，您将创建一个中型帐户，如果您还没有…</h3></div><div class="oc l"><p class="bd b dl z fp nz fr fs oa fu fw dk translated">medium.com</p></div></div><div class="od l"><div class="ri l of og oh od oi lt nu"/></div></div></a></div><div class="nr ns gp gr nt nu"><a href="https://medium.com/@h3ik0.th/temporal-fusion-transformer-unleashed-deep-forecasting-of-multivariate-time-series-in-python-674fa393821b" rel="noopener follow" target="_blank"><div class="nv ab fo"><div class="nw ab nx cl cj ny"><h2 class="bd jd gy z fp nz fr fs oa fu fw jc bi translated">释放时间融合变压器:Python中多元时间序列的深度预测</h2><div class="ob l"><h3 class="bd b gy z fp nz fr fs oa fu fw dk translated">端到端示例:具有外生变量和复杂季节性的时间序列的概率预测</h3></div><div class="oc l"><p class="bd b dl z fp nz fr fs oa fu fw dk translated">medium.com</p></div></div><div class="od l"><div class="rj l of og oh od oi lt nu"/></div></div></a></div><div class="nr ns gp gr nt nu"><a rel="noopener follow" target="_blank" href="/n-beats-unleashed-deep-forecasting-using-neural-basis-expansion-analysis-in-python-343dd6307010"><div class="nv ab fo"><div class="nw ab nx cl cj ny"><h2 class="bd jd gy z fp nz fr fs oa fu fw jc bi translated">N-BEATS Unleashed:使用Python中的神经基础扩展分析进行深度预测</h2><div class="ob l"><h3 class="bd b gy z fp nz fr fs oa fu fw dk translated">端到端示例:具有复杂季节性的多变量时间序列的神经预测</h3></div><div class="oc l"><p class="bd b dl z fp nz fr fs oa fu fw dk translated">towardsdatascience.com</p></div></div><div class="od l"><div class="rk l of og oh od oi lt nu"/></div></div></a></div></div></div>    
</body>
</html>