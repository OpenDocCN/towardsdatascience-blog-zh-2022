<html>
<head>
<title>The Kaggle Way to Tune Hyperparameters with Optuna</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Optuna调整超参数的Kaggle方法</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/the-kaggle-way-to-tune-hyperparameters-with-optuna-285e59a0b95a#2022-01-06">https://towardsdatascience.com/the-kaggle-way-to-tune-hyperparameters-with-optuna-285e59a0b95a#2022-01-06</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""><h1 id="3f51" class="pw-post-title is it iu bd iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq bi translated">用Optuna调整超参数的Kaggle方法</h1></div><div class=""><h2 id="bb72" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">使用Optuna和一个小型项目轻松高效地优化模型的超参数</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/57c8978b482516778d60389a17bab0d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*AI-YmX3qqycS1Weo"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">约书亚·索蒂诺在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="2c71" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">一周前，我发表了我最受欢迎的一篇文章，其中包含了一个你绝对应该知道的数据科学工具和库的<a class="ae kz" rel="noopener" target="_blank" href="/26-github-repositories-to-inspire-your-next-data-science-project-3023c24f4c3c">列表。今天，我将讨论列表中的一个很棒的工具。</a></p><p id="d94c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><a class="ae kz" href="https://github.com/optuna/optuna" rel="noopener ugc nofollow" target="_blank"> Optuna </a>是一个轻量级的通用工具，可以方便地为您的ML算法执行超参数优化。随着最新版本3.0的发布，我觉得这是一个很好的时机让您了解该库最突出的特性，并将其应用到一个真实的迷你项目中。</p><p id="4e45" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">但首先，让我们讨论一下房间里的大象。</p><h1 id="138c" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">为什么Optuna应用如此广泛？</h1><p id="31aa" class="pw-post-body-paragraph la lb iu lc b ld mo jv lf lg mp jy li lj mq ll lm ln mr lp lq lr ms lt lu lv in bi translated">以下是这个工具流行的一些最重要的原因。理所当然地，我会说:</p><ul class=""><li id="85b8" class="mt mu iu lc b ld le lg lh lj mv ln mw lr mx lv my mz na nb bi translated">这是一个独立于平台的库，也就是说——您可以在scikit-learn、Tensorflow/Keras、Pytorch、XGBoost等中使用它，几乎不做任何修改。</li><li id="9e0d" class="mt mu iu lc b ld nc lg nd lj ne ln nf lr ng lv my mz na nb bi translated">Optuna使您能够在超参数优化管道中使用简单的Python循环和条件语句。</li><li id="3860" class="mt mu iu lc b ld nc lg nd lj ne ln nf lr ng lv my mz na nb bi translated">它还允许您轻松地在代码中实现并发。</li><li id="e2f3" class="mt mu iu lc b ld nc lg nd lj ne ln nf lr ng lv my mz na nb bi translated">最后，内置的使用各种绘图功能检查优化历史的支持非常有用。</li></ul><h2 id="e6e1" class="nh lx iu bd ly ni nj dn mc nk nl dp mg lj nm nn mi ln no np mk lr nq nr mm ns bi translated"><strong class="ak">注:</strong></h2><p id="f44b" class="pw-post-body-paragraph la lb iu lc b ld mo jv lf lg mp jy li lj mq ll lm ln mr lp lq lr ms lt lu lv in bi translated">我说<strong class="lc iv">“优化历史”:</strong>是的！那是有趣的部分！没有<code class="fe nt nu nv nw b"><strong class="lc iv">GridSearch</strong></code>实现允许您在搜索超参数时保留您进行的所有试验的所有历史。Optuna有，这样的推论提供了一个很大的优势。</p><p id="9fcd" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在本教程中，我将在一个迷你项目中使用Optuna和XGBoost，以便让您了解所有的基础知识。</p><p id="6356" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们开始吧👇</p><h1 id="86f3" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">设置我们的项目</h1><p id="ffc4" class="pw-post-body-paragraph la lb iu lc b ld mo jv lf lg mp jy li lj mq ll lm ln mr lp lq lr ms lt lu lv in bi translated">第一步是创建一个虚拟环境并安装XGBoost:</p><pre class="kk kl km kn gu nx nw ny nz aw oa bi"><span id="84bb" class="nh lx iu nw b gz ob oc l od oe">pipenv shell</span><span id="5c76" class="nh lx iu nw b gz of oc l od oe">pipenv install xgboost<br/>pipenv install scikit-learn</span></pre><p id="5c2f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">然后导入我们将要使用的库，就像这样:</p><pre class="kk kl km kn gu nx nw ny nz aw oa bi"><span id="f955" class="nh lx iu nw b gz ob oc l od oe">import xgboost as xgb<br/>import numpy as np<br/>import pandas as pd<br/>import matplotlib.pyplot as plt</span></pre><p id="85c2" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们将利用一个预处理过的加州住房数据集来构建一个回归模型，这是我已经准备好的(链接到最后的代码+数据集)。我们将首先以正常方式训练一个模型并计算RMSE，然后使用Optuna尽可能优化我们的模型。</p><h1 id="bcc4" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">为simpleXGBoost模型定型</h1><p id="e9c9" class="pw-post-body-paragraph la lb iu lc b ld mo jv lf lg mp jy li lj mq ll lm ln mr lp lq lr ms lt lu lv in bi translated">预处理数据集可以简单地导入:</p><pre class="kk kl km kn gu nx nw ny nz aw oa bi"><span id="e81d" class="nh lx iu nw b gz ob oc l od oe">df = pd.read_csv('preprocessed_housing.csv')</span></pre><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj og"><img src="../Images/a9f6525b1808a73c0ac55ed5223e2dfe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FmcC5AXcDQ-QpF4gW_FfXg.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">由预处理数据集授权的图像</p></figure><p id="7c42" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">最后，我们将继续训练一个简单的XGBoost模型，并计算验证RMSE:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="oh oi l"/></div></figure><p id="9c4c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">输出是这样的:</p><pre class="kk kl km kn gu nx nw ny nz aw oa bi"><span id="2de1" class="nh lx iu nw b gz ob oc l od oe">RMSE: 53119.69904403545</span></pre><p id="fc19" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">做完这些，让我们继续进入这篇文章的主要部分！</p><h1 id="32de" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">制作光学目标函数</h1><p id="cb77" class="pw-post-body-paragraph la lb iu lc b ld mo jv lf lg mp jy li lj mq ll lm ln mr lp lq lr ms lt lu lv in bi translated">这个目标与你从机器学习理论中回忆起来的有点不同。</p><p id="f6ae" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">Optuna中的目标函数包含以下操作:</p><ul class=""><li id="9170" class="mt mu iu lc b ld le lg lh lj mv ln mw lr mx lv my mz na nb bi translated">它接受我们想要优化的不同超参数的<strong class="lc iv">字典</strong></li><li id="e3b6" class="mt mu iu lc b ld nc lg nd lj ne ln nf lr ng lv my mz na nb bi translated">模型在函数中被<strong class="lc iv">训练</strong></li><li id="6170" class="mt mu iu lc b ld nc lg nd lj ne ln nf lr ng lv my mz na nb bi translated"><strong class="lc iv">根据训练好的模型对测试/验证数据进行预测</strong></li><li id="0ade" class="mt mu iu lc b ld nc lg nd lj ne ln nf lr ng lv my mz na nb bi translated"><strong class="lc iv">精度</strong>或<strong class="lc iv">误差</strong>最终从功能<strong class="lc iv">返回</strong>。</li></ul><p id="edad" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在我们的例子中，我们希望<strong class="lc iv">最小化</strong>我们的RMSE分数，所以我们返回RMSE，然后我们将在“<strong class="lc iv">研究</strong>中使用它来最小化。</p><p id="742a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">让我们创建一个目标函数吧！</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="oh oi l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">我们的目标函数</p></figure><p id="4373" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">n_trials表示目标函数执行的每个试验，参数由<code class="fe nt nu nv nw b"><strong class="lc iv">suggest_int</strong></code>、<code class="fe nt nu nv nw b"><strong class="lc iv">suggest_float</strong></code>等给出。</p><p id="1b3a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们可以方便地指定开始、结束和步数，以及一个<code class="fe nt nu nv nw b"><strong class="lc iv">log</strong></code> <strong class="lc iv"> </strong>参数，该参数指示我们的值是否表示对数仓。学习率超参数使用<code class="fe nt nu nv nw b"><strong class="lc iv">log</strong></code>，可以看到。</p><p id="f96a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在，让我们创建一个<strong class="lc iv">病历报告</strong>。</p><h1 id="3c66" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">做一项研究，并把它整合在一起</h1><p id="fba0" class="pw-post-body-paragraph la lb iu lc b ld mo jv lf lg mp jy li lj mq ll lm ln mr lp lq lr ms lt lu lv in bi translated">Optuna中的<strong class="lc iv">研究</strong>是基于目标函数的整个优化过程。</p><p id="26d0" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">让我们创建一个并开始调整我们的超参数！</p><pre class="kk kl km kn gu nx nw ny nz aw oa bi"><span id="34e6" class="nh lx iu nw b gz ob oc l od oe"># make a study</span><span id="31a4" class="nh lx iu nw b gz of oc l od oe">study = optuna.create_study(direction="minimize")<br/>study.optimize(objective, n_trials=500)</span></pre><p id="3746" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们将“最小化”放在<code class="fe nt nu nv nw b"><strong class="lc iv">direction</strong></code>参数中，因为我们想要使用目标函数来最小化我们的RMSE误差。如果您正在执行分类任务，您可以使用<strong class="lc iv">最大化</strong>和您计算的准确度分数！</p><p id="f3c8" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">你会看到在Google Colab上500次试用不到两分钟！很了不起，不是吗？</p><p id="73be" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">让我们看看最好的分数和参数并打印出来:</p><pre class="kk kl km kn gu nx nw ny nz aw oa bi"><span id="7293" class="nh lx iu nw b gz ob oc l od oe">print(f"Optimized RMSE: {study.best_value:.4f}")</span><span id="84ae" class="nh lx iu nw b gz of oc l od oe">print("Best params:")<br/>for key, value in study.best_params.items():<br/>    print(f"\t{key}: {value}")</span></pre><p id="7c28" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">最后，让我们把它们放在一起:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="oh oi l"/></div></figure><pre class="kk kl km kn gu nx nw ny nz aw oa bi"><span id="5e5b" class="nh lx iu nw b gz ob oc l od oe">Output:</span><span id="44c6" class="nh lx iu nw b gz of oc l od oe">Optimized RMSE: 51774.6284<br/>Best params:  <br/>n_estimators: 1800  <br/>learning_rate: 0.2982950878173913  <br/>max_depth: 11</span></pre><p id="7193" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我会说这看起来是一个非常好的改进！</p><h2 id="2074" class="nh lx iu bd ly ni nj dn mc nk nl dp mg lj nm nn mi ln no np mk lr nq nr mm ns bi translated">奖励实验:</h2><p id="525a" class="pw-post-body-paragraph la lb iu lc b ld mo jv lf lg mp jy li lj mq ll lm ln mr lp lq lr ms lt lu lv in bi translated">最后，尝试用下面的代码片段看看优化历史是什么样子的:</p><pre class="kk kl km kn gu nx nw ny nz aw oa bi"><span id="dc8d" class="nh lx iu nw b gz ob oc l od oe">from optuna.visualization.matplotlib import plot_optimization_history</span><span id="bc87" class="nh lx iu nw b gz of oc l od oe">plot_optimization_history(study)</span></pre><p id="f32a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">您的输出应该类似于以下内容:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj oj"><img src="../Images/88e3180826f8a8574fdf6a04a25659f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7cFNcQPQirwkmtqROWjNEQ.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">按作者分类的图像—优化历史图</p></figure><p id="3818" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">就是这样！是时候为自己一路过关斩将而感到自豪了！</p><h1 id="62b2" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">几句临别赠言…</h1><p id="eb23" class="pw-post-body-paragraph la lb iu lc b ld mo jv lf lg mp jy li lj mq ll lm ln mr lp lq lr ms lt lu lv in bi translated">感谢您的阅读。</p><p id="e9ff" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我希望这个关于mini项目的快速教程有助于认识到使用Optuna与手动常规超参数优化相比所提供的绝对优势。在阅读完本教程后，我建议您尝试使用这个或另一个数据集构建新的管道。</p><p id="be76" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">快乐学习！:)</p><p id="f82a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">您可以在这里找到所有的<a class="ae kz" href="https://github.com/yashprakash13/data-another-day/blob/main/README.md#a-data-scientists-life-hacks" rel="noopener ugc nofollow" target="_blank">代码以及预处理过的数据集</a>。</p><p id="f20d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我希望在我的下一篇文章中再次见到你。在那之前，<a class="ae kz" href="https://ipom.medium.com/" rel="noopener">请跟随我，不要错过我的下一篇文章</a>。我确实每周都写！</p><h2 id="e91a" class="nh lx iu bd ly ni nj dn mc nk nl dp mg lj nm nn mi ln no np mk lr nq nr mm ns bi translated"><a class="ae kz" href="https://ipom.medium.com/membership/" rel="noopener">我还建议成为一名中等会员，不要错过我每周发表的任何数据科学文章。</a>在此加入👇</h2><div class="ok ol gq gs om on"><a href="https://ipom.medium.com/membership/" rel="noopener follow" target="_blank"><div class="oo ab fp"><div class="op ab oq cl cj or"><h2 class="bd iv gz z fq os fs ft ot fv fx it bi translated">通过我的推荐链接加入Medium</h2><div class="ou l"><h3 class="bd b gz z fq os fs ft ot fv fx dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="ov l"><p class="bd b dl z fq os fs ft ot fv fx dk translated">ipom.medium.com</p></div></div><div class="ow l"><div class="ox l oy oz pa ow pb kt on"/></div></div></a></div></div><div class="ab cl pc pd hy pe" role="separator"><span class="pf bw bk pg ph pi"/><span class="pf bw bk pg ph pi"/><span class="pf bw bk pg ph"/></div><div class="in io ip iq ir"><p id="4e49" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv">我的另外几篇文章你可能会感兴趣:</strong></p><div class="ok ol gq gs om on"><a rel="noopener follow" target="_blank" href="/the-nice-way-to-deploy-an-ml-model-using-docker-91995f072fe8"><div class="oo ab fp"><div class="op ab oq cl cj or"><h2 class="bd iv gz z fq os fs ft ot fv fx it bi translated">使用Docker部署ML模型的好方法</h2><div class="ou l"><h3 class="bd b gz z fq os fs ft ot fv fx dk translated">使用FastAPI部署ML模型并在VSCode中轻松封装它的快速指南。</h3></div><div class="ov l"><p class="bd b dl z fq os fs ft ot fv fx dk translated">towardsdatascience.com</p></div></div><div class="ow l"><div class="pj l oy oz pa ow pb kt on"/></div></div></a></div><div class="ok ol gq gs om on"><a rel="noopener follow" target="_blank" href="/31-datasets-for-your-next-data-science-project-6ef9a6f8cac6"><div class="oo ab fp"><div class="op ab oq cl cj or"><h2 class="bd iv gz z fq os fs ft ot fv fx it bi translated">您下一个数据科学项目的31个数据集</h2><div class="ou l"><h3 class="bd b gz z fq os fs ft ot fv fx dk translated">基于任务的数据集的汇编，可用于构建下一个数据科学项目</h3></div><div class="ov l"><p class="bd b dl z fq os fs ft ot fv fx dk translated">towardsdatascience.com</p></div></div><div class="ow l"><div class="pk l oy oz pa ow pb kt on"/></div></div></a></div></div></div>    
</body>
</html>