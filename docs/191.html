<html>
<head>
<title>Deploying A Pre-Trained Sklearn Model on Amazon SageMaker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Amazon SageMaker上部署预先训练的Sklearn模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploying-a-pre-trained-sklearn-model-on-amazon-sagemaker-826a2b5ac0b6#2022-01-07">https://towardsdatascience.com/deploying-a-pre-trained-sklearn-model-on-amazon-sagemaker-826a2b5ac0b6#2022-01-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""><h1 id="28af" class="pw-post-title ir is it bd iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp bi translated">在Amazon SageMaker上部署预先训练的Sklearn模型</h1></div><div class=""><h2 id="363f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">将本地培训的模型投入生产</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/95fb2fb430f7cf75a8af16ac13f00c92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zDSj-P-VV2JwDiNn"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自<a class="ae ky" href="https://unsplash.com/@mrpeker" rel="noopener ugc nofollow" target="_blank">穆罕默德·阿里·皮克</a>拍摄的<a class="ae ky" href="https://unsplash.com/photos/hfiym43qBpk" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><p id="c38f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我曾经写过如何在亚马逊SageMaker上训练和部署定制的<a class="ae ky" href="https://ram-vegiraju.medium.com/training-and-deploying-custom-scikit-learn-models-on-aws-sagemaker-3de6a2f669f4" rel="noopener"> Sklearn </a>和<a class="ae ky" rel="noopener" target="_blank" href="/training-and-deploying-custom-tensorflow-models-with-aws-sagemaker-72027722ad76"> TensorFlow </a>模型。但是，对于某些用例，您可能有在其他地方培训过的预培训模型。在本文中，我们将探索如何获取预先训练好的模型数据，并将其部署到SageMaker上。此外，对于这个例子，我们将主要在本地环境中处理代码，以确保您不会在AWS控制台中有太多繁重的工作。</p><p id="2c22" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">注意</strong>:对于那些刚接触AWS的人来说，如果你想跟进的话，请确保你在下面的<a class="ae ky" href="https://aws.amazon.com/console/" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">链接</strong> </a>做了一个账户。<strong class="lb iu">本文将假设一个新手对AWS和SageMaker的知识达到中级水平。</strong>我们也不会探究模型构建理论，本文的主要焦点将放在部署上。</p><h1 id="8e5e" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">目录</h1><ol class=""><li id="872b" class="mn mo it lb b lc mp lf mq li mr lm ms lq mt lu mu mv mw mx bi translated">设置</li><li id="443a" class="mn mo it lb b lc my lf mz li na lm nb lq nc lu mu mv mw mx bi translated">模型部署脚本</li><li id="9b23" class="mn mo it lb b lc my lf mz li na lm nb lq nc lu mu mv mw mx bi translated">模型调用</li><li id="bbee" class="mn mo it lb b lc my lf mz li na lm nb lq nc lu mu mv mw mx bi translated">其他资源和结论</li></ol><h1 id="0093" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">1.设置</h1><p id="6e48" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">首先，让我们快速地在本地训练一个可用于部署的Sklearn模型。您可以简单地运行以下Python脚本进行设置。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ng nh l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">本地模型训练</p></figure><p id="4fd5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个脚本的主要关键是我们使用<a class="ae ky" href="https://joblib.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> joblib </a>模块来保存训练好的模型。您应该看到这个工件显示在您的本地目录中。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/57e6561e51100b9cbd270d0c3153fa70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/format:webp/1*N1UYTbbQHEAn8eF2ojmAVg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">局部模型神器(作者截图)</p></figure><p id="9196" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有必要使用joblib来保存模型，因为这是SageMaker对Sklearn模型的预期格式。除了我们的本地模型脚本，我们可以提前提供的一个脚本是我们的推理脚本。这有助于SageMaker理解您的模型服务的输入和输出将如何配置。您可以提供四种默认功能<a class="ae ky" href="https://docs.aws.amazon.com/sagemaker/latest/dg/adapt-inference-container.html" rel="noopener ugc nofollow" target="_blank">和</a>:</p><ol class=""><li id="acda" class="mn mo it lb b lc ld lf lg li nj lm nk lq nl lu mu mv mw mx bi translated"><strong class="lb iu"> model_fn </strong>:这将反序列化并加载我们的joblib文件。</li><li id="3d50" class="mn mo it lb b lc my lf mz li na lm nb lq nc lu mu mv mw mx bi translated"><strong class="lb iu"> input_fn </strong>:您可以传入您的模型期望输入的数据格式(json、csv等)。</li><li id="cf11" class="mn mo it lb b lc my lf mz li na lm nb lq nc lu mu mv mw mx bi translated"><strong class="lb iu"> predict_fn </strong>:我们的模型预测功能。</li><li id="7164" class="mn mo it lb b lc my lf mz li na lm nb lq nc lu mu mv mw mx bi translated"><strong class="lb iu"> output_fn </strong>:处理predict_fn的返回值以及端点将得到的响应类型。</li></ol><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ng nh l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">推理处理函数</p></figure><p id="7468" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步是在AWS控制台中创建一个<strong class="lb iu">合适的SageMaker IAM角色</strong>。在这里，您需要为SageMaker提供适当的权限:S3完全访问、SageMaker完全访问和ECR完全访问。对于本例，这应该是您在AWS控制台中的主要工作。一旦您创建了这个角色，我们就可以专注于构建我们的模型部署脚本了。</p><h1 id="8a9c" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">2.模型部署脚本</h1><p id="f8bc" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">首先，我们的模型部署脚本有以下导入。确保这个脚本与您的推理处理程序和模型数据(joblib)在同一个目录中。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ng nh l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">进口</p></figure><p id="d559" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们与AWS服务的大部分协调工作都是通过SDK完成的，在这里是Python SDK: <a class="ae ky" href="https://aws.amazon.com/sdk-for-python/" rel="noopener ugc nofollow" target="_blank"> Boto3 </a>。我们与SageMaker的<a class="ae ky" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sagemaker.html" rel="noopener ugc nofollow" target="_blank"> Boto3客户端</a>合作，协调我们的模型部署步骤。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ng nh l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">SageMaker设置</p></figure><p id="5e63" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这里，我们实例化了SageMaker的客户端和S3客户端，我们将在那里存储我们的模型数据，以便SageMaker访问。下一步是关键部分，SageMaker需要一个<strong class="lb iu">model.tar.gz</strong>格式的模型工件/数据。为此，我们将把本地模型工件和inference.py脚本压缩到一个tar文件中。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ng nh l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">创造model.tar.gz</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/fcdab11ccd1b7508d87682bad9791e4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1264/format:webp/1*aA6iSTi5_ZINtoiLfbqOEw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">model.tar.gz本地保存(作者截图)</p></figure><p id="2f35" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，SageMaker要理解我们需要将这个模型工件放在S3的一个位置。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ng nh l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">将模型数据上传至S3</p></figure><p id="a3ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们可以关注在SageMaker上构建端点的三个步骤。</p><ol class=""><li id="dea8" class="mn mo it lb b lc ld lf lg li nj lm nk lq nl lu mu mv mw mx bi translated"><a class="ae ky" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sagemaker.html#SageMaker.Client.create_model" rel="noopener ugc nofollow" target="_blank">模型创建</a></li><li id="3bc7" class="mn mo it lb b lc my lf mz li na lm nb lq nc lu mu mv mw mx bi translated"><a class="ae ky" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sagemaker.html#SageMaker.Client.create_endpoint_config" rel="noopener ugc nofollow" target="_blank">端点配置创建</a></li><li id="160d" class="mn mo it lb b lc my lf mz li na lm nb lq nc lu mu mv mw mx bi translated"><a class="ae ky" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sagemaker.html#SageMaker.Client.create_endpoint" rel="noopener ugc nofollow" target="_blank">端点创建</a></li></ol><p id="f5f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于SageMaker模型创建，我们需要两个特性:模型数据和容器图像。在这种情况下，我们可以使用SageMaker SDK从SageMaker直接检索sk learn图像进行推理。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ng nh l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">检索Sklearn图像</p></figure><p id="2e68" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们可以提供模型数据和图像来创建我们的SageMaker模型。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ng nh l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">SageMaker模型创建</p></figure><p id="4c60" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们可以使用SageMaker模型来创建我们的端点配置，在这里我们可以指定我们的实例类型和我们想要的端点数量。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ng nh l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">SageMaker端点配置创建</p></figure><p id="8fd4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们可以开始创建我们的端点，这将需要几分钟的时间来成功创建。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ng nh l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">创建端点</p></figure><p id="50be" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您现在运行该脚本，您将看到一个端点成功创建，并且在您的AWS控制台中也是可见的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/7334a5616dbb3d137bf1173348e66417.png" data-original-src="https://miro.medium.com/v2/resize:fit:288/format:webp/1*FgkY-D2uh4E84m_hE4RIqQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">端点创建(作者截图)</p></figure><h1 id="4c69" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">3.模型调用</h1><p id="f3b1" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">我们现在可以创建一个单独的调用文件，用一个样本点来测试我们的端点。我们不想将它添加到主文件中，因为每次执行都会创建一个新的端点。获取您的端点名称，并在下面的脚本中指定它，您将看到执行。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ng nh l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">调用端点</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi no"><img src="../Images/457af8e324a275a5ba0e3368f66e972e.png" data-original-src="https://miro.medium.com/v2/resize:fit:88/format:webp/1*BIO1VpOufhNysi92wyaEpQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">结果(作者截图)</p></figure><h1 id="a396" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">4.其他资源和结论</h1><div class="np nq gp gr nr ns"><a href="https://github.com/RamVegiraju/Pre-Trained-Sklearn-SageMaker" rel="noopener  ugc nofollow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd iu gy z fp nx fr fs ny fu fw is bi translated">GitHub-RamVegiraju/Pre-Trained-Sklearn-sage maker:在亚马逊上部署一个预先训练好的sk learn模型…</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">github.com</p></div></div><div class="ob l"><div class="oc l od oe of ob og ks ns"/></div></div></a></div><p id="ab9b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有关示例的完整代码，请访问上面的链接。理解了模型数据的格式和结构之后，在SageMaker上部署预先训练好的模型就非常简单了。需要发生的主要变化是您使用SDK检索的图像，这应该与您正在使用的框架相匹配。如果SageMaker不支持容器，请查看如何<a class="ae ky" rel="noopener" target="_blank" href="/bring-your-own-container-with-amazon-sagemaker-37211d8412f4">自带容器</a>。</p><h2 id="3046" class="oh lw it bd lx oi oj dn mb ok ol dp mf li om on mh lm oo op mj lq oq or ml os bi translated">额外资源</h2><p id="18f2" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated"><a class="ae ky" href="https://github.com/RamVegiraju/SageMaker-Deployment" rel="noopener ugc nofollow" target="_blank">萨格马克推论的例子</a></p><p id="5543" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" rel="noopener" target="_blank" href="/deploy-multiple-tensorflow-models-to-one-endpoint-65bea81c3f2f">带SageMaker的多模型TensorFlow端点</a></p></div><div class="ab cl ot ou hx ov" role="separator"><span class="ow bw bk ox oy oz"/><span class="ow bw bk ox oy oz"/><span class="ow bw bk ox oy"/></div><div class="im in io ip iq"><p id="fdc8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="pa">如果你喜欢这篇文章，请在</em><a class="ae ky" href="https://www.linkedin.com/in/ram-vegiraju-81272b162/" rel="noopener ugc nofollow" target="_blank"><em class="pa">LinkedIn</em></a><em class="pa">上与我联系，并订阅我的媒体</em> <a class="ae ky" href="https://ram-vegiraju.medium.com/subscribe" rel="noopener"> <em class="pa">简讯</em> </a> <em class="pa">。如果你是新来的中号，用我的</em> <a class="ae ky" href="https://ram-vegiraju.medium.com/membership" rel="noopener"> <em class="pa">会员推荐</em> </a> <em class="pa">报名吧。</em></p></div></div>    
</body>
</html>