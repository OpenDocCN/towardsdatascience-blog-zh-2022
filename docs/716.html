<html>
<head>
<title>Identifying bot traffic with SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用SQL识别bot流量</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/identifying-bot-traffic-with-sql-3327c893bdb2#2022-01-25">https://towardsdatascience.com/identifying-bot-traffic-with-sql-3327c893bdb2#2022-01-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/68a38f7db1bade5c7a5906646cffa5ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PGUyyUB9zvUCDvqa5pu2SQ.jpeg"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">菲利普·格利克曼的照片</p></figure><div class=""><h1 id="d003" class="pw-post-title je jf jg bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">使用SQL识别bot流量</h1></div><p id="8003" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Web数据通常包括某种类型的bot流量。无论是自动化测试用户还是不需要的web抓取者，在使用数据进行报告或分析之前，您都需要将他们从数据中删除。</p><p id="5a7c" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个SQL查询是系统地识别非人类浏览行为的一种快速而简单的方法，因此您可以花更少的时间清理数据，而花更多的时间做有趣的事情。</p><h1 id="9e2d" class="lb lc jg bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">你需要什么数据</h1><p id="90c9" class="pw-post-body-paragraph kd ke jg kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">您将需要一个数据集来表示用户在一段时间内的每个页面视图(或类似的浏览行为，如点击)。这个查询是使用针对亚马逊红移仓库和来自T2段的基本页面视图数据的语法编写的，但是您可以很容易地将它应用于任何页面视图数据源和仓库组合。</p><h1 id="56e6" class="lb lc jg bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">SQL查询</h1><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="663a" class="mn lc jg mj b gy mo mp l mq mr">SELECT <br/> v.anonymous_id <br/>FROM (<br/> SELECT <br/>        p.message_id<br/>        , p.anonymous_id<br/>  , p.timestamp<br/>  , LAG(p.timestamp) over<br/>   (PARTITION BY p.anonymous_id ORDER BY p.timestamp ASC) <br/>   as last_pageview_ts<br/> FROM website.pages p  <br/> ) v</span><span id="b525" class="mn lc jg mj b gy ms mp l mq mr">WHERE date_diff('minute', v.last_pageview_ts, v.timestamp) &lt; 30 <br/>    and v.last_pageview_ts is not null</span><span id="7d45" class="mn lc jg mj b gy ms mp l mq mr">GROUP BY 1</span><span id="6b9d" class="mn lc jg mj b gy ms mp l mq mr">HAVING <br/> avg(date_diff('ms', v.last_pageview_ts, v.timestamp)) &lt;= 1000 <br/> and COUNT(1) &gt; 10</span></pre><h1 id="2776" class="lb lc jg bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">它是如何工作的</h1><p id="e408" class="pw-post-body-paragraph kd ke jg kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">在一个高层次上，这个查询使用页面视图数据来查找以非常快的速度查看了许多页面(&gt; 10个页面)的访问者(&lt; 1 second between views on average). Viewing that many pages so quickly is a strong indication that the viewer is not human and should be removed from the data before analysis.</p><p id="e8f9" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">We defined these thresholds using our common sense about what was and wasn’t <em class="mt">正常的</em>用户行为)。如果你想客观一点，我在最后提供了一些提示，告诉你如何使用你的数据来设定阈值。</p><h1 id="81cd" class="lb lc jg bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">我们来分解一下</h1><p id="056d" class="pw-post-body-paragraph kd ke jg kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated"><strong class="kf jh">步骤1 </strong> —计算每次页面浏览之间的时间</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="ef75" class="mn lc jg mj b gy mo mp l mq mr">LAG(p.timestamp) <br/> over (PARTITION BY p.anonymous_id <br/>     ORDER BY p.timestamp ASC)       as last_pageview_ts</span></pre><p id="c0f6" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf jh">步骤2 </strong> —排除来自不同会话的任何连续页面视图</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="763f" class="mn lc jg mj b gy mo mp l mq mr">WHERE date_diff('minute', v.last_pageview_ts, v.timestamp) &lt; 30</span></pre><p id="f23f" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最终，我们将需要计算每次页面浏览之间的平均时间，如果我们包括会话之间的时间，我们将严重扭曲我们的平均值。通过删除这些记录，我们可以确保我们只计算同一个会话中页面浏览之间的时间。</p><p id="115b" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf jh">步骤3 </strong> —计算每个用户每次页面查看之间的平均时间，并仅过滤查看之间的平均时间为&lt; 1秒(1000毫秒)的用户</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="cd63" class="mn lc jg mj b gy mo mp l mq mr">avg(date_diff('ms', v.last_pageview_ts, v.timestamp)) &lt;1000</span></pre><p id="73d9" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf jh">第4步</strong> —排除页面浏览量少于10次的人</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="a2be" class="mn lc jg mj b gy mo mp l mq mr">COUNT(1) &gt; 10</span></pre><p id="31ce" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该查询将返回一个查看了10个以上页面的用户列表，平均每个页面查看时间不到1秒。最好抽查这些用户及其页面查看行为，以确保所选的anonymous_id看起来像机器人。</p><p id="cbe3" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf jh">提示</strong>:调整平均浏览量和总浏览量的过滤器，使算法更具限制性。</p><p id="53bb" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦你调整了这些参数，你的机器人用户列表就准备好了！</p><p id="d33d" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就是这样！</p><p id="acd8" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后一步是从所有建模的表中删除它们。<a class="ae jd" rel="noopener ugc nofollow" target="_blank" href="/www.narrator.ai">讲述人</a>可以很容易地排除用户的动态列表，所以你不必担心他们偷偷进入你的数据集。<a class="ae jd" href="https://docs.narrator.ai/changelog/exclusion-list-for-activity-stream-users" rel="noopener ugc nofollow" target="_blank">了解更多</a></p></div><div class="ab cl mu mv hu mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ij ik il im in"><h1 id="55a0" class="lb lc jg bd ld le nb lg lh li nc lk ll lm nd lo lp lq ne ls lt lu nf lw lx ly bi translated">好处:使用数据选择好的阈值</h1><p id="8645" class="pw-post-body-paragraph kd ke jg kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">在这一节，我将分享一些使用现有行为数据选择一个好的阈值的技巧。这些方法是不受监督的，这意味着我们没有一个带标签的数据集来告诉我们哪个用户实际上是机器人，哪个不是，所以我们不会建立一些欺诈检测模型。这些只是简单的试探法，你可以用来选择一个更明智的阈值。</p><p id="32b9" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">目标是确定与你网站上的其他用户相比，什么应该被认为是<em class="mt">异常的</em>行为。行为会因您的站点而异，因此在选择阈值之前，我们将查看这些指标的分布，以确定哪些是正常的，哪些是不正常的。</p><h1 id="924c" class="lb lc jg bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">页面查看之间的时间阈值</h1><p id="9842" class="pw-post-body-paragraph kd ke jg kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">下面的SQL使用Redshift中的<a class="ae jd" href="https://docs.aws.amazon.com/redshift/latest/dg/r_WF_PERCENTILE_CONT.html" rel="noopener ugc nofollow" target="_blank"> PERCENTILE_CONT() </a>函数来计算每个页面查看之间的时间的各个百分点。这将给我们一个分布的感觉，而不必做更深入的分析。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="51cf" class="mn lc jg mj b gy mo mp l mq mr">with pvs as (<br/>    SELECT <br/>        p.message_id<br/>        , p.anonymous_id<br/>  , p.timestamp<br/>  , LAG(p.timestamp) over<br/>   (PARTITION BY p.anonymous_id ORDER BY p.timestamp ASC) <br/>   as last_pageview_ts<br/> FROM website.pages p  <br/>),</span><span id="f3a7" class="mn lc jg mj b gy ms mp l mq mr">time_between as (</span><span id="3746" class="mn lc jg mj b gy ms mp l mq mr">SELECT <br/>        v.anonymous_id<br/>        , date_diff('ms', v.last_pageview_ts, v.timestamp) ms_btwn_pvs</span><span id="659f" class="mn lc jg mj b gy ms mp l mq mr">FROM pvs v<br/>    WHERE date_diff('minute', v.last_pageview_ts, v.timestamp) &lt; 30 <br/>        and v.last_pageview_ts is not null</span><span id="4093" class="mn lc jg mj b gy ms mp l mq mr">)</span><span id="8774" class="mn lc jg mj b gy ms mp l mq mr">SELECT <br/>    PERCENTILE_CONT(0.990) within group (ORDER BY ms_btwn_pvs desc) over () as ptile_99<br/>    , PERCENTILE_CONT(0.950) within group (ORDER BY ms_btwn_pvs desc) over () as ptile_95<br/>    , PERCENTILE_CONT(0.90) within group (ORDER BY ms_btwn_pvs desc) over () as ptile_90<br/>    , PERCENTILE_CONT(0.750) within group (ORDER BY ms_btwn_pvs desc) over () as ptile_75<br/>    , PERCENTILE_CONT(0.500) within group (ORDER BY ms_btwn_pvs desc) over () as ptile_50<br/>    , PERCENTILE_CONT(0.250) within group (ORDER BY ms_btwn_pvs desc) over () as ptile_25<br/>FROM time_between<br/>LIMIT 1</span></pre><p id="9d2b" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf jh">查询输出(毫秒)</strong></p><figure class="me mf mg mh gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ng"><img src="../Images/7224ee1ffdab549843ac0328d889e8a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9f7IHBk8ETXZp6fB6rnd0Q.png"/></div></div></figure><p id="b9ff" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该查询将输出页面视图之间时间的各种百分比。例如，PTILE_75是页面查看之间时间的第75个百分位数，这意味着25% (100% — 75%)的页面查看发生在它之前的页面查看的4，618毫秒或更短时间内。作为参考，4,618 ms相当于4.618秒。这符合我们对网站典型页面浏览行为的预期。</p><p id="24b9" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您还可以可视化分布(如曲线图)以获得更好的感觉，但是SQL输出应该足以确定一个好的阈值。</p><figure class="me mf mg mh gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nh"><img src="../Images/ca80032e89eb0cd4abc5de47461befa3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*P4kzIPHxhjSWRs-S.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">作者图片</p></figure><p id="de9b" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf jh">选择阈值</strong></p><p id="679b" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦您对分布有了更好的理解，您就可以为页面浏览之间的时间选择一个明智的阈值。对于非常保守的阈值，选择PTILE_99(第99个百分位数表示两次页面查看之间的最短时间)或第95或90个百分位数表示更宽松的阈值。为了简单起见，我选择1000毫秒作为我的阈值，因为根据我的数据，这是一个介于99%和95%之间的很好的数字。</p><p id="a773" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要更新查询，只需将bot查询中带有<strong class="kf jh"> 1，000 </strong>的行更改为您的新阈值:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="f8b5" class="mn lc jg mj b gy mo mp l mq mr">avg(date_diff('ms', v.last_pageview_ts, v.timestamp)) &lt; 1000</span></pre><h1 id="bfa1" class="lb lc jg bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">总页面浏览量阈值</h1><p id="71a5" class="pw-post-body-paragraph kd ke jg kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们将使用相同的方法来选择总页面浏览量的阈值。首先，使用下面的SQL，我们将计算每个用户的总页面浏览量，并计算百分位数以更好地了解分布情况。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="28e4" class="mn lc jg mj b gy mo mp l mq mr">with pvs as (<br/>    SELECT <br/>        p.message_id<br/>        , p.anonymous_id<br/>  , p.timestamp<br/>  , LAG(p.timestamp) over<br/>   (PARTITION BY p.anonymous_id ORDER BY p.timestamp ASC) <br/>   as last_pageview_ts<br/> FROM website.pages p  <br/>),</span><span id="d6e5" class="mn lc jg mj b gy ms mp l mq mr">total_views as (</span><span id="6159" class="mn lc jg mj b gy ms mp l mq mr">SELECT <br/>        v.anonymous_id<br/>        , count(1) total_pvs</span><span id="c76c" class="mn lc jg mj b gy ms mp l mq mr">FROM pvs v<br/>    WHERE date_diff('minute', v.last_pageview_ts, v.timestamp) &lt; 30 <br/>        and v.last_pageview_ts is not null <br/>    GROUP BY 1</span><span id="2dd6" class="mn lc jg mj b gy ms mp l mq mr">)</span><span id="6b74" class="mn lc jg mj b gy ms mp l mq mr">select <br/>    PERCENTILE_CONT(0.990) within group (ORDER BY total_pvs ASC) over () as ptile_99<br/>    , PERCENTILE_CONT(0.950) within group (ORDER BY total_pvs ASC) over () as ptile_95<br/>    , PERCENTILE_CONT(0.90) within group (ORDER BY total_pvs ASC) over () as ptile_90<br/>    , PERCENTILE_CONT(0.750) within group (ORDER BY total_pvs ASC) over () as ptile_75<br/>    , PERCENTILE_CONT(0.500) within group (ORDER BY total_pvs ASC) over () as ptile_50<br/>    , PERCENTILE_CONT(0.250) within group (ORDER BY total_pvs ASC) over () as ptile_25<br/>from total_views<br/>limit 1</span></pre><p id="7592" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf jh">查询输出</strong></p><figure class="me mf mg mh gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ni"><img src="../Images/c5020fc6d83f5698d59997f3dbee89ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z3gbolSE4eXzWx0KBB0lBg.png"/></div></div></figure><p id="be08" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf jh">选择阈值</strong></p><p id="4812" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就像以前一样，我们有百分位数来更好地了解总页面浏览量的分布。我们将为bot查询选择一个合适的阈值。我选择这个阈值稍微宽松一点(10)，因为我预计大多数机器人是通过页面浏览之间的时间而不是他们在网站上浏览的总页面来检测的。</p><p id="5e4f" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦您确定了想要使用的阈值，只需将bot查询中的这一行替换为您的阈值<strong class="kf jh"> 10 </strong>。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="83c7" class="mn lc jg mj b gy mo mp l mq mr">and COUNT(1) &gt; 10</span></pre><p id="8e5e" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">仅此而已。您已经分析了站点上用户的典型行为，并可以相应地调整阈值。</p><h1 id="2274" class="lb lc jg bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">让我们找到那些机器人！！</h1><figure class="me mf mg mh gt is gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/64a0f099d84dd87e74512e18631ebb8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/0*6Jf2kRVgS6oQVYZQ.gif"/></div><p class="iz ja gj gh gi jb jc bd b be z dk translated"><a class="ae jd" href="https://media.giphy.com/media/tczJoRU7XwBS8/giphy.gif" rel="noopener ugc nofollow" target="_blank">来源</a></p></figure></div></div>    
</body>
</html>