<html>
<head>
<title>Find the top and slowest queries in your database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">查找数据库中排名靠前且最慢的查询</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/find-the-top-n-most-expensive-queries-48e46d8e9752#2022-01-31">https://towardsdatascience.com/find-the-top-n-most-expensive-queries-48e46d8e9752#2022-01-31</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""><h1 id="6f9b" class="pw-post-title ir is it bd iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp bi translated">查找数据库中排名靠前且最慢的查询</h1></div><div class=""><h2 id="b388" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">找到降低数据库处理速度的瓶颈查询</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f6ba165f7b06c48231afc4caeea58926.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5CYzhXWUPkkkQIDb"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在这篇文章中，我们将寻找慢速查询(图片由<a class="ae ky" href="https://unsplash.com/@nicoli" rel="noopener ugc nofollow" target="_blank"> Nicolai Dürbaum </a>在<a class="ae ky" href="https://unsplash.com/photos/PXGvsl0jQcE" rel="noopener ugc nofollow" target="_blank"> unsplash </a>上提供)</p></figure><p id="8ce4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您的数据库增长时，很容易失去对它正在执行的所有进程的跟踪。跟踪阻碍操作的缓慢查询不是很好吗？</p><p id="828b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们将创建一个查询，为您提供<strong class="lb iu">分析和优化数据库</strong>所需的所有工具:它选择有问题的查询，提供这些查询的相关信息，并为您提供查找和改进它们的方法。阅读本文后，您将能够揭示前n个查询以及每个查询的信息:</p><ul class=""><li id="eb66" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">在哪个数据库和对象中查找查询(例如在<code class="fe me mf mg mh b">Coffee</code>数据库中的<code class="fe me mf mg mh b">FreshPot</code>存储过程中)</li><li id="bd36" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">实际的查询本身</li><li id="36ac" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">查询计划</li><li id="d11c" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">创建和最后执行的时间</li><li id="d046" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">执行次数</li><li id="b5cc" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">返回的行数的总数、最小值、最大值和平均值、运行时间和CPU时间</li></ul><p id="6054" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意，本文分析了SQL Server数据库，但是类似的功能也存在于Postgres数据库中。查看本文中关于Postgres数据库中所有查询的统计数据。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="743f" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">搜寻慢速查询</h1><p id="ce95" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">我们将编写一个查询，提供哪些查询速度慢的信息，并为我们提供分析查询的工具。那我们可以</p><ol class=""><li id="4664" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu nr mb mc md bi translated"><strong class="lb iu">检测</strong>:哪些查询有问题？</li><li id="44d9" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu nr mb mc md bi translated"><strong class="lb iu">丰富</strong>:增加更多信息，让我们了解缓慢的原因</li><li id="83c3" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu nr mb mc md bi translated"><strong class="lb iu">分析</strong>:在哪里可以找到查询，问题出在哪里？</li><li id="31ae" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu nr mb mc md bi translated">优化:我们如何进一步改进我们的查询和数据库？</li></ol><p id="d4aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完整查询可在本文底部<a class="ae ky" href="https://gist.github.com/mike-huls/546e9801a64ac1e004f2c83382131382" rel="noopener ugc nofollow" target="_blank">或<strong class="lb iu">这里</strong> </a>。注意，我们将要使用的一些视图需要<code class="fe me mf mg mh b">VIEW DATABASE STATE</code>的许可。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h2 id="16a0" class="ns mv it bd mw nt nu dn na nv nw dp ne li nx ny ng lm nz oa ni lq ob oc nk od bi translated">1.查找有问题的查询</h2><p id="1e06" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">在第一部分中，我们使用CTE来选择我们感兴趣的查询。我们想从<code class="fe me mf mg mh b">sys.dm_exec_query_stats</code>获取一些数据；这将跟踪SQL Server中缓存查询计划的性能统计信息。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="6823" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里的目标是选择我们感兴趣的记录。在本例中，我们选择的记录是<strong class="lb iu">新的</strong>(自上次执行后不到30天)和频繁使用的<strong class="lb iu"/>(在过去30天内超过100次)。我们不介意很少执行的慢速查询。接下来，我们按照平均CPU时间对查询进行排序，然后返回前10个最慢的查询。</p><p id="d4fc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当然，我们可以根据许多标准进行筛选:</p><ul class=""><li id="be24" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">执行时间变化很大的记录(例如，最小和最大CPU时间相差很大)</li><li id="4ec1" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">运行时间和CPU时间(CPU实际执行的时间)相差很大的记录；可能查询浪费了很多等待的时间)</li><li id="f9ee" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">按返回的avg_rows或总cpu时间排序。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/3abcf8899007ffac2520f5ad1920a27e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kkSc8LLqaC_CfZ2j"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">有些虫子伪装得很好(图片由<a class="ae ky" href="https://unsplash.com/@id23" rel="noopener ugc nofollow" target="_blank"> id23 </a>在<a class="ae ky" href="https://unsplash.com/photos/7m3Gw8dgbjg" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄)</p></figure></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h2 id="1146" class="ns mv it bd mw nt nu dn na nv nw dp ne li nx ny ng lm nz oa ni lq ob oc nk od bi translated">2.提供有关查询的更多信息</h2><p id="99c7" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">在上一部分中，我们选择了频繁执行且执行时间很长的查询；这些是我们的问题查询。这一部分的目标是尽可能多地收集关于这些查询的相关信息。让我们看一下代码</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="08b9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面的代码很长，但它只做了几件事:</p><ul class=""><li id="494d" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">使用第34行的视图<code class="fe me mf mg mh b">sys.dm_exec_sql_text</code>添加实际的SQL语句(并清除第21到31行的语句)</li><li id="5665" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">使用视图<code class="fe me mf mg mh b">sys.dm_exec_query_plan</code>添加查询计划(第35行)</li><li id="6950" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">使用视图<code class="fe me mf mg mh b">sys.dm_exec_plan_attributes</code>获取我们稍后需要的数据库id和对象id。在第37到41行<strong class="lb iu"> </strong>中，我们将dbid和objectid记录从行转换为列，这样我们可以更容易地在第36行交叉应用它们。</li></ul><p id="e1c7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是输出(带有匿名声明文本):</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/374bc96699f277cd8f1726e6d67d16b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*80MQuCVEReSPi4mVqrby-w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们的数据库分析语句的输出(不是所有的列都适合，但最重要的列在这里，图片由作者提供)</p></figure></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h2 id="c78d" class="ns mv it bd mw nt nu dn na nv nw dp ne li nx ny ng lm nz oa ni lq ob oc nk od bi translated">3.分析我们的问题查询</h2><p id="65fb" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">我们现在可以开始分析查询；以下是一些建议:</p><ol class=""><li id="7de5" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu nr mb mc md bi translated">检查cpu时间和运行时间之间的差异；可能查询等了很多？</li><li id="174b" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu nr mb mc md bi translated">检查最小和最大cpu和执行时间之间的差异；也许将某些作业安排在晚上服务器有更多可用内存的时候？</li><li id="7d70" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu nr mb mc md bi translated">分析语句文本(格式化vscode中的sql<code class="fe me mf mg mh b">cntrl</code> - <code class="fe me mf mg mh b">shift</code> - <code class="fe me mf mg mh b">p</code> → <code class="fe me mf mg mh b">format document with</code> → <code class="fe me mf mg mh b">sql</code></li><li id="8b2b" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu nr mb mc md bi translated">单击并签出query_plan</li></ol><p id="2161" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦您发现了问题或改进查询的机会，我们需要找到查询的位置。我们已经有了数据库名称；让我们找到查询所在的对象的名称(例如，在存储过程中)。我们可以通过在下面的查询中插入<code class="fe me mf mg mh b">db_name</code>和<code class="fe me mf mg mh b">objectid </code>来做到这一点:</p><pre class="kj kk kl km gt oh mh oi oj aw ok bi"><span id="f307" class="ns mv it mh b gy ol om l on oo">SELECT * FROM CoffeeDB.sys.objects WHERE object_id = 808389949</span></pre><p id="2482" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将告诉您我们正在寻找的对象的类型和名称。例如:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/f1f7b4ef36a9b53ac7b5a280128f0e33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y2qZIT-d6LKazEosYNSAlA.png"/></div></div></figure><p id="148f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们可以在CoffeeDB中搜索一个名为‘My _ Stored _ Procedure’的存储过程，并加快查询速度！</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h2 id="0ba4" class="ns mv it bd mw nt nu dn na nv nw dp ne li nx ny ng lm nz oa ni lq ob oc nk od bi translated">4.进一步优化</h2><p id="ea3a" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">查看一下<a class="ae ky" href="https://mikehuls.com/articles?tags=sql" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">这些文章</strong> </a>来改善你的查询，尤其是<a class="ae ky" href="https://mikehuls.medium.com/sql-understand-how-indices-work-under-the-hood-to-speed-up-your-queries-a7f07eef4080" rel="noopener"> <strong class="lb iu">这一条</strong> </a>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/2c952e02856fa568605b0356bda37b0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6_0rFbLG3QDeTYU1"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">随着所有拥塞的消失，我们的数据库进程再次自由流动(图片由<a class="ae ky" href="https://unsplash.com/@alschim" rel="noopener ugc nofollow" target="_blank"> Alexander Schimmeck </a>在<a class="ae ky" href="https://unsplash.com/photos/W3MXYIfyxno" rel="noopener ugc nofollow" target="_blank"> unsplash </a>上提供)</p></figure><h1 id="a24c" class="mu mv it bd mw mx oq mz na nb or nd ne jz os ka ng kc ot kd ni kf ou kg nk nl bi translated">结论</h1><p id="28f6" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">通过这篇文章，您将完全有能力优化您的数据库！我们已经了解了代码的工作原理以及如何使用它，现在是时候将它应用到您的情况中了。查看<a class="ae ky" href="https://gist.github.com/mike-huls/546e9801a64ac1e004f2c83382131382" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">完整查询此处</strong> </a>。</p><p id="8f76" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你有建议/澄清，请评论，以便我可以改进这篇文章。同时，看看我的其他关于各种编程相关主题的文章，比如:</p><ul class=""><li id="8a90" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-understand-how-indices-work-under-the-hood-to-speed-up-your-queries-a7f07eef4080" rel="noopener">了解索引如何加快查询速度</a></li><li id="6af0" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated"><a class="ae ky" href="https://mikehuls.medium.com/how-to-track-statistics-on-all-queries-in-your-postgres-database-to-prevent-slow-queries-or-730d3f94076c" rel="noopener">跟踪Postgres中所有查询的统计数据以防止瓶颈</a></li><li id="5008" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated"><a class="ae ky" href="https://mikehuls.medium.com/getting-started-with-postgres-in-docker-616127e2e46d" rel="noopener">Docker中的Postgres入门</a></li><li id="2dab" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-delete-into-another-table-b5b946a42299" rel="noopener">删除进入另一个表格</a></li><li id="0a52" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-update-into-another-table-bfc3dff79a66" rel="noopener">更新到另一个标签页</a> le</li><li id="d743" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-insert-delete-and-update-in-one-statement-sync-your-tables-with-merge-14814215d32c" rel="noopener">在一条语句中插入、删除和更新</a></li><li id="76c7" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-update-select-in-one-query-b067a7e60136" rel="noopener">更新选择一批记录</a></li><li id="ae66" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-inserting-only-unique-values-in-a-unique-table-af2eb3b9890a" rel="noopener">插入唯一表格</a></li></ul><p id="0117" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编码快乐！</p><p id="be82" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">—迈克</p><p id="3f7a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">页（page的缩写）学生:比如我正在做的事情？跟我来！</p><div class="ov ow gp gr ox oy"><a href="https://mikehuls.medium.com/membership" rel="noopener follow" target="_blank"><div class="oz ab fo"><div class="pa ab pb cl cj pc"><h2 class="bd iu gy z fp pd fr fs pe fu fw is bi translated">通过我的推荐链接加入Medium—Mike Huls</h2><div class="pf l"><h3 class="bd b gy z fp pd fr fs pe fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="pg l"><p class="bd b dl z fp pd fr fs pe fu fw dk translated">mikehuls.medium.com</p></div></div><div class="ph l"><div class="pi l pj pk pl ph pm ks oy"/></div></div></a></div></div></div>    
</body>
</html>