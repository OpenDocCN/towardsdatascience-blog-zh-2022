# 用 Python 记住过去(模型状态)的五种方法

> 原文：<https://towardsdatascience.com/five-ways-to-remember-the-past-model-state-in-python-2c8430d29679>

## 从闭包函数和迭代器到状态机 Python 库

![](img/267ac44d5883cdb0ac5ae6d37198fa1e.png)

e55evu/AdobeStock

据说…

> “那些不记得过去的人注定要重复过去”。桑塔亚那，1905 年

就像在现实生活中一样，在软件中，知道如何保存“状态”是很重要的，这可能是一种可取的行为，也可能不是。S *tate* 是动力系统在某一时刻的行为。在软件中，系统的数学状态通过保留一组感兴趣的变量值来建模。更详细地说，软件中的*状态*通过*状态机*来建模，状态机的特征是*状态、转移、*以及通常从一个状态转移到另一个状态的*概率*。机器学习中有限状态机(简称状态机)的例子有*马尔可夫链*和*马尔可夫模型*【1】。状态机在各种应用中非常重要:

*   安全关键系统。例子包括医疗设备[2]、配电系统[3]和运输系统，如铁路[4]、飞机[5]和自动驾驶车辆[6]。
*   区块链数据传输、存储和检索系统。区块链也被称为无限状态机[7]。
*   视频游戏[8]，对话式人工智能[9]，图形用户界面实现[10]。
*   用 BLAST(基本局部比对搜索工具)寻找蛋白质序列的相似性[11]。
*   时间序列预测的深度状态空间模型[12]。

每个软件开发人员都知道，在不同的函数调用之间保持变量状态的最简单(也是最难看)的方法是将这个变量声明为一个*全局变量。但是，让我们忘记丑陋，描述用 Python 建模*状态*的五种不同方式，在一个虚构的、风景如画的地中海酒店管理客人的用例中。我们的酒店叫做*阿耳忒弥斯柏树*(其中*阿耳忒弥斯*是古希腊女神，c *ypress* 是她的神树)。*

在创建管理酒店客人的功能时，我们将研究以下在 Python 中管理*状态*的方法:

*   作为默认函数参数的空列表。
*   Python 闭包
*   迭代器
*   类别变量
*   状态机 Python 库。

## 1.作为默认函数参数的空列表

在我们进入第一个用例之前，让我们注意以下几点:一般来说，将空列表作为默认函数参数是一个糟糕的主意。我们将在下面的用例中解释原因。

在我们的第一个用例中，酒店的预订专员希望跟踪带宠物的客人预订的房间，以便分配额外的清洁人员。所以每次当一个房间被预订，客人有宠物时，她的软件调用下面的函数， *roomsWithPet()。*该函数接受一个位置参数( *roomNumber* )和一个命名参数， *lr，*，默认值为一个空列表。该函数被调用三次，只有 *roomNumber* 参数。 *lr* 会怎么样？第一次调用该函数时， *lr* 被创建并用 *roomNumber* 的值填充，随后每次，新的 r *oomNumber* 值被追加到第一次调用时创建的 *lr* 列表中。

因此，输出是:

在我们的例子中，这是理想的行为，但是在许多情况下，当您希望在每次函数调用时都创建一个新的列表时，却不是这样。因此，知道将空列表作为默认参数传递给函数是很重要的，*在函数调用之间保留列表的状态。*

## 2.Python 闭包

在我们的第二个用例中，四个在酒店参加会议的客人到达接待处办理退房手续。客人是同一家公司的员工，在酒店共用一个大套房。接待员需要计算每个人应得的余额。她可以调用下面的函数，输入参数是套房号(501)、住宿天数(3)、套房价格/晚(400 美元)以及每间套房的额外费用(酒店餐厅的餐费)。但是调用一个函数四次，每次只有最后一个参数不同，这有点麻烦。

Python 闭包为我们提供了一种更优雅的方式来做这件事。它们是内部函数，可以访问外部函数*中的值，即使在*外部函数已经完成执行之后【13】。换句话说，闭包函数有能力*记住一个封闭函数的*值，即使这些值已经不在内存中。一般来说，当我们不想写类时，Python 闭包提供了一种简洁的方式来实现数据隐藏，这是实现数据隐藏最常见的方式。

在下面的代码片段中，内部函数 *increaseByMeals()* 是一个闭包函数，因为它*会记住*外部函数 *balanceOwned()* 的值，即使在后者执行之后。因此，这允许我们编写下面的代码，其中 *balanceOwned()* 只用它的三个参数调用一次，然后在它执行后，我们用每个客人的餐费调用它四次。

优雅多了。现在的输出是:

## 3.迭代器

在我们的第三个用例中，酒店的客人可以为个人会议预订瑜伽教练或体能教练。在下面的代码中，D 是一个字典，其中键是房间号，值是“Y”或“PT”(“Y”表示请求的瑜伽教练，“PT”表示请求的体能教练)。

每天早上，都会创建一个新的字典，根据提出请求的时间输入房间号。然后，为了获得已经请求 Yoga 的房间，执行随后的 *filter()* 命令。现在中央服务器已经为瑜伽教练准备好了。每次瑜伽教练要求去下一个房间时，服务器只需调用 *next(ff)，*就会返回下一个房间来找瑜伽教练。以这种方式，瑜伽教练不需要彼此交流接下来去哪个房间。一个简单的迭代器保留房间服务的整体状态，而 *next()* 命令将我们带到下一个需要服务的房间。

输出是:

## 4.类变量和状态机 Python 库

在本节中，我们将讨论前面提到的在 Python 中保留状态的最后两种方法:

*   类变量。这些变量是在类构造中定义的，在构造类时声明，由类的所有实例共享。通过类实例。如果一个类的实例改变了一个类变量，那么该类的所有实例都会受到影响，这样，类变量在类实例之间保持它们的状态。
*   Python 状态机库。这是一个开源库[15],允许定义状态和状态间转换的动作。

我们将在最终用例中演示类变量和 Python 状态机库的使用，该用例模拟了我们酒店中桑拿室的使用。酒店在两个不同的位置有两个桑拿房，每个房间可容纳两人。

我们的类*Sauna*下面的*继承自*状态机*并具有*类变量* *inst_counter* ，它通过每次调用该类的构造函数来计算该类的实例数。我们为每个桑拿房定义了三种状态:*空* (0 个客人进入) *space_avail* (一个客人进入)*满*(两个客人进入)。然后我们给可能的转变命名。例如， *nospace* 意味着我们已经从状态 s *pace_avail* 过渡到状态 *full* 。*

*根据转换的定义，我们定义转换上的动作。例如，函数 *on_enter_space_avail()* 实现了当一个客人在先前空着的桑拿房内时的动作。除了打印有一个桑拿座椅可用，该功能还:*

*   *递增实例变量 *guestcount* 。员工想知道每个房间有多少客人使用过，以评估特定桑拿场所的受欢迎程度。*
*   *获取当前时间。然后将其添加到列表 *entryTimes* 中，这是一个实例变量。知道进入的时间是有用的，这样在繁忙的时候，工作人员可以安排额外的毛巾等。*
*   *记录正在使用房间的客人的房间号，将其附加到列表*房间号*中。这是出于计费目的(每周两次会议以上是免费的，额外会议将向客人收费)。在我们的例子中，房间号是随机生成的。另外，有趣的是, *roomnumbers* 列表是该类的私有成员，为了访问它，我们定义了属性 *getroomnumbers* 。*

*最后，我们定义*循环，*是状态的管道(序列):*被占用*，*无空间*，*两个空间*。*

*下面我们创建一个桑拿房的实例，通过调用 *cycle()* 来完成状态转换。*

*输出如下所示。在第一个*周期()*呼叫后，处于*占用*状态，因此打印*“一个桑拿座位可用*”。第二次呼叫后，它处于状态 *nospace，*并显示“*对不起，桑拿房已满*”。第三次呼叫后，它处于状态*间隔 42 个*，并打印“*欢迎来到桑拿房！*”。*

*现在，让我们获得一些附加信息:客人的进入时间、当前状态、到目前为止的客人数量和房间号。*

*下面是上面代码的输出。正如所料，我们目前处于*空*状态，到目前为止有两位客人使用了 *ArtemisSauna1* ，我们目前有一个*桑拿*类的实例。*

*Python 提供了许多保持状态的方法，换句话说，就是跟踪过程。这是很有价值的，特别是对于安全关键系统，软件同时跟踪许多物理过程的状态，并将状态变化映射到适当的动作。另一方面，正如许多 GUI(图形用户界面)开发人员所证实的，最令人讨厌的缺陷之一是 GUI 不响应用户动作，而是被锁定在特定状态。总之，无论我们的目标是否是保留状态，我们都需要了解 Python 的状态保留特性。*

*本文的代码可以在 Github 目录中找到:[链接到代码](https://github.com/theomitsa/Python-state-modeling/blob/main/Sauna.ipynb)*

*感谢您的阅读！*

## ***参考文献***

1.  *便当，c .，**现实生活中讲解的马尔可夫模型和马尔可夫链:概率性的锻炼套路，**中:走向数据科学**，** 2020 **，** [链接文章](/markov-models-and-markov-chains-explained-in-real-life-probabilistic-workout-routine-65e47b5c9a73#:~:text=Markov%20Model%20or%20Markov%20Chain,few%20hidden%20states%5B2%5D.)*
2.  *Bombarda，A .、S. Bonfanti 和 A. Gargantini，**开发从抽象状态机到嵌入式系统的医疗设备:智能药盒案例研究，**JM 布鲁尔市马扎拉。软件技术:方法和工具。工具 2019。计算机科学讲义()，第 11771 卷。Springer，[链接到文章](https://link.springer.com/chapter/10.1007/978-3-030-29852-4_7)*
3.  *赵，j .等，**用带变量的有限状态机对离散事件系统建模与控制及其在电网中的应用，**系统&控制信，第 61 卷，第 1 期，212–222 页，[链接文章](https://www.sciencedirect.com/science/article/abs/pii/S0167691111002659)。*
4.  *Thapaliya，a .、D. Jeong，d .和 G. Kwon，**使用故障状态机对安全关键系统进行故障分析**。载于:Park，j .，Loia，v .，Yi，g .，Sung，y .(编辑)《计算机科学与普适计算的进展》。可爱的 CSA 2017 2017。电气工程讲义，第 474 卷。2018 年新加坡施普林格。*
5.  *Spagnolo，c .，S. Sumsurooah 和 S. Bozkho，**面向更多电动飞机应用的先进智能电网配电系统**，国际电工综合与系统会议，2019 年第 1–6 页，[链接至文章](https://ieeexplore.ieee.org/document/8949998)。*
6.  *Bae，S. H .等人，**基于有限状态机的城市环境下自动驾驶车辆系统**，第 20 届控制、自动化与系统国际会议 *(ICCAS)* ，第 1181–1186 页，2020 年。*
7.  *Brooks，s .，**区块链:无限状态机**，中:走向数据科学，2017 年 4 月，[链接到文章](https://medium.com/@samuel.brooks/blockchain-the-infinite-state-machine-ffc39f32e182)*
8.  *Seemann 和 D. M. Bourg，**游戏开发者的人工智能，**奥赖利媒体，2004 年 7 月。*
9.  *Zamanirad，s .等人，**基于状态机的人-机器人对话模型和服务**，高级信息系统工程国际会议，2020 年 6 月，[链接到文章](https://link.springer.com/chapter/10.1007/978-3-030-49435-3_13)。*
10.  *Couriol，b .，**稳健工程:你可以信任的状态机用户界面，【2019 年 4 月，[https://www . infoq . com/articles/Robust-User-Interfaces-with-State-Machines/](https://www.infoq.com/articles/robust-user-interfaces-with-state-machines/)***
11.  *Arpith，j .等， **Mercury BLASTP:加速蛋白质序列比对，** ACM 反式可重构技术。系统。2008 年 6 月；1(2): 9、[链接到文章](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2615407/)*
12.  *Rangapuram，S. S .等，**时间序列预测的深态空间模型，** NeurIPS 会议，2018。*
13.  *Python 内部函数:它们有什么用处？、[链接到文章](https://realpython.com/inner-functions-what-are-they-good-for/#retaining-state-with-inner-functions-closures)*
14.  *Pathak，o .， **Python 闭包**，GeeksforGeeks，[链接到文章](https://www.geeksforgeeks.org/python-closures/)*
15.  ***StateMachine Python 库，**链接到库。*