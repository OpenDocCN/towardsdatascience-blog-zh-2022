# 面向数据科学的 Python 依赖管理

> 原文：<https://towardsdatascience.com/python-dependency-management-for-data-science-4f2d272db039>

## 关于 Python 依赖关系，每个数据科学家都应该知道什么

# 依赖管理到底是什么？

依赖管理是管理项目所依赖的所有外部部分的行为。它有污水系统的风险。当它起作用时，你甚至不知道它在那里，但当它失败时，它变得令人痛苦，几乎无法忽视。

每个项目都是建立在别人的汗水和泪水之上的。工程师醒来，煮咖啡，通过编写引导程序(从头启动计算机的程序)开始一个新项目的日子已经成为历史。我们下面有大量的软件和库。我们只是在上面撒上一层薄薄的糖。

![](img/f14be4627d5b5cc4d69eebd717562ce3.png)

作者图片

我的电脑和你的电脑有不同的软件。不仅堆栈不同，而且它们永远在变化。任何事情的运作方式都令人惊讶，但它确实如此。所有这些都要感谢依赖管理的污水系统和许多聪明的人抽象层，这样我们就可以调用我们最喜欢的熊猫函数并得到可预测的结果。

# Python 依赖管理的基础

先说清楚一件事。简单地安装和升级 Python 包不是依赖管理。依赖关系管理是为您的项目记录所需的环境，并使它对其他人复制它变得容易和确定。

你可以在一张纸上写下安装说明。您可以将它们写在源代码注释中。您甚至可以将安装命令直接硬编码到程序中。依赖管理？是的。推荐？没有。

推荐的方法是以一种标准化的、可复制的、被广泛接受的格式将依赖信息从代码中分离出来。这允许版本锁定和简单的确定性安装。有许多选项，但是在本文中我们将描述 pip 和 requirements.txt 文件的经典组合。

但是在我们开始之前，让我们先介绍一下 Python 依赖的原子单元:包。

# 什么是包？

包是 Python 中一个定义明确的术语。像库、框架、工具包这样的术语不是。在本文的剩余部分，我们将使用术语包，甚至是一些被称为库、框架或工具包的东西。

模块是在一个 Python 文件中定义的一切(类、函数等)。).

包是模块的集合。

Pandas 是包，Matplotlib 是包，print()-function 不是包。一个包的目的是成为一个易于分发的、可重用的、版本化的模块集合，它与其他包有明确的依赖关系。

您可能每天都在用 Python `import`语句在代码中引用包。

# 安装包的艺术

虽然您可以通过简单地将软件包手动下载到您的项目来安装它们，但是安装软件包最常见的方式是使用著名的`pip install`命令通过 PyPi (Python 包索引)。

注意:千万不要用`sudo pip install`。从来没有。这就像运行一个病毒。结果是不可预测的，会给你未来带来巨大的痛苦。

也不要全局安装 Python 包。始终使用虚拟环境。

# 什么是虚拟环境？

![](img/85102cc5bc6fb55f1bd9237bbd1c046d.png)

作者图片

Python 虚拟环境是一个安全的泡泡。您应该在本地计算机上的所有项目周围创建一个保护气泡。如果不这样做，项目就会互相伤害。不要让下水道系统漏水！

如果你在泡泡外面呼叫`pip install pandas`，它将被全球安装。这很糟糕。世界在前进，包装也在前进。一个项目需要 2019 年的 Matplotlib，另一个项目需要 2021 年的版本。单一的全球安装无法同时服务于两个项目。所以保护性气泡是必要的。让我们看看如何使用它们。

转到您的项目根目录并创建一个虚拟环境:

```
python3 -m venv mybubble
```

现在我们有一个泡沫，但我们还没有陷入其中。我们进去吧！

```
source mybubble/bin/activate
```

现在我们在泡沫中。您的终端应该在括号中显示虚拟环境名称，如下所示:

```
(mybubble) johndoe@hello:~/myproject$
```

现在我们在泡泡中，安装包是安全的。从现在开始，任何 pip 安装命令将只在虚拟环境中有效。您运行的任何代码都将只使用气泡内的包。

如果您列出已安装的软件包，您应该会看到一个非常短的当前已安装的默认软件包的列表(就像 pip 本身一样)。

```
pip list

Package       Version
------------- -------
pip           20.0.2 
pkg-resources 0.0.0  
setuptools    44.0.0
```

这个列表不再适用于机器中的所有 Python 包，而是适用于虚拟环境中的所有 Python 包。另外，请注意，气泡中使用的 Python 版本是您用来创建气泡的 Python 版本。

要离开气泡，只需调用`deactivate`命令。

始终为所有本地项目创建虚拟环境，并在这些虚拟环境中运行代码。项目之间包版本冲突的痛苦是那种让人辞职的痛苦。不要成为那种人。

# 什么是版本锁定？

![](img/6cd30ed4bf6ef62c0a80f26f281ca625.png)

作者图片

想象一下，你有一个依赖于熊猫包的项目，你想把它传达给世界上的其他人(和你未来的自己)。应该很容易吧？

首先，仅仅说:“你需要熊猫”是有风险的。

风险较小的选项是“你需要熊猫 1.2.1”，但即使这样也不总是足够的。

假设你正确地将熊猫版本锁定在 1.2.1。Pandas 本身有一个对 numpy 的依赖，但不幸的是，它并没有将这个依赖绑定到一个精确的 numpy 版本上。Pandas 本身只是说“你需要 numpy ”,并没有明确的版本。

起初，一切都很好，但六个月后，一个新的 numpy 版本 1.19.6 发布了，带有一个 showstopper 错误。

现在，如果有人安装了你的项目，他们会得到 pandas 1.2.1 和错误百出的 numpy 1.19.6，当你的软件吐出奇怪的错误时，可能会有一些白发。下水道系统在漏水。安装过程不确定！

最靠谱的办法就是把一切都压住。别动依赖关系的依赖关系的依赖关系的依赖关系的依赖关系…你会明白的。把他们钉得像兔子洞一样深。幸运的是，有一些工具可以让你做到这一点。

注意:如果您正在构建一个可重用的包，而不是一个典型的项目，您不应该如此激进地固定它(这就是为什么 Pandas 不固定到确切的 Numpy 版本)。由包的最终用户决定 pin 的内容和积极程度被认为是最佳实践。如果您作为一个包创建者，将所有东西都固定下来，那么您就向最终用户关上了大门。

# 如何固定 Python 依赖关系？

每当你打电话给`pip install`让一些热门的新包进入你的项目，你应该停下来想一想。这将为您的项目创建新的依赖项。我如何记录这一点？

您应该将新的库及其版本号写到 requirements.txt 文件中。pip 理解这种一次安装多个软件包的格式。

**# requires . txt**

```
pandas==1.2.1 matplotlib==3.4.0
```

**#安装**

```
pip install -r requirements.txt
```

这已经比人们遇到的大多数数据科学项目好得多，但我们仍然可以做得更好。还记得上一章关于版本锁定的递归依赖兔子洞吗？我们如何使安装更具确定性？

答案是`pip-compile`命令和`requirements.in`文本文件。

**#要求输入**

```
matplotlib==3.4.0
```

**#自动生成需求. txt**

```
pip-compile requirements.in
```

**#生成的需求. txt**

```
cycler==0.11.0
    # via matplotlib
kiwisolver==1.3.2
    # via matplotlib
matplotlib==3.4.0
    # via -r requirements.in
numpy==1.22.0
    # via
    #   matplotlib
    #   pandas
pandas==1.2.1
    # via -r requirements.in
pillow==9.0.0
    # via matplotlib
pyparsing==3.0.6
    # via matplotlib
python-dateutil==2.8.2
    # via
    #   matplotlib
    #   pandas
pytz==2021.3
    # via pandas
six==1.16.0
    # via python-dateutil
```

在 requirements.in 中，你应该只放你的直接依赖项。

然后，pip-compile 将生成所有库到 requirements.txt 中的完美连接，这为确定性安装提供了所有信息。很简单！记住也要将这两个文件提交到 git 存储库中。

# Python 版本怎么钉？

![](img/6aad732f557136a72aa6a7d0c68e2685.png)

作者图片

固定 Python 版本是很棘手的。没有直接的方法来固定 Python 本身的版本依赖性(例如不使用 conda)。

您可以从您的项目中制作一个 Python 包，这允许您用键`python_requires>=3.9`在`setup.py`或`setup.cfg`中定义 Python 版本，但是对于一个典型的数据科学项目来说，这是多余的，因为它通常不具有可重用包的特征。

如果你真的很重视特定的 Python，你也可以在你的代码中这样做:

```
import sys

if sys.version_info < (3,9):
    sys.exit("Python >= 3.9 required.")
```

最防弹的强制 Python 版本的方法是使用 Docker 容器，我们将在下一章讨论！

# 主要要点

**不要回避依赖管理** —当你把咖啡倒在你的 MacBook 上时，你未来的自己会欣赏那些记录在案的依赖。

**总是在你的本地计算机上使用虚拟环境**——当你安全地呆在保护罩内时，尝试一下有两颗 GitHub 星的深奥的 Python 库没什么大不了的。

**固定版本比不固定要好**——当你的项目不固定时，固定版本可以防止包向前移动。

**包变化很大，Python 变化不大**——即使一个包也可能有几十个嵌套的依赖项，它们在不断变化，但 Python 相对稳定，经得起未来考验。

# 云呢？

当您的项目足够成熟，并提升到云和生产时，您应该着眼于锁定整个环境，而不仅仅是 Python 的东西。

这就是 Docker 容器是你最好的朋友的地方，因为它们不仅能让你锁定 Python 版本，还能锁定操作系统中的任何东西。它就像一个虚拟环境，但规模更大。

我们的下一章将涵盖你需要知道的关于 Docker 的一切，敬请期待！

# 想要更多实用的工程技巧吗？

数据科学家越来越多地成为 R&D 团队的一部分，并致力于生产系统，这意味着数据科学和工程领域正在发生碰撞。我想让没有工程背景的数据科学家更容易理解，就这个主题写了一本免费电子书。

下载电子书: [*数据科学家的工程实践*](https://valohai.com/engineering-practices-ebook/)

*原载于*[*https://valohai.com*](https://valohai.com/blog/dependency-management-for-data-science/)*。*