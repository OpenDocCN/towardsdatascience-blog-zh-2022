<html>
<head>
<title>A Little Code Optimisation Goes a Long Way</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一点点代码优化大有帮助</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/a-little-code-optimisation-goes-a-long-way-91f92ff9f468#2022-03-19">https://towardsdatascience.com/a-little-code-optimisation-goes-a-long-way-91f92ff9f468#2022-03-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="9972" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">即使是原型代码，微小的优化也是有益的</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/6da357cb97ada60d58cbe37bda7f3eed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZtgUXvNBjCJFgJbW"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@laurentmedia?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上画</a></p></figure><blockquote class="kw kx ky"><p id="77d2" class="kz la lb lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">原型代码通常有可能导致严重的头痛或噩梦。这样会造成不同团队之间的摩擦，容易积累技术债。如果在每个阶段都注意一点代码优化和简化，就不会出现这种情况。</p></blockquote><p id="bada" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">需要为客户快速构建模型原型。然后，炸弹被投入生产。在生产过程中的某个地方，新的炸弹被扔了过来，循环继续，我们都快乐地生活着(不是)。</p><p id="584e" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">我们总是匆忙地快速开发代码以满足最后期限，这通常意味着草率/复杂的代码，转化为技术债务(因此术语“炸弹”，或者有些人可能使用术语“雪球”)。虽然很容易认为“这只是一点债务”，或者“我们可以以后再解决这个问题”，但可怕的是，每一点都很重要，越积越多。债务就是债务，如果不偿还，“利息”或罚款是巨大的，当所有这些小事被忽视并积累到为时已晚时，这很容易引起摩擦并淹没团队。</p><p id="777b" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">虽然只有在接近(甚至在之后)生产时才考虑优化代码是很常见的，但如果在原型构建的早期阶段对代码进行<a class="ae kv" href="https://en.wikipedia.org/wiki/Program_optimization" rel="noopener ugc nofollow" target="_blank">优化(即运行更有效或使用更少的资源)</a>和简化，也不会有什么坏处。澄清一下，我并不是说原型模型需要完全优化。我提倡的是，任何开发代码的人都应该:</p><ul class=""><li id="8b7c" class="lz ma iq lc b ld le lg lh lw mb lx mc ly md lv me mf mg mh bi translated"><a class="ae kv" href="https://en.wikipedia.org/wiki/KISS_principle" rel="noopener ugc nofollow" target="_blank">“保持简单，笨蛋”(KISS) </a> ( <a class="ae kv" href="https://ernchow.medium.com/the-importance-of-kiss-ing-and-testing-when-mixing-programming-languages-and-in-general-3c20ead71d9f" rel="noopener">见我的老文章</a>)</li><li id="5fbd" class="lz ma iq lc b ld mi lg mj lw mk lx ml ly mm lv me mf mg mh bi translated">学会更有效地使用你的工具(例如包/库)</li></ul><p id="13f0" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">详细说明一下第二点，使用一个包的方法是非常低效的(例如<code class="fe mn mo mp mq b">pandas</code>)。但是稍加调整，这可以显著地改善您的代码。</p><p id="e076" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">下面是一些虚构的场景，展示了一些非常愚蠢的代码来说明这一点。</p><h1 id="89c7" class="mr ms iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">虚构的场景</h1><p id="001b" class="pw-post-body-paragraph kz la iq lc b ld nj jr lf lg nk ju li lw nl ll lm lx nm lp lq ly nn lt lu lv ij bi translated">假设我们有一些 2000 万件商品的销售数据，用“列”<code class="fe mn mo mp mq b">selling_prices</code>、<code class="fe mn mo mp mq b">costs_per_unit</code>、<code class="fe mn mo mp mq b">unit_sold_counts</code>，例如:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi no"><img src="../Images/cf0e2a44b9eaa6bf8e80c1fb0e16e3c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/format:webp/0*aG9mMD54VdvCaPCN.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">创建虚拟数据(来源:作者)</p></figure><p id="f492" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">这给了我们类似于:</p><pre class="kg kh ki kj gt np mq nq nr aw ns bi"><span id="0718" class="nt ms iq mq b gy nu nv l nw nx">selling_prices = [142, 52, 94, 72, 47, 86, ...] <br/>costs_per_unit = [21, 14, 26, 18, 27, 38, ...] <br/>units_sold_counts = [9090, 70, 300, 930, 204, 650, ...]</span></pre><p id="eba8" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">可能有比列表更好的方法来存储/处理这种大小的数据，但是为了便于讨论，让我们坚持使用 3 个单独的列表作为起点，如上所示。然后，我们要计算<code class="fe mn mo mp mq b">total_profit</code>，即对每个水果的(<code class="fe mn mo mp mq b">selling_price</code> - <code class="fe mn mo mp mq b">cost_per_unit</code> ) x <code class="fe mn mo mp mq b">units</code>求和。</p><h1 id="7179" class="mr ms iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">探测</h1><p id="6d53" class="pw-post-body-paragraph kz la iq lc b ld nj jr lf lg nk ju li lw nl ll lm lx nm lp lq ly nn lt lu lv ij bi translated">出于演示的目的，让我们做一些夸张的傻事(即匆忙和草率的代码):</p><ol class=""><li id="56c2" class="lz ma iq lc b ld le lg lh lw mb lx mc ly md lv ny mf mg mh bi translated">创造一个空的<code class="fe mn mo mp mq b">pandas.DataFrame()</code></li><li id="8271" class="lz ma iq lc b ld mi lg mj lw mk lx ml ly mm lv ny mf mg mh bi translated">逐一插入信息栏</li><li id="41a2" class="lz ma iq lc b ld mi lg mj lw mk lx ml ly mm lv ny mf mg mh bi translated">用<code class="fe mn mo mp mq b">df.apply</code> + a <code class="fe mn mo mp mq b">lambda</code>函数计算<code class="fe mn mo mp mq b">total_profit</code>，并对结果求和</li><li id="2277" class="lz ma iq lc b ld mi lg mj lw mk lx ml ly mm lv ny mf mg mh bi translated">任务完成。(真的吗？)</li></ol><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nz"><img src="../Images/df8f300cd98b9ff81359b8dc5f8aa9d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*77vcG5qls1N31oKz.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">计算总利润的仓促草率的代码(来源:作者)</p></figure><h1 id="20a9" class="mr ms iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">优化/简化</h1><p id="3acd" class="pw-post-body-paragraph kz la iq lc b ld nj jr lf lg nk ju li lw nl ll lm lx nm lp lq ly nn lt lu lv ij bi translated">如果您正在使用<code class="fe mn mo mp mq b">pandas</code>，有一个简单的变化来优化我们想要实现的目标:</p><ol class=""><li id="7246" class="lz ma iq lc b ld le lg lh lw mb lx mc ly md lv ny mf mg mh bi translated">一步创建完整的<code class="fe mn mo mp mq b">pandas.DataFrame</code></li><li id="075b" class="lz ma iq lc b ld mi lg mj lw mk lx ml ly mm lv ny mf mg mh bi translated">使用<a class="ae kv" href="https://numpy.org/doc/stable/user/basics.broadcasting.html" rel="noopener ugc nofollow" target="_blank">广播操作</a>计算所需输出</li><li id="7163" class="lz ma iq lc b ld mi lg mj lw mk lx ml ly mm lv ny mf mg mh bi translated">(断言输出只是为了检查结果是否与原来的<code class="fe mn mo mp mq b">total_profit</code>一致)</li></ol><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oa"><img src="../Images/446ee83c932c446a253ce16acb792de7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mbkHj0ShWPXq2hvt.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">计算总利润的优化代码(来源:作者)</p></figure><p id="7cd3" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">为了进一步简化(和优化)，我们可以直接计算输出，而不需要<code class="fe mn mo mp mq b">pandas</code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/4f4a085fbdbaafc9c5d31f0bcce71cf5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1374/format:webp/0*9OFzy5isic-VR7bq.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">计算没有熊猫的总利润(来源:作者)</p></figure><p id="c4c4" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">在这种规模下(2000 万行)，也许使用<code class="fe mn mo mp mq b">numpy</code>可以加快速度，但仍然保持代码简单，就像这样:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/3c2aa2f9eb7ec4561cf151fd618349bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1330/format:webp/0*UmgDLR3ZvKazjDDj.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">进一步加快 numpy 计算利润的速度(来源:作者)</p></figure><h1 id="3946" class="mr ms iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">计时！</h1><p id="3e56" class="pw-post-body-paragraph kz la iq lc b ld nj jr lf lg nk ju li lw nl ll lm lx nm lp lq ly nn lt lu lv ij bi translated">现在，让我们用 IPython/jupyter notebook 的<a class="ae kv" href="https://ipython.readthedocs.io/en/stable/interactive/magics.html#magic-timeit" rel="noopener ugc nofollow" target="_blank"> %timeit </a>神奇命令来计时每种方法运行我们的 2000 万个数据集需要多长时间。结果如下:</p><ul class=""><li id="77aa" class="lz ma iq lc b ld le lg lh lw mb lx mc ly md lv me mf mg mh bi translated">(夸张地哑)原方法:280 秒</li><li id="d08d" class="lz ma iq lc b ld mi lg mj lw mk lx ml ly mm lv me mf mg mh bi translated">方法同<code class="fe mn mo mp mq b">pandas</code>(改进):17.7 秒</li><li id="4205" class="lz ma iq lc b ld mi lg mj lw mk lx ml ly mm lv me mf mg mh bi translated">无<code class="fe mn mo mp mq b">pandas</code>的方法:4.48 秒</li><li id="bf86" class="lz ma iq lc b ld mi lg mj lw mk lx ml ly mm lv me mf mg mh bi translated">使用<code class="fe mn mo mp mq b">numpy</code>的方法:3.82 秒</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi od"><img src="../Images/4c94952da473eb7b76ec5e53cbc1d023.png" data-original-src="https://miro.medium.com/v2/resize:fit:1388/format:webp/0*QBnpfdBLJxJOX9wD.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">计算总利润的每种方法的计时运行(来源:作者)</p></figure><h1 id="f333" class="mr ms iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">思想</h1><p id="58b5" class="pw-post-body-paragraph kz la iq lc b ld nj jr lf lg nk ju li lw nl ll lm lx nm lp lq ly nn lt lu lv ij bi translated">结果非常清楚。只需对如何使用<code class="fe mn mo mp mq b">pandas</code>进行计算进行简单的调整，就可以使计算速度提高 10 倍以上！想象一下，为了各种各样的<a class="ae kv" href="https://en.wikipedia.org/wiki/Exploratory_data_analysis" rel="noopener ugc nofollow" target="_blank">探索性数据分析(EDA) </a>项目，你不得不一次又一次地使用<code class="fe mn mo mp mq b">pandas</code>，难道你不想通过更有效地使用这个包来自动加速吗？</p><p id="1974" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">如果你真的不需要使用<code class="fe mn mo mp mq b">pandas</code>，另一个额外的调整(即直接计算结果)会给你更好的性能(&gt;快 50 倍)，只是因为你不需要创建整个数据帧(即使重构，这也是一个很大的开销！)过程中。该方法仍然比使用<code class="fe mn mo mp mq b">numpy</code>的方法慢，但性能不会相差太远。这是 KISS 经常被忽视和低估的优点，通过剥离不需要的东西，代码在某种程度上自然得到了优化，而没有使用任何“专门的”加速库。</p><p id="7917" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">这些都是微小的细节，但每一个小细节都很重要！你越了解如何更有效地使用你的工具，你就能更自然地优化和简化你的代码。这可能会有很长的路要走，因为团队会随着时间积累更少的技术债务，代码通常会运行得更快更好！</p><p id="c8c6" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">“就这些！”(引用团队成员的话，每当他觉得自己说了一些合理的话时)</p><h1 id="4bbb" class="mr ms iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">承认</h1><p id="3bc4" class="pw-post-body-paragraph kz la iq lc b ld nj jr lf lg nk ju li lw nl ll lm lx nm lp lq ly nn lt lu lv ij bi translated">非常感谢<a class="ae kv" href="https://www.linkedin.com/in/yaqubalwan/" rel="noopener ugc nofollow" target="_blank"> Yaqub Alwan </a>、<a class="ae kv" href="https://gal-lellouche.medium.com/" rel="noopener"> Gal Lellouche </a>和<a class="ae kv" href="https://medium.com/@saedhussain" rel="noopener"> Saed Hussain </a>富有洞察力的讨论和这篇文章的校对。</p><p id="6cbc" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">注意事项:</p><ul class=""><li id="88af" class="lz ma iq lc b ld le lg lh lw mb lx mc ly md lv me mf mg mh bi translated">原工作 jupyter 笔记本可以在<a class="ae kv" href="https://github.com/chilledgeek/blog_dump/blob/main/fictional_scenarios/fictional_sales.ipynb" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</li><li id="7c12" class="lz ma iq lc b ld mi lg mj lw mk lx ml ly mm lv me mf mg mh bi translated">这篇文章也张贴在<a class="ae kv" href="https://www.blog.chilledgeek.com/" rel="noopener ugc nofollow" target="_blank">blog.chilledgeek.com</a></li></ul></div></div>    
</body>
</html>