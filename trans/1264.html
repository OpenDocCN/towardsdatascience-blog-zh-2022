<html>
<head>
<title>Token Bucket Algorithm With Rust</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带 Rust 的令牌桶算法</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/token-bucket-algorithm-with-rust-4fa130c08ca8#2022-03-30">https://towardsdatascience.com/token-bucket-algorithm-with-rust-4fa130c08ca8#2022-03-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ec26" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">周末建设和学习。这个周末让我们用铁锈做一个象征性的桶。</h2></div></div><div class="ab cl ki kj hx kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="im in io ip iq"><p id="9d2c" class="pw-post-body-paragraph kp kq it kr b ks kt ju ku kv kw jx kx ky kz la lb lc ld le lf lg lh li lj lk im bi translated">我开始写作之旅已经快三年了。</p><p id="eed7" class="pw-post-body-paragraph kp kq it kr b ks kt ju ku kv kw jx kx ky kz la lb lc ld le lf lg lh li lj lk im bi translated">每个周末，除了孩子和家庭活动之外，只要我有时间，我就会进行代码演练或编写代码和学习的想法。</p><p id="eb09" class="pw-post-body-paragraph kp kq it kr b ks kt ju ku kv kw jx kx ky kz la lb lc ld le lf lg lh li lj lk im bi translated">你们的支持是让我不断前进，写出更多精彩学习分享的最重要动力。</p><p id="3d8b" class="pw-post-body-paragraph kp kq it kr b ks kt ju ku kv kw jx kx ky kz la lb lc ld le lf lg lh li lj lk im bi translated">你可以看看我的其他系列和不同主题的文章。</p><div class="ll lm gp gr ln lo"><a href="https://jayhuang75.medium.com/" rel="noopener follow" target="_blank"><div class="lp ab fo"><div class="lq ab lr cl cj ls"><h2 class="bd iu gy z fp lt fr fs lu fu fw is bi translated">魏黄-中号</h2><div class="lv l"><h3 class="bd b gy z fp lt fr fs lu fu fw dk translated">在媒介上阅读黄炜的作品。我喜欢学习。学会成功。每天，魏煌和其他成千上万的人…</h3></div><div class="lw l"><p class="bd b dl z fp lt fr fs lu fu fw dk translated">jayhuang75.medium.com</p></div></div><div class="lx l"><div class="ly l lz ma mb lx mc md lo"/></div></div></a></div></div><div class="ab cl ki kj hx kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="im in io ip iq"><h1 id="f624" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">令牌桶是什么？</h1><p id="2c3a" class="pw-post-body-paragraph kp kq it kr b ks mw ju ku kv mx jx kx ky my la lb lc mz le lf lg na li lj lk im bi translated">先说“限速”。每个软件工程师都明白“速率限制”是如何通过监控传入的请求并确保它们不违反阈值来管理 API。</p><p id="50be" class="pw-post-body-paragraph kp kq it kr b ks kt ju ku kv kw jx kx ky kz la lb lc ld le lf lg lh li lj lk im bi translated">我们正在定义每单位时间的请求率，并排队/拒绝发送超过我们的速率中描述的请求数的传入请求。</p><p id="542c" class="pw-post-body-paragraph kp kq it kr b ks kt ju ku kv kw jx kx ky kz la lb lc ld le lf lg lh li lj lk im bi translated">我们需要一种测量和跟踪的方法来实现这一点。具体来说，有两种主要算法可以实现这一点。</p><ol class=""><li id="1ba0" class="nb nc it kr b ks kt kv kw ky nd lc ne lg nf lk ng nh ni nj bi translated">令牌桶算法。</li><li id="f3cc" class="nb nc it kr b ks nk kv nl ky nm lc nn lg no lk ng nh ni nj bi translated">漏桶算法。</li></ol><blockquote class="np"><p id="e5a5" class="nq nr it bd ns nt nu nv nw nx ny lk dk translated">让我们来关注一下令牌桶算法。我这里用的比喻是电影院。</p></blockquote><figure class="oa ob oc od oe of gh gi paragraph-image"><div role="button" tabindex="0" class="og oh di oi bf oj"><div class="gh gi nz"><img src="../Images/f6e87b406f94e5fbe700ab8589c9eddc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wjMfRPXTLn-sC2wl"/></div></div><p class="ol om gj gh gi on oo bd b be z dk translated">克里斯特·卢哈尔斯在<a class="ae op" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><ol class=""><li id="490e" class="nb nc it kr b ks kt kv kw ky nd lc ne lg nf lk ng nh ni nj bi translated">一个电影院(桶)有预定义的最大容量(代币)和在此期间进入电影院的平均人数(比率)。</li><li id="b165" class="nb nc it kr b ks nk kv nl ky nm lc nn lg no lk ng nh ni nj bi translated">每一批进电影院的人都会消耗来自电影院(桶)的容量(代币)。</li><li id="4964" class="nb nc it kr b ks nk kv nl ky nm lc nn lg no lk ng nh ni nj bi translated">如果容量允许(有足够的代币)，人们可以从事以下活动，例如观看电影。</li><li id="6fef" class="nb nc it kr b ks nk kv nl ky nm lc nn lg no lk ng nh ni nj bi translated">如果没有足够的可用容量(令牌),我们可以根据您的使用案例和策略，拒绝即将到来的一批人的访问或排队。</li></ol><p id="cac0" class="pw-post-body-paragraph kp kq it kr b ks kt ju ku kv kw jx kx ky kz la lb lc ld le lf lg lh li lj lk im bi translated">这些步骤是我们需要在代码中反映的业务逻辑。</p></div><div class="ab cl ki kj hx kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="im in io ip iq"><h1 id="62df" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">让我们编码</h1><blockquote class="oq or os"><p id="f41a" class="kp kq ot kr b ks kt ju ku kv kw jx kx ou kz la lb ov ld le lf ow lh li lj lk im bi translated"><em class="it">免责声明，该代码主要侧重于逻辑演练，可能不包含一些实现细节或性能调优。</em></p></blockquote><blockquote class="np"><p id="eb9e" class="nq nr it bd ns nt nu nv nw nx ny lk dk translated">编码就像写一个故事。</p></blockquote><p id="57fa" class="pw-post-body-paragraph kp kq it kr b ks ox ju ku kv oy jx kx ky oz la lb lc pa le lf lg pb li lj lk im bi translated">在这个用例中，让我们从什么开始。</p><h2 id="a050" class="pc mf it bd mg pd pe dn mk pf pg dp mo ky ph pi mq lc pj pk ms lg pl pm mu pn bi translated">什么</h2><p id="1db4" class="pw-post-body-paragraph kp kq it kr b ks mw ju ku kv mx jx kx ky my la lb lc mz le lf lg na li lj lk im bi translated">Rust 中的结构是我们想要处理的对象。在这种情况下，我们查看令牌桶，其中包含容量(max_tokens)、平均人数(rate)、current_tokens、last_refill_timestamp 将是公式的变量。</p><figure class="po pp pq pr gt of"><div class="bz fp l di"><div class="ps pt l"/></div><p class="ol om gj gh gi on oo bd b be z dk translated">令牌桶结构—按作者</p></figure><h2 id="cc50" class="pc mf it bd mg pd pe dn mk pf pg dp mo ky ph pi mq lc pj pk ms lg pl pm mu pn bi translated">怎么</h2><p id="9ab0" class="pw-post-body-paragraph kp kq it kr b ks mw ju ku kv mx jx kx ky my la lb lc mz le lf lg na li lj lk im bi translated">构建新令牌桶的方式，我们可以考虑我们的第一个“如何”<strong class="kr iu">如何</strong>初始化新令牌桶。</p><figure class="po pp pq pr gt of"><div class="bz fp l di"><div class="ps pt l"/></div><p class="ol om gj gh gi on oo bd b be z dk translated">令牌桶构造器—按作者</p></figure><p id="4991" class="pw-post-body-paragraph kp kq it kr b ks kt ju ku kv kw jx kx ky kz la lb lc ld le lf lg lh li lj lk im bi translated">接下来的<strong class="kr iu">如何</strong>将是基本公式，私有核心引擎，来更新令牌桶的状态。</p><figure class="po pp pq pr gt of"><div class="bz fp l di"><div class="ps pt l"/></div><p class="ol om gj gh gi on oo bd b be z dk translated">令牌桶更新—按作者</p></figure><p id="437c" class="pw-post-body-paragraph kp kq it kr b ks kt ju ku kv kw jx kx ky kz la lb lc ld le lf lg lh li lj lk im bi pu translated"><span class="l pv pw px bm py pz qa qb qc di"> T </span>主要想法是检查最后更新的时间戳，并根据预定义的速率确定将有多少令牌添加到当前容量。</p><p id="a9dd" class="pw-post-body-paragraph kp kq it kr b ks kt ju ku kv kw jx kx ky kz la lb lc ld le lf lg lh li lj lk im bi translated">一旦它被更新，我们可以决定我们的下一步行动。</p><p id="34c0" class="pw-post-body-paragraph kp kq it kr b ks kt ju ku kv kw jx kx ky kz la lb lc ld le lf lg lh li lj lk im bi translated">在下一个动作中，我们将把它塑造成一个 trait，它对令牌桶的动作函数进行分组。</p><figure class="po pp pq pr gt of"><div class="bz fp l di"><div class="ps pt l"/></div><p class="ol om gj gh gi on oo bd b be z dk translated">令牌桶特征—按作者</p></figure><p id="c733" class="pw-post-body-paragraph kp kq it kr b ks kt ju ku kv kw jx kx ky kz la lb lc ld le lf lg lh li lj lk im bi translated">最后<strong class="kr iu">如何</strong>将如何处理即将到来的人，一个公共功能控制与中央核心更新功能触发的时间间隔内。</p><figure class="po pp pq pr gt of"><div class="bz fp l di"><div class="ps pt l"/></div><p class="ol om gj gh gi on oo bd b be z dk translated">令牌桶句柄—按作者</p></figure><h2 id="fead" class="pc mf it bd mg pd pe dn mk pf pg dp mo ky ph pi mq lc pj pk ms lg pl pm mu pn bi translated">让我们测试一下</h2><p id="01e3" class="pw-post-body-paragraph kp kq it kr b ks mw ju ku kv mx jx kx ky my la lb lc mz le lf lg na li lj lk im bi translated">电影院我们最多能容纳 10 个人，平均两个人，输入速率，让我们用今天的 10 场电影来测试它，每部电影只有 2 秒。(仅供演示，我不相信有 2 秒钟的电影存在:)</p><figure class="po pp pq pr gt of"><div class="bz fp l di"><div class="ps pt l"/></div><p class="ol om gj gh gi on oo bd b be z dk translated">令牌桶测试—按作者</p></figure><figure class="po pp pq pr gt of gh gi paragraph-image"><div role="button" tabindex="0" class="og oh di oi bf oj"><div class="gh gi qd"><img src="../Images/b7e121d19aea5a719b8308696d314dde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NoNKMzSK-L-bF8mN_BWshA.png"/></div></div><p class="ol om gj gh gi on oo bd b be z dk translated">令牌桶测试结果—按作者</p></figure><h1 id="ce55" class="me mf it bd mg mh qe mj mk ml qf mn mo jz qg ka mq kc qh kd ms kf qi kg mu mv bi translated">最后的话</h1><p id="8ebc" class="pw-post-body-paragraph kp kq it kr b ks mw ju ku kv mx jx kx ky my la lb lc mz le lf lg na li lj lk im bi translated">从逻辑代码演练的角度来看，我们主要了解了 Rust Token Bucket 算法。</p><p id="61bf" class="pw-post-body-paragraph kp kq it kr b ks kt ju ku kv kw jx kx ky kz la lb lc ld le lf lg lh li lj lk im bi translated">请加入我的中码学习连载，获取最新更新。</p><div class="ll lm gp gr ln lo"><a href="https://jayhuang75.medium.com/membership" rel="noopener follow" target="_blank"><div class="lp ab fo"><div class="lq ab lr cl cj ls"><h2 class="bd iu gy z fp lt fr fs lu fu fw is bi translated">用我的推荐链接加入媒体-黄伟</h2><div class="lv l"><h3 class="bd b gy z fp lt fr fs lu fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="lw l"><p class="bd b dl z fp lt fr fs lu fu fw dk translated">jayhuang75.medium.com</p></div></div><div class="lx l"><div class="qj l lz ma mb lx mc md lo"/></div></div></a></div><p id="0fe9" class="pw-post-body-paragraph kp kq it kr b ks kt ju ku kv kw jx kx ky kz la lb lc ld le lf lg lh li lj lk im bi translated">另外，你可以用下面的链接给我买一杯咖啡，让我有动力在周末进行更多的锻炼和学习。</p><div class="ll lm gp gr ln lo"><a href="https://www.buymeacoffee.com/jayhuang75" rel="noopener  ugc nofollow" target="_blank"><div class="lp ab fo"><div class="lq ab lr cl cj ls"><h2 class="bd iu gy z fp lt fr fs lu fu fw is bi translated">jayhuang75 是编程、编码、工程和领导博客</h2><div class="lv l"><h3 class="bd b gy z fp lt fr fs lu fu fw dk translated">嘿👋你现在可以给我买一杯咖啡，让我有动力在周末进行更多的建设和学习。</h3></div><div class="lw l"><p class="bd b dl z fp lt fr fs lu fu fw dk translated">www.buymeacoffee.com</p></div></div><div class="lx l"><div class="qk l lz ma mb lx mc md lo"/></div></div></a></div></div></div>    
</body>
</html>