<html>
<head>
<title>Use Python Scripts to Insert CSV Data into Django Databases</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Python 脚本将 CSV 数据插入 Django 数据库</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/use-python-scripts-to-insert-csv-data-into-django-databases-72eee7c6a433#2022-02-21">https://towardsdatascience.com/use-python-scripts-to-insert-csv-data-into-django-databases-72eee7c6a433#2022-02-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="013a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Django-extensions 是您正在寻找的工具</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/837d4e2d64a04621843a9514abee62f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*syAhROtQp8wdW3BF1anWBA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">托拜厄斯·菲舍尔在<a class="ae kv" href="https://unsplash.com/s/photos/databases?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="878a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">简介</strong></p><p id="2755" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以，你努力工作，为你的客户开发了一个新的现代 Django web 应用程序。她很开心，恭喜你最后的结果。<em class="ls">干得好。现在，我们只需将数百万个数据库行插入新的应用程序，并开始在生产中使用它</em>。</p><p id="462d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一些准备不足的人听到这样的话会愣住，但你不会:你会知道如何使用<strong class="ky ir"> django-extensions </strong>并且在你安装它之后，使用 django 的 ORM 功能编写 Python 脚本来快速加载数据到 Django 数据库是多么容易。</p><p id="361a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您还不知道 django-extensions，不要担心:这个快速教程将通过一个非常简单的例子展示它是如何工作的。然后你可以把它扩展到你日常活动中可能遇到的更复杂的情况。</p><p id="e24f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第 1 部分:我们的模型和数据</strong></p><p id="422b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将使用我在<a class="ae kv" href="https://medium.com/towards-data-science/django-first-steps-for-the-total-beginners-a-quick-tutorial-5f1e5e7e9a8c" rel="noopener"> my Django tutorial for total 初学者教程</a>中创建的非常简化的 films 应用程序，该教程发布在<a class="ae kv" href="https://medium.com/towards-data-science" rel="noopener">toward Data Science</a>上。</p><div class="lt lu gp gr lv lw"><a rel="noopener follow" target="_blank" href="/django-first-steps-for-the-total-beginners-a-quick-tutorial-5f1e5e7e9a8c"><div class="lx ab fo"><div class="ly ab lz cl cj ma"><h2 class="bd ir gy z fp mb fr fs mc fu fw ip bi translated">Django 初学者的第一步:快速教程</h2><div class="md l"><h3 class="bd b gy z fp mb fr fs mc fu fw dk translated">了解如何在 Django 应用程序中嵌入 Plotly 图形，以及其他主题</h3></div><div class="me l"><p class="bd b dl z fp mb fr fs mc fu fw dk translated">towardsdatascience.com</p></div></div><div class="mf l"><div class="mg l mh mi mj mf mk kp lw"/></div></div></a></div><p id="e9b5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">它的模型只有两个表:<code class="fe ml mm mn mo b">films_film</code>和<code class="fe ml mm mn mo b">films_genre</code>。来自<code class="fe ml mm mn mo b">films/models.py</code>的代码转载如下:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="5ce0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">正如我在我的教程中提到的，这不是这些实体之间的完美模型关系，特别是因为它确定了一部电影不能有一个以上的类型。然而，我决定建立一个用于教学目的的简化模型，我们将在本文中保持这种方式。如果你愿意，你可以在以后扩展这个模型，允许电影和流派之间的多对多关系，或者包括新的实体，比如导演和奖项。</p><p id="cacf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将使用的 CSV 文件可以在我的 GitHub 库中找到<a class="ae kv" href="https://raw.githubusercontent.com/fabricius1/DjangoTutorial/master/films/pixar.csv" rel="noopener ugc nofollow" target="_blank">。它是使用来自<code class="fe ml mm mn mo b">pixarfilms</code> </a><a class="ae kv" href="https://cran.r-project.org/web/packages/pixarfilms/index.html" rel="noopener ugc nofollow" target="_blank"> R 库</a>的数据创建的。由于在我创建的数据模型中，每部电影只允许一种类型，所以我为大多数电影指定了类型“<em class="ls">动画</em>”，但我也包括了一些其他类型，因此我们的示例中不只有一种类型。</p><p id="0ff0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第 2 部分:设置我们的环境</strong></p><p id="645e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">1.在你的机器上选择一个你想要工作的文件夹，用启动代码克隆我的 GitHub 库。</p><pre class="kg kh ki kj gt mr mo ms mt aw mu bi"><span id="3ded" class="mv mw iq mo b gy mx my l mz na">git clone <a class="ae kv" href="https://github.com/fabricius1/DjangoTutorial.git" rel="noopener ugc nofollow" target="_blank">https://github.com/fabricius1/DjangoTutorial.git</a></span></pre><p id="0073" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2.在克隆的文件夹<code class="fe ml mm mn mo b">DjangoTutorial</code>中移动。</p><pre class="kg kh ki kj gt mr mo ms mt aw mu bi"><span id="ddaa" class="mv mw iq mo b gy mx my l mz na">cd DjangoTutorial</span></pre><p id="bb03" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请注意，<code class="fe ml mm mn mo b">pixar.csv</code>文件已经保存在<code class="fe ml mm mn mo b">DjangoTutorial/films</code>文件夹中。</p><p id="076b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">3.用<code class="fe ml mm mn mo b">venv</code>创建一个虚拟环境。我叫我的<code class="fe ml mm mn mo b">.myenv</code>。</p><pre class="kg kh ki kj gt mr mo ms mt aw mu bi"><span id="5f51" class="mv mw iq mo b gy mx my l mz na">python -m venv .myenv</span></pre><p id="9993" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">4.通过针对您选择的终端和操作系统运行正确的命令来激活虚拟环境。下面的命令在我的 Git Bash for Windows 中有效。如果你对用<code class="fe ml mm mn mo b">venv</code>激活虚拟环境有疑问，请查阅<a class="ae kv" href="https://docs.python.org/3/library/venv.html" rel="noopener ugc nofollow" target="_blank"> Python 文档</a>。</p><pre class="kg kh ki kj gt mr mo ms mt aw mu bi"><span id="8302" class="mv mw iq mo b gy mx my l mz na">source .myenv/Scripts/activate</span></pre><p id="f0e7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从现在开始，所有命令都必须在激活虚拟环境的情况下执行。</p><p id="2bfb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">5.用 PIP 安装<code class="fe ml mm mn mo b">django</code>和<code class="fe ml mm mn mo b">django-extensions</code>。我们还将安装<code class="fe ml mm mn mo b">pandas</code>和<code class="fe ml mm mn mo b">plotly</code>，因为<code class="fe ml mm mn mo b">plotly.express</code>在克隆项目的<code class="fe ml mm mn mo b">films/views.py</code>文件中被调用。</p><pre class="kg kh ki kj gt mr mo ms mt aw mu bi"><span id="df09" class="mv mw iq mo b gy mx my l mz na">pip install django django-extensions pandas plotly</span></pre><p id="f0e4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你想了解更多关于<code class="fe ml mm mn mo b">django-extensions</code>，<a class="ae kv" href="https://django-extensions.readthedocs.io/" rel="noopener ugc nofollow" target="_blank">的信息，请阅读文档</a>，尤其是关于<a class="ae kv" href="https://django-extensions.readthedocs.io/en/latest/runscript.html" rel="noopener ugc nofollow" target="_blank">的 runscript 功能</a>的页面。'</p><p id="b3e8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">6.将字符串<code class="fe ml mm mn mo b">'django_extensions'</code>添加到<code class="fe ml mm mn mo b">project/settings.py</code>中的<code class="fe ml mm mn mo b">INSTALLED_APPS</code>列表中。其他行保持不变。</p><pre class="kg kh ki kj gt mr mo ms mt aw mu bi"><span id="61c9" class="mv mw iq mo b gy mx my l mz na">INSTALLED_APPS = [    <br/>    'django.contrib.admin',<br/>    'django.contrib.auth',<br/>    'django.contrib.contenttypes',<br/>    'django.contrib.sessions',<br/>    'django.contrib.messages',<br/>    'django.contrib.staticfiles',<br/>    <br/>    # films app:<br/>    'films.apps.FilmsConfig',</span><span id="80b2" class="mv mw iq mo b gy nb my l mz na">    # add this:<br/>    'django_extensions',<br/>]</span></pre><p id="e087" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">7.应用迁移文件在数据库中创建表:</p><pre class="kg kh ki kj gt mr mo ms mt aw mu bi"><span id="ed78" class="mv mw iq mo b gy mx my l mz na">python manage.py migrate</span></pre><p id="ea49" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">8.查找错误，并根据需要进行更正:</p><pre class="kg kh ki kj gt mr mo ms mt aw mu bi"><span id="d801" class="mv mw iq mo b gy mx my l mz na">python manage.py check</span></pre><p id="5b95" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">9.用<code class="fe ml mm mn mo b">python manage.py runserver</code>在本地运行项目。</p><p id="8cf1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">10.在浏览器上打开<code class="fe ml mm mn mo b">http://localhost:8000/films</code>并检查应用程序，检查是否一切正常。屏幕上不会显示任何电影，因为刚刚创建了<code class="fe ml mm mn mo b">db.sqlite3</code>数据库。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nc"><img src="../Images/623a525c1641db590887c8d2ce62adc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vFxTXqAqsC2zmFkBSMPCyA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="04a2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第 3 部分:创建并运行脚本</strong></p><p id="49ea" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">11.停止服务器。在项目根目录下创建一个<code class="fe ml mm mn mo b">scripts</code>文件夹，与<code class="fe ml mm mn mo b">manage.py</code>在同一层:</p><pre class="kg kh ki kj gt mr mo ms mt aw mu bi"><span id="6398" class="mv mw iq mo b gy mx my l mz na">mkdir scripts</span></pre><p id="59ba" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">12.创建<code class="fe ml mm mn mo b">scripts/load_pixar.py</code>文件。</p><pre class="kg kh ki kj gt mr mo ms mt aw mu bi"><span id="a4bd" class="mv mw iq mo b gy mx my l mz na">touch scripts/load_pixar.py </span></pre><p id="cca8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">13.用以下代码填充<code class="fe ml mm mn mo b">scripts/load_pixar.py</code>。我们稍后会解释:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="5fea" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">14.运行<code class="fe ml mm mn mo b">python manage.py runscript load_pixar</code>。请注意<code class="fe ml mm mn mo b">load_pixar</code>是不带<code class="fe ml mm mn mo b">.py</code>扩展名的。</p><p id="d12d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果一切顺利，您将在控制台中看到导入的行。</p><p id="16af" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">15.用<code class="fe ml mm mn mo b">python manage.py runserver</code>再次运行服务器，然后在浏览器上打开<code class="fe ml mm mn mo b">http://localhost:8000/films</code>。查看 Django 页面现在如何显示导入的电影:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nc"><img src="../Images/843e02215c11c9f14d13803bd15d8806.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wE0vLw0e8SCK8Eo3zwgCjw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="6ceb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第四部分:关于脚本代码</strong></p><p id="b339" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ml mm mn mo b">scripts/load_pixar.py</code>代码中只有一个函数，其末尾没有<em class="ls"> dunder </em>调用。如<a class="ae kv" href="https://django-extensions.readthedocs.io/en/latest/runscript.html" rel="noopener ugc nofollow" target="_blank"> django-extensions 文档</a>中所述，<em class="ls">该文件必须实现一个</em> <code class="fe ml mm mn mo b"><em class="ls">run()</em></code> <em class="ls">函数。这是运行脚本时调用的内容。您可以导入 Django 项目的任何模型或其他部分，以便在这些脚本中使用。</em></p><p id="5d40" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，我们在脚本中导入了<code class="fe ml mm mn mo b">Films</code>和<code class="fe ml mm mn mo b">Genre</code>模型以及<code class="fe ml mm mn mo b">csv</code> Python 内置模块。接下来，在<code class="fe ml mm mn mo b">run()</code>函数中，我们使用<code class="fe ml mm mn mo b">with</code>上下文管理结构，并通过使用模式<code class="fe ml mm mn mo b">app_name/csv_file</code>而不是相对路径来打开<code class="fe ml mm mn mo b">pixar.csv</code>文件。</p><p id="f1a2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后我们将<code class="fe ml mm mn mo b">file</code>变量传递给<code class="fe ml mm mn mo b">csv.reader()</code>函数，调用<code class="fe ml mm mn mo b">next(reader)</code>跳过 CSV 头文件，最后使用 Django 的 ORM 方法<code class="fe ml mm mn mo b">.delete()</code>删除模型表中可能存在的任何实例。如果不想从表中删除现有的行，请删除这些代码行。</p><p id="af6b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下一步是遍历 CSV 中的所有行。在这部分代码中，我们第一次发现了重要的方法<code class="fe ml mm mn mo b">.get_or_create()</code>。它返回一个 tuple，其中第一个索引处的对象是创建的(如果数据库中还不存在)或检索的(如果已经存在)Django 模型对象。元组中的第二个元素是一个布尔值，如果对象已创建，则返回<code class="fe ml mm mn mo b">True</code>，否则返回<code class="fe ml mm mn mo b">False</code>。</p><p id="d346" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请注意我们是如何首先创建(或获取)了<code class="fe ml mm mn mo b">Genre</code>对象，然后使用它以及从每个 CSV 行中获取的其他信息来创建一个新的<code class="fe ml mm mn mo b">Film</code>对象并将其保存到数据库中。</p><p id="2369" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">最后的话</strong></p><p id="2467" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如前所述，这只是如何使用 django-extensions runscript 功能的一个非常简单的例子。通过了解基础知识，您可以实现更复杂模型的解决方案，还可以创建具有错误处理结构的代码，例如，处理异常。</p><p id="80e7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">亲爱的读者，非常感谢你花时间和精力阅读我的文章。</p><p id="eaf4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="ls">快乐编码！</em></p></div></div>    
</body>
</html>