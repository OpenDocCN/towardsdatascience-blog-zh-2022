<html>
<head>
<title>Writing Custom Django Database Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">编写定制的Django数据库函数</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/writing-custom-django-database-functions-4358e6030df7#2022-05-19">https://towardsdatascience.com/writing-custom-django-database-functions-4358e6030df7#2022-05-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="28ab" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">通过定制Django数据库函数，可以更好地控制查询过滤</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/b419ff2ed49ad469b422e151b4bb351c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DRZeeiIbqYPckF9C.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">根据<a class="ae kv" href="https://undraw.co/license" rel="noopener ugc nofollow" target="_blank">公共许可证</a>下的<a class="ae kv" href="https://undraw.co/" rel="noopener ugc nofollow" target="_blank"> Undraw </a>生成的图像</p></figure><p id="5484" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Django的数据库函数表示将在数据库中运行的函数。它为用户提供了一种将底层数据库提供的函数用作注释、聚合或过滤器的方式。函数也是<a class="ae kv" href="https://docs.djangoproject.com/en/4.0/ref/models/expressions/" rel="noopener ugc nofollow" target="_blank">表达式</a>，所以可以和<a class="ae kv" href="https://docs.djangoproject.com/en/4.0/ref/models/querysets/#aggregation-functions" rel="noopener ugc nofollow" target="_blank">聚合函数</a>等其他表达式一起使用和组合。</p><p id="4b37" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Django丰富的特性之一是可以定制它的各种功能。是的，你答对了！🙌我们可以根据需要定制Django数据库功能。</p><p id="b872" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">📝在本帖中，我们将通过下面的几个例子来了解根据我们的业务需求编写自定义函数的要点。</p><p id="c806" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">👉让我们先了解一下<code class="fe ls lt lu lv b">Django Func()</code>类，它是我们前进的基础。</p><h1 id="1f85" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">📜姜戈<code class="fe ls lt lu lv b">Func(*expressions, **extra)</code>级</h1><ul class=""><li id="d4c8" class="mo mp iq ky b kz mq lc mr lf ms lj mt ln mu lr mv mw mx my bi translated">类<a class="ae kv" href="https://docs.djangoproject.com/en/4.0/ref/models/expressions/#django.db.models.Func" rel="noopener ugc nofollow" target="_blank"> Func() </a>是<code class="fe ls lt lu lv b">Django Query Expressions</code>最通用的部分</li><li id="2f2d" class="mo mp iq ky b kz mz lc na lf nb lj nc ln nd lr mv mw mx my bi translated">它允许以某种方式将几乎任何函数或操作符实现到<code class="fe ls lt lu lv b">Django ORM</code>中</li><li id="5286" class="mo mp iq ky b kz mz lc na lf nb lj nc ln nd lr mv mw mx my bi translated"><a class="ae kv" href="https://docs.djangoproject.com/en/4.0/ref/models/expressions/#django.db.models.Func" rel="noopener ugc nofollow" target="_blank"> Func()表达式</a>是所有涉及数据库函数如<code class="fe ls lt lu lv b">COALESCE</code>和<code class="fe ls lt lu lv b">LOWER</code>或聚合如<code class="fe ls lt lu lv b">SUM</code>的表达式的基本类型</li><li id="9562" class="mo mp iq ky b kz mz lc na lf nb lj nc ln nd lr mv mw mx my bi translated">我推荐在使用<code class="fe ls lt lu lv b">Func()</code>之前先阅读<a class="ae kv" href="https://docs.djangoproject.com/en/4.0/ref/models/expressions/#avoiding-sql-injection" rel="noopener ugc nofollow" target="_blank">避开SQL注入</a></li></ul><p id="7540" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以下是编写自定义数据库函数的一些方法:</p><h1 id="860b" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">🔹自定义数据库函数</h1><p id="024f" class="pw-post-body-paragraph kw kx iq ky b kz mq jr lb lc mr ju le lf ne lh li lj nf ll lm ln ng lp lq lr ij bi translated">我们可以使用Django的<a class="ae kv" href="https://docs.djangoproject.com/en/4.0/ref/models/expressions/#django.db.models.Func" rel="noopener ugc nofollow" target="_blank"> Func类</a>创建自定义数据库函数。在我的一个项目中，我想用特定的日期格式将Django过滤器中的<code class="fe ls lt lu lv b">UTC</code>时间戳转换成<code class="fe ls lt lu lv b">IST</code>。编写两个简单的Django数据库函数帮助我<code class="fe ls lt lu lv b">reuse</code>在多个实例中使用它，如下所示:</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="945c" class="nl lx iq lv b gy nm nn l no np">from django.db.models import Func<br/><br/>class TimestampToIST(Func):<br/>    """ Converts the db (UTC) timestamp value to IST equivalent timestamp<br/>    """<br/>    function = 'timezone'<br/>    template = "%(function)s('Asia/Calcutta', %(expressions)s)"<br/><br/><br/>class TimestampToStr(Func):<br/>    """ Converts the timestamp to string using the given format<br/>    """<br/>    function = 'to_char'<br/>    template = "%(function)s(%(expressions)s, 'DD/MM/YYYY HH24:MI:SS')"  # 21/06/2021 16:08:34</span><span id="161b" class="nl lx iq lv b gy nq nn l no np"><br/># Usage<br/>Author.objects.annotate(last_updated=TimestampToStr(TimestampToIST(F('updated_at'))))</span></pre><h1 id="7701" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">🔹数据库功能的部分实现</h1><p id="f086" class="pw-post-body-paragraph kw kx iq ky b kz mq jr lb lc mr ju le lf ne lh li lj nf ll lm ln ng lp lq lr ij bi translated">另一个很好的定制例子是创建一个新版本的函数，其中已经填充了一两个参数。例如，让我们创建一个专门的<code class="fe ls lt lu lv b">SubStr</code>，它从字符串中提取第一个字符:</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="9353" class="nl lx iq lv b gy nm nn l no np">from functools import partial<br/>from django.db.models.functions import Substr<br/><br/>ExtractFirstChar = partial(Substr, pos=1, length=1)</span><span id="ad07" class="nl lx iq lv b gy nq nn l no np"><br/># Usage<br/>User.objects.annotate(name_initial=ExtractFirstChar('first_name'))</span></pre><h1 id="4380" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">🔹执行没有聚合函数的<code class="fe ls lt lu lv b">GROUP BY</code></h1><p id="8d5d" class="pw-post-body-paragraph kw kx iq ky b kz mq jr lb lc mr ju le lf ne lh li lj nf ll lm ln ng lp lq lr ij bi translated">想象一种情况，我们想使用<code class="fe ls lt lu lv b">GROUP BY</code>而不使用任何聚合函数。<code class="fe ls lt lu lv b">Django ORM</code>不允许我们在没有集合函数的情况下使用<code class="fe ls lt lu lv b">GROUP BY</code>🤨因此，为了实现这一点，我们可以创建一个Django函数，它被Django视为一个聚合函数，但在一个<code class="fe ls lt lu lv b">SQL query</code>中计算为<code class="fe ls lt lu lv b">NULL</code>，来源于<a class="ae kv" href="https://stackoverflow.com/a/65066965/9334209" rel="noopener ugc nofollow" target="_blank"> StackOverflow </a></p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="91f6" class="nl lx iq lv b gy nm nn l no np">from django.db.models import CharField, Func<br/><br/>class NullAgg(Func):<br/>    """Annotation that causes GROUP BY without aggregating.<br/><br/>    A fake aggregate Func class that can be used in an annotation to cause<br/>    a query to perform a GROUP BY without also performing an aggregate<br/>    operation that would require the server to enumerate all rows in every<br/>    group.<br/><br/>    Takes no constructor arguments and produces a value of NULL.<br/><br/>    Example:<br/>        ContentType.objects.values('app_label').annotate(na=NullAgg())<br/>    """<br/>    template = 'NULL'<br/>    contains_aggregate = True<br/>    window_compatible = False<br/>    arity = 0<br/>    output_field = CharField()</span></pre></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><h1 id="5193" class="lw lx iq bd ly lz ny mb mc md nz mf mg jw oa jx mi jz ob ka mk kc oc kd mm mn bi translated">📑资源</h1><ul class=""><li id="849f" class="mo mp iq ky b kz mq lc mr lf ms lj mt ln mu lr mv mw mx my bi translated"><a class="ae kv" href="https://docs.djangoproject.com/en/4.0/ref/models/database-functions/" rel="noopener ugc nofollow" target="_blank"> Django数据库功能</a></li><li id="7c5e" class="mo mp iq ky b kz mz lc na lf nb lj nc ln nd lr mv mw mx my bi translated"><a class="ae kv" href="https://docs.djangoproject.com/en/4.0/ref/models/expressions/#django.db.models.Func" rel="noopener ugc nofollow" target="_blank"> Django Func()类</a></li><li id="ac76" class="mo mp iq ky b kz mz lc na lf nb lj nc ln nd lr mv mw mx my bi translated"><a class="ae kv" href="https://stackoverflow.com/a/65066965/9334209" rel="noopener ugc nofollow" target="_blank">stack overflow response GROUP BY without aggregate</a></li></ul></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><p id="3c9b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="od">原载于2022年5月19日</em><a class="ae kv" href="https://dev.to/idrisrampurawala/writing-custom-django-database-functions-4dmb" rel="noopener ugc nofollow" target="_blank"><em class="od">https://dev . to</em></a><em class="od">。</em></p></div></div>    
</body>
</html>