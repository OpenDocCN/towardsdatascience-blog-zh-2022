<html>
<head>
<title>Query SQL Server System Tables to Reverse Engineer Databases</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">查询 SQL Server 系统表以对数据库进行反向工程</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/query-sql-server-system-tables-to-reverse-engineer-databases-fe26f98457d6#2022-03-22">https://towardsdatascience.com/query-sql-server-system-tables-to-reverse-engineer-databases-fe26f98457d6#2022-03-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="dca4" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">数据工程、SQL 和 SQL Server</h2><div class=""/><div class=""><h2 id="da5e" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">每个 Microsoft SQL Server 数据库中的系统表都包含有助于理解数据库的元数据</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/d92e578e5b8439445d324d303723a50d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mKnjeOfnh5nIM9zIJTg7uw.jpeg"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">凯文·Ku 从<a class="ae lh" href="https://www.pexels.com/photo/data-codes-through-eyeglasses-577585/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">派克斯</a>拍摄的照片</p></figure><p id="500f" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在长期的信息技术职业生涯中，我担任过软件开发人员、数据库管理员和数据分析师等角色，需要对几个 SQL Server 数据库进行反向工程。通常，这是因为软件供应商不会为他们的应用程序数据库提供专有文档。作为一名数据分析师或工程师，在某些情况下，我需要编写 SQL 查询来为数据分析解决方案获取数据。但是当数据库文档丢失时，我求助于系统表和视图来理解数据库的结构及其包含的数据。</p><p id="0f12" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">作为数据工程师、数据分析师或数据科学家，您知道对任何数据分析项目所用数据的良好理解是项目成功的关键。但是文档有时是不可用的。如果是这样，并且您的数据源是 SQL Server 数据库，那么应用本文中描述的查询和技术可以帮助您理解数据库的表、列、主键和外键关系，为您提供一个良好的开端。</p><h1 id="69ac" class="me mf it bd mg mh mi mj mk ml mm mn mo ki mp kj mq kl mr km ms ko mt kp mu mv bi translated">本文的先决条件</h1><p id="f5d5" class="pw-post-body-paragraph li lj it lk b ll mw kd ln lo mx kg lq lr my lt lu lv mz lx ly lz na mb mc md im bi translated">要从本文中获得最大收益，您需要以下内容:</p><ul class=""><li id="2723" class="nb nc it lk b ll lm lo lp lr nd lv ne lz nf md ng nh ni nj bi translated">Windows 机器</li><li id="e4b0" class="nb nc it lk b ll nk lo nl lr nm lv nn lz no md ng nh ni nj bi translated">Microsoft SQL Server 或 SQL Server Express 的任何最新版本</li><li id="0964" class="nb nc it lk b ll nk lo nl lr nm lv nn lz no md ng nh ni nj bi translated">Microsoft SQL Server Management Studio(SSMS)</li><li id="31a1" class="nb nc it lk b ll nk lo nl lr nm lv nn lz no md ng nh ni nj bi translated">对用 SQL 编写 SELECT 语句的基本理解</li></ul><p id="7050" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">如果您没有 SQL Server 或 SSMS，下一节将提供这些工具的基本安装说明。</p><h1 id="85dc" class="me mf it bd mg mh mi mj mk ml mm mn mo ki mp kj mq kl mr km ms ko mt kp mu mv bi translated">什么是系统表？</h1><p id="1a12" class="pw-post-body-paragraph li lj it lk b ll mw kd ln lo mx kg lq lr my lt lu lv mz lx ly lz na mb mc md im bi translated">每个 Microsoft SQL Server 最终用户数据库都包含几十个系统表，这些表由数据库的元数据(关于数据的数据)组成。例如，它存储有关数据库中定义的所有表、列、键、视图、存储过程和视图的数据。虽然您可以在<a class="ae lh" href="https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank">SQL Server Management Studio</a>(SSMS)中查看其中的一些内容，但是您可以编写 Transact-SQL 来查询从系统表中检索元数据的视图。</p><p id="2cbf" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">以下是存储在系统表中的几种元数据类型:</p><ul class=""><li id="871d" class="nb nc it lk b ll lm lo lp lr nd lv ne lz nf md ng nh ni nj bi translated">桌子</li><li id="3eee" class="nb nc it lk b ll nk lo nl lr nm lv nn lz no md ng nh ni nj bi translated">列</li><li id="90fa" class="nb nc it lk b ll nk lo nl lr nm lv nn lz no md ng nh ni nj bi translated">主键</li><li id="6d9b" class="nb nc it lk b ll nk lo nl lr nm lv nn lz no md ng nh ni nj bi translated">指数</li><li id="e384" class="nb nc it lk b ll nk lo nl lr nm lv nn lz no md ng nh ni nj bi translated">表关系(外键)</li><li id="c732" class="nb nc it lk b ll nk lo nl lr nm lv nn lz no md ng nh ni nj bi translated">视图</li><li id="8104" class="nb nc it lk b ll nk lo nl lr nm lv nn lz no md ng nh ni nj bi translated">存储过程</li></ul><p id="c83c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">有关系统表和视图的详细信息，请参见微软的<a class="ae lh" href="https://docs.microsoft.com/en-us/sql/relational-databases/system-tables/system-tables-transact-sql?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank">系统表页面</a>。此外，您可以滚动浏览可用的系统视图，如下面 AdventureWorks2019 数据库的 SSMS 屏幕截图所示。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi np"><img src="../Images/d03b745e6ad0e9ac407d7360bfde27bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nYCKhMsQkZNse9pFmHt7qQ.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">访问系统表的系统视图可以在 SSMS 中浏览。Randy Runtsch 在 SSMS 拍摄的快照。</p></figure><p id="eb94" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">要了解系统视图的结构，在 SSMS 中，单击其名称左侧的“+”号。然后，点击“+”号进入“栏目”为每一列显示名称、数据类型以及是否允许空值。下面的示例显示了“all_columns”视图中的列。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/c706e6f4fd2f3d6131011f46090d14cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*-axNgXQ0weq_U9hMRoCDVg.png"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">all_columns 视图中的列。Randy Runtsch 截图。</p></figure><h1 id="6021" class="me mf it bd mg mh mi mj mk ml mm mn mo ki mp kj mq kl mr km ms ko mt kp mu mv bi translated">查询系统表以了解最终用户表和列</h1><p id="0a5d" class="pw-post-body-paragraph li lj it lk b ll mw kd ln lo mx kg lq lr my lt lu lv mz lx ly lz na mb mc md im bi translated">逆向工程是关于学习事物是如何构造或工作的，不管文档是否可用。虽然每个 SQL Server 数据库都包含许多系统视图，但本教程将向您展示如何使用其中的几个视图来了解数据库中的最终用户表和列。我曾使用类似这里所示的查询对包含数百或数千行的数据库进行逆向工程。虽然这项工作需要几天或几周的时间，但这项技术使我能够使用数据库的数据来创建满足客户需求的数据分析解决方案。</p><p id="87b3" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">对于本教程，我使用了 SQL Server Express、SSSMS 和 AdventureWorks2019 示例数据库。下面显示的查询将适用于任何最新版本的 SQL Server 和任何 SQL Server 数据库。但是，如果您需要安装 SQL Server 和示例数据库，请查看以下链接:</p><ul class=""><li id="819b" class="nb nc it lk b ll lm lo lp lr nd lv ne lz nf md ng nh ni nj bi translated"><a class="ae lh" href="https://www.microsoft.com/en-us/Download/details.aspx?id=101064" rel="noopener ugc nofollow" target="_blank">在 Windows 上安装 SQL Server Express 2019 </a></li><li id="93a8" class="nb nc it lk b ll nk lo nl lr nm lv nn lz no md ng nh ni nj bi translated"><a class="ae lh" href="https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank">安装 SQL Server Management Studio</a>(SSMS)</li><li id="a9ba" class="nb nc it lk b ll nk lo nl lr nm lv nn lz no md ng nh ni nj bi translated">安装 SQL Server 或 SQL Server Express 和 SSMS 后，将<a class="ae lh" href="https://docs.microsoft.com/en-us/sql/samples/adventureworks-install-configure?view=sql-server-ver15&amp;tabs=ssms" rel="noopener ugc nofollow" target="_blank"> AdventureWorks2019.bak 文件</a>恢复到 SQL Server(此链接中提供了数据库恢复说明)</li></ul><h2 id="292b" class="nr mf it bd mg ns nt dn mk nu nv dp mo lr nw nx mq lv ny nz ms lz oa ob mu iz bi translated">查询最终用户表</h2><p id="c4cd" class="pw-post-body-paragraph li lj it lk b ll mw kd ln lo mx kg lq lr my lt lu lv mz lx ly lz na mb mc md im bi translated">下面的查询检索 SQL Server 数据库中定义的每个最终用户表的架构名、表名和行数。因为表是任何关系数据库的基本构建块，所以该查询返回的结果应该提供对数据库存储的数据类型的大致理解。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="oc od l"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">查询以获取 SQL Server 数据库中所有用户定义的表。兰迪·朗奇的代码。</p></figure><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/d64352143da7df4d107565a38f0a0cd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*7GldWcWShsf-CwchQCZO4Q.png"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">get_table.sql 查询的示例结果。Randy Runtsch 截图。</p></figure><h2 id="686a" class="nr mf it bd mg ns nt dn mk nu nv dp mo lr nw nx mq lv ny nz ms lz oa ob mu iz bi translated">查询最终用户列</h2><p id="14c5" class="pw-post-body-paragraph li lj it lk b ll mw kd ln lo mx kg lq lr my lt lu lv mz lx ly lz na mb mc md im bi translated">下面的查询检索 SQL Server 数据库的最终用户表中所有列的元数据。它比上面的表查询更复杂，因为它将 sys.columns 视图与其他四个视图连接起来以获得所需的列。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="oc od l"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">检索 SQL Server 数据库中所有最终用户列的查询。Randy Runtsch 的 SQL 代码。</p></figure><p id="2a7c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">虽然上面的查询按模式、表和列对结果进行了排序，但有时先按列对数据进行排序是有用的，如下面的屏幕截图所示。这允许您查看列在整个数据库中的使用位置。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi of"><img src="../Images/daa80f89f74800409020db3529d3722e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zQfWhe7C4mIw1gPqdWnumw.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">列名按列排序 Randy Runtsch 截图。</p></figure><h2 id="a91f" class="nr mf it bd mg ns nt dn mk nu nv dp mo lr nw nx mq lv ny nz ms lz oa ob mu iz bi translated">查询主键</h2><p id="da57" class="pw-post-body-paragraph li lj it lk b ll mw kd ln lo mx kg lq lr my lt lu lv mz lx ly lz na mb mc md im bi translated">另一种有助于理解关系数据库的元数据是每个表的主键。主键定义唯一标识表中某一行的列值或列值组合。下面的查询返回每个主键的名称，以及它所应用的表和列。列 ID 值指示列在多部分键的键中的顺序。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="oc od l"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">检索所有 SQL Server 最终用户表的主键的查询。兰迪·朗奇的代码。</p></figure><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi og"><img src="../Images/51f3acf5303af066660b9a67e341e8c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TOd1qbADjDmKtacKT3_Zig.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">get_pk.sql 查询的示例结果。Randy Runtsch 截图。</p></figure><h2 id="e86f" class="nr mf it bd mg ns nt dn mk nu nv dp mo lr nw nx mq lv ny nz ms lz oa ob mu iz bi translated">查询外键关系</h2><p id="cfd3" class="pw-post-body-paragraph li lj it lk b ll mw kd ln lo mx kg lq lr my lt lu lv mz lx ly lz na mb mc md im bi translated">从系统视图中查询表和列元数据可以很好地理解数据库中存储的数据和数据元素的类型。但是要获得关系数据库的知识，理解表之间的外键关系是必不可少的。以下查询返回定义父表和被引用表之间外键关系的列。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="oc od l"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">查询来检索所有外键关系。兰迪·朗奇的代码。</p></figure><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oh"><img src="../Images/9b13e913858ed186c58e3303e0363646.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dg4K6qtsaKzFRB2MzcvdhQ.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">get_fk_relationships.sql 查询的示例结果。Randy Runtsch 截图。</p></figure><h1 id="4bb1" class="me mf it bd mg mh mi mj mk ml mm mn mo ki mp kj mq kl mr km ms ko mt kp mu mv bi translated">后续步骤</h1><p id="8c51" class="pw-post-body-paragraph li lj it lk b ll mw kd ln lo mx kg lq lr my lt lu lv mz lx ly lz na mb mc md im bi translated">虽然对 SQL Server 数据库进行反向工程是一项耗时的艰苦工作，但有时这是很好地了解数据库的唯一方法。运行上面的查询应该可以提供对数据库的基本理解，除非其创建者对表和列进行了隐晦的命名或者省略了列定义。</p><p id="7bbb" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">一旦您很好地理解了数据库，您就可以通过对最终用户表运行 SELECT 查询来查看和理解它们存储的数据，从而获得更多的知识。然后，您可以使用您的新知识来很好地记录数据库，以支持您或其他数据分析师执行的数据分析项目。</p></div></div>    
</body>
</html>