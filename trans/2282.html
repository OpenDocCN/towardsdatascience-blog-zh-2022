<html>
<head>
<title>Code Validation and Testing Practices</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">代码验证和测试实践</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/code-validation-testing-practices-86a304fd3ca#2022-05-19">https://towardsdatascience.com/code-validation-testing-practices-86a304fd3ca#2022-05-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8b61" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">组合各种断言、if语句、pytest等</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/6384884ba9e6f2f77e141bfa3479b9fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0K0nUHlgkIVRld8P"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来自<a class="ae ky" href="https://www.pexels.com/ko-kr/photo/5473298/" rel="noopener ugc nofollow" target="_blank">像素</a>的免费使用照片</p></figure><h1 id="4e62" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">介绍</h1><p id="c6d4" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们编写的代码必须按照我们预期的方式运行。验证这一点的过程被称为“代码测试”或“代码验证”。包括Git在内的版本控制和协作工具促进了这一过程。Git不在本文讨论的范围之内，所以我将在其他时间讨论它。但是我想向您介绍一些关键的代码验证实践，它们可以帮助您保持您编写的代码和您处理的数据的良好质量。</p><h1 id="fefa" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">定义错误情况</h1><p id="4a36" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我个人认为定义潜在的错误来源和场景对代码验证至关重要。因此，记录整个生产流程中出现的错误并定期更新该列表非常重要。</p><h1 id="7a11" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">If语句和Assert语句</h1><p id="1559" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">一旦这个错误列表被充实，创建一个单独的测试/验证脚本(例如testing.py)。检查每个错误的If-Else语句在这种脚本中非常有用。</p><p id="65f3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">断言语句是涉及使用“断言”的语句，顾名思义，断言某个逻辑为真。如果该逻辑结果为假，它将停止正在运行的脚本或程序，并返回AssertionError。这使得调试和验证代码变得非常方便。</p><p id="8bf8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">看看下面这个简单的例子。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="c4ae" class="mx la it mt b gy my mz l na nb">number = 2<br/>assert number &gt; 0<br/><br/>number = -2<br/>assert number &gt; 0<br/>Traceback (most recent call last):<br/>    ...<br/>AssertionError</span></pre><p id="fb52" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">上面的代码验证名为“number”的变量是否是大于0的值。如果不是，则返回AssertionError。这种断言验证称为“比较断言”。从身份断言到成员断言，还有其他种类的断言可用(例如，检查某个元素是否是一个更大的组的一部分，比如list)。下面的代码是成员断言的一个示例。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="5a93" class="mx la it mt b gy my mz l na nb">numbers = [1, 2, 3, 4, 5]<br/>assert 1 in numbers<br/>assert 2 in numbers</span><span id="ccbc" class="mx la it mt b gy nc mz l na nb">assert 3 in numbers<br/> <br/>assert 6in numbers<br/>Traceback (most recent call last):<br/>    ...<br/>AssertionError</span></pre><h1 id="7a9a" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">使用__debug__</h1><p id="903d" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">使用调试模式是Python中的内置常量。它默认为True。它是一个“常量”,因为一旦Python解释器开始运行，它的值就不能改变。[1]</p><p id="670d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们如何利用这个变量呢？请看看下面这个例子。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="95af" class="mx la it mt b gy my mz l na nb">if __debug__:<br/>    if not &lt;some expression&gt;:<br/>        raise AssertionError(assertion_message)</span><span id="2c7f" class="mx la it mt b gy nc mz l na nb">## Source: <a class="ae ky" href="https://realpython.com/python-assert-statement/" rel="noopener ugc nofollow" target="_blank">https://realpython.com/python-assert-statement/</a></span></pre><p id="f3c4" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">上面的代码等效于下面使用assert的代码。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="c3e4" class="mx la it mt b gy my mz l na nb">assert &lt;some expression&gt;, assertion_message</span></pre><p id="7aba" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们如何使用这个__debug__变量类似于我们如何使用assert语句，但是一个主要的区别是__debug__为我们提供了在调试或非调试模式下运行脚本的灵活性。Python的python -o命令将__debug__变量设置为false，允许用户</p><h1 id="985b" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">Pytest</h1><p id="898d" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">Pytest是一个用于代码测试的Python库。它是一个框架，允许你使用上面的所有东西和许多其他东西来系统地测试你写的各种功能或代码。我将向您介绍一些有用的案例和Pytest应用程序示例。</p><h2 id="f3cc" class="mx la it bd lb nd ne dn lf nf ng dp lj ma nh ni ll me nj nk ln mi nl nm lp nn bi translated">装置</h2><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="a9b4" class="mx la it mt b gy my mz l na nb">pip install -U pytest</span></pre><h2 id="2513" class="mx la it bd lb nd ne dn lf nf ng dp lj ma nh ni ll me nj nk ln mi nl nm lp nn bi translated">示例1:验证一个函数</h2><p id="8481" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">假设我们想使用一些测试用例来验证您编写的名为“func”的函数是否按照您想要的方式工作。这里，测试用例将是func(3) == 5。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="2959" class="mx la it mt b gy my mz l na nb"><strong class="mt iu">def</strong> func(x):</span><span id="0c91" class="mx la it mt b gy nc mz l na nb"><strong class="mt iu">    return</strong> x + 1</span><span id="7553" class="mx la it mt b gy nc mz l na nb"><strong class="mt iu">def</strong> test_answer( ):</span><span id="4f09" class="mx la it mt b gy nc mz l na nb"><strong class="mt iu">    assert</strong> func(3) == 5</span></pre><p id="1c25" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们将该脚本命名为test.py，并在命令shell中运行以下内容:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="781c" class="mx la it mt b gy my mz l na nb">pytest test.py</span></pre><p id="35e4" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这是结果的样子。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="e9c2" class="mx la it mt b gy my mz l na nb">&gt;&gt;&gt;&gt; $ pytest</span><span id="ac5e" class="mx la it mt b gy nc mz l na nb"><strong class="mt iu">=========================== test session starts ============================</strong></span><span id="0067" class="mx la it mt b gy nc mz l na nb">platform linux -- Python 3.x.y, pytest-6.x.y, py-1.x.y, pluggy-0.x.y</span><span id="73ec" class="mx la it mt b gy nc mz l na nb">cachedir: $PYTHON_PREFIX/.pytest_cache</span><span id="44d3" class="mx la it mt b gy nc mz l na nb">rootdir: $REGENDOC_TMPDIR</span><span id="44f2" class="mx la it mt b gy nc mz l na nb">collected 1 item</span><span id="903b" class="mx la it mt b gy nc mz l na nb">test_sample.py F                                                     [100%]</span><span id="5cee" class="mx la it mt b gy nc mz l na nb">================================= FAILURES =================================</span><span id="7340" class="mx la it mt b gy nc mz l na nb"><strong class="mt iu">_______________________________ test_answer ________________________________</strong></span><span id="b710" class="mx la it mt b gy nc mz l na nb">def test_answer():</span><span id="d023" class="mx la it mt b gy nc mz l na nb">&gt;       assert func(3) == 5</span><span id="7a9f" class="mx la it mt b gy nc mz l na nb"><strong class="mt iu">E       assert 4 == 5</strong></span><span id="938f" class="mx la it mt b gy nc mz l na nb"><strong class="mt iu">E        +  where 4 = func(3)</strong></span><span id="6c4d" class="mx la it mt b gy nc mz l na nb"><strong class="mt iu">test.py</strong>:6: AssertionError</span><span id="4ddf" class="mx la it mt b gy nc mz l na nb">========================= short test summary info ==========================</span><span id="e306" class="mx la it mt b gy nc mz l na nb">FAILED test_sample.py::test_answer - assert 4 == 5</span><span id="4b09" class="mx la it mt b gy nc mz l na nb">============================ <strong class="mt iu">1 failed</strong> in 0.12s =============================</span></pre><p id="f8a6" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">引发AssertionError是因为func(3)返回4，但我们断言它是5。这很好，因为我们知道func正在以我们想要的方式工作。</p><h2 id="0d48" class="mx la it bd lb nd ne dn lf nf ng dp lj ma nh ni ll me nj nk ln mi nl nm lp nn bi translated">示例2:验证执行更复杂任务的函数</h2><p id="f06b" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">Pytest还可以用来验证执行更复杂任务的函数或部分脚本，比如从文本中提取情感。你只需要定义一个函数的预期行为和非预期行为。看看这个来自<a class="ae ky" rel="noopener" target="_blank" href="/pytest-for-data-scientists-2990319e55e6">教程</a>的例子，使用Textblob，一个流行的用于情感提取的NLP库。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="c2c8" class="mx la it mt b gy my mz l na nb"><strong class="mt iu">## sentiment.py<br/>### From </strong><a class="ae ky" rel="noopener" target="_blank" href="/pytest-for-data-scientists-2990319e55e6">https://towardsdatascience.com/pytest-for-data-scientists-### 2990319e55e6</a></span><span id="8deb" class="mx la it mt b gy nc mz l na nb"><strong class="mt iu">from </strong>textblob <strong class="mt iu">import </strong>TextBlob</span><span id="5a69" class="mx la it mt b gy nc mz l na nb"><strong class="mt iu">def </strong>extract_sentiment(text: str):</span><span id="fd8c" class="mx la it mt b gy nc mz l na nb">    '''Extract sentiment using textblob.</span><span id="a99e" class="mx la it mt b gy nc mz l na nb">    Polarity is within range [-1, 1]'''</span><span id="0b0d" class="mx la it mt b gy nc mz l na nb">    text = TextBlob(text)</span><span id="89f2" class="mx la it mt b gy nc mz l na nb">    return text.sentiment.polarity</span><span id="b741" class="mx la it mt b gy nc mz l na nb"><strong class="mt iu"><br/>def</strong> test_extract_sentiment( ):</span><span id="658d" class="mx la it mt b gy nc mz l na nb">    text = “I think today will be a great day”</span><span id="31bb" class="mx la it mt b gy nc mz l na nb">    sentiment = extract_sentiment(text)</span><span id="8808" class="mx la it mt b gy nc mz l na nb">    assert sentiment &gt; 0</span></pre><p id="05e4" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在测试用例中，我们将<code class="fe no np nq mt b">extract_sentiment</code>函数应用于一个示例文本:“我认为今天将是伟大的一天”。我们认为该语句包含积极情绪，因此我们将assert语句设计为<code class="fe no np nq mt b">assert sentiment &gt; 0</code>。</p><p id="7fd5" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">奔跑</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="9e07" class="mx la it mt b gy my mz l na nb">pytest sentiment.py</span></pre><p id="d1fc" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们得到了</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="ca76" class="mx la it mt b gy my mz l na nb">&gt;&gt; ========================================= test session starts ==========================================<br/><br/>platform linux -- Python 3.8.3, pytest-5.4.2, py-1.8.1, pluggy-0.13.1collected 1 itemprocess.py .                                                                                     [100%]========================================== 1 passed in 0.68s ===========================================</span></pre><p id="88b4" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">测试通过了，没有出现任何错误！</p><h2 id="d8dc" class="mx la it bd lb nd ne dn lf nf ng dp lj ma nh ni ll me nj nk ln mi nl nm lp nn bi translated">将多个测试分组到一个类中</h2><p id="cac8" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">您还可以使用类在Pytest中执行多个测试。您可以在一个类中捆绑多个测试，如下所示:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="e6d5" class="mx la it mt b gy my mz l na nb"><strong class="mt iu">class</strong> <strong class="mt iu">TestClass</strong>:</span><span id="882b" class="mx la it mt b gy nc mz l na nb"><strong class="mt iu">    def</strong> first_test(self):</span><span id="746f" class="mx la it mt b gy nc mz l na nb">        [ some test ]</span><span id="c3a2" class="mx la it mt b gy nc mz l na nb"><strong class="mt iu">    def</strong> second_test(self):</span><span id="9021" class="mx la it mt b gy nc mz l na nb">        [ some test ]</span></pre><p id="05b8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果其中一个测试未能通过，您将在类似于以下内容的输出消息中得到通知:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="e4d7" class="mx la it mt b gy my mz l na nb">..................</span><span id="cee3" class="mx la it mt b gy nc mz l na nb">...................<br/>========================= short test summary info ==========================</span><span id="629d" class="mx la it mt b gy nc mz l na nb">FAILED test_class.py::TestClass::second_test- AssertionError: assert False</span><span id="3642" class="mx la it mt b gy nc mz l na nb"><strong class="mt iu">1 failed</strong>, 1 passed in 0.56s</span></pre><h1 id="cdb5" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">JSON模式验证</h1><p id="47e4" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">JSON代表<strong class="lt iu">J</strong>ava<strong class="lt iu">S</strong>script<strong class="lt iu">O</strong>object<strong class="lt iu">N</strong>rotation。它是一种基于文本的标准格式，使用JavaScript对象语法表示结构化数据，因此得名于JavaScript。该结构看起来类似于Python中的嵌套字典。</p><p id="6c87" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">JSON文件中最常见的错误之一是模式或格式问题不一致。jsonschema库允许我们轻松地验证JSON文件模式。</p><p id="c8a8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">验证JSON模式可以简单到两行，如下所示。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="9809" class="mx la it mt b gy my mz l na nb"><strong class="mt iu">from </strong>jsonschema <strong class="mt iu">import </strong>validate</span><span id="6f8c" class="mx la it mt b gy nc mz l na nb">validate(instance=[some json], schema=[define schema])</span></pre><p id="801f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">让我们看一个更具体的例子。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="6875" class="mx la it mt b gy my mz l na nb"><strong class="mt iu">from </strong>jsonschema <strong class="mt iu">import </strong>validate</span><span id="f429" class="mx la it mt b gy nc mz l na nb"><strong class="mt iu"># Define Schema</strong><br/>schema = {<br/>"type" : "object",<br/>"properties" :{<br/>"name" : {"type": "string"}<br/>"height" : {"type" : "number"},<br/>"gender" : {"type" : "string"}, <br/>"ethnicity": {"type" : "string"},<br/>"age": {"type": "number"},<br/>}</span></pre><p id="932e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如上定义模式后，您可以在某个测试实例上运行validate函数。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="c1ce" class="mx la it mt b gy my mz l na nb">validate(instance={"name" : "Josh", "gender" : "Male"}, schema=schema)</span></pre><p id="e957" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果实例与模式定义一致，那么validate函数将运行，不会出现任何问题或错误消息。</p><p id="b266" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">对以下实例运行validate确实会返回一条错误消息，因为age字段被定义为包含一个数值，但该实例却包含一个字符串。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="64c7" class="mx la it mt b gy my mz l na nb">validate(<br/>instance={"name" : "Josh", "gender" : "Male", "ethnicity": "Asian", "age": "idk"}, schema=schema,<br/>)</span><span id="7db5" class="mx la it mt b gy nc mz l na nb">&gt;&gt;&gt; <br/>Traceback (most recent call last):<br/> …<br/>ValidationError: ‘idk’ is not of type ‘number’</span></pre><h1 id="2ffd" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">关于作者</h1><p id="85a0" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated"><em class="nr">数据科学家。在密歇根大学刑事司法行政记录系统(CJARS)经济学实验室担任副研究员。Spotify前数据科学实习生。Inc .(纽约市)。即将入学的信息学博士生。他喜欢运动，健身，烹饪美味的亚洲食物，看kdramas和制作/表演音乐，最重要的是崇拜耶稣基督。结账他的</em> <a class="ae ky" href="http://seungjun-data-science.github.io" rel="noopener ugc nofollow" target="_blank"> <em class="nr">网站</em> </a> <em class="nr">！</em></p><h1 id="063d" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">参考</h1><p id="1deb" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">[1] Python-Assert-Statements，真正的Python，<a class="ae ky" href="https://realpython.com/python-assert-statement/" rel="noopener ugc nofollow" target="_blank">https://realpython.com/python-assert-statement/</a></p><p id="08c6" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">[2] K. Tran，面向数据科学的数据科学家Pytest，<a class="ae ky" rel="noopener" target="_blank" href="/pytest-for-data-scientists-2990319e55e6">https://towardsdatascience . com/Pytest-for-Data-Scientists-2990319 e55e 6</a></p><p id="f8e4" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">[3] S. Biham，How to Validate Your JSON Using JSON Schema，Towards Data Science，<a class="ae ky" rel="noopener" target="_blank" href="/how-to-validate-your-json-using-json-schema-f55f4b162dce">https://Towards Data Science . com/How-to-Validate-Your-JSON-Using-JSON-Schema-f55 F4 b 162 DCE</a></p></div></div>    
</body>
</html>