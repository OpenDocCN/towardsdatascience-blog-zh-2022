<html>
<head>
<title>BigQuery SQL Functions For Data Cleaning</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于数据清理的BigQuery SQL函数</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/bigquery-functions-for-data-cleaning-4b96181fbc3#2022-09-23">https://towardsdatascience.com/bigquery-functions-for-data-cleaning-4b96181fbc3#2022-09-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3fca" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">要应用的用例及功能</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b974042017e49f24c743f39c5e9012fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nd5i1wSFa_EyfWNTpyD_Tw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自<a class="ae ky" href="https://pixabay.com/users/roszie-6000120/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=7459066" rel="noopener ugc nofollow" target="_blank">Rosy——世界值成千上万张图片</a>来自<a class="ae ky" href="https://pixabay.com//?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=7459066" rel="noopener ugc nofollow" target="_blank"> Pixabay </a></p></figure><p id="d989" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">无论您是数据工程师、数据科学家还是数据分析师，数据清理都是任何数据相关职位的重要组成部分。今天，我想分享几个用于数据清理的BigQuery SQL函数，以及我会使用它们的一个用例。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="e26f" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">字符串值中不可见的特殊字符</h2><p id="d8e6" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">字符串值可以包含不显示在屏幕上但存储在数据库中的特殊字符。当我在一个字符串字段上应用where子句导致找到0条记录时，我经历了惨痛的教训。这非常令人沮丧，在应用where子句返回我知道存在的记录之前，我必须找到函数来公开<a class="ae ky" href="https://unicode.org/standard/WhatIsUnicode.html" rel="noopener ugc nofollow" target="_blank"> unicode </a>值，以便将它们从字符串中移除。</p><p id="83b0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">BigQuery有一个<a class="ae ky" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/string_functions#normalize" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu"> NORMALIZE </strong> </a>函数来处理这个场景。下面是Jane和Smith之间unicode值的3条记录，它们在查询结果中不可见。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi na"><img src="../Images/d3f4b27f54d88fa012c3ec526be9ef29.png" data-original-src="https://miro.medium.com/v2/resize:fit:718/1*JCjR81TjlX-zT4c4aRC70A.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者创建的屏幕截图示例</p></figure><p id="1b19" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我对<strong class="lb iu"> <em class="nb">、简·史密斯</em> </strong>使用where子句，则不会返回任何记录。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/abf2c8c48b90ca3ad8892371218d89c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:786/1*7sI8MBmYxLjT2vyfuPslmQ.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者创建的屏幕截图示例</p></figure><p id="949e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，如果我对name字段使用<strong class="lb iu"> NORMALIZE </strong>函数，unicode值将被删除，查询结果中将返回三个简·史密斯记录。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/4c4d00f3a8eaff4491901adefe89a189.png" data-original-src="https://miro.medium.com/v2/resize:fit:834/1*aKaspqlrf4lYxbDAFLvcpA.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用作者创建的规格化函数的屏幕截图示例</p></figure><p id="7bf5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> <em class="nb">特别提示</em> </strong>:如果您希望字符串比较不区分大小写，即在查询结果中返回包含简·史密斯或简·史密斯的记录，BigQuery还有一个<a class="ae ky" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/string_functions#normalize_and_casefold" rel="noopener ugc nofollow" target="_blank"> NORMALIZE_AND_CASEFOLD </a>函数。</p><h2 id="a682" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">模式匹配</h2><p id="2508" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">我一直使用<a class="ae ky" href="https://www.w3schools.com/sql/sql_like.asp" rel="noopener ugc nofollow" target="_blank"> LIKE </a>操作符在字符串字段中进行模式匹配。最近，我不得不将网站访问者的<a class="ae ky" href="https://support.google.com/google-ads/answer/2382957?hl=en" rel="noopener ugc nofollow" target="_blank">引用URL</a>进行分类，以匹配<a class="ae ky" href="https://www.jellyfish.com/en-us/training/blog/google-analytics-channels-explained" rel="noopener ugc nofollow" target="_blank">谷歌分析频道报告</a>。因为我不知道URL是大写还是小写，所以在检查模式匹配之前，我必须使用LOWER函数将字段全部转换为小写。</p><p id="d620" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">BigQuery有一个针对这种情况的<a class="ae ky" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/string_functions#contains_substr" rel="noopener ugc nofollow" target="_blank"> CONTAINS_SUBSTR </a>函数。CONTAINS_SUBSTR不仅执行不区分大小写的模式检查，还可以检查数字字段、时间戳和数组中的模式值。</p><p id="b1a8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在下面的例子中，我检查了<strong class="lb iu"> <em class="nb">早餐</em> </strong>字段是否包含全部小写的字符串<strong class="lb iu"> <em class="nb">煎饼</em> </strong>。尽管每条记录在<strong class="lb iu"> <em class="nb">煎饼</em> </strong>中有一个大写字母，但在查询结果中会返回这两行。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/75ee44bfba958bfda70b56e547813f6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1010/1*nEa2JbGR1UloRUwLZ32g1Q.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用作者创建的CONTAINS_SUBSTR函数的屏幕截图示例</p></figure><p id="a025" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> <em class="nb">特别提到</em> </strong> : BigQuery还有一个<a class="ae ky" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/string_functions#ends_with" rel="noopener ugc nofollow" target="_blank"> ENDS_WITH </a>函数，用来检查一个字符串是否以模式结尾。我可以使用它的一个常见用例是检查电子邮件是否以。edu确认用户是学生。</p><h2 id="ee0c" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">日期格式</h2><p id="067e" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">过去，我总是将SQL中的查询结果下载到Excel中，以便为报告目的设置日期格式，因为我无法使用SQL以我需要的方式设置日期格式。当我有大量数据要格式化时，这非常耗时。</p><p id="82a5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">BigQuery有一个<a class="ae ky" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/date_functions#format_date" rel="noopener ugc nofollow" target="_blank"> FORMAT_DATE </a>函数来处理日期格式化。在下面的示例中，2022年9月30日基于<a class="ae ky" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/format-elements#format_elements_date_time" rel="noopener ugc nofollow" target="_blank">格式字符串</a>以三种不同的方式进行格式化。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/fe386b40f57f58f44a46e2cc6c813e6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*EWcgm3HWDmgdum5YwUCGNQ.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用作者创建的FORMAT_DATE函数的屏幕截图示例</p></figure><p id="adab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> <em class="nb">特别说明</em> </strong>:除了FORMAT_DATE，还可以使用<a class="ae ky" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators#format_datetime" rel="noopener ugc nofollow" target="_blank"> FORMAT_DATETIME </a>来格式化日期时间值。还有一个<a class="ae ky" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/string_functions#format_string" rel="noopener ugc nofollow" target="_blank"> FORMAT </a>函数将字段格式化为字符串值。这个函数的一个用例是用逗号分隔符格式化大数。您可以使用FORMAT函数在查询结果中显示1，000，000，而不是1000000。</p><h2 id="a420" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">除以一个零分母</h2><p id="d6b8" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">我经常不得不计算分母可能为0的百分比，这将在除以0时返回SQL错误。一种选择是使用CASE语句在除法之前检查分母是否为0，以避免错误，但是大多数数据库都有处理这种情况的函数。</p><p id="172b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在BigQuery的例子中，这个函数被称为<a class="ae ky" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/mathematical_functions#safe_divide" rel="noopener ugc nofollow" target="_blank"> SAFE_DIVIDE </a>。在下面的例子中，我将10除以0，得到一个<strong class="lb iu"> <em class="nb">除以零</em> </strong>的错误。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/c3325008ed2521ee25ec7f16cc97aa79.png" data-original-src="https://miro.medium.com/v2/resize:fit:610/1*fr1kVcAvbfVDE1q1s50qXQ.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者创建的使用除法错误示例的屏幕截图示例</p></figure><p id="334e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我使用SAFE_DIVIDE之后，结果是一个空值，而不是一个错误。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/bf2f45aa9100e8bb9b058b83f15e0d27.png" data-original-src="https://miro.medium.com/v2/resize:fit:698/1*e1PSL1z3yqw8rRcdGwKXtA.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者创建的使用SAFE_DIVIDE示例的屏幕截图示例</p></figure><p id="1860" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> <em class="nb">特别提示</em> </strong> : BigQuery还有SAFE_ADD、SAFE_SUBTRACT、SAFE_MULTIPLY、SAFE_NEGATE函数，如果发生溢出，这些函数将返回空值。</p><h2 id="293a" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated"><strong class="ak"> <em class="ni">最后的想法</em> </strong></h2><p id="f71c" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">虽然我们永远无法摆脱数据清理，但SQL函数可以提供帮助。我希望你学到了一两个将来有用的新功能。虽然我提到的函数在BigQuery中，但它们也可能在您的数据库中可用。</p><p id="ee05" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nb">注意:以上所有的查询都是在</em> <a class="ae ky" href="https://cloud.google.com/bigquery/docs/sandbox" rel="noopener ugc nofollow" target="_blank"> <em class="nb"> BigQuery沙箱</em> </a> <em class="nb">上运行的，这对任何拥有谷歌账户的人来说都是免费的。</em></p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="3bc0" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">你可能也会喜欢…</h2><div class="nj nk gp gr nl nm"><a rel="noopener follow" target="_blank" href="/6-bigquery-sql-functions-every-user-should-know-9ed97b1cf72e"><div class="nn ab fo"><div class="no ab np cl cj nq"><h2 class="bd iu gy z fp nr fr fs ns fu fw is bi translated">每个用户都应该知道的6个大查询SQL函数</h2><div class="nt l"><h3 class="bd b gy z fp nr fr fs ns fu fw dk translated">检查您的数据库是否也有它们</h3></div><div class="nu l"><p class="bd b dl z fp nr fr fs ns fu fw dk translated">towardsdatascience.com</p></div></div><div class="nv l"><div class="nw l nx ny nz nv oa ks nm"/></div></div></a></div><div class="nj nk gp gr nl nm"><a rel="noopener follow" target="_blank" href="/4-bigquery-sql-shortcuts-that-can-simplify-your-queries-30f94666a046"><div class="nn ab fo"><div class="no ab np cl cj nq"><h2 class="bd iu gy z fp nr fr fs ns fu fw is bi translated">4个可以简化查询的BigQuery SQL快捷方式</h2><div class="nt l"><h3 class="bd b gy z fp nr fr fs ns fu fw dk translated">检查您的数据库是否也有它们</h3></div><div class="nu l"><p class="bd b dl z fp nr fr fs ns fu fw dk translated">towardsdatascience.com</p></div></div><div class="nv l"><div class="ob l nx ny nz nv oa ks nm"/></div></div></a></div><div class="nj nk gp gr nl nm"><a rel="noopener follow" target="_blank" href="/how-data-scientists-can-reduce-data-wrangling-time-with-a-data-mart-809eefbe0bc2"><div class="nn ab fo"><div class="no ab np cl cj nq"><h2 class="bd iu gy z fp nr fr fs ns fu fw is bi translated">数据科学家如何通过数据集市减少数据争论的时间</h2><div class="nt l"><h3 class="bd b gy z fp nr fr fs ns fu fw dk translated">什么是数据集市，为什么数据科学家应该使用数据集市</h3></div><div class="nu l"><p class="bd b dl z fp nr fr fs ns fu fw dk translated">towardsdatascience.com</p></div></div><div class="nv l"><div class="oc l nx ny nz nv oa ks nm"/></div></div></a></div></div></div>    
</body>
</html>