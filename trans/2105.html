<html>
<head>
<title>Three things you need to know when using Variables in DAX</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在DAX中使用变量时，你需要知道三件事</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/three-things-you-need-to-know-when-using-variables-in-dax-c67724862b57#2022-05-11">https://towardsdatascience.com/three-things-you-need-to-know-when-using-variables-in-dax-c67724862b57#2022-05-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ee54" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在DAX中，变量可以被长期使用来简化代码，有时还可以提高性能。以下是你需要知道的关于DAX变量的内容。</h2></div><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/51612ca2a5722f7f1c0f48743a3517a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YX4Z43QS-TQNQJpj"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">由<a class="ae kz" href="https://unsplash.com/@robowunderkind?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">机器人神童</a>在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="31a7" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">DAX中的变量是什么</h1><p id="32dc" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">如果您已经知道如何在DAX代码中使用变量，请继续学习。这部分是给初学者的。</p><p id="5b7a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">变量可以在任何DAX代码中长期用于Power BI和SQL Server Analysis Services。</p><p id="f50d" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我们可以使用变量来存储中间结果。</p><p id="c668" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">使用以下语法定义变量:</p><pre class="kk kl km kn gt mt mu mv mw aw mx bi"><span id="200b" class="my lb it mu b gy mz na l nb nc">VAR VarName = &lt;Value&gt;</span></pre><p id="27d3" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">您不需要在DAX中指定数据类型，因为数据类型是自动分配的。</p><p id="a392" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">你甚至不需要事先声明一个变量。当你要给一个变量赋值的时候，你就已经创建了一个变量。</p><p id="c3f7" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">一旦创建了变量，就必须将RETURN子句添加到DAX代码中以返回值。</p><p id="aa21" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">例如，我想用名为Var1的变量执行一个查询，将它的值设置为100并返回这个值:</p><pre class="kk kl km kn gt mt mu mv mw aw mx bi"><span id="d399" class="my lb it mu b gy mz na l nb nc">EVALUATE<br/> VAR Var1 = 100<br/><br/>RETURN<br/> {Var1}</span></pre><p id="dfb5" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我需要添加花括号来将变量转换成一个一列一行的表格。</p><p id="4194" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">那么，我们能对变量做些什么呢？</p><h1 id="c59e" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">我们可以分配比标量值更多的值</h1><p id="d027" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">我们可以像任何其他编程语言一样，在DAX中为变量赋值一个标量值。</p><p id="83b3" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">变量的创建看起来像这样:</p><pre class="kk kl km kn gt mt mu mv mw aw mx bi"><span id="8d06" class="my lb it mu b gy mz na l nb nc">VAR Var1 = 100</span></pre><p id="721a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">这一行创建了一个名为Var1的变量，并将值100赋给它。</p><p id="fb21" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">此外，我们可以调用DAX测量，并将测量结果赋给变量:</p><pre class="kk kl km kn gt mt mu mv mw aw mx bi"><span id="7b2b" class="my lb it mu b gy mz na l nb nc">VAR SalesAmount = [Sum of Sales Amount</span></pre><p id="9d74" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">然后在度量的筛选器上下文中评估该度量。</p><p id="8510" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">但是我们可以做得更多。</p><p id="1570" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我们可以将整个表添加到一个变量中，并在下面的表达式中使用该变量。</p><p id="c675" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">例如，我想创建一个过去45天的日期列表，并计算这些天的销售额:</p><pre class="kk kl km kn gt mt mu mv mw aw mx bi"><span id="7fa9" class="my lb it mu b gy mz na l nb nc">DEFINE MEASURE ‘All Measures’[SalesLast45Days] =<br/> VAR Last45Days = DATESINPERIOD(‘Date’[Date], MIN(‘Date’[Date]), -45, DAY)<br/> <br/> RETURN<br/>     CALCULATE([Online Sales (By Order Date)]<br/>               ,Last45Days<br/>               )<br/> <br/> EVALUATE<br/>    ADDCOLUMNS(<br/>        SUMMARIZE(‘Date’<br/>               ,’Date’[EnglishYearMonthShortName])<br/>               ,”Sales”, [Online Sales (By Order Date)]<br/>               ,”SalesLast45Days”, ‘All Measures’[SalesLast45Days]<br/>               )</span></pre><p id="78a3" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我在DAX Studio的查询中动态地创建了一个度量“All Measures”[sales last 45 days]。</p><p id="5aa0" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">使用DATESINPERIOD()，我生成一个日期列表，从查询的过滤器上下文中的第一天开始，到45天之前。然后将这个列表赋给变量Last45Days。</p><p id="3c60" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在返回之后，我在CALCULATE()函数中使用这个表作为过滤器。</p><p id="f9f1" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">结果如下图所示:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nd"><img src="../Images/c7d52a26020a7c7fc17b5b1765590554.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h94lWmEDUjJKSBuilr04RA.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图1 —查询过去45天的销售额和结果(图由作者提供)</p></figure><p id="6f57" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">听起来很酷？</p><h1 id="af36" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">一个变量只计算一次</h1><p id="6ff9" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">使用变量时，变量只计算一次，变量中的值可以在表达式中多次使用。</p><p id="c3e5" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">查看以下代码，以百分比形式计算年销售额(YoY)的变化:</p><pre class="kk kl km kn gt mt mu mv mw aw mx bi"><span id="5c3f" class="my lb it mu b gy mz na l nb nc">[YoY %] =<br/> VAR Sales = [Online Sales (By Order Date)]<br/> <br/> VAR SalesPY = CALCULATE([Online Sales (By Order Date)]<br/> ,SAMEPERIODLASTYEAR(‘Date’[Date])<br/> )<br/> <br/>RETURN<br/>    DIVIDE(Sales — SalesPY, Sales)</span></pre><p id="8aa5" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">如您所见，Sales变量可以在DIVIDE()函数中重用两次。</p><p id="0ac6" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">这意味着分配给Sales变量的度量结果只计算一次。</p><p id="34d1" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">这项措施的结果如下:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/04957ac1ef215bcf9d264254a853b030.png" data-original-src="https://miro.medium.com/v2/resize:fit:1190/format:webp/1*LcquUeS-a_2Rr3SBSi6Szw.png"/></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图2 —用YoY %度量值进行查询(作者提供的数据)</p></figure><p id="4037" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">度量中变量的这种可重用性可以显著提高性能。</p><h1 id="2156" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">一个变量只计算一次(又一次？)</h1><p id="304e" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">您可能已经注意到了上面代码中的一个小细节。</p><p id="010c" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">当我可以重用一个变量时，为什么我不这样写这个度量呢？</p><pre class="kk kl km kn gt mt mu mv mw aw mx bi"><span id="b84b" class="my lb it mu b gy mz na l nb nc">[YoY %] =<br/>VAR Sales = [Online Sales (By Order Date)]<br/> <br/>VAR SalesPY = CALCULATE(Sales<br/> ,SAMEPERIODLASTYEAR(‘Date’[Date])<br/> )<br/> <br/>RETURN<br/>    DIVIDE(Sales — SalesPY, Sales)</span></pre><p id="0672" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">这一次，我在CALCULATE()函数中使用了Sales变量。</p><p id="f3c7" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">可惜这不管用。</p><p id="26b4" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">以上带有变体的查询结果如下所示:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nf"><img src="../Images/25f2702fe4af8d3fa58bfd02d06e1a06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*76Db7cB6hKlZqyK0NG87EQ.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图3 —使用错误的年同比百分比度量进行查询(由作者提供)</p></figure><p id="171c" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">当我更改度量的代码以返回CALCULATE()函数的结果时，我们可以找到原因:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/2003fc4df19fdf498d4e92869f8cc6c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1112/format:webp/1*V8DHHESA6CAvnb-vK-UqZw.png"/></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图4——销售变量可以在计算中重用的原因(由作者提供)</p></figure><p id="f322" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">您可以看到CALCULATE()函数的结果与原始销售度量值相同。</p><p id="8d0d" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">原因是分配给变量的值已经被评估，并且过滤器上下文丢失。所以，计算并不影响结果。</p><p id="ed71" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">当使用变量来理解DAX代码的结果时，您必须始终考虑过滤器上下文。如果你不去做，你会得到意想不到的结果。</p><h1 id="f069" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">结论</h1><p id="5e15" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">变量是DAX工具箱的重要组成部分，我建议使用它们来简化DAX代码。</p><p id="71de" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">当我在DAX中开发复杂的计算时，我总是使用变量来获得中间结果。使用这种方法，我可以交叉检查每一步并验证结果。</p><p id="a060" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在DAX中使用变量的另一个好处是，您可以避免创建中间度量，因为您可以在一个度量中完成所有这些。</p><p id="014f" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">谢谢你一直读到最后。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nh"><img src="../Images/8545490b3a0bea5bbc3f25b842a97a69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SniYrcx9_e5MO5Wl"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">山姆·克拉克在Unsplash<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">上的照片</a></p></figure><h1 id="38b6" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">参考</h1><p id="da7d" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">我使用Contoso样本数据集，就像我以前的文章一样。你可以从微软<a class="ae kz" href="https://www.microsoft.com/en-us/download/details.aspx?id=18279" rel="noopener ugc nofollow" target="_blank">这里</a>免费下载ContosoRetailDW数据集。</p><p id="5653" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">Contoso数据可以在MIT许可下自由使用，如这里的<a class="ae kz" href="https://github.com/microsoft/Power-BI-Embedded-Contoso-Sales-Demo" rel="noopener ugc nofollow" target="_blank">所述</a>。</p><div class="ni nj gp gr nk nl"><a href="https://medium.com/@salvatorecagliari/membership" rel="noopener follow" target="_blank"><div class="nm ab fo"><div class="nn ab no cl cj np"><h2 class="bd iu gy z fp nq fr fs nr fu fw is bi translated">通过我的推荐链接加入Medium-Salvatore Cagliari</h2><div class="ns l"><h3 class="bd b gy z fp nq fr fs nr fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="nt l"><p class="bd b dl z fp nq fr fs nr fu fw dk translated">medium.com</p></div></div><div class="nu l"><div class="nv l nw nx ny nu nz kt nl"/></div></div></a></div></div></div>    
</body>
</html>