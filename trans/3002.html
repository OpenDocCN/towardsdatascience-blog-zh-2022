<html>
<head>
<title>How to prevent data exfiltration from Azure Databricks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何防止Azure数据块的数据泄露</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-prevent-data-exfiltration-from-azure-databricks-c1c55df5c9f2#2022-06-30">https://towardsdatascience.com/how-to-prevent-data-exfiltration-from-azure-databricks-c1c55df5c9f2#2022-06-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d0d4" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用数据块审计日志、日志分析和Azure Monitor</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/4c4d4d81452f27de276d781db4ac1612.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8lTTPbDX3loZUyIWg4J5Jg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">检测数据泄露—图片由<a class="ae ky" href="https://unsplash.com/@ikukevk" rel="noopener ugc nofollow" target="_blank">凯文·Ku在Unsplash </a>上提供</p></figure><h1 id="1674" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">1.介绍</h1><p id="1651" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">Azure Databricks是企业做数据科学的热门工具。但是，应防止使用数据块来泄漏数据。为此，将为Azure Databricks实施一个<a class="ae ky" href="https://docs.microsoft.com/en-us/security/benchmark/azure/baselines/databricks-security-baseline" rel="noopener ugc nofollow" target="_blank">安全基线</a>。<a class="ae ky" href="https://databricks.com/blog/2020/03/27/data-exfiltration-protection-with-azure-databricks.html" rel="noopener ugc nofollow" target="_blank">网络架构</a>使用<a class="ae ky" href="https://docs.microsoft.com/en-us/azure/databricks/administration-guide/cloud-configurations/azure/vnet-inject" rel="noopener ugc nofollow" target="_blank"> VNET注入、</a> <a class="ae ky" href="https://docs.microsoft.com/en-us/azure/databricks/security/secure-cluster-connectivity" rel="noopener ugc nofollow" target="_blank">安全集群连接</a>和<a class="ae ky" href="https://docs.microsoft.com/en-us/azure/databricks/administration-guide/access-control/conditional-access#enable-conditional-access-for-azure-databricks" rel="noopener ugc nofollow" target="_blank"> Azure AD条件接收</a>都是实现深度防御的关键。</p><p id="b015" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">安全基线的一部分还包括启用审计日志记录。在这篇blogpost和git repo <code class="fe ms mt mu mv b"><a class="ae ky" href="https://github.com/rebremer/azure-monitor-detect-exfiltration-databricks" rel="noopener ugc nofollow" target="_blank">azure-monitor-detect-exfiltration-databricks</a></code>中，讨论了如何使用<a class="ae ky" href="https://docs.microsoft.com/en-us/azure/databricks/administration-guide/account-settings/azure-diagnostic-logs#--configure-verbose-audit-logs" rel="noopener ugc nofollow" target="_blank"> Databricks audit logging </a>、Log Analytics工作区中的kusto和Azure Monitor中的警报规则来防止数据泄露。基本原理如下:</p><ul class=""><li id="bb9f" class="mw mx it lt b lu mn lx mo ma my me mz mi na mm nb nc nd ne bi translated">尽管审计日志本身不能保护公司数据失窃，但它可以用来对数据泄漏进行警报和取证。这可以再次用于<em class="nf">阻止</em>员工窃取数据(“我们会找到你”)</li><li id="375f" class="mw mx it lt b lu ng lx nh ma ni me nj mi nk mm nb nc nd ne bi translated">详细审核日志的设置简单且成本低廉，没有能力设置所有深度防御措施的小型公司也可以使用。</li></ul><p id="3bb7" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">另请参见下面的架构。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/a3d5535199223473dcf2c8c345e6fe27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mpoxh6mzDqr01FNP_NCMkg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">1.Azure Databricks审计日志记录检测泄漏-作者图片</p></figure><p id="3503" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在这篇博文的剩余部分，我们将更详细地解释数据泄漏检测。在第2章中，部署了资源并创建了一个简单的警报。在第3章中，我们将更详细地讨论kusto脚本，并使用Azure CLI进行部署。</p><h1 id="23ab" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">2.设置数据块数据泄漏检测</h1><p id="b520" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在本博客的剩余部分，使用以下步骤部署项目:</p><ul class=""><li id="cbdd" class="mw mx it lt b lu mn lx mo ma my me mz mi na mm nb nc nd ne bi translated">2.1部署资源</li><li id="48ca" class="mw mx it lt b lu ng lx nh ma ni me nj mi nk mm nb nc nd ne bi translated">2.2在数据块中启用详细审计日志记录</li><li id="9c21" class="mw mx it lt b lu ng lx nh ma ni me nj mi nk mm nb nc nd ne bi translated">2.3(可选)使用Azure门户创建Azure Monitor警报</li></ul><h2 id="66bd" class="nm la it bd lb nn no dn lf np nq dp lj ma nr ns ll me nt nu ln mi nv nw lp nx bi translated">2.1部署资源</h2><p id="c055" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">本教程需要以下资源，并且需要部署这些资源:</p><ul class=""><li id="eddf" class="mw mx it lt b lu mn lx mo ma my me mz mi na mm nb nc nd ne bi translated"><a class="ae ky" href="https://docs.microsoft.com/en-us/azure/databricks/scenarios/quickstart-create-databricks-workspace-portal?tabs=azure-portal#create-an-azure-databricks-workspace" rel="noopener ugc nofollow" target="_blank">Azure data bricks Premium Plan</a><strong class="lt iu"/>(仅Premium支持日志记录)</li><li id="4256" class="mw mx it lt b lu ng lx nh ma ni me nj mi nk mm nb nc nd ne bi translated"><a class="ae ky" href="https://docs.microsoft.com/en-us/azure/azure-monitor/logs/quick-create-workspace?tabs=azure-portal" rel="noopener ugc nofollow" target="_blank">日志分析工作区</a>(建议将工作区部署在与Azure Databricks相同的区域)</li></ul><h2 id="740c" class="nm la it bd lb nn no dn lf np nq dp lj ma nr ns ll me nt nu ln mi nv nw lp nx bi translated">2.2在数据块中启用详细审计日志记录</h2><p id="6768" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在此步骤中，启用了Databricks中的详细审核日志记录。需要执行以下两个步骤:</p><ul class=""><li id="28ad" class="mw mx it lt b lu mn lx mo ma my me mz mi na mm nb nc nd ne bi translated"><a class="ae ky" href="https://docs.microsoft.com/en-us/azure/databricks/administration-guide/account-settings/azure-diagnostic-logs#configure-diagnostic-log-delivery" rel="noopener ugc nofollow" target="_blank">配置数据块</a>的诊断日志传送。确保所有日志都归入在2.1中创建的日志分析工作区。</li><li id="3190" class="mw mx it lt b lu ng lx nh ma ni me nj mi nk mm nb nc nd ne bi translated"><a class="ae ky" href="https://docs.microsoft.com/en-us/azure/databricks/administration-guide/account-settings/azure-diagnostic-logs#enable-or-disable-verbose-audit-logs" rel="noopener ugc nofollow" target="_blank">在数据块</a>中启用详细审计记录。确保您以Databricks admin身份登录，转到Azure Databricks <a class="ae ky" href="https://docs.microsoft.com/en-us/azure/databricks/administration-guide/admin-console" rel="noopener ugc nofollow" target="_blank">管理控制台</a>，单击工作区设置，然后启用<strong class="lt iu">详细审计日志</strong></li></ul><h2 id="03b5" class="nm la it bd lb nn no dn lf np nq dp lj ma nr ns ll me nt nu ln mi nv nw lp nx bi translated"><strong class="ak"> 2.3 </strong>(可选)使用Azure门户创建Azure Monitor警报</h2><p id="fc2e" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在此步骤中，会生成一个简单的警报。在步骤3.2中，使用Azure CLI部署了完整的Databricks渗出脚本，因此可以跳过这一段。需要执行以下步骤:</p><ul class=""><li id="7780" class="mw mx it lt b lu mn lx mo ma my me mz mi na mm nb nc nd ne bi translated"><a class="ae ky" href="https://docs.microsoft.com/en-us/azure/azure-monitor/alerts/alerts-log#create-a-new-log-alert-rule-in-the-azure-portal" rel="noopener ugc nofollow" target="_blank">在Azure门户</a>中创建一个新的日志提醒规则。以<code class="fe ms mt mu mv b">DatabricksNotebook</code>为查询，以表格行为度量，以Cound为聚集类型。作为通知类型，向您自己发送电子邮件。</li></ul><p id="d199" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果您正确配置了规则，并且在Databrick notebook中运行了命令，将在Databrick notebook表的日志分析工作区中创建审核日志记录，这将创建一个导致电子邮件的警报。</p><h1 id="d1bc" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">3.Kusto数据渗透脚本示例</h1><p id="01f2" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在本章中，我们将讨论一个数据渗透脚本，然后将其部署到Azure Monitor。为此，使用了Azure CLI脚本。</p><ul class=""><li id="8579" class="mw mx it lt b lu mn lx mo ma my me mz mi na mm nb nc nd ne bi translated">3.1解释Kusto渗透脚本</li><li id="889d" class="mw mx it lt b lu ng lx nh ma ni me nj mi nk mm nb nc nd ne bi translated">3.2使用Azure CLI创建Azure Monitor警报</li></ul><h2 id="e756" class="nm la it bd lb nn no dn lf np nq dp lj ma nr ns ll me nt nu ln mi nv nw lp nx bi translated">3.1解释Kusto渗透脚本</h2><p id="4641" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在脚本<code class="fe ms mt mu mv b"><a class="ae ky" href="https://github.com/rebremer/azure-monitor-detect-exfiltration-databricks/blob/main/detection/databricksnotebook.kusto" rel="noopener ugc nofollow" target="_blank">databricksnotebook.kusto</a></code>中，使用kusto检测到三种不同的数据泄露场景。这些情景可以解释如下:</p><ul class=""><li id="c33c" class="mw mx it lt b lu mn lx mo ma my me mz mi na mm nb nc nd ne bi translated">场景1。向dbfs写入数据:最好不要在dbfs上存储数据，参见<a class="ae ky" href="https://github.com/Azure/AzureDatabricksBestPractices/blob/master/toc.md#do-not-store-any-production-data-in-default-dbfs-folders" rel="noopener ugc nofollow" target="_blank">这里的</a>。这也是因为数据可以通过dbfs渗透</li><li id="fa47" class="mw mx it lt b lu ng lx nh ma ni me nj mi nk mm nb nc nd ne bi translated">场景2。下载数据集。数据框架可以显示在数据块中，并且是可视化的。还有一个下载按钮，使用户能够在本地存储数据</li><li id="d7fc" class="mw mx it lt b lu ng lx nh ma ni me nj mi nk mm nb nc nd ne bi translated">场景3:在笔记本中多次显示数据。当使用display()命令时，只有有限的一组数据被打印到浏览器。然而，用户可以多次执行显示命令，kusto中窗口可以用于检测这种情况。</li></ul><p id="09b2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">场景2的示例片段如下所示:</p><pre class="kj kk kl km gt ny mv nz oa aw ob bi"><span id="a157" class="nm la it mv b gy oc od l oe of">...                         <br/>//                             <br/>// scenario 2: large download<br/>//<br/>let scenario2 = (<br/>DatabricksNotebook<br/>| where ActionName == "downloadPreviewResults" or ActionName == "downloadLargeResults"<br/>| project TimeGenerated, Identity, ActionName, MyJson = parse_json(RequestParams)<br/>| extend type= "scenario 2: large download"                             | project type, TimeGenerated, Identity, ActionName, MyJson.executionTime, notebook_text=MyJson.commandText, count_row=1                             );<br/>...<br/>                            <br/>scenario1a                              <br/>| union scenario1b, scenario2, scenario3a, scenario3b                             | order by TimeGenerated</span></pre><p id="b793" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">整个脚本也可以在日志分析工作区中运行进行测试，另请参见下图:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/4246da5b4851a90b74aa222ea232fd57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*POOXJNkZZsTtwZ_NEFY5Qw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">3.1日志分析工作区中的Kusto脚本—按作者分类的图像</p></figure><h2 id="6146" class="nm la it bd lb nn no dn lf np nq dp lj ma nr ns ll me nt nu ln mi nv nw lp nx bi translated">3.2使用Azure CLI创建Azure Monitor警报</h2><p id="d0e9" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在下面的脚本中，代码被部署kusto脚本被部署到Log Analytics工作区。</p><pre class="kj kk kl km gt ny mv nz oa aw ob bi"><span id="e165" class="nm la it mv b gy oc od l oe of"># 0. Preliminaries<br/>#<br/># - Chapter 2. Databricks data exfiltration detection is done</span><span id="e783" class="nm la it mv b gy oh od l oe of"># 1. Set variables<br/>#<br/>$SUB='&lt;&lt;your subscription id&gt;&gt;'<br/>$EMAIL='&lt;&lt;your email address&gt;&gt;'<br/>$LAW_RG='&lt;&lt;your resource group with Log Workspace analytics&gt;&gt;'<br/>$LAW_NAME='&lt;&lt;your Log Workspace Analytics name&gt;&gt;'<br/>$ALERT_GROUP_NAME='dbr_exf_detection_ag'<br/>$ALERT_RULE_NAME='dbr_data_exfiltration'</span><span id="6a96" class="nm la it mv b gy oh od l oe of"># 2. Log in<br/>#<br/>az login<br/>az account set --subscription $SUB</span><span id="64a3" class="nm la it mv b gy oh od l oe of"># 3. Create Action Group<br/>#<br/>az monitor action-group create -n $ALERT_GROUP_NAME -g $LAW_RG --action email rebremer $EMAIL<br/>$action_id=$(az monitor action-group show -n $ALERT_GROUP_NAME -g $LAW_RG | ConvertFrom-Json).id</span><span id="74aa" class="nm la it mv b gy oh od l oe of"># 4. Read Kusto detection file, escape special characters<br/>#<br/>Set-Location deployment<br/>$kusto_script = Get-Content "..\detection\databricksnotebook.kusto" -Raw<br/>$kusto_script = $kusto_script -replace "`r`n", "\n"<br/>$kusto_script = $kusto_script -replace '"', '\"'</span><span id="0d7a" class="nm la it mv b gy oh od l oe of"># 5. Add Kusto file to ARM template (using ARM params does not work)<br/>#<br/>$arm_data = Get-Content "arm_dbr_exf_script.json.template" -Raw<br/>$arm_data = $arm_data -replace "{dbr_exf_script}", $kusto_script<br/>$arm_data | Out-File -encoding ASCII arm_dbr_exf_script.json</span><span id="2da4" class="nm la it mv b gy oh od l oe of"># 5. Create Alert rule using ARM template<br/>#<br/>$law_id="/subscriptions/$SUB/resourcegroups/$LAW_RG/providers/microsoft.operationalinsights/workspaces/$LAW_NAME"<br/>az deployment group create --name AlertDeploymentv4 --resource-group $LAW_RG --template-file arm_dbr_exf_script.json --parameters scheduledqueryrules_dbr_data_exfiltration_name=$alert_rule_name<br/>actionGroups_test_dbrdataexf_ag_externalid=$action_id<br/>workspaces_test_storlogging_law_externalid=$law_id</span></pre><p id="71c8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">当一切部署成功时，Azure Monitor中会创建一个警报规则。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/6f6e934f0b82f846a865ebea8c4ca056.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7dewuip6BtbPNAmTQqXGYw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">3.2警报规则成功创建—按作者分类的图像</p></figure><h1 id="277e" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">4.结论</h1><p id="6fe7" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">Azure Databricks是企业做数据科学的热门工具。由于企业通常拥有大量敏感数据，因此应防止数据外泄。应实施Azure数据块的<a class="ae ky" href="https://docs.microsoft.com/en-us/security/benchmark/azure/baselines/databricks-security-baseline" rel="noopener ugc nofollow" target="_blank">安全基线</a>。在这篇blogpost和git repo <code class="fe ms mt mu mv b"><a class="ae ky" href="https://github.com/rebremer/azure-monitor-detect-exfiltration-databricks" rel="noopener ugc nofollow" target="_blank">azure-monitor-detect-exfiltration-databricks</a></code>中，讨论了如何使用Databricks审计日志、日志分析中的kusto和Azure monitor来扩展安全基线。另请参见下面的架构。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/a3d5535199223473dcf2c8c345e6fe27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mpoxh6mzDqr01FNP_NCMkg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">4.Azure Databrisks审计日志记录检测泄漏-作者图片</p></figure></div></div>    
</body>
</html>