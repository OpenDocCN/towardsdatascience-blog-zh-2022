<html>
<head>
<title>Metric Learning for Anomaly Detection</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于异常检测的度量学习</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/metric-learning-for-anomaly-detection-7bde550cfa56#2022-05-17">https://towardsdatascience.com/metric-learning-for-anomaly-detection-7bde550cfa56#2022-05-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1022" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何使用度量学习来检测异常:只有200个标记样本的咖啡豆质量评估</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/7bafc877870dcdd0a239f7192112bbd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5OaUgrDJcda9r3CrW8-yDg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片作者。</p></figure><p id="dd8a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">异常检测是一项迫切而又具有挑战性的任务，在各行各业都有大量的使用案例。这种复杂性主要是由于任务本身就缺乏数据。</p><p id="09f8" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">同样，根据定义，异常也是经常变化的，它们可能会以意想不到的形式出现。因此，基于监督分类的方法有:</p><ul class=""><li id="0c1b" class="lr ls iq kx b ky kz lb lc le lt li lu lm lv lq lw lx ly lz bi translated">数据饥渴——需要相当多的标记数据；</li><li id="3c63" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">昂贵——数据标注本身就是一项昂贵的任务；</li><li id="eef1" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">费时——你会试图获得必然稀缺的东西；</li><li id="9779" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">难以维护-您需要反复重新训练模型，以响应数据分布的变化。</li></ul><p id="2096" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果您想在快速变化的环境中将您的模型投入生产，这些并不是您想要的特性。此外，尽管存在上述所有困难，但与替代产品相比，它们并不一定能提供卓越的性能。在本帖中，我们将详细介绍从这样一个用例中学到的经验。</p><h2 id="34fd" class="mf mg iq bd mh mi mj dn mk ml mm dp mn le mo mp mq li mr ms mt lm mu mv mw mx bi translated">咖啡豆</h2><p id="4a6b" class="pw-post-body-paragraph kv kw iq kx b ky my jr la lb mz ju ld le na lg lh li nb lk ll lm nc lo lp lq ij bi translated">Agrivero.ai是一家为生产商、贸易商和烘焙商提供人工智能解决方案的公司。他们已经收集并标记了超过<strong class="kx ir"> 3万张带有各种缺陷的咖啡豆图片——潮湿的、破损的、有缺口的或者有虫子的样本。该数据用于训练分类器，该分类器评估作物质量并突出可能的问题。</strong></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="ab gu cl ne"><img src="../Images/8c697163ac19fccbf0dad19a2366b80a.png" data-original-src="https://miro.medium.com/v2/1*akKOEtWmY62-ZqBaE-qHTw.gif"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">咖啡中的异常现象。图片作者。</p></figure><p id="b20b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们应该注意到异常是多种多样的，因此列举所有可能的异常本身就是一项具有挑战性的任务。在工作过程中，新的缺陷类型出现，拍摄条件发生变化。因此，一次性标记的数据集是不够的。</p><p id="4b91" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们看看度量学习如何帮助解决这一挑战。</p><h2 id="6db5" class="mf mg iq bd mh mi mj dn mk ml mm dp mn le mo mp mq li mr ms mt lm mu mv mw mx bi translated">度量学习方法</h2><p id="470b" class="pw-post-body-paragraph kv kw iq kx b ky my jr la lb mz ju ld le na lg lh li nb lk ll lm nc lo lp lq ij bi translated">在这种方法中，我们的目标是在n维向量空间中编码图像，然后在推理过程中使用学习到的相似性来标记图像。</p><p id="7151" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最简单的方法是KNN分类法。该算法检索给定查询向量的K个最近邻，并基于多数投票分配标签。</p><p id="cb45" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在生产环境中，kNN分类器可以很容易地用<a class="ae nd" href="https://qdrant.tech/" rel="noopener ugc nofollow" target="_blank"> Qdrant </a>矢量搜索引擎替换。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="ab gu cl ne"><img src="../Images/cbf2511724882f025da0fa981fb913ff.png" data-original-src="https://miro.medium.com/v2/format:webp/1*l_8CVIRwKiTKfgglfAuMqw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">生产部署。图片作者。</p></figure><p id="5177" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这种方法具有以下优点:</p><ul class=""><li id="59f9" class="lr ls iq kx b ky kz lb lc le lt li lu lm lv lq lw lx ly lz bi translated">我们可以从未标记的数据中受益，考虑到标记既耗时又昂贵。</li><li id="83d6" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">相关的度量，例如，精度或召回率，可以在推理期间根据变化的要求进行调整，而无需重新训练。</li><li id="8a1b" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">标记有高分的查询可以作为新的数据点被动态地添加到KNN分类器中。</li></ul><p id="ddc3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了应用度量学习，我们需要一个神经编码器，一个能够将图像转换为矢量的模型。</p><p id="0452" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">从头开始训练这样的编码器可能需要我们可能没有的大量数据。因此，我们将培训分为两步:</p><ul class=""><li id="fdb1" class="lr ls iq kx b ky kz lb lc le lt li lu lm lv lq lw lx ly lz bi translated">第一步是训练自动编码器，用它我们将准备一个能够表示目标域的模型。</li><li id="2b4c" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">第二步是微调。其目的是训练模型来区分所需的异常类型。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="ab gu cl ne"><img src="../Images/b36bd9801173a79d3a886377c6941fe0.png" data-original-src="https://miro.medium.com/v2/format:webp/1*X3esbgoXcxs6xgG9-5FV-A.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">模型训练架构。图片作者。</p></figure><h2 id="dc16" class="mf mg iq bd mh mi mj dn mk ml mm dp mn le mo mp mq li mr ms mt lm mu mv mw mx bi translated">步骤1 —未标记数据的自动编码器</h2><p id="c5e6" class="pw-post-body-paragraph kv kw iq kx b ky my jr la lb mz ju ld le na lg lh li nb lk ll lm nc lo lp lq ij bi translated">首先，我们通过将标签放在一边，在普通的自动编码器架构中预处理了一个类似Resnet18的模型。Autoencoder是由编码器和解码器组成的模型架构，后者试图从前者的低维瓶颈输出中重建原始输入。</p><p id="6d6c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">没有直观的评估标准来指示该设置中的性能，但是我们可以通过直观地检查重新创建的样本来评估是否成功。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="ab gu cl ne"><img src="../Images/035c2524522ffa00741c7bf31b408d09.png" data-original-src="https://miro.medium.com/v2/format:webp/1*kZiLbZbWqQv4IJSP0kOTjQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">用自动编码器模型重建图像的例子。图片作者。</p></figure><p id="d881" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然后，我们使用编码器将数据的子集编码成128维向量，并在这些嵌入和相关标签的基础上创建KNN分类器。</p><p id="0fa3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">虽然结果很有希望，但我们可以通过度量学习进行微调来做得更好。</p><h2 id="47ca" class="mf mg iq bd mh mi mj dn mk ml mm dp mn le mo mp mq li mr ms mt lm mu mv mw mx bi translated">步骤2 —使用度量学习进行微调</h2><p id="31ac" class="pw-post-body-paragraph kv kw iq kx b ky my jr la lb mz ju ld le na lg lh li nb lk ll lm nc lo lp lq ij bi translated">我们从随机选择200个标记样本开始，没有替换。</p><p id="d6f6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在此步骤中，模型由自动编码器的编码器部分组成，随机初始化的投影层堆叠在其上。我们应用了来自冻结编码器的迁移学习，并且仅训练具有三重丢失的投影层和在线批量所有三重挖掘策略。</p><p id="2916" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">不幸的是，该模型在这种尝试中很快就过度拟合了。在下一个实验中，我们使用了一个在线批量硬策略和一个防止向量空间崩溃的技巧。我们将在后续文章中描述我们的方法。</p><p id="9a25" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这一次，它顺利地收敛了，我们的评估指标也有了相当大的改进，以匹配监督分类方法。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="ab gu cl ne"><img src="../Images/cb238241d4042a4826f34bd2689e9dc2.png" data-original-src="https://miro.medium.com/v2/format:webp/1*uH-3MhZW3siZB5xS296weg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">具有KNN分类器的自动编码器模型的度量。图片作者。</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="ab gu cl ne"><img src="../Images/3ba6b4eb1856cf45314bed5004bfe836.png" data-original-src="https://miro.medium.com/v2/format:webp/1*sGWINhuVKueemxzb9dT7XQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">使用KNN分类器的微调模型的度量。图片作者。</p></figure><p id="6ea7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们用500个和2000个样本重复了这个实验，但它只显示出轻微的改善。因此，我们决定坚持200个样本——原因见下文。</p><h2 id="bedd" class="mf mg iq bd mh mi mj dn mk ml mm dp mn le mo mp mq li mr ms mt lm mu mv mw mx bi translated">监督分类方法</h2><p id="4c74" class="pw-post-body-paragraph kv kw iq kx b ky my jr la lb mz ju ld le na lg lh li nb lk ll lm nc lo lp lq ij bi translated">我们还想将我们的结果与传统监督分类模型的指标进行比较。为此，Resnet50模型用大约30k标记的图像进行了微调，可用于训练。令人惊讶的是，F1分数在0.86左右。</p><p id="d82e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">请注意，我们在度量学习方法中仅使用了200个标记样本，而不是监督分类方法中的大约30k。这些数字表明，在性能没有显著下降的情况下，节省了大量成本。</p><h2 id="6b77" class="mf mg iq bd mh mi mj dn mk ml mm dp mn le mo mp mq li mr ms mt lm mu mv mw mx bi translated">结论</h2><p id="d084" class="pw-post-body-paragraph kv kw iq kx b ky my jr la lb mz ju ld le na lg lh li nb lk ll lm nc lo lp lq ij bi translated">我们通过度量学习仅使用0.66% 的标记数据<strong class="kx ir">，获得了与监督分类方法相当的结果。这种方法既省时又节省资源，还可以进一步改进。下一步可能是:</strong></p><ul class=""><li id="5903" class="lr ls iq kx b ky kz lb lc le lt li lu lm lv lq lw lx ly lz bi translated">收集更多未标记的数据，并预训练更大的自动编码器。</li><li id="2eeb" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">获取少量图像的高质量标签，而不是成千上万的图像进行微调。</li><li id="637a" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">在微调步骤中使用超参数优化和可能的逐步解冻。</li><li id="bc42" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">使用<a class="ae nd" href="https://github.com/qdrant/qdrant" rel="noopener ugc nofollow" target="_blank">向量搜索引擎</a>为生产中的度量学习服务。</li></ul><p id="c512" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们正在积极研究这些问题，并将继续在本次挑战和其他度量学习用例中发布我们的发现。</p><p id="8057" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你想享受这种关于度量学习、相似性学习和向量搜索的有趣讨论，请加入我们的Discord:</p><div class="nf ng gp gr nh ni"><a href="https://discord.qdrant.tech/" rel="noopener  ugc nofollow" target="_blank"><div class="nj ab fo"><div class="nk ab nl cl cj nm"><h2 class="bd ir gy z fp nn fr fs no fu fw ip bi translated">加入qdrant Discord服务器！</h2><div class="np l"><h3 class="bd b gy z fp nn fr fs no fu fw dk translated">在Discord上查看qdrant社区-与其他144名成员一起闲逛，享受免费语音和文本聊天。</h3></div><div class="nq l"><p class="bd b dl z fp nn fr fs no fu fw dk translated">discord.qdrant.tech</p></div></div><div class="nr l"><div class="ns l nt nu nv nr nw kp ni"/></div></div></a></div></div></div>    
</body>
</html>