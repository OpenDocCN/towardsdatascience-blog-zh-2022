<html>
<head>
<title>MLflow Model Serving</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">MLflow模型服务</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/mlflow-model-serving-bcd936d59052#2022-04-04">https://towardsdatascience.com/mlflow-model-serving-bcd936d59052#2022-04-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a30b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用MLflow在本地托管模型</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/2d18a0aeeae6e42c6cc98d6ac8f3cbdb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DZSb7rw0Bfd3SktU"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自<a class="ae ky" href="https://unsplash.com/@mattbotsford" rel="noopener ugc nofollow" target="_blank">马特·博茨福德</a>拍摄的<a class="ae ky" href="https://unsplash.com/photos/OKLqGsCT8qs" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><p id="46ee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在之前的文章中，我们讨论了如何用<a class="ae ky" href="https://mlflow.org/" rel="noopener ugc nofollow" target="_blank"> MLflow </a>来<a class="ae ky" rel="noopener" target="_blank" href="/using-mlflow-to-track-machine-learning-experiments-adbf27e9d36c">跟踪和注册模型</a>。MLflow还涵盖了ML生命周期的另一个重要步骤，即<strong class="lb iu">模型托管</strong>和部署。虽然跟踪训练模型的不同迭代很重要，但最终你需要从你选择的模型中进行<a class="ae ky" href="https://hazelcast.com/glossary/machine-learning-inference/" rel="noopener ugc nofollow" target="_blank">推理</a>。</p><p id="7bb8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用<a class="ae ky" href="https://www.mlflow.org/docs/latest/models.html" rel="noopener ugc nofollow" target="_blank"> MLflow模型</a>我们可以打包ML模型用于<strong class="lb iu">本地实时推理</strong>或Apache Spark上的批量推理。在本文中，我们将探索如何训练一个Sklearn模型，然后使用MLflow在本地部署它进行推理。我们将使用MLflow存储库中的以下<a class="ae ky" href="https://github.com/mlflow/mlflow/tree/master/examples/sklearn_logistic_regression" rel="noopener ugc nofollow" target="_blank">示例</a>作为参考。具体这个例子的代码可以在<a class="ae ky" href="https://github.com/RamVegiraju/mlflow-serving" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><h1 id="4111" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">目录</h1><ol class=""><li id="f5bf" class="mn mo it lb b lc mp lf mq li mr lm ms lq mt lu mu mv mw mx bi translated">设置</li><li id="ae06" class="mn mo it lb b lc my lf mz li na lm nb lq nc lu mu mv mw mx bi translated">模特培训</li><li id="c3ca" class="mn mo it lb b lc my lf mz li na lm nb lq nc lu mu mv mw mx bi translated">部署和推理</li><li id="ffbb" class="mn mo it lb b lc my lf mz li na lm nb lq nc lu mu mv mw mx bi translated">其他资源和结论</li></ol><h2 id="5c01" class="nd lw it bd lx ne nf dn mb ng nh dp mf li ni nj mh lm nk nl mj lq nm nn ml no bi translated">1.设置</h2><p id="1c56" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">这里的设置非常简单，因为MLflow是一个开源包，您可以使用它。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">安装MLflow</p></figure><p id="b01d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你想完全访问MLflow <a class="ae ky" href="https://www.mlflow.org/docs/latest/quickstart.html" rel="noopener ugc nofollow" target="_blank">文档</a>，从他们的<a class="ae ky" href="https://github.com/mlflow/mlflow" rel="noopener ugc nofollow" target="_blank">资源库</a>开始吧，那里也有一大套<a class="ae ky" href="https://github.com/mlflow/mlflow/tree/master/examples" rel="noopener ugc nofollow" target="_blank">示例</a>，涵盖了我们讨论过的所有主要组件。</p><p id="4ca2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，对于我们的MLflow模型的设置，我们需要<strong class="lb iu">以模型服务将理解的某种结构定义几个文件</strong>。我们将捕获我们将在脚本中部署的模型，为此，我们可以创建一个<strong class="lb iu"> train.py </strong>来进行模型训练，并创建<strong class="lb iu"> log </strong>我们的<strong class="lb iu">模型工件</strong>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">模型服务脚本</p></figure><p id="47f1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以在根目录下的一个<a class="ae ky" href="https://mlflow.org/docs/0.4.2/projects.html" rel="noopener ugc nofollow" target="_blank"> MLproject </a>文件中指向这个脚本。在这个文件中，我们可以提供<strong class="lb iu">模型服务</strong>所需的<strong class="lb iu">元数据</strong>。在这里，我们可以在train.py中捕获我们的<a class="ae ky" href="https://mlflow.org/0.2.0/python_api/mlflow.projects.html" rel="noopener ugc nofollow" target="_blank">入口点</a>脚本，这将基本上让MLflow知道这是我们可以在项目中捕获我们的模型工件的地方。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">ml项目已定义</p></figure><p id="7b47" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以在这个文件中以yaml格式定义更多的参数。MLflow项目的本质是以可重用的方式打包您的数据科学代码以供部署。例如，在上面的yaml文件中，如果您正在部署conda环境，您也可以定义一个conda环境。</p><p id="c92d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个例子中，我们不会使用conda环境，但是您可以在这个文件中指定您的依赖项。我还附上了一个示例conda.yaml文件，仅供本例的代码库中参考。在我们开始编写培训脚本之前，您的文件结构应该如下所示。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/07a7ef4345b2a4cdd81eb20706011fa7.png" data-original-src="https://miro.medium.com/v2/resize:fit:664/format:webp/1*AYp2HFR_Sab7rQPCDA55GA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">文件结构(作者截图)</p></figure><h2 id="ff61" class="nd lw it bd lx ne nf dn mb ng nh dp mf li ni nj mh lm nk nl mj lq nm nn ml no bi translated">2.模特培训</h2><p id="58dd" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">在开始部署我们的模型之前，我们将使用<a class="ae ky" href="https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.LinearRegression.html" rel="noopener ugc nofollow" target="_blank"> Sklearn框架</a>用<a class="ae ky" href="https://www.cs.toronto.edu/~delve/data/boston/bostonDetail.html" rel="noopener ugc nofollow" target="_blank">波士顿住房数据集</a>训练一个简单的线性回归模型。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">模特培训</p></figure><p id="1448" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以使用MLflow提供的<a class="ae ky" href="https://mlflow.org/docs/1.2.0/python_api/mlflow.html" rel="noopener ugc nofollow" target="_blank"> log_metric API调用</a>来捕获我们的RMSE度量，以跟踪不同的训练迭代。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">MLflow运行的日志度量</p></figure><p id="a904" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">更重要的是，我们需要捕获我们的模型工件/数据，我们可以通过log_model API调用来完成。对于sklearn来说更好的是，MLflow提供了一个为框架定制的特定的<a class="ae ky" href="https://www.mlflow.org/docs/latest/python_api/mlflow.sklearn.html" rel="noopener ugc nofollow" target="_blank"> sklearn.log_model调用</a>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">捕获模型工件</p></figure><p id="c9ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，如果我们运行训练脚本，我们应该看到最后一行中省略了一个运行ID。我们在前面要点的最后一行获取运行ID，这样我们就可以指定我们想要部署哪个模型。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/4630eaefb19779a5eeebc281f7d801c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dtc8O_7w442Uh99qoQs1xg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">模特训练+跑步ID(作者截图)</p></figure><p id="46cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请务必保存此运行ID，我们将需要它为我们的模型服务。</p><h2 id="7ed1" class="nd lw it bd lx ne nf dn mb ng nh dp mf li ni nj mh lm nk nl mj lq nm nn ml no bi translated">3.部署和推理</h2><p id="280d" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">使用这个运行ID，我们可以将MLflow模型作为一个公共REST API。使用下面的命令，我们的模型将作为REST API用于推理。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="03e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，我们为<strong class="lb iu"> no conda环境</strong>提供了一个<strong class="lb iu">环境变量</strong>，因为我们没有针对这种情况的环境变量，但是如果您在conda环境中，请确保忽略它。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/e75ae328c34a7bd8ff8d80d36cb1fa72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kLLRZoqCgk9l10fuTYnaGQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">模特上菜(作者截图)</p></figure><p id="ca2f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们可以通过对<strong class="lb iu">/调用</strong>路径的POST输入来调用本地REST API端点。我们可以获取一个样本数据点，并指定我们的输入数据点以及内容类型(JSON、CSV)。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">引起</p></figure><p id="1490" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以通过<a class="ae ky" href="https://www.mlflow.org/docs/latest/models.html#model-signature-and-input-example" rel="noopener ugc nofollow" target="_blank">模型签名</a>进一步添加更多定制来定义您的输入和输出。您可以将模型签名添加到log_model调用中，以便根据定型数据自动推断输入数据，或者指定您的列/输入数据功能。</p><p id="b64a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个例子中，我们将直接调用REST API和一个示例数据点，如上面的shell命令所示。在另一个shell中运行该命令，您应该会看到推论。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/7c745a8bc7b3ff374d144c69ab5b4fee.png" data-original-src="https://miro.medium.com/v2/resize:fit:480/format:webp/1*Xbs422IKCzvPVWxvuhHiSA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">推论(作者截图)</p></figure><h2 id="d6de" class="nd lw it bd lx ne nf dn mb ng nh dp mf li ni nj mh lm nk nl mj lq nm nn ml no bi translated">4.其他资源和结论</h2><div class="ny nz gp gr oa ob"><a href="https://github.com/RamVegiraju/mlflow-serving" rel="noopener  ugc nofollow" target="_blank"><div class="oc ab fo"><div class="od ab oe cl cj of"><h2 class="bd iu gy z fp og fr fs oh fu fw is bi translated">GitHub-RamVegiraju/mlflow-serving:本地服务ml flow模型的示例</h2><div class="oi l"><h3 class="bd b gy z fp og fr fs oh fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="oj l"><p class="bd b dl z fp og fr fs oh fu fw dk translated">github.com</p></div></div><div class="ok l"><div class="ol l om on oo ok op ks ob"/></div></div></a></div><p id="7faf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">MLflow是一个非常强大的工具，涵盖了ML生命周期的每一步。您可以使用它来构建端到端的ML工作流，但更重要的是，它还为您提供了选择ML项目中您想要关注的步骤的灵活性。</p><p id="b5a3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望这篇文章是对使用MLflow托管模型的一个很好的介绍，我们将在接下来的文章中探索该平台的不同方面。</p><h2 id="f5bc" class="nd lw it bd lx ne nf dn mb ng nh dp mf li ni nj mh lm nk nl mj lq nm nn ml no bi translated">额外资源</h2><p id="03d0" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated"><a class="ae ky" rel="noopener" target="_blank" href="/using-mlflow-to-track-machine-learning-experiments-adbf27e9d36c">使用MLflow跟踪ML实验</a></p><p id="b909" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://docs.databricks.com/applications/mlflow/model-serving.html" rel="noopener ugc nofollow" target="_blank"> MLflow模型注册&amp;服务</a></p><p id="95eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" rel="noopener" target="_blank" href="/3-ways-to-deploy-machine-learning-models-in-production-cdba15b00e">部署ML模型</a></p></div><div class="ab cl oq or hx os" role="separator"><span class="ot bw bk ou ov ow"/><span class="ot bw bk ou ov ow"/><span class="ot bw bk ou ov"/></div><div class="im in io ip iq"><p id="1024" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="ox">如果你喜欢这篇文章，请在</em><a class="ae ky" href="https://www.linkedin.com/in/ram-vegiraju-81272b162/" rel="noopener ugc nofollow" target="_blank"><em class="ox">LinkedIn</em></a><em class="ox">上与我联系，并订阅我的媒体</em> <a class="ae ky" href="https://ram-vegiraju.medium.com/subscribe" rel="noopener"> <em class="ox">简讯</em> </a> <em class="ox">。如果你是新手，使用我的</em> <a class="ae ky" href="https://ram-vegiraju.medium.com/membership" rel="noopener"> <em class="ox">会员推荐</em> </a> <em class="ox">报名。</em></p></div></div>    
</body>
</html>