<html>
<head>
<title>Jinja/DBT SQL Templating in JupyterLab/VSCode</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">JupyterLab/VSCode中的金贾/DBT SQL模板</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/jinja-dbt-sql-templating-in-jupyterlab-vscode-1179e818fe17#2022-07-22">https://towardsdatascience.com/jinja-dbt-sql-templating-in-jupyterlab-vscode-1179e818fe17#2022-07-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="3f19" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">快速原型化您的SQL模板</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/bc4810dbc3feaf8d4f2c6e27aa441f08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L3lkROp3NtU4TrPetUGEtA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">乔安娜·科辛斯卡在Unsplash上的照片</p></figure><p id="cd32" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">SQL本身并不适合重用。为了实现可重用性，SQL通常使用像Jinja这样的库进行模板化。例如<a class="ae lr" href="https://superset.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache超集</a>在其数据集定义中利用了Jinja模板，当然<a class="ae lr" href="https://www.getdbt.com/product/what-is-dbt/" rel="noopener ugc nofollow" target="_blank"> DBT </a>是一个完全围绕Jinja模板构建的工具。Jupyterlab-sql-editor本机支持Jinja模板，这使得在Jupyterlab和VSCode中为超集和DBT构建jinja-sql模板原型成为可能。</p><h2 id="ef23" class="ls lt iq bd lu lv lw dn lx ly lz dp ma le mb mc md li me mf mg lm mh mi mj mk bi translated">使用Jinja模板创建可重用的SQL</h2><p id="dc12" class="pw-post-body-paragraph kv kw iq kx b ky ml jr la lb mm ju ld le mn lg lh li mo lk ll lm mp lo lp lq ij bi translated"><code class="fe mq mr ms mt b"><strong class="kx ir">--jinja</strong></code>选项启用了Jinja模板支持，使得笔记本中声明的任何变量或函数都可以在Jinja标签<code class="fe mq mr ms mt b"><strong class="kx ir">{{}}</strong></code>中替换</p><p id="efe0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">例如，您可以使用变量来表示SQL语句中使用的实际表名。当您拥有用于开发和生产表的数据库模式时，这可能会很有用。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mu"><img src="../Images/e03d71dffa31bb0b1a8327e0343e0945.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ijLekTc_Z2laJlcM52kOmw.png"/></div></div></figure><p id="1189" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在我们的<a class="ae lr" href="https://medium.com/p/e6ac865b42df" rel="noopener">上一篇文章</a>中，我们看到<code class="fe mq mr ms mt b"><strong class="kx ir">%%sparksql</strong></code>魔术支持许多输出格式；文本，交互式网格，交互式JSON树，html，skip。这个<code class="fe mq mr ms mt b"><strong class="kx ir">%%sparksql</strong></code>魔术还有一个锦囊妙计！原谅我的双关语。</p><p id="5c9e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe mq mr ms mt b"><strong class="kx ir">--output sql</strong></code>选项用语法高亮显示结果SQL语句。这是一种验证你的Jinja模板代码的便捷方式。在这个例子中，我们使用python列表变量来自动生成SELECT语句。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mv"><img src="../Images/068fd0cb88eb5f43e6c76ad293c0ebd2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pk_zoWJx607XzKIVqCVoBA.png"/></div></div></figure><p id="1d25" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">正如我们所看到的，Jinja <code class="fe mq mr ms mt b"><strong class="kx ir">{% for item in list %}</strong></code>已经生成了所需的列。</p><h2 id="ac34" class="ls lt iq bd lu lv lw dn lx ly lz dp ma le mb mc md li me mf mg lm mh mi mj mk bi translated">挖掘DBT的力量</h2><p id="ac1d" class="pw-post-body-paragraph kv kw iq kx b ky ml jr la lb mm ju ld le mn lg lh li mo lk ll lm mp lo lp lq ij bi translated">使用Jinja模板来自动生成SQL语句是非常强大的，事实上整个项目都是围绕这个想法构建的。<a class="ae lr" href="https://www.getdbt.com/product/what-is-dbt/" rel="noopener ugc nofollow" target="_blank"> DBT </a>是一个使用SELECT语句开发模块化SQL模型的框架，包括一个<code class="fe mq mr ms mt b"><strong class="kx ir">ref()</strong></code> Jinja宏，用于处理依赖性管理(首先构建哪些模型)。</p><p id="1eaa" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">DBT包含了大量的Jinja宏，旨在简化SQL语句的阐述。DBT有一个包管理系统，允许第三方开发者贡献宏库。在<a class="ae lr" href="https://hub.getdbt.com/" rel="noopener ugc nofollow" target="_blank"> DBT中心</a>有很多</p><p id="f4fe" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">通过简单地将<code class="fe mq mr ms mt b"><strong class="kx ir">--jinja</strong></code>替换为<code class="fe mq mr ms mt b"><strong class="kx ir">--dbt</strong></code>选项，并在笔记本上配置您的DBT项目的位置，magic使您能够利用丰富的宏。我们将使用示例项目<a class="ae lr" href="https://github.com/dbt-labs/jaffle_shop" rel="noopener ugc nofollow" target="_blank"> jaffle_shop </a>来说明DBT的使用。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mw"><img src="../Images/fb99799d262496aff034efd960131884.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yP2A4195TT85VdXM2mvkqw.png"/></div></div></figure><p id="9038" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在jaffle_shop中有一个名为<a class="ae lr" href="https://github.com/dbt-labs/jaffle_shop/blob/main/models/orders.sql" rel="noopener ugc nofollow" target="_blank"> orders.sql </a>的模型。我们可以将这个文件的内容放在Jupyter单元格中，并使用<code class="fe mq mr ms mt b"><strong class="kx ir">--dbt</strong></code>通过DBT处理模板。我们可以使用<code class="fe mq mr ms mt b"><strong class="kx ir">—-output sql</strong></code>来呈现语句，使用<code class="fe mq mr ms mt b"><strong class="kx ir">--output html</strong></code>来执行查询并显示结果。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mx"><img src="../Images/265d5664ced2bcb863067610ff29db15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_ddhq6jIOhaAkzSDMFJTYg.png"/></div></div></figure><p id="da96" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">注意DBT <code class="fe mq mr ms mt b"><strong class="kx ir">ref()</strong></code>宏的使用。该宏引用了您的DBT项目中现有的DBT模型。<code class="fe mq mr ms mt b"><strong class="kx ir">%%sparksql</strong></code>实际上使用了DBT框架来呈现SQL模板。所有的DBT模型和宏都提供给<code class="fe mq mr ms mt b"><strong class="kx ir">%%sparksql</strong></code> magic。</p><p id="f323" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们可以呈现DBT生成的SQL。输出很长，我们只展示了其中的一部分。注意产生预期列的<code class="fe mq mr ms mt b">payment_method</code>循环。还要注意DBT处理短暂模型具体化的方式。更多详情<a class="ae lr" href="https://docs.getdbt.com/docs/building-a-dbt-project/building-models/materializations#ephemeral" rel="noopener ugc nofollow" target="_blank">此处</a>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi my"><img src="../Images/1b5f611270dfd21542f0bd3d7ad5319b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1378/format:webp/1*Xtq_lX_vYM6cdi0-vF9Hkg.png"/></div></figure><p id="4d6c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如前所述，我们可以执行并显示结果。在显示实际结果之前，请注意DBT日志输出。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mz"><img src="../Images/9a172c254c8d3406e0cdb86cb8a8ccb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*41JpeWekDFyApV5mUeTAQg.png"/></div></div></figure><p id="e076" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">使用<code class="fe mq mr ms mt b"><strong class="kx ir">%%sparksql</strong></code>是构建DBT代码原型的一种便捷方式。我们已经用一个预先存在的模型说明了DBT的使用。要从头开始创建DBT模型，您可能只想显示现有表(DBT数据源)或预先存在的DBT模型的数据。假设您想要创建一个基于<code class="fe mq mr ms mt b"><strong class="kx ir">stg_payments</strong></code>的新模型。你可以从展示<code class="fe mq mr ms mt b"><strong class="kx ir">stg_payments</strong></code>的数据开始</p><pre class="kg kh ki kj gt na mt nb nc aw nd bi"><span id="c5ac" class="ls lt iq mt b gy ne nf l ng nh"><strong class="mt ir">%%sparksql</strong> --dbt --output html</span><span id="c217" class="ls lt iq mt b gy ni nf l ng nh">select * from {{ ref('stg_payments') }}</span></pre><p id="9dae" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然后使用DBT的Jinja宏开始转换这个数据集。同时查看结果输出或呈现SQL。</p><pre class="kg kh ki kj gt na mt nb nc aw nd bi"><span id="24a8" class="ls lt iq mt b gy ne nf l ng nh"><strong class="mt ir">%%sparksql</strong> --dbt</span><span id="b08b" class="ls lt iq mt b gy ni nf l ng nh">{% set payment_methods =<br/>  ['credit_card', 'coupon', 'bank_transfer', 'gift_card'] %}</span><span id="3261" class="ls lt iq mt b gy ni nf l ng nh">select<br/>    order_id,<br/>    {% for payment_method in payment_methods -%}<br/>    sum(case when payment_method = '{{ payment_method }}'<br/>    then amount else 0 end) as {{ payment_method }}_amount,<br/>    {% endfor -%}<br/>    sum(amount) as total_amount<br/>from {{ ref('stg_payments') }}<br/>group by order_id</span></pre><p id="6317" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">一旦您有了一个很好的模板化查询，您可以通过简单地将模板复制到DBT <code class="fe mq mr ms mt b"><strong class="kx ir">.sql</strong></code>模型文件中来将它转移到生产环境中，并且确信它实际上会做您期望它做的事情。</p><h2 id="daa2" class="ls lt iq bd lu lv lw dn lx ly lz dp ma le mb mc md li me mf mg lm mh mi mj mk bi translated">Visual Studio代码DBT高级用户</h2><p id="a87c" class="pw-post-body-paragraph kv kw iq kx b ky ml jr la lb mm ju ld le mn lg lh li mo lk ll lm mp lo lp lq ij bi translated"><a class="ae lr" href="https://github.com/innoverio/vscode-dbt-power-user" rel="noopener ugc nofollow" target="_blank"> DBT电力用户</a>是DBT项目的一个流行的VSCode扩展。它支持您的<code class="fe mq mr ms mt b"><strong class="kx ir">.sql</strong></code>模型文件的许多DBT自动完成特性。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/34a2145777b977646bd2acb9b5939800.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MP99eiYlHZsz3rTF0FmdVw.png"/></div></div></figure><p id="f585" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">Visual Studio代码原生支持使用Jupyter笔记本，因此<code class="fe mq mr ms mt b">%%sparksql</code>魔法在VSCode内部工作。如前所示，要在笔记本中利用DBT项目，你需要做的就是把你的DBT的位置给<code class="fe mq mr ms mt b"><strong class="kx ir">%%sparksql</strong></code></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nk"><img src="../Images/b702480e1c91aaf1e5a78e85f53d1a44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xuv0uLULwMLLGkk9ynXEwA.png"/></div></div></figure><p id="6eb6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">一旦笔记本单元格的语言被设置为SQL，DBT超级用户的自动补全功能就会启动，你将获得与编辑<code class="fe mq mr ms mt b"><strong class="kx ir">.sql</strong></code>文件相同的好处。请注意，如果您在VSCode中安装了<a class="ae lr" href="https://github.com/joe-re/sql-language-server" rel="noopener ugc nofollow" target="_blank"> sql-language-server </a>，它会在检测到带有<code class="fe mq mr ms mt b"><strong class="kx ir">%%sparksql</strong></code>魔法的单元格时自动将语言更改为sql。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nl"><img src="../Images/8af783d44c7b88916c284bdb1cf52679.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wB5XLCf75ac2qP1vvIbThg.png"/></div></div></figure><p id="fbdd" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">记住，在JupyterLab中，VSCode自动完成是由<ctrl-space>而不是<tab>触发的。</tab></ctrl-space></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/196e2c3bad58aa79f763b36c0fc242c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vovEawmVxg2wODFGqkommw.png"/></div></div></figure><p id="7d92" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">例如，如果我们选择上面显示的<code class="fe mq mr ms mt b"><strong class="kx ir">is_incremental</strong></code>建议，我们会将以下代码插入到我们的笔记本单元格中。与DBT超级用户在<code class="fe mq mr ms mt b"><strong class="kx ir">.sql</strong></code>模型文件中的行为相同。</p><p id="3154" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">底线是<code class="fe mq mr ms mt b"><strong class="kx ir">%%sparksql</strong></code> magic在VSCode和JupyterLab笔记本上的工作方式是一样的。您可以将DBT模型渲染到SQL中，执行查询并查看结果。类似地，VSCode笔记本也是制作DBT模型原型的好方法。一旦你对你的模型感到满意，你可以把它复制到一个<code class="fe mq mr ms mt b"><strong class="kx ir">.sql</strong></code>模型文件中。</p><h1 id="2396" class="nn lt iq bd lu no np nq lx nr ns nt ma jw nu jx md jz nv ka mg kc nw kd mj nx bi translated">结论</h1><p id="c27a" class="pw-post-body-paragraph kv kw iq kx b ky ml jr la lb mm ju ld le mn lg lh li mo lk ll lm mp lo lp lq ij bi translated">在本文中，我们展示了如何利用<code class="fe mq mr ms mt b"><strong class="kx ir">%%sparksql</strong></code>在JupyterLab和VSCode中轻松构建模板化的Spark SQL原型。我们关注的是Spark，但是jupyterlab-sql-editor也包含了一个<code class="fe mq mr ms mt b"><strong class="kx ir">%%trino</strong></code>魔法！将来可能会添加更多的SQL引擎。欢迎投稿！这是我们的git repo<a class="ae lr" href="https://github.com/CybercentreCanada/jupyterlab-sql-editor" rel="noopener ugc nofollow" target="_blank">cyber centre Canada/jupyterlab-SQL-editor</a>。</p></div></div>    
</body>
</html>