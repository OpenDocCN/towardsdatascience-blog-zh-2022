<html>
<head>
<title>Understanding Meta Learners</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">理解元学习者</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/understanding-meta-learners-8a9c1e340832#2022-07-12">https://towardsdatascience.com/understanding-meta-learners-8a9c1e340832#2022-07-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="1d3e" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/causal-data-science" rel="noopener" target="_blank">因果数据科学</a></h2><div class=""/><div class=""><h2 id="2200" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">如何使用机器学习来估计异质治疗效果</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/72501dc67bb322f8c14fea2101b927c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ff-8_ZjIKiqsljkUfgVPSQ.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">封面，作者图片</p></figure><p id="d047" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">在许多情况下，我们不仅对估计因果效应感兴趣，还对这种效应对于不同用户是否<strong class="lg ja">不同感兴趣</strong>。我们可能有兴趣了解一种药物对不同年龄的人是否有不同的副作用。或者，我们可能有兴趣了解某个广告活动在某些地理区域是否特别有效。</p><p id="1c1a" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">这一知识至关重要，因为它让我们能够<strong class="lg ja">有针对性地进行治疗。如果一种药物对儿童有严重的副作用，我们可能会限制它只在成人中销售。或者，如果一个广告活动只在说英语的国家有效，就不值得在其他地方展示。</strong></p><p id="12d0" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">在这篇博文中，我们将探索一些方法来揭示<strong class="lg ja">治疗效果的异质性</strong>。特别是，我们将探索利用<strong class="lg ja">机器学习</strong>算法灵活性的方法。</p></div><div class="ab cl ma mb hu mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ij ik il im in"><h1 id="3993" class="mh mi iq bd mj mk ml mm mn mo mp mq mr kf ms kg mt ki mu kj mv kl mw km mx my bi translated">例子</h1><p id="1619" class="pw-post-body-paragraph le lf iq lg b lh mz ka lj lk na kd lm ln nb lp lq lr nc lt lu lv nd lx ly lz ij bi translated">假设我们是一家公司，有兴趣了解新的<strong class="lg ja">高级功能</strong>增加了多少收入。特别是，我们知道不同<strong class="lg ja">年龄</strong>的用户有不同的消费态度，我们怀疑超值功能的影响也可能因用户年龄而异。</p><p id="2613" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">该信息可能非常重要，例如针对或<strong class="lg ja">折扣设计</strong>的<strong class="lg ja">广告。如果我们发现高级功能增加了一组特定用户的收入，我们可能希望将广告瞄准该组用户或向他们提供个性化折扣。</strong></p><p id="fba5" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">为了了解高级功能对收入的影响，运行一个<a class="ae ne" href="https://en.wikipedia.org/wiki/A/B_testing" rel="noopener ugc nofollow" target="_blank"> <strong class="lg ja"> AB测试</strong> </a>，我们在测试样本中随机给予10%的用户访问高级功能的权限。这项功能很贵，我们负担不起免费提供给更多用户。希望10%的治疗概率足够了。</p><p id="4f37" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">我们使用来自<code class="fe nf ng nh ni b"><a class="ae ne" href="https://github.com/matteocourthoud/Blog-Posts/blob/main/notebooks/src/dgp.py" rel="noopener ugc nofollow" target="_blank">src.dgp</a></code>的数据生成过程<code class="fe nf ng nh ni b">dgp_premium()</code>生成模拟数据。我还从<code class="fe nf ng nh ni b"><a class="ae ne" href="https://github.com/matteocourthoud/Blog-Posts/blob/main/notebooks/src/utils.py" rel="noopener ugc nofollow" target="_blank">src.utils</a></code>引进了一些绘图函数和库。</p><pre class="kp kq kr ks gt nj ni nk nl aw nm bi"><span id="5338" class="nn mi iq ni b gy no np l nq nr">from src.utils import *<br/>from src.dgp import dgp_premium</span><span id="92fa" class="nn mi iq ni b gy ns np l nq nr">dgp = dgp_premium()<br/>df = dgp.generate_data(seed=5)<br/>df.head()</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="ab gu cl nt"><img src="../Images/01ed7f41cad2e3fa322002bc837f5921.png" data-original-src="https://miro.medium.com/v2/format:webp/1*tjjZ9ENVK58VUwVINW2R3Q.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">数据快照，图片由作者提供</p></figure><p id="653a" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">我们有300名用户的数据，我们观察他们生成的<code class="fe nf ng nh ni b">revenue</code>，以及他们是否被赋予了<code class="fe nf ng nh ni b">premium</code>特性。此外，我们还记录用户的<code class="fe nf ng nh ni b">age</code>。</p><p id="fea7" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">为了了解随机化是否有效，我们使用优步<code class="fe nf ng nh ni b"><a class="ae ne" href="https://causalml.readthedocs.io/" rel="noopener ugc nofollow" target="_blank">causalml</a></code>软件包中的<code class="fe nf ng nh ni b">create_table_one</code>函数制作了一个<strong class="lg ja">协变量平衡表</strong>，其中包含了我们在治疗组和对照组中可观察特征的平均值。顾名思义，这应该永远是你在因果推断分析中呈现的第一张表。</p><pre class="kp kq kr ks gt nj ni nk nl aw nm bi"><span id="832b" class="nn mi iq ni b gy no np l nq nr">from causalml.match import create_table_one<br/><br/>create_table_one(df, 'premium', ['age', 'revenue'])</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="ab gu cl nt"><img src="../Images/795192881bc166bd97439c14e203cb57.png" data-original-src="https://miro.medium.com/v2/format:webp/1*ivd4hcPz4-bpHYExeCiqSg.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">平衡表，作者图片</p></figure><p id="0fcd" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">大多数用户在控制组中，只有31个用户获得了高级功能。平均<code class="fe nf ng nh ni b">age</code>在各组之间具有可比性(标准化平均差异，SMD &lt; 0.1)，而高级功能似乎平均为每个用户增加了<code class="fe nf ng nh ni b">revenue</code>2.59美元。</p><p id="eb0d" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated"><code class="fe nf ng nh ni b">premium</code>功能<strong class="lg ja">的效果是否因用户<code class="fe nf ng nh ni b">age</code>而异</strong>？</p><p id="67bf" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">一个简单的方法可以是在<code class="fe nf ng nh ni b">premium</code>和年龄的完全交互上回归<code class="fe nf ng nh ni b">revenue</code>。</p><pre class="kp kq kr ks gt nj ni nk nl aw nm bi"><span id="503f" class="nn mi iq ni b gy no np l nq nr">linear_model = smf.ols('revenue ~ premium * age', data=df).fit()<br/>linear_model.summary().tables[1]</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nu"><img src="../Images/71563d4056a1650211b1e6bcad6077f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G9FxRnQpgwt9-1FOlJDOPQ.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">线性回归结果，图片由作者提供</p></figure><p id="3748" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">相互作用系数接近于零，不显著。似乎没有<code class="fe nf ng nh ni b">premium</code>对<code class="fe nf ng nh ni b">age</code>的微分作用。但这是真的吗？相互作用系数仅反映线性关系。如果关系是<strong class="lg ja">非线性</strong>怎么办？</p><p id="b92e" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">我们可以通过直接<strong class="lg ja">绘制原始数据</strong>来检查。我们通过<code class="fe nf ng nh ni b">age</code>绘制<code class="fe nf ng nh ni b">revenue</code>，在<code class="fe nf ng nh ni b">premium</code>用户和非高级用户之间分割数据。</p><pre class="kp kq kr ks gt nj ni nk nl aw nm bi"><span id="dba0" class="nn mi iq ni b gy no np l nq nr">sns.scatterplot(data=df, x='age', y='revenue', hue='premium', s=40);</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="ab gu cl nt"><img src="../Images/e83227a8c7784596ad206d8c0ecdf38f.png" data-original-src="https://miro.medium.com/v2/format:webp/1*IfvE-AkvRSK_txqxz79n1w.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">原始数据，作者图片</p></figure><p id="37a0" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">从原始数据来看，似乎30岁到50岁之间的人一般来说<code class="fe nf ng nh ni b">revenue</code>更高，而<code class="fe nf ng nh ni b">premium</code>对35岁到45岁之间的人有特别强的影响。</p><p id="19c5" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">我们可以<strong class="lg ja">想象</strong>按年龄划分的治疗和未治疗的估计收入。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="b57c" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">我们首先计算有(<em class="nx"> μ̂₁ </em>)和没有<code class="fe nf ng nh ni b">premium</code>特征(<em class="nx"> μ̂₀ </em>)的预测收入，并将它们与原始数据一起绘制出来。</p><pre class="kp kq kr ks gt nj ni nk nl aw nm bi"><span id="4f41" class="nn mi iq ni b gy no np l nq nr">df['mu0_hat'] = linear_model.predict(df.assign(premium=0))<br/>df['mu1_hat'] = linear_model.predict(df.assign(premium=1))<br/>plot_TE(df)</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="ab gu cl nt"><img src="../Images/fd8d6cc2254901f76419f080994c2616.png" data-original-src="https://miro.medium.com/v2/format:webp/1*SZM4J4wXitvZtqG8rT1cqA.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">带有线性估计的原始数据，按作者分类的图像</p></figure><p id="2a58" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">正如我们所见，橙色线高于蓝色线，表明<code class="fe nf ng nh ni b">premium</code>对<code class="fe nf ng nh ni b">revenue</code>有积极影响。然而，这两条线基本上是<strong class="lg ja">平行的</strong>，表明治疗效果没有异质性。</p><p id="d292" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">能不能再精确一点？有没有一种方法可以灵活地<strong class="lg ja">估计这种治疗异质性</strong>，而不需要假设函数形式？</p><p id="90b0" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">答案是<strong class="lg ja">是的</strong>！我们可以使用<strong class="lg ja">机器学习</strong>方法灵活估计异构治疗效果。特别是，我们将考察由<a class="ae ne" href="https://www.pnas.org/doi/abs/10.1073/pnas.1804597116" rel="noopener ugc nofollow" target="_blank">孔兹尔，塞孔，，于，(2019) </a>介绍的三种常用方法:</p><ul class=""><li id="b0ca" class="ny nz iq lg b lh li lk ll ln oa lr ob lv oc lz od oe of og bi translated">s-学习者</li><li id="edce" class="ny nz iq lg b lh oh lk oi ln oj lr ok lv ol lz od oe of og bi translated">网络学习者</li><li id="b80b" class="ny nz iq lg b lh oh lk oi ln oj lr ok lv ol lz od oe of og bi translated">X-learner</li></ul></div><div class="ab cl ma mb hu mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ij ik il im in"><h1 id="e610" class="mh mi iq bd mj mk ml mm mn mo mp mq mr kf ms kg mt ki mu kj mv kl mw km mx my bi translated">环境</h1><p id="b966" class="pw-post-body-paragraph le lf iq lg b lh mz ka lj lk na kd lm ln nb lp lq lr nc lt lu lv nd lx ly lz ij bi translated">我们假设对于一组主题<em class="nx"> i=1，…，n </em>，我们观察到一个元组<em class="nx"> (Xᵢ，Dᵢ，Yᵢ) </em>包括</p><ul class=""><li id="b598" class="ny nz iq lg b lh li lk ll ln oa lr ob lv oc lz od oe of og bi translated">一个治疗任务<em class="nx"> Dᵢ∈{0,1} </em> ( <code class="fe nf ng nh ni b">premium</code>)</li><li id="83cf" class="ny nz iq lg b lh oh lk oi ln oj lr ok lv ol lz od oe of og bi translated">一个回应<em class="nx"> Yᵢ∈ℝ </em> ( <code class="fe nf ng nh ni b">revenue</code>)</li><li id="4a2d" class="ny nz iq lg b lh oh lk oi ln oj lr ok lv ol lz od oe of og bi translated">一个特征向量<em class="nx"> Xᵢ∈ℝⁿ </em> ( <code class="fe nf ng nh ni b">age</code>)</li></ul><p id="bbab" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">我们感兴趣的是<strong class="lg ja">估计平均治疗效果</strong>。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi om"><img src="../Images/8819a7b7e463d55e7b1415df639a1ea6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FrC5yzZyE8h48eP-IK1ZrA.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">平均治疗效果，图片由作者提供</p></figure><p id="711a" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">其中<em class="nx">yᵢ⁽</em>ᵈ⁾<em class="nx">t41】表示个体<em class="nx"> i </em>在处理状态<em class="nx"> d </em>下的潜在结果。我们还做了以下假设。</em></p><p id="1485" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated"><strong class="lg ja">假设1:未发现</strong>(或可忽略，或可观的选择)</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi on"><img src="../Images/8808d1e2b53fc71aaab95c8e6aef91fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HeK236XDDPAxReNxHE5ReA.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">无根据假设，作者的图像</p></figure><p id="beaa" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">即以可观察的特征<em class="nx"> X </em>为条件，处理分配<em class="nx"> D </em>几乎是随机的。我们实际假设的是，没有我们没有观察到的其他特征会影响用户是否获得<code class="fe nf ng nh ni b">premium</code>功能和他们的<code class="fe nf ng nh ni b">revenue</code>。这是一个<strong class="lg ja">强假设</strong>，我们观察到的个人特征越多，这个假设就越有可能得到满足。</p><p id="6ffe" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated"><strong class="lg ja">假设2:稳定单位治疗值(SUTVA) </strong></p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oo"><img src="../Images/a1e3e3ecbc7ec73c1b7e49d53dd0971f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PskJW0VrMxjX0bzOgpcOXQ.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">萨特瓦假设，作者图片</p></figure><p id="82cd" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">即潜在的结果不取决于治疗状态。在我们的例子中，我们排除了另一个用户使用<code class="fe nf ng nh ni b">premium</code>功能可能会影响我的<code class="fe nf ng nh ni b">premium</code>对<code class="fe nf ng nh ni b">revenue</code>的影响。违反SUTVA的最常见设置是存在<strong class="lg ja">网络效应</strong>:我的一个朋友使用社交网络增加了我使用它的效用。</p></div><div class="ab cl ma mb hu mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ij ik il im in"><h2 id="82d3" class="nn mi iq bd mj op oq dn mn or os dp mr ln ot ou mt lr ov ow mv lv ox oy mx iw bi translated">s-学习者</h2><p id="44d7" class="pw-post-body-paragraph le lf iq lg b lh mz ka lj lk na kd lm ln nb lp lq lr nc lt lu lv nd lx ly lz ij bi translated">最简单的元算法是<strong class="lg ja">单一学习器或S-学习器</strong>。为了构建S-learner估计器，我们为所有观察值拟合了一个<strong class="lg ja">单一模型</strong> <em class="nx"> μ </em>。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oz"><img src="../Images/6187a9b8ba9778a2f161143c6b79f9ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TWYzHBY7iVj2DkJRZ022mA.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">s-学习者反应函数，图片由作者提供</p></figure><p id="7434" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">估计量由处理前后的预测值之差给出，分别为<em class="nx"> d=1 </em>和<em class="nx"> d=0 </em>。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pa"><img src="../Images/9125a792f27ace02c4cf2b615d55f417.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OENKlt2M-3YUCyQKDUod4A.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">s-学习者评估者，作者图片</p></figure><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="e46c" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">让我们使用<a class="ae ne" href="https://en.wikipedia.org/wiki/Decision_tree_learning" rel="noopener ugc nofollow" target="_blank"> <strong class="lg ja">决策树回归</strong> </a>模型来构建S-learner，使用<code class="fe nf ng nh ni b"><a class="ae ne" href="https://scikit-learn.org/" rel="noopener ugc nofollow" target="_blank">sklearn</a></code>包中的<code class="fe nf ng nh ni b">DecisionTreeRegressor</code>函数。我不会在这里详细介绍决策树，但我只想说，它是一种非参数估计器，使用训练数据将状态空间(在我们的情况下为<code class="fe nf ng nh ni b">premium</code>和<code class="fe nf ng nh ni b">age</code>)分成多个块，并预测结果(在我们的情况下为<code class="fe nf ng nh ni b">revenue</code>)作为每个块内的平均值。</p><pre class="kp kq kr ks gt nj ni nk nl aw nm bi"><span id="29c9" class="nn mi iq ni b gy no np l nq nr">from sklearn.tree import DecisionTreeRegressor<br/><br/>model = DecisionTreeRegressor(min_impurity_decrease=0.001)<br/>S_learner(dgp, model, y="revenue", D="premium", X=["age"])</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="ab gu cl nt"><img src="../Images/36688ed1f11cb6b47ca818e48a1a560c.png" data-original-src="https://miro.medium.com/v2/format:webp/1*qVrUYTFaT2yzBA4cVH86rQ.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">估计的和真实的治疗效果，图片由作者提供</p></figure><p id="379d" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">该图描绘了数据以及响应函数<em class="nx"> μ̂(x,1) </em>和<em class="nx"> μ̂(x,0) </em>。我还用灰色标出了真实反应函数之间的区域:真实的治疗效果。</p><p id="7532" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">正如我们所看到的，S-learner足够灵活，能够理解治疗组和对照组之间的水平存在<strong class="lg ja">差异(我们有两条线)。它还很好地捕捉了对照组<em class="nx">【μ̂(x,1】</em>的响应函数，但是不太好地捕捉了治疗组<em class="nx">【μ̂(x,1】</em>的控制函数。</strong></p><p id="ca41" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">S-learner的<strong class="lg ja">问题</strong>是它正在学习一个<strong class="lg ja">单一模型</strong>，所以我们不得不希望该模型揭示了治疗<em class="nx"> D </em>中的异质性，但事实可能并非如此。此外，如果模型由于<em class="nx"> X </em>的高维度而被严重正则化，则<strong class="lg ja">可能无法恢复任何治疗效果</strong>。例如，对于决策树，我们可能不会在治疗变量<em class="nx"> D </em>上分裂。</p></div><div class="ab cl ma mb hu mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ij ik il im in"><h2 id="f304" class="nn mi iq bd mj op oq dn mn or os dp mr ln ot ou mt lr ov ow mv lv ox oy mx iw bi translated">网络学习者</h2><p id="0d8d" class="pw-post-body-paragraph le lf iq lg b lh mz ka lj lk na kd lm ln nb lp lq lr nc lt lu lv nd lx ly lz ij bi translated">为了构建<strong class="lg ja">双学习器或T学习器</strong>估计器，我们装配了<strong class="lg ja">两个不同的模型</strong>，一个用于处理单元，一个用于控制单元。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pb"><img src="../Images/ec5f0c378c334bfe0a6890c321de29df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kybmgSJTgsdU1n35GijSDw.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">t-学习者反应函数，作者图片</p></figure><p id="12f4" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">估计量由两个模型的预测值之差给出。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pc"><img src="../Images/b234725136c51cf459166ecd7fa02974.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X8Kc3hro8s2WJxXTZ_ItkA.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">T-learner估算器，图片由作者提供</p></figure><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="659a" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">我们像以前一样使用决策树回归模型，但是这一次，我们为治疗组和对照组拟合了两个独立的决策树。</p><pre class="kp kq kr ks gt nj ni nk nl aw nm bi"><span id="3d9f" class="nn mi iq ni b gy no np l nq nr">T_learner(dgp, model, y="revenue", D="premium", X=["age"])</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="ab gu cl nt"><img src="../Images/7a40a30a0cf5f046dcf3ee72bf166f3d.png" data-original-src="https://miro.medium.com/v2/format:webp/1*-azSJdoZUDnvEssi6lwuoQ.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">真实和估计的治疗效果，图片由作者提供</p></figure><p id="9dde" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">正如我们所见，T型学习者比S型学习者更加灵活，因为它适合两种不同的模式。对照组的反应函数<em class="nx"> μ̂ </em> ⁽⁰⁾( <em class="nx"> x </em>仍然非常准确，而治疗组的反应函数<em class="nx"> μ̂ </em> ⁽ ⁾( <em class="nx"> x </em>比以前更加灵活。</p><p id="0c82" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">现在的<strong class="lg ja">问题</strong>是我们<strong class="lg ja">只使用了每个预测问题</strong>的一小部分数据，而S-learner使用了所有的数据。通过拟合两个独立的模型，我们丢失了一些信息。此外，通过使用两个不同的模型，我们可能会在没有异质性的地方得到异质性。例如，使用决策树，即使数据生成过程是相同的，我们也可能得到不同样本的不同分裂。</p></div><div class="ab cl ma mb hu mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ij ik il im in"><h2 id="0f2a" class="nn mi iq bd mj op oq dn mn or os dp mr ln ot ou mt lr ov ow mv lv ox oy mx iw bi translated">X-learner</h2><p id="a83e" class="pw-post-body-paragraph le lf iq lg b lh mz ka lj lk na kd lm ln nb lp lq lr nc lt lu lv nd lx ly lz ij bi translated"><strong class="lg ja">交叉学习者或X-学习者</strong>估算器是T-学习者估算器的<strong class="lg ja">扩展</strong>。它是通过以下方式构建的:</p><ol class=""><li id="3629" class="ny nz iq lg b lh li lk ll ln oa lr ob lv oc lz pd oe of og bi translated">对于T-learner，分别使用处理单元和控制单元计算<strong class="lg ja">μ̂<em class="nx">⁽⁾(</em>x和<em class="nx"> μ̂ </em> ⁽⁰⁾( <em class="nx"> x </em>的独立模型</strong></li><li id="ef83" class="ny nz iq lg b lh oh lk oi ln oj lr ok lv ol lz pd oe of og bi translated">计算中间δ函数，如下所示</li></ol><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nu"><img src="../Images/0dc3ce48fbfba6f1fc80c7f5e2260b07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0Em9NJ-6Dvoqa5h23qLIOg.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">中间delta函数，图片由作者提供</p></figure><p id="1326" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">3.从<em class="nx"> X </em>预测δ，从处理单元计算<em class="nx"> τ̂ </em> ⁽ ⁾( <em class="nx"> x </em>，从控制单元计算<em class="nx"> τ̂ </em> ⁽⁰⁾( <em class="nx"> x </em></p><p id="6979" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">4.估计<a class="ae ne" href="https://en.wikipedia.org/wiki/Propensity_score_matching" rel="noopener ugc nofollow" target="_blank"> <strong class="lg ja">倾向得分</strong> </a>，即被治疗的概率</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pe"><img src="../Images/9006989d59e0ad13a2c8ac45f6c1ae18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H7oTDUWAqjyGDCYAj68hyg.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">倾向得分，按作者分类的图像</p></figure><p id="043a" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">5.计算治疗效果</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pf"><img src="../Images/0fb13ce81e08fbe985880243a4acc059.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EguXuRnhifTOQ_uX4HbUpA.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">X-learner估算器，图片由作者提供</p></figure><p id="e8f4" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">为了更好地理解X-learner是如何工作的，我们想像以前一样用<strong class="lg ja">画出响应函数</strong>。然而，该方法不直接依赖于响应函数。我们还能恢复出<strong class="lg ja">伪响应函数</strong>吗？是啊！</p><p id="d8b9" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">首先，我们可以将治疗效果改写为</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pg"><img src="../Images/cf9277a9f111d83b2697e46fb229f866.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2DFLs-ckc4E2r_um3nf0dA.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">X-learner估计器分解，按作者分类的图像</p></figure><p id="3935" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">因此X学习者估计的伪响应函数是</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ph"><img src="../Images/f4177b0ac173cfbd73cb8a069ec9a1f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zHXipxPZ3Ey4wGUZU5HUAQ.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">x-学习者伪响应函数，图片由作者提供</p></figure><p id="9452" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">如我们所见，X-learner将真实值<em class="nx"> Yᵢ </em> ⁽ᵈ⁾与估计值<em class="nx"> μ̂ᵢ </em> ⁽ᵈ⁾ <em class="nx"> (x) </em>通过<a class="ae ne" href="https://en.wikipedia.org/wiki/Propensity_score_matching" rel="noopener ugc nofollow" target="_blank"> <strong class="lg ja">倾向得分</strong></a><em class="nx">【eᵢ(x】</em>加权，即估计的治疗概率。</p><p id="9609" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated"><strong class="lg ja">什么意思？</strong>这意味着如果对于一些可观测量，我们可以明确区分治疗组和对照组，那么控制反应函数<em class="nx"> μ̂ᵢ </em> ⁽ᵈ⁾将获得大部分权重。相反，如果这两个群体无法区分，那么实际的结果Yᵢ和⁽ᵈ⁾将会得到大部分的权重。</p><p id="38ac" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">为了说明这种方法，我将使用<code class="fe nf ng nh ni b">KNeighborsRegressor</code>函数，通过使用最近的观测值来逼近<em class="nx"> Yᵢ </em> ⁽ᵈ⁾，从而构建伪响应函数。我使用<code class="fe nf ng nh ni b">LogisticRegressionCV</code>函数通过<a class="ae ne" href="https://en.wikipedia.org/wiki/Logistic_regression" rel="noopener ugc nofollow" target="_blank">逻辑回归</a>估计倾向得分。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nv nw l"/></div></figure><pre class="kp kq kr ks gt nj ni nk nl aw nm bi"><span id="38dd" class="nn mi iq ni b gy no np l nq nr">X_learner(df, model, y="revenue", D="premium", X=["age"])</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="ab gu cl nt"><img src="../Images/3effc05e885c407db8e954046ae59622.png" data-original-src="https://miro.medium.com/v2/format:webp/1*ePQrTotrtpkKh3ZpbzhSzA.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">真实和估计的治疗效果，图片由作者提供</p></figure><p id="a400" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">从这个图表中我们可以清楚地看到,<strong class="lg ja"> X-learner </strong>的主要优势在于它使响应函数的<strong class="lg ja">灵活性</strong>适应环境。在我们有大量数据的状态空间区域(对照组)，它主要使用估计的响应函数，在数据很少的状态空间区域(治疗组)，它使用观察值本身。</p></div><div class="ab cl ma mb hu mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ij ik il im in"><h1 id="e27b" class="mh mi iq bd mj mk ml mm mn mo mp mq mr kf ms kg mt ki mu kj mv kl mw km mx my bi translated">结论</h1><p id="1a19" class="pw-post-body-paragraph le lf iq lg b lh mz ka lj lk na kd lm ln nb lp lq lr nc lt lu lv nd lx ly lz ij bi translated">在这篇文章中，我们已经看到了由<a class="ae ne" href="https://www.pnas.org/doi/abs/10.1073/pnas.1804597116" rel="noopener ugc nofollow" target="_blank">孔兹尔，，于，(2019) </a>介绍的不同估计器，它们利用灵活的<strong class="lg ja">机器学习</strong>算法来估计<strong class="lg ja">异质治疗效果</strong>。估计量在复杂程度上有所不同:S-learner适合包含治疗指标作为协变量的单个估计量。T-learner适用于治疗组和对照组的两个独立的估计量。最后，X-learner是T-learner的扩展，它允许不同程度的灵活性，这取决于治疗组和对照组之间可用的数据量。</p><p id="5b6a" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">对于以为目标的<strong class="lg ja">治疗来说，对异质治疗效果的评估是必不可少的，这在行业中尤为重要。事实上，这种文学现在发展很快，受到很多关注。在许多其他论文中，值得一提的是<a class="ae ne" href="https://academic.oup.com/biomet/article/108/2/299/5911092" rel="noopener ugc nofollow" target="_blank"> Nie and Wager (2021) </a>的R-learner程序和<a class="ae ne" href="https://www.tandfonline.com/doi/full/10.1080/01621459.2017.1319839" rel="noopener ugc nofollow" target="_blank"> Athey and Wager (2018) </a>的因果树和森林。我可能会在未来写更多关于这些程序的文章，所以，请继续关注☺️</strong></p><h2 id="b5d2" class="nn mi iq bd mj op oq dn mn or os dp mr ln ot ou mt lr ov ow mv lv ox oy mx iw bi translated">参考</h2><p id="9572" class="pw-post-body-paragraph le lf iq lg b lh mz ka lj lk na kd lm ln nb lp lq lr nc lt lu lv nd lx ly lz ij bi translated">[1] S. Künzel，J. Sekhon，p .，B. Yu，<a class="ae ne" href="https://www.pnas.org/doi/abs/10.1073/pnas.1804597116" rel="noopener ugc nofollow" target="_blank">利用机器学习估计异质治疗效果的金属学者</a> (2019)，<em class="nx"/>。</p><p id="6304" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">[2] X. Nie，S. Wager，<a class="ae ne" href="https://academic.oup.com/biomet/article/108/2/299/5911092" rel="noopener ugc nofollow" target="_blank">异质处理效应的拟甲骨文估计</a> (2021)，<em class="nx"> Biometrika </em>。</p><p id="3a1c" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">[3] S. Athey，S. Wager，<a class="ae ne" href="https://www.tandfonline.com/doi/full/10.1080/01621459.2017.1319839" rel="noopener ugc nofollow" target="_blank">利用随机森林估计和推断异质处理效应</a> (2018)，<em class="nx">美国统计协会杂志</em>。</p><h2 id="7288" class="nn mi iq bd mj op oq dn mn or os dp mr ln ot ou mt lr ov ow mv lv ox oy mx iw bi translated">相关文章</h2><ul class=""><li id="e424" class="ny nz iq lg b lh mz lk na ln pi lr pj lv pk lz od oe of og bi translated">匹配、加权还是回归？</li><li id="6aa7" class="ny nz iq lg b lh oh lk oi ln oj lr ok lv ol lz od oe of og bi translated"><a class="ae ne" rel="noopener" target="_blank" href="/b63dc69e3d8c">Dag和控制变量</a></li></ul><h2 id="1fee" class="nn mi iq bd mj op oq dn mn or os dp mr ln ot ou mt lr ov ow mv lv ox oy mx iw bi translated">密码</h2><p id="b1d4" class="pw-post-body-paragraph le lf iq lg b lh mz ka lj lk na kd lm ln nb lp lq lr nc lt lu lv nd lx ly lz ij bi translated">你可以在这里找到Jupyter的原始笔记本:</p><div class="pl pm gp gr pn po"><a href="https://github.com/matteocourthoud/Blog-Posts/blob/main/notebooks/meta.ipynb" rel="noopener  ugc nofollow" target="_blank"><div class="pp ab fo"><div class="pq ab pr cl cj ps"><h2 class="bd ja gy z fp pt fr fs pu fu fw iz bi translated">Blog-Posts/meta . ipynb at main matter courthoud/Blog-Posts</h2><div class="pv l"><h3 class="bd b gy z fp pt fr fs pu fu fw dk translated">我的中型博客文章的代码和笔记本。为matteocourthoud/Blog-Posts的发展作出贡献</h3></div><div class="pw l"><p class="bd b dl z fp pt fr fs pu fu fw dk translated">github.com</p></div></div><div class="px l"><div class="py l pz qa qb px qc ky po"/></div></div></a></div></div><div class="ab cl ma mb hu mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ij ik il im in"><h2 id="4f95" class="nn mi iq bd mj op oq dn mn or os dp mr ln ot ou mt lr ov ow mv lv ox oy mx iw bi translated">感谢您的阅读！</h2><p id="015a" class="pw-post-body-paragraph le lf iq lg b lh mz ka lj lk na kd lm ln nb lp lq lr nc lt lu lv nd lx ly lz ij bi translated">我真的很感激！🤗<em class="nx">如果你喜欢这个帖子并想看更多，可以考虑</em> <a class="ae ne" href="https://medium.com/@matteo.courthoud" rel="noopener"> <strong class="lg ja"> <em class="nx">关注我</em> </strong> </a> <em class="nx">。我每周发布一次与因果推断和数据分析相关的主题。我尽量让我的帖子简单而精确，总是提供代码、例子和模拟。</em></p><p id="9bc9" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated"><em class="nx">还有，一个小小的</em> <strong class="lg ja"> <em class="nx">免责声明</em> </strong> <em class="nx">:我写作是为了学习所以错误是家常便饭，尽管我尽了最大努力。当你发现他们的时候，请告诉我。也很欣赏新话题的建议！</em></p></div></div>    
</body>
</html>