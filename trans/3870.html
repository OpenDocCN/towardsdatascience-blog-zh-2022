<html>
<head>
<title>IVFPQ + HNSW for Billion-scale Similarity Search</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">IVFPQ + HNSW用于十亿级相似性搜索</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/ivfpq-hnsw-for-billion-scale-similarity-search-89ff2f89d90e#2022-08-29">https://towardsdatascience.com/ivfpq-hnsw-for-billion-scale-similarity-search-89ff2f89d90e#2022-08-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="44c3" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">十亿级矢量数据集的最佳索引方法</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/113e2889856628e1899e38af95b753f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5cS2Mbgb8mylgGEH"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">保罗·塔尔博特在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="ba7d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们在上一篇文章中了解了<a class="ae ky" rel="noopener" target="_blank" href="/similarity-search-with-ivfpq-9c6348fd4db3"> <strong class="lb iu"> IVFPQ </strong> </a>，其中倒排文件索引(IVF)与<a class="ae ky" rel="noopener" target="_blank" href="/product-quantization-for-similarity-search-2f1f67c5fddd">乘积量化</a> (PQ)相结合，创建了一种有效的大规模相似性搜索方法。</p><div class="lv lw gp gr lx ly"><a rel="noopener follow" target="_blank" href="/similarity-search-with-ivfpq-9c6348fd4db3"><div class="lz ab fo"><div class="ma ab mb cl cj mc"><h2 class="bd iu gy z fp md fr fs me fu fw is bi translated">使用IVFPQ进行相似性搜索</h2><div class="mf l"><h3 class="bd b gy z fp md fr fs me fu fw dk translated">了解如何实现倒排文件索引(IVF)以及产品量化(PQ ),以实现快速有效的…</h3></div><div class="mg l"><p class="bd b dl z fp md fr fs me fu fw dk translated">towardsdatascience.com</p></div></div><div class="mh l"><div class="mi l mj mk ml mh mm ks ly"/></div></div></a></div><div class="lv lw gp gr lx ly"><a rel="noopener follow" target="_blank" href="/product-quantization-for-similarity-search-2f1f67c5fddd"><div class="lz ab fo"><div class="ma ab mb cl cj mc"><h2 class="bd iu gy z fp md fr fs me fu fw is bi translated">用于相似性搜索的产品量化</h2><div class="mf l"><h3 class="bd b gy z fp md fr fs me fu fw dk translated">如何在内存中压缩和适应一个庞大的向量集，以便用非对称距离计算进行相似性搜索…</h3></div><div class="mg l"><p class="bd b dl z fp md fr fs me fu fw dk translated">towardsdatascience.com</p></div></div><div class="mh l"><div class="mn l mj mk ml mh mm ks ly"/></div></div></a></div><p id="524a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们将了解<strong class="lb iu"> HNSW </strong>以及它如何与IVFPQ一起使用，以形成十亿级相似性搜索的最佳索引方法。</p><p id="c1e9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将首先介绍NSW和skip list，这是构建HNSW的两个重要基础。我们还将介绍如何使用<a class="ae ky" href="https://github.com/facebookresearch/faiss" rel="noopener ugc nofollow" target="_blank"> Faiss </a>实现HNSW，不同参数设置的效果，以及HNSW索引的不同变体如何在搜索质量、速度和内存使用方面进行比较。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="b5a1" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated"><strong class="ak">内容</strong></h1><p id="a95a" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated"><a class="ae ky" href="#80cb" rel="noopener ugc nofollow"> <strong class="lb iu"> 1。简介</strong> </a> <br/> <a class="ae ky" href="#427b" rel="noopener ugc nofollow"> <strong class="lb iu"> 2。可导航小世界(新州)</strong> </a> <br/> ∘ <a class="ae ky" href="#2c8e" rel="noopener ugc nofollow"> (A)新州—建设</a> <br/> ∘ <a class="ae ky" href="#2a7b" rel="noopener ugc nofollow"> (B)新州—搜索</a> <br/> <a class="ae ky" href="#1469" rel="noopener ugc nofollow"> <strong class="lb iu"> 3 .跳过清单</strong> </a> <br/> <a class="ae ky" href="#57a8" rel="noopener ugc nofollow"> <strong class="lb iu"> 4。分层可导航小世界(hnsw)</strong></a><br/>∘<a class="ae ky" href="#4f45" rel="noopener ugc nofollow">(a)hnsw—构造</a> <br/> ∘ <a class="ae ky" href="#0582" rel="noopener ugc nofollow">插入过程</a> <br/> ∘ <a class="ae ky" href="#2a02" rel="noopener ugc nofollow">启发式选择</a> <br/> ∘ <a class="ae ky" href="#4dbd" rel="noopener ugc nofollow"> (B) HNSW —搜索</a> <br/> <a class="ae ky" href="#c7d8" rel="noopener ugc nofollow"> <strong class="lb iu"> 5 .用Faiss实现:indexhnswflat</strong></a><br/>∘<a class="ae ky" href="#9342" rel="noopener ugc nofollow">效果的m，efConstruction，和efSearch </a> <br/> <a class="ae ky" href="#9718" rel="noopener ugc nofollow"> <strong class="lb iu"> 6。用Faiss实现:IndexIVFPQ+HNSW</strong></a><br/><a class="ae ky" href="#c8f9" rel="noopener ugc nofollow"><strong class="lb iu">7。HNSW指标对比(有/无IVF和/或PQ) </strong> </a> <br/> <a class="ae ky" href="#baa5" rel="noopener ugc nofollow"> <strong class="lb iu"> 8。概要</strong> </a></p><h1 id="80cb" class="mv mw it bd mx my ns na nb nc nt ne nf jz nu ka nh kc nv kd nj kf nw kg nl nm bi translated">1.介绍</h1><p id="1fa7" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">图由顶点和边组成。边是连接两个顶点的线。让我们称连接的顶点为朋友。</p><p id="6ca6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在向量的世界中，相似的向量通常彼此靠近。因此，如果向量被表示为图上的顶点，逻辑上，靠近在一起的顶点(即，具有高相似性的向量)应该被连接为<em class="nx">朋友</em>。即使他们没有作为朋友<em class="nx">连接在一起</em>，他们也应该可以很容易地通过一两个顶点到达彼此。</p><p id="339e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于一个可导航的图，每个顶点都必须有朋友。否则就没有办法到达顶点。有<em class="nx">个朋友</em>很好，但是有太多的<em class="nx">个朋友</em>对一个图来说代价会很大。想想保持这些连接所需的内存和存储，以及在搜索期间比较距离所需的计算次数。</p><p id="f1cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通常，我们不希望图形看起来像下面这样。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/e1a44f9262143ae6aa2ee67678a87a9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1126/format:webp/1*JwTICgHIh6vs_1O011g2Ow.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">除非另有说明，所有图片均为作者所有</p></figure><blockquote class="nz"><p id="a2e7" class="oa ob it bd oc od oe of og oh oi lu dk translated">我们想要的是一个具有<a class="ae ky" href="https://en.wikipedia.org/wiki/Small-world_network" rel="noopener ugc nofollow" target="_blank">小世界网络</a>特性的可导航图，其中每个顶点只有少量的连接，并且两个随机选择的顶点之间的平均跳数很低。</p></blockquote><h1 id="427b" class="mv mw it bd mx my ns na nb nc nt ne nf jz oj ka nh kc ok kd nj kf ol kg nl nm bi translated">2.可航行的小世界(新南威尔士州)</h1><p id="12d1" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">从概念上讲，使用Delaunay图(或<a class="ae ky" href="https://en.wikipedia.org/wiki/Delaunay_triangulation" rel="noopener ugc nofollow" target="_blank"> Delaunay三角剖分</a>)进行近似最近邻搜索似乎是理想的，因为彼此靠近的顶点是<em class="nx">朋友</em>，并且不存在孤立的顶点。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi om"><img src="../Images/1ed5586539a7af335c7f2d9564fc3134.png" data-original-src="https://miro.medium.com/v2/resize:fit:1020/format:webp/1*daNXIidBtHpNHyOnMo5LMA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">一个Delaunay图的例子</p></figure><p id="c16c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，构建一个Delaunay图并不容易和直接，并且搜索效率只是次优的。例如，如果两个顶点A和B相距很远，我们需要通过大量从A开始的<em class="nx">友</em>连接才能到达B，反之亦然。</p><p id="ced5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，新南威尔士州使用一种更简单的方法来构建Delaunay图的近似值，而不是构建精确的Delaunay图。</p><h2 id="2c8e" class="on mw it bd mx oo op dn nb oq or dp nf li os ot nh lm ou ov nj lq ow ox nl oy bi translated">新南威尔士州——建筑</h2><p id="f96b" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">NSW图是通过以随机顺序一个接一个地插入顶点来构建的(即向量首先被打乱)。</p><blockquote class="nz"><p id="a4e0" class="oa ob it bd oc od oz pa pb pc pd lu dk translated">当插入一个新顶点时，它将连接到与其最近的现有顶点。</p></blockquote><p id="5ebe" class="pw-post-body-paragraph kz la it lb b lc pi ju le lf pj jx lh li pk lk ll lm pl lo lp lq pm ls lt lu im bi translated">在下图中，<code class="fe pe pf pg ph b">M</code>被设置为3。我们从插入a开始。此时，图中没有其他顶点。接下来，我们插入B。由于图中只有A，我们将B连接到A。然后我们插入C。现在图中只有A和B，所以我们将C连接到A和B。接下来，我们插入D。同样，由于图中只有A，B和C，我们将D连接到A，B和C。</p><p id="d8db" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，当我们插入E时，图中有四个其他顶点，即A、B、C和d。由于<code class="fe pe pf pg ph b">M</code>设置为3，我们只将E连接到最近的三个顶点，即B、C和d</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pn"><img src="../Images/8c2cd52f6323914326c34026696fcb26.png" data-original-src="https://miro.medium.com/v2/resize:fit:764/format:webp/1*VOjUe1ufbAt2YN5RgLrjkg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">用<code class="fe pe pf pg ph b">M=3</code>构建NSW图</p></figure><p id="e015" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们继续以这种方式插入顶点并构建图形，我们可以得到如下所示的NSW图形。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi po"><img src="../Images/4562615f3e1c68daf4f2c969fb02d32c.png" data-original-src="https://miro.medium.com/v2/resize:fit:766/format:webp/1*mWe6b0Z82HremetXRlQV0A.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">新南威尔士州图表示例</p></figure><p id="be04" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">随着越来越多的顶点被插入，可以观察到在早期阶段建立的一些连接已经变成了长距离链接。例如，看看上图中的链接“A — B”和“C — D”。</p><h2 id="2a7b" class="on mw it bd mx oo op dn nb oq or dp nf li os ot nh lm ou ov nj lq ow ox nl oy bi translated">新南威尔士州——搜索</h2><p id="f760" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">在新南威尔士州图上的搜索遵循简单的贪婪搜索方法。</p><blockquote class="nz"><p id="551d" class="oa ob it bd oc od oz pa pb pc pd lu dk translated">在每一步中仅使用局部信息，并且不需要数据的维度或分布的先验全局知识。这就是新州的妙处，可以从任何一个顶点发起搜索。</p></blockquote><p id="d03a" class="pw-post-body-paragraph kz la it lb b lc pi ju le lf pj jx lh li pk lk ll lm pl lo lp lq pm ls lt lu im bi translated">可以随机选择搜索的入口点。从当前点开始，该算法将试图找到离查询向量最近的<em class="nx">朋友</em>，并向该顶点移动。</p><p id="aec2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如下所述，重复该步骤，直到它再也找不到任何比自己更接近查询向量的<em class="nx">朋友</em>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pp"><img src="../Images/6a07c437eb93246ffa92819e100613d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1362/format:webp/1*GoHviEFZ7RzyZ9yIGNnqzw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在新南威尔士州图上搜索最近邻(示例1)</p></figure><p id="c6fc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下图显示了在构建的早期阶段创建的远程链接如何有利于一些搜索案例。在这个例子中，入口点、A和查询向量位于图的相对两端。由于长距离链接“A — B”，搜索过程只需两跳(A→B→K)即可到达查询向量的最近邻居。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pq"><img src="../Images/0a4ba106a3bd3fbaf0a6c90f2935244c.png" data-original-src="https://miro.medium.com/v2/resize:fit:860/format:webp/1*9vtkt5FobU6sYH_G8-2wXw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在新南威尔士州图上搜索最近邻(示例2)</p></figure><p id="620e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">新南威尔士州的搜索质量可以通过使用随机入口点执行多次搜索来提高。</p><h1 id="1469" class="mv mw it bd mx my ns na nb nc nt ne nf jz nu ka nh kc nv kd nj kf nw kg nl nm bi translated">3.跳过列表</h1><p id="7721" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated"><a class="ae ky" href="https://en.wikipedia.org/wiki/Skip_list" rel="noopener ugc nofollow" target="_blank">跳表</a>是W. Pugh [3]发明的一种数据结构，基于<a class="ae ky" href="https://en.wikipedia.org/wiki/Linked_list" rel="noopener ugc nofollow" target="_blank">链表</a>构建，元素排序。</p><p id="751d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是一个链表的例子，其中的元素已经排序。链表上的节点包含元素的值和指向下一个元素的指针。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pr"><img src="../Images/2ee45a37a9a1cf3d33a4af13515b0317.png" data-original-src="https://miro.medium.com/v2/resize:fit:1138/format:webp/1*063HYp53Z48c6ulA-l_mYg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">具有排序元素的链表</p></figure><p id="745b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">跳表由多层链表组成，其中原始链表在最底层(0级)。较高的级别包含在级别0上找到的相同元素，但只是它们的子集。级别越高，元素的数量越少。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ps"><img src="../Images/9f9fe3a512130479aa6070bd92ba1a81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1222/format:webp/1*1Gigm34wH9drlhg6Vvm6SQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">跳转列表数据结构</p></figure><blockquote class="nz"><p id="1e8f" class="oa ob it bd oc od oe of og oh oi lu dk translated">跳过列表的上层充当高速公路，因为一些元素在遍历期间被跳过。</p></blockquote><p id="d461" class="pw-post-body-paragraph kz la it lb b lc pi ju le lf pj jx lh li pk lk ll lm pl lo lp lq pm ls lt lu im bi translated">这使得在跳过列表中快速搜索元素。搜索从最顶层开始，遍历节点，只有当前指针指向下一个值大于要搜索的值的元素时，才向下搜索。</p><p id="7b11" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，搜索‘91’只需要遍历3个节点，如果要在原始链表上进行搜索，则需要遍历8个节点。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pt"><img src="../Images/14b14313aa1fd6f6c539a27406167a79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1226/format:webp/1*xaqTzKULefkMU2RytJIqvA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在跳过列表中搜索91</p></figure><h1 id="57a8" class="mv mw it bd mx my ns na nb nc nt ne nf jz nu ka nh kc nv kd nj kf nw kg nl nm bi translated">4.分层可导航小世界</h1><p id="f07d" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">HNSW是新南威尔士州的新发展，其中的层次结构构成了一种优雅的细化，其灵感来自于skip list的分层结构。</p><p id="8418" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">HNSW中的分层组合将不同长度的链路分成不同的层。远程链接可以在上层找到，而短程链接在底层。</p><p id="b6fc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">长距离链接在减少到达正在寻找的最近邻居附近所花费的时间和精力方面起着重要的作用。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pu"><img src="../Images/d2a39a9cb9418ff5a96e08e746a1c644.png" data-original-src="https://miro.medium.com/v2/resize:fit:1004/format:webp/1*CCA6dJk5JllrvbRXf3R3BA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">HNSW的一个例子</p></figure><h2 id="4f45" class="on mw it bd mx oo op dn nb oq or dp nf li os ot nh lm ou ov nj lq ow ox nl oy bi translated">HNSW——建筑</h2><p id="bae2" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">HNSW的构建与NSW非常相似，其中的图结构也是通过一个接一个地插入顶点来增量构建的。</p><p id="e4ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，与NSW不同，顶点在插入之前不需要被打乱。这是因为HNSW中的随机效应是由水平随机化完成的。这是如何工作的？</p><p id="ed50" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">嗯，在构建图形的过程中，每个顶点被随机分配一个整数，<code class="fe pe pf pg ph b">ℓ</code>，表示该顶点所在的最大层数。例如，如果一个顶点被赋予了<code class="fe pe pf pg ph b">ℓ=3</code>，那么我们可以找到存在于第2层、第1层和第0层的顶点。</p><blockquote class="nz"><p id="e861" class="oa ob it bd oc od oz pa pb pc pd lu dk translated">“以指数衰减概率分布随机选择元素所在的最大层”——<a class="ae ky" href="https://arxiv.org/abs/1603.09320" rel="noopener ugc nofollow" target="_blank">y . Malkov和D. Yashunin </a></p></blockquote><p id="ec2b" class="pw-post-body-paragraph kz la it lb b lc pi ju le lf pj jx lh li pk lk ll lm pl lo lp lq pm ls lt lu im bi translated">这使得<code class="fe pe pf pg ph b">ℓ=1</code>成为顶点最有可能收到的赋值，并且获得更大的<code class="fe pe pf pg ph b">ℓ</code>值的概率极低。</p><p id="2c61" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，大多数顶点总是出现在第0层。随着级别数的增加，这些级别上的顶点数会显著减少。为了了解<code class="fe pe pf pg ph b">ℓ</code>的分布情况，请看下面来自50万个向量的随机数据集的样本。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pv"><img src="../Images/096ce3de2e66adec0eaa0353a50bc5b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:862/format:webp/1*YbbzXhsPjFOgzmfwrj6k_A.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来自500，000个向量的随机数据集的ℓ分布</p></figure><h2 id="0582" class="on mw it bd mx oo op dn nb oq or dp nf li os ot nh lm ou ov nj lq ow ox nl oy bi translated">插入过程</h2><p id="fee1" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">在插入过程中，在每一层上，该算法贪婪地探索顶点的<a class="ae ky" href="http://mathonline.wikidot.com/neighbourhood-degrees-and-degree-sequence#toc0" rel="noopener ugc nofollow" target="_blank">邻域</a>，并维护当前找到的新插入顶点的最近邻居的动态列表。</p><p id="191e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于从顶层开始的插入过程的第一阶段，这个动态列表的大小被设置为1。然后，找到的最近的顶点被用作下一层的入口点，搜索继续进行。</p><p id="4585" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦达到低于<code class="fe pe pf pg ph b">ℓ</code>的水平，这标志着插入过程的第二阶段。从这一点开始，动态列表的大小遵循由名为<code class="fe pe pf pg ph b">efConstruction</code>的参数设置的值。除了作为下一层(如果有的话)的入口点之外，当前找到的最近邻居也是候选的<em class="nx">朋友</em>，其中的<code class="fe pe pf pg ph b">M</code>将被选择来与当前层上新插入的顶点建立连接。</p><p id="acdb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当新插入顶点的连接在级别0建立时，插入过程结束。</p><blockquote class="pw px py"><p id="7c7c" class="kz la nx lb b lc ld ju le lf lg jx lh pz lj lk ll qa ln lo lp qb lr ls lt lu im bi translated">根据论文<a class="ae ky" href="https://arxiv.org/abs/1603.09320" rel="noopener ugc nofollow" target="_blank"/>【2】，“通过评估列表中最近的先前未评估的元素的邻域，在每一步更新动态列表，直到评估列表中每个元素的邻域”。</p><p id="96ec" class="kz la nx lb b lc ld ju le lf lg jx lh pz lj lk ll qa ln lo lp qb lr ls lt lu im bi translated">因此<code class="fe pe pf pg ph b">efConstruction</code>(设置动态候选列表的大小)可以被定义为控制要探索的候选邻居数量的参数。它标志着施工期间的勘探深度。</p></blockquote><h2 id="2a02" class="on mw it bd mx oo op dn nb oq or dp nf li os ot nh lm ou ov nj lq ow ox nl oy bi translated"><strong class="ak">启发式选择</strong></h2><p id="8fbc" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">之前，我们了解到对于新南威尔士州，将选择最接近新顶点的<code class="fe pe pf pg ph b">M</code>个现有顶点进行连接。这是一种简单的方法，只选择并连接到最近的顶点。对于HNSW来说，使用启发式方法建立连接是提升性能的一个进步。</p><blockquote class="nz"><p id="2bd0" class="oa ob it bd oc od oz pa pb pc pd lu dk translated">启发式选择不仅考虑了顶点之间的最短距离，还考虑了图上不同区域的连通性。</p></blockquote><p id="f8cc" class="pw-post-body-paragraph kz la it lb b lc pi ju le lf pj jx lh li pk lk ll lm pl lo lp lq pm ls lt lu im bi translated">考虑下面的例子。很明显，右边的两个集群没有直接连接。为了从A到Y，人们必须穿过一条很长的路线，通过左边的另一个星团。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi qc"><img src="../Images/80ef47331864b486235dbc6be7043921.png" data-original-src="https://miro.medium.com/v2/resize:fit:738/format:webp/1*xS8hgVTs10h7pHmbUiM9gA.png"/></div></figure><p id="be77" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用<code class="fe pe pf pg ph b">M=2</code>，当我们在如下所示的位置插入一个新的顶点N时，我们得到4个候选的<em class="nx">朋友，</em> A，B，X和Y，其中2个将被选择与N连接</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi qd"><img src="../Images/abc8cc5f7e05376f29c8f70fa4b64453.png" data-original-src="https://miro.medium.com/v2/resize:fit:866/format:webp/1*E7aUllRqLtiE6fOskUGJaw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">启发式选择</p></figure><p id="44a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在4个候选点中，A最接近新顶点。因此，选择A连接到n。</p><p id="9e4f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">距离N最近的下一个顶点是B。但是，因为距离“B — A”小于距离“B — N ”,所以忽略顶点B，而考虑下一个最近的顶点Y。</p><p id="7d6b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此时，试探选择将N连接到Y，因为距离‘Y-A’大于‘Y-N’。通过这样做，我们现在能够在右侧的两个集群之间建立直接连接。</p><blockquote class="nz"><p id="da93" class="oa ob it bd oc od oz pa pb pc pd lu dk translated">该启发式算法增强了顶点邻域的多样性，并且对于高度聚集的数据的情况导致了更好的搜索效率。</p></blockquote><p id="22ac" class="pw-post-body-paragraph kz la it lb b lc pi ju le lf pj jx lh li pk lk ll lm pl lo lp lq pm ls lt lu im bi translated">在构建过程中，除了为每个新顶点建立<code class="fe pe pf pg ph b">M</code>连接，HNSW还关注每个顶点在任一时间点的连接总数。为了保持小世界的可导航性，对于0级，每个顶点的最大连接数通常被限制在<code class="fe pe pf pg ph b"><em class="nx">2*M</em></code>，对于所有其他级别，最大连接数被限制在<code class="fe pe pf pg ph b"><em class="nx">M</em></code>。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h2 id="4dbd" class="on mw it bd mx oo op dn nb oq or dp nf li os ot nh lm ou ov nj lq ow ox nl oy bi translated">(B)HNSW-搜索</h2><p id="1b42" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">HNSW的搜索过程从顶层的指定入口点开始。它遵循与插入过程所描述的相同的搜索过程，贪婪地探索顶点的邻域以找到最接近查询向量的顶点并向其移动。</p><p id="93b5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当它再也找不到任何比自己更接近查询向量的顶点时，它就下降到下一级。</p><p id="fed5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">搜索继续进行，直到到达底层(层0)，在这一点上将探索更多的候选邻居。当前找到的最近邻居的动态列表的大小将遵循由名为<code class="fe pe pf pg ph b">efSearch</code>的参数设置的值。一旦完成了所有需要的探索，就会返回动态列表中的<code class="fe pe pf pg ph b">k</code>个最近邻居。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi qe"><img src="../Images/697367745ee0c9a5f4438eee385845a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:992/format:webp/1*KChgy3e2F7xH6XanW_Tvgg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在HNSW图上搜索最近邻</p></figure><h1 id="c7d8" class="mv mw it bd mx my ns na nb nc nt ne nf jz nu ka nh kc nv kd nj kf nw kg nl nm bi translated">5.用Faiss实现:IndexHNSWFlat</h1><p id="80de" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated"><a class="ae ky" href="https://github.com/facebookresearch/faiss" rel="noopener ugc nofollow" target="_blank"><strong class="lb iu">Faiss</strong></a><strong class="lb iu"/>(脸书AI相似性搜索)是一个针对高效相似性搜索进行了高度优化的库。</p><p id="e318" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Faiss中，HNSW通过<code class="fe pe pf pg ph b">IndexHNSWFlat</code>实现。Faiss中的索引是一个数据结构，一个可以使用<code class="fe pe pf pg ph b">add</code>方法将向量添加到索引中的对象，以及使用<code class="fe pe pf pg ph b">search</code>方法在给定一些查询向量的情况下执行最近邻搜索。<em class="nx">平面</em>索引通常是指没有任何压缩或编码的索引，其中实际向量按原样存储。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="qf qg l"/></div></figure><h2 id="9342" class="on mw it bd mx oo op dn nb oq or dp nf li os ot nh lm ou ov nj lq ow ox nl oy bi translated">M、efConstruction和efSearch的效果</h2><p id="d583" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">在本节中，我们将绘制并检查<code class="fe pe pf pg ph b">M</code>、<code class="fe pe pf pg ph b">efConstruction</code>和<code class="fe pe pf pg ph b">efSearch</code>对HNSW的影响。</p><blockquote class="pw px py"><p id="0a62" class="kz la nx lb b lc ld ju le lf lg jx lh pz lj lk ll qa ln lo lp qb lr ls lt lu im bi translated">概括来说，<code class="fe pe pf pg ph b"><em class="it">M</em></code>是在构建过程中为每个新顶点建立的连接数。<code class="fe pe pf pg ph b">efConstruction</code>是构建期间要探索的候选邻居的数量，而<code class="fe pe pf pg ph b">efSearch</code>是搜索期间要探索的候选邻居的数量。</p><p id="f355" class="kz la nx lb b lc ld ju le lf lg jx lh pz lj lk ll qa ln lo lp qb lr ls lt lu im bi translated">为了生成这些图，300万个128维向量被添加到<code class="fe pe pf pg ph b">IndexHNSWFlat</code>，并且使用1000个查询向量来执行搜索。这些是使用Faiss数据集模块生成的合成矢量。</p><p id="671f" class="kz la nx lb b lc ld ju le lf lg jx lh pz lj lk ll qa ln lo lp qb lr ls lt lu im bi translated">准确性，或者说搜索质量，是由检索性能决定的。在我们的例子中，它是用<code class="fe pe pf pg ph b">1-recall@3</code>测量的。这是在每个查询的前3个结果中返回真正最近邻的查询向量的分数。</p></blockquote><p id="be54" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下是对上述参数对HNSW的影响的观察。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><p id="f5e1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于查询向量搜索，速度受<code class="fe pe pf pg ph b">M</code>、<code class="fe pe pf pg ph b">efConstruction</code>和<code class="fe pe pf pg ph b">efSearch</code>的影响。当这些参数的值增加时，搜索通常会变慢。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi qh"><img src="../Images/4f049a354a0ec310fc7c95ef685bf68a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1338/format:webp/1*b17ImiEDhgheL-GS0YQkAg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">1，000个查询向量的每个查询的平均搜索时间(毫秒)。</p></figure><p id="206b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">同样的参数也会影响搜索质量。更大的<code class="fe pe pf pg ph b">M</code>、<code class="fe pe pf pg ph b">efConstruction</code>或<code class="fe pe pf pg ph b">efSearch</code>值可以获得更高的召回率。</p><p id="e2ce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，将<code class="fe pe pf pg ph b">efConstruction</code>设置为太小的值对获得合理的性能没有帮助。在这种情况下提高<code class="fe pe pf pg ph b">M</code>或<code class="fe pe pf pg ph b">efSearch</code>的值没有帮助。为了获得满意的结果，绝对需要一个可行的<code class="fe pe pf pg ph b">efConstruction</code>值。</p><p id="1a6b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，在我们的例子中，<code class="fe pe pf pg ph b">efConstruction=40</code>连同<code class="fe pe pf pg ph b">M=32</code>和<code class="fe pe pf pg ph b">efSearch=16</code>能够以每个查询0.24毫秒的快速搜索速度达到0.85的令人印象深刻的召回率。这意味着在85%的情况下，每个查询的前3个结果中都会返回真正的最近邻。</p><p id="af45" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们不介意较慢的搜索，将<code class="fe pe pf pg ph b">efSearch</code>增加到76甚至可以将召回率提高到接近完美的0.97分！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi qi"><img src="../Images/f416d95c8e2a3711de66f280a27f7cf8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1334/format:webp/1*tyr5lc7QWHRKSrQjWMwr-w.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">1000个查询向量的召回性能。</p></figure><p id="1605" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">可以看到，在<code class="fe pe pf pg ph b">M</code>、<code class="fe pe pf pg ph b">efSearch</code>和<code class="fe pe pf pg ph b">efConstruction</code>的高值达到某一点后，回忆开始慢慢趋于平稳。此外，请注意为<code class="fe pe pf pg ph b">M</code>和<code class="fe pe pf pg ph b">efConstruction</code>设置较高的值会导致构建时间明显延长，如下图所示。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi qj"><img src="../Images/1db59311b5c8857a7ea252bdee581059.png" data-original-src="https://miro.medium.com/v2/resize:fit:1086/format:webp/1*1nhvbaXBDCj4a4H128eE2Q.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">300万个128维向量的构建时间。</p></figure><p id="d186" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，指示内存使用的HNSW的索引大小随着<code class="fe pe pf pg ph b">M</code>线性增长。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qk"><img src="../Images/ba7884ba4dd8b47fb0ae1b98006c8d7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:636/format:webp/1*JmOifff902s8E1yvduWUsw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">300万个128维向量的索引大小(MB)。</p></figure><p id="8368" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面的气泡图总结了<code class="fe pe pf pg ph b">M</code>、<code class="fe pe pf pg ph b">efConstruction</code>和<code class="fe pe pf pg ph b">efSearch</code>对HNSW的搜索速度和准确性的影响，以及对索引大小和构建时间的影响。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ql"><img src="../Images/ce9996fe948b0e4804132c4c385f606e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1340/format:webp/1*oIOZFF1JlomFUOum9AKcag.png"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi qh"><img src="../Images/e72d886a237cc7436bc2d0fb366e9c7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1338/format:webp/1*sjR27h5EyeOI7QD4y0-I-A.png"/></div></figure><p id="18d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果内存不是问题，HNSW是提供快速和高质量搜索的绝佳选择。</p><h1 id="9718" class="mv mw it bd mx my ns na nb nc nt ne nf jz nu ka nh kc nv kd nj kf nw kg nl nm bi translated">6.用Faiss实现:IndexIVFPQ + HNSW</h1><p id="a93b" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">厉害！我们已经学习了如何用Faiss实现HNSW。但是我们如何将HNSW与<a class="ae ky" rel="noopener" target="_blank" href="/similarity-search-with-ivfpq-9c6348fd4db3"> IVFPQ </a>一起使用呢？</p><p id="38a5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Faiss中，<a class="ae ky" rel="noopener" target="_blank" href="/similarity-search-with-ivfpq-9c6348fd4db3"> IVFPQ </a>用<code class="fe pe pf pg ph b">IndexIVFPQ</code>实现。</p><blockquote class="nz"><p id="4f7b" class="oa ob it bd oc od oz pa pb pc pd lu dk translated">我们之前看到的<code class="fe pe pf pg ph b">IndexHNSWFlat</code>现在作为<code class="fe pe pf pg ph b">IndexIVFPQ</code>的粗量化器。</p><p id="d37b" class="oa ob it bd oc od oz pa pb pc pd lu dk translated">粗略量化器负责寻找最接近查询向量的分区质心，以便只需要在那些分区上执行向量搜索。</p></blockquote><p id="d58e" class="pw-post-body-paragraph kz la it lb b lc pi ju le lf pj jx lh li pk lk ll lm pl lo lp lq pm ls lt lu im bi translated">下面的代码显示了如何用<code class="fe pe pf pg ph b">IndexHNSWFlat</code>创建一个<code class="fe pe pf pg ph b">IndexIVFPQ</code>作为粗量化器。</p><p id="2cc0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意<code class="fe pe pf pg ph b">IndexIVFPQ</code>需要在添加数据库向量之前用k-means聚类进行训练。为此，使用了<code class="fe pe pf pg ph b">train</code>方法。一旦创建了索引，就可以设置<code class="fe pe pf pg ph b">nprobe</code>的值来指定要搜索的分区数量。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="qf qg l"/></div></figure></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><blockquote class="pw px py"><p id="3b4f" class="kz la nx lb b lc ld ju le lf lg jx lh pz lj lk ll qa ln lo lp qb lr ls lt lu im bi translated">在Faiss中，也可以使用<code class="fe pe pf pg ph b"><a class="ae ky" href="https://github.com/facebookresearch/faiss/wiki/The-index-factory" rel="noopener ugc nofollow" target="_blank">index_factory</a></code>函数而不是类构造函数来创建索引。这种替代方法非常有用，尤其是对于构建复杂的复合索引，这种索引可能包含预处理步骤，如<a class="ae ky" href="https://en.wikipedia.org/wiki/Principal_component_analysis" rel="noopener ugc nofollow" target="_blank"> PCA </a>，或者其他类型的向量转换和细化。</p><p id="365d" class="kz la nx lb b lc ld ju le lf lg jx lh pz lj lk ll qa ln lo lp qb lr ls lt lu im bi translated">使用<code class="fe pe pf pg ph b">index_factory</code>，通过指定向量的维数(例如128)和工厂字符串<em class="it"> </em>(例如“IVF10000_HNSW32，PQ16”)作为函数的输入，可以将几行代码简化为一行。</p></blockquote><pre class="kj kk kl km gt qm ph qn qo aw qp bi"><span id="85ef" class="on mw it ph b gy qq qr l qs qt">index = faiss.index_factory(128, "IVF10000_HNSW32,PQ16")</span></pre><blockquote class="pw px py"><p id="5871" class="kz la nx lb b lc ld ju le lf lg jx lh pz lj lk ll qa ln lo lp qb lr ls lt lu im bi translated">上面的代码使用<code class="fe pe pf pg ph b"><em class="it">index_factory</em></code>为128维向量创建一个索引。它是一个具有10，000个分区的倒排文件索引，使用16个8位段的乘积量化(如果未指定位数，则默认为8位)。粗略量化器是基于图形的HNSW索引，对于每个新顶点有32个连接。</p></blockquote><h1 id="c8f9" class="mv mw it bd mx my ns na nb nc nt ne nf jz nu ka nh kc nv kd nj kf nw kg nl nm bi translated">7.HNSW指数比较(有/无IVF和/或PQ)</h1><p id="d02d" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">在本节中，我们将研究HNSW索引的不同变体，以及它们在搜索准确性、速度和内存使用方面的比较。它们是:</p><ul class=""><li id="ecf7" class="qu qv it lb b lc ld lf lg li qw lm qx lq qy lu qz ra rb rc bi translated">IVFPQ+HNSW</li><li id="0e88" class="qu qv it lb b lc rd lf re li rf lm rg lq rh lu qz ra rb rc bi translated">试管婴儿+HNSW</li><li id="5092" class="qu qv it lb b lc rd lf re li rf lm rg lq rh lu qz ra rb rc bi translated">HNSW</li><li id="af65" class="qu qv it lb b lc rd lf re li rf lm rg lq rh lu qz ra rb rc bi translated">HNSW+PQ</li></ul><p id="3ff6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Faiss <code class="fe pe pf pg ph b">index_factory</code>用于通过以下工厂字符串创建这四种类型的索引:</p><blockquote class="pw px py"><p id="8b5d" class="kz la nx lb b lc ld ju le lf lg jx lh pz lj lk ll qa ln lo lp qb lr ls lt lu im bi translated"><strong class="lb iu"> <em class="it"> IVF65536_HNSW32，PQ32 </em> </strong>:这本质上是<strong class="lb iu"> IVFPQ+HNSW </strong>。它是一个具有65，536个分区的倒排文件索引，使用32个8位段的乘积量化。粗量化器是基于图形的HNSW索引，带有<code class="fe pe pf pg ph b">M=32</code>。</p><p id="1dde" class="kz la nx lb b lc ld ju le lf lg jx lh pz lj lk ll qa ln lo lp qb lr ls lt lu im bi translated"><strong class="lb iu"> <em class="it"> IVF65536_HNSW32，平</em> </strong>:这本质上是<strong class="lb iu"> IVF+HNSW </strong>。它是一个有65，536个分区的倒排文件索引。粗量化器是基于图形的HNSW索引，带有<code class="fe pe pf pg ph b"><em class="it">M=32</em></code>。</p><p id="08cd" class="kz la nx lb b lc ld ju le lf lg jx lh pz lj lk ll qa ln lo lp qb lr ls lt lu im bi translated"><strong class="lb iu"> <em class="it"> HNSW32，Flat </em> </strong>:这本质上只是<strong class="lb iu"> HNSW </strong>，一个基于图形的索引，带有<code class="fe pe pf pg ph b"><em class="it">M=32</em></code>。</p><p id="77dc" class="kz la nx lb b lc ld ju le lf lg jx lh pz lj lk ll qa ln lo lp qb lr ls lt lu im bi translated"><strong class="lb iu"> <em class="it"> HNSW32_PQ32 </em> </strong>:这个本质上是<strong class="lb iu"> HNSW+PQ </strong>。它是一个基于图形的HNSW索引，带有<code class="fe pe pf pg ph b"><em class="it">M=32</em></code>，使用乘积量化，有32段，每段8比特。</p></blockquote><p id="f2b8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">和之前一样，在这些索引中加入300万个128维向量，使用1000个查询向量进行搜索。至于<code class="fe pe pf pg ph b">efConstruction</code>和<code class="fe pe pf pg ph b">efSearch</code>，使用Faiss的默认值。</p><p id="fef4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在四种类型的索引中，<strong class="lb iu"> IVFPQ+HNSW </strong>在索引大小或内存使用方面是冠军。它的大小只有154 MB，内存效率比单独的HNSW高15倍。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi po"><img src="../Images/87a8640aea3ebcca35febce273981b4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:766/format:webp/1*ZrHpA--9dhkxYtjUNbYJWQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">300万个128维向量的索引大小(MB)。</p></figure><p id="6698" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于基于IVF的索引，增加<code class="fe pe pf pg ph b">nprobe</code>(要搜索的分区数量)会导致更长的搜索时间，但会提高召回性能。</p><p id="f1e9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">根据使用的<code class="fe pe pf pg ph b">nprobe</code>的值，基于IVF的索引可以比HNSW或HNSW+PQ的性能更好或更差。</p><p id="48c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从下面的图表中，我们可以了解当<code class="fe pe pf pg ph b">nprobe=128</code>用于基于IVF的索引时，索引的相对性能。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ri"><img src="../Images/316c3b58a6fd86bb64563d6b8f0e0834.png" data-original-src="https://miro.medium.com/v2/resize:fit:958/format:webp/1*EufbEOPOvoxO-aXCYDbgwA.png"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi rj"><img src="../Images/336468510b0c3f304db7192e96e71d73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1104/format:webp/1*1RszF_jhCG1R0o_UuntVVw.png"/></div></figure><blockquote class="nz"><p id="3c6d" class="oa ob it bd oc od oe of og oh oi lu dk translated">选择合适的<code class="fe pe pf pg ph b">nprobe</code>是平衡搜索速度和准确性的关键。</p></blockquote><h1 id="baa5" class="mv mw it bd mx my ns na nb nc nt ne nf jz oj ka nh kc ok kd nj kf ol kg nl nm bi translated">8.摘要</h1><p id="43f8" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">下表显示了四种索引的召回性能与搜索时间的关系，以及它们各自的大小(MB)。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="qf qg l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">对于基于IVF的索引，使用的<code class="fe pe pf pg ph b">nprobe</code>是128。</p></figure><p id="0ac0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">结果可以从下面的图表中看到。在条形图上，我们可以看到四种类型的索引在搜索速度上的巨大差异，相比之下，在回忆性能上的差异更为细微。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi rk"><img src="../Images/f21b0bce200d240b3e189079a2b68ff8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1014/format:webp/1*ijxlhBBmJbTysKyDymSAyw.png"/></div></figure><p id="9ab4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面的气泡图很好地展示了搜索时间与回忆性能的对比。气泡的大小对应于索引的大小，这表示内存使用情况。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi rl"><img src="../Images/6476d63e833d2f23f25a89d30ae82a24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1130/format:webp/1*t7ahLNz4QX8-wJFUXiv1LA.png"/></div></figure><p id="6fdc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在搜索速度方面，可以观察到基于试管婴儿的索引(绿色和橙色气泡)领先。由于搜索的非穷举性质，它们的速度非常快，因为搜索只在一小部分分区上执行。</p><p id="3b76" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在准确性方面，HNSW(红色气泡)领先，PQ指数(绿色和蓝色气泡)落后。PQ指标是带有<a class="ae ky" rel="noopener" target="_blank" href="/product-quantization-for-similarity-search-2f1f67c5fddd">乘积量化</a>的指标。由于它们进行有损压缩，因此预期它们具有较低的精度。然而，它们的弱点被内存中的巨大节省所高度补偿。</p><p id="6006" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">显然，<strong class="lb iu"> IVFPQ+HNSW </strong>(绿色泡泡)无论是搜索速度还是内存效率都是赢家。它拥有最小的内存占用(哦，看看绿色泡泡有多小)，通过使用<code class="fe pe pf pg ph b">nprobe=128</code>，它成功实现了每个查询0.03毫秒的最快平均搜索时间，并且具有0.77的良好召回率。</p><p id="c1ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果需要更高的召回率呢？如下图所示，增加<code class="fe pe pf pg ph b">nprobe</code>可以达到目的，但代价是搜索时间更长。记住，选择一个合适的<code class="fe pe pf pg ph b">nprobe</code>是在权衡利弊中取得明智和现实结果的基础。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi rm"><img src="../Images/582984499e650d8e17e5aea2a71a52bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/format:webp/1*UudzimME44itTsokst2qOA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">增加<code class="fe pe pf pg ph b">nprobe</code>对基于IVF的指标的影响。当<code class="fe pe pf pg ph b">nprobe</code>增加时，绿色和橙色的气泡向右上方移动。</p></figure><blockquote class="nz"><p id="db6e" class="oa ob it bd oc od oe of og oh oi lu dk translated">IVFPQ 与作为粗量化器的<strong class="ak"> HNSW </strong>一起提供了一种极其节省内存且无可挑剔的快速搜索，对于大规模近似最近邻搜索具有良好的准确性。</p></blockquote><p id="a0ba" class="pw-post-body-paragraph kz la it lb b lc pi ju le lf pj jx lh li pk lk ll lm pl lo lp lq pm ls lt lu im bi translated">毫不奇怪，凭借速度、内存使用和准确性的良好平衡，<strong class="lb iu"> IVFPQ+HNSW </strong>成为十亿级相似性搜索的最佳索引方法。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi rn"><img src="../Images/232ea4b9a875ce13face116b26b3e09c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IX57wpmMDGqwRTb_"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@japhethmast?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Japheth Mast </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><h1 id="9db5" class="mv mw it bd mx my ns na nb nc nt ne nf jz nu ka nh kc nv kd nj kf nw kg nl nm bi translated">参考</h1><p id="6f4e" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">[1] Y. Malkov，A. Ponomarenko，A. Logvinov和V. Krylov，<a class="ae ky" href="https://doi.org/10.1016/j.is.2013.10.006" rel="noopener ugc nofollow" target="_blank">基于可导航小世界图的近似最近邻算法</a> (2013)</p><p id="3c27" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">[2] Y. Malkov和D. Yashunin，<a class="ae ky" href="https://arxiv.org/abs/1603.09320" rel="noopener ugc nofollow" target="_blank">使用分层可导航小世界图的高效和鲁棒的近似最近邻搜索</a> (2018)</p><p id="7adb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">[3] W. Pugh，<a class="ae ky" href="https://dl.acm.org/doi/10.1145/78973.78977" rel="noopener ugc nofollow" target="_blank">跳过列表:平衡树的概率替代方案</a> (1990)，《美国计算机学会通讯》，第33卷，第6期，第668-676页</p><p id="1f0a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">[4] J .布里格斯，<a class="ae ky" href="https://www.pinecone.io/learn/hnsw/" rel="noopener ugc nofollow" target="_blank">分层可导航小世界(HNSW) </a></p><p id="1573" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">[5] Y. Matsui，<a class="ae ky" href="https://www.youtube.com/watch?v=SKrHs03i08Q" rel="noopener ugc nofollow" target="_blank">亿级近似最近邻搜索</a> (2020)</p><p id="127e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">[6] <a class="ae ky" href="https://github.com/facebookresearch/faiss/wiki/" rel="noopener ugc nofollow" target="_blank"> Faiss Wiki </a></p><p id="af3d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">[7] J. Arguello，<a class="ae ky" href="https://ils.unc.edu/courses/2013_spring/inls509_001/lectures/10-EvaluationMetrics.pdf" rel="noopener ugc nofollow" target="_blank">评价指标</a></p><pre class="kj kk kl km gt qm ph qn qo aw qp bi"><span id="9642" class="on mw it ph b gy qq qr l qs qt"><strong class="ph iu"><em class="nx">Before You Go...</em></strong></span><span id="7e03" class="on mw it ph b gy ro qr l qs qt"><em class="nx">Thank you for reading this post, and I hope you’ve enjoyed learning the best indexing approach for billion-scale similarity search.</em></span><span id="a181" class="on mw it ph b gy ro qr l qs qt"><em class="nx">If you like my post, don’t forget to hit </em><a class="ae ky" href="https://peggy1502.medium.com/" rel="noopener"><strong class="ph iu"><em class="nx">Follow</em></strong></a><em class="nx"> and </em><a class="ae ky" href="https://peggy1502.medium.com/subscribe" rel="noopener"><strong class="ph iu"><em class="nx">Subscribe</em></strong></a><em class="nx"> to get notified via email when I publish.</em></span><span id="9ce9" class="on mw it ph b gy ro qr l qs qt"><em class="nx">Optionally, you may also </em><a class="ae ky" href="https://peggy1502.medium.com/membership" rel="noopener"><em class="nx">sign up</em></a><em class="nx"> for a Medium membership to get full access to every story on Medium.</em></span><span id="2b31" class="on mw it ph b gy ro qr l qs qt">📑 <em class="nx">Visit this </em><a class="ae ky" href="https://github.com/peggy1502/Data-Science-Articles/blob/main/README.md" rel="noopener ugc nofollow" target="_blank"><em class="nx">GitHub repo</em></a><em class="nx"> for all codes and notebooks that I shared in my posts.</em></span><span id="f192" class="on mw it ph b gy ro qr l qs qt">© 2022 All rights reserved.</span></pre><p id="be24" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有兴趣阅读我的其他数据科学文章吗？查看以下内容:</p><div class="lv lw gp gr lx ly"><a rel="noopener follow" target="_blank" href="/advanced-techniques-for-fine-tuning-transformers-82e4e61e16e"><div class="lz ab fo"><div class="ma ab mb cl cj mc"><h2 class="bd iu gy z fp md fr fs me fu fw is bi translated">微调变压器的先进技术</h2><div class="mf l"><h3 class="bd b gy z fp md fr fs me fu fw dk translated">学习这些先进的技术，看看它们如何帮助改善结果</h3></div><div class="mg l"><p class="bd b dl z fp md fr fs me fu fw dk translated">towardsdatascience.com</p></div></div><div class="mh l"><div class="rp l mj mk ml mh mm ks ly"/></div></div></a></div><div class="lv lw gp gr lx ly"><a rel="noopener follow" target="_blank" href="/transformers-can-you-rate-the-complexity-of-reading-passages-17c76da3403"><div class="lz ab fo"><div class="ma ab mb cl cj mc"><h2 class="bd iu gy z fp md fr fs me fu fw is bi translated">变形金刚，你能评价阅读段落的复杂程度吗？</h2><div class="mf l"><h3 class="bd b gy z fp md fr fs me fu fw dk translated">用PyTorch微调RoBERTa以预测文本摘录的阅读难易程度</h3></div><div class="mg l"><p class="bd b dl z fp md fr fs me fu fw dk translated">towardsdatascience.com</p></div></div><div class="mh l"><div class="rq l mj mk ml mh mm ks ly"/></div></div></a></div><div class="lv lw gp gr lx"><div role="button" tabindex="0" class="ab bv gv cb fp rr rs bn rt ks ex"><div class="ru l"><div class="ab q"><div class="l di"><img alt="Peggy Chang" class="l de bw rv rw fe" src="../Images/9e4c26496eb3cca6b350330838259487.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*4RiPT4MGaV1PUkLGaNirFQ.png"/><div class="fb bw l rv rw fc n aw fd"/></div><div class="hh l fo"><p class="bd b dl z fp fq fr fs ft fu fv fw dk translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" href="https://peggy1502.medium.com/?source=post_page-----89ff2f89d90e--------------------------------" rel="noopener follow" target="_top">张佩琦</a></p></div></div><div class="rz sa gw l"><h2 class="bd iu xd qu fp xe fr fs me fu fw is bi translated">掌握动态编程系列</h2></div><div class="ab q"><div class="l fo"><a class="bd b be z bi xf au xg xh xi tu xj an eh ei xk xl xm el em eo de bk ep" href="https://peggy1502.medium.com/list/series-on-mastering-dynamic-programming-ce9124edda06?source=post_page-----89ff2f89d90e--------------------------------" rel="noopener follow" target="_top">View list</a></div><div class="xn l fo"><span class="bd b dl z dk">2 stories</span></div></div></div><div class="sm dh sn fp ab so fo di"><div class="di se bv sf sg"><div class="dh l"><img alt="Article cover for “Mastering Dynamic Programming — Understanding the fundamentals and knowing when and how to apply this optimization technique”. Author: Peggy Chang" class="dh" src="../Images/4189e936345f7dd6622ff2fc4cc61733.png" width="194" height="194" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/1*c0gU2CkZ880j1_pfnGS1fw.png"/></div></div><div class="di se bv sh si sj"><div class="dh l"><img alt="Article cover for “Mastering Dynamic Programming II — Manual tabulation and workout is a great way to start grokking, analyzing, and spotting patterns, as well as strengthening our understanding and intuitions”. Author: Peggy Chang" class="dh" src="../Images/2cfd9c02af79a8bee7a11d30e4d2abb9.png" width="194" height="194" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/1*2hR-6vz3mdHIh8hS0GXanA.png"/></div></div><div class="di bv sk sl sj"><div class="dh l"><div class="sp sq sr l qp"/></div></div></div></div></div><div class="lv lw gp gr lx ly"><a href="https://pub.towardsai.net/building-a-product-recommendation-engine-with-aws-sagemaker-321a0e7c7f7b" rel="noopener  ugc nofollow" target="_blank"><div class="lz ab fo"><div class="ma ab mb cl cj mc"><h2 class="bd iu gy z fp md fr fs me fu fw is bi translated">用AWS SageMaker构建产品推荐引擎</h2><div class="mf l"><h3 class="bd b gy z fp md fr fs me fu fw dk translated">了解如何使用Amazon SageMaker因式分解机构建和训练个性化推荐引擎</h3></div><div class="mg l"><p class="bd b dl z fp md fr fs me fu fw dk translated">pub.towardsai.net</p></div></div><div class="mh l"><div class="ss l mj mk ml mh mm ks ly"/></div></div></a></div><div class="lv lw gp gr lx ly"><a rel="noopener follow" target="_blank" href="/aws-certified-machine-learning-specialty-97eacbd1a0fe"><div class="lz ab fo"><div class="ma ab mb cl cj mc"><h2 class="bd iu gy z fp md fr fs me fu fw is bi translated">AWS认证机器学习—专业</h2><div class="mf l"><h3 class="bd b gy z fp md fr fs me fu fw dk translated">关于如何准备和通过考试的提示和建议</h3></div><div class="mg l"><p class="bd b dl z fp md fr fs me fu fw dk translated">towardsdatascience.com</p></div></div><div class="mh l"><div class="st l mj mk ml mh mm ks ly"/></div></div></a></div></div></div>    
</body>
</html>