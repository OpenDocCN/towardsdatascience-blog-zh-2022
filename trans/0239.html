<html>
<head>
<title>How to Compute a Moving Average in BigQuery Using SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用SQL在BigQuery中计算移动平均值</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-compute-a-moving-average-in-bigquery-using-sql-15f3fedd7489#2022-02-10">https://towardsdatascience.com/how-to-compute-a-moving-average-in-bigquery-using-sql-15f3fedd7489#2022-02-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="42df" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">消除变化，发现趋势，并在Data Studio中将其可视化</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/09acf39343fc5387623a26f3e342becd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tpP3NvZc27q1N0g-hXV0Lg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">股市站(信用:<a class="ae ky" href="https://unsplash.com/@behy_studio" rel="noopener ugc nofollow" target="_blank">https://unsplash.com/@behy_studio</a></p></figure><h1 id="5c1d" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">问题是</h1><p id="66aa" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">当查看<strong class="lt iu">时序数据时，</strong>决策可能会受到随机、短期波动(加密货币的价格、报告的新冠肺炎病例数量)的<strong class="lt iu"> </strong>影响。</p><p id="9b75" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这就是为什么使用<strong class="lt iu">移动平均线</strong>(也称为<strong class="lt iu">移动平均线</strong>或<strong class="lt iu">滚动平均线</strong>)最有助于消除短期波动并突出长期趋势。</p><p id="6351" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">例如，新冠肺炎测试站和实验室可能整周批量报告病例(或者周末关闭时不报告)，加密货币股票市场价格可能会在几天之间的值之间快速振荡。</p><p id="8d8c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">举例来说，在查看Covid 19新案例时，您可能已经在谷歌搜索上看到了下图:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/72be42244c3dc08c9c3d62c5d8a1d194.png" data-original-src="https://miro.medium.com/v2/resize:fit:1330/format:webp/1*jhPP3PUhLLA6h_JtJA2AoQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来自谷歌搜索的Covid 19个新案例(图片由作者提供)</p></figure><p id="884f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">你会注意到图例中浅蓝色的线显示了7天的平均值。这正是我们将在本文中学习做的事情😎</p><p id="2ddd" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">您可以在下面的Data Studio中看到它的显示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mt"><img src="../Images/cc54859a5a646fbc8e899361e31eab35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*amr5wXsuQo4GDRUSTlNNpA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">数据工作室中显示的Covid 19个新病例(图片由作者提供)</p></figure><h1 id="c765" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">解决方案</h1><p id="5440" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在本文中，我们将根据谷歌新冠肺炎公开赛数据计算<strong class="lt iu"> 7天移动平均线。</strong></p><p id="e2b8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在这种情况下，选择7天是很重要的(因为我们可以计算14天、30天等等的移动平均值)。</p><p id="549a" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在这里，我们选择7天，因为这是一个相当短的时期，我们希望保持每周视图(例如，周一至周日)，这将更好地代表电晕测试站或测试中心的速度(报告可能在周末，或在一周的特定间隔)。</p><p id="75bc" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">但是对于不同的用例，我们可能会选择不同的时间框架。我们的示例是大约7 <em class="mu">天</em>的周期，但是也可以按<em class="mu"> 12周</em>的周期来计算。视情况而定，框架也可以是<em class="mu">天、</em>周、<em class="mu">季、</em>年。</p><p id="293b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">此外，您可以将移动平均值应用于任何数值，如<em class="mu">收入、用户数量等……)</em></p><p id="eebb" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们的解决方案将使用<strong class="lt iu"> <em class="mu">解析函数</em> </strong> <em class="mu">。</em>这些函数允许我们计算或获取一组行的值，并为每一行返回一个<strong class="lt iu">单个</strong>结果。这就像在不执行维度连接或分组的情况下在单个表中旅行或浏览一样。</p><p id="8f6d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">要了解更多关于<strong class="lt iu"> <em class="mu">聚合解析函数</em> </strong>，你可以在这里看看👇🏼</p><div class="mv mw gp gr mx my"><a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/aggregate_analytic_functions" rel="noopener  ugc nofollow" target="_blank"><div class="mz ab fo"><div class="na ab nb cl cj nc"><h2 class="bd iu gy z fp nd fr fs ne fu fw is bi translated">聚合分析函数| BigQuery |谷歌云</h2><div class="nf l"><h3 class="bd b gy z fp nd fr fs ne fu fw dk translated">发送反馈以下部分描述了BigQuery支持的聚合分析函数。对于一个…</h3></div><div class="ng l"><p class="bd b dl z fp nd fr fs ne fu fw dk translated">cloud.google.com</p></div></div><div class="nh l"><div class="ni l nj nk nl nh nm ks my"/></div></div></a></div><p id="67b9" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">对于这个实验，我们使用来自公共BigQuery数据集的<strong class="lt iu">新冠肺炎公共数据</strong>。</p><p id="a5d3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">您可以通过以下链接获得更多信息👇🏼</p><div class="mv mw gp gr mx my"><a href="https://cloud.google.com/blog/products/data-analytics/free-public-datasets-for-covid19" rel="noopener  ugc nofollow" target="_blank"><div class="mz ab fo"><div class="na ab nb cl cj nc"><h2 class="bd iu gy z fp nd fr fs ne fu fw is bi translated">新冠肺炎免费公共数据集|谷歌云博客</h2><div class="nf l"><h3 class="bd b gy z fp nd fr fs ne fu fw dk translated">数据在调查、研究和应对突发公共卫生事件的能力中始终发挥着至关重要的作用</h3></div><div class="ng l"><p class="bd b dl z fp nd fr fs ne fu fw dk translated">cloud.google.com</p></div></div><div class="nh l"><div class="nn l nj nk nl nh nm ks my"/></div></div></a></div><p id="17b2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">要找到我们将逐步解释的完整脚本，您可以直接转到<strong class="lt iu">步骤#3、</strong>并在BigQuery <strong class="lt iu">中运行它。</strong></p></div><div class="ab cl no np hx nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="im in io ip iq"><h1 id="135a" class="kz la it bd lb lc nv le lf lg nw li lj jz nx ka ll kc ny kd ln kf nz kg lp lq bi translated">步骤#1:转换和分组</h1><p id="171e" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">首先，我们希望得到我们的特定变量(<code class="fe oa ob oc od b">new_confirmed</code>)按期望的时间段聚合(在我们的例子中是每天<em class="mu"/>)。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="e9f8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">上面的查询返回一个包含每天新确诊病例的表。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi og"><img src="../Images/7f5f8f794d1d94013fc03c8e8965ae6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:392/format:webp/1*wyEALBz7W4qz57xp-wqcqQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">每日新增确诊病例</p></figure><p id="95c3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">通过使用<em class="mu">查询编辑器</em>和<em class="mu">结果表</em>之间的<strong class="lt iu">浏览数据</strong>按钮，我们可以在Data Studio上很好地显示每日新增确诊病例如下:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/5516e7fae8788e6c306c055fd0ad0b35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rIB-MbjkmGvU2EVgRFijYA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">数据工作室每日新增确诊病例(图片作者提供)</p></figure><p id="1c5a" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这只是第一步，但这是一个好的开始，坚持住😅</p><h1 id="76b8" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">第二步:如何计算我们的移动平均线？</h1><p id="c7b2" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们之前计算了每日新增确诊病例的数量，其中输出是一天中每行和新增病例数量的表格。我们将该列命名为<code class="fe oa ob oc od b">new_cases</code>。</p><p id="5191" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们将使用一个<strong class="lt iu">聚合分析函数</strong>来获得我们的移动平均值。该函数将如下所示:</p><pre class="kj kk kl km gt oi od oj ok aw ol bi"><span id="aa6b" class="om la it od b gy on oo l op oq">AVG(new_cases) OVER(ORDER BY UNIX_DATE(date) RANGE BETWEEN 6 PRECEDING AND CURRENT ROW)</span></pre><p id="d388" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们输入我们想要新案例的平均值<em class="mu"> AVG(new_cases) </em>，并且我们希望这个平均值包括当前行值<em class="mu">当前行</em>和前面的6行(以及我们表中的每一行)。</p><p id="bded" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">然后，您将得到以下输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi or"><img src="../Images/518a39f8e645ba09782308c702dd1383.png" data-original-src="https://miro.medium.com/v2/resize:fit:592/format:webp/1*VScx5nSPcjkHHh40d5p7Kw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">移动平均每行的输出</p></figure><p id="19cf" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">让我们手动计算，从<em class="mu">2022–02–06</em>开始，7天平均值将返回:</p><p id="c15f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><em class="mu">(155439+214542+241049+716294+831347+970542+929533)/7</em></p><p id="f403" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这给出了<em class="mu"> 579820，85 </em>，我们四舍五入到你在<em class="mu">2022–02–06的<code class="fe oa ob oc od b">seven_days_ma</code>栏中看到的值。</em></p><p id="ef54" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">但是，我们需要解决一个微妙的问题。你也可以这样写</p><pre class="kj kk kl km gt oi od oj ok aw ol bi"><span id="af0b" class="om la it od b gy on oo l op oq">AVG(new_cases) OVER(ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW)</span></pre><p id="4cf0" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">那么使用RANGE或者ROWS的<strong class="lt iu">区别是什么呢？</strong></p><p id="e1cd" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这些行将查看当前行之前的行数，以便将它们包含在我们的平均值中。因此，在我们的例子中，该函数将查看当前行，然后查看之前的“物理”6行，并计算平均值。但是如果有遗漏的日期呢？</p><p id="7a54" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这就是RANGE派上用场的地方，如果表由于某种原因缺少日期，那么行将回溯到6天以前。范围将产生一个基于日期值本身的窗口。</p><p id="db7d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">以<strong class="lt iu">失踪日期</strong>为例:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi os"><img src="../Images/9a7308662e3ddc46232040a41ecf2c19.png" data-original-src="https://miro.medium.com/v2/resize:fit:690/format:webp/1*9C44jgYppHHREi0mSxyr2A.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">ma_rows使用行框架，ma_range使用范围框架</p></figure><p id="159c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">您可以在这里看到，<code class="fe oa ob oc od b">ma_rows</code>正在使用行计算7天移动平均线，<code class="fe oa ob oc od b">ma_range</code>正在使用范围计算我们的移动平均线，由于缺少日期<em class="mu">(2022–02–03)</em>，它们计算的值并不完全相同。</p><p id="b023" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">通常，建议使用范围，因为它不是基于物理行，而是基于逻辑值。唯一的区别是日期字段需要使用UNIX_DATE()函数进行转换。</p><h1 id="fcc4" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">步骤3:在我们的查询中应用公式</h1><p id="7a65" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">现在，我们可以把所有这些放在一起，这是完整的脚本。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="6200" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">第一个WITH子句计算每个日期的所有新确诊病例。在<em class="mu"> " — Main Query" </em>注释下，我们应用我们的移动平均函数，并且我们还在顶部的另一个查询中对其进行舍入(因为我们不能通过OVER()子句使用舍入函数)。</p><p id="c499" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这为我们提供了以下输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/0dd2bbf436519927a78163b377857134.png" data-original-src="https://miro.medium.com/v2/resize:fit:590/format:webp/1*W-ItrDDPUtXC1MQDw4tTog.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">移动平均查询的结果以表格的形式显示</p></figure><p id="aeda" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这就是我们如何得到我们的7天移动平均线！🍻然后就可以在Data studio上显示了</p></div><div class="ab cl no np hx nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="im in io ip iq"><h1 id="e3be" class="kz la it bd lb lc nv le lf lg nw li lj jz nx ka ll kc ny kd ln kf nz kg lp lq bi translated">现在，是时候闪耀✨了</h1><p id="f48e" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">然后，我们可以使用Datastudio来显示我们的结果，这为我们提供了新冠肺炎案例和浅蓝色7天移动平均线的良好概览。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mt"><img src="../Images/cc54859a5a646fbc8e899361e31eab35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*amr5wXsuQo4GDRUSTlNNpA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">数据工作室中显示的Covid 19个新病例(图片由作者提供)</p></figure><p id="e625" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">该方法可用于任何类型的时间序列和变量。有趣的部分是<strong class="lt iu"> <em class="mu">聚合解析函数</em> </strong>的使用。他们使这个练习变得容易得多，即使他们一开始并不容易理解。</p><p id="9368" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我希望你会喜欢这个方法，这篇文章会帮你节省一些时间。但更重要的是，我希望这将帮助您更轻松地使用SQL和BigQuery！是一个很好的练习技巧的用例！</p><p id="01f5" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">是时候深入研究一些数据了！🤓</p></div></div>    
</body>
</html>