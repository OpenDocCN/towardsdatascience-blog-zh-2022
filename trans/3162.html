<html>
<head>
<title>Pandas vs Dask vs Datatable: A Performance Comparison for processing CSV files</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Pandas vs Dask vs Datatable:处理CSV文件的性能比较</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/pandas-vs-dask-vs-datatable-a-performance-comparison-for-processing-csv-files-3b0e0e98215e#2022-07-12">https://towardsdatascience.com/pandas-vs-dask-vs-datatable-a-performance-comparison-for-processing-csv-files-3b0e0e98215e#2022-07-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4080" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">熊猫可能不再是最好的选择了</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/03ece7ab837167e4225b0de212688e1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VHWx-jKOKpOMYAyz"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">马丁·雷施在<a class="ae ky" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="36a1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi lv translated"><span class="l lw lx ly bm lz ma mb mc md di"> W </span>说到处理CSV文件，每个人脑海中出现的第一个工具就是熊猫。毫无疑问，pandas是一个伟大的框架，dataframe提供了一种极其精简的数据表示形式，帮助我们更好地分析和理解数据。</p><p id="8994" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最近做了一个任务，要求我合并30K+ CSV文件。我的神感是用熊猫，但是因为某些文件操作的表现不太顺利。在这篇文章中，我想和你分享另外两种选择，并比较它们和熊猫的行为和表现。最后，您将理解每个库的权衡，并能够做出正确的选择。</p><blockquote class="me mf mg"><p id="8818" class="kz la mh lb b lc ld ju le lf lg jx lh mi lj lk ll mj ln lo lp mk lr ls lt lu im bi translated">我对实验得出的一些结果感到非常惊讶，因为除非你实际尝试，否则无法预测。希望这篇文章可以节省你试错的时间，帮助你在选择库的时候做出更好的决定。</p></blockquote></div><div class="ab cl ml mm hx mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="im in io ip iq"><h2 id="3132" class="ms mt it bd mu mv mw dn mx my mz dp na li nb nc nd lm ne nf ng lq nh ni nj nk bi translated"><a class="ae ky" href="https://www.dask.org/" rel="noopener ugc nofollow" target="_blank"> Dask </a></h2><p id="0f93" class="pw-post-body-paragraph kz la it lb b lc nl ju le lf nm jx lh li nn lk ll lm no lo lp lq np ls lt lu im bi translated">大多数数据分析Python库(如Numpy、pandas和scikit-learn)的一个问题是，它们不能扩展到单台机器之外。Dask是一个开源库，当您处理大型数据时，它为分析提供了高级并行化。它可以在需要时将这些分析包扩展到多核机器和分布式集群。它提供了一个与pandas相似的API接口，以确保一致性并最小化摩擦。</p><h2 id="7f1d" class="ms mt it bd mu mv mw dn mx my mz dp na li nb nc nd lm ne nf ng lq nh ni nj nk bi translated"><a class="ae ky" href="https://datatable.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank">数据表</a></h2><p id="80ec" class="pw-post-body-paragraph kz la it lb b lc nl ju le lf nm jx lh li nn lk ll lm no lo lp lq np ls lt lu im bi translated">Datatable是另一个考虑到性能的Python库。与dask不同，datatable的目标是在一台<strong class="lb iu">单节点机器上以尽可能快的速度执行大型数据处理</strong>。同时，它与pandas的互操作性提供了轻松转换到另一个数据处理框架的能力。</p><p id="0558" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这两个库都旨在提高pandas的性能，并保持与pandas相似的界面以方便使用。在接下来的几节中，我在我的Macbook Pro(2.6 GHz 6核英特尔酷睿i7，16GB内存)上进行了实验，在不同的环境中运行时，您可能会得到不同的结果。</p></div><div class="ab cl ml mm hx mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="im in io ip iq"><h2 id="1748" class="ms mt it bd mu mv mw dn mx my mz dp na li nb nc nd lm ne nf ng lq nh ni nj nk bi translated">读取单个CSV文件</h2><p id="807a" class="pw-post-body-paragraph kz la it lb b lc nl ju le lf nm jx lh li nn lk ll lm no lo lp lq np ls lt lu im bi translated">让我们从最简单的操作开始——读取单个CSV文件。让我惊讶的是，在最基本的操作上，我们已经可以看到巨大的差异了。数据表比熊猫快70%，而dask快500%！结果是各种各样的数据帧对象，它们有非常相同的接口。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div></figure><h2 id="386d" class="ms mt it bd mu mv mw dn mx my mz dp na li nb nc nd lm ne nf ng lq nh ni nj nk bi translated">读取多个CSV文件</h2><p id="9521" class="pw-post-body-paragraph kz la it lb b lc nl ju le lf nm jx lh li nn lk ll lm no lo lp lq np ls lt lu im bi translated">当我试图用熊猫来完成这个任务时，这就是我被卡住的地方。pandas没有提供可以在一行中读取多个CSV文件的接口。唯一的方法是做一个for循环，将每个数据帧追加到一个列表中，最后，使用<code class="fe ns nt nu nv b">pd.concat</code>来组合所有这些数据帧。但这是相当低效的。让我们检查以下内容:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="cf02" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个结果也很有趣，因为事实证明，在读取多个CSV文件方面，datatable的性能比pandas差，这与我的预期相反。尽管如此，达斯克仍然赢得了比赛，表现比熊猫好4倍。</p><p id="03e6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">警告— CSV文件有不同的格式</strong></p><p id="2d4a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">组合多个CSV文件时，由于版本不同或数据文件损坏，CSV文件可能会有不同的格式。在这种情况下，我们应该小心不要无意中混淆了不同的CSV文件。</p><p id="7d7d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">新列</strong></p><p id="9764" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个例子中，我准备了两个文件，其中一个有一个额外的列。我试图模拟一个真实的场景，在这个场景中，源文件中有一个微小的模式变化。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="b865" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是你所期望的吗？</p><p id="7105" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Pandas将使用新模式作为目标模式，<strong class="lb iu">新列将被回填为旧数据</strong>中的 <code class="fe ns nt nu nv b"><strong class="lb iu">NaN</strong></code> <strong class="lb iu">。列表<code class="fe ns nt nu nv b">files</code>中的顺序无关紧要，因为pandas将选择具有更多列的模式，而不管读取顺序如何。</strong></p><p id="888f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另一方面，Dask让我很惊讶。它使用列表中第一个文件的<strong class="lb iu">模式作为目标模式，并忽略不匹配的文件。</strong>当<strong class="lb iu"> </strong>我反转<code class="fe ns nt nu nv b">files</code>时，我得到了完全不同的结果，因为先读取了一个不同的文件。这有点冒险，因为它可能会在不通知您的情况下忽略许多行。一种解决方法是读取每个文件的文件头，并在合并之前进行比较。尽管这产生了一点点开销，但总的处理时间仍然比pandas快，因为在“合并”阶段获得了巨大的性能增益。</p><p id="cadb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">与其他的相比，数据表是相当安全的。如果在模式中发现差异，它将引发异常。你可以在<code class="fe ns nt nu nv b">rbind</code>函数中添加<code class="fe ns nt nu nv b">force=True</code>，这样它就会有和熊猫一样的行为。</p><p id="4500" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">重命名现有列</strong></p><p id="02ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另一个常见的模式更改是重命名现有的列，这是一个突破性的更改。在这个例子中，<code class="fe ns nt nu nv b">data.csv</code>只包含<code class="fe ns nt nu nv b">gross_amount</code>，而<code class="fe ns nt nu nv b">data_rename_col.csv</code>只包含<code class="fe ns nt nu nv b">net_amount</code>。看到前面的例子后，在检查结果之前，让我们猜一猜。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="dcbd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以，熊猫的结果既包含了<code class="fe ns nt nu nv b">gross_amount</code>又包含了<code class="fe ns nt nu nv b">net_amount</code>，它用<code class="fe ns nt nu nv b">NaN</code>填充了缺失的值。Dask给出与之前相同的结果，这取决于它首先读取的文件。在这种情况下，Datatable抛出一个不同的异常，其名称为中断列。这在调试过程中很有帮助。一般来说，它们都继承了上一个例子的相同行为。</p><h2 id="eadd" class="ms mt it bd mu mv mw dn mx my mz dp na li nb nc nd lm ne nf ng lq nh ni nj nk bi translated">计算聚合</h2><p id="e1c6" class="pw-post-body-paragraph kz la it lb b lc nl ju le lf nm jx lh li nn lk ll lm no lo lp lq np ls lt lu im bi translated">一项重要的分析是计算聚合，如最小值、最大值、总和、平均值和中值，其中单个数字可以洞察整个(部分)数据集。那么这些计算的性能如何呢？</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div></figure><blockquote class="me mf mg"><p id="6011" class="kz la mh lb b lc ld ju le lf lg jx lh mi lj lk ll mj ln lo lp mk lr ls lt lu im bi translated">根据<a class="ae ky" href="https://examples.dask.org/dataframes/02-groupby.html" rel="noopener ugc nofollow" target="_blank"> dask文档</a>:一般来说，dask . data frame group-by-aggregations的性能与pandas group-by-aggregations大致相同，只是可伸缩性更强。</p></blockquote><p id="51ae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">计算聚合的性能也是一样的。但与熊猫相比，dask能够在集群中扩展解决方案。</p><h2 id="cdb0" class="ms mt it bd mu mv mw dn mx my mz dp na li nb nc nd lm ne nf ng lq nh ni nj nk bi translated">写入CSV文件</h2><p id="af86" class="pw-post-body-paragraph kz la it lb b lc nl ju le lf nm jx lh li nn lk ll lm no lo lp lq np ls lt lu im bi translated">最后一部分是卸载。所有这3个库都有相同的接口<code class="fe ns nt nu nv b">.to_csv()</code>将数据帧保存到CSV中。除此之外，dask还支持<a class="ae ky" href="https://parquet.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Parquet </a>格式，这是一种流行的柱状二进制格式，旨在实现高效的数据存储和检索。它提供了高效的数据压缩和编码方案，增强了批量处理复杂数据的性能。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="580c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如你所见，获胜者是镶木地板格式的dask。Pandas和datatable的表现一样。常规CSV格式的Dask性能最差，这与读取CSV文件的性能完全相反。parquet的高性能是因为数据被分成了几个分区。默认情况下，dask会将每个parquet文件作为数据帧中的一个分区单独加载，这样更便于并行加载。</p><p id="259b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，dask在默认情况下用<a class="ae ky" href="https://en.wikipedia.org/wiki/Snappy_(compression)" rel="noopener ugc nofollow" target="_blank"> snappy compression </a>写出parquet文件。快速压缩通常是分布式计算中文件的最佳选择。虽然它压缩文件的力度不如gzip等其他压缩算法，但在解压文件时速度更快。您也可以用其他压缩算法覆盖它。</p></div><div class="ab cl ml mm hx mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="im in io ip iq"><h2 id="cd3f" class="ms mt it bd mu mv mw dn mx my mz dp na li nb nc nd lm ne nf ng lq nh ni nj nk bi translated">结论</h2><p id="ddd1" class="pw-post-body-paragraph kz la it lb b lc nl ju le lf nm jx lh li nn lk ll lm no lo lp lq np ls lt lu im bi translated">我希望这篇文章能够让您对pandas、dask和datatable的不同方面有一个整体的了解。事实证明，没有一个图书馆是完美的。Dask擅长读写文件，尤其是使用它的parquet格式。它能够将您的解决方案分发到一个集群。Datatable试图以稍好的性能模仿熊猫的行为。Pandas是另外两个库的核心，提供了最完整的计算方法。</p><p id="cc29" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">比较不同的工具并了解它们的优缺点总是很有趣的。我鼓励你在你感兴趣的领域也做这样的练习，并与社区分享。它将使许多人受益。</p><p id="d348" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我知道你对这三个图书馆的看法！干杯！</p></div><div class="ab cl ml mm hx mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="im in io ip iq"><h2 id="5113" class="ms mt it bd mu mv mw dn mx my mz dp na li nb nc nd lm ne nf ng lq nh ni nj nk bi translated">参考</h2><div class="nw nx gp gr ny nz"><a href="https://coiled.io/blog/speed-up-pandas-query-10x-with-dask/#:~:text=Dask%20runs%20faster%20than%20pandas,cores%20to%20run%20the%20computation" rel="noopener  ugc nofollow" target="_blank"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd iu gy z fp oe fr fs of fu fw is bi translated">用这6个Dask数据帧技巧将熊猫的查询速度提高10倍——盘绕</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">这篇文章演示了如何使用六种性能的Dask将pandas的查询速度提高10倍…</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">coiled.io</p></div></div><div class="oi l"><div class="oj l ok ol om oi on ks nz"/></div></div></a></div></div></div>    
</body>
</html>