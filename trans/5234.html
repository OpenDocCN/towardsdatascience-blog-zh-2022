<html>
<head>
<title>The ultimate reference for clean Pandas code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">清洁熊猫代码的最终参考</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/the-ultimate-reference-for-clean-pandas-code-413df676e63c#2022-11-23">https://towardsdatascience.com/the-ultimate-reference-for-clean-pandas-code-413df676e63c#2022-11-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ed94" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">一种清理数据的干净方法</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f750bf77280cb7a3c29cd385aa2cae7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4g3-zF_62EoNDO4s"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/ja/@preciousplasticmelbourne?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Precious Plastic Melbourne </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="f31e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">熊猫可以将最混乱的数据转化为原始的机器学习数据集。不过，这个过程本身可能会相当混乱。</p><p id="24bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">熊猫的代码很难读懂，原因有很多。首先，熊猫有许多不同的方式来完成同样的基本任务。子集化数据、添加新列、删除列、删除空值和许多其他过程可以通过许多不同的方式完成，这导致了不一致和混乱的代码。</p><p id="8841" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对熊猫来说，管理数据清理步骤的顺序也是一个挑战。我职业生涯早期的大部分数据清理代码如下所示:</p><pre class="kj kk kl km gt lv lw lx bn ly lz bi"><span id="7e76" class="ma mb it lw b be mc md l me mf"># Import data<br/>df_raw = pd.read_csv("path/to/data/file.csv")<br/><br/># Clean data<br/>df_raw["id"] = df_raw["id"].astype(str)<br/>df_merged = df_raw.merge(df2, on="id")<br/>df_final = df_merged.drop(columns=["col_5", "col_6", "col_7"])<br/><br/># Investigate data<br/>df_agg = df_final.groupby("id").size()</span></pre><p id="b9d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">“意大利面条式代码”，就像上面的例子，很难解释和调试。此外，命名空间中有如此多的数据框会耗尽内存，并且在处理大型数据集时可能会特别成问题。</p><p id="5b13" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，熊猫代码可能会变得混乱，因为很多时候它是在匆忙中编写的。无论您是渴望构建模型并需要提前快速清理数据集，还是有一批新的输出数据需要分析，作为一名数据科学家，熊猫通常是达到目的的一种手段。</p><p id="390d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么，一劳永逸地编写干净的熊猫代码的秘诀是什么呢？两个字:<strong class="lb iu">方法链接</strong>。</p><p id="af40" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇文章中，我与您分享了一组精选的 clean Pandas 方法，我用它们来预处理、调查、聚集和分析 Twitter 数据，在一个单独的项目<a class="ae ky" href="https://github.com/m-newhauser/distilbert-senator-tweets" rel="noopener ugc nofollow" target="_blank">中，我用它们来训练一个 Transformer 模型。利用这些例子将扩展您对方法链的理解，并作为您编写自己干净的 Pandas 代码的参考指南。</a></p><h1 id="3548" class="mg mb it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">清洁熊猫的基本知识</h1><p id="fada" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li mz lk ll lm na lo lp lq nb ls lt lu im bi translated">Pandas 库附带了大量的内置方法。回想一下，在 Python 中，<a class="ae ky" href="https://docs.python.org/3/tutorial/classes.html#:~:text=A" rel="noopener ugc nofollow" target="_blank">方法</a>是属于一个特定类的对象的函数，并且被附加到对象本身上，就像<code class="fe nc nd ne lw b">df.to_csv()</code>一样。方法也可以被链接，这意味着您可以一次对一个对象应用几个方法。</p><pre class="kj kk kl km gt lv lw lx bn ly lz bi"><span id="6e5a" class="ma mb it lw b be mc md l me mf">new_df = (                          # Wrap everything in ()'s<br/>    original_df                     # Name of data frame to modify<br/>    .query("text_length &gt; 140")     # Subset based on text length<br/>    .sort_values(by="text_length")  # Sort entire df by text length<br/>    .reset_index()                  # Reset index of subsetted df<br/>)</span></pre><p id="445f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">强迫自己使用 Pandas 方法而不是操作符一开始可能会令人沮丧，因为在大多数情况下，您正在重新学习您已经知道的东西。但是这就是为什么您应该坚持使用方法链的原因:</p><ul class=""><li id="aad6" class="nf ng it lb b lc ld lf lg li nh lm ni lq nj lu nk nl nm nn bi translated">它使代码更具可读性。</li><li id="d753" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">它消除了对多个中间数据帧的需要，从而节省了内存。</li><li id="350a" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">更容易调试。只需一行一行地注释掉数据帧操作，看看哪种方法给你带来了问题。</li></ul><h1 id="455d" class="mg mb it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">数据清理</h1><p id="a24c" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li mz lk ll lm na lo lp lq nb ls lt lu im bi translated">我有一个由美国参议员制作的原始推文的数据框架，我通过具有提升访问凭证的<a class="ae ky" href="https://developer.twitter.com/en/docs/twitter-api" rel="noopener ugc nofollow" target="_blank"> Twitter API v2 </a>获取。以下是一些数据:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="d107" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们做一些链接来清理这一点。在这一次调用中，我们将选择并删除列，格式化日期列，清理 tweet 的原始文本，计算文本长度，合并两个数据框，删除重复的行，重命名列，重新排序列名，按日期排序，并删除 tweet 长度为零的所有行。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="f11a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可能对这些方法中的大部分都很熟悉。也许这里最重要的方法是<code class="fe nc nd ne lw b">.assign()</code>，它允许您创建新列或覆盖旧列。我主要出于两个目的使用<code class="fe nc nd ne lw b">assign()</code>方法。</p><ol class=""><li id="718b" class="nf ng it lb b lc ld lf lg li nh lm ni lq nj lu nv nl nm nn bi translated">更改现有列的数据类型:</li></ol><pre class="kj kk kl km gt lv lw lx bn ly lz bi"><span id="7d9b" class="ma mb it lw b be mc md l me mf">.assign(column_name=original_df["column_name"].astype(str)</span></pre><p id="1eee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">2.将函数应用于整列:</p><pre class="kj kk kl km gt lv lw lx bn ly lz bi"><span id="ce6a" class="ma mb it lw b be mc md l me mf">.assign(new_column=original_df["column_name"].apply(function_name)</span></pre><p id="5856" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，您也可以将多个函数按顺序应用于一个列。</p><h1 id="33f7" class="mg mb it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">数据调查</h1><p id="6e5f" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li mz lk ll lm na lo lp lq nb ls lt lu im bi translated">在对原始 Twitter 数据实现了这个庞大的链之后，我们有了一个整洁的、可读的数据框架，我们想要检查它。</p><p id="dd10" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">简单的方法<code class="fe nc nd ne lw b">.info()</code>为您提供了关于数据框的大量信息，包括:</p><ul class=""><li id="6382" class="nf ng it lb b lc ld lf lg li nh lm ni lq nj lu nk nl nm nn bi translated">行数(和索引范围)</li><li id="bbb1" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">列数</li><li id="8e1a" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">列名</li><li id="28b0" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">列的数据类型</li><li id="47fc" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">每列非空值的数量</li><li id="4189" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">内存使用</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="1b38" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个方便的一行程序可以获得每列的空值数量:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="d615" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nc nd ne lw b">.describe()</code>方法为您提供了每个列中数据的实际值和分布的概述。根据列的数据类型将<code class="fe nc nd ne lw b">.describe()</code>应用于列，以获得更清晰的输出，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="2e20" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe nc nd ne lw b">dtype="object"</code>上调用<code class="fe nc nd ne lw b">.describe()</code>的结果不是特别有洞察力，因为列<code class="fe nc nd ne lw b">id</code>、<code class="fe nc nd ne lw b">username</code>和<code class="fe nc nd ne lw b">text</code>包含字符串值而不是分类数据。然而，<code class="fe nc nd ne lw b">party</code>列的行值可能会显示一个潜在的模式。</p><h1 id="4604" class="mg mb it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">数据汇总和分析</h1><p id="a54f" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li mz lk ll lm na lo lp lq nb ls lt lu im bi translated">分类变量的数据聚合通常是我为 NLP 项目进行的任何分析的第一部分。tweet 数据集中最明显的聚合变量是<code class="fe nc nd ne lw b">party</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="8a5b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，让我们转到一些更高级的聚合。像这样按顺序链接<code class="fe nc nd ne lw b">.groupby()</code>和<code class="fe nc nd ne lw b">.agg()</code>函数可以更容易地从整体上理解聚合:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="80e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">应用聚合后，生成的索引难以阅读。<code class="fe nc nd ne lw b">.pipe()</code>方法是将一个函数应用于整个数据帧的干净熊猫方法。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><h1 id="0f96" class="mg mb it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">结论</h1><p id="302a" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li mz lk ll lm na lo lp lq nb ls lt lu im bi translated">编写干净的熊猫代码的关键是强迫自己使用<strong class="lb iu">方法链接</strong>。这样做最终会使您的代码更具可读性和可解释性，更易于调试，甚至节省内存。正如本文所展示的，您可以在数据生命周期的每个部分使用方法链，包括清理、调查、聚集和分析数据。有关方法链接的更多信息，请查看下面的参考资料。</p></div><div class="ab cl nw nx hx ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="im in io ip iq"><p id="6617" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="od">如果您想了解最新的数据科学趋势、技术和软件包，请考虑成为中级会员。你将可以无限制地访问像《走向数据科学》这样的文章和博客，并且你会支持我的写作。(每个会员我赚一小笔佣金)。</em></p><div class="oe of gp gr og oh"><a href="https://medium.com/@mary.newhauser/membership" rel="noopener follow" target="_blank"><div class="oi ab fo"><div class="oj ab ok cl cj ol"><h2 class="bd iu gy z fp om fr fs on fu fw is bi translated">通过我的推荐链接加入媒体-玛丽·纽豪斯</h2><div class="oo l"><h3 class="bd b gy z fp om fr fs on fu fw dk translated">阅读玛丽·纽豪斯(以及媒体上成千上万的其他作家)的每一个故事。您的会员费直接支持…</h3></div><div class="op l"><p class="bd b dl z fp om fr fs on fu fw dk translated">medium.com</p></div></div><div class="oq l"><div class="or l os ot ou oq ov ks oh"/></div></div></a></div><h1 id="6187" class="mg mb it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">想要连接吗？</h1><ul class=""><li id="9a6c" class="nf ng it lb b lc mx lf my li ow lm ox lq oy lu nk nl nm nn bi translated">📖跟着我上<a class="ae ky" href="https://medium.com/@mary.newhauser" rel="noopener">媒</a></li><li id="2964" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">🔗查看我的其他<a class="ae ky" href="https://www.datascienceportfol.io/marynewhauser" rel="noopener ugc nofollow" target="_blank">项目</a></li></ul><h1 id="5ab5" class="mg mb it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">资源</h1><ul class=""><li id="d299" class="nf ng it lb b lc mx lf my li ow lm ox lq oy lu nk nl nm nn bi translated"><a class="ae ky" href="https://github.com/m-newhauser/clean-pandas" rel="noopener ugc nofollow" target="_blank">本文的支持代码</a></li><li id="fd96" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">马特·哈里森的《有效的熊猫》</li><li id="76b5" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><a class="ae ky" href="https://tomaugspurger.github.io/modern-1-intro" rel="noopener ugc nofollow" target="_blank">现代熊猫</a></li><li id="d452" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><a class="ae ky" href="https://pandas.pydata.org/docs/" rel="noopener ugc nofollow" target="_blank">熊猫文档</a></li></ul><h1 id="f6cc" class="mg mb it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">参考</h1><p id="c4ea" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li mz lk ll lm na lo lp lq nb ls lt lu im bi translated">(1) M. Newhauser，<a class="ae ky" href="https://github.com/m-newhauser/distilbert-senator-tweets" rel="noopener ugc nofollow" target="_blank"> DistilBERT 参议员推文</a> (2022)。</p><p id="83a1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">(2) T. Augspurger，<a class="ae ky" href="https://tomaugspurger.github.io/modern-1-intro.html" rel="noopener ugc nofollow" target="_blank">现代熊猫(上)</a> (2016)。</p><p id="32e3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">(3) M. Harrison &amp; T. Petrou，<a class="ae ky" href="https://www.packtpub.com/product/pandas-1-x-cookbook-second-edition/9781839213106" rel="noopener ugc nofollow" target="_blank"> Pandas 1.x cookbook:使用 Python 进行科学计算、时间序列分析和探索性数据分析的实用食谱(第二版)</a> (2020)。</p><p id="9253" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">(4) Python 软件基础，<a class="ae ky" href="https://docs.python.org/3/tutorial/classes.html#:~:text=A%20method%20is%20a%20function,%2C%20sort%2C%20and%20so%20on" rel="noopener ugc nofollow" target="_blank"> 9。类别</a> (2022)。</p><p id="bec5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">(5) Twitter，<a class="ae ky" href="https://developer.twitter.com/en/docs/twitter-api" rel="noopener ugc nofollow" target="_blank"> Twitter API 文档</a> (2022)。</p></div></div>    
</body>
</html>