<html>
<head>
<title>Important Syntax Updates of Elasticsearch 8 in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python中Elasticsearch 8的重要语法更新</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/important-syntax-updates-of-elasticsearch-8-in-python-4423c5938b17#2022-06-12">https://towardsdatascience.com/important-syntax-updates-of-elasticsearch-8-in-python-4423c5938b17#2022-06-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2c76" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">一些帮助你应对弹性搜索突变的建议</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/2c92537fe9fae493f40a6058c354593c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qCpGYiSJqTFadtmk.jpg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由皮沙贝的<a class="ae ky" href="https://pixabay.com/illustrations/update-upgrade-to-update-board-1672385/" rel="noopener ugc nofollow" target="_blank">杰拉德</a>拍摄</p></figure><p id="face" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Elasticsearch Python客户端库第8版有不少突破性的改动，在你从7版更新到8版的时候会给你带来很多麻烦。尽管这可能是一项痛苦的任务，但仍然建议将库更新到最新版本，因为已经添加了许多新功能，并且应该更加用户友好。在这篇文章中，我们将概述Elasticsearch 8的重要语法更新，这将有助于您重构代码，使其与最新版本的库一起工作。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="e14e" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">准备</h2><p id="9629" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">如果您想测试本文中演示的代码片段，最好在本地运行一个Elasticsearch服务器。我们将<a class="ae ky" href="https://levelup.gitconnected.com/how-to-run-elasticsearch-8-on-docker-for-local-development-401fd3fff829" rel="noopener ugc nofollow" target="_blank">使用Docker启动Elasticsearch和Kibana containers </a>，使用Docker图像的最新版本，在撰写本文时是8.2.2版，但应该也适用于8版的其他图像。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="6314" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，我们需要安装Elasticsearch Python客户端库的版本8。最好将它安装在一个虚拟环境中，这样它就不会影响你系统中现有的库。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="9f5b" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">对连接使用严格的客户端配置</h2><p id="173f" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">在Elasticsearch版本8中，删除了<em class="nc">方案</em>、<em class="nc">主机</em>和<em class="nc">端口</em>的默认值，现在我们需要明确指定它们。否则会有一个<code class="fe nd ne nf ng b">ValueError</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="63e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有关客户端配置的更多示例，请查看此<a class="ae ky" href="https://github.com/elastic/elasticsearch-py/issues/1690" rel="noopener ugc nofollow" target="_blank"> GitHub问题</a>。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="9a97" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">使用Elasticsearch而不是IndicesClient来管理指数</h2><p id="0278" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">我们曾经使用<code class="fe nd ne nf ng b"><a class="ae ky" href="https://elasticsearch-py.readthedocs.io/en/v7.12.0/api.html#indices" rel="noopener ugc nofollow" target="_blank">IndicesClient</a></code>类来管理索引。然而，它已经过时了，我们现在应该使用<code class="fe nd ne nf ng b">Elasticsearch</code>类来直接管理索引。实际上，在本文中，我们将使用上面创建的<code class="fe nd ne nf ng b">es_client</code>对象来执行所有与索引相关的操作。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="ee73" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">API只允许关键字参数</h2><p id="a9b7" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">在Elasticsearch版本8中，我们只能对所有API使用关键字参数。现在使用关键字参数将引发一个<code class="fe nd ne nf ng b">TypeError</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="04a5" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">使用client.options()指定传输参数</h2><p id="7a7c" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">像<code class="fe nd ne nf ng b">ignore</code>这样的每请求选项现在应该用<code class="fe nd ne nf ng b">client.options()</code>来指定，而不是在API方法中。另外，<code class="fe nd ne nf ng b">ignore</code>现在改名为<code class="fe nd ne nf ng b">ignore_status</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="2612" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">更多用<code class="fe nd ne nf ng b">client.options()</code>指定的选项可在<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/client/python-api/current/migration.html#migration-options" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="0a5f" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">使用顶级参数而不是body字段</h2><p id="3344" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">这可能是影响最大的变化。我们曾经使用<code class="fe nd ne nf ng b">body</code>字段来指定所有与Elasticsearch相关的设置或搜索查询，如本文中的<a class="ae ky" href="https://lynn-kwong.medium.com/all-you-need-to-know-about-using-elasticsearch-in-python-b9ed00e0fdf0" rel="noopener">所示。现在我们需要将它们全部改为顶级参数。它不仅仅影响<code class="fe nd ne nf ng b">search</code> API，而是影响所有的API。例如，<code class="fe nd ne nf ng b">create</code> API需要更新如下:</a></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="742d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，我们只需要将<code class="fe nd ne nf ng b">body</code>参数扩展到顶级参数。如果你不想一个接一个地明确指定顶级参数，你可以使用字典扩展语法<code class="fe nd ne nf ng b">**<a class="ae ky" href="https://gist.github.com/lynnkwong/3c5ed5b3225a1e4e56e9bc6b739881e2#file-elasticsearch-index-configurations-py" rel="noopener ugc nofollow" target="_blank">configuaration</a></code>。这一变化同样适用于所有的Elasticsearch APIs。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="c564" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">批量API的更新</h2><p id="2c60" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">当我们有大量文档需要索引时，我们可以使用<code class="fe nd ne nf ng b">bulk</code> API来批量加载它们。现在语法也不同了。首先，我们需要明确地指定索引。此外，我们应该使用<code class="fe nd ne nf ng b">operations</code>而不是<code class="fe nd ne nf ng b">body</code>参数来指定动作:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="cd8d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还要注意，在旧语法中，<code class="fe nd ne nf ng b">actions</code>是一个长字符串，每个动作由一个换行符分隔。然而，在新的语法中，<code class="fe nd ne nf ng b">actions</code>可以是作为字典的操作列表，这意味着我们现在不需要将每个操作作为JSON字符串转储。我们还可以使用带有新语法的<code class="fe nd ne nf ng b">filter_path</code>参数来指定在响应中显示哪些字段。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="fc22" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">API响应现在是对象而不是字典</h2><p id="aabd" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">在以前的版本中，Elasticsearch APIs的响应是字典，你通常通过<code class="fe nd ne nf ng b">resp['hits']['hits']</code>得到结果。然而，在Elasticsearch 8中，响应不再是字典，而是类<code class="fe nd ne nf ng b">ObjectApiResponse</code>的实例。它有两个属性，<code class="fe nd ne nf ng b">meta</code>和<code class="fe nd ne nf ng b">body</code>，分别用于访问请求元数据和结果。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="7817" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">神奇的是，我们仍然像以前一样直接访问<code class="fe nd ne nf ng b">hits</code>键。但是，我们只能像访问字典键一样访问它，而不能访问对象属性。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="4f1b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是为了与旧的行为保持一致。我认为这也可能会被否决，因此，更安全的方法是从<code class="fe nd ne nf ng b">body</code>访问<code class="fe nd ne nf ng b">hits</code>，如上所示。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="8440" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">使用更细粒度的错误类</h2><p id="bf0b" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">在以前的版本中，<code class="fe nd ne nf ng b">TransportError</code>既包括传输错误(如连接超时)也包括API错误(如未找到索引)。但在Elasticsearch版中，<code class="fe nd ne nf ng b">TransportError</code>只覆盖了传输错误，新的<code class="fe nd ne nf ng b">ApiError</code>需要用于API错误，对调试更有帮助。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="5203" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本帖中，我们介绍了在Python中使用Elasticsearch 8的一些重要语法更新。它们中的许多都是突破性的改变，这意味着你需要更新你以前的Python代码，以使它们适用于最新的版本。有了本文中展示的列表，代码的重构应该会简单得多。您也可以参考<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/client/python-api/current/migration.html#migration-options" rel="noopener ugc nofollow" target="_blank">官方文档</a>和<a class="ae ky" href="https://github.com/elastic/elasticsearch-py/issues/1696" rel="noopener ugc nofollow" target="_blank"> GitHub问题</a>来更好地了解变化的原因以及更多技术细节。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="aac8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">相关文章:</p><ul class=""><li id="542a" class="nh ni it lb b lc ld lf lg li nj lm nk lq nl lu nm nn no np bi translated"><a class="ae ky" href="https://lynn-kwong.medium.com/all-you-need-to-know-about-using-elasticsearch-in-python-b9ed00e0fdf0" rel="noopener">关于在Python中使用Elasticsearch你需要知道的一切</a></li></ul></div></div>    
</body>
</html>