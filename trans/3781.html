<html>
<head>
<title>Coping with Daylight saving time in Hourly Reporting</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在每小时报告中应对夏令时</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/coping-with-daylight-saving-time-in-hourly-reporting-b753578927a6#2022-08-22">https://towardsdatascience.com/coping-with-daylight-saving-time-in-hourly-reporting-b753578927a6#2022-08-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1f5b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">当你需要每小时报告一次时，夏令时开关可能是一个真正的问题。我是这样解决的。</h2></div><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/c1a07efa8157d26897419d447ce6b3a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YeNnWXBnUKjGS1mL"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">照片由<a class="ae kz" href="https://unsplash.com/@jontyson?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">乔恩·泰森</a>在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h1 id="05ea" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">介绍</h1><p id="816d" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">通常，我们以天或更低的粒度创建报告。</p><p id="440c" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">一段时间以前，我为一个客户工作，该客户为他们的生产线创建能耗报告，这些生产线全天候运行。</p><p id="1831" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">他们的数据汇总到15分钟。</p><p id="e97d" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在这种情况下，切换到夏令时再切换回太阳时会导致报告中出现问题。</p><p id="6fb9" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">对于本文，我创建了一个基于日期和时间的表，时间序列为每分钟一行，每行的值为1。</p><p id="bf60" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">这样，我可以直接展示开关的效果。</p><h1 id="d0f3" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">问题</h1><p id="2b84" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">当我将该表加载到Power BI中时，当我查看每月级别的数据时，我得到以下报告:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi mt"><img src="../Images/2d47279cd36a21ea258d0b2dcb309cda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DUOj6NvntOcALDwx0dsn6Q.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图1 —问题(作者提供的图)</p></figure><p id="ed31" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">当我查看其中一个月的每日级别时，在没有开关的情况下，在小时级别的数据上添加工具提示后，我得到以下报告:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi mu"><img src="../Images/67a0038735dde3b446609ccc1cd76d8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sAqa9g1XBlOWfURKcVXUlQ.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图2——每日平均每月的问题(作者提供的数字)</p></figure><p id="8919" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">现在，我们来看一个月的每日数据，其中包含一个开关:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi mv"><img src="../Images/40e9b7c6616399f1de61a61c25b37a03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eaaFtuAAD8t1TwF9-37hTw.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图3 —带开关的一天的数据(由作者提供)</p></figure><p id="38f0" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">如你所见，我们的数据在秋季有一个峰值。在春天，当我们从太阳时切换到夏令时时，我们会在数据中得到一个间隙。</p><p id="d62a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">问题是，在现实中，数据没有间隙和尖峰，但我们看到它们是因为开关。</p><p id="18d2" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">这可能会使报告的消费者感到困惑。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi mw"><img src="../Images/18ca9b86d2082cb23c53615f60540b33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*e974Rf9pbvECYFxN"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">Dex Ezekiel 在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="d9d9" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">解决办法</h1><p id="86e2" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">一个可能的解决方案的第一步是用开关识别日子。</p><p id="07bf" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">为此，当我在Azure SQL数据库中加载我的日期表时，我使用了以下T-SQL代码:</p><pre class="kk kl km kn gt mx my mz na aw nb bi"><span id="f91d" class="nc lb it my b gy nd ne l nf ng">SET @TimeZone_Offset =<br/>  DATEDIFF(hh,<br/>    DATEADD(hh, 4, @DT),<br/>    CONVERT(datetime2,<br/>      SWITCHOFFSET(DATEADD(hh, 4, @DT),<br/>             DATEPART(TZOFFSET,<br/>                DATEADD(hh, 4, @DT<br/>                AT TIME ZONE ‘Central European Standard Time’)<br/>                )<br/>            )<br/>       );</span></pre><p id="610d" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">变量@DT包含一个日期。</p><p id="9694" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">然后，我向DATEDIFF()的第一个参数的日期添加四个小时。</p><p id="0f13" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">下一步是使用SWITCHOFFSET()作为DATEDIFF()的第二个参数切换到UTC时区，并获得本地时区和UTC之间的差异。在调用DATEPART(TZOFFSET，…)函数时，需要设置您的时区。</p><p id="ff9f" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">将数据写入数据表后，我使用下面的代码用时间开关在每一行上设置一个特殊值:</p><pre class="kk kl km kn gt mx my mz na aw nb bi"><span id="05d2" class="nc lb it my b gy nd ne l nf ng">WITH [Result]<br/>AS<br/>(SELECT [DateKey]<br/>    ,CASE [TimeZone_Offset] — LAG([TimeZone_Offset], 1, 1)<br/>                                   OVER(ORDER BY [DateKey])<br/>       WHEN 1 THEN 2.5<br/>       WHEN -1 THEN 1.5<br/>       ELSE [TimeZone_Offset]<br/>     END AS [TimeZone_Offset_Chg]<br/>   FROM [dbo].[Date])<br/>UPDATE [dbo].[Date]<br/>    SET [TimeZone_Offset] = [R].[TimeZone_Offset_Chg]<br/>  FROM [dbo].[Date] AS [D]<br/>     INNER JOIN [Result] AS [R]<br/>        ON [R].[DateKey] = [D].[DateKey];</span></pre><p id="00f4" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我使用LAG()函数将实际行与前一行进行比较，以查看值是否发生了变化。</p><p id="5934" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">然后，当事情发生变化时，我设置特定的值(秋天为1.5，春天为2.5)。</p><p id="ded1" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">这样，我就可以找到在太阳时和夏令时之间转换的日子。</p><p id="3263" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">接下来是我想如何处理这些信息。</p><p id="5abf" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">例如，我想在我的报告中显示那天是否发生了切换。</p><p id="2f71" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">为了实现这个目标，我创造了一种新的方法来编辑动态评论:</p><pre class="kk kl km kn gt mx my mz na aw nb bi"><span id="d226" class="nc lb it my b gy nd ne l nf ng">Comment =<br/>IF(HASONEVALUE(DayLight_SavingTime_Demo[TimeZone_Offset])<br/>     ,”Normal OP”<br/>     ,”Switch of Daylight saving time happened”<br/>   )</span></pre><p id="63ff" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">当某一天发生切换时，HASONEVALUE()为列[TimeZone_Offset]返回false。</p><p id="6cc7" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">为了实现这一点，我设置了我的演示数据集来在正确的时间切换TimeZone_Offset:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/50397a964c534cdc30e5dca5fb8cf9bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:722/format:webp/1*z2r6nYT8TRv5E7xYtOnDJQ.png"/></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图4 —带开关的数据(作者提供的图)</p></figure><p id="41df" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">因此，当我用开关检查一天的列[TimeZone_Offset]时，我得到了不止一个值。所以，HASONEVALUE()返回FALSE。</p><p id="21e0" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在Power BI中，结果如下所示:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi ni"><img src="../Images/e92164289240caa3bd08c8373a964631.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WjsULOZ0ptuz482ItsmVDA.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图5 —带开关和动态标题的一天(作者提供的图片)</p></figure><p id="217a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在典型的一天，我显示文本“正常OP”:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nj"><img src="../Images/fb2585d8db293487dc0ac23b64fe7bcc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3xmT0u2VqF6t-MQ-nagjFA.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图6 —没有开关的日子和动态标题(作者提供的图片)</p></figure><p id="b513" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">这个小小的添加让消费者知道发生了什么，并正确理解数据。</p><h1 id="db12" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">结论</h1><p id="205e" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">虽然这是一个相当奇特的问题，但在处理这个问题时，我学到了很多关于使用时区的知识。</p><p id="3325" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在这种情况下，你可能会找到另一种方式来展示你的结果。</p><p id="e874" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">例如，我的客户正在考虑在秋天转换时平滑一天中的值。我还不知道他将如何处理春季数据的缺口。</p><p id="6615" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">无论如何，我的方法让你敞开心扉，说出你想如何应对这种情况。它只为您提供了完成这项工作的工具集。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nk"><img src="../Images/0d1cf9e48e393073f9547d71f8de9a8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Vr5AuTkp5l-XV3Q0"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">Yianni Mathioudakis 在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="cdcc" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">这取决于你和你的用户来制定细节以应对时间的转换。</p><div class="nl nm gp gr nn no"><a href="https://medium.com/@salvatorecagliari/membership" rel="noopener follow" target="_blank"><div class="np ab fo"><div class="nq ab nr cl cj ns"><h2 class="bd iu gy z fp nt fr fs nu fu fw is bi translated">通过我的推荐链接加入Medium-Salvatore Cagliari</h2><div class="nv l"><h3 class="bd b gy z fp nt fr fs nu fu fw dk translated">阅读萨尔瓦托勒·卡利亚里的每一个故事(以及媒体上成千上万的其他作家)。您的会员费直接…</h3></div><div class="nw l"><p class="bd b dl z fp nt fr fs nu fu fw dk translated">medium.com</p></div></div><div class="nx l"><div class="ny l nz oa ob nx oc kt no"/></div></div></a></div></div></div>    
</body>
</html>