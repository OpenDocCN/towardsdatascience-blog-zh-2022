<html>
<head>
<title>Elasticsearch Python workshop #1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Elasticsearch Python 研讨会#1</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/elasticsearch-python-workshop-1-741fa8b9aaf1#2022-02-20">https://towardsdatascience.com/elasticsearch-python-workshop-1-741fa8b9aaf1#2022-02-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d401" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">基础知识</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/24a1a1a77f09efee566277c69814bd32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lnyhfRyDCk1GAknS"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">戴维·克洛德在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="6a4a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">欢迎来到 Elasticsearch Python 研讨会的第一部分。本系列将从 Python 程序员的角度来关注这个问题，我希望我能对这个小型生态系统有所了解，这个生态系统是用 Python 客户端和工具从 Elasticsearch 集群中获取额外数据而构建起来的。特别是当你是一个数据科学家时，这个系列可能会节省你一些时间。像所有的研讨会一样:为了保持文章简洁，我把代码剪成了片段。但是你可以从<a class="ae kv" href="https://github.com/PascalThalmann/ElasticPythonWorkshop/tree/master/1_the_basics" rel="noopener ugc nofollow" target="_blank"> GitHub repo 为这个工作坊</a>下载完整的代码。话虽如此，让我们直入主题吧。</p><p id="6c04" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我在<a class="ae kv" href="https://cdax.ch/2020/10/10/elasticsearch-migration-6-2-2-nach-7-8-0/" rel="noopener ugc nofollow" target="_blank"> Elasticsearch 迁移 6.22 到 7.8.0 </a>(抱歉，这篇文章只有德语版)中使用了 python 库<a class="ae kv" href="https://elasticsearch-py.readthedocs.io/en/7.10.0/index.html" rel="noopener ugc nofollow" target="_blank"> Python Elasticsearch 客户端</a>用于 reindex 任务。为了节省您的时间，我们从安装和一些基本的配置设置开始。这可能会更方便，因为 Elasticsearch 8.0.0 增强了安全性——在没有任何安全性的情况下连接到本地主机是默认不启用的。但是首先，让我们安装 Elasticsearch 客户端。下面的例子是使用 Ubuntu 18.04 LTS。</p><h1 id="e221" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">安装库</h1><p id="34b7" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">使用 pip3 安装最新的 Elasticsearch 客户端:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="52b0" class="mu lt iq mq b gy mv mw l mx my">sudo apt update &amp;&amp; sudo apt upgrade<br/>sudo apt install python3-pip<br/>sudo python3 -m pip install 'elasticsearch&gt;=7.0.0,&lt;8.0.0'<br/>sudo python3 -m pip install elasticsearch_dsl</span></pre><h1 id="023f" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">创建您的第一个连接</h1><p id="17f8" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">让我们从简单开始，假设您的集群是 pre-Elasticsearch=8.0.0，并且您没有实现安全性。如果没有将节点暴露给网络，请连接到“localhost”而不是主机名。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="fa73" class="mu lt iq mq b gy mv mw l mx my">es = Elasticsearch(["<a class="ae kv" href="http://srvelk:9200" rel="noopener ugc nofollow" target="_blank">http://srvelk:9200</a>"])<br/>es.cat.nodes()</span></pre><p id="fc71" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">就是这样。没有安全措施很简单，对吧？好了，让我们看看在启用安全性时需要做些什么。</p><h1 id="28e6" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">创建启用安全性的连接</h1><p id="ce25" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">为了通过安全集群建立连接，我们需要再安装一个 pip 模块(可能已经安装了，只要确保您已经安装了):</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="c889" class="mu lt iq mq b gy mv mw l mx my">sudo python3 -m pip install urllib3</span></pre><p id="8d8b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可能还没有证书，但您至少需要一个用户名/密码。您可以像这样设置连接:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="3797" class="mu lt iq mq b gy mv mw l mx my">from ssl import create_default_context<br/>from elasticsearch import Elasticsearch</span><span id="3da7" class="mu lt iq mq b gy mz mw l mx my">es = Elasticsearch(["<a class="ae kv" href="https://username:password@srvelk:9200" rel="noopener ugc nofollow" target="_blank">https://username:password@srvelk:9200</a>"], verify_certs=False)<br/>es.cat.nodes()</span></pre><p id="c169" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这将是可行的，但会产生一些令人不快的警告。我们最好使用证书，所以如果您没有证书，让我们创建一个 pem-certificate。</p><h1 id="01f3" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">生成 pem 证书</h1><p id="98bd" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">如果您使用默认设置安装了 Elasticsearch 8，您可能不知道集群的 SSL-Keystore 密码。但是温和地说，Elastic 提供了直接从密钥库中读取密码的工具，但是您需要 root 权限:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="3bf5" class="mu lt iq mq b gy mv mw l mx my">/usr/share/elasticsearch/bin/elasticsearch-keystore \<br/>   show xpack.security.http.ssl.keystore.secure_password</span></pre><p id="4963" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是将证书添加到密钥库中所需的“导入密码”。我们现在使用 OpenSSL 创建证书 python_es_client.pem:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="06a4" class="mu lt iq mq b gy mv mw l mx my">openssl pkcs12 -in /etc/elasticsearch/certs/http.p12 \<br/>   -cacerts -out /etc/elasticsearch/certs/python_es_client.pem</span></pre><p id="b7c3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">出现提示时，输入密码。选择您选择的 PEM 密码。之后，将 pem 文件复制到 python 脚本可以访问的位置。将您的证书存储在/tmp 中并不是一个好的选择，这只是出于演示的目的。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="0eaa" class="mu lt iq mq b gy mv mw l mx my">chmod 666 /etc/elasticsearch/certs/python_es_client.pem<br/>cp /etc/elasticsearch/certs/python_es_client.pem /tmp</span></pre><p id="0b6e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们用 Python 创建另一个连接:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="a2b3" class="mu lt iq mq b gy mv mw l mx my">from ssl import create_default_context<br/>from elasticsearch import Elasticsearch</span><span id="0bbb" class="mu lt iq mq b gy mz mw l mx my">context = create_default_context(cafile='/tmp/python_es_client.pem')<br/>es = Elasticsearch(["<a class="ae kv" href="https://username:password@srvelk:9200" rel="noopener ugc nofollow" target="_blank">https://username:password@srvelk:9200</a>"], ssl_context=context)<br/>es.cat.nodes()</span></pre><p id="5607" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最好不要在脚本中包含您的用户名和密码。我们需要的是一个 API 密钥，并在没有凭据的情况下连接到集群。</p><h1 id="163c" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">使用 API 密钥连接</h1><p id="7988" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我们需要首先创建一个角色。转到堆栈管理-&gt;角色并创建一个角色。该角色必须至少包含“管理 api 密钥”权限</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi na"><img src="../Images/5b423afccf2ab1a062e4425cb3097c32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*iF4bbx_OYdh3RGP8.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="8592" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在向用户添加或创建一个角色。转到堆栈管理-&gt;用户并添加角色:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nb"><img src="../Images/01ba227cfe540b70eadc087f6a0f1ba7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ti4iVeOkvqS50z2O.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="7437" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在生成 API 密钥。转到堆栈管理-&gt; API 密钥，并为需要通过 API 密钥访问的用户创建 API 密钥。请在创建后将 API 密钥保存在安全的地方:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/bcfab55550fbcb6e2f433ee70adb2d83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/format:webp/0*hn6DcaVkDnaSkEkW.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="9907" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们用 Python 创建另一个连接:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="5b3b" class="mu lt iq mq b gy mv mw l mx my">from ssl import create_default_context<br/>from elasticsearch import Elasticsearch</span><span id="54c4" class="mu lt iq mq b gy mz mw l mx my">api_key='aC1wNUYzOEJCWV...RSjJMaEhvbDMyWElvZw=='<br/>context = create_default_context(cafile='/tmp/python_es_client.pem')<br/>es = Elasticsearch(["<a class="ae kv" href="https://srvelk:9200" rel="noopener ugc nofollow" target="_blank">https://srvelk:9200</a>"], ssl_context=context, api_key=api_key)<br/>es.cat.nodes()</span></pre><p id="528e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个看起来更好🙂</p><h1 id="d246" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结论</h1><p id="e2fc" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">如果你成功了:祝贺你！现在，您应该能够创建与 Python Elasticsearch 客户端的连接了。如有问题，请查阅官方文档或给我留言。你也可以和我联系或者关注<a class="ae kv" href="https://www.linkedin.com/in/pascal-thalmann/" rel="noopener ugc nofollow" target="_blank">链接。</a></p><p id="bd79" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果谷歌把你带到这里，你可能还会检查这个系列的其他<a class="ae kv" href="https://pascalth.medium.com/list/python-elasticsearch-workshop-947054f07bd9" rel="noopener">部分</a></p></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><p id="34bc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="nk">原发布于</em><a class="ae kv" href="https://cdax.ch/2022/02/20/elasticsearch-python-workshop-1-the-basics/" rel="noopener ugc nofollow" target="_blank"><em class="nk">https://cdax . ch</em></a><em class="nk">。</em></p></div></div>    
</body>
</html>