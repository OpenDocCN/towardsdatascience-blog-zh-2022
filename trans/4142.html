<html>
<head>
<title>3 Reasons Why Spark’s Lazy Evaluation is Useful</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Spark懒评有用的3个理由</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/3-reasons-why-sparks-lazy-evaluation-is-useful-ed06e27360c4#2022-09-14">https://towardsdatascience.com/3-reasons-why-sparks-lazy-evaluation-is-useful-ed06e27360c4#2022-09-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1993" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">Spark的懒评以及你为什么要在意</h2></div><p id="222c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">作者:<a class="ae le" href="https://medium.com/u/d38873cbc5aa?source=post_page-----40d1ab7243c2--------------------------------" rel="noopener">阿玛尔·哈斯尼</a> &amp; <a class="ae le" href="https://medium.com/u/7f47bdb8b8c0?source=post_page-----40d1ab7243c2--------------------------------" rel="noopener">迪亚·赫米拉</a></p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lf"><img src="../Images/b32a0f89a0dffbd61ac232c14e5d0434.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w-X5igGod0iIlDrf_-4KNw.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">照片由<a class="ae le" href="https://unsplash.com/@karsten116?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">卡斯滕·怀恩吉尔特</a>在<a class="ae le" href="https://unsplash.com/s/photos/dog-sleeping?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="5df0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有多少次你在笔记本上运行PySpark代码，期望看到一个漂亮的格式化表格，却得到一些“随机”字符串？很快你意识到你忘了展示/显示你的数据框，于是你就把它修好了。但是实际发生了什么呢？</p><p id="383a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你可能已经知道答案:<strong class="kk iu">懒评</strong>。但是到底什么是懒惰评估，更重要的是为什么Spark会有这种行为？</p><pre class="lg lh li lj gt lv lw lx ly aw lz bi"><span id="ccf6" class="ma mb it lw b gy mc md l me mf"><strong class="lw iu">Table of Contents:</strong><br/>· <a class="ae le" href="#ad8a" rel="noopener ugc nofollow">What is Lazy Evaluation?</a><br/>· <a class="ae le" href="#cc3a" rel="noopener ugc nofollow">What is the difference between TRANSFORMATIONS and ACTIONS?</a><br/>  ∘ <a class="ae le" href="#c810" rel="noopener ugc nofollow">Transformations</a><br/>  ∘ <a class="ae le" href="#bda5" rel="noopener ugc nofollow">Actions</a><br/>· <a class="ae le" href="#1adb" rel="noopener ugc nofollow">Spark’s Catalyst Optimizer</a><br/>· <a class="ae le" href="#bfa6" rel="noopener ugc nofollow">What are the advantages of using Lazy Evaluation?</a></span></pre></div><div class="ab cl mg mh hx mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="im in io ip iq"><h1 id="ad8a" class="mn mb it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">什么是懒评？</h1><p id="8aa8" class="pw-post-body-paragraph ki kj it kk b kl ne ju kn ko nf jx kq kr ng kt ku kv nh kx ky kz ni lb lc ld im bi translated">首先，<em class="nj">懒惰评估</em>不是Spark发明的概念，已经存在一段时间了，只是众多评估策略中的一种。在我们的上下文中，了解以下两点是有用的:</p><ul class=""><li id="fd04" class="nk nl it kk b kl km ko kp kr nm kv nn kz no ld np nq nr ns bi translated"><em class="nj">惰性求值</em>是一种求值策略，将表达式的求值延迟到需要它的值的时候。</li><li id="8507" class="nk nl it kk b kl nt ko nu kr nv kv nw kz nx ld np nq nr ns bi translated"><em class="nj">急切求值</em>是你最熟悉的求值策略，在大多数编程语言中都有使用。与惰性求值相反，表达式的求值一遇到就执行。</li></ul><p id="02f5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们回到火花。在Spark中，<em class="nj">惰性评估</em>意味着您可以应用任意多的<strong class="kk iu">转换</strong>，但是Spark不会启动进程的执行，直到一个<strong class="kk iu">动作</strong>被调用。</p><blockquote class="ny"><p id="5bb7" class="nz oa it bd ob oc od oe of og oh ld dk translated">💡因此，转变是懒惰的，而行动是热切的。</p></blockquote><h1 id="cc3a" class="mn mb it bd mo mp oj mr ms mt ok mv mw jz ol ka my kc om kd na kf on kg nc nd bi translated">转换和动作之间的区别是什么？</h1><h2 id="c810" class="ma mb it bd mo oo op dn ms oq or dp mw kr os ot my kv ou ov na kz ow ox nc oy bi translated">转换</h2><p id="e13c" class="pw-post-body-paragraph ki kj it kk b kl ne ju kn ko nf jx kq kr ng kt ku kv nh kx ky kz ni lb lc ld im bi translated">转换是你用来以你想要的方式修改数据帧的指令，并且是延迟执行的。有两种类型的转换:</p><ul class=""><li id="5baf" class="nk nl it kk b kl km ko kp kr nm kv nn kz no ld np nq nr ns bi translated"><strong class="kk iu">窄</strong>转换:单个分区需要计算的数据存在于同一个分区中。<br/> <em class="nj">例子:</em> <code class="fe oz pa pb lw b"> select</code>，<code class="fe oz pa pb lw b"> filter</code></li></ul><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="ab gu cl pc"><img src="../Images/9945b88c6dbe9132ac1d7feea1fc953a.png" data-original-src="https://miro.medium.com/v2/0*2KWKs5Lvh1mupUEf"/></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">作者图片</p></figure><ul class=""><li id="86a9" class="nk nl it kk b kl km ko kp kr nm kv nn kz no ld np nq nr ns bi translated"><strong class="kk iu">宽</strong>转换:需要为单个分区计算的数据可能存在于多个分区中。<br/> <em class="nj">举例:</em> <code class="fe oz pa pb lw b"> groupBy</code>，<code class="fe oz pa pb lw b"> repartition</code></li></ul><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="ab gu cl pc"><img src="../Images/13a389df86f5ca9d4a53bdead94aee31.png" data-original-src="https://miro.medium.com/v2/0*IuvZokc1TdaqUmQ8"/></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">作者图片</p></figure><h2 id="bda5" class="ma mb it bd mo oo op dn ms oq or dp mw kr os ot my kv ou ov na kz ow ox nc oy bi translated">行动</h2><p id="2c63" class="pw-post-body-paragraph ki kj it kk b kl ne ju kn ko nf jx kq kr ng kt ku kv nh kx ky kz ni lb lc ld im bi translated">动作是要求立即计算一个值的语句，是急切的语句。<br/> <em class="nj">例子:</em><code class="fe oz pa pb lw b"> show</code><code class="fe oz pa pb lw b"> count</code><code class="fe oz pa pb lw b"> collect</code><code class="fe oz pa pb lw b"> save</code></p><p id="2379" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">💡通常，一个转换将获取一个RDD并返回另一个RDD。操作将采用RDD，但将返回不同性质的内容:</p><pre class="lg lh li lj gt lv lw lx ly aw lz bi"><span id="375e" class="ma mb it lw b gy mc md l me mf">.---------------- ---------.<br/>| Transformation | Actions |<br/>| -------------- | ------- |<br/>| select         | show    |<br/>| distinct       | count   |<br/>| groupBy        | collect |<br/>| sum            | save    |<br/>| orderBy        |         |<br/>| where          |         |<br/>| limit          |         |<br/>.---------------- ---------.</span></pre><h1 id="1adb" class="mn mb it bd mo mp oj mr ms mt ok mv mw jz pd ka my kc pe kd na kf pf kg nc nd bi translated">火花的催化剂优化器</h1><p id="96ae" class="pw-post-body-paragraph ki kj it kk b kl ne ju kn ko nf jx kq kr ng kt ku kv nh kx ky kz ni lb lc ld im bi translated">在说实际优势之前，我们先快速说一下Spark的<strong class="kk iu">触媒优化器</strong>。</p><p id="66e7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当执行不同的转换时，Spark会将它们存储在一个有向无环图(或DAG)中。你实际上可以在<strong class="kk iu"> SparkUI </strong>中查看DAG。下面是一个简单的例子，大概是这样的:</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="ab gu cl pc"><img src="../Images/70e1303c71056991646e6a0dbd5f332f.png" data-original-src="https://miro.medium.com/v2/0*cWEUvlErq9Mf3pdr"/></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">作者图片</p></figure><p id="7515" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦DAG被构建，Spark的catalyst优化器将执行一组基于规则和基于成本的优化，以确定执行的<a class="ae le" href="https://www.clairvoyant.ai/blog/apache-spark-logical-and-physical-plans" rel="noopener ugc nofollow" target="_blank">逻辑和物理计划</a>。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="gh gi pg"><img src="../Images/48574b2b8582ec0c291dc2d3da2a46af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/0*8jymyiQyW1D3lS-0"/></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">作者图片</p></figure><p id="7720" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">显然，这是一个非常简化的版本，但对于我们的目的来说已经足够了。如果你想了解更多细节，你可以看看Databricks博客上的这篇<a class="ae le" href="https://www.databricks.com/blog/2015/04/13/deep-dive-into-spark-sqls-catalyst-optimizer.html" rel="noopener ugc nofollow" target="_blank">帖子</a>。</p><h1 id="bfa6" class="mn mb it bd mo mp oj mr ms mt ok mv mw jz pd ka my kc pe kd na kf pf kg nc nd bi translated">用懒人评价有什么好处？</h1><p id="7150" class="pw-post-body-paragraph ki kj it kk b kl ne ju kn ko nf jx kq kr ng kt ku kv nh kx ky kz ni lb lc ld im bi translated">在使用惰性评估的优势中，我们发现了以下三点:</p><h2 id="a05c" class="ma mb it bd mo oo op dn ms oq or dp mw kr os ot my kv ou ov na kz ow ox nc oy bi translated">1.提高效率</h2><p id="6d4a" class="pw-post-body-paragraph ki kj it kk b kl ne ju kn ko nf jx kq kr ng kt ku kv nh kx ky kz ni lb lc ld im bi translated">Spark的Catalyst optimizer将操作组合在一起，减少数据传递次数，提高性能。</p><p id="1e93" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">catalyst优化器的另一个优点是，通常不会用于最终结果的值将不会被计算。</p><p id="c94e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">举个例子吧。让我们首先定义一些数据帧:</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="ph pi l"/></div></figure><p id="5882" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，如果我们添加一个“性别”列，然后立即覆盖它:</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="ph pi l"/></div></figure><p id="669f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Spark会自动将这些操作组合在一起，因此会忽略第一个定义，因为它在最终结果中实际上并不使用。快速浏览一下逻辑与物理计划会使其更加清晰:</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi pj"><img src="../Images/8b246a790e653906a4404df11b8d4ad0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y3nAQHX3S1_Mjzj8XzSakA.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">作者截图</p></figure><p id="a9d2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">所有这些也将优化驱动程序和集群通信，并加快程序。</p><p id="fb21" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">📔查看这篇<a class="ae le" href="https://www.projectpro.io/recipes/explain-spark-lazy-evaluation-detail" rel="noopener ugc nofollow" target="_blank">博客文章</a>获得更多详细的例子。</p><h2 id="c6c0" class="ma mb it bd mo oo op dn ms oq or dp mw kr os ot my kv ou ov na kz ow ox nc oy bi translated">2.更好的可读性</h2><p id="c42c" class="pw-post-body-paragraph ki kj it kk b kl ne ju kn ko nf jx kq kr ng kt ku kv nh kx ky kz ni lb lc ld im bi translated">因为您知道Spark将操作组合在一起并在幕后优化代码，所以您可以使用更小的操作来组织您的程序，这将提高代码的可读性和可维护性。</p><h2 id="2607" class="ma mb it bd mo oo op dn ms oq or dp mw kr os ot my kv ou ov na kz ow ox nc oy bi translated">3.内存管理</h2><p id="7d40" class="pw-post-body-paragraph ki kj it kk b kl ne ju kn ko nf jx kq kr ng kt ku kv nh kx ky kz ni lb lc ld im bi translated">如果Spark的转换迫在眉睫，您必须将所有中间数据帧/rdd存储在某个地方，或者至少管理内存将成为您的另一个关注点。</p><p id="25ef" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用惰性评估，Spark将只在实际需要的时候存储中间结果。</p><p id="457c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">显然，如果需要，您可以通过缓存或导出结果来手动规避这种行为。但是很多时候，中介结果是“中介”的，不需要存储。</p><h1 id="c1b4" class="mn mb it bd mo mp oj mr ms mt ok mv mw jz pd ka my kc pe kd na kf pf kg nc nd bi translated">最后的想法</h1><p id="8014" class="pw-post-body-paragraph ki kj it kk b kl ne ju kn ko nf jx kq kr ng kt ku kv nh kx ky kz ni lb lc ld im bi translated">不可否认的是，懒评估在优化和效率方面增加了很多价值。然而，它也伴随着一些挫折。</p><p id="353f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">其中一个原因是，惰性求值很难与来自命令式编程的特性一起使用，命令式编程假定执行顺序是固定的。一个例子是异常处理:如果在运行时发生错误，Spark只会在使用一个动作时显示它。由于操作的顺序是不确定的(由于潜在的优化)，这使得很难知道是哪个确切的转换导致了它。</p><p id="cda0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您是PySpark的新手，正在从Pandas过渡过来，或者只是想要一个不错的备忘单，您可能想看看这篇文章:</p><div class="pk pl gp gr pm pn"><a rel="noopener follow" target="_blank" href="/equivalents-between-pandas-and-pyspark-c8b5ba57dc1d"><div class="po ab fo"><div class="pp ab pq cl cj pr"><h2 class="bd iu gy z fp ps fr fs pt fu fw is bi translated">你从熊猫到PySpark的平稳过渡指南</h2><div class="pu l"><h3 class="bd b gy z fp ps fr fs pt fu fw dk translated">熊猫大战PySpark 101</h3></div><div class="pv l"><p class="bd b dl z fp ps fr fs pt fu fw dk translated">towardsdatascience.com</p></div></div><div class="pw l"><div class="px l py pz qa pw qb lp pn"/></div></div></a></div><p id="20fb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">谢谢你坚持到现在。注意安全，下一个故事再见😊！</p><h1 id="8d73" class="mn mb it bd mo mp oj mr ms mt ok mv mw jz pd ka my kc pe kd na kf pf kg nc nd bi translated">更多文章阅读</h1><div class="pk pl gp gr pm pn"><a rel="noopener follow" target="_blank" href="/8-tips-to-write-cleaner-code-376f7232652c"><div class="po ab fo"><div class="pp ab pq cl cj pr"><h2 class="bd iu gy z fp ps fr fs pt fu fw is bi translated">编写更简洁代码的8个技巧</h2><div class="pu l"><h3 class="bd b gy z fp ps fr fs pt fu fw dk translated">始终获得干净、可读和优雅的代码</h3></div><div class="pv l"><p class="bd b dl z fp ps fr fs pt fu fw dk translated">towardsdatascience.com</p></div></div><div class="pw l"><div class="qc l py pz qa pw qb lp pn"/></div></div></a></div><div class="pk pl gp gr pm pn"><a rel="noopener follow" target="_blank" href="/how-to-easily-merge-multiple-jupyter-notebooks-into-one-e464a22d2dc4"><div class="po ab fo"><div class="pp ab pq cl cj pr"><h2 class="bd iu gy z fp ps fr fs pt fu fw is bi translated">如何轻松将多台Jupyter笔记本合并为一台</h2><div class="pu l"><h3 class="bd b gy z fp ps fr fs pt fu fw dk translated">黑进你的Jupyter</h3></div><div class="pv l"><p class="bd b dl z fp ps fr fs pt fu fw dk translated">towardsdatascience.com</p></div></div><div class="pw l"><div class="qd l py pz qa pw qb lp pn"/></div></div></a></div></div></div>    
</body>
</html>