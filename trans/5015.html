<html>
<head>
<title>A Non-Exhaustive List Of ‘Silent’ Mistakes in SQL That Can Ruin Your Analysis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SQL中可能会破坏您的分析的“无声”错误的非详尽列表</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/a-non-exhaustive-list-of-silent-mistakes-in-sql-that-can-ruin-your-analysis-e5c62e6db489#2022-11-08">https://towardsdatascience.com/a-non-exhaustive-list-of-silent-mistakes-in-sql-that-can-ruin-your-analysis-e5c62e6db489#2022-11-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1de0" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">从犯了单子上大多数错误的人那里</h2></div><p id="e96e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我的大部分数据项目通常以同样的方式开始:一堆SQL查询。经过几年的经验，我认识到——有时是艰难的——不要搞砸这一步是至关重要的，因为即使是一个小错误也会很快使你得到的结果无效。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/0fe5515d8e5f01be884b1c466df0e9e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*F9hU4zfxu-cz-BfF"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">瓦尔瓦拉·格拉博瓦在<a class="ae lr" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="bfbe" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">犯这些小错误的方法有很多。我不是在说忘记“分组”或用零除某些东西——这些很容易发现，因为您的查询工具会返回错误。我说的是<strong class="kh ir">那些无声的错误</strong>，那些根本不会返回任何结果的错误，你根本没有任何警告。<strong class="kh ir">我说的是这样的情况，你最终相信你得到了你想要的结果，但你实际上没有——现在你所做的查询不允许你正确地回答你为自己设置的问题。</strong></p><p id="abe1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面是这些小错误的不完全列表，根据我自己的经验按频率排序。为了说明它们，我将使用<a class="ae lr" rel="noopener" target="_blank" href="/what-to-do-when-your-experiment-returns-a-non-statistically-significant-result-81ecaf56fb32">我通常的例子</a>——想象一下:</p><ul class=""><li id="c124" class="ls lt iq kh b ki kj kl km ko lu ks lv kw lw la lx ly lz ma bi translated">你在一家游戏公司工作，该公司发布了多个免费游戏(有可能删除付费用户的广告)。</li><li id="a820" class="ls lt iq kh b ki mb kl mc ko md ks me kw mf la lx ly lz ma bi translated">您的角色是了解用户增长，为此，您可以访问以下3个数据库:</li></ul><pre class="lc ld le lf gt mg mh mi mj aw mk bi"><span id="a0dc" class="ml mm iq mh b gy mn mo l mp mq"><strong class="mh ir">user_status_per_country</strong><br/>user_id <br/>country<br/>is_paid_user</span><span id="aa1d" class="ml mm iq mh b gy mr mo l mp mq"><strong class="mh ir">daily_country_revenue</strong><br/>date<br/>country<br/>monetization_source<br/>revenue</span><span id="3642" class="ml mm iq mh b gy mr mo l mp mq"><strong class="mh ir">daily_country_users</strong><br/>date<br/>country<br/>game_id<br/>users</span></pre><p id="551f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们开始吧！</p><h1 id="f317" class="ms mm iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">#1:假设数据库/字段的内容基于其名称或描述</h1><p id="d35a" class="pw-post-body-paragraph kf kg iq kh b ki nj jr kk kl nk ju kn ko nl kq kr ks nm ku kv kw nn ky kz la ij bi translated">让我们从一个例子开始:你如何使用<strong class="kh ir">user _ status _ per _ country</strong>来吸引所有的免费用户？</p><p id="4c81" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">应该是is _ paid _ user = FALSE吧？</p><p id="8af9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好吧，假设这个字段是主用户数据库和历史数据库之间的左连接的结果，历史数据库包含在任何时间点成为付费用户的所有用户及其当前状态，因此，它以这样一种方式实现，它实际上可以接受3个不同的值:TRUE(用户是付费用户)、FALSE(用户曾经是付费用户，现在不是了)和NULL(用户不存在于正确的数据库中，即它以前从未是付费用户)。</p><p id="6a0f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">那么is _ paid _ user = FALSE将不会给出您所需要的结果，因为这将返回过去至少支付过一次的所有用户。</p><p id="f1ed" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一般来说，由于您的大部分工作和结果都取决于您使用的数据源，因此不要依赖于关于字段/数据库内容的假设(尤其是基于命名的假设)是很重要的，并且要有办法确保您的假设是正确的。</p><h1 id="6e0f" class="ms mm iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">#2:由于重复而导致的超额计数</h1><p id="fce6" class="pw-post-body-paragraph kf kg iq kh b ki nj jr kk kl nk ju kn ko nl kq kr ks nm ku kv kw nn ky kz la ij bi translated">这是一个普通的。当您的表中要连接的字段上的每个值有多行时，您可能会遇到这种情况。</p><p id="d67b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，使用我在介绍中提到的情况，如果您尝试计算每个国家的每个用户的每日收入，您不能直接加入每日_国家_收入和每日_国家_用户，因为您在每日_国家_收入中有一个国家的每日多个条目(由于不同的货币化来源)，并且在每日_国家_用户中有一个国家的每日多个条目(由于不同的游戏id)。</p><p id="9835" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">具体来说，如果你这样写:</p><pre class="lc ld le lf gt mg mh mi mj aw mk bi"><span id="c91f" class="ml mm iq mh b gy mn mo l mp mq">SELECT<br/>  date,<br/>  country,<br/>  SUM(revenue) AS revenue,<br/>  SUM(users) AS users<br/>FROM daily_country_users<br/>JOIN daily_country_revenue<br/>USING(date_id,country)<br/>GROUP BY <br/>  date,<br/>  country</span></pre><p id="971b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你将最终过度计算你的用户和收入。</p><h1 id="be11" class="ms mm iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">#3:搞乱环境</h1><h2 id="9f5f" class="ml mm iq bd mt no np dn mx nq nr dp nb ko ns nt nd ks nu nv nf kw nw nx nh ny bi translated">逻辑错误</h2><p id="17ce" class="pw-post-body-paragraph kf kg iq kh b ki nj jr kk kl nk ju kn ko nl kq kr ks nm ku kv kw nn ky kz la ij bi translated">你知道一个程序员的笑话吗？他的搭档告诉他们“去商店，买一加仑牛奶，如果他们有鸡蛋，就买6加仑”，然后他们带着6加仑牛奶回来了。</p><p id="2a58" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里的概念是一样的——你需要确保你给出的条件是非常明确的，这样你才能得到你想要的。</p><p id="34c6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，如果您想获得法国或西班牙的付费用户，您应该编写如下查询</p><pre class="lc ld le lf gt mg mh mi mj aw mk bi"><span id="89d7" class="ml mm iq mh b gy mn mo l mp mq">is_paid_user AND (country_code = "FR" OR country_code = "ES")</span></pre><p id="d6dc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">而不是</p><pre class="lc ld le lf gt mg mh mi mj aw mk bi"><span id="1dbd" class="ml mm iq mh b gy mn mo l mp mq">is_paid_user AND country_code = "FR" OR country_code = "ES"</span></pre><p id="8d08" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因为这最后一个语句会给你所有法国付费用户和ES的所有用户。(旁注:IN语句也可以用在这里——但这对我阐述我的观点没有帮助)</p><p id="ebb0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">(无耻的自我推销:在这一点上，有些人可能会说，我们可以使用UNION ALL来提高性能，而不是使用“OR”。我们将在后续文章中讨论这个问题，敬请关注！).</p><h2 id="c328" class="ml mm iq bd mt no np dn mx nq nr dp nb ko ns nt nd ks nu nv nf kw nw nx nh ny bi translated">“疏忽”错误</h2><p id="78e8" class="pw-post-body-paragraph kf kg iq kh b ki nj jr kk kl nk ju kn ko nl kq kr ks nm ku kv kw nn ky kz la ij bi translated">这一条属于“关注细节”的范畴——确保你使用正确的条件是很重要的。尤其是在处理字符串的时候，比如字符串是大写的。使用前面的示例，下面的语句:</p><pre class="lc ld le lf gt mg mh mi mj aw mk bi"><span id="a71b" class="ml mm iq mh b gy mn mo l mp mq">is_paid_user AND (country_code = "fr" OR country_code = "ES")</span></pre><p id="377d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">…只会返回西班牙语付费用户。</p><h1 id="c5c6" class="ms mm iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">#4:误解一些函数/运算符的工作方式</h1><p id="d840" class="pw-post-body-paragraph kf kg iq kh b ki nj jr kk kl nk ju kn ko nl kq kr ks nm ku kv kw nn ky kz la ij bi translated">一个小测验:如果给定以下参数，你知道通常的聚合函数会做什么吗？</p><pre class="lc ld le lf gt mg mh mi mj aw mk bi"><span id="8e19" class="ml mm iq mh b gy mn mo l mp mq">1. AVG(1, 2, 3, 4, NULL, NULL)<br/>2. AVG(1, 2, 3, 4, 0, 0)<br/>3. COUNT("A", "B", "B", NULL, NULL)<br/>4. COUNT("A", "B", "B", "", "")<br/>5. STRING_AGG("A","B",NULL,"C",NULL)</span></pre><p id="5562" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一般来说，了解您使用的不同函数如何处理空值，以及这会如何影响您的结果(在某些情况下，您可能希望这些空值不被计算在内，而在其他情况下，您可能希望它们被视为0)是很重要的。</p><p id="d658" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">同样的事情也适用于操作人员——充分了解他们的行为可以避免糟糕的意外。例如，BETWEEN是包含性的，但是当您开始比较不同的日期格式时，这可能会有点误导(更多信息请参见<a class="ae lr" href="https://sqlblog.org/2009/10/16/bad-habits-to-kick-mis-handling-date-range-queries" rel="noopener ugc nofollow" target="_blank">本文</a>)，所以确保您很好地理解条件应该是什么以及您将使用的操作符将如何表现是很重要的。</p><h1 id="a31f" class="ms mm iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">#5:在第二个数据库上使用非空条件进行左/右连接</h1><p id="d27c" class="pw-post-body-paragraph kf kg iq kh b ki nj jr kk kl nk ju kn ko nl kq kr ks nm ku kv kw nn ky kz la ij bi translated">基本上，如果您执行左/右连接并在第二个表中的字段上添加一个非空条件，您就有点违背了使用左/右连接的目的，因为您将根据表2的条件筛选表1(而最有可能的情况是，如果您使用左/右连接，您希望表1中的所有记录只应用于表2)。</p><p id="c8f5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好吧，这可能很难理解—<a class="ae lr" href="https://stackoverflow.com/questions/9160991/left-join-with-condition" rel="noopener ugc nofollow" target="_blank">stack overflow上的这个问题</a>很好地说明了我在这里提到的内容，以及可以使用的解决方案。</p></div><div class="ab cl nz oa hu ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="ij ik il im in"><p id="be57" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是我在SQL中发现的前5个最好的无声错误——这些错误可能不会马上看到，但会严重影响您的工作。希望这个故事能起到警示作用，对一些人有所帮助！</p><p id="adaf" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">还有第六个问题，我遇到过很多次，我犹豫着要不要加到这个列表中:窗口函数的错误实现。最后，我认为窗口函数应该有它们自己的独立文章，所以我将在后续的故事中回到这一篇。</p><p id="18b8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">希望你喜欢阅读这篇文章！<strong class="kh ir">你有什么建议想要分享吗？在评论区让大家知道！</strong></p><p id="0b0a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你想更多地了解我，这里有一些你可能会喜欢的文章。</p><div class="og oh gp gr oi oj"><a rel="noopener follow" target="_blank" href="/7-tips-to-avoid-public-embarrassment-as-a-data-analyst-caec8f701e42"><div class="ok ab fo"><div class="ol ab om cl cj on"><h2 class="bd ir gy z fp oo fr fs op fu fw ip bi translated">让您的数据分析更加稳健的7个技巧</h2><div class="oq l"><h3 class="bd b gy z fp oo fr fs op fu fw dk translated">增强对结果的信心，建立更强大的个人品牌</h3></div><div class="or l"><p class="bd b dl z fp oo fr fs op fu fw dk translated">towardsdatascience.com</p></div></div><div class="os l"><div class="ot l ou ov ow os ox ll oj"/></div></div></a></div><div class="og oh gp gr oi oj"><a rel="noopener follow" target="_blank" href="/how-to-build-a-successful-dashboard-359c8cb0f610"><div class="ok ab fo"><div class="ol ab om cl cj on"><h2 class="bd ir gy z fp oo fr fs op fu fw ip bi translated">如何构建成功的仪表板</h2><div class="oq l"><h3 class="bd b gy z fp oo fr fs op fu fw dk translated">一份清单，来自某个制造了几个不成功产品的人</h3></div><div class="or l"><p class="bd b dl z fp oo fr fs op fu fw dk translated">towardsdatascience.com</p></div></div><div class="os l"><div class="oy l ou ov ow os ox ll oj"/></div></div></a></div><div class="og oh gp gr oi oj"><a href="https://medium.com/@jolecoco/how-to-choose-which-data-projects-to-work-on-c6b8310ac04e" rel="noopener follow" target="_blank"><div class="ok ab fo"><div class="ol ab om cl cj on"><h2 class="bd ir gy z fp oo fr fs op fu fw ip bi translated">如何…选择要处理的数据项目</h2><div class="oq l"><h3 class="bd b gy z fp oo fr fs op fu fw dk translated">如果你有合理利用时间的方法，你可以优化你创造的价值。</h3></div><div class="or l"><p class="bd b dl z fp oo fr fs op fu fw dk translated">medium.com</p></div></div><div class="os l"><div class="oz l ou ov ow os ox ll oj"/></div></div></a></div></div></div>    
</body>
</html>