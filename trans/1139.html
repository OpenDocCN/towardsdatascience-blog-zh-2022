<html>
<head>
<title>Deploy Machine learning models with Node.js Swagger, BigQuery and AWS Cloudformation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Node.js Swagger、BigQuery 和 AWS Cloudformation 部署机器学习模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploy-machine-learning-models-with-node-js-swagger-bigquery-and-aws-cloudformation-1c66f60e79a3#2022-03-23">https://towardsdatascience.com/deploy-machine-learning-models-with-node-js-swagger-bigquery-and-aws-cloudformation-1c66f60e79a3#2022-03-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3add" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">教程如何用一个命令部署你的机器学习模型</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/3dd4caeaa5b3d93d9eebc30c348d5af2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fWvK0PRcZmGyGRTO0ujscA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片<a class="ky kz ep" href="https://medium.com/u/e06a48b3dd48?source=post_page-----1c66f60e79a3--------------------------------" rel="noopener" target="_blank">💡迈克·沙克霍米罗夫</a></p></figure><h1 id="1ed6" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">对初学者来说真的简单易学。</h1><p id="32e8" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">包含代码的存储库可以在这里找到<a class="ae mo" href="https://github.com/mshakhomirov/deploy-ml-model-with-swagger-bigquery-and-node-js" rel="noopener ugc nofollow" target="_blank"/>。</p><h1 id="bed6" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">概述</h1><p id="d128" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">在这篇文章中，我将创建一个简单的 API，并用 AWS Cloudformation 部署它。我想实现以下目标:</p><ul class=""><li id="91ef" class="mp mq it lu b lv mr ly ms mb mt mf mu mj mv mn mw mx my mz bi translated">创建一个<strong class="lu iu">节点。JS </strong> API 服务于我的<strong class="lu iu">机器学习</strong>模型。</li><li id="f686" class="mp mq it lu b lv na ly nb mb nc mf nd mj ne mn mw mx my mz bi translated">将 API 服务连接到数据仓库解决方案(在我的例子中是<strong class="lu iu"> BigQuery </strong>)</li><li id="75d7" class="mp mq it lu b lv na ly nb mb nc mf nd mj ne mn mw mx my mz bi translated">使用<strong class="lu iu"> Docker </strong>和<strong class="lu iu"> AWS Cloudformation </strong>部署我的服务</li></ul><h1 id="2b39" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">先决条件、库和设置</h1><ul class=""><li id="2aa6" class="mp mq it lu b lv lw ly lz mb nf mf ng mj nh mn mw mx my mz bi translated"><strong class="lu iu"> Node.js </strong>。你将需要它来创建一个新的<strong class="lu iu">招摇</strong> API。</li><li id="0c16" class="mp mq it lu b lv na ly nb mb nc mf nd mj ne mn mw mx my mz bi translated"><strong class="lu iu"> GCP 账号</strong>已启用<strong class="lu iu"> Google BigQuery </strong>。我将使用 BigQuery 作为数据仓库解决方案来存储我的数据和训练 ML 模型。当涉及到数据清理时，它是非常有用的。然后我可以导出数据并在<strong class="lu iu"> Spark </strong>中训练我的模型，甚至直接在<strong class="lu iu"> BigQuery </strong>中训练它。一些常见的任务如<em class="ni">逻辑回归</em>已经存在。</li><li id="fe5b" class="mp mq it lu b lv na ly nb mb nc mf nd mj ne mn mw mx my mz bi translated">AWS 帐户来部署服务。是的，在这个练习中我们将完全混合。</li></ul><p id="8589" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">免费层是可用的，所以它不会花费你任何东西，但它总是一个好主意，以保持对帐单的关注。</p><blockquote class="nm nn no"><p id="f99e" class="ls lt ni lu b lv mr ju lx ly ms jx ma np nj md me nq nk mh mi nr nl ml mm mn im bi translated"><em class="it">顺便说一下，使用 AWS Cloudformation，您可以删除所有相关资源，然后一键重新创建它们。</em></p></blockquote><h1 id="fefc" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">第一步。创建一个新的 Swagger 项目</h1><p id="96c4" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">我将使用<strong class="lu iu">swagger</strong>T36】1 包来创建我的 API。</p><ul class=""><li id="4a0b" class="mp mq it lu b lv mr ly ms mb mt mf mu mj mv mn mw mx my mz bi translated"><code class="fe ns nt nu nv b">$ npm install -g swagger</code></li><li id="dd44" class="mp mq it lu b lv na ly nb mb nc mf nd mj ne mn mw mx my mz bi translated"><code class="fe ns nt nu nv b">cd Documents/code</code></li><li id="32a3" class="mp mq it lu b lv na ly nb mb nc mf nd mj ne mn mw mx my mz bi translated"><code class="fe ns nt nu nv b">$ swagger project create ml-service</code></li><li id="c65d" class="mp mq it lu b lv na ly nb mb nc mf nd mj ne mn mw mx my mz bi translated">选择<strong class="lu iu">表示</strong>作为框架。</li><li id="9c2d" class="mp mq it lu b lv na ly nb mb nc mf nd mj ne mn mw mx my mz bi translated">成功！您可以通过运行<code class="fe ns nt nu nv b">$ swagger project start ml-service</code>来启动您的新应用</li></ul><h1 id="900a" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">第二步。连接您的 ml-service 和 BigQuery 数据仓库</h1><p id="c336" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">我们假设我们在<strong class="lu iu"> BigQuery </strong>中保存了一个机器学习模型，即流失预测等。让我们构建一个数据连接器，用我们的服务来服务这些预测。</p><h1 id="2103" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">为您的移动服务创建一个服务帐户</h1><p id="74e8" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">这需要授权您的应用程序，以便它可以访问 BigQuery 中的数据。</p><p id="92b5" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated"><code class="fe ns nt nu nv b">./bq-shakhomirov-b86071c11c27.json</code>是<strong class="lu iu"> BigQuery </strong>凭证文件的一个例子。您将需要这个<strong class="lu iu"> <em class="ni">服务帐户凭证</em> </strong>文件来通过 Google 验证您的微服务，这样它就可以真正做一些事情。点击阅读更多关于<a class="ae mo" href="https://cloud.google.com/docs/authentication/production" rel="noopener ugc nofollow" target="_blank">服务账户认证的信息。只需从你的<em class="ni">谷歌云平台</em>账户下载并添加到你的应用文件夹。</a></p><p id="ca93" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">看起来应该是这样的:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="4c14" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">然而，我们正在用<strong class="lu iu"> swagger </strong>构建一个服务，所以让我们把它添加到<code class="fe ns nt nu nv b">config/default.yaml</code>中。</p><p id="641e" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">最后，它应该是这样的:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure><h1 id="af87" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">向 API 路由添加端点</h1><p id="3db6" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">我们将使用这个端点来返回我们需要的数据。</p><p id="0df6" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">在接下来的步骤中，我们将创建一个函数作为控制器，这样每当我们点击 API 端点时，它将执行并从我们的 BigQuery 表中提取数据。</p><p id="4e8f" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">转到<code class="fe ns nt nu nv b">api/swagger/swagger.yaml</code>，在默认<code class="fe ns nt nu nv b">/hello_world</code>端点之后添加新的 API 端点:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure><h1 id="245e" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">添加一个 swagger api 控制器(函数)</h1><p id="4c04" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">它将运行一个 SQL 查询，并从 BigQuery 表中返回<em class="ni">模型</em>数据。让我们称它为<code class="fe ns nt nu nv b">api/controllers/userList.js</code>，它将被用来返回一个用户列表，以防我们想以某种方式使用它，例如，在重定向中。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="8a29" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">在这种情况下，<code class="fe ns nt nu nv b">api/controllers/userList.js</code>将为我们的端点处理响应和状态代码。作为依赖项添加的<code class="fe ns nt nu nv b">bigQueryHelper</code>将负责我们需要的任何数据仓库逻辑，包括潜在的数据转换、缓存和其他一切。</p><h1 id="ad05" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">BigQuery 助手</h1><p id="2707" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">这将处理实际的连接和我们的数据逻辑。让我们创建一个文件<code class="fe ns nt nu nv b">api/helpers/bigQueryHelper.js</code></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure><h1 id="32f5" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">安装所需的第三方依赖项</h1><p id="983d" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">我们将只使用两个。运行以下命令:</p><p id="3f7c" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated"><code class="fe ns nt nu nv b">$ npm i @google-cloud/bigquery http-status-codes --reg <a class="ae mo" href="http://registry.npmjs.org/" rel="noopener ugc nofollow" target="_blank">http://registry.npmjs.org/</a></code></p><p id="296f" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">现在运行<code class="fe ns nt nu nv b">$ swagger project start</code>并尝试一个建议的<code class="fe ns nt nu nv b">$ curl <a class="ae mo" href="http://127.0.0.1:10010/hello?name=Scott" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:10010/hello?name=Scott</a></code></p><blockquote class="nm nn no"><p id="97fd" class="ls lt ni lu b lv mr ju lx ly ms jx ma np nj md me nq nk mh mi nr nl ml mm mn im bi translated"><em class="it">注意:如果你运行的 Node.js 高于 10.x，你很可能会遇到这个错误</em> <a class="ae mo" href="https://github.com/swagger-api/swagger-node/issues/586" rel="noopener ugc nofollow" target="_blank"> <em class="it"> 4 </em> </a></p></blockquote><p id="718d" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">我希望 swagger-node 会收到更多及时的更新，但这里是一个修复。</p><h1 id="7f7c" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">权宜之计</h1><ul class=""><li id="9969" class="mp mq it lu b lv lw ly lz mb nf mf ng mj nh mn mw mx my mz bi translated">更新你的 swagger-express-mw: <code class="fe ns nt nu nv b">"swagger-express-mw": "^0.7.0"</code></li><li id="4553" class="mp mq it lu b lv na ly nb mb nc mf nd mj ne mn mw mx my mz bi translated">在<code class="fe ns nt nu nv b">config/default.yaml</code>将 swagger_params_parser 添加到 swagger_controllers</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure><ul class=""><li id="6c3a" class="mp mq it lu b lv mr ly ms mb mt mf mu mj mv mn mw mx my mz bi translated">跑<code class="fe ns nt nu nv b">npm install</code></li><li id="0600" class="mp mq it lu b lv na ly nb mb nc mf nd mj ne mn mw mx my mz bi translated">运行<code class="fe ns nt nu nv b">swager project start</code></li><li id="eac7" class="mp mq it lu b lv na ly nb mb nc mf nd mj ne mn mw mx my mz bi translated">再试试<code class="fe ns nt nu nv b">curl http://127.0.0.1:10010/hello?name=Scott</code>。现在一切都应该运行正常。</li></ul><h1 id="e6b6" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">在 BigQuery 中填充您的表</h1><p id="3124" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">我们假设 model trainer 作为一个单独的流程运行，并填充我们的表，例如，每天。我们来模拟一些数据。在您的数据仓库中运行以下 SQL:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure><h1 id="e977" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">最后</h1><p id="a867" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">如果一切正常，那么尝试运行我们的<strong class="lu iu"> BigQuery 数据连接器</strong>T5】</p><p id="4618" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">输出必须是:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="c119" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated"><strong class="lu iu">这里我们创建了一个简单的数据服务，它将从您的数据仓库中提供数据。</strong></p><h1 id="d621" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">第三步。Docker 映像和 AWS Cloudformation 部署</h1><p id="6709" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">创建文档文件<code class="fe ns nt nu nv b">./Dockerfile</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure><h1 id="58ff" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">构建 Docker 映像</h1><p id="d5ac" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">在命令行中运行:</p><ul class=""><li id="cbf9" class="mp mq it lu b lv mr ly ms mb mt mf mu mj mv mn mw mx my mz bi translated"><code class="fe ns nt nu nv b">$ docker build -f Dockerfile -t yourAccountNumber.dkr.ecr.eu-west-1.amazonaws.com/ml-service:latest .</code></li><li id="0886" class="mp mq it lu b lv na ly nb mb nc mf nd mj ne mn mw mx my mz bi translated"><code class="fe ns nt nu nv b">$ docker run -p 80:10010 -it yourAccountNumber.dkr.ecr.eu-west-1.amazonaws.com/ml-service:latest</code></li></ul><p id="93b3" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">这将容器的端口 10011 绑定到主机 127.0.0.1 上的 TCP 端口 80。记得你暴露了端口 80，所以试试:<code class="fe ns nt nu nv b">$ curl <a class="ae mo" href="http://localhost:80/userList/3" rel="noopener ugc nofollow" target="_blank">http://localhost:80/userList/3</a></code></p><p id="2f57" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated"><strong class="lu iu">输出:</strong>输出必须是:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="1ad4" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">现在，当我们构建了 Docker 映像后，让我们<strong class="lu iu">将</strong>映像推送到<em class="ni"> AWS ECR 库</em>。我们需要先创建一个。</p><h1 id="4624" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">创建 AWS ECR 存储库</h1><p id="3d55" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">为此，您将需要<strong class="lu iu"> AWS CLI </strong>。</p><p id="0c71" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">创建 AWS Cloudofrmation 文件(复制—粘贴此文件):<code class="fe ns nt nu nv b">cloudformation/ecr.template</code></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="c4aa" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated"><strong class="lu iu">运行:</strong></p><ul class=""><li id="ed27" class="mp mq it lu b lv mr ly ms mb mt mf mu mj mv mn mw mx my mz bi translated"><code class="fe ns nt nu nv b">$ cd ./cloudformation</code></li><li id="190c" class="mp mq it lu b lv na ly nb mb nc mf nd mj ne mn mw mx my mz bi translated">用您的名字替换<strong class="lu iu"> MyMlServiceRepository </strong>和<strong class="lu iu"> ml-service </strong>并运行:</li></ul><pre class="kj kk kl km gt ny nv nz oa aw ob bi"><span id="071b" class="oc lb it nv b gy od oe l of og">aws cloudformation create-stack — template-body file://ecr.template — stack-name MyMlServiceRepository — capabilities CAPABILITY_IAM — parameters ParameterKey=YourModule,ParameterValue=ml-service</span></pre><p id="9893" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">如果成功的输出是这样的:</p><pre class="kj kk kl km gt ny nv nz oa aw ob bi"><span id="0a0a" class="oc lb it nv b gy od oe l of og">{ "StackId": "arn:aws:cloudformation:eu-west-1:53763437664:stack/MyMlServiceRepository/123f55-a9ea-11ec-97f2-02af2e5b45e7" }</span></pre><p id="c66f" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">现在，如果您转到 AWS 控制台并选择<strong class="lu iu"> Cloudformation </strong>，您将看到您的堆栈以及相关的存储库资源。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/8c26ee35f62d427b345fa173278edc3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*AEdAHBMdASRYQkrE.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片<a class="ky kz ep" href="https://medium.com/u/e06a48b3dd48?source=post_page-----1c66f60e79a3--------------------------------" rel="noopener" target="_blank">💡迈克·沙克霍米罗夫</a> ak</p></figure><p id="27c5" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">现在，让我们将我们的形象推向这个回购:</p><ul class=""><li id="4814" class="mp mq it lu b lv mr ly ms mb mt mf mu mj mv mn mw mx my mz bi translated"><code class="fe ns nt nu nv b">$ docker push yourAccountNumber.dkr.ecr.eu-west-1.amazonaws.com/ml-service:latest</code></li></ul><p id="4fdc" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">如果您遇到<code class="fe ns nt nu nv b">no basic auth credentials</code>错误，您可能想先登录:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="200b" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">再次按下，您的 Docker 图像将被上传:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure><h1 id="e172" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">使用 Cloudformation 堆栈创建资源并部署我们的服务</h1><p id="e37f" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">现在我们在 AWS 中有了 Docker 映像，我们希望在云中部署我们的服务。</p><blockquote class="nm nn no"><p id="9944" class="ls lt ni lu b lv mr ju lx ly ms jx ma np nj md me nq nk mh mi nr nl ml mm mn im bi translated"><em class="it">我想用一个命令创建所有相关的资源，即 EC 集群、任务定义和负载平衡器。</em></p></blockquote><p id="acf6" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">使用<code class="fe ns nt nu nv b">./cloudformation/cluster_and_task.yaml</code>创建带有任务定义和负载均衡器的集群和 ECS 服务。<strong class="lu iu">删除并重新创建是安全的</strong></p><blockquote class="nm nn no"><p id="ce74" class="ls lt ni lu b lv mr ju lx ly ms jx ma np nj md me nq nk mh mi nr nl ml mm mn im bi translated">AWS Cloudformation 可以轻松实现这一点</p></blockquote><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure><blockquote class="oi"><p id="0f7a" class="oj ok it bd ol om on oo op oq or mn dk translated">只需一个 Cloudformation 文件，即可创建 Docker 集群、任务定义和负载平衡器。</p></blockquote><p id="5011" class="pw-post-body-paragraph ls lt it lu b lv os ju lx ly ot jx ma mb ou md me mf ov mh mi mj ow ml mm mn im bi translated">在运行<code class="fe ns nt nu nv b">create</code>命令到达<code class="fe ns nt nu nv b">./cloudformation/cluster_and_task.yaml</code>之前，确保<strong class="lu iu">堆栈</strong>参数<strong class="lu iu">存在</strong>:</p><ul class=""><li id="1cb1" class="mp mq it lu b lv mr ly ms mb mt mf mu mj mv mn mw mx my mz bi translated">关键名称</li><li id="4b14" class="mp mq it lu b lv na ly nb mb nc mf nd mj ne mn mw mx my mz bi translated">图像</li><li id="8c84" class="mp mq it lu b lv na ly nb mb nc mf nd mj ne mn mw mx my mz bi translated">VPC</li><li id="922a" class="mp mq it lu b lv na ly nb mb nc mf nd mj ne mn mw mx my mz bi translated">您的默认 VPC 的子网</li></ul><p id="fce1" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">转到<a class="ae mo" href="https://eu-west-1.console.aws.amazon.com/ec2/v2/home?region=eu-west-1#KeyPairs" rel="noopener ugc nofollow" target="_blank"> EC2 服务</a>并创建一个名为<code class="fe ns nt nu nv b">dockerClusterKeyPair</code>的密钥对。确保堆栈文件中的其他默认名称与您的 AWS 帐户匹配。</p><p id="f12b" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated"><strong class="lu iu">在你的命令行运行:</strong></p><pre class="kj kk kl km gt ny nv nz oa aw ob bi"><span id="3a9b" class="oc lb it nv b gy od oe l of og">$ aws cloudformation create-stack --template-body file://cluster_and_task.yaml --stack-name MlServiceStaging --capabilities CAPABILITY_IAM</span></pre><p id="9a9f" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">成功创建堆栈后，您将在输出中看到您的 ELB(负载平衡器)端点:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/e3f201f553a67291c58dc0f84d526387.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Qr0sfwTwlRIYVtIY.png"/></div></div></figure><p id="11aa" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated"><code class="fe ns nt nu nv b">$ curl <a class="ae mo" href="http://ecsalbmed-1019625851.eu-west-1.elb.amazonaws.com/userList/3" rel="noopener ugc nofollow" target="_blank">http://ecsalbmed-1019625851.eu-west-1.elb.amazonaws.com/userList/3</a></code></p><p id="8f6c" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated"><strong class="lu iu">现在您可以安全地删除整个堆栈了。</strong></p><p id="ab64" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">或者，您可以从文件中提供所有堆栈参数，即</p><pre class="kj kk kl km gt ny nv nz oa aw ob bi"><span id="9d38" class="oc lb it nv b gy od oe l of og">$ aws cloudformation create-stack --template-body file://cluster_and_task.yaml --stack-name MlServiceStaging --capabilities CAPABILITY_IAM --parameters file://staging.json</span></pre><p id="6948" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">有关更多信息，请参见亚马逊 ECS 开发人员指南<a class="ae mo" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/launch_container_instance.html" rel="noopener ugc nofollow" target="_blank"> 6 </a>的故障排除部分。</p><h1 id="0834" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">结论</h1><p id="5a52" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">我们已经创建了一个简单而可靠的 API 服务来服务我们来自 BigQuery 的机器学习模型。使用基础设施作为代码使得部署、改变和进行任何类型的修改变得非常容易。例如，您可能想要创建另一个数据连接器来从<strong class="lu iu"> Postgres </strong>中提取预测，并在提供给客户之前应用一些奇特的数据转换逻辑。<strong class="lu iu"> AWS Cloudformation </strong>让你的代码可以重用。包括<strong class="lu iu"> CI/CD </strong>在内的部署过程变得非常简单。我知道，作为代码的基础设施是一个复杂的话题，但是一旦你掌握了它，它将对你的部署有巨大的帮助和难以置信的速度提升。</p><h1 id="5df3" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">资源</h1><p id="bbd2" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">[1]:<a class="ae mo" href="https://www.npmjs.com/package/swagger" rel="noopener ugc nofollow" target="_blank">https://www.npmjs.com/package/swagger</a></p><p id="22b4" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">【2】:<a class="ae mo" href="https://swagger.io/tools/open-source/getting-started/" rel="noopener ugc nofollow" target="_blank">https://swagger.io/tools/open-source/getting-started/</a></p><p id="6499" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">[3]:<a class="ae mo" href="https://cloud.google.com/docs/authentication/production" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/docs/authentication/production</a></p><p id="2675" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">[4]:<a class="ae mo" href="https://github.com/swagger-api/swagger-node/issues/586" rel="noopener ugc nofollow" target="_blank">https://github.com/swagger-api/swagger-node/issues/586</a></p><p id="a9ca" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">https://aws.amazon.com/cli/</p><p id="ce81" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated">[6]:<a class="ae mo" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/launch_container_instance.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/AmazonECS/latest/developer guide/launch _ container _ instance . html</a></p></div><div class="ab cl ox oy hx oz" role="separator"><span class="pa bw bk pb pc pd"/><span class="pa bw bk pb pc pd"/><span class="pa bw bk pb pc"/></div><div class="im in io ip iq"><p id="d525" class="pw-post-body-paragraph ls lt it lu b lv mr ju lx ly ms jx ma mb nj md me mf nk mh mi mj nl ml mm mn im bi translated"><em class="ni">原载于 https://mydataschool.com</em><a class="ae mo" href="https://mydataschool.com/blog/deploy-ml-model-with-swagger-bigquery-and-node-js/" rel="noopener ugc nofollow" target="_blank"><em class="ni"/></a><em class="ni">。</em></p></div></div>    
</body>
</html>