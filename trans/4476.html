<html>
<head>
<title>Large Scale Data Profiling with whylogs and Fugue on Spark, Ray or Dask</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Spark、Ray或Dask上使用whylogs和Fugue进行大规模数据分析</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/large-scale-data-profiling-with-whylogs-and-fugue-on-spark-ray-or-dask-e6917f6e1621#2022-10-04">https://towardsdatascience.com/large-scale-data-profiling-with-whylogs-and-fugue-on-spark-ray-or-dask-e6917f6e1621#2022-10-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="7cfd" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">为异常检测、漂移检测和数据验证等用例分析大规模数据</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/e69399754bb149a36b374db85f7be7f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B4GoFmpnkpE9YlS7Zb6IeA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">哈士奇与放大镜——作者图片</p></figure><h1 id="f8e7" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">动机</h1><p id="c839" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">数据管道有可能以多种方式产生意想不到的结果。异常数据会导致数据缩放不正确。机器学习模型漂移会导致预测精度降低。当数据管道执行时，上游集合中的故障可能会导致空值。我们如何防范这些失败案例？</p><p id="adac" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">监控数据质量的一种方法是数据验证。像<a class="ae mo" href="https://github.com/unionai-oss/pandera" rel="noopener ugc nofollow" target="_blank">潘德拉</a>和<a class="ae mo" href="https://github.com/great-expectations/great_expectations" rel="noopener ugc nofollow" target="_blank">远大前程</a>这样的工具允许数据从业者建立一套预定义的规则。例如，我们可以检查数据集中是否存在列，或者某个重要特性是否包含空值。</p><p id="ba8f" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">虽然这在理论上听起来不错，但它要求我们事先知道关于数据的许多事情。Great Expectations确实有一个分析器，但是它非常严格，并且不能很好地扩展到Spark。当我们的数据不太可预测时，我们需要找到其他方法或指标来提醒我们随着时间的推移数据会下降。例如，想象一个趋势向上的时间序列在某一天显著下降。如果我们应用数据验证来检查最大值和最小值，我们的验证规则可能无法捕捉到这种下降。我们需要一套更通用的分析工具，能够扩展到数据验证、漂移检测和异常检测等应用。</p><h1 id="7011" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">whylogs简介</h1><p id="2656" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">这就是为什么日志会出现的原因。<strong class="lp ir"> whylogs是一个开源的数据记录框架，它让我们能够以最小的开销分析我们的数据。上面提到的问题:异常检测、漂移检测和数据质量检查都可以解决，如果我们有好的数据配置文件。</strong></p><p id="b28e" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">使用whylogs，用户可以通过添加几行代码来分析他们的数据。以下面的例子为例，我们分析了熊猫的数据帧。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">样本whylogs代码— <a class="ae mo" href="https://whylogs.readthedocs.io/en/latest/examples/basic/Getting_Started.html#Profiling-with-whylogs" rel="noopener ugc nofollow" target="_blank">摘自WhyLabs文档</a></p></figure><p id="9186" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">可以查看概要文件，生成类似于下表的内容。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mr"><img src="../Images/20dc9a778bfdec94e1e2c698989a1822.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3_nMh3LVXtSRgbf47kG9kw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">whylogs的配置文件输出— <a class="ae mo" href="https://whylogs.readthedocs.io/en/latest/examples/basic/Getting_Started.html#Profiling-with-whylogs" rel="noopener ugc nofollow" target="_blank">摘自WhyLabs文档</a></p></figure><p id="4af3" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">该配置文件包含的列数超过了此处可以优雅显示的数量。在上图中，我们看到(按顺序):</p><ul class=""><li id="6f0e" class="ms mt iq lp b lq mj lt mk lw mu ma mv me mw mi mx my mz na bi translated">记录总数(第一列)</li><li id="00d5" class="ms mt iq lp b lq nb lt nc lw nd ma ne me nf mi mx my mz na bi translated">空记录计数(第二列)</li><li id="3853" class="ms mt iq lp b lq nb lt nc lw nd ma ne me nf mi mx my mz na bi translated">列中值的推断类型(第三至第七列)</li></ul><p id="e4de" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">不适合上图的其他列包括:</p><ul class=""><li id="ac3f" class="ms mt iq lp b lq mj lt mk lw mu ma mv me mw mi mx my mz na bi translated">估计基数</li><li id="e8a8" class="ms mt iq lp b lq nb lt nc lw nd ma ne me nf mi mx my mz na bi translated">频繁值</li><li id="6a6d" class="ms mt iq lp b lq nb lt nc lw nd ma ne me nf mi mx my mz na bi translated">分布指标，如最大值、最小值和分位数</li></ul><p id="c4b3" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">whylogs配置文件设计有三个重要属性:高效、可定制和可合并。前两个非常简单明了。whylogs的开销很低，这使得它可以轻松扩展到Spark这样的大数据框架。更重要的属性是<a class="ae mo" href="https://whylogs.readthedocs.io/en/latest/examples/basic/Merging_Profiles.html?highlight=merging#Merging-Profiles" rel="noopener ugc nofollow" target="_blank">可熔性</a>。可以将数据帧的较小部分的配置文件添加在一起，以形成全局数据集配置文件。</p><p id="f5d7" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">在处理Spark、Dask和Ray之类的分布式框架时，这是一个重要的属性，在这些框架中，数据可以存在于多个工作者之间。可以独立地分析分区，然后汇总。第二件事是，如果需要，数据集的更重要的子部分也可以独立地进行分析，然后整合到更广泛的分析中，而不必重新计算分位数等统计数据。</p><h1 id="48fd" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">通过神游扩展到大数据</h1><p id="6c3d" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">一些图书馆分析数据，如<a class="ae mo" href="https://github.com/ydataai/pandas-profiling" rel="noopener ugc nofollow" target="_blank">熊猫-分析</a>，但这些都集中在探索性数据分析，所以它们被设计成跟踪不同的东西。熊猫概况提供的一些信息很难扩展到Spark这样的大数据框架。</p><p id="f203" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated"><strong class="lp ir"> whylogs旨在将其数据记录扩展到大数据。</strong>我们可以使用赋格集成来分布式运行分析。他们还集成了<a class="ae mo" href="https://whylogs.readthedocs.io/en/latest/examples/integrations/kafka-example/Kafka_Example.html" rel="noopener ugc nofollow" target="_blank">卡夫卡</a>和<a class="ae mo" href="https://whylogs.readthedocs.io/en/latest/examples/integrations/Feature_Stores_and_whylogs.html#Logging-data-from-Feature-Stores-with-Feast-and-whylogs" rel="noopener ugc nofollow" target="_blank">盛宴</a>等等。</p><p id="fc6d" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">开源的<a class="ae mo" href="https://github.com/fugue-project/fugue/" rel="noopener ugc nofollow" target="_blank">神游项目</a>获取Python、Pandas或SQL代码，并将其带到<strong class="lp ir"> Spark、Dask或Ray </strong>。在Fugue上使用whylogs允许我们维护相同的简单界面来生成配置文件。例如:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">fugue_profile函数</p></figure><p id="0db1" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">这仍然是运行在熊猫的引擎之上。它将产生与上面使用普通whylogs的代码片段相同的结果。优点是，我们只需提供一个参数，就可以将它带到Spark、Dask或Ray。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ng"><img src="../Images/bd685752e8196d74f61d277cd6401b5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ict4-tJsyQGtneb1N2-nvA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">fugue_profile输出—作者提供的图像</p></figure><p id="67a6" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">为了引入Spark，我们可以将SparkSession作为<code class="fe nh ni nj nk b">engine</code>传递。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">将whylogs档案带到Spark</p></figure><p id="2d84" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">为了在Dask和Ray上执行，我们可以传递集群地址或<code class="fe nh ni nj nk b">Client</code>。</p><h1 id="7849" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">分析逻辑分区</h1><p id="dfaf" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">在处理大数据时，一个更常见的用例是分析数据的逻辑分区。这可以帮助我们找到离群分区，并且对于探索性分析也是有用的。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">对每个分区应用fugue_profile</p></figure><p id="67a7" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">这将返回如下图所示的输出，其中最后一列是序列化的概要文件。然后这些可以被<a class="ae mo" href="https://whylogs.readthedocs.io/en/latest/examples/integrations/Fugue_Profiling.html?highlight=fugue#Profiling-on-logical-partitions" rel="noopener ugc nofollow" target="_blank">解串</a>和后处理。这个数据帧已经比原始数据帧小得多，所以反序列化和提取数据非常快。<strong class="lp ir">通过对配置文件进行操作，我们可以存储和分析数量少得多的数据。</strong></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nl"><img src="../Images/a352881ca3b4d32864cc70633383f032.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vga-sADe5CMt7tijw5w7rA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">每个分区的分析—按作者分类的图像</p></figure><h1 id="67aa" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">数据配置文件的使用</h1><p id="dda7" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">有了数据概要文件，我们可以将它们应用到不同的用例中。</p><p id="1336" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated"><strong class="lp ir">异常检测</strong></p><p id="4074" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">对于每月持续出现的新数据，我们可以每月运行配置文件并存储这些配置文件。然后，我们可以用z-score之类的指标来比较分布图中不同分位数的值。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/78da6fc382d248f8059bb0b3a71b2a9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1362/format:webp/1*ks9sNgP0JP2SNeuKXj3UqA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">分布式概要分析用例—按作者分类的图像</p></figure><p id="d71f" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">这种设置对于大数据尤其重要，因为我们不需要返回到以前的数据并重新计算指标。数据配置文件足以检查异常情况。</p><p id="640b" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated"><strong class="lp ir">数据质量</strong></p><p id="d79a" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">配置文件中缺少数据计数。基数也有助于查找包含过多类别的列。我们还可以用已经包含的分位数检查这些数字是否在某个已知的范围内。如果用户需要跟踪更多的东西，还可以添加自定义指标。</p><p id="709b" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated"><strong class="lp ir">漂移检测</strong></p><p id="1c5e" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">我们可以通过监控传入数据的分布来确定是否需要重新训练我们的机器学习模型。通过几行额外的代码，whylogs可以生成<a class="ae mo" href="https://whylogs.readthedocs.io/en/latest/examples/basic/Notebook_Profile_Visualizer.html#Profile-Summary" rel="noopener ugc nofollow" target="_blank">可视化报告</a>。这些在调试为什么会发生意外的预测分布时非常有用。下图显示了新数据的预期分布与实际分布。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/79819eaf965d32547c707a668eea896a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yXnTbIXM1GKx54SkMRHAjw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">whylogs可视化示例—图片来自<a class="ae mo" href="https://whylogs.readthedocs.io/en/latest/examples/basic/Notebook_Profile_Visualizer.html#Drift-Summary" rel="noopener ugc nofollow" target="_blank"> whylogs文档</a></p></figure><h1 id="5a7b" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">结论</h1><p id="03b2" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">在本文中，我们讨论了可以通过数据概要分析解决的一系列问题。<strong class="lp ir">异常检测、漂移检测和数据质量问题有时需要在没有数据先验知识的情况下解决。数据配置文件是一种以无人监管的方式处理这些数据的非常通用的方法。</strong>档案也可以作为将来验证规则的基础。</p><p id="8293" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">whylogs特别强大，因为它被设计成轻量级的，可以扩展到大数据。mergability属性还允许在数据分区的分布式设置中使用它，这些分区可以在以后合并。通过使用Fugue集成，可以在Spark、Dask和Ray之上轻松使用whylogs来在集群之上运行分析。这些结果可以保存并在将来使用，而无需重新计算过去的数据。</p><h1 id="84d6" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">资源</h1><ol class=""><li id="7510" class="ms mt iq lp b lq lr lt lu lw no ma np me nq mi nr my mz na bi translated"><a class="ae mo" href="https://github.com/whylabs/whylogs" rel="noopener ugc nofollow" target="_blank"> whylogs回购</a></li><li id="adbb" class="ms mt iq lp b lq nb lt nc lw nd ma ne me nf mi nr my mz na bi translated"><a class="ae mo" href="https://whylogs.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank">为什么日志文档</a></li><li id="30f6" class="ms mt iq lp b lq nb lt nc lw nd ma ne me nf mi nr my mz na bi translated"><a class="ae mo" href="https://github.com/fugue-project/fugue/" rel="noopener ugc nofollow" target="_blank">赋格回购</a></li><li id="d0f3" class="ms mt iq lp b lq nb lt nc lw nd ma ne me nf mi nr my mz na bi translated"><a class="ae mo" href="https://fugue-tutorials.readthedocs.io/" rel="noopener ugc nofollow" target="_blank">赋格教程</a></li></ol><p id="05e5" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">要与我们聊天:</p><ol class=""><li id="7461" class="ms mt iq lp b lq mj lt mk lw mu ma mv me mw mi nr my mz na bi translated"><a class="ae mo" href="http://slack.fugue.ai/" rel="noopener ugc nofollow" target="_blank">赋格松弛</a></li><li id="6478" class="ms mt iq lp b lq nb lt nc lw nd ma ne me nf mi nr my mz na bi translated"><a class="ae mo" href="https://bit.ly/rsqrd-slack" rel="noopener ugc nofollow" target="_blank">为什么日志松弛</a></li></ol></div></div>    
</body>
</html>