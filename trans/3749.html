<html>
<head>
<title>How to manage Azure Data Factory from DEV to PRD</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何从DEV到PRD管理Azure数据工厂</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-manage-azure-data-factory-from-dev-to-prd-ab7c8a2d10ae#2022-08-21">https://towardsdatascience.com/how-to-manage-azure-data-factory-from-dev-to-prd-ab7c8a2d10ae#2022-08-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7c3d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用Azure DevOps和Azure Data Factory CI/CD实用程序</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/116c886463ee9af63f8b5a413a08b496.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FMMEWlQEMlkG0toJbKwW3A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">管理从DEV到PRD的数据工厂管道—照片由<a class="ae ky" href="https://unsplash.com/@rgaleriacom" rel="noopener ugc nofollow" target="_blank"> Ricardo Gomez Angel </a>在<a class="ae ky" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h1 id="624c" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">1.介绍</h1><p id="f132" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在软件项目中，<a class="ae ky" href="https://en.wikipedia.org/wiki/Development,_testing,_acceptance_and_production" rel="noopener ugc nofollow" target="_blank">开发/TST/UAT </a>环境被用来开发和测试代码。之后，代码被发布到PRD环境中。Azure数据工厂(ADF)项目遵循相同的分阶段方法。但是，需要注意以下ADF挑战:</p><ul class=""><li id="23e4" class="mn mo it lt b lu mp lx mq ma mr me ms mi mt mm mu mv mw mx bi translated">ADF项目只能作为一个整体部署，而不是部署单个管道。在这种情况下，应该防止未经测试的代码最终进入生产环境。</li><li id="08be" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm mu mv mw mx bi translated">ADF支持分支和拉请求，但是很难检查JSON中的变化。审查变更只能在ADF本身中完成，要么使用DEV中的不同分支，要么在TST中运行</li><li id="f25e" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm mu mv mw mx bi translated">ADF管道不能孤立测试，但是，通过固定数据源和pytest库，可以实现单元和集成测试。见我之前的<a class="ae ky" rel="noopener" target="_blank" href="/how-to-build-unit-tests-for-azure-data-factory-3aa11b36c7af">博客</a>。</li></ul><p id="3b3f" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nd mc md me ne mg mh mi nf mk ml mm im bi translated">在这篇blogpost和git repo <code class="fe ng nh ni nj b"><a class="ae ky" href="https://github.com/rebremer/azure-data-factory-cicd-feature-release" rel="noopener ugc nofollow" target="_blank">azure-data-factory-cicd-feature-release</a></code>中，讨论了如何优化ADF的发布周期，以防止未经测试的代码最终进入生产，另请参见下面的概述。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/f7399e064f8e4f1a64dfc50e52880abb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zi5pqL65IGwtstZa.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">1.从DEV到PRD管理ADF按作者分类的图片</p></figure><p id="71c5" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nd mc md me ne mg mh mi nf mk ml mm im bi translated">在此，主要观点如下:</p><ul class=""><li id="147c" class="mn mo it lt b lu mp lx mq ma mr me ms mi mt mm mu mv mw mx bi translated">多个开发人员使用1个ADF实例来创建功能。每个功能都有自己的分支。如果有太多的开发人员在同一个ADF实例上工作(&gt; 10)，可以决定为一组开发人员创建一个新的实例。</li><li id="996d" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm mu mv mw mx bi translated">一旦一个特性准备好进行测试，它就会使用ARM模板部署到自己的ADF实例中。如果需要测试N个特性，这将导致N个ADF实例。这样，一个新的特性可以被孤立地测试，而不必先合并到主分支中。</li><li id="9425" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm mu mv mw mx bi translated">一旦一个特性成功，它就被合并到主分支，随后，主分支被自动部署到UAT环境中。在UAT环境中，可以进行集成测试。也可以决定合并到一个专用的UAT(预发布)分支，即在UAT测试成功后合并到main。</li><li id="4d88" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm mu mv mw mx bi translated">一旦集成测试成功，主分支将部署到PRD。请注意，部署到PRD总是发生在主分支，而不是特性分支。这是为了防止在PRD部署之后发生合并冲突，在最坏的情况下，这会导致撤销PRD中已经存在的特性。</li></ul><p id="5d5a" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nd mc md me ne mg mh mi nf mk ml mm im bi translated">在这篇博客的剩余部分，我们将讨论部署到不同环境的详细过程。最后，注意这篇博客遵循了MSFT推荐的<a class="ae ky" href="https://docs.microsoft.com/en-us/azure/data-factory/continuous-integration-delivery-improvements#the-new-cicd-flow" rel="noopener ugc nofollow" target="_blank">新ADF CI/CD流程</a>。在这个流程中，<a class="ae ky" href="https://www.npmjs.com/package/@microsoft/azure-data-factory-utilities" rel="noopener ugc nofollow" target="_blank">NPM Azure Data Factory utilities</a>库而不是ADF publish按钮被用来传播到不同的环境。</p><h1 id="c6c9" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">2.偏差</h1><p id="0c95" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在本博客的剩余部分，使用以下步骤部署项目:</p><ul class=""><li id="e50b" class="mn mo it lt b lu mp lx mq ma mr me ms mi mt mm mu mv mw mx bi translated">2.1先决条件</li><li id="c41f" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm mu mv mw mx bi translated">2.2设置Azure DevOps项目</li><li id="100b" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm mu mv mw mx bi translated">2.3设置ADF开发实例</li><li id="4c48" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm mu mv mw mx bi translated">2.4在ADF开发中创建特征分支</li></ul><h2 id="4bc9" class="nl la it bd lb nm nn dn lf no np dp lj ma nq nr ll me ns nt ln mi nu nv lp nw bi translated">2.1先决条件</h2><p id="9c0c" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">本教程需要以下资源:</p><ul class=""><li id="070d" class="mn mo it lt b lu mp lx mq ma mr me ms mi mt mm mu mv mw mx bi translated"><a class="ae ky" href="https://azure.microsoft.com/en-us/free/" rel="noopener ugc nofollow" target="_blank">蔚蓝账户</a></li><li id="626a" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm mu mv mw mx bi translated"><a class="ae ky" href="https://azure.microsoft.com/en-us/services/devops/" rel="noopener ugc nofollow" target="_blank">天蓝色DevOps </a></li><li id="50eb" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm mu mv mw mx bi translated"><a class="ae ky" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a>(推荐，也用于故障排除)</li></ul><p id="3c7d" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nd mc md me ne mg mh mi nf mk ml mm im bi translated">随后，转到Azure门户并创建一个资源组，所有Azure资源都将部署在该资源组中。这也可以使用以下Azure CLI命令来完成:</p><pre class="kj kk kl km gt nx nj ny nz aw oa bi"><span id="6369" class="nl la it nj b gy ob oc l od oe">az group create -n &lt;&lt;your resource group&gt;&gt; -l &lt;&lt;your location&gt;&gt;</span></pre><h2 id="6ef5" class="nl la it bd lb nm nn dn lf no np dp lj ma nq nr ll me ns nt ln mi nu nv lp nw bi translated">2.2创建Azure DevOps项目</h2><p id="4ced" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">Azure DevOps是一个工具，可以持续地构建、测试和部署你的代码到任何平台和云。创建新项目后，单击存储库文件夹并选择导入以下存储库:</p><ul class=""><li id="4844" class="mn mo it lt b lu mp lx mq ma mr me ms mi mt mm mu mv mw mx bi translated"><a class="ae ky" href="https://github.com/rebremer/azure-data-factory-cicd-feature-release" rel="noopener ugc nofollow" target="_blank">https://github . com/rebremer/azure-data-factory-cicd-feature-release</a></li></ul><p id="e058" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nd mc md me ne mg mh mi nf mk ml mm im bi translated">另见下图，其中使用本博客的git repo创建了一个devops repo:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/4183f47fc20af14eda5d74c8156edbe5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*iwMdcTU5tNM_wKzc.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">2.2.1将存储库添加到您的Azure DevOps项目，image by author</p></figure><p id="203b" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nd mc md me ne mg mh mi nf mk ml mm im bi translated">随后，需要服务连接来访问资源组fom Azure DevOps中的资源。转到项目设置，服务连接，然后选择Azure资源管理器，另见下图。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/8894cdfc83963f52e842efde7d88c9d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*nEGt55h5nI_hotXd.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">2.2.2将存储库添加到您的Azure DevOps项目，image by author</p></figure><p id="838a" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nd mc md me ne mg mh mi nf mk ml mm im bi translated">选择服务主体身份验证，并将范围限制到您之前创建的资源组，另请参见下图。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/27c870a81c93730726c0174c9c7533fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*b7YRbd9aRe5AhL4w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">2.2.3按作者将范围限制到资源组、图像</p></figure><h2 id="425b" class="nl la it bd lb nm nn dn lf no np dp lj ma nq nr ll me ns nt ln mi nu nv lp nw bi translated">2.3设置ADF开发实例</h2><p id="d4a8" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在这一段中，创建了用于开发的Azure数据工厂。此ADF开发实例应使用在步骤2.2中创建的Azure DevOps git repo。</p><ul class=""><li id="6142" class="mn mo it lt b lu mp lx mq ma mr me ms mi mt mm mu mv mw mx bi translated">在这个<a class="ae ky" href="https://docs.microsoft.com/en-us/azure/data-factory/quickstart-create-data-factory-portal#create-a-data-factory" rel="noopener ugc nofollow" target="_blank">链接</a>中，解释了如何在门户中创建Azure数据工厂实例</li><li id="e08b" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm mu mv mw mx bi translated">在这个<a class="ae ky" href="https://docs.microsoft.com/en-us/azure/data-factory/source-control#configuration-method-1-home-page" rel="noopener ugc nofollow" target="_blank">链接</a>中，解释了如何将代码库添加到ADF中。确保添加了devops项目git repo 2.2。</li></ul><p id="6cea" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nd mc md me ne mg mh mi nf mk ml mm im bi translated">或者，Azure CLI也可以用来创建数据工厂，包括添加代码库，见<a class="ae ky" href="https://docs.microsoft.com/en-us/cli/azure/datafactory?view=azure-cli-latest#az-datafactory-create" rel="noopener ugc nofollow" target="_blank">这里</a>。请参见下面链接到Azure DevOps git repo的成功部署的ADF实例:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/8e217d4cb4df61e39b985fb066c9aca1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jhdqGmmw8shQLvtxxUdixQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">2.3 Azure数据工厂实例链接到Azure DevOps</p></figure><h2 id="05be" class="nl la it bd lb nm nn dn lf no np dp lj ma nq nr ll me ns nt ln mi nu nv lp nw bi translated">2.4在ADF开发中创建特征分支</h2><p id="8ea6" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">一切就绪后，就可以开始开发了。软件开发的最佳实践是从主分支创建开发分支。在这个开发分支中，特性是由开发人员创建的。</p><p id="850d" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nd mc md me ne mg mh mi nf mk ml mm im bi translated">在这篇博客中，关键是新的分支是在Azure DevOps中创建的，而不是ADF本身。这是因为Azure DevOps Pipeline yml文件也应该包含在新分支中(ADF不会这样做)。转到您的Azure DevOps项目，选择分支并创建新分支，另请参见下文。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/d15789cbeef6588885c269b5f145f8a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PP1scPYctsx2J9pWQqPCIA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">2.4在Azure DevOps中创建新分支</p></figure><p id="9415" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nd mc md me ne mg mh mi nf mk ml mm im bi translated">开发人员现在也可以在ADF中找到分支，并可以在分支中开始编码。当一个开发人员完成他的代码后，他的分支将被其他开发人员审查和测试。这将在下一小节中讨论。</p><h1 id="b053" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">3.测验(test)</h1><p id="734b" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在这一章中，检查了一个特性分支，并将其部署到ADF实例中进行测试。执行以下步骤:</p><ul class=""><li id="ff6d" class="mn mo it lt b lu mp lx mq ma mr me ms mi mt mm mu mv mw mx bi translated">3.1创建拉动式请求(PR)</li><li id="4a6e" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm mu mv mw mx bi translated">3.2将功能分支部署到新的ADF TST实例</li></ul><h2 id="09c9" class="nl la it bd lb nm nn dn lf no np dp lj ma nq nr ll me ns nt ln mi nu nv lp nw bi translated">3.1创建拉动式请求(PR)</h2><p id="9d6d" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在开发人员完成其分支后，应创建一个PR，以便其他人可以查看。转到Azure DevOps项目，转到分支，选择您的功能分支，然后选择新的拉请求，见下文</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/1db31ca16898b38dceb619a34a5395a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YupZa1upXkCeSsu4x8jFaQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">4.1创建拉式请求</p></figure><p id="6996" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nd mc md me ne mg mh mi nf mk ml mm im bi translated">填写表格，并填写负责审查变更的开发人员的姓名。将向这些开发人员发送一封电子邮件通知他们。</p><h2 id="e0c1" class="nl la it bd lb nm nn dn lf no np dp lj ma nq nr ll me ns nt ln mi nu nv lp nw bi translated">3.2将功能分支部署到新的ADF TST实例</h2><p id="c130" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">正如介绍中所讨论的，很难从JSON中回顾ADF管道的变化。请购单应始终在ADF实例中审查。有三种不同的方法可以做到这一点，如下所示:</p><ul class=""><li id="ea77" class="mn mo it lt b lu mp lx mq ma mr me ms mi mt mm mu mv mw mx bi translated">转到ADF开发实例，选择分支并查看更改。测试可能是一个挑战，因为分支机构仍然处于开发环境中</li><li id="1850" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm mu mv mw mx bi translated">将更改部署到现有的通用ADF TST实例。将代码部署到现有管道将覆盖现有ADF实例。</li><li id="3f67" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm mu mv mw mx bi translated">将更改部署到具有功能分支名称的新的专用ADF TST实例。变更也可以单独测试。</li></ul><p id="9358" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nd mc md me ne mg mh mi nf mk ml mm im bi translated">本小节采用了新的专用ADF TST实例方法。转到你的Azure DevOps项目，转到你的repo，找到<code class="fe ng nh ni nj b"><a class="ae ky" href="https://github.com/rebremer/azure-data-factory-cicd-feature-release/blob/main/azure-pipelines-feature.yml" rel="noopener ugc nofollow" target="_blank">azure-pipelines-release.yml</a></code>并修改值以指向你的工作区，也见下文。</p><pre class="kj kk kl km gt nx nj ny nz aw oa bi"><span id="213a" class="nl la it nj b gy ob oc l od oe">variables:<br/>  adfdev : "&lt;&lt;your dev ADF instance&gt;&gt;"<br/>  adftst : $(Build.SourceBranchName)<br/>  subiddev: "&lt;&lt;your dev subscription id&gt;&gt;"<br/>  subidtst: "&lt;&lt;your tst subscription id&gt;&gt;"<br/>  rgdev : "&lt;&lt;your dev resource group&gt;&gt;"<br/>  rgtst : "&lt;&lt;your tst resource group&gt;&gt;"<br/>  location : "&lt;&lt;your location&gt;&gt;"<br/>  AzureServiceConnectionId: "&lt;&lt;your AzureServiceConnectionId&gt;&gt;"</span></pre><p id="4390" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nd mc md me ne mg mh mi nf mk ml mm im bi translated">现在，在DevOps项目中选择管道，然后单击“新建管道”。转到向导，选择您之前创建的Azure Repos Git和git repo。在“配置”选项卡中，选择“现有的Azure Pipelines YAML文件”,然后选择可以在git repo中找到的<code class="fe ng nh ni nj b"><a class="ae ky" href="https://github.com/rebremer/azure-data-factory-cicd-feature-release/blob/main/azure-pipelines-feature.yml" rel="noopener ugc nofollow" target="_blank">azure-pipelines-release.yml</a></code>,也见下文。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/32cbae98b3ed7677eb59abd172953f15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*OUs_f9VltAWVCtzc.png"/></div></div></figure><p id="4053" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nd mc md me ne mg mh mi nf mk ml mm im bi translated">一旦创建了管道，它就会立即运行，当运行成功时，一个新的数据工厂实例就会以特性分支的名称创建。在一个特征分支被正确地检查和测试之后，可以决定再次将它合并到主分支。这将在下一段讨论。</p><h1 id="05ea" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">4.UAT和珠三角</h1><p id="2d1b" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在本博客的剩余部分，使用以下步骤部署项目:</p><ul class=""><li id="f620" class="mn mo it lt b lu mp lx mq ma mr me ms mi mt mm mu mv mw mx bi translated">4.1将特征分支合并到主分支</li><li id="ef58" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm mu mv mw mx bi translated">4.2将主要分支部署到UAT民主同盟军</li><li id="d05d" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm mu mv mw mx bi translated">4.3将主要分支部署到ADF PRD</li></ul><h2 id="848f" class="nl la it bd lb nm nn dn lf no np dp lj ma nq nr ll me ns nt ln mi nu nv lp nw bi translated">4.1将特征分支合并到主分支</h2><p id="cc51" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在特征分支被审查和测试正确后，它将再次与主分支合并。选择拉动请求，添加备注并将PR标记为完成，另请参见下图。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/b5485599bdac61c54bd2cd8a9d1389d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6z_nR923Foedcv4zUA10Pw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">4.1关闭PR，将特征分支合并到主分支</p></figure><p id="585c" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nd mc md me ne mg mh mi nf mk ml mm im bi translated">特征分支现在合并到主分支。下一步，将在主要分支机构的UAT环境中运行回归测试。那将在下一段讨论。</p><h2 id="441b" class="nl la it bd lb nm nn dn lf no np dp lj ma nq nr ll me ns nt ln mi nu nv lp nw bi translated">4.2将主要分支部署到UAT民主同盟军</h2><p id="6d0c" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">主要分支始终是部署到珠三角。这样做是为了确保只有一个代码库在生产中使用。然而，在将一个特性合并到main之后，首先要运行几个回归测试，以确保main分支不包含冲突的变更。在这一段中，主要分支部署到了UAT。</p><p id="2f17" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nd mc md me ne mg mh mi nf mk ml mm im bi translated">转到你的Azure DevOps项目，转到你的repo，找到<code class="fe ng nh ni nj b"><a class="ae ky" href="https://github.com/rebremer/azure-data-factory-cicd-feature-release/blob/main/azure-pipelines-main.txt" rel="noopener ugc nofollow" target="_blank">azure-pipelines-release.txt</a></code>,调整值指向你的工作区，也见下文</p><pre class="kj kk kl km gt nx nj ny nz aw oa bi"><span id="afdf" class="nl la it nj b gy ob oc l od oe">variables:<br/>  adfdev : "&lt;&lt;your dev ADF instance&gt;&gt;"<br/>  adfuat : "&lt;&lt;your uat ADF instance&gt;&gt;"<br/>  subiddev: "&lt;&lt;your dev subscription id&gt;&gt;"<br/>  subiduat: "&lt;&lt;your uat subscription id&gt;&gt;"<br/>  rgdev : "&lt;&lt;your dev resource group&gt;&gt;"<br/>  rguat : "&lt;&lt;your uat resource group&gt;&gt;"<br/>  location : "&lt;&lt;your location&gt;&gt;"<br/>AzureServiceConnectionId: "&lt;&lt;your AzureServiceConnectionId&gt;&gt;"</span></pre><p id="22bd" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nd mc md me ne mg mh mi nf mk ml mm im bi translated">现在采取第3.2节中描述的类似步骤来创建和运行管道。另外两点意见:</p><ul class=""><li id="d7f9" class="mn mo it lt b lu mp lx mq ma mr me ms mi mt mm mu mv mw mx bi translated"><code class="fe ng nh ni nj b"><a class="ae ky" href="https://github.com/rebremer/azure-data-factory-cicd-feature-release/blob/main/azure-pipelines-feature.yml" rel="noopener ugc nofollow" target="_blank">azure-pipelines-release.yml</a> </code>包含以下代码片段:<code class="fe ng nh ni nj b">trigger: main</code>。这意味着每当主分支中有变化时(例如，当一个特征分支被合并时)，流水线就运行，并且测试可以被执行。</li><li id="bf1e" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm mu mv mw mx bi translated">创建Azure DevOps管道以部署到UAT只需一次</li></ul><p id="0945" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nd mc md me ne mg mh mi nf mk ml mm im bi translated">当测试成功执行后，代码就可以部署到PRD中了。这将在下一章讨论</p><h2 id="fd4e" class="nl la it bd lb nm nn dn lf no np dp lj ma nq nr ll me ns nt ln mi nu nv lp nw bi translated">4.3将主要分支部署到ADF PRD</h2><p id="e657" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">当回归测试在UAT成功时，主分支机构准备在珠三角部署。这可以简单地通过在4.2中部署的管道中添加一个<code class="fe ng nh ni nj b"><a class="ae ky" href="https://github.com/rebremer/azure-data-factory-cicd-feature-release/blob/main/azure-pipelines-feature.yml#L72" rel="noopener ugc nofollow" target="_blank">deploy ADF to PRD</a> </code>任务来完成。关于回归测试和部署到PRD的两个附加备注:</p><ul class=""><li id="2ff6" class="mn mo it lt b lu mp lx mq ma mr me ms mi mt mm mu mv mw mx bi translated">自动测试ADF可能是一个挑战。在我之前的博客<a class="ae ky" rel="noopener" target="_blank" href="/how-to-build-unit-tests-for-azure-data-factory-3aa11b36c7af">如何为Azure数据工厂</a>构建单元测试中，广泛讨论了如何使用DevOps和pytest建立测试框架</li><li id="ab37" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm mu mv mw mx bi translated">为了防止版本自动部署到PRD，可以在管道中添加一个<a class="ae ky" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/utility/manual-validation?view=azure-devops&amp;tabs=yaml" rel="noopener ugc nofollow" target="_blank">手动验证步骤</a>。这在我之前的博客中也讨论过，可以在附带的<a class="ae ky" href="https://github.com/rebremer/blog-adfv2unittest-git/blob/adf_publish/azure-pipelines.yml#L148" rel="noopener ugc nofollow" target="_blank"> azure管道示例</a>中找到</li></ul><h1 id="5d63" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">5.结论</h1><p id="e350" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在一个典型的软件项目中，<a class="ae ky" href="https://en.wikipedia.org/wiki/Development,_testing,_acceptance_and_production" rel="noopener ugc nofollow" target="_blank"> DEV/TST/UAT </a>环境被用来开发和测试代码。之后，它被释放到珠江三角洲环境中。Azure数据工厂(ADF)管道遵循相同的发布周期。然而，ADF项目只能作为一个整体进行部署，并且存在未经测试的代码被部署到生产环境中的风险。在这个博客和git repo <code class="fe ng nh ni nj b"><a class="ae ky" href="https://github.com/rebremer/azure-data-factory-cicd-feature-release" rel="noopener ugc nofollow" target="_blank">azure-data-factory-cicd-feature-release</a></code>中，描述了如何管理ADF发布，另请参见下面的概述。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/f7399e064f8e4f1a64dfc50e52880abb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zi5pqL65IGwtstZa.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">5.从DEV到PRD管理ADF按作者分类的图片</p></figure></div></div>    
</body>
</html>