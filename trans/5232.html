<html>
<head>
<title>Automating Deployment of Pre-Trained Models on Amazon SageMaker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 Amazon SageMaker 上自动部署预先训练好的模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/automating-deployment-of-pre-trained-models-on-amazon-sagemaker-46d50c246503#2022-11-22">https://towardsdatascience.com/automating-deployment-of-pre-trained-models-on-amazon-sagemaker-46d50c246503#2022-11-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="752c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在 SageMaker 推理上部署 TensorFlow ResNet50</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/dd3ffd1ea6691ed847ee5f3e59f081f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Xu-QDPxFSUHQOCyT"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自<a class="ae ky" href="https://unsplash.com/photos/Uz0uQXvOtEY" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>由<a class="ae ky" href="https://unsplash.com/@possessedphotography" rel="noopener ugc nofollow" target="_blank">附身摄影</a></p></figure><p id="6eb7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">过去，我曾写过在亚马逊 SageMaker 上部署<a class="ae ky" rel="noopener" target="_blank" href="/deploying-a-pre-trained-sklearn-model-on-amazon-sagemaker-826a2b5ac0b6">预先训练好的模型</a>。虽然我发布的<a class="ae ky" href="https://github.com/RamVegiraju/Pre-Trained-Sklearn-SageMaker" rel="noopener ugc nofollow" target="_blank">工件</a>是可复制的，但它需要理解<a class="ae ky" rel="noopener" target="_blank" href="/sagemaker-python-sdk-vs-boto3-sdk-45c424e8e250">AWS SDK</a>和适当的 API 调用，以及理解更高级别的<a class="ae ky" href="https://sagemaker.readthedocs.io/en/stable/" rel="noopener ugc nofollow" target="_blank"> SageMaker Python SDK </a>。</p><p id="f050" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于新用户来说，这可能需要消化很多东西，为了使体验更简单，我已经帮助构建了一个<a class="ae ky" href="https://github.com/aws-samples/sagemaker-migration-toolkit" rel="noopener ugc nofollow" target="_blank"> API </a>，它自动化了用户为了正确部署<a class="ae ky" href="https://docs.aws.amazon.com/sagemaker/latest/dg/deploy-model.html" rel="noopener ugc nofollow" target="_blank"> SageMaker 端点</a>而必须理解的大量底层工作。有了这个 API，重点是使预训练模型的迁移对于数据科学家和一般不熟悉 SageMaker 或 AWS 的用户来说更加简单和直观。</p><p id="76bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">目前支持什么？目前该 API 被称为<strong class="lb iu"> SageMaker 迁移工具包</strong>，它支持 TensorFlow、PyTorch 和 Sklearn 模型的预训练模型部署。除此之外，还有对实时和无服务器端点的支持，默认情况下，如果您没有指定您想要的推断选项，该包将部署到无服务器端点。最后，目前只有单个模型端点支持实时推理，但对于预先训练的多模型部署的手动示例，请查看这些<a class="ae ky" href="https://github.com/RamVegiraju/SageMaker-Deployment/tree/master/RealTime/Multi-Model-Endpoint/Pre-Trained-Deployment" rel="noopener ugc nofollow" target="_blank">示例</a>。</p><p id="b958" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在今天的文章中，我将带您了解如何利用 TensorFlow 框架将这个 API 与流行的预训练的<a class="ae ky" href="https://www.tensorflow.org/api_docs/python/tf/keras/applications/resnet50/ResNet50" rel="noopener ugc nofollow" target="_blank"> ResNet50 模型</a>一起使用。</p><h2 id="c5c3" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">SageMaker 迁移工具包设置</h2><p id="662e" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">关于 API 的设置说明可以在<a class="ae ky" href="https://github.com/aws-samples/sagemaker-migration-toolkit/blob/main/README.md" rel="noopener ugc nofollow" target="_blank"> GitHub 自述文件</a>中找到。安装与其他 Python 包非常相似，您将在下面的步骤中看到。</p><ol class=""><li id="71fb" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated">克隆 GitHub repo</li><li id="1bfc" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">python setup.py bdist_wheel</li><li id="bc8f" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">pip install dist/sage maker _ migration _ toolkit-0 . 0 . 1-py3-none-any . whl</li><li id="b2fc" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">sagemaker _ migration.configure 模块名称 sagemaker_migration.configure</li></ol><p id="d3c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第四步是为 SageMaker 服务添加 IAM 角色。您应该能够在 IAM 控制台中访问它，或者在笔记本单元中运行以下代码来获得您的角色。</p><pre class="kj kk kl km gt nh ni nj bn nk nl bi"><span id="37da" class="nm lw it ni b be nn no l np nq">import sagemaker<br/>sagemaker.get_execution_role()</span></pre><p id="b5d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个例子中，我们将在一台<a class="ae ky" href="https://docs.aws.amazon.com/sagemaker/latest/dg/nbi.html" rel="noopener ugc nofollow" target="_blank"> SageMaker 笔记本</a>上使用 conda_tf2 内核，以便预装 TensorFlow。</p><h2 id="fd7d" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">ResNet50 型号设置</h2><p id="705f" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">在开始使用迁移工具包之前，我们需要正确下载和序列化 ResNet50 模型工件。SageMaker 希望模型数据的格式符合框架的服务栈。对于 TensorFlow 服务，序列化模型数据遵循<a class="ae ky" href="https://www.tensorflow.org/guide/saved_model" rel="noopener ugc nofollow" target="_blank"> SavedModel </a>格式。模型数据的结构应该如下所示:</p><pre class="kj kk kl km gt nh ni nj bn nk nl bi"><span id="5dd5" class="nm lw it ni b be nn no l nr nq">model_artifact_version/<br/>    variables/<br/>        variables.data<br/>        variables.index<br/>    keras_metadata.pb<br/>    saved_model.pb<br/>inference.py #optional, but recommended</span></pre><p id="5aee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用 TensorFlow，我们可以加载 ResNet50 模型。</p><pre class="kj kk kl km gt nh ni nj bn nk nl bi"><span id="7f75" class="nm lw it ni b be nn no l np nq">import os<br/>import tensorflow as tf<br/>from tensorflow.keras.applications import resnet50<br/>from tensorflow.keras import backend<br/>import numpy as np<br/>from tensorflow.keras.preprocessing import image<br/><br/>tf.keras.backend.set_learning_phase(0)<br/>model = resnet50.ResNet50() #Load model</span></pre><p id="6771" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">既然我们的模型已经加载，我们可以将这些模型工件转储到一个目录中，其结构如上所示。</p><pre class="kj kk kl km gt nh ni nj bn nk nl bi"><span id="dde2" class="nm lw it ni b be nn no l np nq">export_dir = "00002" #directory to store model artifacts<br/>model = tf.keras.applications.ResNet50()<br/><br/>if not os.path.exists(export_dir):<br/>    os.makedirs(export_dir)<br/>    print("Directory ", export_dir, " Created ")<br/>else:<br/>    print("Directory ", export_dir, " already exists")<br/># Save to SavedModel<br/>model.save(export_dir, save_format="tf", include_optimizer=False)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/d42505d46e1ebe42d45fb56da5264e44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/format:webp/1*7RO2gjS5IBaWaWeqc9oxUg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">保存的模型工件(作者截图)</p></figure><p id="0544" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，SageMaker 迁移工具包还期望提供一个 inference.py 脚本。对于那些不熟悉的人来说，一个<a class="ae ky" href="https://aws.plainenglish.io/adding-custom-inference-scripts-to-amazon-sagemaker-2208c3332510" rel="noopener ugc nofollow" target="_blank"> inference.py </a>文件允许用户将他们的预处理和后处理逻辑添加到他们的端点。对于这个模型，我们真的不需要任何前/后处理，所以我们可以创建一个没有任何功能的虚拟推理脚本。</p><pre class="kj kk kl km gt nh ni nj bn nk nl bi"><span id="f9a6" class="nm lw it ni b be nn no l np nq">%%writefile inference.py<br/>import os<br/>import json</span></pre><p id="ff56" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在准备利用迁移工具包进行模型部署。</p><h2 id="451d" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">SageMaker 迁移工具包部署</h2><p id="cddf" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">我们首先导入必要的模块来使用这个包。</p><pre class="kj kk kl km gt nh ni nj bn nk nl bi"><span id="645b" class="nm lw it ni b be nn no l np nq">from sagemaker_migration import frameworks as fwk<br/>import os</span></pre><p id="87e4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在框架模块中，目前支持 TensorFlow、PyTorch 和 Sklearn。我们创建一个 TensorFlow 模型实体，并传递适当的参数。</p><pre class="kj kk kl km gt nh ni nj bn nk nl bi"><span id="e9ef" class="nm lw it ni b be nn no l np nq"># Create a TensorFlow Model Object Entity, you can create a real-time or serverless endpoint<br/>tf_model = fwk.TensorFlowModel(<br/>    version = '2.3.0',<br/>    model_data = '00002',<br/>    inference_option = 'real-time',<br/>    inference = 'inference.py',<br/>    instance_type = 'ml.m5.xlarge')</span></pre><p id="3480" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里有几个强制参数:</p><ol class=""><li id="5ceb" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated">model_data (str):这是序列化模型数据的路径。</li><li id="a898" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">推论(str):这是你的推论. py 脚本，即使是空的也要提供一个。</li><li id="626b" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">version (str):这是您的模型的框架版本，在底层，工具包将搜索该版本支持的 SageMaker 容器。</li></ol><p id="8b0a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">至于推理选项，默认设置为无服务器推理。如果您指定推理选项，您还可以设置参数，例如用于<a class="ae ky" href="https://github.com/aws-samples/sagemaker-migration-toolkit/blob/main/sagemaker_migration/sagemaker_migration.py#L32" rel="noopener ugc nofollow" target="_blank">实时推理</a>的实例类型，以及用于<a class="ae ky" href="https://github.com/aws-samples/sagemaker-migration-toolkit/blob/main/sagemaker_migration/sagemaker_migration.py#L43" rel="noopener ugc nofollow" target="_blank">无服务器推理</a>的并发/内存。</p><p id="70e9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">与使用 Boto3 的主要区别在于，您不再需要与模型、端点配置、<a class="ae ky" href="https://aws.plainenglish.io/how-to-retrieve-amazon-sagemaker-deep-learning-images-ff4a5866299e" rel="noopener ugc nofollow" target="_blank">图像</a>和其他较低层次的相关 SageMaker 对象进行交互。当您部署这个 TensorFlow 模型实体时，您将看到所有这些都是自动创建的。</p><pre class="kj kk kl km gt nh ni nj bn nk nl bi"><span id="8f23" class="nm lw it ni b be nn no l np nq">tf_model.deploy_to_sagemaker()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/f48392bd7966198afd35b74341bbd74c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y5DS4_DlQESMApOHPdmgeQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">端点创建(作者截图)</p></figure><p id="d3b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">模型 tarball 是自动为您创建的，<a class="ae ky" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sagemaker.html#SageMaker.Client.create_model" rel="noopener ugc nofollow" target="_blank"> SageMaker 模型</a>、<a class="ae ky" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sagemaker.html#SageMaker.Client.create_endpoint_config" rel="noopener ugc nofollow" target="_blank"> SageMaker 端点配置</a>，最后是<a class="ae ky" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sagemaker.html#SageMaker.Client.create_endpoint" rel="noopener ugc nofollow" target="_blank"> SageMaker 端点</a>本身。</p><h2 id="fc94" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">结论</h2><div class="nu nv gp gr nw nx"><a href="https://github.com/aws-samples/sagemaker-migration-toolkit/blob/main/examples/resnet-sm-toolkit.ipynb" rel="noopener  ugc nofollow" target="_blank"><div class="ny ab fo"><div class="nz ab oa cl cj ob"><h2 class="bd iu gy z fp oc fr fs od fu fw is bi translated">sage maker-migration-toolkit/resnet-sm-toolkit . ipynb at main…</h2><div class="oe l"><h3 class="bd b gy z fp oc fr fs od fu fw dk translated">在 GitHub 上创建一个帐户，为 AWS-samples/sage maker-migration-toolkit 的开发做出贡献。</h3></div><div class="of l"><p class="bd b dl z fp oc fr fs od fu fw dk translated">github.com</p></div></div><div class="og l"><div class="oh l oi oj ok og ol ks nx"/></div></div></a></div><p id="04c5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以在上面的链接中找到这个例子的代码。如果您在使用 API 或您想要请求的任何模型时有任何问题，请在<a class="ae ky" href="https://github.com/aws-samples/sagemaker-migration-toolkit" rel="noopener ugc nofollow" target="_blank"> Github </a>上添加 PR 或问题。一如既往，我希望这篇文章是一个有用的指南，尤其是对那些刚接触 SageMaker 上的模型部署的人。敬请关注更多信息，感谢所有反馈。</p><h2 id="e6c9" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">额外资源</h2><p id="1254" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated"><a class="ae ky" href="https://github.com/aws-samples/load-testing-sagemaker-endpoints" rel="noopener ugc nofollow" target="_blank">负载测试 SageMaker 端点</a></p><p id="8183" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" rel="noopener" target="_blank" href="/bring-your-own-container-with-amazon-sagemaker-37211d8412f4"> SageMaker 自带容器</a></p></div><div class="ab cl om on hx oo" role="separator"><span class="op bw bk oq or os"/><span class="op bw bk oq or os"/><span class="op bw bk oq or"/></div><div class="im in io ip iq"><p id="fdf8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="ot">如果你喜欢这篇文章，请在</em> <a class="ae ky" href="https://www.linkedin.com/in/ram-vegiraju-81272b162/" rel="noopener ugc nofollow" target="_blank"> <em class="ot"> LinkedIn </em> </a> <em class="ot">上与我联系，并订阅我的媒体</em> <a class="ae ky" href="https://ram-vegiraju.medium.com/subscribe" rel="noopener"> <em class="ot">简讯</em> </a> <em class="ot">。如果你是新手，使用我的</em> <a class="ae ky" href="https://ram-vegiraju.medium.com/membership" rel="noopener"> <em class="ot">会员推荐</em> </a> <em class="ot">报名。</em></p></div></div>    
</body>
</html>