<html>
<head>
<title>How To Handle Date and Time Difference in PostgreSQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何处理PostgreSQL中的日期和时间差异</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-handle-date-and-time-difference-in-postgresql-615f26ba0b84#2022-06-24">https://towardsdatascience.com/how-to-handle-date-and-time-difference-in-postgresql-615f26ba0b84#2022-06-24</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><h2 id="0e3a" class="is it iu bd b dl iv iw ix iy iz ja dk jb translated" aria-label="kicker paragraph">SQL提示</h2><div class=""/><div class=""><h2 id="0a0f" class="pw-subtitle-paragraph ka jd iu bd b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr dk translated">当没有DATE_DIFF()函数可用时，让您的生活更轻松的3个技巧</h2></div><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj ks"><img src="../Images/30b616c422f5e83a6c8ca99ffefcc640.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8f399rq3ZHetn1tA_YHBiw.jpeg"/></div></div><p class="le lf gk gi gj lg lh bd b be z dk translated">乔恩·泰森在<a class="ae li" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><blockquote class="lj lk ll"><p id="923c" class="lm ln lo lp b lq lr ke ls lt lu kh lv lw lx ly lz ma mb mc md me mf mg mh mi in bi translated">潜在客户A于2022年1月20日上午8点注册了贵公司的服务。她在2022年2月3日下午4点取消了订阅。她成为你们公司的客户多久了？</p></blockquote><p id="1e58" class="pw-post-body-paragraph lm ln iu lp b lq lr ke ls lt lu kh lv mj lx ly lz mk mb mc md ml mf mg mh mi in bi translated">要回答这个问题，你需要计算两个时间点之间的差异。不考虑这种特定情况下最相关的时间尺度(差异是否应该用周来表示？几天内？几个小时？)，必须有一个函数来帮助您<strong class="lp je">轻松地找到两个事件之间过去了多长时间——在本例中，是潜在客户注册和取消订阅之间的时间。</strong></p><p id="6cb9" class="pw-post-body-paragraph lm ln iu lp b lq lr ke ls lt lu kh lv mj lx ly lz mk mb mc md ml mf mg mh mi in bi translated">在我以前的工作经验中，我曾经通过使用直接连接到我们数据库的Google BigQuery控制台来获得这类问题的答案。在Google BigQuery中，查询是用标准SQL编写的。足够方便的是，有一个<strong class="lp je">易于实现的公式来计算两个时间点的差值</strong> : <a class="ae li" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/date_functions#date_diff" rel="noopener ugc nofollow" target="_blank"> DATE_DIFF() </a>。</p><p id="07e5" class="pw-post-body-paragraph lm ln iu lp b lq lr ke ls lt lu kh lv mj lx ly lz mk mb mc md ml mf mg mh mi in bi translated">但是，<strong class="lp je">在PostgreSQL中没有与DATE_DIFF() </strong>直接等价的。因此，我们必须找到现有功能的正确组合，以获得我们真正需要的输出。关于这个话题，<a class="ae li" href="https://www.postgresql.org/docs/current/functions-datetime.html" rel="noopener ugc nofollow" target="_blank"> PostgreSQL的文档</a>非常广泛，但是我必须承认我对列出的所有公式有些困惑。</p><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj mm"><img src="../Images/e75e9d03ae4806e755eb82ee87fd12e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GJyHvgnUYdXfx27-SANOKQ.png"/></div></div><p class="le lf gk gi gj lg lh bd b be z dk translated">摘自<a class="ae li" href="https://www.postgresql.org/docs/current/functions-datetime.html" rel="noopener ugc nofollow" target="_blank"> PostgreSQL文档</a></p></figure><p id="ceae" class="pw-post-body-paragraph lm ln iu lp b lq lr ke ls lt lu kh lv mj lx ly lz mk mb mc md ml mf mg mh mi in bi translated">看似简单的事情结果比我想象的稍微复杂一些，所以我想我可以和你分享以下3个正确处理PostgreSQL日期差异的技巧。</p><p id="fee3" class="pw-post-body-paragraph lm ln iu lp b lq lr ke ls lt lu kh lv mj lx ly lz mk mb mc md ml mf mg mh mi in bi translated">让我们通过引言中提到的例子来详细研究它们。在这个例子中，假设我们定义了两个输入变量<strong class="lp je">:start _ date和end_date。我们想要得到的<strong class="lp je">输出是这两个日期时间的差值</strong>:</strong></p><ul class=""><li id="7e9d" class="mn mo iu lp b lq lr lt lu mj mp mk mq ml mr mi ms mt mu mv bi translated">以天为单位</li><li id="0a13" class="mn mo iu lp b lq mw lt mx mj my mk mz ml na mi ms mt mu mv bi translated">以小时计</li></ul><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj nb"><img src="../Images/9669f0b3a0899b1d80df1cfba0c8b44d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*flkLGDOeaR3PzILWbohCQQ.png"/></div></div><p class="le lf gk gi gj lg lh bd b be z dk translated">作者举例</p></figure><h1 id="d229" class="nc nd iu bd ne nf ng nh ni nj nk nl nm kj nn kk no km np kn nq kp nr kq ns nt bi translated">#1 —避免一连串的DATE_PART()函数</h1><p id="eec7" class="pw-post-body-paragraph lm ln iu lp b lq nu ke ls lt nv kh lv mj nw ly lz mk nx mc md ml ny mg mh mi in bi translated">我曾经遇到的第一个技巧来自<a class="ae li" href="https://www.sqlines.com/postgresql/how-to/datediff" rel="noopener ugc nofollow" target="_blank"> SQLines </a>:</p><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj nz"><img src="../Images/1f4b53be26a49d0dcf794a8bea5c9d3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZpfOMBZmPk-nP_zM7CFEVw.png"/></div></div><p class="le lf gk gi gj lg lh bd b be z dk translated">从<a class="ae li" href="https://www.sqlines.com/postgresql/how-to/datediff" rel="noopener ugc nofollow" target="_blank"> SQLines </a>中提取</p></figure><p id="afa2" class="pw-post-body-paragraph lm ln iu lp b lq lr ke ls lt lu kh lv mj lx ly lz mk mb mc md ml mf mg mh mi in bi translated">他们建议创建一个用户定义的函数，或者，如果您只有编写一些声明性SQL ( <code class="fe oa ob oc od b">SELECT...</code>)的权限或技能，建议的解决方案是使用一系列的DATE_PART()函数。在我们的示例中，我们将编写以下代码来获取天数和小时数的差异:</p><figure class="kt ku kv kw gu kx"><div class="bz fq l di"><div class="oe of l"/></div></figure><p id="6dc8" class="pw-post-body-paragraph lm ln iu lp b lq lr ke ls lt lu kh lv mj lx ly lz mk mb mc md ml mf mg mh mi in bi translated">这将导致以下输出:</p><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj og"><img src="../Images/cd8b78d1620f4046d8886c555d69f772.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uEfdz5tull4uI34Yq8qeDw.png"/></div></div><p class="le lf gk gi gj lg lh bd b be z dk translated">提示#1的输出—作者的代码和屏幕截图</p></figure><p id="c316" class="pw-post-body-paragraph lm ln iu lp b lq lr ke ls lt lu kh lv mj lx ly lz mk mb mc md ml mf mg mh mi in bi translated">计算是正确的，并且输出是容易解释的。然而，我认为这种方法有两个缺点。</p><p id="f141" class="pw-post-body-paragraph lm ln iu lp b lq lr ke ls lt lu kh lv mj lx ly lz mk mb mc md ml mf mg mh mi in bi translated">首先，<strong class="lp je">所需的那段代码不紧凑</strong>。为了获得更好的代码可读性，必须确保代码正确缩进，以便读者理解哪个“日期部分”对应于计算的哪个部分。在我们的例子中，我们只进行到小时刻度，但是如果我们想计算秒的差异，我们将添加两个额外的DATE_PART函数。</p><p id="28a9" class="pw-post-body-paragraph lm ln iu lp b lq lr ke ls lt lu kh lv mj lx ly lz mk mb mc md ml mf mg mh mi in bi translated">第二，多次调用函数DATE_PART()会导致<strong class="lp je">在执行</strong>段代码时可能会损失性能。当对相同的输出实现各种选项时，必须确保比较两个查询在应用于相同数据集时的性能。</p><h1 id="34c9" class="nc nd iu bd ne nf ng nh ni nj nk nl nm kj nn kk no km np kn nq kp nr kq ns nt bi translated">#2—从年龄开始()</h1><p id="06ac" class="pw-post-body-paragraph lm ln iu lp b lq nu ke ls lt nv kh lv mj nw ly lz mk nx mc md ml ny mg mh mi in bi translated">在PostgreSQL中，函数AGE()将为您的问题提供详细的答案:这两个事件之间经过了多长时间？<strong class="lp je">输出以文本行</strong>的形式显示两个时间点之间的差异。</p><figure class="kt ku kv kw gu kx"><div class="bz fq l di"><div class="oe of l"/></div></figure><p id="0b93" class="pw-post-body-paragraph lm ln iu lp b lq lr ke ls lt lu kh lv mj lx ly lz mk mb mc md ml mf mg mh mi in bi translated">输出将如下所示:</p><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj oh"><img src="../Images/5cf4a1d98ca4fa17c71670741a3bf2c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cGGdUj75_YjUUgUOlAoyYw.png"/></div></div><p class="le lf gk gi gj lg lh bd b be z dk translated">技巧#2的输出—作者的代码和屏幕截图</p></figure><p id="8d75" class="pw-post-body-paragraph lm ln iu lp b lq lr ke ls lt lu kh lv mj lx ly lz mk mb mc md ml mf mg mh mi in bi translated">根据您的数据输入和您正在处理的用例，您可能会对这种方法感到满意。特别是，如果您用函数AGE()给出的输出来回答最终用户的需求，可能就没有必要使输出过于复杂。</p><h1 id="bbce" class="nc nd iu bd ne nf ng nh ni nj nk nl nm kj nn kk no km np kn nq kp nr kq ns nt bi translated">#3 —使用EXTRACT(EPOCH FROM())提升级别</h1><p id="4dbd" class="pw-post-body-paragraph lm ln iu lp b lq nu ke ls lt nv kh lv mj nw ly lz mk nx mc md ml ny mg mh mi in bi translated">如果您确定所有值都包含在给定的日期和时间范围内，请保持简单。只要坚持使用<strong class="lp je"> AGE()函数，并结合EXTRACT() </strong>即可。这适用于以下以天数表示的差异。但是仔细看看以小时为单位的输出差异:</p><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj oi"><img src="../Images/5143e761c6f1eba2ce750bafba1cdd0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QFo-PY1aOKgq-twPpN-K2w.png"/></div></div><p class="le lf gk gi gj lg lh bd b be z dk translated">提示#2的不当使用输出—作者的代码和屏幕截图</p></figure><p id="9176" class="pw-post-body-paragraph lm ln iu lp b lq lr ke ls lt lu kh lv mj lx ly lz mk mb mc md ml mf mg mh mi in bi translated">正如您可能注意到的，第二个查询的问题是，我们试图返回两天之间的时间差异。在这里，AGE()函数并不合适:<strong class="lp je">它返回以小时为单位的差值…不考虑日期！</strong></p><p id="4277" class="pw-post-body-paragraph lm ln iu lp b lq lr ke ls lt lu kh lv mj lx ly lz mk mb mc md ml mf mg mh mi in bi translated">在这种情况下——无论如何，如果您有疑问——您应该使用EXTRACT()函数和EPOCH参数的组合<strong class="lp je">。让我们最后一次以我们的例子来证明:</strong></p><figure class="kt ku kv kw gu kx"><div class="bz fq l di"><div class="oe of l"/></div></figure><p id="7492" class="pw-post-body-paragraph lm ln iu lp b lq lr ke ls lt lu kh lv mj lx ly lz mk mb mc md ml mf mg mh mi in bi translated">输出将如下所示:</p><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj oj"><img src="../Images/ede704590a8d27b47a9a7ab856e3677a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6MVS9NXMdiA-Vqv5jH2DhA.png"/></div></div><p class="le lf gk gi gj lg lh bd b be z dk translated">技巧#3的输出—作者的代码和屏幕截图</p></figure><p id="0250" class="pw-post-body-paragraph lm ln iu lp b lq lr ke ls lt lu kh lv mj lx ly lz mk mb mc md ml mf mg mh mi in bi translated"><strong class="lp je">成功了！</strong>与使用选项#1编写的代码相比，有两个优点:</p><ol class=""><li id="f906" class="mn mo iu lp b lq lr lt lu mj mp mk mq ml mr mi ok mt mu mv bi translated">代码更加简洁</li><li id="c873" class="mn mo iu lp b lq mw lt mx mj my mk mz ml na mi ok mt mu mv bi translated">天数的差异以更详细的级别表示(默认情况下，有两位小数)</li></ol><h1 id="a698" class="nc nd iu bd ne nf ng nh ni nj nk nl nm kj nn kk no km np kn nq kp nr kq ns nt bi translated">结论</h1><blockquote class="lj lk ll"><p id="bf3f" class="lm ln lo lp b lq lr ke ls lt lu kh lv lw lx ly lz ma mb mc md me mf mg mh mi in bi translated">在适用的地方保持简单</p><p id="50ec" class="lm ln lo lp b lq lr ke ls lt lu kh lv lw lx ly lz ma mb mc md me mf mg mh mi in bi translated">在相关的地方使它变得复杂</p></blockquote><p id="ea9e" class="pw-post-body-paragraph lm ln iu lp b lq lr ke ls lt lu kh lv mj lx ly lz mk mb mc md ml mf mg mh mi in bi translated">本文的目的是收集有用的技巧来处理PostgreSQL中的日期和时间差异。您无需一次应用所有这些功能——只需<strong class="lp je">选择最适合您自己的用例</strong>即可。</p><p id="a9ce" class="pw-post-body-paragraph lm ln iu lp b lq lr ke ls lt lu kh lv mj lx ly lz mk mb mc md ml mf mg mh mi in bi translated">在PostgreSQL中使用其他函数来轻松处理日期和时间吗？我很乐意听到他们，并在评论区分享我们的最佳实践！</p></div><div class="ab cl ol om hy on" role="separator"><span class="oo bw bk op oq or"/><span class="oo bw bk op oq or"/><span class="oo bw bk op oq"/></div><div class="in io ip iq ir"><p id="467f" class="pw-post-body-paragraph lm ln iu lp b lq lr ke ls lt lu kh lv mj lx ly lz mk mb mc md ml mf mg mh mi in bi translated">你喜欢读这篇文章吗？ <a class="ae li" href="https://marie-lefevre.medium.com/membership" rel="noopener"> <em class="lo">成为会员</em> </a> <em class="lo">加入一个不断成长的充满好奇心的社区吧！</em></p><div class="os ot gq gs ou ov"><a href="https://marie-lefevre.medium.com/membership" rel="noopener follow" target="_blank"><div class="ow ab fp"><div class="ox ab oy cl cj oz"><h2 class="bd je gz z fq pa fs ft pb fv fx jd bi translated">通过我的推荐链接加入媒体-玛丽·勒菲弗尔</h2><div class="pc l"><h3 class="bd b gz z fq pa fs ft pb fv fx dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="pd l"><p class="bd b dl z fq pa fs ft pb fv fx dk translated">marie-lefevre.medium.com</p></div></div><div class="pe l"><div class="pf l pg ph pi pe pj lc ov"/></div></div></a></div></div></div>    
</body>
</html>