<html>
<head>
<title>Differences between Numbering Functions in BigQuery using SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用SQL的BigQuery中编号函数之间的差异</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/differences-between-numbering-functions-in-bigquery-using-sql-658fb7c9af65#2022-09-03">https://towardsdatascience.com/differences-between-numbering-functions-in-bigquery-using-sql-658fb7c9af65#2022-09-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2cfc" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解如何使用等级、密集等级、行号、累积分布、百分位数等级、四分位数、百分位数等等</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/0cadf822c2f9630151a91c8f175b89d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FFOPGbs8Zl6F4iPs"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">澳大利亚摄影师<a class="ae ky" href="https://unsplash.com/@austris_a?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">在</a><a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="9ffc" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">什么是编号功能？</h1><p id="60ff" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">编号功能为表中的每条记录分配一个数字(或小数)。它们主要用于对数据进行排序或分配序号，以便进一步处理(重复数据删除、过滤、分组)。</p><p id="648c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">它们通常需要按特定维度排序(日期、收入、薪水、ID等)。</p><p id="68f0" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">它们可用于回答以下问题:</p><ul class=""><li id="b2a0" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm mx my mz na bi translated"><strong class="lt iu">收入最高的国家有哪些？</strong></li><li id="2023" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated"><strong class="lt iu">我如何按赛区和工资给排球运动员排名？</strong></li><li id="ba4e" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated"><strong class="lt iu">按产品类别划分，表现最佳的国家有哪些？</strong></li><li id="b44d" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated"><strong class="lt iu">根据摄取日期复制了哪些行？</strong></li></ul><p id="9001" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">本文将分为<strong class="lt iu">两节。</strong>第一部分将介绍<code class="fe ng nh ni nj b">RANK()</code>、<code class="fe ng nh ni nj b">DENSE_RANK()</code>和<code class="fe ng nh ni nj b">ROW_NUMBER()</code>的机制，因为它们的目的非常相似，但输出和机制略有不同。</p><p id="986e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">第二部分将涵盖<code class="fe ng nh ni nj b">PERCENT_RANK</code>、<code class="fe ng nh ni nj b">CUME_DIST</code>和<code class="fe ng nh ni nj b">NTILE</code>，它们具有不同的目的、机制和输出。</p><p id="a0a7" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我还建议阅读伟大的谷歌文档。</p><div class="nk nl gp gr nm nn"><a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/numbering_functions" rel="noopener  ugc nofollow" target="_blank"><div class="no ab fo"><div class="np ab nq cl cj nr"><h2 class="bd iu gy z fp ns fr fs nt fu fw is bi translated">编号功能| BigQuery | Google Cloud</h2><div class="nu l"><h3 class="bd b gy z fp ns fr fs nt fu fw dk translated">无论您的企业正处于数字化转型的早期阶段，谷歌云都可以帮助您…</h3></div><div class="nv l"><p class="bd b dl z fp ns fr fs nt fu fw dk translated">cloud.google.com</p></div></div><div class="nw l"><div class="nx l ny nz oa nw ob ks nn"/></div></div></a></div><p id="27e0" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">为了更好地理解这些函数之间的区别，我们将查询以下数据集，该数据集包含来自<a class="ae ky" href="https://shop.googlemerchandisestore.com/" rel="noopener ugc nofollow" target="_blank">谷歌商品商店</a>的不同国家和产品类别的销售额。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/d067b15997d7a14512e6a190068fce40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1130/format:webp/1*AAmJ3EpUmdctEya7c-RK-Q.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们简单分析用例的基础表。(图片由<a class="ae ky" href="https://medium.com/@romaingranger" rel="noopener">作者</a>提供)</p></figure></div><div class="ab cl od oe hx of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="im in io ip iq"><h2 id="c200" class="ok la it bd lb ol om dn lf on oo dp lj ma op oq ll me or os ln mi ot ou lp ov bi translated">行数</h2><p id="4878" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">函数<code class="fe ng nh ni nj b">ROW_NUMBER()</code>将总是返回一个唯一的数字，从1开始按顺序递增(1，2，3，4…，8，9…)。不需要指定顺序，即使行或值相似，输出编号也总是唯一的。</p><p id="72d0" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果没有使用<code class="fe ng nh ni nj b">ORDER BY</code>子句，结果将是<strong class="lt iu">不确定的</strong>，这意味着即使输入数据相同，结果也会不同。</p><p id="0788" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">让我们看两个例子:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/6323681937f2c3289f6c9871640b0c30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1330/format:webp/1*huV1HK8hIDWosDCNPozVpg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">ROW_NUMBER()返回一个连续且唯一的数字。(图片由<a class="ae ky" href="https://medium.com/@romaingranger" rel="noopener">作者</a>提供)</p></figure><p id="2ecb" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在本例中，我们使用一个空的<code class="fe ng nh ni nj b">OVER()</code>子句，这意味着函数将遍历表并为每一行随机分配一个数字(即使BigQuery如何分配它可能有一些逻辑)。</p><p id="74fa" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">让我们看看在我们的第二个例子中，当我们向revenue字段添加一个<code class="fe ng nh ni nj b">ORDER BY</code>子句时会发生什么。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/fa84d1d7676cf78c1e2dc3f1c49963e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1330/format:webp/1*eqphPDjFONk2ycSNhkALrQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">ROW_NUMBER()返回一个按收入排序的连续且唯一的数字。(图片由<a class="ae ky" href="https://medium.com/@romaingranger" rel="noopener">作者</a>提供)</p></figure><p id="b7f8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">行号现在按收入排序，我们希望结果按降序排列，这就是为什么我们添加了一个<code class="fe ng nh ni nj b">DESC</code>命令(默认情况下，它是升序)。</p><p id="c9ac" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">对于具有相同值、<code class="fe ng nh ni nj b">Indonesia</code>和<code class="fe ng nh ni nj b">Taiwan</code>的<strong class="lt iu">两行，功能输出数保持递增。</strong></p><p id="23f5" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">隐含地，还有一个字母顺序，这可以通过手动添加另一个排序参数来改变。</p><blockquote class="oz pa pb"><p id="cfab" class="lr ls pc lt b lu mn ju lw lx mo jx lz pd mp mc md pe mq mg mh pf mr mk ml mm im bi translated"><code class="fe ng nh ni nj b">ROW_NUMBER() OVER(ORDER BY revenue DESC, country DESC)</code></p></blockquote></div><div class="ab cl od oe hx of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="im in io ip iq"><p id="ffe3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">假设我们想要分解每个产品类别的<strong class="lt iu">行号。为此，我们可以使用一个<code class="fe ng nh ni nj b">PARTITION BY</code>子句，并按收入值降序排序。</strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/e7d46b03ae8f7a78d9c06dc1931e85d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1330/format:webp/1*2Zd5SbhQ4XIuIBLyAnbnQg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">ROW_NUMBER()为每个分区返回一个从1开始的连续且唯一的数字。(图片由<a class="ae ky" href="https://medium.com/@romaingranger" rel="noopener">作者</a>提供)</p></figure><p id="21e7" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这对于在数据集中可用的不同组或类别中排列/分配顺序非常有益。</p></div><div class="ab cl od oe hx of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="im in io ip iq"><h2 id="10c1" class="ok la it bd lb ol om dn lf on oo dp lj ma op oq ll me or os ln mi ot ou lp ov bi translated">秩和稠密_秩</h2><p id="d786" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">函数<code class="fe ng nh ni nj b">RANK()</code>和<code class="fe ng nh ni nj b">DENSE_RANK()</code>的行为与<code class="fe ng nh ni nj b">ROW_NUMBER()</code>相同，但有两个例外:它们如何<strong class="lt iu">序列号</strong>以及它们如何<strong class="lt iu">管理相似的值</strong>。</p><p id="5f07" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">对于<code class="fe ng nh ni nj b">RANK()</code>，相似的行将获得相同的等级号，但是函数将在两个或更多相同的行之后留下一个间隙。</p><p id="040b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">对于<code class="fe ng nh ni nj b">DENSE_RANK()</code>，相似的行将接收相同的等级编号，但是等级编号总是递增1，并且在我们的编号序列中不会有间隔。</p><p id="344c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">让我们举例说明<strong class="lt iu">一个查询中的三个功能</strong>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pg"><img src="../Images/9e5d8eb6efd09abf6094007783c0ed7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*izEhWvc9Skh0tKuU05X1ZA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">这三个功能按收入排序。(图片由<a class="ae ky" href="https://medium.com/@romaingranger" rel="noopener">作者</a>提供)</p></figure><p id="ff86" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这是我们不同函数的输出。您可以关注国家/地区<code class="fe ng nh ni nj b">Venezuela</code>(重复)的第5行和第6行上的函数如何工作，以及之后:</p><ul class=""><li id="8552" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm mx my mz na bi translated"><code class="fe ng nh ni nj b">ROW_ NUMBER()</code>保持其递增顺序(1，2，3，<strong class="lt iu"> 4，5，6，7 </strong></li><li id="655e" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated"><code class="fe ng nh ni nj b">RANK()</code>给出相同的输出值(5，5)，但随后丢失其增量序列(1，2，3，<strong class="lt iu"> 4，5，5，7 </strong>)</li><li id="38eb" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated"><code class="fe ng nh ni nj b">DENSE_RANK()</code>给出相同的输出值(5，5)，但保持其递增顺序(1，2，3，<strong class="lt iu"> 4，5，5，6 </strong></li></ul><p id="9e76" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">第10行和第11行的机制相同，因为我们是按收入排序的，它们的收入相同。这种增量序列机制对于任意数量的对等值都是一样的。</p><p id="347c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu">为什么不用ROW_NUMBER代替RANK或者DENSE_RANK？</strong></p><p id="7596" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">您可以使用<code class="fe ng nh ni nj b">ROW_NUMBER()</code>作为排名函数，但是有时为所有相似/对等行保持相同的排名值是很有趣的。</p><p id="bcf8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">对于某些用例，用<code class="fe ng nh ni nj b">DENSE_RANK()</code>保持数字序列总是递增1可能是一个好的选择。</p></div><div class="ab cl od oe hx of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="im in io ip iq"><h2 id="8ecf" class="ok la it bd lb ol om dn lf on oo dp lj ma op oq ll me or os ln mi ot ou lp ov bi translated"><strong class="ak"> CUME_DIST </strong></h2><p id="03c1" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">函数<code class="fe ng nh ni nj b">CUME_DIST()</code>计算数据集或分区内值的累积分布。它返回从0到1的值(&gt; 0且≤1)。</p><p id="3ea7" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这个函数需要一个<code class="fe ng nh ni nj b">ORDER BY</code>子句来对值进行排序。</p><p id="2aa2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">根据Google的文档，它是使用公式计算的:<strong class="lt iu"> NP/NR。我们可以这样来解释它:</strong></p><ul class=""><li id="d92c" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm mx my mz na bi translated"><code class="fe ng nh ni nj b">NP</code>位于当前行之前或与当前行相似的行数</li><li id="74f8" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated"><code class="fe ng nh ni nj b">NR</code>是(整个数据集或一个分区的)总行数</li></ul><p id="3bf3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">它将向您展示数据集中的值是如何分布的。例如，基于收入的数据集行分布:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ph"><img src="../Images/57f7fb1c07b621adb27078fdc2a3ae6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1328/format:webp/1*r2FvIiziYre-TfCIqH_MWQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">按收入排序的所有行的累积分布。(图片由<a class="ae ky" href="https://medium.com/@romaingranger" rel="noopener">作者</a>提供)</p></figure><p id="c85c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们使用<code class="fe ng nh ni nj b">ROUND()</code>函数和乘法<code class="fe ng nh ni nj b">*100</code>将数据转换成可读性更好的百分比格式。</p><p id="a1b7" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">让我们手动计算。对于我们的第一行，只有1个值，并且没有低于<strong class="lt iu"> 1323的收入。</strong>这给了我们<strong class="lt iu"> 1/12 = 8% </strong>(我们的数据集中有12行)。</p><p id="f014" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在，让我们看看第4行，<code class="fe ng nh ni nj b">Nigeria</code>，有3行的值在当前行的<strong class="lt iu"> 3314 + </strong>下。这给了我们<strong class="lt iu"> 4/12 = 33% </strong>。</p><p id="ae09" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">有趣的部分是针对<strong class="lt iu">第2排和第3排</strong>(或第7排和第8排)。它们具有相同的收入值。因此，如果我们查看第2行，我们可以预期计算结果为<strong class="lt iu"> 2/12 = 16%。</strong>但是，由于第3行是相似的，所以两行的结果都是<strong class="lt iu"> 3/12 = 25%。</strong></p></div><div class="ab cl od oe hx of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="im in io ip iq"><h2 id="ae4d" class="ok la it bd lb ol om dn lf on oo dp lj ma op oq ll me or os ln mi ot ou lp ov bi translated">恩蒂莱</h2><p id="eada" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated"><code class="fe ng nh ni nj b">NTILE()</code>函数允许您将一组已排序的数据点分成均匀分布的桶。你可能知道这就是<strong class="lt iu">分位数</strong>，它可以有不同的类型:</p><ul class=""><li id="ccdc" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm mx my mz na bi translated"><strong class="lt iu">四分位数</strong> (4个分位数)</li><li id="d50a" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated"><strong class="lt iu">十分位数</strong> (10个分位数)</li><li id="29f0" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated"><strong class="lt iu">百分位数</strong> (100个分位数)</li></ul><p id="70ac" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">例如，<strong class="lt iu"> quartiles </strong>将数据集分成四个大小相等的桶。这意味着第一个四分位数(Q1)包含25%的数据点。</p><p id="baae" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">让我们将四分位数应用到我们的表中:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/5da8c38e44030dfff6a82f4e944271fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1330/format:webp/1*vvveoa62mL_SgLK1CUQcOg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们的行根据收入分成4个大小相等的桶。(图片由作者提供)</p></figure><p id="d213" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在这种情况下，我们根据有序收入将我们的数据点分成四个相等的桶(每个桶有3行，即<strong class="lt iu"> 3/12 = 25% </strong>)。</p><p id="2010" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">请记住<strong class="lt iu">这不是总数的百分比。</strong>如果我们将第四个四分位数国家(法国、日本和美国)的收入相加，它确实占总收入的90%。</p><p id="353c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">使用此功能时，您必须提供一个输入号码，例如:<code class="fe ng nh ni nj b">NTILE(4)</code>。你不能让这个参数为空，给一个0或负值的输入数而没有看到一个错误。</p><p id="bd84" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">您可以使用这种方法<strong class="lt iu">在您的数据中找到离群值</strong>(高于95%百分点的数据点)<strong class="lt iu">根据他们的购买价值(前25%)对您的客户</strong>进行分类，等等。</p></div><div class="ab cl od oe hx of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="im in io ip iq"><h2 id="1392" class="ok la it bd lb ol om dn lf on oo dp lj ma op oq ll me or os ln mi ot ou lp ov bi translated">百分比排名</h2><p id="bed5" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">函数<code class="fe ng nh ni nj b">PERCENT_RANK()</code>计算一组值中值的百分比分布。它返回从0到1的值。</p><p id="ee84" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这个函数需要一个<code class="fe ng nh ni nj b">ORDER BY</code>子句来对值进行排序。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pi"><img src="../Images/22b697d5635acc21e9147fa8159f18b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1324/format:webp/1*6kiaBHJJcI4gRQrPSpy-yg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">所有行按收入排序的百分位数排名(图片由<a class="ae ky" href="https://medium.com/@romaingranger" rel="noopener">作者</a>提供)</p></figure><p id="8bd6" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">同样，我们使用<code class="fe ng nh ni nj b">ROUND()</code>函数和乘法<code class="fe ng nh ni nj b">*100</code>将数据转换成可读性更好的百分比格式。</p><p id="1d72" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">看产出，<code class="fe ng nh ni nj b">Germany</code>收入最低(不大于其他任何国家)，所以<strong class="lt iu">百分位排名为零。</strong></p><p id="4b39" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">另一方面，<code class="fe ng nh ni nj b">United States</code>拥有所有国家中最大的收入(大于任何其他国家)，因此<strong class="lt iu">百分位等级为1(或100%)。</strong></p><p id="ccb3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">对于<code class="fe ng nh ni nj b">France</code>，百分位数排名为82%。这意味着它的收入高于所有其他国家的82%。</p></div><div class="ab cl od oe hx of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="im in io ip iq"><h1 id="8f14" class="kz la it bd lb lc pj le lf lg pk li lj jz pl ka ll kc pm kd ln kf pn kg lp lq bi translated">结论和想法</h1><p id="aa87" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">从实际经验来看，最常用的功能有<code class="fe ng nh ni nj b">ROW_NUMBER()</code>、<code class="fe ng nh ni nj b">RANK()</code>、<code class="fe ng nh ni nj b">DENSE_RANK()</code>和<code class="fe ng nh ni nj b">NTILE()</code>。</p><p id="6bad" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">例如，我的一项任务需要使用<code class="fe ng nh ni nj b">DENSE_RANK()</code>来识别<strong class="lt iu">收购产品</strong>，基本上是对客户订单中的产品进行排序，以识别哪些是最先购买的产品。这个函数允许我们将序列递增1，在一个订单中处理多个产品，并且仍然能够计算客户订单总数的正确数量。</p><p id="ec04" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在另一项任务中，<code class="fe ng nh ni nj b">NTILE()</code>帮助<strong class="lt iu">将客户</strong>分类为近期和频繁购买者类别(如<strong class="lt iu"> RFM模型</strong>(近期、频率、货币))，这将用于在我们的电子邮件服务提供商系统中进行细分。</p><p id="4282" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">您可以在其他数据库系统(Amazon Redshift、MySQL、Postgres、Snowflake等)中找到这些函数，因为它们是流行的SQL windows函数(至少对于排名和行号)。</p></div><div class="ab cl od oe hx of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="im in io ip iq"><h2 id="d72c" class="ok la it bd lb ol om dn lf on oo dp lj ma op oq ll me or os ln mi ot ou lp ov bi translated">引用和数据集</h2><p id="64a2" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">本文中使用的数据集来自于<a class="ae ky" href="https://cloud.google.com/bigquery/public-data" rel="noopener ugc nofollow" target="_blank"> BigQuery公共数据</a>，是在<a class="ae ky" href="https://creativecommons.org/licenses/by/4.0/" rel="noopener ugc nofollow" target="_blank"> CC BY 4.0 </a>许可下的Google analytics数据样本。</p><div class="nk nl gp gr nm nn"><a href="https://developers.google.com/analytics/bigquery/web-ecommerce-demo-dataset" rel="noopener  ugc nofollow" target="_blank"><div class="no ab fo"><div class="np ab nq cl cj nr"><h2 class="bd iu gy z fp ns fr fs nt fu fw is bi translated">Google Analytics 4电子商务web实施的BigQuery样本数据集| Google Analytics…</h2><div class="nu l"><h3 class="bd b gy z fp ns fr fs nt fu fw dk translated">谷歌商品商店是一个出售谷歌品牌商品的在线商店。该网站使用谷歌分析4的…</h3></div><div class="nv l"><p class="bd b dl z fp ns fr fs nt fu fw dk translated">developers.google.com</p></div></div><div class="nw l"><div class="po l ny nz oa nw ob ks nn"/></div></div></a></div></div></div>    
</body>
</html>