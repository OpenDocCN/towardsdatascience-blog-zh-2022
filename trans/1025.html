<html>
<head>
<title>Apache Airflow for Data Science — How to Work with REST APIs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Apache air flow for Data Science——如何使用 REST APIs</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/apache-airflow-for-data-science-how-to-work-with-rest-apis-8f4e20bee7d#2022-03-17">https://towardsdatascience.com/apache-airflow-for-data-science-how-to-work-with-rest-apis-8f4e20bee7d#2022-03-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="17d8" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated"><strong class="ak">在 5 分钟内构建连接到远程 REST API 的数据管道</strong></h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/461cafd97edd8ea1f66b0def56780eca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zBrIq4vE2c0xplDD"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@sanderweeteling?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">砂光机 Weeteling </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="83f8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">90%的数据管道有什么共同点？您已经猜到了——从 REST APIs 中提取和转换数据。如果您是 Apache Airflow 的狂热用户，有多种方法可以实现这一点。在<a class="ae ky" href="https://betterdatascience.com/apache-airflow-run-tasks-in-parallel/" rel="noopener ugc nofollow" target="_blank">早期的文章</a>中，您看到了如何用<code class="fe lv lw lx ly b">PythonOperator</code>处理 API 调用，但是我提到这不是一个推荐的方法。</p><p id="3dc8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么你应该如何完成这项任务呢？嗯，Airflow 有一个专用的<code class="fe lv lw lx ly b">SimpleHttpOperator</code>内置，它允许你有效地与外部 API 进行通信。今天你会了解到一切。</p><p id="ec77" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不想看书？请观看我的视频:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lz ma l"/></div></figure></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="6415" class="mi mj it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">如何配置与 REST APIs 通信的气流</h1><p id="b9ac" class="pw-post-body-paragraph kz la it lb b lc na ju le lf nb jx lh li nc lk ll lm nd lo lp lq ne ls lt lu im bi translated">首先，您必须使用以下命令安装 HTTP provider for Airflow:</p><pre class="kj kk kl km gt nf ly ng nh aw ni bi"><span id="ecab" class="nj mj it ly b gy nk nl l nm nn">pip install 'apache-airflow-providers-http'</span></pre><p id="1ea3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你不会马上在 Airflow 主页上看到它，所以你必须重启 web 服务器和调度程序。这样做之后，在<code class="fe lv lw lx ly b">dags</code>文件夹中创建一个新的 Python 文件——我将我的命名为<code class="fe lv lw lx ly b">api_dag.py</code>。</p><p id="2604" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它将包含我们今天要写的 DAG 的逻辑。现在，粘贴以下样板文件来设置 DAG:</p><pre class="kj kk kl km gt nf ly ng nh aw ni bi"><span id="4f39" class="nj mj it ly b gy nk nl l nm nn">import json<br/>from datetime import datetime<br/>from airflow.models import DAG<br/>from airflow.providers.http.sensors.http import HttpSensor<br/>from airflow.providers.http.operators.http import SimpleHttpOperator<br/>from airflow.operators.python import PythonOperator<br/></span><span id="2d8c" class="nj mj it ly b gy no nl l nm nn">with DAG(<br/>    dag_id='api_dag',<br/>    schedule_interval='@daily',<br/>    start_date=datetime(2022, 3, 1),<br/>    catchup=False<br/>) as dag:</span></pre><p id="f2fe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步是打开气流主页，进入<em class="np">管理</em> — <em class="np">连接</em>。单击加号添加新连接，并指定连接参数，如下图所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/7df6718beb0789b7b9e57472e37cb59a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dt2m4hjelwTvclcpPud1yA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 1-定义气流中的 HTTP 连接(图片由作者提供)</p></figure><p id="7d04" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">DAG 将从<a class="ae ky" href="https://gorest.co.in/" rel="noopener ugc nofollow" target="_blank">gorest.co.in</a>网站提取 posts JSON 数据，该网站用作测试目的的虚拟 REST API。您可以随意更改连接 ID 和描述，但请保留图像中显示的连接类型和主机。</p><p id="3a67" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在您已经拥有了提取数据所需的一切，接下来让我们开始吧。</p></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="5a4d" class="mi mj it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">写气流 DAG</h1><p id="6cf5" class="pw-post-body-paragraph kz la it lb b lc na ju le lf nb jx lh li nc lk ll lm nd lo lp lq ne ls lt lu im bi translated">使用外部 API 时，一个好的做法是先检查它们是否可用。有时您正在连接的网站关闭了，您应该经常检查它。</p><p id="39e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="np">为什么？</em>原因很简单——通过将逻辑分成两个任务(一个检查 API 是否可用，另一个获取数据),您可以知道 DAG 失败是因为 API 没有启动还是因为代码中有错误。不检查 API 是否可用可能会导致您在错误的地方搜索 bug。</p><p id="5bb0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用下面的代码声明一个<code class="fe lv lw lx ly b">HttpSensor</code> -它检查在气流配置中声明的 API 是否为给定的端点运行- <code class="fe lv lw lx ly b">posts/</code>:</p><pre class="kj kk kl km gt nf ly ng nh aw ni bi"><span id="a287" class="nj mj it ly b gy nk nl l nm nn">with DAG(...) as dag:</span><span id="6bb7" class="nj mj it ly b gy no nl l nm nn">    # 1. Check if the API is up<br/>    task_is_api_active = HttpSensor(<br/>        task_id='is_api_active',<br/>        http_conn_id='api_posts',<br/>        endpoint='posts/'<br/>    )</span></pre><p id="f9e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将足以测试任务。使用以下命令:</p><pre class="kj kk kl km gt nf ly ng nh aw ni bi"><span id="877e" class="nj mj it ly b gy nk nl l nm nn">airflow tasks test api_dag is_api_available 2022-3-1</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/dc472fdd40196e31dbd894eb0ff975f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S5p81xLNe34vOFakqRfocw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 2-测试 HttpSensor 气流任务(图片由作者提供)</p></figure><p id="f6e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">API 已经启动并运行，这意味着接下来我们可以提取数据了。</p><p id="e9e5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个<code class="fe lv lw lx ly b">SimpleHttpOperator</code>会处理好的。它将向<code class="fe lv lw lx ly b">posts/</code>端点发出 GET 请求，并将结果作为 JSON 返回:</p><pre class="kj kk kl km gt nf ly ng nh aw ni bi"><span id="e01a" class="nj mj it ly b gy nk nl l nm nn">with DAG(...) as dag:</span><span id="8e52" class="nj mj it ly b gy no nl l nm nn">    # 1. Check if the API is up<br/>    task_is_api_active = HttpSensor(...)</span><span id="f1ac" class="nj mj it ly b gy no nl l nm nn">    # 2. Get the posts<br/>    task_get_posts = SimpleHttpOperator(<br/>        task_id='get_posts',<br/>        http_conn_id='api_posts',<br/>        endpoint='posts/',<br/>        method='GET',<br/>        response_filter=lambda response: json.loads(response.text),<br/>        log_response=True<br/>    )</span></pre><p id="386e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们也测试一下这个任务:</p><pre class="kj kk kl km gt nf ly ng nh aw ni bi"><span id="2e06" class="nj mj it ly b gy nk nl l nm nn">airflow tasks test api_dag get_posts 2022-3-1</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/737587106a5d9e3b7320790558768871.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H4etZeoVK_TCc9iMjRk60Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 3 —从 Airflow 中的 REST API 收集数据(图片由作者提供)</p></figure><p id="9870" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以看到一个包含多个 JSON 对象的 JSON 数组，这表明数据已被成功提取。</p><p id="af40" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们如何访问它？这是最棒的部分——air flow 在幕后将数据存储在<a class="ae ky" href="https://betterdatascience.com/apache-airflow-xcoms/" rel="noopener ugc nofollow" target="_blank"> XComs </a>中(<em class="np"> Admin </em> — <em class="np"> XComs </em>):</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/0c25cf92fb5977a6bc595854c11d2e58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FCwU22CqSZOBFGHO7_HSAg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 4 —推送到 XComs 的帖子(图片由作者提供)</p></figure><p id="e16f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这意味着我们现在可以编写另一个任务，使用<code class="fe lv lw lx ly b">PythonOperator</code>以 JSON 格式在本地保存数据。任务和功能代码显示如下:</p><pre class="kj kk kl km gt nf ly ng nh aw ni bi"><span id="6b25" class="nj mj it ly b gy nk nl l nm nn">import json<br/>...</span><span id="63a2" class="nj mj it ly b gy no nl l nm nn">def save_posts(ti) -&gt; None:<br/>    posts = ti.xcom_pull(task_ids=['get_posts'])<br/>    with open('/Users/dradecic/airflow/data/posts.json', 'w') as f:<br/>        json.dump(posts[0], f)<br/>        <br/>        <br/>with DAG(...) as dag:</span><span id="83e9" class="nj mj it ly b gy no nl l nm nn">    # 1. Check if the API is up<br/>    task_is_api_active = HttpSensor(...)</span><span id="8142" class="nj mj it ly b gy no nl l nm nn">    # 2. Get the posts<br/>    task_get_posts = SimpleHttpOperator(...)</span><span id="5ec4" class="nj mj it ly b gy no nl l nm nn">    # 3. Save the posts<br/>    task_save = PythonOperator(<br/>        task_id='save_posts',<br/>        python_callable=save_posts<br/>    )</span></pre><p id="8230" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用以下 shell 命令测试任务:</p><pre class="kj kk kl km gt nf ly ng nh aw ni bi"><span id="093e" class="nj mj it ly b gy nk nl l nm nn">airflow tasks test api_dag save_posts 2022-3-1</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/6112b3a106164f76fa730ff072294628.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fIT57gXPIVPotKigM8M8FQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 5 —测试保存帖子的任务(图片由作者提供)</p></figure><p id="5734" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">看起来一切顺利，这意味着您应该在<code class="fe lv lw lx ly b">data</code>文件夹中看到一个<code class="fe lv lw lx ly b">posts.json</code>文件。以下是它包含的内容:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/9ebbb738a4b8b9d008fe4f65775ae0bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m7bTlAovdxY86HwKqzZErg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 6 —以 JSON 格式保存的帖子(图片由作者提供)</p></figure><p id="c1af" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所有获取的帖子都保存在 JSON 文件中，这意味着我们所有的任务都像广告中说的那样工作。在结束之前，我们先做一个简单的总结。</p></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="cd3f" class="mi mj it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">结论</h1><p id="bc08" class="pw-post-body-paragraph kz la it lb b lc na ju le lf nb jx lh li nc lk ll lm nd lo lp lq ne ls lt lu im bi translated">今天，您已经学习了如何在 Apache Airflow 中与 REST APIs 进行通信。最佳实践是首先检查 API 是否可用，如果不可用，您就不会认为解析逻辑有问题。我将把任务依赖性和通过 Airflow 服务器运行任务的任务留给您。现在你知道如何去做了，它会成为一个很好的练习。</p><p id="ee3a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请继续关注下面的文章，我们将在其中讨论气流和亚马逊 S3 连接。</p><h2 id="8086" class="nj mj it bd mk nu nv dn mo nw nx dp ms li ny nz mu lm oa ob mw lq oc od my oe bi translated">推荐阅读</h2><ul class=""><li id="db20" class="of og it lb b lc na lf nb li oh lm oi lq oj lu ok ol om on bi translated"><a class="ae ky" href="https://betterdatascience.com/best-data-science-prerequisite-books/" rel="noopener ugc nofollow" target="_blank">学习数据科学先决条件(数学、统计和编程)的 5 本最佳书籍</a></li><li id="129f" class="of og it lb b lc oo lf op li oq lm or lq os lu ok ol om on bi translated"><a class="ae ky" href="https://betterdatascience.com/top-books-to-learn-data-science/" rel="noopener ugc nofollow" target="_blank">2022 年学习数据科学的前 5 本书</a></li><li id="1d26" class="of og it lb b lc oo lf op li oq lm or lq os lu ok ol om on bi translated"><a class="ae ky" href="https://betterdatascience.com/apache-airflow-install/" rel="noopener ugc nofollow" target="_blank">如何在本地安装阿帕奇气流</a></li></ul><h2 id="cccd" class="nj mj it bd mk nu nv dn mo nw nx dp ms li ny nz mu lm oa ob mw lq oc od my oe bi translated">保持联系</h2><ul class=""><li id="f989" class="of og it lb b lc na lf nb li oh lm oi lq oj lu ok ol om on bi translated">雇用我作为一名<a class="ae ky" href="https://betterdatascience.com/contact/" rel="noopener ugc nofollow" target="_blank">技术作家</a></li><li id="6837" class="of og it lb b lc oo lf op li oq lm or lq os lu ok ol om on bi translated">在 YouTube<a class="ae ky" href="https://www.youtube.com/c/BetterDataScience" rel="noopener ugc nofollow" target="_blank">上订阅</a></li><li id="692a" class="of og it lb b lc oo lf op li oq lm or lq os lu ok ol om on bi translated">在<a class="ae ky" href="https://www.linkedin.com/in/darioradecic/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上连接</li></ul></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><p id="b640" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="np">喜欢这篇文章吗？成为</em> <a class="ae ky" href="https://medium.com/@radecicdario/membership" rel="noopener"> <em class="np">中等会员</em> </a> <em class="np">继续无限制学习。如果你使用下面的链接，我会收到你的一部分会员费，不需要你额外付费。</em></p><div class="ot ou gp gr ov ow"><a href="https://medium.com/@radecicdario/membership" rel="noopener follow" target="_blank"><div class="ox ab fo"><div class="oy ab oz cl cj pa"><h2 class="bd iu gy z fp pb fr fs pc fu fw is bi translated">通过我的推荐链接加入 Medium-Dario rade ci</h2><div class="pd l"><h3 class="bd b gy z fp pb fr fs pc fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="pe l"><p class="bd b dl z fp pb fr fs pc fu fw dk translated">medium.com</p></div></div><div class="pf l"><div class="pg l ph pi pj pf pk ks ow"/></div></div></a></div></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><p id="edc0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="np">原载于 2022 年 3 月 17 日 https://betterdatascience.com</em><em class="np">T21</em><a class="ae ky" href="https://betterdatascience.com/apache-airflow-rest-api/" rel="noopener ugc nofollow" target="_blank">。</a></p></div></div>    
</body>
</html>