<html>
<head>
<title>Elasticsearch Beats Workshop #4</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Elasticsearch Beats研讨会#4</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/elasticsearch-beats-workshop-4-609bf10ce3e7#2022-04-17">https://towardsdatascience.com/elasticsearch-beats-workshop-4-609bf10ce3e7#2022-04-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="7c8e" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Metricbeat与Filebeat</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/8871bc0efd17f92a32ba8fe66f8fcb14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*T91xU0WRIWkXCDvu"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@umby?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">翁贝托</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="02b3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">欢迎来到Beats工作坊的第四部分。这里可以找到第一家作坊<a class="ae kv" rel="noopener" target="_blank" href="/elasticsearch-beats-workshop-1-c73189069793">。像往常一样，为了使每篇文章尽可能简洁，我将代码简化为片段。如果你想看完整的代码，请查阅我的</a><a class="ae kv" href="https://github.com/PascalThalmann/ElasticBeatWorkshop/tree/master/4_metricbeat_vs_filebeat" rel="noopener ugc nofollow" target="_blank"> GitHub页面。如果谷歌把你带到这里，你可能还会检查</a><a class="ae kv" href="https://medium.com/@pascalth/list/elasticsearch-beats-workshop-fbe5332d03e1" rel="noopener">系列</a>的其他部分。</p><p id="a935" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">今天，我们来看看可能是最流行的节拍:Metricbeat和Filebeat。两者都是Beats家族的成员，都是开源和社区项目，都是用Go编写的。</p><p id="a24b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这次研讨会的技术性将不如其他研讨会。技术方面的东西，比如安装Metric-和Filebeat，将完全放在GitHub repo中。我们将仔细看看这些节拍的预期目的，以及它们如何最好地用于你的项目。</p><p id="30fb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是游戏计划:</p><ul class=""><li id="7018" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">我将在一小段中描述每个节拍</li><li id="c427" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">我将描述测试场景和两个Beats需要达到的目标</li><li id="a543" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">我们将看看在每一拍中需要多少努力才能达到目标</li><li id="12c2" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">我们将看看不同的节拍分配了多少系统资源</li><li id="2cfb" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">我们将经历每一拍的正面和负面</li><li id="c06b" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">在结论中，我将描述，什么时候顶用哪个节拍</li></ul><p id="32ef" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">话虽如此，我们还是开始吧！</p></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="5bd3" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">关于度量的一些话</h1><p id="e563" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">此时，我需要澄清Metricbeat中的度量是什么。指标是从Metricbeat到Elasticsearch以固定间隔报告的值。这些值可以是各种类型的，从长整型到布尔型，甚至是字符串。重要的是要知道Metricbeat不是由一个事件触发的，而是由一个定义的间隔触发的—例如，每5秒。即使在创建指标时没有发生任何事情，Metricbeat也会发送一份报告。在这种情况下，度量将是一个空字符串、零、假或任何定义为“什么都没有发生”的值。如果发生了一些事情，例如，CPU 1以75%的负载运行，那么CPU 1的指标可能是0.75。</p><h1 id="028c" class="mn mo iq bd mp mq nk ms mt mu nl mw mx jw nm jx mz jz nn ka nb kc no kd nd ne bi translated">Metricbeat的简要描述</h1><p id="93af" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">Metricbeat自带许多模块，适用于最常用的应用。Nginx、Mysql、MongoDB、Prometheus和许多其他软件在基本安装中都有一个模块，可以轻松配置。然而:如果您的应用程序或您的度量标准不是基本安装的一部分，您需要额外的努力。最好的情况是，在Metricbeat GitHub repo中找到所需的模块，然后设置开发环境，并用新模块编译Metricbeat。如何做到这一点在我的第二次研讨会中有所描述。但是在大多数情况下，你可能需要编写你的模块和矩阵集。为此，你至少需要对围棋有一个基本的了解，你甚至可能会雇佣一名围棋开发者，或者让一家<a class="ae kv" href="https://cdax.ch/about-cdax-gmbh/" rel="noopener ugc nofollow" target="_blank">专业公司</a>为你开发这个模块。</p><h1 id="6915" class="mn mo iq bd mp mq nk ms mt mu nl mw mx jw nm jx mz jz nn ka nb kc no kd nd ne bi translated">关于日志的几句话</h1><p id="bef1" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">此时，我需要澄清一下Filebeat的日志是什么:它是一个由事件提供的文件。事件可以是应用程序崩溃、用户登录或其他足以写入记录的重要事件。当然，守护程序可以定期发送应用程序的统计数据(这将与指标的定义相匹配),并每5秒钟将测量结果记录到日志文件中。但是如果这个守护进程停止了，并且没有向日志文件发送任何数据，那么对于Filebeat来说，没有事件发生，因此不会向Elasticsearch发送任何数据。或者简而言之，Filebeat并不关心记录是以间隔存储还是完全任意存储:只要有新记录出现，它就会拾取它们。</p><p id="b3ab" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">日志记录通常带有时间戳。虽然没有时间戳的日志条目几乎没有意义，但是即使没有时间戳，Filebeat也会发送拾取的记录。每条记录都有一个自动添加的字段@timestamp，它表示Filebeat选择记录时的时间戳。</p><h1 id="491b" class="mn mo iq bd mp mq nk ms mt mu nl mw mx jw nm jx mz jz nn ka nb kc no kd nd ne bi translated">Filebeat的简要描述</h1><p id="4fd4" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">Filebeat，顾名思义，是一个跟踪日志文件并将新记录发送到Elasticsearch集群或Logstash的beat。如果Filebeat停止了——可能是因为升级——那么只要Filebeat再次运行，它就会从最后一个位置继续跟踪日志文件。内存机制保证了随时重启的能力，而不会丢失数据或发送副本。这使得Filebeat成为跟踪和分析日志的一个非常健壮的工具。</p><p id="4153" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Filebeat 8.1.0自带71个模块。它附带了用于本地存储日志(如Log、Syslog、filestream和journald)的模块，但也支持网络协议和端点(如TCP、UDP、Kafka、MQTT和Google Workspace)。</p><p id="9286" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Filebeat具有非常灵活的给定模块。它可以配置为任何类型的输入，基于文件或通过网络地址。添加新字段可以通过在配置文件中定义它们来完成。但它不止于此:Filebeat配备了许多处理器。在将数据发送到Elasticsearch之前，可以使用它们来转换数据。Logstash中的许多处理器都在Filebeat中实现，减少了Logstash或Elasticsearch集群上所需的处理。</p><p id="cfc1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后但同样重要的是:如果需要，Filebeat还配有手刹。它可以防止您的摄取管道过载。背压敏感协议与Elasticsearch或Logstash对话，并在需要时减慢Filebeat。</p><h1 id="eb14" class="mn mo iq bd mp mq nk ms mt mu nl mw mx jw nm jx mz jz nn ka nb kc no kd nd ne bi translated">测试场景</h1><p id="1bf6" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">在我们的简单场景中，我们监控文件filebeat.log的修改时间。目标是每10秒发送一个包含filebeat.log的最新修改日期的报告。该报告如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/637c73f2ce24e798824368ab15c79e27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*G9WAowIvWRSPzSPn.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">一个示例文档——按作者排序的图像</p></figure><h1 id="b81d" class="mn mo iq bd mp mq nk ms mt mu nl mw mx jw nm jx mz jz nn ka nb kc no kd nd ne bi translated">使用Metricbeat向Elasticsearch发送指标</h1><p id="64c4" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">作为Metricbeat模块，我将使用我们在<a class="ae kv" href="https://cdax.ch/2022/04/09/elasticsearch-beats-workshop-3-a-more-sophisticated-configuration-for-your-metricset/" rel="noopener ugc nofollow" target="_blank"> workshop 3 </a>中创建的模块。它有一点额外的计算，但没有什么会有任何不同。</p><h1 id="41df" class="mn mo iq bd mp mq nk ms mt mu nl mw mx jw nm jx mz jz nn ka nb kc no kd nd ne bi translated">使用Filebeat向Elasticsearch发送指标</h1><p id="e155" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">由于Filebeat从日志中读取事件，因此该任务需要两个步骤:一个简单的shell脚本——称为Filebeat _ logger . sh——每隔10秒从filebeat.log中读取修改时间，并将其写入自身。以及跟踪日志文件并将事件发送给Elasticsearch的Filebeat实例。</p><h1 id="1e9d" class="mn mo iq bd mp mq nk ms mt mu nl mw mx jw nm jx mz jz nn ka nb kc no kd nd ne bi translated">Filebeat的简单配置</h1><p id="26d3" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">我将使用Filebeat的一个非常基本的配置:</p><pre class="kg kh ki kj gt nq nr ns nt aw nu bi"><span id="359f" class="nv mo iq nr b gy nw nx l ny nz">filebeat.inputs:<br/>- type: log<br/>  enabled: true<br/>  paths:<br/>    - /logs/filebeat.log<br/>  exclude_lines: ["^\"\""]<br/>  processors:<br/>  - decode_csv_fields:<br/>      fields:<br/>        message: decoded.csv<br/>      separator: ","<br/>  - extract_array:<br/>        field: decoded.csv<br/>        mappings:<br/>          timestamp: 0<br/>          file_name: 1<br/>          mod_time: 2<br/>  - drop_fields:<br/>        fields: ["decoded"]</span></pre><h1 id="384f" class="mn mo iq bd mp mq nk ms mt mu nl mw mx jw nm jx mz jz nn ka nb kc no kd nd ne bi translated">性能比较</h1><p id="8bc3" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">我们来看看Filebeat的内存和CPU消耗:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/276de02a9457e40a1346f67eb581de29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*NjDSxXUPrOfTrB87.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><em class="ob">超过10分钟的Filebeat CPU和实际内存使用情况——图片由作者提供</em></p></figure><p id="da0c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Filebeat使用120MB内存。CPU仅在非常短的峰值中使用。10%的峰值占大多数，也有3个峰值达到20% —在10分钟内。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/afe381166b488efaec2c24ee5110878e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*xjfqG6uzB_xQp50w.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><em class="ob"> filebeat_logger.sh超过10分钟的CPU和实际内存使用情况——图片由作者提供</em></p></figure><p id="64be" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">记录器需要大约3MB的内存，并且这里那里有一些奇怪的尖峰。我不清楚为什么，但我也没有进一步研究它。sh是一个Bash脚本，出于性能原因，我不建议使用Bash来编写守护进程。对于这个例子，这无关紧要，因为这只是一个测试。</p><p id="354b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Metricbeat只需要60MB内存，是Filebeat所需内存的一半。有趣的是，它和Filebeat有相同的CPU峰值。可以说，Metricbeat消耗的CPU和Filebeat一样多。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/b847374d4399564978e3aa5d6ff57b52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*2xpV7XT8jWa5QQ4w.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><em class="ob">超过10分钟的CPU和实际内存使用度量——图片由作者提供</em></p></figure><h1 id="076c" class="mn mo iq bd mp mq nk ms mt mu nl mw mx jw nm jx mz jz nn ka nb kc no kd nd ne bi translated">Filebeat的优缺点</h1><p id="def0" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">Filebeat的巨大优势是它的灵活性:几乎没有限制。如果对磁盘的I/O是一个问题，Filebeat可以从网络地址读取。有了处理器，Filebeat提供了一个非常强大的工具来转换数据，并在摄取之前丰富它们。通过对背压敏感的协议，Filebeat实现了一种安全机制，可以防止集群过载。而且Filebeat不会丢失一条日志记录，即使Filebeat暂时没有运行。</p><p id="ca81" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后但同样重要的一点是:如果出现问题，您可以在本地保存日志文件。这可能是一种祝福，也可能是一种诅咒。如果您的Elasticsearch集群无法访问，您可以使用grep和其他工具来分析您的日志。另一方面，您需要管理您的日志。</p><p id="d538" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而:Filebeat是事件驱动的。如果logger守护进程停止了，没有新的数据进来，Filebeat不会在意。记录器守护进程将增加CPU和内存消耗。如果资源很少或者logger守护进程触发了大量的请求，那么您可能希望用Go、C++或者至少Perl或Python编写守护进程，而不是Bash。</p><h1 id="003f" class="mn mo iq bd mp mq nk ms mt mu nl mw mx jw nm jx mz jz nn ka nb kc no kd nd ne bi translated">Metricbeat的优缺点</h1><p id="5785" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">Metricbeat的优势似乎很明显:它只需要Filebeat一半的内存。Metricbeat将每10秒向Elasticsearch发送一份报告，即使什么也没发生。有了Go中的知识，就可以创建内存占用非常少并且几乎有无限可能的托运人。</p><p id="1ef5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">缺点是Metricbeat模块和metricsets高度专门化，具有特定的字段和数据类型。您可能能够创建某种通用模块，但是灵活性不是Metricbeat的优势，并且在某一点上，您将被迫为其他类型的指标创建另一个模块或metricset这将带来一个价格标签，它肯定比使用将数据发送到Filebeat或Logstash的自行编写的守护程序进行测量要高。</p></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="703d" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">结论</h1><p id="f25f" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">只要您对Metricbeat 8.1.2提供的73个模块满意，您就拥有了一个监视最流行的应用程序的好工具。到目前为止，我遇到的模块配置起来非常简单。通常，每个模块都有Kibana仪表板。</p><p id="6083" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您的物联网设备内存和存储有限，应该运行数量严格受限的进程，并且指标是预先定义的，那么定制指标集可能是正确的选择。</p><p id="959c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">另一方面，Filebeat与logger守护程序相结合，为您提供了很大的灵活性，并且能够非常容易地扩展您的监控框架。Filebeat仍然是一个事件驱动的工具，但是您的记录器确保事件基于记录的指标。这在不断出现新的监控需求的动态环境中非常有用。</p><p id="e6b3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以最后，这真的取决于，你的重点在哪里。灵活性与性能。在一个交付时间至关重要的世界里，当谈到标准安装之外的指标时，我在大多数情况下会选择Filebeat。</p></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><p id="1507" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="oc">最初发布于</em><a class="ae kv" href="https://cdax.ch/2022/04/17/elasticsearch-beats-workshop-4-metricbeat-versus-filebeat/" rel="noopener ugc nofollow" target="_blank"><em class="oc">https://cdax . ch</em></a><em class="oc">。</em></p></div></div>    
</body>
</html>