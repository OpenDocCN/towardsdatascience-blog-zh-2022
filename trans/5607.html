<html>
<head>
<title>Train YOLO for Object Detection on a Custom Dataset using Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Python 训练 YOLO 在自定义数据集上进行对象检测</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/train-yolo-for-object-detection-on-a-custom-dataset-using-python-e4fe5eb94673#2022-12-19">https://towardsdatascience.com/train-yolo-for-object-detection-on-a-custom-dataset-using-python-e4fe5eb94673#2022-12-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/083e4a2b52bebf3de78ad53a243d00c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gqIag9YypCanQJhLTzt3gg.jpeg"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">非洲的野生马赛洛(图片由作者提供)</p></figure><div class=""/><div class=""><h2 id="3903" class="pw-subtitle-paragraph kc je jf bd b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dk translated">了解 Yolov4 和 Darknet 来训练自定义对象检测器</h2></div><h2 id="3737" class="ku kv jf bd kw kx ky dn kz la lb dp lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">介绍</h2><p id="5138" class="pw-post-body-paragraph lq lr jf ls b lt lu kg lv lw lx kj ly ld lz ma mb lh mc md me ll mf mg mh mi ij bi translated">我最近开始从事计算机视觉领域的工作。在这些早期，我正在研究物体检测的各种算法如何工作。其中最知名的有<strong class="ls jg"> R-CNN </strong>、<strong class="ls jg">快 R-CNN </strong>、<strong class="ls jg">快 R-CNN </strong>当然还有<strong class="ls jg"> YOLO </strong>。</p><p id="567a" class="pw-post-body-paragraph lq lr jf ls b lt mj kg lv lw mk kj ly ld ml ma mb lh mm md me ll mn mg mh mi ij bi translated">在本文中，我想重点讨论最后提到的算法。YOLO 是物体探测领域的尖端技术，YOLO 有无数的应用案例。然而，今天我不想告诉你 YOLO 是如何工作的，也不想告诉你它的架构，但是我想简单地向你展示如何启动这个算法，并做出你的预测。此外，我们还将了解如何在自定义数据集上对其进行<strong class="ls jg">训练，从而使其适应您的数据。如果你也想看我写的一篇关于 YOLO 内部运作的文章，请跟我来，因为我打算在未来几天内写这篇文章。</strong></p><h2 id="3579" class="ku kv jf bd kw kx ky dn kz la lb dp lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">黑暗网络</h2><p id="609d" class="pw-post-body-paragraph lq lr jf ls b lt lu kg lv lw lx kj ly ld lz ma mb lh mc md me ll mf mg mh mi ij bi translated">我不认为有比你在他们的网站上找到的定义更好的方式来描述 Darknet。</p><blockquote class="mp mq mr"><p id="b324" class="lq lr ms ls b lt mj kg lv lw mk kj ly mt ml ma mb mu mm md me mv mn mg mh mi ij bi translated">Darknet 是用 C 和 CUDA 编写的开源神经网络框架。速度快，安装方便，支持 CPU 和 GPU <br/>计算。你可以在 GitHub 上找到源代码，或者你可以在这里阅读更多关于 Darknet 可以做什么的内容。</p></blockquote><p id="ce18" class="pw-post-body-paragraph lq lr jf ls b lt mj kg lv lw mk kj ly ld ml ma mb lh mm md me ll mn mg mh mi ij bi translated">所以我们要做的就是学习如何使用这个开源项目。</p><p id="6fce" class="pw-post-body-paragraph lq lr jf ls b lt mj kg lv lw mk kj ly ld ml ma mb lh mm md me ll mn mg mh mi ij bi translated">你可以在 github 上找到暗网代码。看一看它，因为我们将使用它在我们的自定义数据集上训练 YOLO。</p><h2 id="51df" class="ku kv jf bd kw kx ky dn kz la lb dp lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">克隆暗网</h2><p id="e9a1" class="pw-post-body-paragraph lq lr jf ls b lt lu kg lv lw lx kj ly ld lz ma mb lh mc md me ll mf mg mh mi ij bi translated">我将在下面这篇文章中展示的代码是要在 Colab 上运行的，因为我没有带 GPU 当然你也可以在笔记本上重复这段代码。偶尔会改变的是路径。</p><p id="bef2" class="pw-post-body-paragraph lq lr jf ls b lt mj kg lv lw mk kj ly ld ml ma mb lh mm md me ll mn mg mh mi ij bi translated">所以首先我们去克隆 darknet GitHub 库。如果我们使用<strong class="ls jg"> <em class="ms"> %%bash </em> </strong> <em class="ms">命令，Colab 允许我们编写 bash 命令。</em></p><pre class="mw mx my mz gt na nb nc bn nd ne bi"><span id="ec61" class="nf kv jf nb b be ng nh l ni nj">%%bash<br/>git clone https://github.com/AlexeyAB/darknet</span></pre><p id="d982" class="pw-post-body-paragraph lq lr jf ls b lt mj kg lv lw mk kj ly ld ml ma mb lh mm md me ll mn mg mh mi ij bi translated">一旦你克隆了 repo，你会在你的工作目录中看到很多文件，放松，它看起来比实际上更复杂。<br/>现在我们需要<strong class="ls jg">重新配置 makefile </strong>。不知道 makefile 是什么？简而言之，它是一个使你的代码编译变得容易的文件。</p><p id="93fc" class="pw-post-body-paragraph lq lr jf ls b lt mj kg lv lw mk kj ly ld ml ma mb lh mm md me ll mn mg mh mi ij bi translated">如果你曾经用 C 语言编写过代码，你会知道实际的做法是写一个文件<em class="ms"> file.c </em>，然后你用一个命令来编译它，比如<em class="ms"> g++ etc… </em> <br/>这个命令用来编译在大型项目中可能会很长，因为它必须考虑依赖关系等等。</p><p id="0614" class="pw-post-body-paragraph lq lr jf ls b lt mj kg lv lw mk kj ly ld ml ma mb lh mm md me ll mn mg mh mi ij bi translated">因此，每次通过重写<em class="ms"> g++ etc… </em> <br/>进行编译都会非常费力，然后我们要做的是创建一个 makefile，其中已经包含了这个写好的命令，我们要做的就是<strong class="ls jg">启动 makefile 来编译代码</strong>。<br/><strong class="ls jg">makefile 通常包含用户可以根据需要设置的配置变量</strong>。</p><p id="a812" class="pw-post-body-paragraph lq lr jf ls b lt mj kg lv lw mk kj ly ld ml ma mb lh mm md me ll mn mg mh mi ij bi translated">也就是说，我们要做的是设置一些在暗网 makefile 中找到的变量。<br/>因此，请确保您有可用的 GPU，并运行以下单元。</p><pre class="mw mx my mz gt na nb nc bn nd ne bi"><span id="ec54" class="nf kv jf nb b be ng nh l ni nj">%%bash<br/>cd darknet<br/>sed -i 's/OPENCV=0/OPENCV=1/' Makefile<br/># In case you dont have a GPU, make sure to comment out the<br/># below 3 lines<br/>sed -i 's/GPU=0/GPU=1/' Makefile<br/>sed -i 's/CUDNN=0/CUDNN=1/' Makefile<br/>sed -i 's/CUDNN_HALF=0/CUDNN_HALF=1/' Makefile</span></pre><p id="3650" class="pw-post-body-paragraph lq lr jf ls b lt mj kg lv lw mk kj ly ld ml ma mb lh mm md me ll mn mg mh mi ij bi translated">在这个单元中，例如第一行中的命令<em class="ms"> sed -i </em>允许您将 OPENCV 变量从 0 更改为 1。</p><p id="c2bf" class="pw-post-body-paragraph lq lr jf ls b lt mj kg lv lw mk kj ly ld ml ma mb lh mm md me ll mn mg mh mi ij bi translated">我们在前一个单元格中设置的设置允许我们在 GPU 而不是 CPU 上启动 YOLO。<br/>现在我们将使用 make 命令启动 makefile。</p><pre class="mw mx my mz gt na nb nc bn nd ne bi"><span id="fadd" class="nf kv jf nb b be ng nh l ni nj">%%bash<br/>#compile darkent source code<br/>cd darknet</span></pre><p id="5b59" class="pw-post-body-paragraph lq lr jf ls b lt mj kg lv lw mk kj ly ld ml ma mb lh mm md me ll mn mg mh mi ij bi translated">现在我们安装了一个库，它将在 YOLO 探测到的物体周围绘制边界框。</p><pre class="mw mx my mz gt na nb nc bn nd ne bi"><span id="21f2" class="nf kv jf nb b be ng nh l ni nj">%%capture<br/>!pip install -q torch_snippets</span></pre><h2 id="88ad" class="ku kv jf bd kw kx ky dn kz la lb dp lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">下载数据集</h2><p id="c029" class="pw-post-body-paragraph lq lr jf ls b lt lu kg lv lw lx kj ly ld lz ma mb lh mc md me ll mf mg mh mi ij bi translated">我将使用包含卡车和公共汽车图像的对象检测数据集。Kaggle 上有很多物体检测数据集，你可以从那里下载一个。</p><p id="68f5" class="pw-post-body-paragraph lq lr jf ls b lt mj kg lv lw mk kj ly ld ml ma mb lh mm md me ll mn mg mh mi ij bi translated">如果你不知道如何直接从 Colab 下载 Kaggle 数据集，你可以去看看我以前的一些文章。</p><p id="dce3" class="pw-post-body-paragraph lq lr jf ls b lt mj kg lv lw mk kj ly ld ml ma mb lh mm md me ll mn mg mh mi ij bi translated">所以我下载并解压数据集。</p><pre class="mw mx my mz gt na nb nc bn nd ne bi"><span id="82eb" class="nf kv jf nb b be ng nh l ni nj">!wget - quiet link_to_dataset<br/>!tar -xf open-images-bus-trucks.tar.xz<br/>!rm open-images-bus-trucks.tar.xz</span></pre><p id="0fe3" class="pw-post-body-paragraph lq lr jf ls b lt mj kg lv lw mk kj ly ld ml ma mb lh mm md me ll mn mg mh mi ij bi translated">下图描述了下载的数据集的结构。</p><figure class="mw mx my mz gt is gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/8b15ca95f474d319500f6e227b8ee2dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:688/format:webp/1*Wk8PbW8Zcq0sFo39G1_m9w.png"/></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">作者图片</p></figure><h2 id="5af0" class="ku kv jf bd kw kx ky dn kz la lb dp lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">下载 YOLO</h2><p id="2298" class="pw-post-body-paragraph lq lr jf ls b lt lu kg lv lw lx kj ly ld lz ma mb lh mc md me ll mf mg mh mi ij bi translated">显然，你不必从头开始做 YOLO 训练，而是直接从网上下载重量。<br/>使用以下命令从<strong class="ls jg"> YOLO4 </strong>下载权重。</p><pre class="mw mx my mz gt na nb nc bn nd ne bi"><span id="3619" class="nf kv jf nb b be ng nh l ni nj">!wget - quiet https://github.com/AlexeyAB/darknet/releases/download/darknet_yolo_v3_optimal/yolov4.weights</span></pre><p id="d46c" class="pw-post-body-paragraph lq lr jf ls b lt mj kg lv lw mk kj ly ld ml ma mb lh mm md me ll mn mg mh mi ij bi translated">要查看一切是否正常，请运行以下命令。</p><pre class="mw mx my mz gt na nb nc bn nd ne bi"><span id="2033" class="nf kv jf nb b be ng nh l ni nj">%%bash<br/>#I had to use the flag -dont_show cause wasnt working. Try to run wiithout it<br/>cd darknet<br/>./darknet detector test cfg/coco.data cfg/yolov4.cfg ../yolov4.weights data/person.jpg -dont_show</span></pre><p id="4d4c" class="pw-post-body-paragraph lq lr jf ls b lt mj kg lv lw mk kj ly ld ml ma mb lh mm md me ll mn mg mh mi ij bi translated">在这个命令中，我们刚刚运行了</p><ul class=""><li id="a960" class="nl nm jf ls b lt mj lw mk ld nn lh no ll np mi nq nr ns nt bi translated">我们指定我们想要 YOLO4: <em class="ms"> cfg/yolov4.cfg </em>的配置</li><li id="60db" class="nl nm jf ls b lt nu lw nv ld nw lh nx ll ny mi nq nr ns nt bi translated">我们指定使用刚刚下载的权重:<em class="ms">../yolov4.weights </em></li><li id="4910" class="nl nm jf ls b lt nu lw nv ld nw lh nx ll ny mi nq nr ns nt bi translated">我们将对克隆了回购协议后获得的 coco 数据集进行预测:<em class="ms"> cfg/coco.data </em></li><li id="786a" class="nl nm jf ls b lt nu lw nv ld nw lh nx ll ny mi nq nr ns nt bi translated">而我们做的预测如下图:<em class="ms"> data/person.jpg </em></li></ul><h2 id="1e5a" class="ku kv jf bd kw kx ky dn kz la lb dp lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">准备数据集</h2><p id="4b8d" class="pw-post-body-paragraph lq lr jf ls b lt lu kg lv lw lx kj ly ld lz ma mb lh mc md me ll mf mg mh mi ij bi translated">YOLO 希望找到正确设置的某些文件和文件夹，以便在您的自定义数据集上进行训练。<br/>首先，你需要在<em class="ms"> darknet/data/obj.names </em>路径中打开你写标签的文件。<br/>在 Colab 中，我们可以使用<strong class="ls jg">魔法命令</strong>通过单元格直接写入文件。magic 命令下的所有东西都会被复制<br/>到指定的文件中。</p><pre class="mw mx my mz gt na nb nc bn nd ne bi"><span id="b0cf" class="nf kv jf nb b be ng nh l ni nj">%%writefile darknet/data/obj.names<br/>bus<br/>truck</span></pre><p id="a107" class="pw-post-body-paragraph lq lr jf ls b lt mj kg lv lw mk kj ly ld ml ma mb lh mm md me ll mn mg mh mi ij bi translated">现在我们需要修改另一个文件来告诉 YOLO 需要多少个类，在哪里可以找到训练和<br/>验证的路径，以及在哪里可以找到带有标签名称的文件。我们可以简单地使用 magic 命令和下面几行代码来完成。</p><pre class="mw mx my mz gt na nb nc bn nd ne bi"><span id="222c" class="nf kv jf nb b be ng nh l ni nj">%%writefile darknet/data/obj.data<br/>classes = 2<br/>train = darknet/data/train.txt<br/>valid = darknet/data/val.txt<br/>names = darknet/data/obj.names<br/>backup = backup/</span></pre><p id="8adb" class="pw-post-body-paragraph lq lr jf ls b lt mj kg lv lw mk kj ly ld ml ma mb lh mm md me ll mn mg mh mi ij bi translated">所以为了理解它，你的 train txt 文件应该看起来像你在下图中看到的那样(类似于验证)。</p><figure class="mw mx my mz gt is gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/a41ba968587a21a5da2b9fe1a4aa8f87.png" data-original-src="https://miro.medium.com/v2/resize:fit:602/format:webp/1*m6SmVSb6PtQ2M9wRuUEzNA.png"/></div></figure><p id="276f" class="pw-post-body-paragraph lq lr jf ls b lt mj kg lv lw mk kj ly ld ml ma mb lh mm md me ll mn mg mh mi ij bi translated">其中每行指示在哪里找到训练图像。</p><p id="d75d" class="pw-post-body-paragraph lq lr jf ls b lt mj kg lv lw mk kj ly ld ml ma mb lh mm md me ll mn mg mh mi ij bi translated">但是我们指定的文件仍然是空的。因此，我们将下载的数据集文件夹中的数据复制到 Darknet 中的默认文件夹中。</p><pre class="mw mx my mz gt na nb nc bn nd ne bi"><span id="db91" class="nf kv jf nb b be ng nh l ni nj">!mkdir -p darknet/data/obj<br/>!cp -r open-images-bus-trucks/images/* darknet/data/obj/<br/>!cp -r open-images-bus-trucks/yolo_labels/all/{train,val}.txt darknet/data/<br/>!cp -r open-images-bus-trucks/yolo_labels/all/labels/*.txt darknet/data/obj/<br/>#add prefix 'darkent/' in front of each row in darkent/data/train.txt<br/>!sed -i -e 's/^/darknet\//' darknet/data/train.txt<br/>!sed -i -e 's/^/darknet\//' darknet/data/val.txt</span></pre><p id="bf05" class="pw-post-body-paragraph lq lr jf ls b lt mj kg lv lw mk kj ly ld ml ma mb lh mm md me ll mn mg mh mi ij bi translated">就像我们之前下载 YOLO 的权重一样。这次我们拿<strong class="ls jg"> <em class="ms"> yolov4-tiny </em> </strong>比之前的快。<br/>然后我们将权重复制到 Darknet 中适当的文件夹。</p><pre class="mw mx my mz gt na nb nc bn nd ne bi"><span id="cb71" class="nf kv jf nb b be ng nh l ni nj">!wget - quiet https://github.com/AlexeyAB/darknet/releases/download/darknet_yolo_v4_pre/yolov4-tiny.conv.29<br/>!cp yolov4-tiny.conv.29 darknet/build/darknet/x64/</span></pre><p id="90e9" class="pw-post-body-paragraph lq lr jf ls b lt mj kg lv lw mk kj ly ld ml ma mb lh mm md me ll mn mg mh mi ij bi translated">现在让我们重命名负责配置<em class="ms"> yolov4 tiny </em>架构的配置文件。<br/>之后，我们将编辑一些参数来设置批次数量、类别数量和其他参数。</p><pre class="mw mx my mz gt na nb nc bn nd ne bi"><span id="d14f" class="nf kv jf nb b be ng nh l ni nj">%%bash<br/>cd darknet<br/># create a copy of existing configuration and modify it in place<br/>cp cfg/yolov4-tiny-custom.cfg cfg/yolov4-tiny-bus-trucks.cfg<br/># max_batches to 4000 (since the dataset is small enough)<br/>sed -i 's/max_batches = 500200/max_batches=4000/' cfg/yolov4-tiny-bus-trucks.cfg<br/># number of sub-batches per batch<br/>sed -i 's/subdivisions=1/subdivisions=16/' cfg/yolov4-tiny-bus-trucks.cfg<br/># number of batches after which learning rate is decayed<br/>sed -i 's/steps=400000,450000/steps=3200,3600/' cfg/yolov4-tiny-bus-trucks.cfg<br/># number of classes is 2 as opposed to 80<br/># (which is the number of COCO classes)<br/>sed -i 's/classes=80/classes=2/g' cfg/yolov4-tiny-bus-trucks.cfg<br/># in the classification and regression heads,<br/># change number of output convolution filters<br/># from 255 -&gt; 21 and 57 -&gt; 33, since we have fewer classes<br/># we don't need as many filters<br/>sed -i 's/filters=255/filters=21/g' cfg/yolov4-tiny-bus-trucks.cfg<br/>sed -i 's/filters=57/filters=33/g' cfg/yolov4-tiny-bus-trucks.cfg</span></pre><h2 id="68b5" class="ku kv jf bd kw kx ky dn kz la lb dp lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">训练模型！</h2><p id="9821" class="pw-post-body-paragraph lq lr jf ls b lt lu kg lv lw lx kj ly ld lz ma mb lh mc md me ll mf mg mh mi ij bi translated">现在我们准备好了，剩下的就是启动模型火车了</p><pre class="mw mx my mz gt na nb nc bn nd ne bi"><span id="d408" class="nf kv jf nb b be ng nh l ni nj">!./darknet/darknet detector train darknet/data/obj.data ./darknet/cfg/yolov4-tiny-bus-trucks.cfg yolov4-tiny.conv.29 -dont_show -mapLastAt</span></pre><p id="0e98" class="pw-post-body-paragraph lq lr jf ls b lt mj kg lv lw mk kj ly ld ml ma mb lh mm md me ll mn mg mh mi ij bi translated">对我来说，这个训练花了大约一个小时。<br/>现在你可以在你的图像上运行预测来得到类和边界框。</p><pre class="mw mx my mz gt na nb nc bn nd ne bi"><span id="0d27" class="nf kv jf nb b be ng nh l ni nj">from torch_snippets import Glob, stem, show, read<br/># upload your own images to a folder<br/>image_paths = Glob('images-of-trucks-and-busses')<br/>for f in image_paths:<br/> !./darknet detector test \<br/> data/obj.data cfg/yolov4-tiny-bus-trucks.cfg\<br/> backup/yolov4-tiny-bus-trucks_4000.weights {f}<br/> !mv predictions.jpg {stem(f)}_pred.jpg<br/>for i in Glob('*_pred.jpg'):<br/> show(read(i, 1), sz=20)</span></pre><figure class="mw mx my mz gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oa"><img src="../Images/390e27b48da6f3b6b7b0d348a2bc7628.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A-sUpcgRMDnVKT9tl_vBiA.png"/></div></div></figure><h1 id="0293" class="ob kv jf bd kw oc od oe kz of og oh lc kl oi km lg ko oj kp lk kr ok ks lo ol bi translated">最后的想法</h1><p id="fe7b" class="pw-post-body-paragraph lq lr jf ls b lt lu kg lv lw lx kj ly ld lz ma mb lh mc md me ll mf mg mh mi ij bi translated">正如我们所见，使用 YOLO 并不复杂。我们可以克隆一些高效的实现，并将其用于我们的用例。就我而言，我只是用它来对我今年夏天去非洲旅行时拍的一些照片进行预测，以此取乐。😁</p><p id="4a9e" class="pw-post-body-paragraph lq lr jf ls b lt mj kg lv lw mk kj ly ld ml ma mb lh mm md me ll mn mg mh mi ij bi translated">我还没有详细介绍这个算法是如何工作的，因为我想在以后的文章中使用自顶向下的方法来详细介绍。所以我希望你现在也能像我一样使用 YOLO 和玩它！</p><h1 id="33e0" class="ob kv jf bd kw oc od oe kz of og oh lc kl oi km lg ko oj kp lk kr ok ks lo ol bi translated">结束了</h1><p id="3120" class="pw-post-body-paragraph lq lr jf ls b lt lu kg lv lw lx kj ly ld lz ma mb lh mc md me ll mf mg mh mi ij bi translated"><em class="ms">马赛洛·波利蒂</em></p><p id="eb91" class="pw-post-body-paragraph lq lr jf ls b lt mj kg lv lw mk kj ly ld ml ma mb lh mm md me ll mn mg mh mi ij bi translated"><a class="ae mo" href="https://www.linkedin.com/in/marcello-politi/" rel="noopener ugc nofollow" target="_blank"> Linkedin </a>，<a class="ae mo" href="https://twitter.com/_March08_" rel="noopener ugc nofollow" target="_blank"> Twitter </a>，<a class="ae mo" href="https://march-08.github.io/digital-cv/" rel="noopener ugc nofollow" target="_blank"> CV </a></p></div></div>    
</body>
</html>