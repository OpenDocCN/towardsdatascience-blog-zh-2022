<html>
<head>
<title>Using Airflow Decorators to Author DAGs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用气流装饰器创作Dag</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/airflow-dags-decorators-b5dc03c76f07#2022-06-21">https://towardsdatascience.com/airflow-dags-decorators-b5dc03c76f07#2022-06-21</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="763b" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">用Python decorators创作Apache Airflow DAGs和任务</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/09010d401053cd21056d20cad6e95274.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fiEi7w5zMp9s378X7i4l_A.jpeg"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">由<a class="ae kz" href="https://unsplash.com/@tvschaitanya?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">柴坦尼亚电视台</a>在<a class="ae kz" href="https://unsplash.com/s/photos/circle?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><h2 id="1a1f" class="la lb iu bd lc ld le dn lf lg lh dp li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">介绍</h2><p id="3f42" class="pw-post-body-paragraph lw lx iu ly b lz ma jv mb mc md jy me lj mf mg mh ln mi mj mk lr ml mm mn mo in bi translated">在气流中编写管道的最常见方式是使用DAG上下文管理器自动为该DAG分配新的运算符。从Airflow 2开始，您现在可以使用decorators来创作Airflow DAGs和任务。</p><p id="eb12" class="pw-post-body-paragraph lw lx iu ly b lz mp jv mb mc mq jy me lj mr mg mh ln ms mj mk lr mt mm mn mo in bi translated">在今天的教程中，我们将介绍这些装饰器，并展示如何使用它们来编写更简洁的代码。此外，我们还将演示如何使用更传统的方法编写相同的DAG。</p></div><div class="ab cl mu mv hy mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="in io ip iq ir"><h2 id="2148" class="la lb iu bd lc ld le dn lf lg lh dp li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">传统的方式</h2><p id="5f24" class="pw-post-body-paragraph lw lx iu ly b lz ma jv mb mc md jy me lj mf mg mh ln mi mj mk lr ml mm mn mo in bi translated">在Airflow中创作数据管道最常用的方法是使用DAG作为上下文管理器，自动为该DAG分配新的操作符。</p><p id="cd93" class="pw-post-body-paragraph lw lx iu ly b lz mp jv mb mc mq jy me lj mr mg mh ln ms mj mk lr mt mm mn mo in bi translated">例如，假设我们想要构建一个ETL管道，在这个管道中，我们将从外部API获取一些数据，对其进行转换，并最终将结果报告为标准输出。</p><p id="4f2d" class="pw-post-body-paragraph lw lx iu ly b lz mp jv mb mc mq jy me lj mr mg mh ln ms mj mk lr mt mm mn mo in bi translated">为此，我们将创建三个简单的任务，如下所示。</p><pre class="kk kl km kn gu nb nc nd ne aw nf bi"><span id="2766" class="la lb iu nc b gz ng nh l ni nj">import logging<br/>import requests<br/>from datetime import timedelta</span><span id="051f" class="la lb iu nc b gz nk nh l ni nj">from airflow import DAG<br/>from airflow.utils.dates import days_ago<br/>from airflow.operators.python_operator import PythonOperator<br/></span><span id="3b7c" class="la lb iu nc b gz nk nh l ni nj">ENDPOINT = 'https://some-api.com/data'</span><span id="fb23" class="la lb iu nc b gz nk nh l ni nj">default_args = {<br/>    'owner': 'airflow',<br/>    'retries': 1,<br/>    'retry_delay': timedelta(minutes=5),<br/>}</span><span id="0b85" class="la lb iu nc b gz nk nh l ni nj">def _extract_data():<br/>    return requests.get(ENDPOINT).json()['data']</span><span id="d2d7" class="la lb iu nc b gz nk nh l ni nj">def _transform_data(data):<br/>    return {'no_records': len(data)}</span><span id="3bdf" class="la lb iu nc b gz nk nh l ni nj">def _load_results(no_records):<br/>    logging.info(<br/>        f'No. of records fetched by {ENDPOINT}: {no_records}'<br/>    )</span><span id="5516" class="la lb iu nc b gz nk nh l ni nj">with DAG(<br/>    default_args=default_args,<br/>    schedule_interval='@hourly', <br/>    start_date=days_ago(1),<br/>):<br/>    extract = PythonOperator(<br/>        task_id='extract_from_api',<br/>        python_callable=_extract_data,<br/>    )</span><span id="dddd" class="la lb iu nc b gz nk nh l ni nj">    transform = PythonOperator(<br/>        task_id='transform_data',<br/>        python_callable=_transform_data,<br/>        op_kwargs=[extract]<br/>    )</span><span id="8640" class="la lb iu nc b gz nk nh l ni nj">    load = PythonOperator(<br/>        task_id='load_data',<br/>        python_callable=_load_results,<br/>        op_kwargs=[transform['no_records']]<br/>    )</span><span id="c674" class="la lb iu nc b gz nk nh l ni nj">    extract &gt;&gt; transform &gt;&gt; load</span></pre></div><div class="ab cl mu mv hy mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="in io ip iq ir"><h2 id="aaef" class="la lb iu bd lc ld le dn lf lg lh dp li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">使用气流装饰器创作Dag</h2><p id="c501" class="pw-post-body-paragraph lw lx iu ly b lz ma jv mb mc md jy me lj mf mg mh ln mi mj mk lr ml mm mn mo in bi translated">从Airflow 2.0开始，你也可以使用decorators从一个函数创建Dag。Python中的decorator是一个函数，它接受另一个函数作为参数，修饰它(即丰富它的功能)并最终返回它。</p><p id="5426" class="pw-post-body-paragraph lw lx iu ly b lz mp jv mb mc mq jy me lj mr mg mh ln ms mj mk lr mt mm mn mo in bi translated">DAG装饰器创建一个DAG生成器函数，每个用<code class="fe nl nm nn nc b">@dag</code>装饰器装饰的函数都将返回一个DAG对象。但是请注意，到目前为止，您只能对Python函数使用Airflow装饰器，通常您必须通过<code class="fe nl nm nn nc b">PythonOperator</code>调用这些函数。</p><pre class="kk kl km kn gu nb nc nd ne aw nf bi"><span id="1908" class="la lb iu nc b gz ng nh l ni nj">from datetime import timedelta</span><span id="5f1f" class="la lb iu nc b gz nk nh l ni nj">from airflow.decorators import dag, task<br/>from airflow.utils.dates import days_ago<br/></span><span id="cedd" class="la lb iu nc b gz nk nh l ni nj">ENDPOINT = 'https://some-api.com/data'</span><span id="4a5a" class="la lb iu nc b gz nk nh l ni nj">default_args = {<br/>    'owner': 'airflow',<br/>    'retries': 1,<br/>    'retry_delay': timedelta(minutes=5),<br/>}</span><span id="288c" class="la lb iu nc b gz nk nh l ni nj">@dag(<br/>    default_args=default_args,<br/>    schedule_interval='@hourly', <br/>    start_date=days_ago(1),<br/>)<br/>def example_dag():</span><span id="215c" class="la lb iu nc b gz nk nh l ni nj">    @task<br/>    def extract():<br/>        return requests.get(ENDPOINT).json()['data']</span><span id="9579" class="la lb iu nc b gz nk nh l ni nj">    @task<br/>    def transform(data):<br/>        return {'no_records': len(data)}</span><span id="8edd" class="la lb iu nc b gz nk nh l ni nj">    @task<br/>    def load(no_records):<br/>        logging.info(<br/>            f'No. of records fetched by {ENDPOINT}: {no_records}'<br/>        )</span><span id="e74f" class="la lb iu nc b gz nk nh l ni nj">    load(transform(extract()['no_records']))<br/></span><span id="c7cf" class="la lb iu nc b gz nk nh l ni nj">dag = example_data()</span></pre><p id="41ae" class="pw-post-body-paragraph lw lx iu ly b lz mp jv mb mc mq jy me lj mr mg mh ln ms mj mk lr mt mm mn mo in bi translated">正如你所看到的，decorators帮助我们写了一个更干净、更简洁的代码。无需为每个单独的任务显式指定PythonOperators，我们通过利用新的气流装饰器，仅用几行代码就创建了一个相当简单的DAG。</p></div><div class="ab cl mu mv hy mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="in io ip iq ir"><h2 id="78f3" class="la lb iu bd lc ld le dn lf lg lh dp li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">最后的想法</h2><p id="f311" class="pw-post-body-paragraph lw lx iu ly b lz ma jv mb mc md jy me lj mf mg mh ln mi mj mk lr ml mm mn mo in bi translated">在今天的文章中，我们展示了如何使用新的气流装饰器来创作任务和Dag。这无疑是一个非常有前途的特性，但还不完全，因为它只能用于非常小的可用操作符子集。</p><p id="a805" class="pw-post-body-paragraph lw lx iu ly b lz mp jv mb mc mq jy me lj mr mg mh ln ms mj mk lr mt mm mn mo in bi translated">此外，我对我们需要使用新符号来指定任务依赖关系的方式有点怀疑。对于复杂的依赖关系，语法会变得非常混乱，可读性也不好。总的来说，我认为这是一个很好的补充，至少可以用于一些基本的Dag。</p><p id="f48d" class="pw-post-body-paragraph lw lx iu ly b lz mp jv mb mc mq jy me lj mr mg mh ln ms mj mk lr mt mm mn mo in bi translated">请注意，您甚至可以创建定制的装饰器，以满足您特定项目的需求。您可以在官方文档的<a class="ae kz" href="https://airflow.apache.org/docs/apache-airflow/2.0.2/howto/custom-operator.html" rel="noopener ugc nofollow" target="_blank">相关章节中找到更多关于如何操作的信息。</a></p></div><div class="ab cl mu mv hy mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="in io ip iq ir"><p id="1b77" class="pw-post-body-paragraph lw lx iu ly b lz mp jv mb mc mq jy me lj mr mg mh ln ms mj mk lr mt mm mn mo in bi translated"><a class="ae kz" href="https://gmyrianthous.medium.com/membership" rel="noopener"> <strong class="ly iv">成为会员</strong> </a> <strong class="ly iv">阅读介质上的每一个故事。你的会员费直接支持我和你看的其他作家。你也可以在媒体上看到所有的故事。</strong></p><div class="no np gq gs nq nr"><a href="https://gmyrianthous.medium.com/membership" rel="noopener follow" target="_blank"><div class="ns ab fp"><div class="nt ab nu cl cj nv"><h2 class="bd iv gz z fq nw fs ft nx fv fx it bi translated">通过我的推荐链接加入Medium-Giorgos Myrianthous</h2><div class="ny l"><h3 class="bd b gz z fq nw fs ft nx fv fx dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="nz l"><p class="bd b dl z fq nw fs ft nx fv fx dk translated">gmyrianthous.medium.com</p></div></div><div class="oa l"><div class="ob l oc od oe oa of kt nr"/></div></div></a></div></div><div class="ab cl mu mv hy mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="in io ip iq ir"><p id="676e" class="pw-post-body-paragraph lw lx iu ly b lz mp jv mb mc mq jy me lj mr mg mh ln ms mj mk lr mt mm mn mo in bi translated"><strong class="ly iv">相关文章你可能也喜欢</strong></p><div class="no np gq gs nq nr"><a rel="noopener follow" target="_blank" href="/run-airflow-docker-1b83a57616fb"><div class="ns ab fp"><div class="nt ab nu cl cj nv"><h2 class="bd iv gz z fq nw fs ft nx fv fx it bi translated">如何使用Docker在本地运行气流</h2><div class="ny l"><h3 class="bd b gz z fq nw fs ft nx fv fx dk translated">在本地机器上使用Docker运行Airflow的分步指南</h3></div><div class="nz l"><p class="bd b dl z fq nw fs ft nx fv fx dk translated">towardsdatascience.com</p></div></div><div class="oa l"><div class="og l oc od oe oa of kt nr"/></div></div></a></div></div><div class="ab cl mu mv hy mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="in io ip iq ir"><div class="kk kl km kn gu nr"><a rel="noopener follow" target="_blank" href="/connect-airflow-worker-gcp-e79690f3ecea"><div class="ns ab fp"><div class="nt ab nu cl cj nv"><h2 class="bd iv gz z fq nw fs ft nx fv fx it bi translated">如何在Cloud Composer上连接到气流工作者</h2><div class="ny l"><h3 class="bd b gz z fq nw fs ft nx fv fx dk translated">在谷歌云平台上连接气流工作者</h3></div><div class="nz l"><p class="bd b dl z fq nw fs ft nx fv fx dk translated">towardsdatascience.com</p></div></div><div class="oa l"><div class="oh l oc od oe oa of kt nr"/></div></div></a></div></div><div class="ab cl mu mv hy mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="in io ip iq ir"><div class="kk kl km kn gu nr"><a rel="noopener follow" target="_blank" href="/hashicorp-vault-airflow-cfdddab31ea"><div class="ns ab fp"><div class="nt ab nu cl cj nv"><h2 class="bd iv gz z fq nw fs ft nx fv fx it bi translated">如何用气流设置HashiCorp保险库</h2><div class="ny l"><h3 class="bd b gz z fq nw fs ft nx fv fx dk translated">将HashiCorp Vault与Apache Airflow集成</h3></div><div class="nz l"><p class="bd b dl z fq nw fs ft nx fv fx dk translated">towardsdatascience.com</p></div></div><div class="oa l"><div class="oi l oc od oe oa of kt nr"/></div></div></a></div></div></div>    
</body>
</html>