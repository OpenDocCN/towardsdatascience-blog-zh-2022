<html>
<head>
<title>3 steps for Building Airflow Pipelines with Efficient Resource Utilisation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建高效利用资源的气流管道的3个步骤</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/3-steps-to-build-airflow-pipelines-with-efficient-resource-utilisation-b9f399d29fb3#2022-07-03">https://towardsdatascience.com/3-steps-to-build-airflow-pipelines-with-efficient-resource-utilisation-b9f399d29fb3#2022-07-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/36626c0dcb01a375107ebc8d4c2fa492.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EiAOE_P_5Lh6z6G_"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@knixon?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">凯勒·尼克森</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="b919" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这篇博客着眼于一些对管理工作流中的资源有价值的气流特性。我们将探讨一些相互关联的概念，这些概念会影响任何数据管道的底层基础设施的资源利用。特别是，我们将探讨以下概念:</p><ul class=""><li id="6eb8" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated"><strong class="kf ir">气流池</strong>用于<em class="lk">根据预定义的指标将资源分配</em>给一组任务。</li><li id="3a29" class="lb lc iq kf b kg ll kk lm ko ln ks lo kw lp la lg lh li lj bi translated"><strong class="kf ir">并行&amp;并发</strong>高效<em class="lk">扩展</em>管道，充分利用可用的基础设施。</li><li id="4a97" class="lb lc iq kf b kg ll kk lm ko ln ks lo kw lp la lg lh li lj bi translated"><strong class="kf ir">优先级权重</strong>用于<em class="lk">确定</em>的优先级，并在其他任务之前为关键任务分配资源。</li></ul><p id="7f53" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本博客不着重介绍气流；要了解更多关于使用Apache Airflow构建管道的信息，请点击这里查看我的其他博客<a class="ae kc" href="https://vachan15.medium.com/index-link-to-all-my-blogs-98efca323fa8" rel="noopener">。事不宜迟，让我们开始探讨上面提到的话题。</a></p><h1 id="8c60" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated"><strong class="ak"> 1。气流池</strong></h1><p id="46cf" class="pw-post-body-paragraph kd ke iq kf b kg mo ki kj kk mp km kn ko mq kq kr ks mr ku kv kw ms ky kz la ij bi translated">作为数据工程师，我们构建多个管道来负责运行特定的工作流。解决方案需要一个DAG或一组DAG来实现预期的结果。例如，一组Dag将数据加载到数据仓库，另一组部署和监控机器学习模型，一些Dag启动或停止项目的基础设施。</p><p id="f294" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有这么多Dag，有时需要同时运行其中的几个，管理底层资源的分配变得至关重要。这样做很重要，这样气流就不会淹没基础架构或由于资源限制(如可同时运行的任务/Dag数量)而阻碍业务关键型任务。我们可以使用池的概念将任务分配给资源。</p><figure class="mu mv mw mx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mt"><img src="../Images/5555b73c235d224365629fd33c2c58aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VxdZ6jevb4AfGkVu"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">照片由Jonathan Chng 在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="1251" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">与游泳池类似，气流罐中的池是流程运行的区域。它包含<strong class="kf ir"> <em class="lk">插槽</em> </strong>，气流中的操作员一旦分配到池中就可以使用。根据任务的配置，任务可以使用一个或多个插槽。默认情况下，每个任务使用一个槽，并被分配给包含128个槽的default_pool。</p><p id="577f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在单个池中运行所有任务是有问题的。例如，如果airflow实例正在利用池中的所有插槽，并且需要运行更多的任务，在这种情况下，任务将排队等待正在进行的进程完成。</p><h2 id="94d7" class="my lr iq bd ls mz na dn lw nb nc dp ma ko nd ne me ks nf ng mi kw nh ni mm nj bi translated"><strong class="ak">在气流中使用水池</strong></h2><p id="86e6" class="pw-post-body-paragraph kd ke iq kf b kg mo ki kj kk mp km kn ko mq kq kr ks mr ku kv kw ms ky kz la ij bi translated">如下所示，我们可以使用管理面板访问Airflow中的池。我们还可以使用它来查看/修改所有现有池或创建新池。</p><figure class="mu mv mw mx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/81d1cd533787244d60c9c3038c5cdbf1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xPLiGLZNFmCn-7pIVCwo8Q.png"/></div></div></figure><figure class="mu mv mw mx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/9122d38ccc115322adf6a2859a9eb79e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VqlIhoXu5f-_HScBXDLRhw.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">作者图片</p></figure><p id="9246" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建之后，我们可以使用操作符中的<strong class="kf ir"> <em class="lk">池</em> </strong>属性将任务分配给池。我们可以让同一个DAG中的操作员，或者根据逻辑差异将多个DAG分配给不同的池。此外，如果池中的一些任务比其他任务需要更多的资源，我们可以使用操作符中的<strong class="kf ir"> <em class="lk"> pool_slots </em> </strong>属性为这些任务分配更多的资源。</p><p id="871c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以从下面的DAG中观察到，我们有一些关键任务和一些非关键任务。我们根据任务的重要性将它们分配到不同的池中。此外，我们为基本任务分配更多的pool_slots，让Airflow知道这些任务需要更多的资源。</p><figure class="mu mv mw mx gt jr"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="d5f1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们知道了如何配置池，要有效地使用它们，还需要一些额外的步骤。</p><ul class=""><li id="e46e" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated"><strong class="kf ir">将任务分配给不同的池。</strong>在单个池中运行所有任务可能会有问题。例如，如果一个Airflow实例正在使用所有的槽，并且需要运行更多的任务，那么不管这些任务的重要性如何，它们都会被排队，直到一个正在进行的进程释放出一个位置。因此，我们可以为业务关键型作业创建一个池，为非关键型任务创建另一个池，并相应地为池类型分配操作。</li><li id="9e9d" class="lb lc iq kf b kg ll kk lm ko ln ks lo kw lp la lg lh li lj bi translated">除了分离池，我们还需要<strong class="kf ir">管理池内的槽</strong>。我们必须确保业务关键型池有足够的槽，以便任务在开始处理之前不会等待太久。</li><li id="a01c" class="lb lc iq kf b kg ll kk lm ko ln ks lo kw lp la lg lh li lj bi translated">池的<strong class="kf ir">数量</strong>取决于用例。例如，我们可以为高、中、低关键任务设置三个池，或者为不同的工作流设置单独的池，例如一个池用于管理基础架构，另一个池用于管理数据管道等等。</li><li id="3aa7" class="lb lc iq kf b kg ll kk lm ko ln ks lo kw lp la lg lh li lj bi translated">池中的<strong class="kf ir">插槽数量</strong>。可以帮助确定槽数的几个因素如下<br/> *】需要并行运行的任务数<br/> *】每个任务需要的槽数<br/> *】一个任务的时延容忍度。<br/>例如，如果一个池需要为一个管道并行运行10个任务，每个任务需要两个插槽，并且如果所有的任务都是不停机运行的关键，那么我们应该为池分配至少20个插槽来有效地运行管道。</li></ul><h1 id="dbfc" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">2.并行和并发</h1><p id="b81c" class="pw-post-body-paragraph kd ke iq kf b kg mo ki kj kk mp km kn ko mq kq kr ks mr ku kv kw ms ky kz la ij bi translated">在本节中，我们将了解池正常工作所需的一些气流配置。</p><ul class=""><li id="38e2" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated"><strong class="kf ir">并行度:</strong>定义为一个气流实例可以同时执行<strong class="kf ir">的任务数，即包括所有Dag。如果airflow实例处于最大允许并行度容量，即将到来的任务将排队，而不管它们的池配置如何。<br/>例如，让我们假设具有以下配置的情况:<br/> *]要运行的任务:100 <br/> *]池容量(槽数)= 200 <br/> *]每个任务的槽数= 1 <br/>假设<strong class="kf ir"> <em class="lk">并行度</em> </strong>被设置为其默认值32。在这种情况下，尽管池可以同时运行所有任务，但由于最大并行度的限制，它将在任何给定时间运行32个任务。</strong></li><li id="d43e" class="lb lc iq kf b kg ll kk lm ko ln ks lo kw lp la lg lh li lj bi translated"><strong class="kf ir"> Dag_concurrency </strong>:定义为一个DAG 中可以同时执行<strong class="kf ir">的最大任务数。与并行性类似，dag并发会影响工作流的资源利用率。并行性影响气流级别(即跨所有dag)的任务排队，而dag_concurrency影响DAG级别的进程排队。<br/>例如，让我们假设具有以下配置的情况:<br/> *]要运行的任务:100 <br/> *]并行度= 128 <br/> *]池容量(槽数)= 200 <br/> *]每个任务的槽数= 1 <br/>假设<strong class="kf ir"><em class="lk">Dag _ concurrency</em></strong><em class="lk"/>设置为其默认值16。尽管配置的其余部分支持并行处理，但它受到dag并发性的限制。因此，所有超过16的操作都要排队。</strong></li></ul><figure class="mu mv mw mx gt jr"><div class="bz fp l di"><div class="nm nn l"/></div></figure><h1 id="586c" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">3.优先级权重</h1><p id="bc7f" class="pw-post-body-paragraph kd ke iq kf b kg mo ki kj kk mp km kn ko mq kq kr ks mr ku kv kw ms ky kz la ij bi translated">在构建大数据管道时，有时我们希望将一组任务的优先级高于其他任务。例如，如果我们有多个数据源，并且在ETL过程中处理一些数据源比其他数据源更重要，我们可以配置我们的工作流来区分这些任务的优先级。</p><figure class="mu mv mw mx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/afaca5fbcb8bffe6edfba914849c339d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xf-59mRMv6kUZ9mXHD3_YA.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">作者图片</p></figure><p id="313b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从上面的DAG我们可以观察到，Airflow运行一组任务，即在<strong class="kf ir"><em class="lk">data _ source _ 2</em></strong>之前<strong class="kf ir"><em class="lk">data _ source _ 1</em></strong>的ETL。我们可以通过设置以下配置来实现:</p><ul class=""><li id="5b56" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated"><strong class="kf ir"><em class="lk">priority _ weight</em></strong>:优先级权重是一个操作员的属性，为每个任务分配优先级。</li></ul><figure class="mu mv mw mx gt jr"><div class="bz fp l di"><div class="nm nn l"/></div></figure><ul class=""><li id="8ef3" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated"><strong class="kf ir"> <em class="lk"> weight_rule </em> </strong>:权重规则决定了任务权重的计算方法。</li></ul><figure class="mu mv mw mx gt jr"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="2102" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在气流中，我们有如下三个重量规则:</p><ol class=""><li id="fc64" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la np lh li lj bi translated"><strong class="kf ir"> Absolute </strong>:允许气流实例根据分配给每个任务的<strong class="kf ir"> <em class="lk"> priority_weight </em> </strong>对任务进行优先级排序。<br/>例如，让我们假设以下配置。<br/>*]priority _ weight = 2 for all critical_data分支<br/>*]priority _ weight = 1 for all non _ critical _ data分支<br/>现在，对于下面的DAG，所有具有较高priority_weights的任务，即critical _ data任务，首先被调度和执行。</li></ol><figure class="mu mv mw mx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nq"><img src="../Images/4ac66f2777e98cd7bed9b1bde241a06a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zzBck69xEClC2jWc90W2SQ.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">作者图片</p></figure><p id="4447" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> 2。上游</strong>:使用上游权重规则允许Airflow实例通过将操作的权重分配为等于其下游任务的权重之和来区分DAG中上游任务的优先级。<br/>例如，让我们假设以下配置。<br/> *]所有任务的priority _ weight = 1<br/>现在，对于下面的DAG，任务<strong class="kf ir"><em class="lk">load _ data _ source _ 1 _ pod _ 0</em></strong>的<strong class="kf ir"> priority_weight为5 </strong>，即下游任务为4，自身为1。</p><figure class="mu mv mw mx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/46750872661167c8151d31f58b5de106.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vs-HtQNPVR7ARiJkqlH83A.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">作者图片</p></figure><p id="f38c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> 3。下游</strong>:使用下游权重规则允许Airflow实例通过分配一个操作的权重等于其上游任务的权重之和来区分DAG中下游任务的优先级。例如，让我们假设以下配置。<br/> *] priority_weight = 1对于所有任务<br/>现在，对于下面的DAG，任务<strong class="kf ir"><em class="lk">extract _ data _ source _ 1 _ pod _ 0</em></strong>的<strong class="kf ir"> priority_weight为4，</strong>即上游任务为3，自身为1。</p><figure class="mu mv mw mx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nq"><img src="../Images/b0f2c90440903bac74e34331e9cd9d74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rmwuFtRb1ohpIireq7pQTg.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">作者图片</p></figure><p id="e8d8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果任务属于同一个库，那么知道它们之间的优先级是可比较的是至关重要的。如果DAG中的操作员被分配到不同的池，则每个池中具有较高优先级的任务将首先执行。较高的priority_weights意味着Airflow将在服务任何其他排队作业之前运行这些任务。</p><h1 id="e1ce" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">结论</h1><p id="cdba" class="pw-post-body-paragraph kd ke iq kf b kg mo ki kj kk mp km kn ko mq kq kr ks mr ku kv kw ms ky kz la ij bi translated">建立有效利用基础设施的数据管道是多种因素的结合。这篇博客探讨了其中一些相互关联的概念，以便管道可以基于底层资源和逻辑流进行伸缩。</p><h1 id="8c45" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">参考</h1><div class="ns nt gp gr nu nv"><a href="https://airflow.apache.org/" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd ir gy z fp oa fr fs ob fu fw ip bi translated">主页</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">没有更多的命令行或XML魔术！使用标准Python功能创建工作流，包括日期时间…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">airflow.apache.org</p></div></div><div class="oe l"><div class="of l og oh oi oe oj jw nv"/></div></div></a></div><h1 id="0ea8" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">阅读其他数据博客</h1><div class="ns nt gp gr nu nv"><a href="https://vachan15.medium.com/index-link-to-all-my-blogs-98efca323fa8" rel="noopener follow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd ir gy z fp oa fr fs ob fu fw ip bi translated">索引—链接到我的所有博客</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">这篇文章只是为了方便访问我过去写的博客。不同领域的博客会…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">vachan15.medium.com</p></div></div></div></a></div><h1 id="ce5f" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">在Linkedin上连接:</h1><div class="ns nt gp gr nu nv"><a href="https://www.linkedin.com/in/vachan-anand-26bb76b7/" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd ir gy z fp oa fr fs ob fu fw ip bi translated">Vachan Anand —顾问— Servian | LinkedIn</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">一家非盈利机构的创始人，具有金融服务行业的工作经历。熟练HTML…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">www.linkedin.com</p></div></div><div class="oe l"><div class="ok l og oh oi oe oj jw nv"/></div></div></a></div></div></div>    
</body>
</html>