<html>
<head>
<title>Apache Airflow for Data Science — How to Work With Databases (Postgres)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Apache Airflow for Data Science —如何使用数据库(Postgres)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/apache-airflow-for-data-science-how-to-work-with-databases-postgres-a4dc79c04cb8#2022-02-26">https://towardsdatascience.com/apache-airflow-for-data-science-how-to-work-with-databases-postgres-a4dc79c04cb8#2022-02-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="32fa" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在10分钟内编写一个Postgres ETL管道</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/110616ec44c4dc3cd23eaf3306c33669.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EGJbVoDPDfJuYgIo"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@mikesetchell?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">迈克·塞切尔</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="1d08" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上周的文章的<a class="ae ky" href="https://betterdatascience.com/apache-airflow-write-your-first-dag/" rel="noopener ugc nofollow" target="_blank">中，您已经看到了如何编写一个Airflow DAG，它从终端获取当前的日期时间信息，解析它，并将其保存到本地CSV文件中。这是一个相当简单的DAG，但足以让你看到气流是如何工作的。今天，我们将进入一个更高的档位，广泛地使用Postgres数据库。</a></p><p id="c466" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您将看到如何从数据库中获取数据、运行SQL查询，以及将CSV文件插入数据库—所有这些都在单个DAG中完成。所以，事不宜迟，让我们直入主题吧。</p><p id="614b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不想看书？请观看我的视频:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="9e43" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">你今天要做什么</h1><p id="91bb" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">今天，您将编写一个实现以下数据管道的气流DAG:</p><ol class=""><li id="58cc" class="nb nc it lb b lc ld lf lg li nd lm ne lq nf lu ng nh ni nj bi translated">从Postgres表中获取数据</li><li id="981f" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu ng nh ni nj bi translated">使用Python和Pandas处理数据，并将其保存到CSV文件中</li><li id="0825" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu ng nh ni nj bi translated">截断Postgres数据库中的目标表</li><li id="6547" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu ng nh ni nj bi translated">将CSV文件复制到Postgres表中</li></ol><p id="c2fb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们首先必须配置所有与数据集和数据库相关的东西。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="4701" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">数据集和数据库配置</h1><p id="8c86" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">从<a class="ae ky" href="https://gist.githubusercontent.com/netj/8836201/raw/6f9306ad21398ea43cba4f7d537619d0e07d5ae3/iris.csv" rel="noopener ugc nofollow" target="_blank">此链接</a>下载虹膜数据集。它相对较小，但能满足我们今天的需求:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/3d2e4b36eeaffaef912b2615215e66c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R5d_QYDTlMIA02enP0GcYQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片1-虹膜数据集(图片由作者提供)</p></figure><p id="cdc7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">打开建立了Postgres连接的DBMS。使用以下语句创建表—不要觉得有义务使用相同的命名约定:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="7605" class="nv mf it nr b gy nw nx l ny nz">CREATE TABLE iris(<br/>	iris_id SERIAL PRIMARY KEY,<br/>	iris_sepal_length REAL,<br/>	iris_sepal_width REAL,<br/>	iris_petal_length REAL,<br/>	iris_petal_width REAL,<br/>	iris_variety VARCHAR(16)<br/>);</span></pre><p id="ac77" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建表后，将Iris CSV数据集加载到其中。在适用的情况下，对列名和/或路径进行适当的更改:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="b252" class="nv mf it nr b gy nw nx l ny nz">COPY iris(iris_sepal_length, iris_sepal_width, iris_petal_length, iris_petal_width, iris_variety)<br/>FROM '/Users/dradecic/Desktop/iris.csv'<br/>DELIMITER ','<br/>CSV HEADER;</span></pre><p id="20a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的数据管道将在最后一步将数据加载到Postgres中。目标表将具有与<code class="fe oa ob oc nr b">iris</code>表相同的结构，只是没有ID列。使用下面的SQL语句创建它:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="6176" class="nv mf it nr b gy nw nx l ny nz">CREATE TABLE iris_tgt AS (<br/>	SELECT<br/>		iris_sepal_length, iris_sepal_width, iris_petal_length, iris_petal_width, iris_variety<br/>	FROM iris<br/>	WHERE 1 = 2<br/>);</span></pre><p id="f300" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，让我们验证数据是否被复制到了<code class="fe oa ob oc nr b">iris</code>表中:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="0a43" class="nv mf it nr b gy nw nx l ny nz">SELECT * FROM iris;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/ef99ade8ae0eddf5597d81197eeda5d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3SHoGBFZbnVn-icN0H5n2g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片2-复制到Postgres数据库的数据集(图片由作者提供)</p></figure><p id="8a32" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是我们在数据库端需要做的全部工作，但是在编写DAG之前还有一步要做——在Airflow中建立Postgres连接。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="dcd9" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">如何在气流中设置Postgres连接</h1><p id="bca8" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">如果Airflow webserver和scheduler正在运行，请将其关闭，并运行以下命令来安装Airflow的Postgres提供程序包:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="6da5" class="nv mf it nr b gy nw nx l ny nz">pip install 'apache-airflow[postgres]'</span></pre><p id="139a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是终端输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/c67ba43be1e773faa3160abbb03f81d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0vPN51iqrSHkX-X_xP6s0A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图3 —为Postgres安装气流插件(图片由作者提供)</p></figure><p id="915a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成后，启动网络服务器和调度程序，并导航到<em class="of">气流</em> — <em class="of">管理</em> — <em class="of">连接</em>。点击<em class="of">加号</em>添加新连接并指定连接参数。这是我的样子:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/d48e5a8e75ac92da0fd647c68fd19f8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sxy-SNA0xAPn5XVCin5yug.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图4-定义气流中的Postgres连接(图片由作者提供)</p></figure><p id="6fbb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成后，滚动到屏幕底部并点击<em class="of">保存</em>。</p><p id="36bb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还没完呢。让我们在<em class="of">Admin</em>—<em class="of">Variables</em>下声明一个变量，该变量保存已处理的CSV文件的位置:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/0ae3f415cb713c143cfb5038aefef1c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gWaNTN2RTFhrf_XwEDm_fA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图5 —声明用于存储临时CSV文件的变量(作者图片)</p></figure><p id="0069" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">好了，现在我们完成了。下一个是DAG。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="0c74" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">编写DAG — Apache Airflow和Postgres</h1><p id="0294" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">这是今天文章的重点。我们会将DAG分成多个易于管理的块，这样您就不会不知所措。我们将从样板代码开始，然后开始使用Postgres。</p><h2 id="1ec0" class="nv mf it bd mg oh oi dn mk oj ok dp mo li ol om mq lm on oo ms lq op oq mu or bi translated">库导入和DAG样板文件</h2><p id="c86f" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">下面的代码片段从Python和Airflow中导入了我们需要的一切。它还声明了一个ID为<code class="fe oa ob oc nr b">postgres_db_dag</code>的DAG，计划每天运行一次:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="ae19" class="nv mf it nr b gy nw nx l ny nz">import pandas as pd<br/>from datetime import datetime<br/>from airflow.models import DAG<br/>from airflow.operators.python import PythonOperator<br/>from airflow.hooks.postgres_hook import PostgresHook<br/>from airflow.models import Variable<br/>from airflow.operators.bash import BashOperator<br/>from airflow.providers.postgres.operators.postgres import PostgresOperator<br/></span><span id="ab69" class="nv mf it nr b gy os nx l ny nz">with DAG(<br/>    dag_id='postgres_db_dag',<br/>    schedule_interval='@daily',<br/>    start_date=datetime(year=2022, month=2, day=1),<br/>    catchup=False<br/>) as dag:<br/>    pass</span></pre><p id="de1c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在将分别实现这四项任务中的每一项，并解释发生了什么。如果你很着急，向下滚动一点，因为有一个完整的DAG代码片段。</p><h2 id="c0ed" class="nv mf it bd mg oh oi dn mk oj ok dp mo li ol om mq lm on oo ms lq op oq mu or bi translated">任务#1 —通过气流从Postgres获取数据</h2><p id="3c67" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">我们DAG的第一个任务是从Postgres数据库中获取数据。这并不像你想象的那样简单。我们不会使用Postgres操作符，而是通过<code class="fe oa ob oc nr b">PythonOperator</code>调用一个Python函数。该任务将调用<code class="fe oa ob oc nr b">get_iris_data()</code>函数，并将返回值推送到Airflow的Xcoms:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="5819" class="nv mf it nr b gy nw nx l ny nz"># 1. Get the Iris data from a table in Postgres<br/>task_get_iris_data = PythonOperator(<br/>	task_id='get_iris_data',<br/>	python_callable=get_iris_data,<br/>	do_xcom_push=True<br/>)</span></pre><p id="71f0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe oa ob oc nr b">get_iris_data()</code>函数利用了<code class="fe oa ob oc nr b">PostgresHook</code>——一种建立到Postgres数据库的连接、运行SQL语句并获取结果的方法。获取整个表，然后推送到Airflow的Xcoms:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="e82f" class="nv mf it nr b gy nw nx l ny nz">def get_iris_data():<br/>    sql_stmt = "SELECT * FROM iris"<br/>    pg_hook = PostgresHook(<br/>        postgres_conn_id='postgres_db',<br/>        schema='db_test'<br/>    )<br/>    pg_conn = pg_hook.get_conn()<br/>    cursor = pg_conn.cursor()<br/>    cursor.execute(sql_stmt)<br/>    return cursor.fetchall()</span></pre><p id="1eb9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用以下shell命令测试任务:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="2d17" class="nv mf it nr b gy nw nx l ny nz">airflow tasks test postgres_db_dag get_iris_data 2022-2-1</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/0979e2a06efbb9af9c386d8af5cbcd63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S7LYQp5m1DB3TBbgHg23vA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图6 —测试从Postgres中检索数据的任务(图片由作者提供)</p></figure><p id="48ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">成功—您可以看到Iris表作为元组列表打印到控制台。接下来我们来处理一下。</p><h2 id="f5d4" class="nv mf it bd mg oh oi dn mk oj ok dp mo li ol om mq lm on oo ms lq op oq mu or bi translated">任务2——处理虹膜数据</h2><p id="13a0" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">如果你是一个日常的熊猫用户，处理虹膜数据集应该感觉很熟悉。我们将声明另一个调用<code class="fe oa ob oc nr b">process_iris_data()</code>函数的<code class="fe oa ob oc nr b">PythonOperator</code>:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="af21" class="nv mf it nr b gy nw nx l ny nz"># 2. Process the Iris data<br/>task_process_iris_data = PythonOperator(<br/>	task_id='process_iris_data',<br/>	python_callable=process_iris_data<br/>)</span></pre><p id="9852" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该函数从Airflow的Xcoms中检索一个元组列表，并为其创建一个Pandas数据帧。然后，对于处理部分，只保留符合四个标准的行，过滤后的数据帧保存到CSV文件中，不包含ID列。我们通过之前声明的气流变量获得CSV位置:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="6302" class="nv mf it nr b gy nw nx l ny nz">def process_iris_data(ti):<br/>    iris = ti.xcom_pull(task_ids=['get_iris_data'])<br/>    if not iris:<br/>        raise Exception('No data.')</span><span id="0eec" class="nv mf it nr b gy os nx l ny nz">    iris = pd.DataFrame(<br/>        data=iris[0],<br/>        columns=['iris_id', 'iris_sepal_length', 'iris_sepal_width',<br/>                 'iris_petal_length', 'iris_petal_width', 'iris_variety']<br/>    )<br/>    iris = iris[<br/>        (iris['iris_sepal_length'] &gt; 5) &amp;<br/>        (iris['iris_sepal_width'] == 3) &amp;<br/>        (iris['iris_petal_length'] &gt; 3) &amp;<br/>        (iris['iris_petal_width'] == 1.5)<br/>    ]<br/>    iris = iris.drop('iris_id', axis=1)<br/>    iris.to_csv(Variable.get('tmp_iris_csv_location'), index=False)</span></pre><p id="3048" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在测试中:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="af49" class="nv mf it nr b gy nw nx l ny nz">airflow tasks test postgres_db_dag process_iris_data 2022-2-1</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ot"><img src="../Images/1949e839f48768b354dd4aa9878ddb26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OCCms61Rj_QkYldyBCWXyA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图7 —测试处理虹膜数据的任务(图片由作者提供)</p></figure><p id="7116" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">又一次成功了。CSV应该存储在<code class="fe oa ob oc nr b">/tmp/iris_processed.csv</code>处，所以让我们在终端中打印该文件:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ou"><img src="../Images/71da5085ec49d5371dce0ef3c1a62f4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9bTgRwp6NKkoYYH9qwG_pg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图8-处理任务的结果(作者提供的图片)</p></figure><p id="b2f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">只有三行加上标题被保留，表明管道的预处理步骤按预期工作。</p><h2 id="ca6c" class="nv mf it bd mg oh oi dn mk oj ok dp mo li ol om mq lm on oo ms lq op oq mu or bi translated">任务#3 —截断Postgres表</h2><p id="c074" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">我们的DAG每天都被执行，这意味着每天都会有三行被插入到Postgres数据库的一个表中。我们不希望值随着时间的推移而重复，所以我们将在插入前截断表。</p><p id="f266" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是第三项任务的由来。它使用<code class="fe oa ob oc nr b">PostgresOperator</code>建立到数据库的连接并运行SQL语句。该声明是在<code class="fe oa ob oc nr b">sql</code>参数下指定的:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="efe5" class="nv mf it nr b gy nw nx l ny nz"># 3. Truncate table in Postgres<br/>task_truncate_table = PostgresOperator(<br/>	task_id='truncate_tgt_table',<br/>	postgres_conn_id='postgres_db',<br/>	sql="TRUNCATE TABLE iris_tgt"<br/>)</span></pre><p id="66c1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们测试一下，看看是否有错误:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="bc1e" class="nv mf it nr b gy nw nx l ny nz">airflow tasks test postgres_db_dag truncate_tgt_table 2022-2-1</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ov"><img src="../Images/5fc7647e35ccf9c90d580bb6562cc227.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dpQgj3iz6TEOnnE9X9cWyQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图9 —截断目标表任务的结果(作者提供的图片)</p></figure><p id="9e5f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">任务成功，没有任何问题，所以我们可以进入下一个。</p><h2 id="e146" class="nv mf it bd mg oh oi dn mk oj ok dp mo li ol om mq lm on oo ms lq op oq mu or bi translated">任务#4 —使用气流将CSV文件加载到Postgres中</h2><p id="c88a" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">最后，我们希望将处理过的数据加载到表中。我们将使用<code class="fe oa ob oc nr b">BashOperator</code>来这样做。它将运行一个在<code class="fe oa ob oc nr b">bash_command</code>参数下指定的shell命令。</p><p id="c601" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将要运行的代码很长，所以我决定把它分成多行。确保分别用您的数据库名称和数据库用户名替换<code class="fe oa ob oc nr b">db_test</code>和<code class="fe oa ob oc nr b">dradecic</code>:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="c071" class="nv mf it nr b gy nw nx l ny nz"># 4. Save to Postgres<br/>task_load_iris_data = BashOperator(<br/>	task_id='load_iris_data',<br/>	bash_command=(<br/>		'psql -d db_test -U dradecic -c "'<br/>		'COPY iris_tgt(iris_sepal_length, iris_sepal_width, iris_petal_length, iris_petal_width, iris_variety) '<br/>		"FROM '/tmp/iris_processed.csv' "<br/>		"DELIMITER ',' "<br/>		'CSV HEADER"'<br/>	)<br/>)</span></pre><p id="a5f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看看它是否有效:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="26ad" class="nv mf it nr b gy nw nx l ny nz">airflow tasks test postgres_db_dag truncate_tgt_table 2022-2-1</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ow"><img src="../Images/0ad96687255dd9109b71032a82918195.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8Sy2iYOnk74OS17XMDHuAg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图10 —测试数据插入任务(作者图片)</p></figure><p id="c0c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">精彩！看起来任务成功了，三行被复制到了表中。我们现在应该有一个完全工作的DAG，我们将在接下来的部分中测试它。</p><p id="5b72" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您遗漏了什么，请使用下面部分的代码片段作为参考。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="c2d1" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">气流到Postgres DAG完整代码</h1><p id="ae4b" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">下面是DAG + <strong class="lb iu">任务连接</strong>的完整代码:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="7a5e" class="nv mf it nr b gy nw nx l ny nz">import pandas as pd<br/>from datetime import datetime<br/>from airflow.models import DAG<br/>from airflow.operators.python import PythonOperator<br/>from airflow.hooks.postgres_hook import PostgresHook<br/>from airflow.models import Variable<br/>from airflow.operators.bash import BashOperator<br/>from airflow.providers.postgres.operators.postgres import PostgresOperator<br/></span><span id="567b" class="nv mf it nr b gy os nx l ny nz">def get_iris_data():<br/>    sql_stmt = "SELECT * FROM iris"<br/>    pg_hook = PostgresHook(<br/>        postgres_conn_id='postgres_db',<br/>        schema='db_test'<br/>    )<br/>    pg_conn = pg_hook.get_conn()<br/>    cursor = pg_conn.cursor()<br/>    cursor.execute(sql_stmt)<br/>    return cursor.fetchall()<br/></span><span id="9aa4" class="nv mf it nr b gy os nx l ny nz">def process_iris_data(ti):<br/>    iris = ti.xcom_pull(task_ids=['get_iris_data'])<br/>    if not iris:<br/>        raise Exception('No data.')</span><span id="d398" class="nv mf it nr b gy os nx l ny nz">    iris = pd.DataFrame(<br/>        data=iris[0],<br/>        columns=['iris_id', 'iris_sepal_length', 'iris_sepal_width',<br/>                 'iris_petal_length', 'iris_petal_width', 'iris_variety']<br/>    )<br/>    iris = iris[<br/>        (iris['iris_sepal_length'] &gt; 5) &amp;<br/>        (iris['iris_sepal_width'] == 3) &amp;<br/>        (iris['iris_petal_length'] &gt; 3) &amp;<br/>        (iris['iris_petal_width'] == 1.5)<br/>    ]<br/>    iris = iris.drop('iris_id', axis=1)<br/>    iris.to_csv(Variable.get('tmp_iris_csv_location'), index=False)<br/></span><span id="aeb2" class="nv mf it nr b gy os nx l ny nz">with DAG(<br/>    dag_id='postgres_db_dag',<br/>    schedule_interval='@daily',<br/>    start_date=datetime(year=2022, month=2, day=1),<br/>    catchup=False<br/>) as dag:</span><span id="f9e5" class="nv mf it nr b gy os nx l ny nz">    # 1. Get the Iris data from a table in Postgres<br/>    task_get_iris_data = PythonOperator(<br/>        task_id='get_iris_data',<br/>        python_callable=get_iris_data,<br/>        do_xcom_push=True<br/>    )</span><span id="7f44" class="nv mf it nr b gy os nx l ny nz">    # 2. Process the Iris data<br/>    task_process_iris_data = PythonOperator(<br/>        task_id='process_iris_data',<br/>        python_callable=process_iris_data<br/>    )</span><span id="2607" class="nv mf it nr b gy os nx l ny nz">    # 3. Truncate table in Postgres<br/>    task_truncate_table = PostgresOperator(<br/>        task_id='truncate_tgt_table',<br/>        postgres_conn_id='postgres_db',<br/>        sql="TRUNCATE TABLE iris_tgt"<br/>    )</span><span id="d589" class="nv mf it nr b gy os nx l ny nz">    # 4. Save to Postgres<br/>    task_load_iris_data = BashOperator(<br/>        task_id='load_iris_data',<br/>        bash_command=(<br/>            'psql -d db_test -U dradecic -c "'<br/>            'COPY iris_tgt(iris_sepal_length, iris_sepal_width, iris_petal_length, iris_petal_width, iris_variety) '<br/>            "FROM '/tmp/iris_processed.csv' "<br/>            "DELIMITER ',' "<br/>            'CSV HEADER"'<br/>        )<br/>    )<br/>    <br/>    task_get_iris_data &gt;&gt; task_process_iris_data &gt;&gt; task_truncate_table &gt;&gt; task_load_iris_data</span></pre><p id="3ac2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们将了解如何通过气流运行DAG。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="dd02" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">如何在气流中运行DAG</h1><p id="e8ca" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">如果您现在打开Airflow的主页，您会看到另一个DAG列表:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/15c586767bf9f3abecb7bfc5e8cae579.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d8xieP0SxvN4v0oVl9gHtw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图11-所有气流Dag(图片由作者提供)</p></figure><p id="a7e5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">确保通过扳动开关来打开它。打开DAG并按下<em class="of">播放</em>按钮运行它。几秒钟后，所有任务都应该变成深绿色，表示它们成功完成:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/5785567eb464c16c25e0f9ea25b545c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GTnQT_cFiaobORdBmPWkqg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图12 —运行我们的气流DAG(图片由作者提供)</p></figure><p id="8243" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在数据库中，您现在可以看到插入了三行，代表符合我们筛选标准的所有鲜花:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/930f16283068619f34804d821f36cfa6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*37rsgaCjZlv1zKcp55qHLg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图13 —加载到Postgres数据库中的记录(作者图片)</p></figure><p id="ab45" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就这样DAG运行没有问题，所以我们就到此为止吧。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="3069" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">总结和后续步骤</h1><p id="15e6" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">Airflow的主要用例是编排，不一定是从数据库中提取数据。尽管如此，你可以用钩子来做。今天我们探讨了如何使用钩子，如何运行SQL语句，以及如何将数据插入到SQL表中——所有这些都使用Postgres。您可以轻松地将相同的逻辑应用于不同的数据库。DAG中的变化将是最小的。</p><p id="edaa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">作为一项家庭作业，你可以尝试将熊猫数据帧直接插入Postgres，而不必先将其保存为CSV文件。这是我们将在接下来的文章中讨论的内容，如果您找不到解决方案，请继续关注。</p><p id="dc3e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读！</p><h2 id="0a40" class="nv mf it bd mg oh oi dn mk oj ok dp mo li ol om mq lm on oo ms lq op oq mu or bi translated">推荐阅读</h2><ul class=""><li id="26d3" class="nb nc it lb b lc mw lf mx li ox lm oy lq oz lu pa nh ni nj bi translated"><a class="ae ky" href="https://betterdatascience.com/best-data-science-prerequisite-books/" rel="noopener ugc nofollow" target="_blank">学习数据科学先决条件(数学、统计和编程)的5本最佳书籍</a></li><li id="bfe0" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu pa nh ni nj bi translated"><a class="ae ky" href="https://betterdatascience.com/top-books-to-learn-data-science/" rel="noopener ugc nofollow" target="_blank">2022年学习数据科学的前5本书</a></li><li id="2eff" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu pa nh ni nj bi translated"><a class="ae ky" href="https://betterdatascience.com/apache-airflow-install/" rel="noopener ugc nofollow" target="_blank">如何在本地安装阿帕奇气流</a></li></ul><h2 id="74bd" class="nv mf it bd mg oh oi dn mk oj ok dp mo li ol om mq lm on oo ms lq op oq mu or bi translated">保持联系</h2><ul class=""><li id="b9f9" class="nb nc it lb b lc mw lf mx li ox lm oy lq oz lu pa nh ni nj bi translated">雇用我作为一名技术作家</li><li id="a5b7" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu pa nh ni nj bi translated">订阅<a class="ae ky" href="https://www.youtube.com/c/BetterDataScience" rel="noopener ugc nofollow" target="_blank"> YouTube </a></li><li id="b33a" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu pa nh ni nj bi translated">在<a class="ae ky" href="https://www.linkedin.com/in/darioradecic/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上连接</li></ul></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><p id="a0de" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="of">喜欢这篇文章吗？成为</em> <a class="ae ky" href="https://medium.com/@radecicdario/membership" rel="noopener"> <em class="of">中等会员</em> </a> <em class="of">继续无限制学习。如果你使用下面的链接，我会收到你的一部分会员费，不需要你额外付费。</em></p><div class="pb pc gp gr pd pe"><a href="https://medium.com/@radecicdario/membership" rel="noopener follow" target="_blank"><div class="pf ab fo"><div class="pg ab ph cl cj pi"><h2 class="bd iu gy z fp pj fr fs pk fu fw is bi translated">通过我的推荐链接加入Medium-Dario rade ci</h2><div class="pl l"><h3 class="bd b gy z fp pj fr fs pk fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="pm l"><p class="bd b dl z fp pj fr fs pk fu fw dk translated">medium.com</p></div></div><div class="pn l"><div class="po l pp pq pr pn ps ks pe"/></div></div></a></div></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><p id="5867" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="of">原载于2022年2月26日https://betterdatascience.com</em><em class="of">的</em> <a class="ae ky" href="https://betterdatascience.com/apache-airflow-postgres-database/" rel="noopener ugc nofollow" target="_blank"> <em class="of">。</em></a></p></div></div>    
</body>
</html>