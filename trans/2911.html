<html>
<head>
<title>How to Use Conversion-Rate (CVR) as an Objective in Multi-Armed Bandit Experiments</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在多臂强盗实验中使用转化率(CVR)作为目标</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-use-cvr-as-an-objective-in-multi-armed-bandit-experiments-4dfd2ab48a24#2022-06-24">https://towardsdatascience.com/how-to-use-cvr-as-an-objective-in-multi-armed-bandit-experiments-4dfd2ab48a24#2022-06-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="5728" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">包含代码示例的分步指南</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/84dbc22a4dfe6286c8d1c0e784765468.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*eDoTdJkkgKa0UOyc"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae kv" href="https://unsplash.com/@valeon?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">米切尔·布茨</a>拍摄</p></figure><h1 id="7c25" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated"><strong class="ak">简介</strong></h1><p id="b924" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">多臂土匪(MAB)已经成为一个越来越重要的实验工具，并已被广泛采用的行业巨头，如谷歌，Meta，网飞，领英等。进行有效的实验。然而，广泛使用的MAB测试设计要求感兴趣的目标提供即时反馈，以便更新每个变量的分配概率。这就是为什么你能找到的大多数运行MAB实验的教程可能都是以点击率(CTR)为目标的。</p><p id="e3b3" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">所以在这篇文章中，我想告诉你如何运行一个多臂土匪实验，为目标，采取重大延误，以实现如转换率(CVR)。</p><blockquote class="mp mq mr"><p id="50ba" class="lo lp ms lq b lr mk jr lt lu ml ju lw mt mm lz ma mu mn md me mv mo mh mi mj ij bi translated">这篇文章引用了我在2022年网络大会上发表的论文<a class="ae kv" href="https://arxiv.org/pdf/2202.00846.pdf" rel="noopener ugc nofollow" target="_blank"/></p></blockquote><h1 id="8ade" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated"><strong class="ak">为什么要进行多臂强盗实验？</strong></h1><p id="c4d8" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">假设你正在开展一项在线广告活动，并试图找到能给你的产品带来最高转化率的最佳平面设计，你将需要进行一项实验。</p><p id="0616" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">您可以运行一个经典的A/B/n测试，将固定比例的用户分配给竞争设计，然后在收集足够的数据后进行分析。然而，有两个常见的问题是A/B/n测试经常被批评的。当处理像CVR这样的延迟指标时，这些问题更加突出，因为完成实验需要更长的时间。</p><ol class=""><li id="4966" class="mw mx iq lq b lr mk lu ml lx my mb mz mf na mj nb nc nd ne bi translated">大量的实验成本。因为A/B/n测试中的所有竞争处理都保证了样本大小的固定部分，所以即使是“糟糕”的处理也可能暴露给大量用户，这可能会对用户体验造成伤害。更长的实验意味着更大的实验成本。</li><li id="3bb6" class="mw mx iq lq b lr nf lu ng lx nh mb ni mf nj mj nb nc nd ne bi translated">如果分析不正确，容易做出错误的决定。A/B/n测试旨在仅在达到目标样本量时进行分析。但是缺乏经验和耐心的实验者往往倾向于在实验前偷看结果并做出决定，这可能导致错误的结论。更多讨论见<a class="ae kv" href="https://www.lucidchart.com/blog/the-fatal-flaw-of-ab-tests-peeking" rel="noopener ugc nofollow" target="_blank">这篇博客</a>。实验时间越长，出错的机会就越多。</li></ol><p id="00cb" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们的英雄来了，多臂强盗范式。在这种范式中，我们将我们的竞争广告设计视为许多不同的老虎机。每个老虎机都有自己的成功率(转化率)。我们想找到一个速度最好的老虎机，然后继续拉它的手臂。MAB算法将提供一种原则性的方法，在整个实验中反复调整分配比，直到最佳处理接收到大部分样本。</p><p id="4d1c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">MAB的优势在于降低了实验的机会成本，而且不受窥视。</p><h1 id="903c" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">计算CVR的问题是</h1><p id="9614" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">现在你可能会想，MAB听起来不错，但CVR有什么特别之处呢？</p><p id="e0db" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">转换率是行业中非常常见和重要的指标。但与点击率不同的是，转化信号很稀疏，而且往往有延迟。例如，电子商务网站用户可能在他们第一次开始浏览后的几个小时甚至几天都没有完成他们的订单。这种不确定的延误会给我们带来麻烦。</p><p id="e264" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在本文中，我们遵循在线广告行业的标准，将CVR定义为导致转化(例如购买)的点击百分比。</p><h2 id="d20d" class="nk kx iq bd ky nl nm dn lc nn no dp lg lx np nq li mb nr ns lk mf nt nu lm nv bi translated">天真的CVR</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/0f7559ac876b2751a2749c73e696181c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1040/format:webp/1*D3x4I3M62pZz4Pw8QjLx-A.png"/></div></figure><p id="d4e3" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这是业内人士通常使用的。这个CVR公式的问题是，在我们计算它的值的任何时候，我们都会错过所有被延迟且尚未观察到的转换。所以这个天真的CVR会低估真正的CVR。</p><p id="fa7e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们可以在下面的例子中看到这一点。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nx"><img src="../Images/154ec71b17fd493bb7c71a1af1cbf9d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QgcsatemaKB3cuGKR46DwQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="a322" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在这个简单的实验中，我们模拟了真实CVR等于0.5的情况，并假设所有转换在点击后总是延迟1小时。显然，在实践中，转换延迟不会这么简单，但本例中的逻辑同样适用。</p><p id="98e4" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">例如，为了计算t2时的简单CVR，我们需要将所有橙色条作为分子相加，将所有灰色条作为分母相加。计算出的原始CVR由图中的红线表示。显然，它低估了真正的CVR。</p><p id="dcd3" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">下面的代码创建了一个更通用的模拟器。它产生具有指数延迟分布的转换，并跟踪转换随时间的可观测性。这个模拟器以后可以用来测试我们的Bandit代码。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><h2 id="4a95" class="nk kx iq bd ky nl nm dn lc nn no dp lg lx np nq li mb nr ns lk mf nt nu lm nv bi translated">纠正CVR</h2><p id="10da" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在上面的例子中，纠正低估的一种方法是在计算t2的CVR时，只使用t0和t1的灰条作为分母。然后，修正的CVR估计等于0.5，这是潜在的事实。</p><p id="5788" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这种补救措施能够奏效的原因是，我们知道在t2的点击没有任何机会在t2产生转化(它们相应的转化只能在1小时后观察到)。所以t2时的那些点击不应该包括在分母中。图中的绿线是使用这种思想计算的，并且恢复了t0之后的真实CVR。</p><p id="e281" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这种方法可以推广到更复杂的情况，其中延迟是随机的，并遵循一般的延迟分布(其CDF表示为τ)</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/1bcd42190449599f816a73bf83236c2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1108/format:webp/1*eU5QO7WWT2npAGtUXYJcBw.png"/></div></figure><p id="99ed" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">简单来说，我们要对点击进行重新加权来计算有效点击，一次点击的权重是基于从点击到现在观察到其转化的概率。最近点击越多，权重越低。</p><p id="c183" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">如果延迟分布已知，这个公式可以证明是一个无偏估计量。</p><h2 id="8243" class="nk kx iq bd ky nl nm dn lc nn no dp lg lx np nq li mb nr ns lk mf nt nu lm nv bi translated">估计延迟分布的挑战</h2><p id="adee" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">实际上，我们不知道真实的延迟分布是什么。在本节中，我们将讨论估计延迟分布的挑战。</p><p id="e5ca" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在实验过程中，观察到的延迟是右删失的。这意味着，如果我们绘制转换延迟直方图，我们无法观察到超过某个阈值的延迟。就像下面的例子，</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/e644c97866375da51d202320a24ab152.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vmC2N8PET5RgDIme.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="42b5" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">本例中，我们试图估算t=1000时的延迟分布，只能观察到小于1000的转换延迟。</p><p id="081c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">当延迟等于1000时，图中有一个尖峰。那些是还没有转化的点击。这些点击有两种可能的结果。要么它们将在未来转换，意味着具有大于1000的延迟；或者它们永远不会导致转换，相当于有一个无限长的延迟。图中的红色阴影标记了这些未转换。</p><p id="f264" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们只对估计蓝色样本的延迟分布感兴趣。如果红色部分可以排除，估计相对容易做(这是标准的生存分析)。不幸的是，在实验过程中，没有办法区分这两种可能性，除非我们知道真正的最终CVR。</p><p id="470c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">但是最终的CVR是我们想要估计的。我们兜了一圈回来了！</p><h1 id="5ddd" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">如何和CVR一起管理MAB</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/a1f2eee6e8d48c542bd10194e7f533ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vO_TeUkNr7ZkCua3.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="ec5b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们提出的系统的概述已在上面介绍过了。有两个与算法相关的主要组件。第一个部分将点击和转换日志作为输入，并估计实验中每个处理组的CVRs。第二组件基于来自第一组件的所有估计的CVR来计算分配概率。如果不满足停止规则，将根据分配概率向用户显示新广告。然后重复该过程。</p><h2 id="4fb0" class="nk kx iq bd ky nl nm dn lc nn no dp lg lx np nq li mb nr ns lk mf nt nu lm nv bi translated">CVR估计</h2><p id="5732" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在第一部分中，我们使用<a class="ae kv" href="https://en.wikipedia.org/wiki/Expectation%E2%80%93maximization_algorithm" rel="noopener ugc nofollow" target="_blank">期望最大化</a>方法来获得每个实验组的CVR估计值。</p><p id="67b8" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">首先，我们假设延迟分布是指数分布的，对于每个实验组k由λk参数化。</p><p id="acbe" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">对于每个组k，收集组k中的所有点击。首先计算I跟随的每个点击的权重</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi od"><img src="../Images/5a8036e63f7931bb10af2b4473644d44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1364/format:webp/1*XkkzUgQmmEncrSlxwqRJUg.png"/></div></figure><p id="a67c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">然后更新估计值</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/eab41cfe3ad30af2d93657253e9485c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1340/format:webp/1*IpQBg6sWQujpXAUQeDKExg.png"/></div></figure><p id="e32f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在哪里</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi of"><img src="../Images/d6a018dcbe1208df9568a5d638fb3607.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5w0wjWBRAOpjEUdSdsu2Zw.png"/></div></div></figure><p id="8be3" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在每个时间步长t，我们将上面定义的E-M计算迭代几个周期，以确保得到的估计是稳定的。设L代表循环总数。然后保存每个时间步长的最终估计，并用作下一个时间步长的先验，即</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi og"><img src="../Images/8bdcf2a9d3cd13c72cf7cef9d2e0e8b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1008/format:webp/1*k61btNh7F2tacJitkDl0uw.png"/></div></figure><p id="55aa" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">下面的代码提供了该过程的一个示例实现。每个Arm类对应于上面描述的一个组，负责获取相关的日志数据，并获得λ和θ的估计值。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><h2 id="48a5" class="nk kx iq bd ky nl nm dn lc nn no dp lg lx np nq li mb nr ns lk mf nt nu lm nv bi translated">汤普森取样</h2><p id="9ff5" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">一旦我们得到每个组的估计CVR，我们就可以使用Thompson抽样来计算分配概率。</p><p id="3690" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">为了使用Thompson抽样，我们需要知道估计CVR的分布。因为从EM过程中得到它不是微不足道的，所以我们采用启发式方法来假设每个组k的CVR</p><p id="e9fa" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在时间t遵循β分布，β(αkt，βkt)。参数更新如下:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/d417e4c7b656bc92fe049161836d10f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1212/format:webp/1*GJPd66tDTGAVbtYbq9Wxlg.png"/></div></figure><p id="53ab" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">简单来说，βkt等于有效点击次数+ 1。</p><p id="9005" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">一个组的分配概率是该组提供最高期望CVR的后验概率。我们使用蒙特卡罗模拟来计算这些值。</p><p id="c969" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">αkt和βkt更新和β采样的代码嵌入在上面的Arm类中。通过调用每个分支的<code class="fe oi oj ok ol b">draw_beta_sample</code>方法，我们可以如下计算分配概率。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="b68b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">下图总结了指数分布延迟方法的整个过程。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi om"><img src="../Images/08ac6244ccdad6d60b7ac1ae21107c20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*sqZgUnAG1wRyrqGH.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><h1 id="3ff7" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">结论</h1><p id="8d39" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">这就是了。现在你可以开始用CVR度规运行你的多臂强盗实验了。这篇文章是基于我们的论文<a class="ae kv" href="https://arxiv.org/pdf/2202.00846.pdf" rel="noopener ugc nofollow" target="_blank">延迟二进制反馈的适应性实验</a>而写的。如果您想假设除指数分布之外的延迟分布，或者使用其他类型的延迟反馈，您可以在本文中找到更多讨论。对于本文中显示的完整代码，您可以在这里找到它们<a class="ae kv" href="https://gist.github.com/znwang25/490545dbe762dcfdae5329b2e2fa120d#file-everything_in_a_file-py" rel="noopener ugc nofollow" target="_blank">。</a></p></div></div>    
</body>
</html>