<html>
<head>
<title>How To Setup HashiCorp Vault with Airflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用气流设置HashiCorp保险库</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/hashicorp-vault-airflow-cfdddab31ea#2022-06-03">https://towardsdatascience.com/hashicorp-vault-airflow-cfdddab31ea#2022-06-03</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="f891" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">将HashiCorp Vault与Apache Airflow集成</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/96875f324d1aa23fd52e0ec25a2577a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KL19CtrG03XqQ-bUvNXh0g.jpeg"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">照片由<a class="ae kz" href="https://unsplash.com/@cristina_gottardi?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">克里斯蒂娜·戈塔迪</a>在<a class="ae kz" href="https://unsplash.com/s/photos/lock?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h2 id="69c5" class="la lb iu bd lc ld le dn lf lg lh dp li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">介绍</h2><p id="33f2" class="pw-post-body-paragraph lw lx iu ly b lz ma jv mb mc md jy me lj mf mg mh ln mi mj mk lr ml mm mn mo in bi translated">默认情况下，Apache Airflow从元数据数据库中读取连接和变量，该数据库实际上存储了Airflow UI的相应选项卡上可见的所有内容。</p><p id="f5ac" class="pw-post-body-paragraph lw lx iu ly b lz mp jv mb mc mq jy me lj mr mg mh ln ms mj mk lr mt mm mn mo in bi translated">尽管通过UI添加(或删除)连接和变量(并因此将它们存储在也提供静态加密的元数据数据库中)绝对没有什么特别的问题，但有时将Airflow连接到一个中央秘密管理工具可能更容易管理，该工具也被组织中的其他工具使用。</p><p id="8140" class="pw-post-body-paragraph lw lx iu ly b lz mp jv mb mc mq jy me lj mr mg mh ln ms mj mk lr mt mm mn mo in bi translated">这种方法将从本质上帮助您以更有效的方式管理您的秘密，这样无论何时发生变化，它都会反映在实际读取该秘密的每个工具上，因此您不必手动更新相应系统上的每个秘密(例如Airflow)。</p><p id="0443" class="pw-post-body-paragraph lw lx iu ly b lz mp jv mb mc mq jy me lj mr mg mh ln ms mj mk lr mt mm mn mo in bi translated">在今天的教程中，我们将展示如何将HashiCorp Vault(最常用的秘密管理工具之一)与Apache Airflow连接。</p></div><div class="ab cl mu mv hy mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="in io ip iq ir"><h2 id="07fb" class="la lb iu bd lc ld le dn lf lg lh dp li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">步骤1:更新airflow.cfg文件</h2><p id="0a43" class="pw-post-body-paragraph lw lx iu ly b lz ma jv mb mc md jy me lj mf mg mh ln mi mj mk lr ml mm mn mo in bi translated">为了将HashiCorp Vault与Airflow集成，以便后者从前者检索连接和变量，我们需要将<code class="fe nb nc nd ne b"><a class="ae kz" href="https://airflow.apache.org/docs/apache-airflow-providers-hashicorp/stable/_api/airflow/providers/hashicorp/secrets/vault/index.html#airflow.providers.hashicorp.secrets.vault.VaultBackend" rel="noopener ugc nofollow" target="_blank"><strong class="ly iv">VaultBackend</strong></a></code>指定为<code class="fe nb nc nd ne b">airflow.cfg</code>的<code class="fe nb nc nd ne b">[secrets]</code>部分中的<code class="fe nb nc nd ne b">backend</code>。</p><pre class="kk kl km kn gu nf ne ng nh aw ni bi"><span id="1a3b" class="la lb iu ne b gz nj nk l nl nm"><strong class="ne iv">[secrets]</strong><br/>backend = airflow.providers.hashicorp.secrets.vault.VaultBackend<br/>backend_kwargs = {<br/>    "connections_path": "connections",<br/>    "variables_path": "variables",<br/>    "url": "http://127.0.0.1:8200",<br/>    "mount_point": "airflow",<br/>}</span></pre><p id="b42a" class="pw-post-body-paragraph lw lx iu ly b lz mp jv mb mc mq jy me lj mr mg mh ln ms mj mk lr mt mm mn mo in bi translated">上述配置假设您的气流连接作为秘密存储在<code class="fe nb nc nd ne b">airflow</code> mount_path和路径<code class="fe nb nc nd ne b">connections</code>(即<code class="fe nb nc nd ne b">airflow/connections</code>)下。同样，您的变量存储在<code class="fe nb nc nd ne b">airflow/variables</code>下。</p><p id="d56f" class="pw-post-body-paragraph lw lx iu ly b lz mp jv mb mc mq jy me lj mr mg mh ln ms mj mk lr mt mm mn mo in bi translated">您还应该确保指定允许您在Airflow和Vault之间执行身份验证的附加参数。例如，您可能需要传递<code class="fe nb nc nd ne b">approle</code>、<code class="fe nb nc nd ne b">role_id</code>和<code class="fe nb nc nd ne b">secret_id</code>参数(或者可能是<code class="fe nb nc nd ne b">token</code>参数)。你可以在这里看到可用参数的完整列表。</p></div><div class="ab cl mu mv hy mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="in io ip iq ir"><h2 id="38a7" class="la lb iu bd lc ld le dn lf lg lh dp li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">步骤2:将连接作为机密添加到Vault</h2><p id="b45f" class="pw-post-body-paragraph lw lx iu ly b lz ma jv mb mc md jy me lj mf mg mh ln mi mj mk lr ml mm mn mo in bi translated">连接库应存放在气流配置中指定的<code class="fe nb nc nd ne b">connections_path</code>中，如上一步所示。</p><p id="c76f" class="pw-post-body-paragraph lw lx iu ly b lz mp jv mb mc mq jy me lj mr mg mh ln ms mj mk lr mt mm mn mo in bi translated">对于每个连接，您必须创建一个至少包含以下密钥之一的存储库密码:</p><ul class=""><li id="dd38" class="nn no iu ly b lz mp mc mq lj np ln nq lr nr mo ns nt nu nv bi translated"><code class="fe nb nc nd ne b"><strong class="ly iv">conn_id</strong></code> ( <code class="fe nb nc nd ne b">str</code> ) -连接ID。</li><li id="6fb4" class="nn no iu ly b lz nw mc nx lj ny ln nz lr oa mo ns nt nu nv bi translated"><code class="fe nb nc nd ne b"><strong class="ly iv">conn_type</strong></code> ( <code class="fe nb nc nd ne b">str</code> ) -连接类型。</li><li id="c2f7" class="nn no iu ly b lz nw mc nx lj ny ln nz lr oa mo ns nt nu nv bi translated"><code class="fe nb nc nd ne b"><strong class="ly iv">description</strong></code> ( <code class="fe nb nc nd ne b">str</code> ) -连接描述。</li><li id="14ad" class="nn no iu ly b lz nw mc nx lj ny ln nz lr oa mo ns nt nu nv bi translated"><code class="fe nb nc nd ne b"><strong class="ly iv">host</strong></code>(<code class="fe nb nc nd ne b">str</code>)——主持人。</li><li id="ecc9" class="nn no iu ly b lz nw mc nx lj ny ln nz lr oa mo ns nt nu nv bi translated"><code class="fe nb nc nd ne b"><strong class="ly iv">login</strong></code> ( <code class="fe nb nc nd ne b">str</code> ) -登录。</li><li id="ff70" class="nn no iu ly b lz nw mc nx lj ny ln nz lr oa mo ns nt nu nv bi translated"><code class="fe nb nc nd ne b"><strong class="ly iv">password</strong></code>(<code class="fe nb nc nd ne b">str</code>)——密码。</li><li id="3773" class="nn no iu ly b lz nw mc nx lj ny ln nz lr oa mo ns nt nu nv bi translated"><code class="fe nb nc nd ne b"><strong class="ly iv">schema</strong></code> ( <code class="fe nb nc nd ne b">str</code> ) -模式。</li><li id="e759" class="nn no iu ly b lz nw mc nx lj ny ln nz lr oa mo ns nt nu nv bi translated"><code class="fe nb nc nd ne b"><strong class="ly iv">port</strong></code> ( <code class="fe nb nc nd ne b">int</code> ) -端口号。</li><li id="d1a7" class="nn no iu ly b lz nw mc nx lj ny ln nz lr oa mo ns nt nu nv bi translated"><code class="fe nb nc nd ne b"><strong class="ly iv">extra</strong></code> ( <code class="fe nb nc nd ne b">Union[str, dict]</code> ) -额外元数据。私有/SSH密钥等非标准数据可以保存在这里。JSON编码的对象。</li><li id="3dfc" class="nn no iu ly b lz nw mc nx lj ny ln nz lr oa mo ns nt nu nv bi translated"><code class="fe nb nc nd ne b"><strong class="ly iv">uri</strong></code> ( <code class="fe nb nc nd ne b">str</code> ) -描述连接参数的URI地址。</li></ul><p id="a1bf" class="pw-post-body-paragraph lw lx iu ly b lz mp jv mb mc mq jy me lj mr mg mh ln ms mj mk lr mt mm mn mo in bi translated">这是因为机密的内容应该与提供的应该与<code class="fe nb nc nd ne b"><a class="ae kz" href="https://airflow.apache.org/docs/apache-airflow/stable/_api/airflow/models/connection/index.html#airflow.models.connection.Connection" rel="noopener ugc nofollow" target="_blank">airflow.models.connections.Connection</a></code>类的预期参数对齐。</p></div><div class="ab cl mu mv hy mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="in io ip iq ir"><h2 id="d67c" class="la lb iu bd lc ld le dn lf lg lh dp li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">步骤3:添加变量作为Vault机密</h2><p id="676d" class="pw-post-body-paragraph lw lx iu ly b lz ma jv mb mc md jy me lj mf mg mh ln mi mj mk lr ml mm mn mo in bi translated">现在进入变量，当你把它们作为秘密添加到vault中时，你应该小心一点，因为预期的格式可能不像你通常预期的那样直接。</p><p id="ba69" class="pw-post-body-paragraph lw lx iu ly b lz mp jv mb mc mq jy me lj mr mg mh ln ms mj mk lr mt mm mn mo in bi translated">让我们假设在<code class="fe nb nc nd ne b">airflow.cfg</code>中，你已经将<code class="fe nb nc nd ne b">variables_path</code>指定为<code class="fe nb nc nd ne b">variables</code>，将<code class="fe nb nc nd ne b">mount_point</code>指定为<code class="fe nb nc nd ne b">airflow</code>。如果您希望存储一个名为<code class="fe nb nc nd ne b">my_var</code>的变量，其值为<code class="fe nb nc nd ne b">hello</code>，那么您必须将秘密存储为:</p><pre class="kk kl km kn gu nf ne ng nh aw ni bi"><span id="de42" class="la lb iu ne b gz nj nk l nl nm">vault kv put airflow/variables/my_var value=hello</span></pre><p id="1ff2" class="pw-post-body-paragraph lw lx iu ly b lz mp jv mb mc mq jy me lj mr mg mh ln ms mj mk lr mt mm mn mo in bi translated">注意，秘密<code class="fe nb nc nd ne b">Key</code>是<code class="fe nb nc nd ne b">value</code>，秘密<code class="fe nb nc nd ne b">Value</code>是<code class="fe nb nc nd ne b">hello</code>！</p></div><div class="ab cl mu mv hy mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="in io ip iq ir"><h2 id="6546" class="la lb iu bd lc ld le dn lf lg lh dp li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">步骤4:访问气流Dag中的连接</h2><p id="edde" class="pw-post-body-paragraph lw lx iu ly b lz ma jv mb mc md jy me lj mf mg mh ln mi mj mk lr ml mm mn mo in bi translated">您可以使用以下代码来访问作为Vault机密存储的Airflow连接，并观察其详细信息:</p><pre class="kk kl km kn gu nf ne ng nh aw ni bi"><span id="f906" class="la lb iu ne b gz nj nk l nl nm">import json <br/>import logging  </span><span id="7388" class="la lb iu ne b gz ob nk l nl nm">from airflow.hooks.base_hook import BaseHook   </span><span id="f7eb" class="la lb iu ne b gz ob nk l nl nm">conn = BaseHook.get_connection('secret_name') <br/>logging.info(     <br/>    f'Login: {conn.login}'     <br/>    f'Password: {conn.password}'     <br/>    f'URI: {conn.get_uri()}'     <br/>    f'Host: {conn.host}'     <br/>    f'Extra: " {json.loads(conn.get_extra())}'   <br/>    # ... <br/>)</span></pre><p id="3901" class="pw-post-body-paragraph lw lx iu ly b lz mp jv mb mc mq jy me lj mr mg mh ln ms mj mk lr mt mm mn mo in bi translated">请注意，将首先搜索存储库机密，然后是环境变量，最后是metastore(即通过Airflow UI添加的连接)。这种搜索顺序是不可配置的。</p></div><div class="ab cl mu mv hy mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="in io ip iq ir"><h2 id="e410" class="la lb iu bd lc ld le dn lf lg lh dp li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">步骤5:访问气流Dag中的变量</h2><p id="c850" class="pw-post-body-paragraph lw lx iu ly b lz ma jv mb mc md jy me lj mf mg mh ln mi mj mk lr ml mm mn mo in bi translated">同样，以下代码片段将帮助您检索存储在Vault中的变量值:</p><pre class="kk kl km kn gu nf ne ng nh aw ni bi"><span id="945c" class="la lb iu ne b gz nj nk l nl nm">import logging  </span><span id="69c7" class="la lb iu ne b gz ob nk l nl nm">from airflow.models import Variable   </span><span id="f09e" class="la lb iu ne b gz ob nk l nl nm">my_var = Variable.get('var_name') <br/>logging.info(f'var_name value: {my_var}')</span></pre></div><div class="ab cl mu mv hy mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="in io ip iq ir"><h2 id="1ab8" class="la lb iu bd lc ld le dn lf lg lh dp li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">步骤6:使用DAG测试存储集成</h2><p id="33a1" class="pw-post-body-paragraph lw lx iu ly b lz ma jv mb mc md jy me lj mf mg mh ln mi mj mk lr ml mm mn mo in bi translated">在下面的代码片段中，您可以找到一个示例Airflow DAG，您可以使用它来测试Airflow是否可以从<code class="fe nb nc nd ne b">airflow.cfg</code>文件中指定的Vault中正确读取变量和连接。</p><pre class="kk kl km kn gu nf ne ng nh aw ni bi"><span id="aae7" class="la lb iu ne b gz nj nk l nl nm">import logging <br/>from datetime import datetime  </span><span id="c249" class="la lb iu ne b gz ob nk l nl nm">from airflow import DAG <br/>from airflow.models import Variable <br/>from airflow.hooks.base_hook import BaseHook <br/>from airflow.operators.python_operator import PythonOperator<br/></span><span id="74bc" class="la lb iu ne b gz ob nk l nl nm">def get_secrets(**kwargs):<br/>     <br/>    # Test connections   <br/>    conn = BaseHook.get_connection(kwargs['my_conn_id'])<br/>    logging.info(<br/>        f"Password: {conn.password}, Login: {conn.login}, "<br/>        f"URI: {conn.get_uri()}, Host: {conn.host}"<br/>    )        </span><span id="4319" class="la lb iu ne b gz ob nk l nl nm">    # Test variables     <br/>    test_var = Variable.get(kwargs['var_name'])<br/>    logging.info(f'my_var_name: {test_var}')</span><span id="9b9b" class="la lb iu ne b gz ob nk l nl nm">with DAG(   <br/>    'test_vault_connection',    <br/>    start_date=datetime(2020, 1, 1),    <br/>    schedule_interval=None<br/>) as dag:      <br/>    test_task = PythonOperator(         <br/>        task_id='test-task',         <br/>        python_callable=get_secrets,         <br/>        op_kwargs={<br/>            'my_conn_id': 'connection_to_test',<br/>            'var_name': 'my_test_var',<br/>        },     <br/>    )</span></pre></div><div class="ab cl mu mv hy mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="in io ip iq ir"><h2 id="e276" class="la lb iu bd lc ld le dn lf lg lh dp li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">最后的想法</h2><p id="f311" class="pw-post-body-paragraph lw lx iu ly b lz ma jv mb mc md jy me lj mf mg mh ln mi mj mk lr ml mm mn mo in bi translated">在今天的教程中，我们展示了如何配置HashiCorp Vault，以便被Apache Airflow用作主要的后端秘密存储。然后，我们演示了如何向保险库添加连接和密码。</p><p id="4a30" class="pw-post-body-paragraph lw lx iu ly b lz mp jv mb mc mq jy me lj mr mg mh ln ms mj mk lr mt mm mn mo in bi translated">最后，我们通过几个实例演示了如何以编程方式从Vault中检索连接和变量，并在Airflow DAGs中使用它们。</p></div><div class="ab cl mu mv hy mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="in io ip iq ir"><p id="1b77" class="pw-post-body-paragraph lw lx iu ly b lz mp jv mb mc mq jy me lj mr mg mh ln ms mj mk lr mt mm mn mo in bi translated"><a class="ae kz" href="https://gmyrianthous.medium.com/membership" rel="noopener"> <strong class="ly iv">成为会员</strong> </a> <strong class="ly iv">阅读介质上的每一个故事。你的会员费直接支持我和你看的其他作家。你也可以在媒体上看到所有的故事。</strong></p><div class="oc od gq gs oe of"><a href="https://gmyrianthous.medium.com/membership" rel="noopener follow" target="_blank"><div class="og ab fp"><div class="oh ab oi cl cj oj"><h2 class="bd iv gz z fq ok fs ft ol fv fx it bi translated">通过我的推荐链接加入Medium-Giorgos Myrianthous</h2><div class="om l"><h3 class="bd b gz z fq ok fs ft ol fv fx dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="on l"><p class="bd b dl z fq ok fs ft ol fv fx dk translated">gmyrianthous.medium.com</p></div></div><div class="oo l"><div class="op l oq or os oo ot kt of"/></div></div></a></div></div><div class="ab cl mu mv hy mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="in io ip iq ir"><p id="676e" class="pw-post-body-paragraph lw lx iu ly b lz mp jv mb mc mq jy me lj mr mg mh ln ms mj mk lr mt mm mn mo in bi translated"><strong class="ly iv">相关文章你可能也喜欢</strong></p><div class="oc od gq gs oe of"><a rel="noopener follow" target="_blank" href="/run-airflow-docker-1b83a57616fb"><div class="og ab fp"><div class="oh ab oi cl cj oj"><h2 class="bd iv gz z fq ok fs ft ol fv fx it bi translated">如何使用Docker在本地运行气流</h2><div class="om l"><h3 class="bd b gz z fq ok fs ft ol fv fx dk translated">在本地机器上使用Docker运行Airflow的分步指南</h3></div><div class="on l"><p class="bd b dl z fq ok fs ft ol fv fx dk translated">towardsdatascience.com</p></div></div><div class="oo l"><div class="ou l oq or os oo ot kt of"/></div></div></a></div></div><div class="ab cl mu mv hy mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="in io ip iq ir"><div class="kk kl km kn gu of"><a rel="noopener follow" target="_blank" href="/connect-airflow-worker-gcp-e79690f3ecea"><div class="og ab fp"><div class="oh ab oi cl cj oj"><h2 class="bd iv gz z fq ok fs ft ol fv fx it bi translated">如何在Cloud Composer上连接到气流工作者</h2><div class="om l"><h3 class="bd b gz z fq ok fs ft ol fv fx dk translated">在谷歌云平台上连接气流工作者</h3></div><div class="on l"><p class="bd b dl z fq ok fs ft ol fv fx dk translated">towardsdatascience.com</p></div></div><div class="oo l"><div class="ov l oq or os oo ot kt of"/></div></div></a></div></div><div class="ab cl mu mv hy mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="in io ip iq ir"><div class="kk kl km kn gu of"><a rel="noopener follow" target="_blank" href="/environment-variables-python-aecb9bf01b85"><div class="og ab fp"><div class="oh ab oi cl cj oj"><h2 class="bd iv gz z fq ok fs ft ol fv fx it bi translated">在Python中与环境变量交互</h2><div class="om l"><h3 class="bd b gz z fq ok fs ft ol fv fx dk translated">使用Python访问、导出和取消设置环境变量</h3></div><div class="on l"><p class="bd b dl z fq ok fs ft ol fv fx dk translated">towardsdatascience.com</p></div></div><div class="oo l"><div class="ow l oq or os oo ot kt of"/></div></div></a></div></div></div>    
</body>
</html>