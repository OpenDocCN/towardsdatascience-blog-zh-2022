<html>
<head>
<title>Slowly Changing Dimension Type 2 with Google BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Google BigQuery 缓慢改变维度类型 2</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/slowly-changing-dimension-type-2-with-google-bigquery-749e0f9107fb#2022-11-10">https://towardsdatascience.com/slowly-changing-dimension-type-2-with-google-bigquery-749e0f9107fb#2022-11-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b811" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用 SQL MERGE 逐步实现 SCD 类型 2</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/d4ef2ff72043e83fb3a24e88f161dfbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*tK_wAgqqNWZ1Ab9Ki8CnZw.jpeg"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">图片来源于<a class="ae ku" href="https://unsplash.com/photos/HPjUkyhfVkY?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditShareLink" rel="noopener ugc nofollow" target="_blank">unsplash.com</a></p></figure><h1 id="2c1c" class="kv kw it bd kx ky kz la lb lc ld le lf jz lg ka lh kc li kd lj kf lk kg ll lm bi translated">摘要</h1><p id="ba51" class="pw-post-body-paragraph ln lo it lp b lq lr ju ls lt lu jx lv lw lx ly lz ma mb mc md me mf mg mh mi im bi translated">重要的是以一种允许管理变更的方式对数据建模，以便对诸如以下问题有一个快速的答案:</p><ul class=""><li id="48d9" class="mj mk it lp b lq ml lt mm lw mn ma mo me mp mi mq mr ms mt bi translated">变化是什么时候发生的？</li><li id="06b2" class="mj mk it lp b lq mu lt mv lw mw ma mx me my mi mq mr ms mt bi translated">现在还有效吗？</li><li id="2342" class="mj mk it lp b lq mu lt mv lw mw ma mx me my mi mq mr ms mt bi translated">以前怎么样？</li><li id="3025" class="mj mk it lp b lq mu lt mv lw mw ma mx me my mi mq mr ms mt bi translated">最终状态是什么？</li></ul><p id="ab86" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated">例如，如果您想跟踪过去几年的支出，然后您开始注意到，如果您按月做报告，则每年都会更改分类，这不会与按年的实际支出相匹配，但如果您有适当的分类维度，则可以拆分更改。</p><p id="b256" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated">在这篇文章中，我们将学习如何在<strong class="lp iu"> MERGE BigQuery </strong>实现中破解缺失的<strong class="lp iu">输出</strong>，以创建渐变维度<strong class="lp iu"> Type 2 </strong>，我将更详细地解释以下内容:</p><ol class=""><li id="8711" class="mj mk it lp b lq ml lt mm lw mn ma mo me mp mi nc mr ms mt bi translated">该设置</li><li id="7bb3" class="mj mk it lp b lq mu lt mv lw mw ma mx me my mi nc mr ms mt bi translated">SCD 型简介</li><li id="9ff6" class="mj mk it lp b lq mu lt mv lw mw ma mx me my mi nc mr ms mt bi translated">逐步执行</li><li id="ca84" class="mj mk it lp b lq mu lt mv lw mw ma mx me my mi nc mr ms mt bi translated">了解解决方案</li></ol><p id="3b55" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated">最后，我将添加<strong class="lp iu">结论、感谢、故障排除、</strong>和<strong class="lp iu">有用的资源。</strong></p><p id="ecfb" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated">如果您正在使用 Google Query，我建议您查看我以前的帖子，关于<a class="ae ku" rel="noopener" target="_blank" href="/run-bigquery-sql-using-python-api-client-b5287ac05b99">使用 Python API 客户端运行 big Query SQL</a>和<a class="ae ku" rel="noopener" target="_blank" href="/connecting-dbeaver-to-google-bigquery-23c8a12e55b5">将 DBeaver 连接到 Google BigQuery </a>，因为它们一步一步地详细介绍了如何创建和配置服务帐户以及如何避免 BigQuery Web 界面。</p></div><div class="ab cl nd ne hx nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="im in io ip iq"><h1 id="dcc2" class="kv kw it bd kx ky nk la lb lc nl le lf jz nm ka lh kc nn kd lj kf no kg ll lm bi translated">设置</h1><p id="8b27" class="pw-post-body-paragraph ln lo it lp b lq lr ju ls lt lu jx lv lw lx ly lz ma mb mc md me mf mg mh mi im bi translated">我们将使用两个表，<strong class="lp iu"> HR_INPUT，</strong>作为随时间变化的输入，而<strong class="lp iu"> EmployeeDim </strong>用于维度类型 2:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="aff2" class="nu kw it nq b gy nv nw l nx ny">CREATE OR REPLACE TABLE SCD.HR_INPUT (<br/>   ID         STRING NOT NULL<br/>  ,EMPLOYEE   STRING NOT NULL<br/>  ,JOB_TITLE  STRING NOT NULL<br/>  ,COMPANY    STRING NOT NULL<br/>  ,START_YEAR INTEGER NOT NULL<br/>);</span><span id="bae9" class="nu kw it nq b gy nz nw l nx ny">CREATE OR REPLACE TABLE SCD.EmployeeDim (<br/>   SKEY       STRING NOT NULL<br/>  ,ID         STRING NOT NULL<br/>  ,EMPLOYEE   STRING NOT NULL<br/>  ,JOB_TITLE  STRING NOT NULL<br/>  ,COMPANY    STRING NOT NULL<br/>  ,START_YEAR INTEGER NOT NULL<br/>  ,END_YEAR   INTEGER NOT NULL<br/>  ,ACTIVE     STRING NOT NULL<br/>  ,CREATED    TIMESTAMP NOT NULL<br/>  ,UPDATED    TIMESTAMP NOT NULL<br/>);</span></pre><p id="d917" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated">在 HR 输入表中，您将获得当前雇主，我们将模拟我们在不同的年份运行三次:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ob oc di od bf oe"><div class="gh gi oa"><img src="../Images/aa8ed84e7d8546e5e04e1ecb25915f88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7lvii27wKa__iCa-00SXqg.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">作者的例子</p></figure><p id="9837" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated">员工 Dim 的最终表格如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ob oc di od bf oe"><div class="gh gi of"><img src="../Images/223ea3f3388fc8bffadaac6ab3a16dae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IRX25SqgoB7YfU1dqrU55A.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">最终<strong class="bd og"> SCD。作者使用 Google BigQuery Web UI 查询 EmployeeDim </strong>结果</p></figure><p id="df4b" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated">此外，我们将使用存储<strong class="lp iu">过程 SP_EmployeeDim_SCD2 </strong>来使用 MERGE 处理数据:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="06ee" class="nu kw it nq b gy nv nw l nx ny">CREATE OR REPLACE PROCEDURE SCD.SP_EmployeeDim_SCD2()<br/>BEGIN<br/>  MERGE SCD.EmployeeDim AS output<br/>  USING (<br/>    SELECT src.ID as PSEUDO_ID, src.*<br/>      FROM SCD.HR_INPUT AS src<br/>    UNION ALL<br/>    SELECT NULL as PSEUDO_ID, dup.*<br/>      FROM SCD.HR_INPUT AS dup<br/>     INNER JOIN SCD.EmployeeDim AS trget ON dup.ID = trget.ID<br/>     WHERE trget.END_YEAR = 9999 <br/>       AND trget.START_YEAR &lt;&gt; dup.START_YEAR<br/>  ) AS input<br/>  ON input.PSEUDO_ID = output.ID</span><span id="1ce9" class="nu kw it nq b gy nz nw l nx ny">  WHEN NOT MATCHED THEN</span><span id="1a11" class="nu kw it nq b gy nz nw l nx ny">  INSERT (SKEY,ID,EMPLOYEE,JOB_TITLE,COMPANY,START_YEAR<br/>          ,END_YEAR,ACTIVE,CREATED,UPDATED)<br/>  VALUES ( GENERATE_UUID()<br/>          ,input.ID<br/>          ,input.EMPLOYEE<br/>          ,input.JOB_TITLE<br/>          ,input.COMPANY<br/>          ,input.START_YEAR<br/>          ,9999<br/>          ,'Y'<br/>          ,CURRENT_TIMESTAMP()<br/>          ,CURRENT_TIMESTAMP()<br/>  )</span><span id="630d" class="nu kw it nq b gy nz nw l nx ny">  WHEN MATCHED <br/>   AND output.END_YEAR = 9999<br/>   AND output.START_YEAR &lt;&gt; input.START_YEAR THEN</span><span id="99af" class="nu kw it nq b gy nz nw l nx ny">  UPDATE  SET ACTIVE = 'N'<br/>         ,END_YEAR = input.START_YEAR<br/>         ,UPDATED = CURRENT_TIMESTAMP()<br/>  ;</span><span id="4f20" class="nu kw it nq b gy nz nw l nx ny">END;</span></pre></div><div class="ab cl nd ne hx nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="im in io ip iq"><h1 id="327a" class="kv kw it bd kx ky nk la lb lc nl le lf jz nm ka lh kc nn kd lj kf no kg ll lm bi translated">SCD 型简介</h1><p id="6fa7" class="pw-post-body-paragraph ln lo it lp b lq lr ju ls lt lu jx lv lw lx ly lz ma mb mc md me mf mg mh mi im bi translated">在数据建模中，<a class="ae ku" href="https://www.kimballgroup.com/2008/08/slowly-changing-dimensions/" rel="noopener ugc nofollow" target="_blank">渐变维度</a>是实现维度表中历史变化跟踪的重要部分。</p><p id="c738" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated"><a class="ae ku" href="https://www.kimballgroup.com/2008/09/slowly-changing-dimensions-part-2/" rel="noopener ugc nofollow" target="_blank"> SCD Type 2 </a>的美妙之处在于，它允许我们看到数据发生时的状态，并将其视为当前活动状态。</p><p id="831f" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated">例如，假设您有财务分类和与每笔交易相关的支出。在这种情况下，如果我们没有正确地跟踪变化，就很容易陷入部门之间的战争。</p><p id="8968" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated">使用 SCD Type 2，我们可以看到上一版本的分类所花费的全年时间，而且我们可以逐月检查它是如何定义的，这有助于我们解释为什么一个区域花费了更多的钱。</p></div><div class="ab cl nd ne hx nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="im in io ip iq"><h1 id="918c" class="kv kw it bd kx ky nk la lb lc nl le lf jz nm ka lh kc nn kd lj kf no kg ll lm bi translated">逐步执行</h1><p id="8c35" class="pw-post-body-paragraph ln lo it lp b lq lr ju ls lt lu jx lv lw lx ly lz ma mb mc md me mf mg mh mi im bi translated"><strong class="lp iu"> <em class="oh">首先是</em> </strong>，让我们删除两个表中的所有数据，重新开始:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="4e49" class="nu kw it nq b gy nv nw l nx ny">TRUNCATE TABLE SCD.EmployeeDim;<br/>TRUNCATE TABLE SCD.HR_INPUT;</span></pre><p id="696b" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated"><strong class="lp iu"> <em class="oh">第二个</em> </strong>，我们将假设我们在 2008 年，数据源使用下面的 INSERT 语句反映了我作为<strong class="lp iu">数据仓库架构师</strong>的当前工作:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="cc55" class="nu kw it nq b gy nv nw l nx ny">INSERT INTO SCD.HR_INPUT VALUES ('123456','Cristian Saavedra Desmoineaux','Data Warehouse Architect','MILLICOM/TIGO',2008);</span><span id="7e26" class="nu kw it nq b gy nz nw l nx ny">SELECT * FROM SCD.HR_INPUT;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/4cf9d4ea35caed01c1ea446f15600255.png" data-original-src="https://miro.medium.com/v2/resize:fit:712/format:webp/1*WpWXj8bPWQ4pFrdMP7unMg.png"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated"><strong class="bd og"> SCD。HR_INPUT </strong>作者使用 Google BigQuery Web UI 查询的结果</p></figure><p id="7b03" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated">然后，我们将调用存储过程<strong class="lp iu"> SP_EmployeeDim_SCD2 </strong>在 EmployeeDim 表中插入第一行，从 2008 年开始，到 9999 年结束:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="b9ef" class="nu kw it nq b gy nv nw l nx ny">CALL SCD.SP_EmployeeDim_SCD2();</span><span id="85ee" class="nu kw it nq b gy nz nw l nx ny">SELECT * FROM SCD.EmployeeDim;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/54010496484613105542c306b95759ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:678/format:webp/1*oXzfK6oOxEkdhSdab38NjA.png"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated"><strong class="bd og"> SCD。作者使用 Google BigQuery Web UI 进行的 EmployeeDim </strong>结果查询</p></figure><p id="de2c" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated"><strong class="lp iu"> <em class="oh">第三个</em> </strong>，我们将假设我们是在 2009 年，而输入的数据没有改变它:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="3bed" class="nu kw it nq b gy nv nw l nx ny">CALL SCD.SP_EmployeeDim_SCD2();</span></pre><p id="02f5" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated">如您所见，<strong class="lp iu"> EmployeeDim </strong>表也没有改变:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/a1fd54d4042fb97a467fccf140ca6c53.png" data-original-src="https://miro.medium.com/v2/resize:fit:706/format:webp/1*VGZQz2Z2e9bwrWYUY2xciw.png"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated"><strong class="bd og"> SCD。作者使用 Google BigQuery Web UI 第二次运行该过程后的 EmployeeDim </strong>结果查询</p></figure><p id="f931" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated"><strong class="lp iu"> <em class="oh">第四个</em> </strong>，我们假设我们在 2021 年，数据源显示我在 REEF Technologies 工作时的当前工作，我们运行存储过程<strong class="lp iu"> SP_EmployeeDim_SCD2 </strong>:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="2f9a" class="nu kw it nq b gy nv nw l nx ny">TRUNCATE TABLE SCD.HR_INPUT;</span><span id="eaf4" class="nu kw it nq b gy nz nw l nx ny">INSERT INTO SCD.HR_INPUT VALUES ('123456','Cristian Saavedra Desmoineaux','Senior Business Intelligence Engineer - Manager II','REEF Technology',2021);</span><span id="d259" class="nu kw it nq b gy nz nw l nx ny">SELECT * FROM SCD.HR_INPUT;</span><span id="4de4" class="nu kw it nq b gy nz nw l nx ny">CALL SCD.SP_EmployeeDim_SCD2();</span><span id="aa3f" class="nu kw it nq b gy nz nw l nx ny">SELECT * FROM SCD.EmployeeDim;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/38767b14786e2f03d25530d57d409e38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1020/format:webp/1*a5BGi1ePZs437rpF_XnBcQ.png"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated"><strong class="bd og"> SCD。HR_INPUT </strong>作者使用 Google BigQuery Web UI 第二次修改后的结果查询</p></figure><p id="c27c" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated">现在我们有两张唱片了。之前的记录从 2008 年到 2021 年有效，并且无效:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi om"><img src="../Images/84986cede735f72a7487d363287fe4cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:984/format:webp/1*gh46XiasKYQEjwwU7EFQeQ.png"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated"><strong class="bd og"> SCD。EmployeeDim </strong>作者使用 Google BigQuery Web UI 第三次运行该过程后的结果查询</p></figure><p id="efa3" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated"><strong class="lp iu"> <em class="oh">第五个</em> </strong>，现在我们是 2022 年，HR 输入表反映了我现在的角色:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="4562" class="nu kw it nq b gy nv nw l nx ny">TRUNCATE TABLE SCD.HR_INPUT;</span><span id="90d7" class="nu kw it nq b gy nz nw l nx ny">INSERT INTO SCD.HR_INPUT VALUES ('123456','Cristian Saavedra Desmoineaux','Manager, Data &amp; Analytics','Cardinal Health',2022);</span><span id="3e00" class="nu kw it nq b gy nz nw l nx ny">SELECT * FROM SCD.HR_INPUT;</span><span id="0539" class="nu kw it nq b gy nz nw l nx ny">CALL SCD.SP_EmployeeDim_SCD2();</span><span id="5566" class="nu kw it nq b gy nz nw l nx ny">SELECT * FROM SCD.EmployeeDim;</span></pre><p id="a98e" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated">我们在 HR 输入表中只看到一条记录:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi on"><img src="../Images/d6815931e66516e5e0bf98406fb61776.png" data-original-src="https://miro.medium.com/v2/resize:fit:688/format:webp/1*BRtf_MiiTu0n-hMEXZYXYw.png"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated"><strong class="bd og"> SCD。HR_INPUT </strong>作者使用 Google BigQuery Web UI 第三次修改后的结果查询</p></figure><p id="ef2e" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated">和 Employee 维度中的三个记录，显示我的当前记录为活动记录，其余记录为非活动记录:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/2d6b0ac9e2fe4d8f5fdad0a1f10ba6e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1008/format:webp/1*0HJ5hAmaBhltpu5qyovS-g.png"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated"><strong class="bd og"> SCD。EmployeeDim </strong>由作者使用 Google BigQuery Web UI 运行福特时间的过程后的结果查询</p></figure></div><div class="ab cl nd ne hx nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="im in io ip iq"><h1 id="80f6" class="kv kw it bd kx ky nk la lb lc nl le lf jz nm ka lh kc nn kd lj kf no kg ll lm bi translated">了解解决方案</h1><p id="1d69" class="pw-post-body-paragraph ln lo it lp b lq lr ju ls lt lu jx lv lw lx ly lz ma mb mc md me mf mg mh mi im bi translated">首先，让我们看一下 SP_EmployeeDim_SCD2 存储过程:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ob oc di od bf oe"><div class="gh gi op"><img src="../Images/6d48c29cf6d25a3a040cd7833260c1cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3-IR03ZKxBiX0RKtDCMCbA.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">作者使用 Google BigQuery Web UI 创建的存储过程</p></figure><p id="1954" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated">如您所见，有一个 MERGE 语句说:</p><blockquote class="oq or os"><p id="191c" class="ln lo oh lp b lq ml ju ls lt mm jx lv ot mz ly lz ou na mc md ov nb mg mh mi im bi translated">尝试将维度与数据源合并，如果伪 ID 不匹配，则插入一个<strong class="lp iu">新行</strong>，否则更新为<strong class="lp iu">无效</strong>，并添加年末</p></blockquote><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="13f2" class="nu kw it nq b gy nv nw l nx ny">MERGE SCD.EmployeeDim AS output <br/>USING (&lt;... subquery ...&gt;) AS input <br/>ON input.PSEUDO_ID = output.ID</span><span id="c5ea" class="nu kw it nq b gy nz nw l nx ny">WHEN NOT MATCHED THEN<br/>INSERT (&lt;... columns ...&gt;)<br/>VALUES (GENERATE_UUID(),&lt;... all data ...&gt;,9999,'Y'<br/>,CURRENT_TIMESTAMP(),CURRENT_TIMESTAMP())</span><span id="1ab5" class="nu kw it nq b gy nz nw l nx ny">WHEN MATCHED AND output.END_YEAR = 9999<br/>     AND output.START_YEAR &lt;&gt; input.START_YEAR THEN</span><span id="5c77" class="nu kw it nq b gy nz nw l nx ny">UPDATE SET ACTIVE = 'N', END_YEAR = input.START_YEAR, UPDATED = CURRENT_TIMESTAMP()</span></pre><p id="9853" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated">当不匹配时，我们从 HR 输入表中取出<strong class="lp iu">的所有数据</strong>，使用 GENERATE_UUID()函数添加一个<a class="ae ku" href="https://www.kimballgroup.com/1998/05/surrogate-keys/" rel="noopener ugc nofollow" target="_blank"> <strong class="lp iu">代理键</strong> </a> <strong class="lp iu"> </strong>，添加一个无穷大的<strong class="lp iu">结束年份</strong>，将其标记为<strong class="lp iu">活动</strong>，并设置<strong class="lp iu">时间戳</strong>。</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="1cde" class="nu kw it nq b gy nv nw l nx ny">WHEN NOT MATCHED THEN<br/>INSERT(SKEY,ID,EMPLOYEE,JOB_TITLE,COMPANY,START_YEAR,END_YEAR,ACTIVE<br/>,CREATED,UPDATED) VALUES (GENERATE_UUID(),input.ID,input.EMPLOYEE<br/>,input.JOB_TITLE,input.COMPANY,input.START_YEAR,9999,'Y'<br/>,CURRENT_TIMESTAMP(),CURRENT_TIMESTAMP())</span></pre><p id="7e75" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated">当我们找到它时，我们更新了那些仍然对未来开放并具有不同起始年份的，我们将它们设置为<strong class="lp iu">不活动，</strong>添加一个<strong class="lp iu">结束年份</strong>并更新<strong class="lp iu">时间戳。</strong></p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="9e19" class="nu kw it nq b gy nv nw l nx ny">WHEN MATCHED AND output.END_YEAR = 9999 <br/>             AND output.START_YEAR &lt;&gt; input.START_YEAR THEN<br/>UPDATE SET ACTIVE = 'N', END_YEAR = input.START_YEAR<br/>, UPDATED = CURRENT_TIMESTAMP()</span></pre><p id="5cac" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated">最初，我试图实现 Kimball 设计技巧#107 时，我发现 Google BigQuery 没有实现我 14 年前看到的输出。然后我发现有可能改变来源:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="2a8e" class="nu kw it nq b gy nv nw l nx ny">USING (<br/>SELECT src.ID as PSEUDO_ID, src.*<br/>FROM SCD.HR_INPUT AS src<br/>UNION ALL<br/>SELECT NULL as PSEUDO_ID, dup.*<br/>FROM SCD.HR_INPUT AS dup<br/>INNER JOIN SCD.EmployeeDim AS trget ON dup.ID = trget.ID<br/>WHERE trget.END_YEAR = 9999 AND trget.START_YEAR &lt;&gt; dup.START_YEAR<br/>) AS input</span></pre><p id="c813" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated">我带来了所有的数据，复制了 ID 列，并将其命名为<strong class="lp iu"> Pseudo ID，</strong>新的记录和按年份拆分现有 ID 的值将在这里实现。</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="11e5" class="nu kw it nq b gy nv nw l nx ny">SELECT src.ID as PSEUDO_ID, src.*<br/>FROM SCD.HR_INPUT AS src</span></pre><p id="9ce4" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated">我添加输入表中的所有记录，这些记录将把现有的 ID 添加为活动的，在分类为要插入的合并语句的<strong class="lp iu">伪 ID </strong>中添加一个空值。</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="1880" class="nu kw it nq b gy nv nw l nx ny">SELECT <strong class="nq iu">NULL</strong> as PSEUDO_ID, dup.*<br/>FROM SCD.HR_INPUT AS dup<br/>INNER JOIN SCD.EmployeeDim AS trget ON dup.ID = trget.ID<br/>WHERE trget.END_YEAR = 9999 AND trget.START_YEAR &lt;&gt; dup.START_YEAR</span></pre></div><div class="ab cl nd ne hx nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="im in io ip iq"><h1 id="3734" class="kv kw it bd kx ky nk la lb lc nl le lf jz nm ka lh kc nn kd lj kf no kg ll lm bi translated">结论</h1><p id="a947" class="pw-post-body-paragraph ln lo it lp b lq lr ju ls lt lu jx lv lw lx ly lz ma mb mc md me mf mg mh mi im bi translated"><a class="ae ku" href="https://www.kimballgroup.com/2008/09/slowly-changing-dimensions-part-2/" rel="noopener ugc nofollow" target="_blank">缓变维度类型 2 </a>允许我们看到数据发生时的样子，并将其视为当前活动的，MERGE 语句可以简化 SCD 类型 2 的创建但在 Google BigQuery 中实现；我们需要对源查询进行更改，以替换当前不可用的输出。</p><p id="ee41" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated">如果您正在使用 Google Query，我建议您查看我以前的帖子，关于<a class="ae ku" rel="noopener" target="_blank" href="/run-bigquery-sql-using-python-api-client-b5287ac05b99">使用 Python API 客户端运行 big Query SQL</a>和<a class="ae ku" rel="noopener" target="_blank" href="/connecting-dbeaver-to-google-bigquery-23c8a12e55b5">将 DBeaver 连接到 Google BigQuery </a>，因为它们一步一步地详细介绍了如何创建和配置服务帐户以及如何避免 BigQuery Web 界面。</p></div><div class="ab cl nd ne hx nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="im in io ip iq"><h1 id="b678" class="kv kw it bd kx ky nk la lb lc nl le lf jz nm ka lh kc nn kd lj kf no kg ll lm bi translated">谢谢</h1><p id="c477" class="pw-post-body-paragraph ln lo it lp b lq lr ju ls lt lu jx lv lw lx ly lz ma mb mc md me mf mg mh mi im bi translated">我把这篇文章献给沃伦·桑斯韦特(金宝集团)，一个了不起的人，一个知识渊博的专业人士，直到他生命的最后几天，他都面带微笑。</p><p id="655a" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated">当我们一起工作时，他对数据建模的热情向我展示了我职业生涯的成长之路。</p><p id="c50a" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated">对我的朋友来说，我仍然是你所说的数据魔术师。</p></div><div class="ab cl nd ne hx nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="im in io ip iq"><h1 id="cdf8" class="kv kw it bd kx ky nk la lb lc nl le lf jz nm ka lh kc nn kd lj kf no kg ll lm bi translated">解决纷争</h1><h2 id="9a84" class="nu kw it bd kx ow ox dn lb oy oz dp lf lw pa pb lh ma pc pd lj me pe pf ll pg bi translated">验证过程主体时出错(添加选项(strict_mode=false)以隐藏):查询错误:没有为此项目启用开单。在 https://console.cloud.google.com/billing.<a class="ae ku" href="https://console.cloud.google.com/billing." rel="noopener ugc nofollow" target="_blank">启用计费</a>在自由层不允许 DML 查询。请设置一个帐单帐户来取消此限制。在[3:5]</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ob oc di od bf oe"><div class="gh gi ph"><img src="../Images/4cdc3ade9a5574d5d140e95b1483e809.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9NMK_c8MDbMu77rebyKlxA.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">使用 Google BigQuery Web UI 合并错误消息 Google BigQuery 自由层</p></figure><p id="995f" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated">如果您正在使用免费层，您需要转到收费项目，方法是转到 https://console.cloud.google.com/billing 的<a class="ae ku" href="https://console.cloud.google.com/billing" rel="noopener ugc nofollow" target="_blank">，创建一个帐户，设置一种支付方式，然后转到我的项目，选择您的项目，并更改计费。</a></p><p id="a4a4" class="pw-post-body-paragraph ln lo it lp b lq ml ju ls lt mm jx lv lw mz ly lz ma na mc md me nb mg mh mi im bi translated">请记住在测试后返回，并再次锁定或禁用计费。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ob oc di od bf oe"><div class="gh gi pi"><img src="../Images/e5ab22a87d903718b5a2635dfbc0e8ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HqyqEAAh1rwqny3hLZ-YhA.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">控制台谷歌云计费创建一个帐户。作者使用 Google BigQuery Web UI 截图</p></figure></div><div class="ab cl nd ne hx nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="im in io ip iq"><h1 id="82c0" class="kv kw it bd kx ky nk la lb lc nl le lf jz nm ka lh kc nn kd lj kf no kg ll lm bi translated">有用的资源</h1><div class="pj pk gp gr pl pm"><a href="https://en.wikipedia.org/wiki/Slowly_changing_dimension" rel="noopener  ugc nofollow" target="_blank"><div class="pn ab fo"><div class="po ab pp cl cj pq"><h2 class="bd iu gy z fp pr fr fs ps fu fw is bi translated">缓慢变化的维度-维基百科</h2><div class="pt l"><h3 class="bd b gy z fp pr fr fs ps fu fw dk translated">数据管理和数据仓库中的缓变维度(SCD)是一个包含相对…</h3></div><div class="pu l"><p class="bd b dl z fp pr fr fs ps fu fw dk translated">en.wikipedia.org</p></div></div><div class="pv l"><div class="pw l px py pz pv qa ko pm"/></div></div></a></div><div class="pj pk gp gr pl pm"><a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/dml-syntax#merge_statement" rel="noopener  ugc nofollow" target="_blank"><div class="pn ab fo"><div class="po ab pp cl cj pq"><h2 class="bd iu gy z fp pr fr fs ps fu fw is bi translated">Google 标准 SQL | BigQuery | Google Cloud 中的数据操作语言(DML)语句</h2><div class="pt l"><h3 class="bd b gy z fp pr fr fs ps fu fw dk translated">无论您的企业正处于数字化转型的早期阶段，谷歌云都可以帮助您解决…</h3></div><div class="pu l"><p class="bd b dl z fp pr fr fs ps fu fw dk translated">cloud.google.com</p></div></div><div class="pv l"><div class="qb l px py pz pv qa ko pm"/></div></div></a></div><div class="pj pk gp gr pl pm"><a href="https://www.kimballgroup.com/2008/11/design-tip-107-using-the-sql-merge-statement-for-slowly-changing-dimension-processing/" rel="noopener  ugc nofollow" target="_blank"><div class="pn ab fo"><div class="po ab pp cl cj pq"><h2 class="bd iu gy z fp pr fr fs ps fu fw is bi translated">设计技巧#107 使用 SQL MERGE 语句进行渐变维度处理- Kimball…</h2><div class="pt l"><h3 class="bd b gy z fp pr fr fs ps fu fw dk translated">大多数 ETL 工具都提供了一些处理缓慢变化的维度的功能。有时，当工具不…</h3></div><div class="pu l"><p class="bd b dl z fp pr fr fs ps fu fw dk translated">www.kimballgroup.com</p></div></div><div class="pv l"><div class="qc l px py pz pv qa ko pm"/></div></div></a></div><div class="pj pk gp gr pl pm"><a href="https://www.kimballgroup.com/2008/08/slowly-changing-dimensions/" rel="noopener  ugc nofollow" target="_blank"><div class="pn ab fo"><div class="po ab pp cl cj pq"><h2 class="bd iu gy z fp pr fr fs ps fu fw is bi translated">渐变尺寸-金博尔集团</h2><div class="pt l"><h3 class="bd b gy z fp pr fr fs ps fu fw dk translated">时间的概念渗透到数据仓库的每个角落。我们存储在……</h3></div><div class="pu l"><p class="bd b dl z fp pr fr fs ps fu fw dk translated">www.kimballgroup.com</p></div></div><div class="pv l"><div class="qd l px py pz pv qa ko pm"/></div></div></a></div><div class="pj pk gp gr pl pm"><a href="https://www.kimballgroup.com/2008/09/slowly-changing-dimensions-part-2/" rel="noopener  ugc nofollow" target="_blank"><div class="pn ab fo"><div class="po ab pp cl cj pq"><h2 class="bd iu gy z fp pr fr fs ps fu fw is bi translated">渐变尺寸，第 2 部分-金博尔集团</h2><div class="pt l"><h3 class="bd b gy z fp pr fr fs ps fu fw dk translated">数据仓库的所有者必须决定如何响应维度实体描述的变化…</h3></div><div class="pu l"><p class="bd b dl z fp pr fr fs ps fu fw dk translated">www.kimballgroup.com</p></div></div><div class="pv l"><div class="qe l px py pz pv qa ko pm"/></div></div></a></div><div class="pj pk gp gr pl pm"><a href="https://www.kimballgroup.com/2013/02/design-tip-152-slowly-changing-dimension-types-0-4-5-6-7/" rel="noopener  ugc nofollow" target="_blank"><div class="pn ab fo"><div class="po ab pp cl cj pq"><h2 class="bd iu gy z fp pr fr fs ps fu fw is bi translated">设计提示#152 渐变尺寸类型 0、4、5、6 和 7 -金博尔组</h2><div class="pt l"><h3 class="bd b gy z fp pr fr fs ps fu fw dk translated">Ralph 在 1996 年引入了渐变维度(SCD)属性的概念。维度建模器，在…</h3></div><div class="pu l"><p class="bd b dl z fp pr fr fs ps fu fw dk translated">www.kimballgroup.com</p></div></div><div class="pv l"><div class="qf l px py pz pv qa ko pm"/></div></div></a></div><div class="pj pk gp gr pl pm"><a href="https://www.kimballgroup.com/1998/05/surrogate-keys/" rel="noopener  ugc nofollow" target="_blank"><div class="pn ab fo"><div class="po ab pp cl cj pq"><h2 class="bd iu gy z fp pr fr fs ps fu fw is bi translated">代理键-金博尔组</h2><div class="pt l"><h3 class="bd b gy z fp pr fr fs ps fu fw dk translated">根据韦氏完整字典，代孕母亲是一种“人造或合成产品，被用作…</h3></div><div class="pu l"><p class="bd b dl z fp pr fr fs ps fu fw dk translated">www.kimballgroup.com</p></div></div><div class="pv l"><div class="qg l px py pz pv qa ko pm"/></div></div></a></div></div></div>    
</body>
</html>