<html>
<head>
<title>Handling DNS and SSL/TLS for your AWS Kubernetes Cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为AWS Kubernetes集群处理DNS和SSL/TLS</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/handling-dns-and-ssl-tls-for-your-aws-kubernetes-cluster-f3ecd0991e6a#2022-05-12">https://towardsdatascience.com/handling-dns-and-ssl-tls-for-your-aws-kubernetes-cluster-f3ecd0991e6a#2022-05-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ea3c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在AWS上将Kubernetes服务连接到您的域的快速纲要</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/55615fe29aee57117b5482450f4d8e67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*38PnqWkZU8mVRIrr"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@comparefibre?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上对比纤维</a></p></figure><p id="f839" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，您已经在AWS上创建了一个Kubernetes集群，在其上部署了一些应用程序，并最终准备向世界展示您所构建的东西。但是您需要了解如何将域连接到您的应用程序并设置SSL/TLS。我以前也有过类似的经历，所以我写了这个快速的总结，这样你就不用去库伯内特兔子洞找答案了。</p><p id="87f8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">我会为</em> <a class="ae ky" rel="noopener" target="_blank" href="/ssl-tls-for-your-kubernetes-cluster-with-cert-manager-3db24338f17"> <em class="lv"> SSL/TLS设置</em> </a> <em class="lv">写一篇单独的文章，并在这里链接，所以这篇文章不会太长。</em></p><h2 id="0cdb" class="lw lx it bd ly lz ma dn mb mc md dp me li mf mg mh lm mi mj mk lq ml mm mn mo bi translated">将您的域迁移到AWS路由53</h2><p id="9839" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li mr lk ll lm ms lo lp lq mt ls lt lu im bi translated">Route53是AWS提供的DNS服务。它的工作是将请求路由到您的域和子域，再路由到附属于它们的IP。</p><p id="9c62" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可能已经通过Route53注册了您的域名，在这种情况下，您不需要在这里做任何事情。但是，如果您从另一个提供商处购买了您的域名，例如Namecheap，那么您需要将其转让给Route53来管理您的DNS记录和路由流量。</p><p id="18f4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要通过AWS控制台执行此操作，请导航到AWS Route53并创建一个托管区域。托管区域保存有关您希望如何路由流量的记录。创建托管区域时，您将被要求提供一个域，例如example.com，但如果您不想迁移整个域，也可以放入一个子域，例如test.example.com。</p><p id="7968" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您的新托管区域将有一个包含4台服务器的NS记录。进入您的域的管理部分，在它当前所在的提供商中。它将有一节添加自定义域名。将4个名称服务器复制到自定义DNS部分。你完了。现在，您需要等待24小时才能完成迁移。</p><h2 id="7c41" class="lw lx it bd ly lz ma dn mb mc md dp me li mf mg mh lm mi mj mk lq ml mm mn mo bi translated">使用Kubernetes集群配置外部DNS</h2><p id="94e2" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li mr lk ll lm ms lo lp lq mt ls lt lu im bi translated">为什么我们把你的域名迁移到Route53？因为我们希望在您的DNS上为您所有公开的Kubernetes服务和入口自动创建新记录，如果您的DNS位于AWS上，这将更容易实现。ExternalDNS 将为我们做这件事。它基本上是我们将在您的群集上部署的一个单元。它将在route53中寻找需要DNS记录的资源列表，并自动创建这些记录。</p><p id="bad2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下是外部DNS的K8S模板:</p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="9f50" class="lw lx it mv b gy mz na l nb nc">apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/>  name: external-dns<br/>  # If you're using Amazon EKS with IAM Roles for Service Accounts, specify the following annotation.<br/>  # Otherwise, you may safely omit it.<br/>  annotations:<br/>    # Substitute your account ID and IAM service role name below.<br/>    <strong class="mv iu">eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT-ID:role/IAM-SERVICE-ROLE-NAME</strong><br/>---<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>kind: ClusterRole<br/>metadata:<br/>  name: external-dns<br/>rules:<br/>- apiGroups: [""]<br/>  resources: ["services","endpoints","pods"]<br/>  verbs: ["get","watch","list"]<br/>- apiGroups: ["extensions","networking.k8s.io"]<br/>  resources: ["ingresses"]<br/>  verbs: ["get","watch","list"]<br/>- apiGroups: [""]<br/>  resources: ["nodes"]<br/>  verbs: ["list","watch"]<br/>---<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>kind: ClusterRoleBinding<br/>metadata:<br/>  name: external-dns-viewer<br/>roleRef:<br/>  apiGroup: rbac.authorization.k8s.io<br/>  kind: ClusterRole<br/>  name: external-dns<br/>subjects:<br/>- kind: ServiceAccount<br/>  name: external-dns<br/>  namespace: default<br/>---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: external-dns<br/>spec:<br/>  strategy:<br/>    type: Recreate<br/>  selector:<br/>    matchLabels:<br/>      app: external-dns<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: external-dns<br/>      # If you're using kiam or kube2iam, specify the following annotation.<br/>      # Otherwise, you may safely omit it.<br/>      annotations:<br/>        <strong class="mv iu">iam.amazonaws.com/role: arn:aws:iam::ACCOUNT-ID:role/IAM-SERVICE-ROLE-NAME</strong><br/>    spec:<br/>      serviceAccountName: external-dns<br/>      containers:<br/>      - name: external-dns<br/>        image: k8s.gcr.io/external-dns/external-dns:v0.7.6<br/>        args:<br/>        - --source=service<br/>        - --source=ingress<br/>        - --domain-filter=external-dns-test.my-org.com # will make ExternalDNS see only the hosted zones matching provided domain, omit to process all available hosted zones<br/>        - --provider=aws<br/>        - --policy=upsert-only # would prevent ExternalDNS from deleting any records, omit to enable full synchronization<br/>        - --aws-zone-type=public # only look at public hosted zones (valid values are public, private or no value for both)<br/>        - --registry=txt<br/>        - --txt-owner-id=my-hostedzone-identifier<br/>      securityContext:<br/>        fsGroup: 65534 # For ExternalDNS to be able to read Kubernetes and AWS token files</span></pre><p id="21d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您会注意到几行粗体字表示AWS IAM角色Arn的注释。IAM角色将由ExternalDNS承担。它应该有权向Route53上的托管区域添加记录。以下是创建该角色的方法。</p><p id="1e98" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将这个内联策略保存到一个json文件。该策略为角色提供了路由53托管区域的权限。</p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="c1d3" class="lw lx it mv b gy mz na l nb nc">{<br/>  "Version": "2012-10-17",<br/>  "Statement": [<br/>    {<br/>      "Effect": "Allow",<br/>      "Action": [<br/>        "route53:ChangeResourceRecordSets"<br/>      ],<br/>      "Resource": [<br/>        "arn:aws:route53:::hostedzone/*"<br/>      ]<br/>    },<br/>    {<br/>      "Effect": "Allow",<br/>      "Action": [<br/>        "route53:ListHostedZones",<br/>        "route53:ListResourceRecordSets"<br/>      ],<br/>      "Resource": [<br/>        "*"<br/>      ]<br/>    }<br/>  ]<br/>}</span></pre><p id="6152" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用AWS CLI创建角色。</p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="1d26" class="lw lx it mv b gy mz na l nb nc">aws iam create-role — role-name role-example — assume-role-policy-document path/to/policy</span></pre><p id="6bb2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将上面命令返回的Arn替换到ExternalDNS模板中的粗体部分，并部署。</p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="42cf" class="lw lx it mv b gy mz na l nb nc">kubectl -n external-dns apply template.yaml</span></pre><p id="277d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">好了，我们完成了外部DNS的设置。现在，将为您部署的每个入口或服务自动创建一个DNS记录。</p><h2 id="ff79" class="lw lx it bd ly lz ma dn mb mc md dp me li mf mg mh lm mi mj mk lq ml mm mn mo bi translated">它是如何工作的一个例子</h2><p id="e0c2" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li mr lk ll lm ms lo lp lq mt ls lt lu im bi translated">这里有一个指向mynginx.your-domain.com的nginx服务的模板。</p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="c8f8" class="lw lx it mv b gy mz na l nb nc">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: nginx<br/>  annotations:<br/>    <strong class="mv iu">external-dns.alpha.kubernetes.io/hostname: mynginx.your-domain.com</strong><br/>spec:<br/>  type: LoadBalancer<br/>  ports:<br/>  - port: 80<br/>    name: http<br/>    targetPort: 80<br/>  selector:<br/>    app: nginx</span><span id="e571" class="lw lx it mv b gy nd na l nb nc">---</span><span id="5db2" class="lw lx it mv b gy nd na l nb nc">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: nginx<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app: nginx<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: nginx<br/>    spec:<br/>      containers:<br/>      - image: nginx<br/>        name: nginx<br/>        ports:<br/>        - containerPort: 80<br/>          name: http</span></pre><p id="efe1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了测试，你可以用<code class="fe ne nf ng mv b">kubectl apply -f [your-file-name.yaml]</code>应用上面的模板，然后在route53中检查你的托管区域下的记录。你会发现一个新的A记录自动为mynginx.your-domain.com创建，指向这个nginx服务的DNS名称。</p><p id="3908" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是连接您的域。总的来说，我们已经在您的集群上部署了ExternalDNS，以便它可以自动将指向您集群上的服务和入口的新记录添加到Route53上托管的域的DNS中。我们还将您的域迁移到了Route53，因此它可以由AWS管理，并创建了一个新角色来授予route 53 external DNS权限。接下来，您需要为您的服务设置TLS/SSL。我将在下一篇文章中讨论这个问题，并在这里链接。</p></div></div>    
</body>
</html>