<html>
<head>
<title>From Dev to Deployment: An End to End Sentiment Classifier App with MLflow, SageMaker, and Streamlit</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从开发到部署:包含MLflow、SageMaker和Streamlit的端到端情感分类器应用</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/from-dev-to-deployment-an-end-to-end-sentiment-classifier-app-with-mlflow-sagemaker-and-119043ea4203#2022-09-22">https://towardsdatascience.com/from-dev-to-deployment-an-end-to-end-sentiment-classifier-app-with-mlflow-sagemaker-and-119043ea4203#2022-09-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1e2b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在本教程中，我们将从DagsHub-MLflow开始构建一个NLP应用程序，然后在SageMaker和EC2中进行部署，前端在Streamlit中。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/73ad1f570a633d179de3f617dc8a173c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ML2fP_UiVQB3nK4ThxYZGQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由<a class="ae ky" href="https://unsplash.com/photos/dyaxQ-aoGWY" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae ky" href="https://unsplash.com/@siloine" rel="noopener ugc nofollow" target="_blank"> Yoann Siloine </a>拍摄</p></figure><h2 id="cb1f" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">目录</h2><p id="b573" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated"><a class="ae ky" href="#bda8" rel="noopener ugc nofollow"> — 1。设置DagsHub repo和需求</a><br/>—<a class="ae ky" href="#0056" rel="noopener ugc nofollow">创建您的DagsHub rep</a>o<br/>—<a class="ae ky" href="#dbf5" rel="noopener ugc nofollow">设置虚拟环境</a><br/>—<a class="ae ky" href="#b026" rel="noopener ugc nofollow">用DVC </a> <br/> — <a class="ae ky" href="#f770" rel="noopener ugc nofollow"> 2a下载数据。在MLflow中启动您的第一个实验</a><br/>—<a class="ae ky" href="#444b" rel="noopener ugc nofollow">朴素贝叶斯模型作为情感分类的骨干</a><br/>—<a class="ae ky" href="#8cb4" rel="noopener ugc nofollow">建立DagsHub MLflow并运行实验</a> <br/> — <a class="ae ky" href="#3605" rel="noopener ugc nofollow"> 2b。做一个更通用的代码来核算不同的型号</a> <br/> — <a class="ae ky" href="#3306" rel="noopener ugc nofollow"> 3。在MLflow中注册您的模型并部署到SageMaker端点</a><br/>—<a class="ae ky" href="#23d6" rel="noopener ugc nofollow">将模型添加到MLflow注册表</a><br/>—<a class="ae ky" href="#ee27" rel="noopener ugc nofollow">设置AWS IAM角色以从MLflow </a> <br/>部署— <a class="ae ky" href="#1d93" rel="noopener ugc nofollow">将您注册的模型部署到AWS SageMaker </a> <br/> — <a class="ae ky" href="#0d7c" rel="noopener ugc nofollow"> 4。在EC2实例上部署一个streamlit应用程序，并通过您的仪表板运行预测</a><br/>—<a class="ae ky" href="#874f" rel="noopener ugc nofollow">创建一个简单的Streamlit仪表板应用程序</a><br/>—<a class="ae ky" href="#664d" rel="noopener ugc nofollow">将您的仪表板部署到EC2实例</a> <br/> — <a class="ae ky" href="#80e5" rel="noopener ugc nofollow">优点、缺点、局限性、未来要做的工作</a>—<br/>—<a class="ae ky" href="#b5e3" rel="noopener ugc nofollow">结论</a> <br/> — <a class="ae ky" href="#99f1" rel="noopener ugc nofollow">支持我的写作</a></p><p id="0f08" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">欢迎来到这个关于机器学习的新教程。今天我们将使用以下工具开发一个完整的端到端应用程序，从模型开发到模型部署:DagsHub、MLflow、AWS SageMaker、AWS EC2和Streamlit。特别是，我们将使用DagsHub作为我们的GitHub repo，因为它提供了MLflow和数据版本控制<code class="fe mt mu mv mw b">dvc</code>的集成版本。通过这种方式，我们不必在云上设置新的MLflow服务器和存储桶，因为一切都已准备好用于我们的新模型实验。</p><p id="ec60" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">我们将实施情感分类模型，这是我们必须处理的工作的大纲:</p><ol class=""><li id="586b" class="mx my it lx b ly mo mb mp li mz lm na lq nb mn nc nd ne nf bi translated">我们将探讨如何建立DagsHub回购以及我们需要什么要求。</li><li id="fbba" class="mx my it lx b ly ng mb nh li ni lm nj lq nk mn nc nd ne nf bi translated">我们将致力于一个tweet情感数据集，分析不同的<code class="fe mt mu mv mw b">sklearn</code>模型，并将在MLflow中跟踪它们。</li><li id="4240" class="mx my it lx b ly ng mb nh li ni lm nj lq nk mn nc nd ne nf bi translated">一旦我们学会了如何比较模型，我们将跳到AWS SageMaker上的MLflow部署端。我们将回顾IAM用户和角色以及端点创建</li><li id="a932" class="mx my it lx b ly ng mb nh li ni lm nj lq nk mn nc nd ne nf bi translated">最后，我们将把我们的分类模型包装在一个Streamlit应用程序中，托管在一个EC2实例上。</li></ol><h1 id="bda8" class="nl la it bd lb nm nn no le np nq nr lh jz ns ka ll kc nt kd lp kf nu kg lt nv bi translated">1.设置DagsHub回购和要求</h1><p id="09d3" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">在这里你可以找到我今天要处理的所有相关代码。</p><h2 id="0056" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">创建您的DagsHub repo</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图1:一键创建一个新的DagsHub repo。</p></figure><p id="b611" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">图1显示了如何在DagsHub中创建一个repo。只需点击你的个人资料图片旁边的“创建”按钮，然后给回购提供一个名称和描述，你就可以开始了。一旦创建了回购，与Github不同的是，您会看到更多的特性。如果你点击“远程”,窗口会显示DagsHub提供的3种服务:Git、DVC和MLflow。</p><h2 id="dbf5" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">设置虚拟环境</h2><p id="ac33" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">对于这个项目，我强烈建议你使用虚拟环境。因此，用以下代码克隆您的DagsHub存储库</p><pre class="kj kk kl km gt ny mw nz oa aw ob bi"><span id="7c9c" class="kz la it mw b gy oc od l oe of">git clone <a class="ae ky" href="https://dagshub.com/stefanobosisio1/sentiment_mlflow.git" rel="noopener ugc nofollow" target="_blank">https://dagshub.com/stefanobosisio1/sentiment_mlflow.git</a></span></pre><p id="d677" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">并创建一个Python <code class="fe mt mu mv mw b">venv</code>在你的终端<code class="fe mt mu mv mw b">python -m venv venv</code>中键入这个命令将创建一个<code class="fe mt mu mv mw b">venv/</code>文件夹。使用<code class="fe mt mu mv mw b">venv/bin/pip install --upgrade pip</code>将<code class="fe mt mu mv mw b">pip</code>升级至最新版本</p><h2 id="b026" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">和DVC一起下载数据</h2><p id="4ade" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">正如我之前提到的，DagsHub提供了一个基于<code class="fe mt mu mv mw b">dvc</code>的数据版本系统——你可以在这里找到更多信息<a class="ae ky" href="https://dvc.org/doc/user-guide" rel="noopener ugc nofollow" target="_blank">。简而言之，DVC是一个出色的Python工具，它允许您保持对数据的控制和版本。</a></p><p id="2e47" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">我们将使用下面的数据。这些是来自Twitter的无版权数据，CC0 1.0许可证，<a class="ae ky" href="https://paperswithcode.com/dataset/twitter-sentiment-analysis" rel="noopener ugc nofollow" target="_blank">可从这里</a>公开获得。在Python: <code class="fe mt mu mv mw b">venv/bin/pip install dvc</code>中安装<code class="fe mt mu mv mw b">dvc</code>，并使用:<code class="fe mt mu mv mw b">venv/bin/dvc init</code>在终端<code class="fe mt mu mv mw b">dvc</code>中的存储库文件夹中初始化</p><p id="fc3d" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">现在你已经准备好克隆<code class="fe mt mu mv mw b">split-data</code>文件夹了:</p><pre class="kj kk kl km gt ny mw nz oa aw ob bi"><span id="299b" class="kz la it mw b gy oc od l oe of">venv/bin/dvc get https://dagshub.com/nirbarazida/tweet-sentiment-analysis-data split-data/</span></pre><p id="d697" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">我们已经准备好第一次提交DagsHub——注意我们是如何使用<code class="fe mt mu mv mw b">dvc</code>提交的:</p><pre class="kj kk kl km gt ny mw nz oa aw ob bi"><span id="040c" class="kz la it mw b gy oc od l oe of">venv/bin/dvc add split-data<br/>git add .gitignore split-data.dvc <br/>git commit -m "A NICE MESSAGE FOR COMMIT"<br/>git push origin </span></pre><h1 id="f770" class="nl la it bd lb nm nn no le np nq nr lh jz ns ka ll kc nt kd lp kf nu kg lt nv bi translated">2a。在MLflow中启动您的第一个实验</h1><p id="0d51" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">我们已经准备好处理MLflow了。首先，让我们用一个非常简单的朴素贝叶斯分类器为我们的代码创建一个主干，来学习如何构建模型和MLflow设置</p><h2 id="444b" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">作为情感分类骨干的朴素贝叶斯模型</h2><p id="39b6" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated"><a class="ae ky" href="https://dagshub.com/stefanobosisio1/sentiment_mlflow/src/main/naivebayes.py" rel="noopener ugc nofollow" target="_blank">在这里你可以找到代码。</a>我们将尝试获取整个工作流的精髓，而不是深入数据科学的本质，因此我们将只使用这些文件:<code class="fe mt mu mv mw b">split-data/X_train</code>和<code class="fe mt mu mv mw b">split-data/y_train</code>。首先，我们需要预处理我们的数据，并清除它们:</p><ul class=""><li id="0d9f" class="mx my it lx b ly mo mb mp li mz lm na lq nb mn og nd ne nf bi translated">停用词，如<code class="fe mt mu mv mw b">and, but, a, an...</code></li><li id="030d" class="mx my it lx b ly ng mb nh li ni lm nj lq nk mn og nd ne nf bi translated">标点</li><li id="8fac" class="mx my it lx b ly ng mb nh li ni lm nj lq nk mn og nd ne nf bi translated">特殊字符，如标签、标记、换行符或撇号</li></ul><p id="60bb" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">在99%的情况下，这是每个NLP项目的第一步。因此，我们只需要三个简单的函数:<code class="fe mt mu mv mw b">remove_stopwords</code>、<code class="fe mt mu mv mw b">remove_punctuation</code>和<code class="fe mt mu mv mw b">remove_specific_chars</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh nx l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图2:文本清理功能:用NLTK删除停用词，用string模块删除标点符号，而特定字符删除标签、新行以及撇号。</p></figure><p id="fed8" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">每个函数接收给定的文本作为输入，并创建一个新的<code class="fe mt mu mv mw b">outline</code>字符串。此外，在预处理之前，我们要将输入数据帧中的所有字符串小写，如图3所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh nx l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图3:输入文本的预处理和清理。</p></figure><p id="3aa9" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">在设置MLflow之前，让我们完成第一个朴素贝叶斯分类器下的工作流(图4)。在预处理位之后，数据可以分成训练集和验证集。要将字符串转换成数字，需要调用<code class="fe mt mu mv mw b">sklearn</code>矢量器(如<code class="fe mt mu mv mw b">CountVectorizer</code>或<code class="fe mt mu mv mw b">TfidfVectorizer</code>)。矢量化之后，输入数据可以被分类器读取，<code class="fe mt mu mv mw b">MultinominalNB</code>，我们可以继续进行训练和度量。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh nx l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图4:全模型循环。数据被清理，然后分成训练集和验证集。输入字符串用CountVectorizer进行矢量化，然后传递给朴素贝叶斯模型进行分类。</p></figure><h2 id="8cb4" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">设置DagsHub MLflow并运行实验</h2><p id="f69e" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">要设置DagsHub MLflow服务器，我们需要来自DagsHub的跟踪uri、跟踪用户名和密码。为什么？</p><ul class=""><li id="73ae" class="mx my it lx b ly mo mb mp li mz lm na lq nb mn og nd ne nf bi translated">跟踪uri是MLflow服务器的url，工件将被报告到该服务器。我们需要这些信息来建立连接</li><li id="e105" class="mx my it lx b ly ng mb nh li ni lm nj lq nk mn og nd ne nf bi translated">DagsHub需要跟踪用户和密码来验证我们的实验并访问MLflow服务器</li></ul><p id="79d4" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">在您的repo中，单击远程按钮，您将找到所有需要的信息，如图5所示。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/08b3028a3ff450cf3ae25ef5b3470a9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EtZ4tzKyxfmg8Wc5B6759Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图5:跟踪uri、用户名和密码(隐藏)以设置DagsHub MLflow跟踪。</p></figure><p id="0847" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">您可以将这些信息复制到一个<code class="fe mt mu mv mw b">setup_mlflow.txt</code>文件中，并在我们的主代码中解析它。然后，图6显示了如何在您的代码中设置MLflow跟踪，以及MLflow如何集成到您的主干代码中——记住<a class="ae ky" href="https://dagshub.com/stefanobosisio1/sentiment_mlflow/src/main/naivebayes.py" rel="noopener ugc nofollow" target="_blank">在这里您可以找到完整的代码</a></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh nx l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图6:模型代码中MLflow的设置。</p></figure><p id="45fa" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">简而言之，这些是MLflow用于跟踪实验的关键要素:</p><ul class=""><li id="1837" class="mx my it lx b ly mo mb mp li mz lm na lq nb mn og nd ne nf bi translated">通过<code class="fe mt mu mv mw b">mlflow.set_tracking_uri(mlflow_tracking_uri)</code>建立与MLflow服务器的连接</li><li id="02c5" class="mx my it lx b ly ng mb nh li ni lm nj lq nk mn og nd ne nf bi translated">设置一个实验，如果已经存在<code class="fe mt mu mv mw b">mlflow.create_experiment</code>和<code class="fe mt mu mv mw b">mlflow_client.get_experiment_by_name</code>，则检索其<code class="fe mt mu mv mw b">id</code></li><li id="d91f" class="mx my it lx b ly ng mb nh li ni lm nj lq nk mn og nd ne nf bi translated">用上下文管理器<code class="fe mt mu mv mw b">with mlflow.start_run(...)</code>开始实验</li><li id="93e6" class="mx my it lx b ly ng mb nh li ni lm nj lq nk mn og nd ne nf bi translated">尽可能多地利用<a class="ae ky" href="https://gist.github.com/Steboss89/8ba3f007239b4ae982d575e5f04071f0" rel="noopener ugc nofollow" target="_blank">ml flow自动日志功能</a>，比如<code class="fe mt mu mv mw b">mlflow.sklearn.autolog(...)</code>。自动记录功能使用Python模块<code class="fe mt mu mv mw b">inspect</code>跟踪实验以及为不同“风格”的模型(如<code class="fe mt mu mv mw b">sklearn</code>、<code class="fe mt mu mv mw b">torch</code>等)生成的人工制品和物体。)</li><li id="2361" class="mx my it lx b ly ng mb nh li ni lm nj lq nk mn og nd ne nf bi translated">用<code class="fe mt mu mv mw b">mlflow.end_run()</code>结束你的实验</li></ul><p id="bc11" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">实验运行后，您可以在MLflow UI中可视化指标和工件，可以通过两种方式访问:</p><ul class=""><li id="17d8" class="mx my it lx b ly mo mb mp li mz lm na lq nb mn og nd ne nf bi translated">将<code class="fe mt mu mv mw b">.mlflow</code>添加到您的DagsHub回购协议中(例如【http://dagshub.com/stefanobosisio1/sentiment_mlflow.mlflow】T4</li><li id="7d4f" class="mx my it lx b ly ng mb nh li ni lm nj lq nk mn og nd ne nf bi translated">或者单击“远程”,并在“MLflow”部分下单击“转到mlflow UI ”(图5)</li></ul><p id="d1ff" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">图7显示了MLflow UI应该是什么样子。通过点击“开始时间”,您将访问关于您的模型的更多信息，比如模型的参数、度量、标签和工件。在artefacts框中，您会注意到一个<code class="fe mt mu mv mw b">model</code>文件夹，它存储由MLflow自动生成的文件，以便在预测时调用您的模型，例如condo环境、python需求和二进制文件。所有这些都在两行简单的代码中！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/b44a5d9055680fd73194c8342a19cdbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p-UPQd7DBK5MMGO01JZzFw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图7:使用朴素贝叶斯运行第一个测试后的MLflow UI示例。</p></figure><h1 id="3605" class="nl la it bd lb nm nn no le np nq nr lh jz ns ka ll kc nt kd lp kf nu kg lt nv bi translated">2b。编写一个更通用的代码来考虑不同的模型</h1><p id="a090" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">通常最好的做法是有一个通用的代码，以考虑不同的场景和不同的模型。出于这个原因，我们将把我们的朴素贝叶斯代码发展成一个更通用的代码，在这里我们可以选择不同的单词矢量器，以及不同的模型。在这里你可以找到参考代码</p><p id="23f9" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">第一件事是将我们所有的预处理函数和模型转换成一个<code class="fe mt mu mv mw b">sklearn</code>管道:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh nx l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图8:使用清理函数和情感分类器返回sklearn管道的函数。</p></figure><p id="e084" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">在选择了我们想要使用的模型和矢量器之后,<code class="fe mt mu mv mw b">pipeline</code>就创建好了。<a class="ae ky" href="https://dagshub.com/stefanobosisio1/sentiment_mlflow/src/main/multiple_models.py#L44" rel="noopener ugc nofollow" target="_blank"/><code class="fe mt mu mv mw b"><a class="ae ky" href="https://dagshub.com/stefanobosisio1/sentiment_mlflow/src/main/multiple_models.py#L44" rel="noopener ugc nofollow" target="_blank">PreprocessTweets</a></code><a class="ae ky" href="https://dagshub.com/stefanobosisio1/sentiment_mlflow/src/main/multiple_models.py#L44" rel="noopener ugc nofollow" target="_blank">现在是一个类，它包含了我们在上面</a>中创建的所有清理函数。为了设置它，我们需要记住导入<code class="fe mt mu mv mw b">sklearn.base.BaseEstimator</code>和<code class="fe mt mu mv mw b">sklearn.base.TransformerMixing</code>，并在类定义中继承这些方法。核心功能在<code class="fe mt mu mv mw b">fit_transform</code>函数中，其中输入数据帧列<code class="fe mt mu mv mw b">text</code>被清理并作为<code class="fe mt mu mv mw b">numpy</code>数组返回，因此它可以被矢量器步骤接收。</p><p id="416b" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">第二步是拥有一个解析器功能，例如用<code class="fe mt mu mv mw b">argparse</code></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh nx l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图9: Argparse处理不同的输入，有一个更通用的接口。</p></figure><p id="d790" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">通过这种方式，可以处理不同的模型，扩展代码并并行运行。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh nx l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图10:设置MLflow参数，直接调用跟踪器，安装管道并保存所有内容。</p></figure><p id="7191" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">图10显示了概括的最后步骤。给定输入的解析参数，我们现在可以为不同的实验设置MLflow(例如，一个实验将运行朴素贝叶斯，另一个是逻辑回归，另一个是随机森林)。我们可以用<code class="fe mt mu mv mw b">mlflow.start_run</code>直接开始跟踪，而不是把所有东西都包在<code class="fe mt mu mv mw b">mlflow</code>上下文管理器中。请记住，可以同时调用多个自动记录功能，MLflow将能够记录不同型号口味的产品。最后，运行预测，保存模型并将其报告给MLflow服务器。</p><p id="f5bd" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">通过这种方式，您将能够并行地或者用一个简单的bash脚本运行多个实验(图10)。对于本教程，我已经运行了一个朴素贝叶斯模型，一个逻辑回归模型，以及带有<code class="fe mt mu mv mw b">CountVectorizer</code>和<code class="fe mt mu mv mw b">TfIdfVectorizer</code>矢量器的随机森林。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh nx l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图11:提交多个实验和模型的bash脚本示例。</p></figure><p id="7b69" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">在这个阶段，在MLflow tracking中，所有这些模型都在同一个实验系列下，因此您可以对它们进行比较，并决定哪一个是最好的模型——图12</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图12:在MLflow中，您可以立即比较您运行的所有实验，并检查它们的指标和图表。</p></figure><h1 id="9906" class="nl la it bd lb nm nn no le np nq nr lh jz ns ka ll kc nt kd lp kf nu kg lt nv bi translated">3.在MLflow中注册您的模型并部署到SageMaker端点</h1><h2 id="23d6" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">向MLflow注册表添加模型</h2><p id="6291" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">每次在MLflow中保存模型时，您都会在模型的工件框中看到“注册模型”选项。这个小按钮允许您将当前模型添加到MLflow数据库中，该数据库确定哪些模型已注册并准备好用于“试运行”和“生产”环境，以及在模型需要淘汰时用于“归档”。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/60bd3e5ca370d74395721ef1739c06b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TW2KpYc-ZYhz-fOEIwQWMQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图13:带有“注册模型”选项的MLflow中的人工制品框。</p></figure><p id="0eb9" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">只需选择性能最佳的型号，并注册到MLflow注册表中。如图14所示，这种手动操作可以在Python中轻松完成。这种方法对于CI/CD非常有用。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh nx l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图14: Mlflow Python API允许通过运行id在注册表中添加模型。</p></figure><p id="f8b8" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">选择您的模型应该处于的环境，即“暂存”或“生产”。您的模型将有一个来自模型注册中心的类似uri:<code class="fe mt mu mv mw b">models:/NAME_OF_YOUR_MODEL_IN_THE_REGISTRY/environment</code></p><h2 id="ee27" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">设置要从MLflow部署的AWS IAM角色</h2><p id="7b02" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">如果你已经准备好了所有的AWS角色，你可以跳过这一段，否则请跟我来。</p><p id="baf4" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">假设你在AWS中有一个注册账户，让我们进入IAM(身份和访问管理)下的AWS控制台——同样的操作可以在Terraform中完成。在这里，我们可以转到<code class="fe mt mu mv mw b">Users</code>下，点击<code class="fe mt mu mv mw b">add Users</code>。选择一个用户名，例如<code class="fe mt mu mv mw b">stefano</code>，点击<code class="fe mt mu mv mw b">access key</code>。这将允许您拥有对正确设置至关重要的<code class="fe mt mu mv mw b">aws_access_key_id</code>和<code class="fe mt mu mv mw b">aws_secret_access_key</code>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ol"><img src="../Images/d3517dfef6153a496e9ad3cfd422ee72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mXWXZWBdA0Qoaq1JmAvJHg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图15:创建一个新用户并选择访问密钥凭证类型。</p></figure><p id="1ea5" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">在第二步中，将用户添加到组中。如果你没有sagemaker群，创建一个新的群。像<code class="fe mt mu mv mw b">sagemakergroup</code>一样设置组名，添加两个策略:<code class="fe mt mu mv mw b">AmazonSageMakerFullAccess</code>和<code class="fe mt mu mv mw b">AmazonEC2ContainerRegistryFullAccess</code>。这些是授予用户处理SageMaker和图像容器的所有权限的关键角色。继续剩余的步骤，最后下载您的凭证csv文件——或者记下访问密钥。</p><p id="9147" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">接下来，转到“角色”下，单击“创建角色”。在<code class="fe mt mu mv mw b">Trusted Entity Type</code>中选择<code class="fe mt mu mv mw b">AWS service</code>，在<code class="fe mt mu mv mw b">Use Cases</code>下寻找<code class="fe mt mu mv mw b">SageMaker</code>，选择<code class="fe mt mu mv mw b">Sagemaker — Execution</code>。继续，最后给角色起个名字(例如<code class="fe mt mu mv mw b">awssagemakerdeployment</code>)。一旦角色被创建，点击它并在某处复制<code class="fe mt mu mv mw b">arn</code>——它将类似于<code class="fe mt mu mv mw b">arn:aws:iam::YOUR_AWS_NUMBER:role/awssagemakerdeployment</code>。我们以后会需要这些信息。</p><p id="47b7" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">最后，您需要设置AWS CLI界面。在您的终端类型<code class="fe mt mu mv mw b">aws configure</code>中，系统会提示您输入用户访问密钥和秘密访问密钥(包含在下载的csv文件中),并添加最适合您的项目的区域(例如，对我来说是<code class="fe mt mu mv mw b">eu-west-1</code>)和输出格式(例如<code class="fe mt mu mv mw b">json</code>)。这将为MLflow使用正确的用户和权限部署到SageMaker准备所有必需的凭证设置。</p><h2 id="1d93" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">将您注册的模型部署到AWS SageMaker</h2><p id="87fa" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">我们需要做的第一件事是在AWS ECR中创建MLflow模型启动器的图像。MLflow model launcher是您在每个模型的artefact box中看到的东西，其中我们有一个模板化的代码，可以检索保存的模型并作为前端接口运行它，以进行预测。要创建这个容器，只需使用<code class="fe mt mu mv mw b">mlflow</code>并在您的终端中键入:</p><pre class="kj kk kl km gt ny mw nz oa aw ob bi"><span id="72f0" class="kz la it mw b gy oc od l oe of">venv/bin/mlflow sagemaker build-and-push-container</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/a3c57309324090cba0f7234d73f92e28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DJeZ6m_Jz8IT7TrXeX4MYQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图16: MLflow已在ECR中推送mlflow-pyfunc映像。</p></figure><p id="fb47" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">根据您的互联网连接，此命令将在AWS ECR上构建和推送基本MLflow映像。检索图像uri，类似于<code class="fe mt mu mv mw b">YOUR_AWS_NUMBER.dkr.ecr.YOUR_REGION.amazonaws.com/mlflow-pyfunc:VERSION_NUMBER</code>。</p><p id="0419" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">从这里开始，您需要一小段代码<a class="ae ky" href="https://dagshub.com/stefanobosisio1/sentiment_mlflow/src/main/register_model.py" rel="noopener ugc nofollow" target="_blank">，这里是链接</a>，以将您的模型部署到SageMaker——图17。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh nx l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图17:将注册的MLflow模型部署到SageMaker端点。</p></figure><p id="827c" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">在图17的Python代码中，我们使用了create ECR image container uri、model uri——在本例中用于“staging”环境——和<code class="fe mt mu mv mw b">awssagemakerdeployment</code>的<code class="fe mt mu mv mw b">arn</code>。部署将需要几分钟时间。前往SageMaker推理页面，您将看到新的闪亮端点。请记住:端点是有成本的！所以实验完记得删。在这种情况下，我们使用一个<code class="fe mt mu mv mw b">ml.t2.medium</code>实例，它是最小和最便宜的。</p><p id="d5bf" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">这样一个端点可以很容易地从这个脚本中进行本地查询:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh nx l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图18:给定一条输入tweet，从部署的SageMaker端点运行预测的脚本。</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi on"><img src="../Images/54c447b9b1766e8cd3c1569b7bb6c46c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AcYIO0P2cDCy7VgvnYUfWg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图19:一旦模型被部署，模型在Sagemaker推断端点中是可见的。</p></figure><h1 id="0d7c" class="nl la it bd lb nm nn no le np nq nr lh jz ns ka ll kc nt kd lp kf nu kg lt nv bi translated">4.在EC2实例上部署Streamlit应用程序，并通过您的仪表板运行预测</h1><p id="405d" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">我们遗漏了什么？一个简单的前端，一个实用的用户界面，通过简单地输入我们的输入tweet来查询模型。为此，Streamlit派上了用场。Streamlit已经做好了一切准备，可以使用它简单而伟大的Python模块<a class="ae ky" href="https://streamlit.io/gallery" rel="noopener ugc nofollow" target="_blank">来创建一个伟大的界面，正如你从Streamlit图库</a>中看到的那样。</p><p id="3b98" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">我必须承认，我不是Streamlit中疯狂花哨设计的超级专家，但是，我知道如何用最少的努力创建一个简单的仪表板，以接收输入tweet并返回预测。</p><h2 id="874f" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">创建简单的Streamlit仪表板应用程序</h2><p id="84dc" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated"><a class="ae ky" href="https://dagshub.com/stefanobosisio1/sentiment_mlflow/src/main/dashboard.py" rel="noopener ugc nofollow" target="_blank">仪表板的参考代码可在此处找到。</a></p><p id="f7f2" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">首先，安装<code class="fe mt mu mv mw b">streamlit</code>版本1.11.0，因为您可能会遇到新版本和Python &gt; 3.8的错误:</p><pre class="kj kk kl km gt ny mw nz oa aw ob bi"><span id="04e5" class="kz la it mw b gy oc od l oe of">venv/bin/pip install streamlit==1.11.0</span></pre><p id="7055" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">然后，我们需要一些元素来创建一个紧凑的前端。从图18中，我们可以复制<code class="fe mt mu mv mw b">check_status</code>和<code class="fe mt mu mv mw b">query_endpoint</code>函数，它们将被用来调用端点。如图20所示，这些调用然后围绕Streamlit进行包装</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh nx l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图20:在我们的Streamlit应用程序中接收输入tweet并返回情感的简单代码。</p></figure><p id="f864" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">您可以通过调用<code class="fe mt mu mv mw b">streamlit</code>在本地测试这段代码，如下所示:</p><pre class="kj kk kl km gt ny mw nz oa aw ob bi"><span id="5e96" class="kz la it mw b gy oc od l oe of">venv/bin/streamlit run dashboard.py</span></pre><p id="9342" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">这将直接在您的浏览器中运行。如果一切正常，您就可以将这个应用程序部署到EC2实例了</p><h2 id="664d" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">将您的仪表板部署到EC2实例</h2><p id="db4f" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">在AWS控制台上，转到EC2并点击<code class="fe mt mu mv mw b">Launch Instance:</code></p><ul class=""><li id="4d47" class="mx my it lx b ly mo mb mp li mz lm na lq nb mn og nd ne nf bi translated">为您的机器选择一个名称。</li><li id="0c87" class="mx my it lx b ly ng mb nh li ni lm nj lq nk mn og nd ne nf bi translated">在“应用程序和操作系统映像(亚马逊机器映像)”下，选择Ubuntu——我用的是22.04</li><li id="5e2a" class="mx my it lx b ly ng mb nh li ni lm nj lq nk mn og nd ne nf bi translated">“实例类型”可以是一个<code class="fe mt mu mv mw b">t1.micro</code>——我们不需要这个应用程序的超级能力</li><li id="ba30" class="mx my it lx b ly ng mb nh li ni lm nj lq nk mn og nd ne nf bi translated">在“密钥对”上，单击“创建密钥对”。选择<code class="fe mt mu mv mw b">RSA</code>和<code class="fe mt mu mv mw b">.pem</code>格式，并给密钥对命名，例如<code class="fe mt mu mv mw b">StreamlitDeployment</code>。一个<code class="fe mt mu mv mw b">.pem</code>文件将被下载到您的本地。</li><li id="7ea6" class="mx my it lx b ly ng mb nh li ni lm nj lq nk mn og nd ne nf bi translated">“网络设置”:点击“编辑”并向下滚动，直到您可以添加一个“自定义安全组”，如图21所示。这里添加一个“自定义TCP ”,可以访问Streamlit使用的端口“8501”。将来源保留为“任何地方”。请注意，对于公司的应用程序，这必须在您的VPC内得到保护。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/c109aa05525b37d000019754c0db5568.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MWu77JMSbZUg7pzEqcDdVg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图21:选择Add security group rule为Streamlit使用的端口8501建立新的TCP连接。</p></figure><p id="5829" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">保持所有其他设置不变，并创建虚拟机。然后，记下机器的“公共IPv4 DNS”，其格式类似于<code class="fe mt mu mv mw b">ec2-MACHINE_IP.compute-1.amazonaws.com</code>。最后，检查机器的“用户名”,点击机器的“实例ID ”,然后点击“连接”。在这种情况下，机器用户名应该是<code class="fe mt mu mv mw b">ubuntu</code>。</p><p id="71c0" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">现在我们可以从本地命令行连接到机器。首先，我们需要对下载的<code class="fe mt mu mv mw b">pem</code>密钥对文件授予读取权限，然后我们可以使用以下命令对虚拟机进行<code class="fe mt mu mv mw b">ssh</code>:</p><pre class="kj kk kl km gt ny mw nz oa aw ob bi"><span id="4a2f" class="kz la it mw b gy oc od l oe of">chmod 400 StreamlitDeployment.pem <br/>ssh -I "StreamlitDeployment" ubuntu@PUBLIC_IPv4_DNS</span></pre><p id="14ec" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">在前面的段落中检索到了<code class="fe mt mu mv mw b">PUBLIC_IPv4_DNS</code>。</p><p id="9297" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">在虚拟机中，我们需要安装所有缺失的依赖项:</p><pre class="kj kk kl km gt ny mw nz oa aw ob bi"><span id="4f64" class="kz la it mw b gy oc od l oe of">sudo apt-get update</span><span id="f514" class="kz la it mw b gy op od l oe of">wget <a class="ae ky" href="https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh" rel="noopener ugc nofollow" target="_blank">https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh</a> -O ~/miniconda.sh</span><span id="6e49" class="kz la it mw b gy op od l oe of">bash ~/miniconda.sh -b -p ~/miniconda</span><span id="a577" class="kz la it mw b gy op od l oe of">echo "PATH=$PATH:$HOME/miniconda/bin" &gt;&gt; ~/.bashrc</span><span id="e41c" class="kz la it mw b gy op od l oe of">source ~/.bashrc</span><span id="034d" class="kz la it mw b gy op od l oe of">pip install streamlit<br/>pip install pandas<br/>pip install boto3</span></pre><p id="22da" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">最后，我们可以将我们创建的<code class="fe mt mu mv mw b">dashboard.py</code>文件复制到虚拟机:</p><pre class="kj kk kl km gt ny mw nz oa aw ob bi"><span id="7b68" class="kz la it mw b gy oc od l oe of">scp -i "StreamlitDeployment.pem" dashboard.py ubuntu@PUBLIC_IPv4_DNS:~/. </span></pre><p id="4af2" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">以及AWS存储在我们笔记本电脑上的<code class="fe mt mu mv mw b">~/.aws</code>下的<code class="fe mt mu mv mw b">credentials</code>文件</p><pre class="kj kk kl km gt ny mw nz oa aw ob bi"><span id="2505" class="kz la it mw b gy oc od l oe of">scp -I "StreamlitDeployment.pem" ~/.aws/credentials ubuntu@PUBLIC_IPv4_DNS:~/.aws/.</span></pre><p id="2f32" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">直接从终端，我们可以立即测试Streamlit应用程序:</p><pre class="kj kk kl km gt ny mw nz oa aw ob bi"><span id="6afd" class="kz la it mw b gy oc od l oe of">streamlit run dashboard.py</span><span id="a354" class="kz la it mw b gy op od l oe of"><strong class="mw iu">You can now view your Streamlit app in your browser.</strong></span><span id="bef2" class="kz la it mw b gy op od l oe of">Network URL: <strong class="mw iu">http://172.31.22.205:8501</strong></span><span id="47aa" class="kz la it mw b gy op od l oe of">External URL: <strong class="mw iu">http://54.146.192.225:8501</strong></span></pre><p id="02b3" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">如果您连接到<code class="fe mt mu mv mw b"><a class="ae ky" href="http://54.146.192.225:8501," rel="noopener ugc nofollow" target="_blank">http://54.146.192.225:8501</a></code> <a class="ae ky" href="http://54.146.192.225:8501," rel="noopener ugc nofollow" target="_blank">、</a><code class="fe mt mu mv mw b">External URL</code>，您将能够与仪表板应用程序进行交互:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oq"><img src="../Images/b286efb6328928ce59dfecb2f56769b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vdfo2gEnE3iX_uVUeGWvpw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图22:我们创建并从EC2实例运行的Streamlit应用程序示例。</p></figure><p id="300b" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">一切都很好，但我们可以做得更好，利用<code class="fe mt mu mv mw b">TMUX</code>启动一个流会话，这样我们就可以从虚拟机注销，并在不保持连接的情况下与应用程序交互。让我们安装TMUX:</p><pre class="kj kk kl km gt ny mw nz oa aw ob bi"><span id="c239" class="kz la it mw b gy oc od l oe of">sudo apt-get tmux</span></pre><p id="21d0" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">并开始流式会话:</p><pre class="kj kk kl km gt ny mw nz oa aw ob bi"><span id="dab9" class="kz la it mw b gy oc od l oe of">tmux new -s StreamlitSession</span></pre><p id="c348" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">现在我们可以自由运行Streamlit，应用程序将在tmux会话中运行:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi or"><img src="../Images/0515c0a49dbcc4666a79dae8b3388c25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GOniVf6Pnde30c2NIYDzvg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图23:仪表板中给出的输入和来自情感分类器的输出结果的例子。</p></figure><p id="a2e8" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">您可以通过按下<code class="fe mt mu mv mw b">Ctrl+B</code>离开SSH外壳，并在旁边按下<code class="fe mt mu mv mw b">D</code>键。这个组合将使您脱离<code class="fe mt mu mv mw b">tmux</code>会话，您将能够从SSH连接中注销。如果您想停止<code class="fe mt mu mv mw b">tmux</code>会话，只需重新连接到机器并寻找正在运行的作业的<code class="fe mt mu mv mw b">PID</code></p><pre class="kj kk kl km gt ny mw nz oa aw ob bi"><span id="936c" class="kz la it mw b gy oc od l oe of">ps aux | grep streamlit</span></pre><p id="c9b0" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">并终止该进程</p><pre class="kj kk kl km gt ny mw nz oa aw ob bi"><span id="34a2" class="kz la it mw b gy oc od l oe of">kill PID NUMBER</span></pre><h1 id="80e5" class="nl la it bd lb nm nn no le np nq nr lh jz ns ka ll kc nt kd lp kf nu kg lt nv bi translated">优点、缺点、局限性和未来的工作</h1><p id="f111" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">在这个阶段，我们可以稍微回顾一下整个过程。我们可以立即指出一些优点:</p><ul class=""><li id="3438" class="mx my it lx b ly mo mb mp li mz lm na lq nb mn og nd ne nf bi translated">Git-DagsHub接口通过提供一个专用的MLflow服务器和存储来减轻我们的负担。这节省了大量时间和麻烦，因为我们不必设置虚拟机或特定的VPC权限或基础架构(例如对等)，就可以在我们的所有云工具之间共享MLflow系统</li><li id="aed2" class="mx my it lx b ly ng mb nh li ni lm nj lq nk mn og nd ne nf bi translated">如果我们是基于AWS的MLflow提供了一个超级简单的接口来处理我们注册的模型。我们不需要担心创建docker文件或特定的SageMaker代码</li></ul><p id="7004" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">还有一些缺点:</p><ul class=""><li id="0ac7" class="mx my it lx b ly mo mb mp li mz lm na lq nb mn og nd ne nf bi translated">我们可能不基于AWS。在这种情况下，MLflow为Azure部署提供了一个很好的解决方案，但不适用于Google云平台。<a class="ae ky" rel="noopener" target="_blank" href="/spin-up-your-models-in-gcp-ai-platform-with-mlflow-deployment-plugin-c0198077dca1">不久前我曾试图填补这一空白</a>，但还需要进一步的工作，以在MLflow模型注册中心和GCP之间建立更无缝的接口</li><li id="58c2" class="mx my it lx b ly ng mb nh li ni lm nj lq nk mn og nd ne nf bi translated">如果您想将这个模型升级到Heroku，DagsHub目前没有提供任何与这个部署提供者的CI/CD接口。因此，您需要创建更多的图像(docker-compose ),让注册的模型和端点接口被Heroku包装起来，并作为定制图像托管</li><li id="16f0" class="mx my it lx b ly ng mb nh li ni lm nj lq nk mn og nd ne nf bi translated">SageMaker端点成本！在部署您的超级ML模型之前，考虑部署SageMaker批量转换作业而不是端点的可能性。<a class="ae ky" href="https://github.com/mlflow/mlflow/issues/1472" rel="noopener ugc nofollow" target="_blank">这里是GitHub问题请求和到适应该批量转换请求的MLflow PRs的链接。</a></li></ul><p id="022c" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">因此，我们需要从这个出发点考虑今后的工作。首先，我们可以找到一种合适的方式来填补MLflow和其他云提供商(不是Azure，不是AWS)之间的差距。额外的帮助可能来自谢顿。Seldon提供了一个MLflow接口来托管和旋转模型——不管Kubernetes可能会带来哪些复杂问题。值得一提的是最近的MLflow实现<a class="ae ky" href="https://github.com/wianai/mlflow-deployment-controller" rel="noopener ugc nofollow" target="_blank">，这是一个新的mlflow部署控制器</a>，可以在多个云平台上铺平所有的部署道路。请继续关注，因为我将尝试与您分享类似的内容:)</p><h1 id="b5e3" class="nl la it bd lb nm nn no le np nq nr lh jz ns ka ll kc nt kd lp kf nu kg lt nv bi translated">结论</h1><p id="04ac" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">这是一个很长的教程，但我想你对最后的结果很满意。我们学到了很多东西，所以让我们来回顾一下:</p><ul class=""><li id="191b" class="mx my it lx b ly mo mb mp li mz lm na lq nb mn og nd ne nf bi translated">我们学习了如何创建一个简单的模型并将其记录到MLflow中，如何向MLflow认证，以及跟踪我们的实验。关键要点:实现MLflow Python bits、身份验证、跟踪概念。</li><li id="5047" class="mx my it lx b ly ng mb nh li ni lm nj lq nk mn og nd ne nf bi translated">我们看到了如何使我们的代码更通用，利用了<code class="fe mt mu mv mw b">sklearn</code>管道的功能，创建了我们的定制转换器来处理数据，并使它们成为最终训练管道的一部分。</li><li id="ce50" class="mx my it lx b ly ng mb nh li ni lm nj lq nk mn og nd ne nf bi translated">我们学习了如何将我们最好的模型部署到AWS。首先，我们将模型注册到MLflow registry，然后使用MLflow sagemaker部署方案并设置AWS IAM角色。</li><li id="a271" class="mx my it lx b ly ng mb nh li ni lm nj lq nk mn og nd ne nf bi translated">最后，我们用Streamlit为我们的模型创建了一个前端，并学习了如何设置EC2实例来适应这个应用程序。</li></ul><p id="ada7" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">我希望你喜欢这个教程，并感谢阅读它。</p></div><div class="ab cl os ot hx ou" role="separator"><span class="ov bw bk ow ox oy"/><span class="ov bw bk ow ox oy"/><span class="ov bw bk ow ox"/></div><div class="im in io ip iq"><h1 id="99f1" class="nl la it bd lb nm oz no le np pa nr lh jz pb ka ll kc pc kd lp kf pd kg lt nv bi translated">支持我的写作</h1><p id="2cbd" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated"><em class="pe">通过我的推荐链接加入Medium来支持我的写作和项目:</em></p><div class="pf pg gp gr ph pi"><a href="https://stefanobosisio1.medium.com/membership" rel="noopener follow" target="_blank"><div class="pj ab fo"><div class="pk ab pl cl cj pm"><h2 class="bd iu gy z fp pn fr fs po fu fw is bi translated">通过我的推荐链接加入Medium-Stefano Bosisio</h2><div class="pp l"><h3 class="bd b gy z fp pn fr fs po fu fw dk translated">阅读Stefano Bosisio(以及媒体上成千上万的其他作家)的每一个故事。为什么支持我？1)关于人工智能的文章…</h3></div><div class="pq l"><p class="bd b dl z fp pn fr fs po fu fw dk translated">stefanobosisio1.medium.com</p></div></div><div class="pr l"><div class="ps l pt pu pv pr pw ks pi"/></div></div></a></div><p id="be13" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">如果有任何问题或意见，请随时给我发电子邮件，地址是:stefanobosisio1@gmail.com，或者直接在Medium这里。</p></div></div>    
</body>
</html>