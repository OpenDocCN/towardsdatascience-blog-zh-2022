<html>
<head>
<title>Scaling MLOps with resilient pipelines</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用弹性管道扩展 MLOps</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/i-tried-scaling-sagemaker-pipeline-executions-and-this-happened-31279b92821e#2022-03-27">https://towardsdatascience.com/i-tried-scaling-sagemaker-pipeline-executions-and-this-happened-31279b92821e#2022-03-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="cd66" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">通过重试策略提高 SageMaker 管道的弹性</h2></div><p id="44ea" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">昨天，我使用 SageMaker Pipelines 自动化了一个预测项目的工作流程。我启动了 3 个并发管道执行来在不同的时间范围内训练模型。想象预测一天，一周，一个月。</p><p id="a119" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">过了一会儿，2 次执行失败。这是一个简单的培训工作配额问题。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lc"><img src="../Images/a494d1c8730ea39cfd30ea33b06aec0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T-VWvPpYHoMFdvfx1OelRw.jpeg"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">布莱恩·麦高恩在<a class="ae lb" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="69d6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像 MLOps 项目中的所有事情一样，您的管道执行可能会由于各种因素而失败。事实上，建造一条永不失败的管道是不可能的。</p><p id="8e97" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这篇文章中，我将向您展示如何使用重试策略使您的 SageMaker 管道对常见错误更有弹性。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="e0d6" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">先决条件</h1><p id="619d" class="pw-post-body-paragraph kf kg iq kh b ki mr jr kk kl ms ju kn ko mt kq kr ks mu ku kv kw mv ky kz la ij bi translated">要浏览此示例，请确保您具备以下条件:</p><ol class=""><li id="4836" class="mw mx iq kh b ki kj kl km ko my ks mz kw na la nb nc nd ne bi translated">如果您对 SageMaker Pipelines 听起来很陌生，请访问<a class="ae lb" href="https://www.youtube.com/watch?v=Hvz2GGU3Z8g" rel="noopener ugc nofollow" target="_blank">介绍亚马逊 SageMaker Pipelines </a>。我们将以鲍鱼为例进行说明。</li><li id="6955" class="mw mx iq kh b ki nf kl ng ko nh ks ni kw nj la nb nc nd ne bi translated">我们将在示例 MLOps 管道中使用重试策略。确保您熟悉 AWS 上的<a class="ae lb" href="https://aws.amazon.com/builders-library/timeouts-retries-and-backoff-with-jitter/" rel="noopener ugc nofollow" target="_blank">超时、重试和带抖动的回退</a>。</li></ol></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="663a" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">每件事都会失败</h1><p id="4b88" class="pw-post-body-paragraph kf kg iq kh b ki mr jr kk kl ms ju kn ko mt kq kr ks mu ku kv kw mv ky kz la ij bi translated">默认情况下，使用 SageMaker 管道，当管道步骤报告错误时，会导致执行完全失败。</p><p id="f585" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">以下是在对具有某些实例类型的<a class="ae lb" href="https://www.youtube.com/watch?v=Hvz2GGU3Z8g" rel="noopener ugc nofollow" target="_blank">鲍鱼管道示例</a>启动执行时可能会出现的错误示例。在这里，我的帐户在培训工作中使用<code class="fe nk nl nm nn b">ml.c5n.2xlarge</code>的配额为 1:</p><div class="ld le lf lg gt ab cb"><figure class="no lh np nq nr ns nt paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><img src="../Images/1694780ce5c60c07445935b5ae873da1.png" data-original-src="https://miro.medium.com/v2/resize:fit:588/format:webp/1*nQ_KK6hGX-XpBxR6uag9gw.png"/></div></figure><figure class="no lh nu nq nr ns nt paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><img src="../Images/46fa9b610e2ca25a9154be09c7b17352.png" data-original-src="https://miro.medium.com/v2/resize:fit:1414/format:webp/1*muYpKYxcS0VG8ovIMtCshw.png"/></div><p class="lo lp gj gh gi lq lr bd b be z dk nv di nw nx translated">作者图片:我的第一个管道执行成功了，而另外两个管道执行了<strong class="bd ny">resourcelimitexceed</strong>错误和<strong class="bd ny"> failed </strong>。</p></figure></div><p id="4539" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当出现这种错误时，我们是否可以构建能够容忍并降低完全失败概率的管道？在 MLOps 项目中，是否有可能将失败视为一种自然现象？</p><h2 id="17c5" class="nz ma iq bd mb oa ob dn mf oc od dp mj ko oe of ml ks og oh mn kw oi oj mp ok bi translated">通过重试策略提高管道弹性</h2><p id="3048" class="pw-post-body-paragraph kf kg iq kh b ki mr jr kk kl ms ju kn ko mt kq kr ks mu ku kv kw mv ky kz la ij bi translated">在亚马逊，我们设计系统来降低和容忍失败的可能性。想象一下，即使房子着火了，系统也能继续运行。</p><p id="3940" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你可以在<a class="ae lb" href="https://youtu.be/AaYNwOh90Pg?t=862" rel="noopener ugc nofollow" target="_blank">彼得·德桑蒂斯</a>和<a class="ae lb" href="https://youtu.be/OdzaTbaQwTg?t=2527" rel="noopener ugc nofollow" target="_blank">沃纳·沃格尔斯</a>关于发明的会议中一窥端倪。每年我最喜欢的一些。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi om"><img src="../Images/e369b67ace529be20f414417e3b816ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dyCcuc2RlDDuvU2t"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">图片来自<a class="ae lb" href="https://www.youtube.com/watch?v=OdzaTbaQwTg" rel="noopener ugc nofollow" target="_blank"> re:Invent </a>。失败是必然的，随着时间的推移，一切终将失败——沃纳·威格尔</p></figure><p id="461c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通常，在管道上应用重试策略是提高管道健壮性的一个好方法。<a class="ae lb" href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-retry-policy.html" rel="noopener ugc nofollow" target="_blank"> SageMaker 重试策略</a>有助于在错误发生后自动重试管道步骤。它们可以很方便地应对局部和暂时故障，这些故障通常会在一段时间后自行纠正。</p><p id="fc94" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">参见<a class="ae lb" href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-retry-policy.html#pipelines-retry-policy-supported-exceptions" rel="noopener ugc nofollow" target="_blank">重试策略支持的异常类型</a>了解 SageMaker 管道支持的异常的更多详细信息。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="1d4b" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">在管道中设置重试策略</h1><h2 id="66bc" class="nz ma iq bd mb oa ob dn mf oc od dp mj ko oe of ml ks og oh mn kw oi oj mp ok bi translated">在管道中添加重试策略很简单</h2><p id="d466" class="pw-post-body-paragraph kf kg iq kh b ki mr jr kk kl ms ju kn ko mt kq kr ks mu ku kv kw mv ky kz la ij bi translated">在我们的鲍鱼示例中，我们将使用来自<a class="ae lb" href="https://github.com/aws/sagemaker-python-sdk/blob/master/src/sagemaker/workflow/retry.py" rel="noopener ugc nofollow" target="_blank"> SageMaker python SDK </a>的<code class="fe nk nl nm nn b">StepRetryPolicy</code>和<code class="fe nk nl nm nn b">SageMakerJobStepRetryPolicy</code>。他们将帮助我们减轻我们在培训步骤中看到的<code class="fe nk nl nm nn b">ResourceLimitExceeded</code>问题。您可以在<a class="ae lb" href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-retry-policy.html#pipelines-retry-policy-json-schema" rel="noopener ugc nofollow" target="_blank"> SageMaker 文档</a>中找到关于策略字段和模式的详细信息。</p><p id="b719" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面是我如何为我的渠道创建策略:</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="on oo l"/></div></figure><p id="b710" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我将策略设置为间隔 30 秒，回退率为 2。这意味着 SageMaker 将在失败 30 秒后尝试启动训练步骤，1 分钟后重试，2 分钟后重试，依此类推。所有这些都有 240 分钟的到期时间，所以我不会以停滞的管道执行结束。</p><p id="8972" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面是我如何在培训步骤中应用这些策略:</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="on oo l"/></div></figure><p id="15da" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以在这里找到<a class="ae lb" href="https://gist.github.com/SofianHamiti/0855ed3d4e525472be5ce1a754cbf22d" rel="noopener ugc nofollow" target="_blank">示例管道，并根据您的用例随意调整策略。</a></p><h2 id="a5cd" class="nz ma iq bd mb oa ob dn mf oc od dp mj ko oe of ml ks og oh mn kw oi oj mp ok bi translated">现在是容易的部分！</h2><p id="2159" class="pw-post-body-paragraph kf kg iq kh b ki mr jr kk kl ms ju kn ko mt kq kr ks mu ku kv kw mv ky kz la ij bi translated">您可以使用<code class="fe nk nl nm nn b">ml.c5n.2xlarge</code>实例再次启动并发管道执行。</p><div class="ld le lf lg gt ab cb"><figure class="no lh op nq nr ns nt paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><img src="../Images/ce2bb8f170758298668ddda339b82633.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*YgiRBYzNCE_3p0hLCOReKA.png"/></div></figure><figure class="no lh op nq nr ns nt paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><img src="../Images/5ec892798c560c08f7f1c7dd47011f2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gRcev-PBEFcqoBiS0c01bQ.png"/></div></figure><figure class="no lh op nq nr ns nt paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><img src="../Images/7ee057277e6ceace64fc8d36e265b026.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*geUUCXqTg60G4B4KeXRmBg.png"/></div><p class="lo lp gj gh gi lq lr bd b be z dk oq di or nx translated">作者提供的图片:现在，其他执行并没有失败，而是等待并重试各自的训练步骤，直到成功。</p></figure></div></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="a061" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">结论</h1><p id="d3ff" class="pw-post-body-paragraph kf kg iq kh b ki mr jr kk kl ms ju kn ko mt kq kr ks mu ku kv kw mv ky kz la ij bi translated">任何事情都会失败，您的 MLOps 管道也会失败。</p><p id="e481" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们在鲍鱼管道示例中应用了重试策略，并使其对资源限制错误更具弹性。这是一个简单的技巧，您可以在项目中使用它来降低完全执行失败的可能性。</p><p id="49f0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你也可以阅读<a class="ae lb" rel="noopener" target="_blank" href="/mlops-with-mlflow-and-amazon-sagemaker-pipelines-33e13d43f238"> MLOps with MLFlow 和亚马逊 SageMaker Pipelines </a>，了解你可以用 SageMaker MLOps 项目做的其他很酷的事情。</p></div></div>    
</body>
</html>