<html>
<head>
<title>Pandas Tricks for Time Series Analysis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于时间序列分析的熊猫把戏</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/pandas-tricks-for-time-series-analysis-726618532172#2022-09-21">https://towardsdatascience.com/pandas-tricks-for-time-series-analysis-726618532172#2022-09-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1cd8" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用于分析熊猫时间序列的3个函数(带代码)</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/018a7772507981c5c6abbae9ca862bd1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X_12RuZwnBGB9DjxS9w8yg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@goumbik?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">卢卡斯·布拉塞克</a>在<a class="ae ky" href="https://unsplash.com/s/photos/time-series?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="5313" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">熊猫几乎不需要介绍。对于那些刚刚开始接触数据科学领域的人来说，Pandas代表Panel Data Analysis，是目前Python中数据转换的主要库。</p><p id="9782" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">除了很多其他的东西，我们还可以使用这个漂亮的包来分析时间序列。可以，有很多方法可以用。在这篇文章中，我们将会看到其中的一些。</p><h1 id="e605" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">时间序列</h1><p id="6873" class="pw-post-body-paragraph lg lh it li b lj mu ju ll lm mv jx lo lp mw lr ls lt mx lv lw lx my lz ma mb im bi translated">让我们首先商定什么是时间序列。</p><blockquote class="mz"><p id="573e" class="na nb it bd nc nd ne nf ng nh ni mb dk translated">在连续时间内获得的一个量的一系列值，它们之间通常有相等的间隔。(牛津语言)</p></blockquote><p id="192f" class="pw-post-body-paragraph lg lh it li b lj nj ju ll lm nk jx lo lp nl lr ls lt nm lv lw lx nn lz ma mb im bi translated">简单地说，时间序列是指我们在一段时间内测量的东西，比如说商店的销售额。因此，我们将从1月、2月、3月开始取值，以此类推，直到12月。这将为我们提供一个包含月份和销售额的数据集。这是一个时间序列。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/19fbde62746539bd8e343dc8b2f6b7b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xQSe1TzgRJ4fuiU_l4tpBA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">熊猫创造的时间序列。图片由作者提供。</p></figure><p id="2707" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">熊猫对处理时间序列有充分的准备。下一节将展示一些有助于我们分析的代码片段。</p><h1 id="15ee" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">使用熊猫</h1><p id="2e40" class="pw-post-body-paragraph lg lh it li b lj mu ju ll lm mv jx lo lp mw lr ls lt mx lv lw lx my lz ma mb im bi translated">咱们<code class="fe np nq nr ns b">import numpy as np</code>和<code class="fe np nq nr ns b">import pandas as pd</code>吧。</p><p id="06c0" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我们应该学习的第一件事是如何在熊猫中创建一组日期。这在生成用于训练目的的时间序列时非常有用。</p><p id="8132" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">因此，如果我们使用<code class="fe np nq nr ns b">date_range()</code>，就有可能创建我们想要的任意多的日期，使用任何需要的时间间隔。</p><pre class="kj kk kl km gt nt ns nu nv aw nw bi"><span id="8e77" class="nx md it ns b gy ny nz l oa ob"># Create a date range of 7 days<br/>pd.date_range("2022-01-01", periods=7, freq='D')</span><span id="3c55" class="nx md it ns b gy oc nz l oa ob"><strong class="ns iu">[OUT]:<br/></strong>DatetimeIndex(['2022-01-01', '2022-01-02', '2022-01-03', '2022-01-04','2022-01-05', '2022-01-06', '2022-01-07'],               dtype='datetime64[ns]', freq='D')</span></pre><p id="0d33" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">注意，输出是一个从我们的初始日期起7天的列表。还有许多其他频率可用作<code class="fe np nq nr ns b">freq</code>。最常见的是表示每周的<code class="fe np nq nr ns b">"W”</code>、表示月末日期的<code class="fe np nq nr ns b">"M”</code>、表示月初的<code class="fe np nq nr ns b">"MS”</code>以及其他许多<a class="ae ky" href="https://pandas.pydata.org/docs/user_guide/timeseries.html#timeseries-offset-aliases" rel="noopener ugc nofollow" target="_blank">可以在这里找到的</a>。</p><p id="2c5e" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">知道了这一点，我们可以继续创建一个数据集，用于本帖中的练习。我们将设置一个种子，这样您就可以重现与我相同的结果，然后我们创建一个包含每日日期和销售额的数据集，并将日期设置为索引。</p><pre class="kj kk kl km gt nt ns nu nv aw nw bi"><span id="a61b" class="nx md it ns b gy ny nz l oa ob"># Setting a seed for reproductionability<br/>np.random.seed(12)</span><span id="ac6a" class="nx md it ns b gy oc nz l oa ob"># Create dataset<br/>df = pd.DataFrame({<br/> 'date': pd.date_range("2022-01-01", periods=180, freq='D'),<br/> 'sales': np.random.randint(1000, 10000, size=180)})</span><span id="f23b" class="nx md it ns b gy oc nz l oa ob"> # Set index<br/>df = df.set_index('date')</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi od"><img src="../Images/a60cbfb54b43e5108b50016e9db6e66b.png" data-original-src="https://miro.medium.com/v2/resize:fit:318/format:webp/1*uChetxuDoLmLr0UUy_Jo4Q.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">数据集头。图片由作者提供。</p></figure><p id="018f" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">现在，我们将继续熊猫的功能代码。请注意，时间序列的一个重要特征是将日期作为索引。当我们在前面的代码中设置索引时，我们已经满足了这个要求。</p><h2 id="119b" class="nx md it bd me oe of dn mi og oh dp mm lp oi oj mo lt ok ol mq lx om on ms oo bi translated">重新取样</h2><p id="d274" class="pw-post-body-paragraph lg lh it li b lj mu ju ll lm mv jx lo lp mw lr ls lt mx lv lw lx my lz ma mb im bi translated">第一个有趣的函数是<code class="fe np nq nr ns b">resample</code>。它所做的是接受一个数据集或一个系列(一列),并根据作为参数提供的<code class="fe np nq nr ns b">rule</code>聚集数据。这是一种按日期按功能分组的方式。</p><p id="dde3" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我们的数据集日期频率是每天，对吗？如果要转化为月销售额呢？</p><p id="ca46" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我们可以用<code class="fe np nq nr ns b">resample</code>做到这一点，但是由于数据被聚合，我们还必须添加一个函数来处理聚合的数字。我们可以<code class="fe np nq nr ns b">sum()</code>或计算<code class="fe np nq nr ns b">mean()</code>或<code class="fe np nq nr ns b">median()</code>，看月份的<code class="fe np nq nr ns b">max()</code><em class="op">等</em>。</p><pre class="kj kk kl km gt nt ns nu nv aw nw bi"><span id="e1cc" class="nx md it ns b gy ny nz l oa ob"># Resample by month end date<br/>df.resample(rule= 'M').mean()</span></pre><p id="30a7" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">按月取平均值，并将指数设置为每月结束日期，结果如下。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/0401613769f8fe0f196d3e3cf91c05d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:432/format:webp/1*hWN95X9ghY7ROIb8XSfGBA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">按月平均。图片由作者提供。</p></figure><p id="3a76" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">现在让我们按周销售额来绘制汇总数据。</p><pre class="kj kk kl km gt nt ns nu nv aw nw bi"><span id="59b1" class="nx md it ns b gy ny nz l oa ob"># Resample plot<br/>df.resample('W').mean().plot(figsize=(15,5), title='Avg Weekly Sales');</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi or"><img src="../Images/9d8db004cc39866fa3562e59188c1752.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ntS8dyKdCqw9i0yUh8UQVw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">平均每周销售额。图片由作者提供。</p></figure><p id="efc7" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">看起来我们的销售额在三月和四月之间有所下降，在六月中旬达到顶峰。</p><h2 id="fc9c" class="nx md it bd me oe of dn mi og oh dp mm lp oi oj mo lt ok ol mq lx om on ms oo bi translated">变化</h2><p id="3436" class="pw-post-body-paragraph lg lh it li b lj mu ju ll lm mv jx lo lp mw lr ls lt mx lv lw lx my lz ma mb im bi translated">Pandas中的<code class="fe np nq nr ns b">shift</code>功能是让你在一列中上下移动数据。假设我们要将当天的销售额与前一天的销售额()以及当天的销售额与下周的销售额()进行比较。下面是如何使用<code class="fe np nq nr ns b">shift</code>完成的。</p><pre class="kj kk kl km gt nt ns nu nv aw nw bi"><span id="e3e8" class="nx md it ns b gy ny nz l oa ob"># Create a copy of the data<br/>df_shift = df.copy()</span><span id="3328" class="nx md it ns b gy oc nz l oa ob">#Shift one day up<br/>df_shift['next_day_sales'] = df_shift.sales.shift(-1)</span><span id="479d" class="nx md it ns b gy oc nz l oa ob">#Shift one week up<br/>df_shift['next_week_sales'] = df_shift.sales.shift(-7)</span></pre><p id="6dbf" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">看看我们如何拉动第二天的销售额和7天的销售额，将它们放在一起进行比较。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi os"><img src="../Images/1b70ec158a93da3b071ad8a688b297af.png" data-original-src="https://miro.medium.com/v2/resize:fit:836/format:webp/1*_-HI29Xk9o4W7HAqW0FZ2g.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">当天对次日对下周。图片由作者提供。</p></figure><p id="27e0" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">显然，如果需要，我们可以在这些列之间创建差异。</p><pre class="kj kk kl km gt nt ns nu nv aw nw bi"><span id="03d2" class="nx md it ns b gy ny nz l oa ob"># Net gain/loss week over week<br/>df_shift['one_week_net'] = df_shift.sales - df_shift.sales.shift(-7)</span></pre><h2 id="f1a5" class="nx md it bd me oe of dn mi og oh dp mm lp oi oj mo lt ok ol mq lx om on ms oo bi translated">滚动平均值</h2><p id="e101" class="pw-post-body-paragraph lg lh it li b lj mu ju ll lm mv jx lo lp mw lr ls lt mx lv lw lx my lz ma mb im bi translated">下一个函数是从事股票交易的人常用的工具，即<code class="fe np nq nr ns b">rolling</code>平均值。事实上，这个功能是可以与其他功能结合使用的，不仅意味着，而且它恰好是最常见的。</p><p id="c2ef" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">这个函数创建一个窗口来聚集数据。因此，举例来说，如果我们创建2天的移动平均值，<code class="fe np nq nr ns b">rolling</code>将从数据集中提取连续2天的子集，并计算聚合结果，即最大值、中值或最常用的平均值。</p><pre class="kj kk kl km gt nt ns nu nv aw nw bi"><span id="bed0" class="nx md it ns b gy ny nz l oa ob"># Calculate 2 days average with Pandas<br/>df.rolling(2).mean()</span></pre><p id="a448" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">在下图中，我们可以看到第一个值是一个<code class="fe np nq nr ns b">NaN</code>，因为没有足够的数据(本例中为2个数据点)来创建平均值。因此，对于第二个点，它获取原始数据集的前两行，并计算平均点。(6787 + 4325)/2 = 5556.</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/e2e0bbfe9b6f3327e57f151dd6b3153e.png" data-original-src="https://miro.medium.com/v2/resize:fit:342/format:webp/1*MJm9vky3wVC5fgE4nAVPCw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">2天移动平均线。图片由作者提供。</p></figure><p id="e9a2" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">滚动平均非常常用于绘制数据，是趋势的一个很好的指示。子集周期越长，线越平滑。注意，100天滚动平均线几乎是一条线，只是显示主要趋势，而7天平均线随着数据上下波动。</p><pre class="kj kk kl km gt nt ns nu nv aw nw bi"><span id="d432" class="nx md it ns b gy ny nz l oa ob"># Rolling plot<br/>df.sales.plot(figsize=(25,8), legend=True, linestyle='--', color='darkgray')</span><span id="94bc" class="nx md it ns b gy oc nz l oa ob">df.rolling(window=7).sales.mean().plot(legend=True, label='7 day average', linewidth=2)</span><span id="d63f" class="nx md it ns b gy oc nz l oa ob">df.rolling(30).sales.mean().plot(legend=True, label='30 day average', linewidth=3)</span><span id="870e" class="nx md it ns b gy oc nz l oa ob">df.rolling(100).sales.mean().plot(legend=True, label='100 day average', linewidth=4);</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ou"><img src="../Images/ec9e76c621ea8fbeba715b6057197bbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8wBE5cFO-U-beESx8ra0oQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">实际数据(灰色)与7、30和100天平均值的比较。图片由作者提供。</p></figure><h1 id="c495" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">在你走之前</h1><p id="1110" class="pw-post-body-paragraph lg lh it li b lj mu ju ll lm mv jx lo lp mw lr ls lt mx lv lw lx my lz ma mb im bi translated">我相信熊猫对我们分析任何数据都是有价值的，当然也包括时间序列。这篇文章中介绍的这三个函数可以帮助你开始时间序列分析。好好利用他们。</p><ul class=""><li id="4aef" class="ov ow it li b lj lk lm ln lp ox lt oy lx oz mb pa pb pc pd bi translated"><code class="fe np nq nr ns b">resample</code>:将数据从日频率转换到其他时间频率。</li><li id="131e" class="ov ow it li b lj pe lm pf lp pg lt ph lx pi mb pa pb pc pd bi translated"><code class="fe np nq nr ns b">shift</code>:在列中上下移动数据，进行比较或计算。</li><li id="8c83" class="ov ow it li b lj pe lm pf lp pg lt ph lx pi mb pa pb pc pd bi translated"><code class="fe np nq nr ns b">rolling</code>:创建滚动平均线，观察趋势。</li></ul><p id="cb16" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">如果你喜欢这些数据，请关注我。</p><div class="pj pk gp gr pl pm"><a href="http://gustavorsantos.medium.com/" rel="noopener follow" target="_blank"><div class="pn ab fo"><div class="po ab pp cl cj pq"><h2 class="bd iu gy z fp pr fr fs ps fu fw is bi translated">古斯塔沃·桑托斯-中等</h2><div class="pt l"><h3 class="bd b gy z fp pr fr fs ps fu fw dk translated">阅读古斯塔夫·桑托斯在媒介上的作品。数据科学家。我从数据中提取见解，以帮助个人和公司…</h3></div><div class="pu l"><p class="bd b dl z fp pr fr fs ps fu fw dk translated">gustavorsantos.medium.com</p></div></div><div class="pv l"><div class="pw l px py pz pv qa ks pm"/></div></div></a></div><p id="018c" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">如果你想成为中等会员，<a class="ae ky" href="https://gustavorsantos.medium.com/membership" rel="noopener">这里有一个介绍链接</a>。</p><h1 id="9c36" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">参考</h1><p id="c7a2" class="pw-post-body-paragraph lg lh it li b lj mu ju ll lm mv jx lo lp mw lr ls lt mx lv lw lx my lz ma mb im bi translated">熊猫日期范围:<a class="ae ky" href="https://pandas.pydata.org/docs/reference/api/pandas.date_range.html" rel="noopener ugc nofollow" target="_blank">https://pandas . pydata . org/docs/reference/API/pandas . Date _ Range . html</a></p><p id="4809" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">熊猫再取样:<a class="ae ky" href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.resample.html" rel="noopener ugc nofollow" target="_blank">https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.resample.html</a></p><p id="2682" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">熊猫转移:<a class="ae ky" href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.shift.html" rel="noopener ugc nofollow" target="_blank">https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.shift.html</a></p><p id="201c" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">熊猫滚滚:<a class="ae ky" href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.rolling.html" rel="noopener ugc nofollow" target="_blank">https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.rolling.html</a></p></div></div>    
</body>
</html>