<html>
<head>
<title>How to calculate a percentage of total in BigQuery using SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用SQL计算BigQuery中的百分比</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-calculate-a-percentage-of-total-in-bigquery-using-sql-59b077c1225f#2022-08-16">https://towardsdatascience.com/how-to-calculate-a-percentage-of-total-in-bigquery-using-sql-59b077c1225f#2022-08-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1170" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">比较一行对所有行总和的贡献</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/d4d57813c1a5352a67ca129279de4542.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ypeE1H811PXnYS9y"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@karim_manjra?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">卡里姆·曼吉拉</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><h1 id="c46e" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">为什么要用总数的百分比？</h1><p id="640d" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">假设你有一个销售咖啡的电子商务网站，你有三种不同类别的产品:阿拉比卡、罗布斯塔和利百丽卡。</p><p id="33fd" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在一份报告上，你看到2022年6月，你卖出了阿拉比卡的<strong class="lt iu">34.5万€，罗布斯塔</strong>的<strong class="lt iu">11.2万€，利百丽卡</strong>的<strong class="lt iu">13万€。从绝对值来看，你会注意到阿拉比卡咖啡是你最大的收入来源，但从百分比来看，<strong class="lt iu">它代表了你本月销售额的73% </strong>。</strong></p><blockquote class="ms"><p id="f206" class="mt mu it bd mv mw mx my mz na nb mm dk translated">这个想法是看一行对所有行的总和的贡献</p></blockquote><p id="6d65" class="pw-post-body-paragraph lr ls it lt b lu nc ju lw lx nd jx lz ma ne mc md me nf mg mh mi ng mk ml mm im bi translated">为了避免通过将一个值除以所有值的总和来手动计算该百分比，我们将学习如何使用SQL来帮助我们，并帮助回答以下问题:</p><ul class=""><li id="a534" class="nh ni it lt b lu mn lx mo ma nj me nk mi nl mm nm nn no np bi translated"><strong class="lt iu">什么产品对我们公司的收入贡献最大？</strong></li><li id="2063" class="nh ni it lt b lu nq lx nr ma ns me nt mi nu mm nm nn no np bi translated"><strong class="lt iu">随着时间的推移，我们国家的市场份额如何演变？</strong></li></ul><p id="46b6" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在本文中，我们的数据来自于<a class="ae ky" href="https://shop.googlemerchandisestore.com/" rel="noopener ugc nofollow" target="_blank">谷歌商品电子商务网站</a>。对于我们的分析，我们的表包含销售的产品、产品名称和类别以及产生的收入。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/fc9569d9c0865067b11aea98ed0f5d61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OzazicC5Il7zPhkCKCuSWg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们的基本数据表。(图片由<a class="ae ky" href="https://romaingranger.medium.com/" rel="noopener">作者</a>提供)</p></figure></div><div class="ab cl nw nx hx ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="im in io ip iq"><h2 id="c765" class="od la it bd lb oe of dn lf og oh dp lj ma oi oj ll me ok ol ln mi om on lp oo bi translated">产品类别对总收入的贡献</h2><p id="8179" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">对于我们的第一个业务问题，我们想知道每个产品类别对我们总收入的贡献有多大。</p><p id="b68f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">首先，我们需要计算每个产品类别的总收入。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="op oq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们计算每个产品类别的总收入。</p></figure><p id="9584" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">因此，我们得到一个表，每个产品类别和产生的收入各占一行。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi or"><img src="../Images/967cadb9f2925664f4c7b22167c79a12.png" data-original-src="https://miro.medium.com/v2/resize:fit:724/format:webp/1*dsDwr-cIVgprEoykrVAWdw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">每个产品类别的总收入。(图片由<a class="ae ky" href="https://romaingranger.medium.com/" rel="noopener">作者</a></p></figure><p id="4a98" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们的网店总共有<strong class="lt iu"> 21个类目</strong>，如果做营收之和(<code class="fe os ot ou ov b">revenue_per_category</code>字段之和)，得到<strong class="lt iu">174万</strong>(也就是我们的网店总营收)<strong class="lt iu">。</strong></p><p id="7be0" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在，要获得总收入的百分比，我们需要将每个类别的收入除以总收入。</p><p id="0fc2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">为了实现这一点，不使用<code class="fe os ot ou ov b">JOIN</code>子句，您可以使用<code class="fe os ot ou ov b">OVER()</code>子句。让我们深入细节:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="op oq l"/></div></figure><p id="cd35" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在顶部的<code class="fe os ot ou ov b">WITH</code>子句中，我们有一个计算每个类别收入的第一个查询。在我们的主语句中，在<code class="fe os ot ou ov b">*</code>之后有两行:</p><ul class=""><li id="9931" class="nh ni it lt b lu mn lx mo ma nj me nk mi nl mm nm nn no np bi translated">第一行计算总收入(您实际上并不需要它，<strong class="lt iu">它只是为了突出语法</strong>并展示如何使用窗口函数)</li><li id="4edd" class="nh ni it lt b lu nq lx nr ma ns me nt mi nu mm nm nn no np bi translated">第二行计算每个类别的收入份额。</li></ul><p id="cc2b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">你可以注意到我们使用了一个<code class="fe os ot ou ov b">SAFE_DIVIDE</code>函数，以防我们除以0(意味着我们的总收入为0)。该函数将返回收入份额的<code class="fe os ot ou ov b">NULL</code>值，而不是抛出“<strong class="lt iu">除以0”</strong>错误。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/a31cc3ed4ed1853aaf956fc04f0ab969.png" data-original-src="https://miro.medium.com/v2/resize:fit:1328/format:webp/1*Q1u_vYCth4WDKhGQ2WDcbw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">每个类别的收入份额。(图片由<a class="ae ky" href="https://romaingranger.medium.com/" rel="noopener">作者</a>提供)</p></figure><p id="ae15" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这就是你如何在Data Studio中用饼状图绘制它:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ox"><img src="../Images/28d7d4ec7c5d76de123801482d08dfc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bWqNtNzAgMGoFqiYRG8j9A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">每个产品类别占我们总收入的份额。(图片由<a class="ae ky" href="https://romaingranger.medium.com/" rel="noopener">作者</a>提供)</p></figure><p id="52d5" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">服装<strong class="lt iu">类别是贡献最大的类别，与<strong class="lt iu">其他</strong>和<strong class="lt iu">办公室</strong>并列。</strong></p><p id="7ca9" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们可以看到，我们有两个不同的类别<strong class="lt iu">其他</strong>和<strong class="lt iu">其他。</strong></p><ul class=""><li id="436f" class="nh ni it lt b lu mn lx mo ma nj me nk mi nl mm nm nn no np bi translated"><strong class="lt iu">其他</strong>是我们数据中标注为“其他”的类别。</li><li id="3c8e" class="nh ni it lt b lu nq lx nr ma ns me nt mi nu mm nm nn no np bi translated"><strong class="lt iu">其他</strong>是因为Data studio在数据点过多的时候会截断结果。这里我们只显示10个切片，但是我们有21个类别。通过这样做，Data Studio将所有剩余的类别组合成一个名为<strong class="lt iu"> others </strong>的类别。</li></ul></div><div class="ab cl nw nx hx ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="im in io ip iq"><h2 id="a905" class="od la it bd lb oe of dn lf og oh dp lj ma oi oj ll me ok ol ln mi om on lp oo bi translated">一段时间内产品类别对收入的贡献</h2><p id="57b2" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">对于我们的第二个业务问题，我们想知道我们的产品类别的收入份额是如何随着时间变化的。</p><p id="ec2d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">为此，我们将计算每个产品类别每月的收入，然后计算该月每个产品类别占总收入的百分比。</p><p id="1e2f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">首先，我们需要计算每个类别在一段时间内的总收入(在我们的例子中是每个月)。我们每月增加第二个<code class="fe os ot ou ov b">GROUP BY</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="op oq l"/></div></figure><p id="ff18" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">因此，每个月每个产品类别和产生的收入各占一行。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/e8d7d95b1a25c2ff8b4a7ae1870b28e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1006/format:webp/1*qb9uOYwssE9wrt9BHAWvaw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们每个类别的每月总收入。(图片由<a class="ae ky" href="https://romaingranger.medium.com/" rel="noopener">作者</a>提供)</p></figure><p id="6c5d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">为了查看随时间的变化，我们不查看21个类别，而是放大第一个业务问题中看到的<strong class="lt iu">前4个类别</strong>:服装、其他、办公用品和饮料。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="op oq l"/></div></figure><p id="735c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">您可以注意到，我们创建了一个子查询，它封装了我们的<code class="fe os ot ou ov b">ratio</code>字段，在我们计算出每月总数的百分比后，过滤所需的类别。如果我们之前进行了筛选，总收入将只代表这四个类别。</p><p id="f34e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们在这个查询中的窗口函数与本文前一部分中使用的非常相似，除了我们的<code class="fe os ot ou ov b">OVER()</code>子句现在将每个月划分为分区。</p><p id="2d5a" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这导致了以下结果:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oz"><img src="../Images/333e1884ee7af2be409b65686f08ccda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H08DLXtxUaqhcIZE-xFhIg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">几个月来我们前四大类别总收入的百分比。(图片由<a class="ae ky" href="https://romaingranger.medium.com/" rel="noopener">作者</a>提供)</p></figure><p id="dbd5" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们可以观察到<strong class="lt iu"> Other </strong>类别肯定是跟踪错误或被贴错标签，因为它不会在一个月内返回，并且是2016年8月至9月期间唯一出现的类别。</p><p id="8e56" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">随着时间的推移，我们确实看到这三个类别占我们商店收入的60%,而在2017年1月,<strong class="lt iu">“办公室”</strong>类别的贡献超过了以往。</p><h1 id="459c" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">结论</h1><p id="7315" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">如果我们在SQL中学习这种方法，它可以节省手动计算的时间，并且能够为许多类别/维度扩展这种计算。</p><p id="c487" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这也是因为并不是所有的数据仓库系统都提供了一种有效的方法来计算一个比率或总份额。BigQuery的情况并非如此。</p><p id="8f14" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">其他系统，如亚马逊红移或雪花有一个名为<code class="fe os ot ou ov b">ratio_to_report()</code>的窗口函数，它计算我们在本文中看到的内容。数据可视化系统，如Tableau或QlikSense，也使计算总百分比变得更加容易。</p><p id="bff2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">感谢您的阅读；我希望这篇文章给了你计算和理解它背后的方法的关键。</p></div></div>    
</body>
</html>