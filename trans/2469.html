<html>
<head>
<title>How I Cut 92% of Data Processing Time Using a Simple Copy and Paste</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我如何使用简单的复制和粘贴来减少92%的数据处理时间</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-i-cut-92-of-data-processing-time-using-a-simple-copy-and-paste-b62df85a7845#2022-05-30">https://towardsdatascience.com/how-i-cut-92-of-data-processing-time-using-a-simple-copy-and-paste-b62df85a7845#2022-05-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1b9f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解您的工具非常重要</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e4a7d3053a4492b74e373a461c11117c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jTuzyPIdFUd40TiWmeuAzw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">把你的数据变成一辆微调过的赛车！照片由苏拉夫·米什拉拍摄:<a class="ae ky" href="https://www.pexels.com/photo/grey-coupe-on-road-3136673/" rel="noopener ugc nofollow" target="_blank">https://www.pexels.com/photo/grey-coupe-on-road-3136673/</a></p></figure><p id="a6fe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我很想说标题是点击诱饵，但在这种情况下，它实际上是真实的。让我解释一下。</p><h1 id="d648" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">背景</h1><p id="be7c" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">几个月前，一位我多年前合作过的首席技术官在LinkedIn上找到了我。他在一家新公司工作，需要一些帮助。</p><p id="2f55" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">“嘿，布拉德——我记得你对Postgres很有经验。如果您的日程安排中有时间，并且您对此感兴趣，您是否有兴趣打个电话？”</p><p id="f855" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是一条简单的信息，没有真正的细节，但似乎很有趣。我们安排了一次会面，他解释道。</p><p id="a46d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">他的公司通过供应商管理的托管解决方案推送大量数据。问题是，有一些性能和稳定性问题正在蔓延，使他的客户保证成为一个主要的苦差事。他希望有人能充当翻译，以确保所提供的信息是可靠的，并翻译深奥的技术内容。</p><p id="356e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这听起来很容易，为什么不呢？</p><p id="f0fb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我正在正式提名这个假设为年度轻描淡写。</p><p id="a58e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我终于进去看到我到底在处理什么的时候，我有点震惊。数据库已经增长到80TB左右，一些单独的表(和索引)超过了15TB。汪汪。</p><p id="4af6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通常，当我突然接到一个电话，要求进入这样一个场景时，我会认为是“正常”大小的数据库。大约在0.5-2TB的范围内。当一家公司拥有如此规模的数据存储库时，通常会有团队来管理它，以保持一切正常运行。</p><p id="38b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这次不会。我不得不成为主题专家，与一些在不同领域拥有专业知识的非常有才华的人争论，以了解他们面临的数据挑战。</p><h1 id="a59c" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">从哪里开始？</h1><p id="8c1f" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">第一个合乎逻辑的步骤是确保系统实际上是半调优的，以处理数据的大小和运行它的硬件。</p><p id="6306" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">波斯特格里斯是一只有趣的野兽。它对用户非常友好，但对朋友很挑剔。它将愉快地允许管理员和用户做各种各样的坏事，并将尽可能地适应。</p><p id="c968" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这造成了一个相当大的问题。对于如何调整数据库以应对如此规模的存储中的海量数据，目前还没有太多的指南或建议。</p><p id="faba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你有一个数据库容量为几百GB的web应用程序，搜索一下，有大量的指南可以让你在附近找到合适的位置，并让你以相当不错的性能运行。您需要通过一个非最优的数据模型来获得您的结果——您可以通过stackoverflow中的一个示例来获得您需要的结果。你大概不会有太多问题。</p><p id="6af8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Postgres会尽力满足你。它有一个伟大的计划者和一个伟大的引擎来执行这些计划。</p><p id="f1ec" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不利的一面是，与MySQL / MariaDB或类似的更加自我配置的数据库相比，您可能会看到显著的改进。</p><p id="cfd6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你拨对了，Postgres可以成为你梦寐以求的印第车。即使大数据贯穿其模式。</p><p id="630a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以，我的第一步是把它拿到附近。也许不能成为一级方程式赛车，但至少可以成为一辆普通车。</p><p id="83d6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我花了很多时间寻找共享缓冲区、工作内存和维护工作内存的最佳值。我还调整了真空和自动真空设置，以保持东西干净整洁。</p><p id="1f3f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不久，该系统的规模就适合数据和硬件。它不再有可靠性问题，并且它的资源使用情况开始变得更好。</p><p id="5872" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然这不是本文的主旨，但我确实想提到，在上下文中，性能和可靠性稳定性是需要检查的主要项目。仅此一项就能帮助业务部门让客户满意。如果顾客不高兴，没有人会高兴。</p><h1 id="9c07" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">大问题</h1><p id="6580" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">随着我对这些问题的深入研究，另一个令人烦恼的问题出现了，那就是总体性能不佳。</p><p id="46d4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尽管数据量很大，但运行查询的时间比我预期的要长。有些是设计，有些只是活动，但有些东西似乎不对劲。</p><p id="dc3e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我想花一秒钟解释一下最后一句话。在我长期与各种系统打交道的过程中，无论是网络、操作系统还是数据库，我都喜欢称之为系统管理员第六感。这是一种经验的功能，既有一般的，也有你正在处理的系统的特殊功能。你开始凭直觉知道什么时候事情表现不好。</p><p id="58b0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这不是真正的魔法或任何神秘的东西。只是观察不同的系统，理解在特定的条件下特定的输入可能会产生什么。你可能不会立即知道什么是错的，但你通常可以知道什么时候是不对的。都是关于对细节的关注。</p><p id="64b1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">利用我的蜘蛛感应，我知道有一个问题。</p><p id="aeeb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于阅读这篇文章的有经验的人来说，你可能会想，“好吧，废话。”然而，我面临的更大的挑战是，我正在使用一个包含高度机密和受保护信息的数据库。虽然我有权限使用系统，但我没有权限使用数据本身。</p><p id="382b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">做顾问的另一个乐趣。</p><p id="be8d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，为了探索这个问题，我需要与内部团队合作，为我提供一些匿名的查询样本。在看到查询后的10分钟内，我意识到了问题所在。</p><h1 id="1c5b" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">揭秘</h1><p id="28e8" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">如果你不需要等待消息的披露，那么一个类似点击诱饵的标题有什么用呢？</p><p id="35cf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过系统上的主要查询，我看到了Postgres性能的死亡之吻。可怕的选择独特。</p><p id="4ddd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在一群愤怒的数据库管理员和数据分析师拿着干草叉和火把来到我的住所之前，让我为自己辩护一下。</p><p id="4d75" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">简单地说，Postgres根本不能很好地处理DISTINCTs。这不是一般陈述，而是后置陈述。</p><p id="b751" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我喜欢Postgres的一点是它符合SQL标准。它倾向于默认一个标准，而不是创造自己的语言风格。这也意味着，在某些情况下，虽然系统会符合您的要求，但实现并不完美——或者在这种情况下，很好。</p><p id="e04a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">其他数据库引擎如SQLServer、Oracle、MySQL等。，处理很好，对性能影响最小。Postgres没有。这是一个例外，一个让一切都不同的例外。</p><p id="9a4a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你看，简单地说，其他RDBMS引擎允许索引可以很容易地跳过，以提取唯一的值。它是高效和有效的。</p><p id="f026" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另一方面，Postgres必须首先检索整个集合，然后对集合进行二次扫描，以识别并返回唯一值。这看起来并不多，但在数据世界里，这很重要。开始向查询中添加列，最终会有多次查询。</p><p id="457d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，对于像这样的使用一个关键字的大型数据库上的每个查询，仅返回集合就需要花费大量的时间和资源。</p><p id="8fee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们如何绕过它？</p><p id="8f0a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有多种方法。首先，如果模型正在开发中，我个人会努力确保数据的存储方式能够正确地返回唯一值，而不需要使用DISTINCT。有时会有例外，但大多数数据模型都可以用这种方式构建。</p><p id="4c11" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第二，如果我的第一个偏好不可行，我将尝试使用其他构造来提供有问题的查询的唯一集合。这可能是视图的战略性使用，甚至是集合返回函数，允许减少不确定性和构造更好的查询。不利的一面是，这通常需要花费更多的时间和精力在数据库及其使用上，以确定在哪里以及如何使用它们。</p><p id="fddf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第三，通常还有其他方法来编写查询。</p><p id="85bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们现代的开发世界中，我们经常倾向于将快速开发置于快速性能之上。如果你在云中，资源是无限的(对吗？)所以只要某个东西有点快，我们总是可以给这个实例更多的信任，然后强行使用它。我是在开玩笑，但不完全是。</p><p id="c177" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通常有一种方法可以优化性能，只需以稍微不同的方式考虑数据。只需要一点点创意。</p><h1 id="8264" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">简单的方法</h1><p id="9a3a" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">删除DISTINCT的最快、最简单的方法就是将SELECT子句复制到GROUP BY子句中。</p><p id="fa49" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我提到的其他数据库上，如果您运行查询分析来查看计划，您将经常看到一个不同的和一个等价的GROUP BY具有几乎相同的查询计划。这是由计划者进行的优化，以注意到这些大多是等价的功能。</p><p id="2641" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Postgres不是这样的。DISTINCT和GROUP BY将有非常不同的计划，并且在大多数情况下最终会导致非常不同的执行时间。对于针对大型数据集的复杂查询，这可能会产生重大影响。</p><p id="21e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我将注意到有例外和警告。什么时候没有？但作为一般指导，我个人认为这是真的。考虑到变更的简单性，用代码测试和实现通常影响不大。</p><h1 id="4b8d" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">证明</h1><p id="ffd9" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">说了这么多，还是说证明吧。</p><p id="d15a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我的客户有一个正在运行的查询，要将大量数据从一个位置移动到另一个位置。从本质上说，他们从数据库中提取交易数据，并将其转移到一个进行更多分析和报告的位置。</p><p id="b5b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是一个夜间过程，在我开始之前，平均需要25个小时才能完成。它回避了这样一个问题，如果花费超过一天的时间，这是否是真正的每日报告，但这是一个完全不同的语义讨论。</p><p id="f470" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">环境的稳定和配置的更改产生了一些较小的平均影响，但实际上花费在此操作上的时间始终保持在25小时。</p><p id="19ce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过将SELECT DISTINCT修改为SELECT … GROUP，将该过程缩短为2小时。</p><p id="b57f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个简单的改变将花费的时间减少了92%。它只是将SELECT子句复制并粘贴到GROUP BY子句中。</p><h1 id="6485" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">结论</h1><p id="dfb5" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">正如我一直试图指出的那样，不仅对我的客户，而且在这篇文章中——这篇文章对一个简单的概念进行了冗长的解释——这一切都归结于了解您的系统。</p><p id="6a31" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">仅仅知道系统如何工作是不够的。你还需要知道它的细微差别和古怪之处。它在哪里出类拔萃，又在哪里奋斗？有什么地方不符合传统智慧吗？</p><p id="be0a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你用一套特定的技术工作足够长的时间，你会慢慢学到这些经验。如果你像我一样，碰巧做了很多这种类型的咨询，你只需要进入每一个新的环境，知道堆栈中的每一项技术都有一些令人头痛或拯救者的东西。</p><p id="000d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">密切关注，做你的研究，你会发现有时甚至ctrl+c / ctrl+v也能给你意想不到的结果。</p></div></div>    
</body>
</html>