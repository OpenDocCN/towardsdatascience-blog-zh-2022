<html>
<head>
<title>What Is Behind The Python “with” Statement?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python的“with”语句背后是什么？</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/what-is-behind-the-python-with-statement-89c74be3a6bd#2022-06-27">https://towardsdatascience.com/what-is-behind-the-python-with-statement-89c74be3a6bd#2022-06-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/594e1f352d5a6dcee630b5c25d467948.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q1McwDZMZ7LuobUDdI69Ng.jpeg"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">图片由<a class="ae jg" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=3129361" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae jg" href="https://pixabay.com/users/skitterphoto-324082/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=3129361" rel="noopener ugc nofollow" target="_blank">鲁迪和</a>彼得·斯皮特林拍摄</p></figure><div class=""/><div class=""><h2 id="79cd" class="pw-subtitle-paragraph kg ji jj bd b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dk translated">您可以编写支持“with”语句的定制函数和类</h2></div><p id="7d22" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我相信你一定曾经在Python中使用过“with”语句，只要你不是几天前才开始学习的Python新手。众所周知，我们可以使用with语句创建资源的“上下文”,而不必担心随后关闭或释放它。</p><p id="66aa" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">由于这种语法在Python中是独一无二的，您有没有想过幕后到底发生了什么？在本文中，我将深入介绍Python with语句，并提供一些在程序中灵活使用它的想法。</p><h1 id="2e78" class="lu lv jj bd lw lx ly lz ma mb mc md me kp mf kq mg ks mh kt mi kv mj kw mk ml bi translated">1.为什么使用“with”语句？</h1><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/95eb3651c4ea1047785bdaf23f98c408.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dYTBMakdc5SoLSCceInJ_A.jpeg"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">图片来自<a class="ae jg" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1683134" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae jg" href="https://pixabay.com/users/coyot-2009089/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1683134" rel="noopener ugc nofollow" target="_blank">尤拉杰·沃尔高</a></p></figure><p id="6c46" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们从一些基本的开始。with-statement最常见的用例之一是在Python问题中打开文件。假设我们想打开一个文本文件并向其中写入一些内容，然后关闭它。最简单的代码如下。</p><h2 id="e5d6" class="mq lv jj bd lw mr ms dn ma mt mu dp me lh mv mw mg ll mx my mi lp mz na mk nb bi translated">1.1一个不好的例子</h2><pre class="mm mn mo mp gt nc nd ne nf aw ng bi"><span id="b292" class="mq lv jj nd b gy nh ni l nj nk"># Bad Example<br/>f = open('my.txt', 'w')<br/>f.write('Hello!')<br/>f.close()</span></pre><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/629dcf8e32863ea82bc25430564a2851.png" data-original-src="https://miro.medium.com/v2/resize:fit:1092/format:webp/1*Ezhy9Li9pv2wPeECgJUA_A.png"/></div></figure><p id="9148" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">上面的代码将打开一个名为<code class="fe nm nn no nd b">my.txt</code>的文件，然后将字符串<code class="fe nm nn no nd b">Hello!</code>写入其中。然后，我们需要关闭文件流来释放这个资源，以避免内存泄漏之类的问题。</p><p id="eeb7" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然而，这是一个不好的例子。如果在我们操纵文件的过程中出了问题，程序将永远不会到达<code class="fe nm nn no nd b">close()</code>方法。</p><h2 id="734b" class="mq lv jj bd lw mr ms dn ma mt mu dp me lh mv mw mg ll mx my mi lp mz na mk nb bi translated">1.2“常规”解决方案</h2><p id="79b6" class="pw-post-body-paragraph ky kz jj la b lb np kk ld le nq kn lg lh nr lj lk ll ns ln lo lp nt lr ls lt im bi translated">因此，更好的解决方案是将<code class="fe nm nn no nd b">close()</code>方法放在finally-block中，后面跟着一个try-except块。</p><pre class="mm mn mo mp gt nc nd ne nf aw ng bi"><span id="327d" class="mq lv jj nd b gy nh ni l nj nk"># Try Except<br/>f = open('my.txt', 'r')<br/>try:<br/>    print(f.readline())<br/>except:<br/>    pass<br/>finally:<br/>    f.close()</span></pre><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/d3e6ef66276851456e7c7e0299b23cc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1112/format:webp/1*sn6p6NJ2bJQkfFaxWmOlgw.png"/></div></figure><p id="d1f2" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">上面的代码这次以读取模式打开文件，然后读取第一行并打印出来。“finally”块确保<code class="fe nm nn no nd b">close()</code>方法被保证执行，即使可能有错误。</p><h2 id="0216" class="mq lv jj bd lw mr ms dn ma mt mu dp me lh mv mw mg ll mx my mi lp mz na mk nb bi translated">1.3推荐的解决方案</h2><p id="6401" class="pw-post-body-paragraph ky kz jj la b lb np kk ld le nq kn lg lh nr lj lk ll ns ln lo lp nt lr ls lt im bi translated">推荐的解决方案是在Python中使用with语句。代码非常简单，如下所示。</p><pre class="mm mn mo mp gt nc nd ne nf aw ng bi"><span id="1cfc" class="mq lv jj nd b gy nh ni l nj nk"># With Statement<br/>with open('my.txt', 'r') as f:<br/>    print(f.readline())</span></pre><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/c2dcd593278b23e1638029ace1cd52c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1224/format:webp/1*tmog5C6VQWytJRb5hEB_MA.png"/></div></figure><p id="c1ee" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们将该文件作为变量<code class="fe nm nn no nd b">f</code>打开，然后我们可以在这个with-statement块中使用该文件来做我们想做的任何事情。我们不会费心关闭文件。它也保证最终会被摧毁。同样，我们不能在上下文之外使用变量<code class="fe nm nn no nd b">f</code>。</p><p id="15ff" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">另外值得一提的是，从Python 3.1开始，我们可以在with语句中放置多个逗号分隔的上下文表达式。</p><pre class="mm mn mo mp gt nc nd ne nf aw ng bi"><span id="d248" class="mq lv jj nd b gy nh ni l nj nk">with open('my.txt', 'r') as f_source, open('my_new.txt', 'w') as f_dest:<br/>    f_dest.write(f_source.readline() + ' Again')</span></pre><p id="4794" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">此外，从Python 3.10开始，我们可以使用括号将多个表达式分组，这样代码就可以分成多行，从而提高可读性。</p><pre class="mm mn mo mp gt nc nd ne nf aw ng bi"><span id="c5b0" class="mq lv jj nd b gy nh ni l nj nk">with (<br/>    open('my.txt', 'r') as f_source,<br/>    open('my_new.txt', 'w') as f_dest<br/>):<br/>    f_dest.write(f_source.readline() + ' Again')</span></pre><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nw"><img src="../Images/887333566e817c00d4013a88dec2a6fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9uLJSkiEyUzus_VTPnsbKw.png"/></div></div></figure><p id="b911" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">顺便说一下，上面的代码打开原始文件<code class="fe nm nn no nd b">my.txt</code>作为源文件，打开一个新文件<code class="fe nm nn no nd b">my_new.txt</code>作为目标文件。然后，它从源文件中读取并写入作为目标的新文件。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nx"><img src="../Images/84c8e6388a6b6297d2975b5df02f9219.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_0HkXJwM2NbLW6t68W2lFw.png"/></div></div></figure><h1 id="da34" class="lu lv jj bd lw lx ly lz ma mb mc md me kp mf kq mg ks mh kt mi kv mj kw mk ml bi translated">2.“带”定制类</h1><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/6742a9ad839babd0696074fb1ef3631e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bMzxmifn0AqdBw-jcCFZ-A.jpeg"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">图片来自<a class="ae jg" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=911804" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae jg" href="https://pixabay.com/users/bodobe-1222375/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=911804" rel="noopener ugc nofollow" target="_blank"> bodobe </a></p></figure><p id="c84f" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">所有的回顾都已经在前面的章节中完成了。现在我们应该从一些深入的东西开始。为什么<code class="fe nm nn no nd b">open()</code>方法支持with-statement？我们能创建支持它的定制课程吗？</p><h2 id="16f2" class="mq lv jj bd lw mr ms dn ma mt mu dp me lh mv mw mg ll mx my mi lp mz na mk nb bi translated">2.1简单的例子</h2><p id="0795" class="pw-post-body-paragraph ky kz jj la b lb np kk ld le nq kn lg lh nr lj lk ll ns ln lo lp nt lr ls lt im bi translated">答案是肯定的。让我们从一个简单的类开始作为例子。</p><pre class="mm mn mo mp gt nc nd ne nf aw ng bi"><span id="15cb" class="mq lv jj nd b gy nh ni l nj nk">class Person:</span><span id="565e" class="mq lv jj nd b gy ny ni l nj nk">    def __init__(self, name):<br/>        self.name = name<br/>    <br/>    def greeting(self):<br/>        print(f'Hello, my name is {self.name}!')</span></pre><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nz"><img src="../Images/e50fff55343ce9c691192dbdc4a69f0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2Zf2s54S08Ytuklw3fbr4w.png"/></div></div></figure><p id="a92c" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">类<code class="fe nm nn no nd b">Person</code>只有两个方法，一个是init方法，它将<code class="fe nm nn no nd b">name</code>值作为类的属性。然后，还有一个<code class="fe nm nn no nd b">greeting()</code>方法，用这个人的名字打印一条问候消息。</p><p id="9d05" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们试试它的<code class="fe nm nn no nd b">greeting()</code>方法。</p><pre class="mm mn mo mp gt nc nd ne nf aw ng bi"><span id="2e2f" class="mq lv jj nd b gy nh ni l nj nk">Person('Chris').greeting()</span></pre><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/bd32701672456f862a0f591e1576b90d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*8EgVFUqZ6eNaLJoHM12jgw.png"/></div></figure><p id="af72" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，假设我们想在使用with语句的上下文中创建这个人。我们能做到吗？</p><pre class="mm mn mo mp gt nc nd ne nf aw ng bi"><span id="db7e" class="mq lv jj nd b gy nh ni l nj nk">with Person('Chris') as p:<br/>    p.greeting()</span></pre><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ob"><img src="../Images/991497f58bfea808b6cde9c54aa6ce10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y7GKaGfPra0BnjpgotpeSw.png"/></div></div></figure><p id="7084" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">显然，我们不能。然而，错误提醒了我们应该做什么。</p><h2 id="2fb4" class="mq lv jj bd lw mr ms dn ma mt mu dp me lh mv mw mg ll mx my mi lp mz na mk nb bi translated">2.2.__enter__和__exit__方法的实现</h2><p id="fe83" class="pw-post-body-paragraph ky kz jj la b lb np kk ld le nq kn lg lh nr lj lk ll ns ln lo lp nt lr ls lt im bi translated">为了能够使用with语句，我们需要实现<code class="fe nm nn no nd b">__enter__()</code>方法。事实上，还有另一个叫做<code class="fe nm nn no nd b">__exit__()</code>的方法是可选的。让我们看看下面的代码。</p><pre class="mm mn mo mp gt nc nd ne nf aw ng bi"><span id="7af2" class="mq lv jj nd b gy nh ni l nj nk">class Person:</span><span id="da99" class="mq lv jj nd b gy ny ni l nj nk">    def __init__(self, name):<br/>        self.name = name<br/>    <br/>    def greeting(self):<br/>        print(f'Hello, my name is {self.name}!')</span><span id="927e" class="mq lv jj nd b gy ny ni l nj nk">    def __enter__(self):<br/>        print('Creating a person object in a context...')<br/>        return self</span><span id="8860" class="mq lv jj nd b gy ny ni l nj nk">    def __exit__(self, exc_type, exc_value, exc_tb):<br/>        print("exception type:", exc_type)<br/>        print("exception value:", exc_value)<br/>        print("exception traceback:", exc_tb)<br/>        print('Object disposed')</span></pre><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oc"><img src="../Images/c631c5db95caaa169e62737ab704a813.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6hLAEIi4Y3uXavD8y0SX9Q.png"/></div></div></figure><p id="81eb" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这里，当使用with语句创建对象时，将执行<code class="fe nm nn no nd b">__enter__()</code>方法。它必须返回对象，也就是它自己。</p><p id="6b03" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当上下文结束并且需要释放对象时，将调用<code class="fe nm nn no nd b">__exit__()</code>方法。它还有3个参数，如果有异常，这些参数将捕捉异常的一些细节。</p><p id="c115" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，让我们再试一次代码。</p><pre class="mm mn mo mp gt nc nd ne nf aw ng bi"><span id="17f7" class="mq lv jj nd b gy nh ni l nj nk">with Person('Chris') as p:<br/>    p.greeting()</span></pre><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi od"><img src="../Images/7b76d551358ce9a87b042f0237a978c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dw7Mz5wA9Q4nfHO83gRxXw.png"/></div></div></figure><p id="da81" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">从输出中我们可以看到，<code class="fe nm nn no nd b">__enter__()</code>方法在其他任何事情之前被调用，然后执行with语句的主体，也就是问候消息。最后，调用<code class="fe nm nn no nd b">__exit__()</code>方法并释放对象。</p><h2 id="af25" class="mq lv jj bd lw mr ms dn ma mt mu dp me lh mv mw mg ll mx my mi lp mz na mk nb bi translated">2.3在With语句中处理异常</h2><p id="6f01" class="pw-post-body-paragraph ky kz jj la b lb np kk ld le nq kn lg lh nr lj lk ll ns ln lo lp nt lr ls lt im bi translated">上面的代码中没有发生异常，所以所有与异常相关的参数都是<code class="fe nm nn no nd b">None</code>。</p><pre class="mm mn mo mp gt nc nd ne nf aw ng bi"><span id="5b62" class="mq lv jj nd b gy nh ni l nj nk">with Person('Chris') as p:<br/>    a = 1/0<br/>    p.greeting()</span></pre><p id="7fe2" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这段代码中，我添加了<code class="fe nm nn no nd b">a = 1/0</code>，这肯定会导致错误。让我们看看with-statement将如何表现。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oe"><img src="../Images/854a66f1f60d4e05bc907c5dd1c60448.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HDpcbAQvCgat7q44k1nAcw.png"/></div></div></figure><p id="bf09" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">异常类型、值和追溯现在可用，因为有一个异常。这些回调参数使我们能够相应地处理异常。</p><h1 id="4e39" class="lu lv jj bd lw lx ly lz ma mb mc md me kp mf kq mg ks mh kt mi kv mj kw mk ml bi translated">3.“带”定制功能</h1><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/d3acdb1d222eb61be7c460053d37200d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dP1cPtkzhddVy_yROI9csQ.jpeg"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">图片来自<a class="ae jg" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=96240" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae jg" href="https://pixabay.com/users/weinstock-25534/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=96240" rel="noopener ugc nofollow" target="_blank"> Uwe Baumann </a></p></figure><p id="e32c" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">好吧，大多数时候我们可能想在函数中使用with语句，而不是创建一个对象。<code class="fe nm nn no nd b">open()</code>函数就是这样一个例子。也就是说，我们用这个函数写一个with语句，并给出我们想要打开的文件名。然后，它在这个上下文中打开文件，当离开上下文时，连接被破坏。</p><p id="20bd" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们可以使用Python内置的<code class="fe nm nn no nd b">contextlib</code>来做到这一点。具体来说，我们需要在这个模块中使用<code class="fe nm nn no nd b">contextmanager</code>。</p><pre class="mm mn mo mp gt nc nd ne nf aw ng bi"><span id="6753" class="mq lv jj nd b gy nh ni l nj nk">from contextlib import contextmanager</span></pre><p id="0a36" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后，我们可以用<code class="fe nm nn no nd b">contextmanager</code>作为装饰来定义函数。</p><p id="41df" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">假设我们要与一个数据库建立连接。让我们用伪代码来做这件事。</p><pre class="mm mn mo mp gt nc nd ne nf aw ng bi"><span id="f84d" class="mq lv jj nd b gy nh ni l nj nk"><a class="ae jg" href="http://twitter.com/contextmanager" rel="noopener ugc nofollow" target="_blank">@contextmanager</a><br/>def get_db_connection(connection_str):<br/>    db_con = 'connected to' + connection_str<br/>    try:<br/>        yield db_con<br/>    finally:<br/>        print('the connection is closed')</span></pre><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi of"><img src="../Images/a991edd0ea04392b43a48be5b36bd0a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kgnagFMDE0BQ51I_1Oe0DA.png"/></div></div></figure><p id="ecb1" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">该代码模拟连接到一个数据库。请注意，我们需要使用<code class="fe nm nn no nd b">yield</code>关键字来返回数据库连接。此外，我们需要使用try-except块，并确保异常得到处理，并且应该在finally块中释放资源。</p><p id="e50e" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在我们可以在with语句中使用这个函数。</p><pre class="mm mn mo mp gt nc nd ne nf aw ng bi"><span id="33a1" class="mq lv jj nd b gy nh ni l nj nk">with get_db_connection('mysql') as con:<br/>    print(con)</span></pre><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi og"><img src="../Images/59b6016059d91db9ca795530db3581da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mVpHxe3VnafWhbIi1Wi_Yg.png"/></div></div></figure><h1 id="3057" class="lu lv jj bd lw lx ly lz ma mb mc md me kp mf kq mg ks mh kt mi kv mj kw mk ml bi translated">摘要</h1><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/113265cea2c0cc839e131029bb000915.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*afZ4KkDbyidaI7LbvtHUKA.jpeg"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">图片来自<a class="ae jg" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=2468874" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae jg" href="https://pixabay.com/users/garageband-4200899/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=2468874" rel="noopener ugc nofollow" target="_blank"> garageband </a></p></figure><p id="3e5f" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这篇文章中，我已经介绍了我们什么时候需要使用with语句以及如何使用它。还解释了这种语法背后的机制。除此之外，我还介绍了如何编写一个支持with语句的类或函数。通过以这种方式实现一个类或一个函数，我们可以以一种非常Pythonic化的方式简化接口的使用。</p><div class="is it gp gr iu oh"><a href="https://medium.com/@qiuyujx/membership" rel="noopener follow" target="_blank"><div class="oi ab fo"><div class="oj ab ok cl cj ol"><h2 class="bd jk gy z fp om fr fs on fu fw ji bi translated">通过我的推荐链接加入灵媒-陶</h2><div class="oo l"><h3 class="bd b gy z fp om fr fs on fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="op l"><p class="bd b dl z fp om fr fs on fu fw dk translated">medium.com</p></div></div><div class="oq l"><div class="or l os ot ou oq ov ja oh"/></div></div></a></div><p id="5c53" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你觉得我的文章有帮助，请考虑加入Medium会员来支持我和成千上万的其他作者！(点击上面的链接)</p><blockquote class="ow"><p id="9de6" class="ox oy jj bd oz pa pb pc pd pe pf lt dk translated">除非另有说明，所有图片都是作者的</p></blockquote></div></div>    
</body>
</html>