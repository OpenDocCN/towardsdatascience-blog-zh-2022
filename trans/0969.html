<html>
<head>
<title>Apache Airflow for Data Science — How to Communicate Between Tasks with Airflow XComs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Apache Airflow for Data Science —如何使用 Airflow XComs 在任务之间进行通信</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/apache-airflow-for-data-science-how-to-communicate-between-tasks-with-airflow-xcoms-22b4cd075562#2022-03-14">https://towardsdatascience.com/apache-airflow-for-data-science-how-to-communicate-between-tasks-with-airflow-xcoms-22b4cd075562#2022-03-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5043" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">学习使用 XComs 在气流任务之间发送和接收数据</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/4df15c18106736c1f858bc2625df1244.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1is1_EaxwkNp1Nck"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@unandalusgus?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Gustavo Quepón </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="721e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编写气流 Dag 和任务非常有趣，但是如何在它们之间交换数据呢？这就是 XComs(“交叉通信”)的用武之地，它是一种允许任务相互“交谈”的机制。</p><p id="ae76" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">今天，您将学习如何将数据推送到 Airflow XComs，以及如何通过编写由两个任务组成的 DAG 来提取数据。两者都将利用<code class="fe lv lw lx ly b">PythonOperator</code>做一些非常基本的事情。您还将了解什么时候不应该使用 XComs，以及它的局限性。</p><p id="7ae7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不想看书？请观看我的视频:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lz ma l"/></div></figure></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="dcbc" class="mi mj it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">如何将一个值推送到气流 XComs</h1><p id="8725" class="pw-post-body-paragraph kz la it lb b lc na ju le lf nb jx lh li nc lk ll lm nd lo lp lq ne ls lt lu im bi translated">让我们从给气流 XComs 推一个值开始。这可以通过多种方式来实现，但是到目前为止最明确的方式是将<code class="fe lv lw lx ly b">do_xcom_push=True</code>指定为任务参数。</p><p id="3cbf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们将编写一个样板文件来处理库导入并声明 Airflow DAG:</p><pre class="kj kk kl km gt nf ly ng nh aw ni bi"><span id="a51c" class="nj mj it ly b gy nk nl l nm nn">from datetime import datetime<br/>from airflow.models import DAG<br/>from airflow.operators.python import PythonOperator<br/></span><span id="d444" class="nj mj it ly b gy no nl l nm nn">with DAG(<br/>    dag_id='xcom_dag',<br/>    schedule_interval='@daily',<br/>    start_date=datetime(2022, 3, 1),<br/>    catchup=False<br/>) as dag:<br/>    pass</span></pre><p id="b941" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">开始执行任务。<code class="fe lv lw lx ly b">task_get_date</code>任务将调用一个 Python 函数<code class="fe lv lw lx ly b">get_date()</code>，并将其返回值推送到 Airflow 的 XComs。该函数只返回字符串格式的日期:</p><pre class="kj kk kl km gt nf ly ng nh aw ni bi"><span id="eaf9" class="nj mj it ly b gy nk nl l nm nn">from datetime import datetime<br/>from airflow.models import DAG<br/>from airflow.operators.python import PythonOperator<br/></span><span id="a306" class="nj mj it ly b gy no nl l nm nn">def get_date() -&gt; str:<br/>    return str(datetime.now())<br/></span><span id="0381" class="nj mj it ly b gy no nl l nm nn">with DAG(<br/>    dag_id='xcom_dag',<br/>    schedule_interval='@daily',<br/>    start_date=datetime(2022, 3, 1),<br/>    catchup=False<br/>) as dag:</span><span id="4a73" class="nj mj it ly b gy no nl l nm nn">    task_get_date = PythonOperator(<br/>        task_id='get_date',<br/>        python_callable=get_date,<br/>        do_xcom_push=True<br/>    )</span></pre><p id="0724" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以通过终端测试任务来验证一切工作正常:</p><pre class="kj kk kl km gt nf ly ng nh aw ni bi"><span id="d839" class="nj mj it ly b gy nk nl l nm nn">airflow tasks test xcom_dag get_date 2022-3-1</span></pre><p id="5c27" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">任务被标记为成功，日期返回:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/917a9f6f353d76c7b3af0e29767dd546.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kfn-gtT1ED-L0vFREOpyaA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 1-通过终端测试气流任务(图片由作者提供)</p></figure><p id="7194" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有两种方法可以测试该值是否被推送到 Airflow 的 XComs。第一种方法是在 Airflow 的元数据数据库中发出一条 SQL 语句。第二种更简单的方法是打开 Airflow 的主页，进入<em class="nq">管理</em> — <em class="nq"> XComs </em>:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/4690ebb889d48145771c969d302f75c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XLqag8-dQg7epz0cdTeonw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 2 —在 Airflow 后端推送的 XCom(图片由作者提供)</p></figure><p id="110f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以看到存储在 XComs 中的返回值。问题仍然是——如何把它弄出来？</p></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="d5cd" class="mi mj it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">如何通过气流得到 XCom 值</h1><p id="e5d2" class="pw-post-body-paragraph kz la it lb b lc na ju le lf nb jx lh li nc lk ll lm nd lo lp lq ne ls lt lu im bi translated">我们现在将编写另一个任务——<code class="fe lv lw lx ly b">task_save_date</code>——它调用<code class="fe lv lw lx ly b">save_date()</code> Python 函数。这次情况有所不同，你应该记住以下几点:</p><ul class=""><li id="d285" class="ns nt it lb b lc ld lf lg li nu lm nv lq nw lu nx ny nz oa bi translated"><strong class="lb iu">指定</strong> <code class="fe lv lw lx ly b"><strong class="lb iu">ti</strong></code> <strong class="lb iu">参数</strong>——它代表<em class="nq">任务实例</em>，允许你拉取存储在气流 XComs 中的值。</li><li id="2b18" class="ns nt it lb b lc ob lf oc li od lm oe lq of lu nx ny nz oa bi translated"><strong class="lb iu"/><code class="fe lv lw lx ly b"><strong class="lb iu">xcom_pull()</strong></code><strong class="lb iu">方法</strong>——用于从一个或多个气流任务中提取返回值列表。注意第一个参数的复数形式。指定要从中提取存储在 XComs 中的值的任务 id 列表。</li><li id="316e" class="ns nt it lb b lc ob lf oc li od lm oe lq of lu nx ny nz oa bi translated"><strong class="lb iu">这是一个列表</strong> —用 Python 的列表索引符号访问被拉取值的成员。</li></ul><p id="41e6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下是任务和函数的代码:</p><pre class="kj kk kl km gt nf ly ng nh aw ni bi"><span id="aa46" class="nj mj it ly b gy nk nl l nm nn">from datetime import datetime<br/>from airflow.models import DAG<br/>from airflow.operators.python import PythonOperator<br/></span><span id="b64a" class="nj mj it ly b gy no nl l nm nn">def get_date() -&gt; str:<br/>    ...<br/></span><span id="552c" class="nj mj it ly b gy no nl l nm nn">def save_date(ti) -&gt; None:<br/>    dt = ti.xcom_pull(task_ids=['get_date'])<br/>    if not dt:<br/>        raise ValueError('No value currently stored in XComs.')</span><span id="226c" class="nj mj it ly b gy no nl l nm nn">    with open('/Users/dradecic/airflow/data/date.txt', 'w') as f:<br/>        f.write(dt[0])<br/></span><span id="4dfb" class="nj mj it ly b gy no nl l nm nn">with DAG(<br/>    ...<br/>) as dag:</span><span id="47eb" class="nj mj it ly b gy no nl l nm nn">    task_get_date = PythonOperator(<br/>        ...<br/>    )</span><span id="89c3" class="nj mj it ly b gy no nl l nm nn">    task_save_date = PythonOperator(<br/>        task_id='save_date',<br/>        python_callable=save_date<br/>    )</span></pre><p id="f657" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们来测试一下:</p><pre class="kj kk kl km gt nf ly ng nh aw ni bi"><span id="737c" class="nj mj it ly b gy nk nl l nm nn">airflow tasks test xcom_dag save_date 2022-3-1</span></pre><p id="2e5b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，没有出现异常:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/41a6373935d5ee92a0d6fb37372a6ce8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iQDD3x3A40sln0VJ0myoAw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 3-通过终端(2)测试气流任务(图片由作者提供)</p></figure><p id="d517" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">假设一切顺利，您将看到一个新的<code class="fe lv lw lx ly b">date.txt</code>文件被创建。我这边看起来是这样的:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/f309b129a52486a263eab45fe0daf7c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ErNTNjjvVqFCK_ugq_7TNQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 4 —保存的价值(作者图片)</p></figure><p id="d665" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是你如何使用 XComs 在气流任务之间进行通信。有什么你应该知道的限制吗？接下来让我们讨论这些。</p></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="2942" class="mi mj it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">气流 XComs 限制</h1><p id="6d34" class="pw-post-body-paragraph kz la it lb b lc na ju le lf nb jx lh li nc lk ll lm nd lo lp lq ne ls lt lu im bi translated">XComs 看起来像是在 Airflow 中任务间通信的万能解决方案，但是有一些限制您应该知道。Airflow 不是一个数据处理框架，所以避免在任务之间发送巨大的熊猫数据帧。</p><p id="1792" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果试图在任务之间交换大型数据集，很可能会遇到内存问题。在 Spark 中处理大数据集，并且仅使用气流来触发 Spark 作业。</p><p id="578a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在一天结束时，气流是一个管弦乐队，它应该只用于这一目的。</p></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="a380" class="mi mj it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">结论</h1><p id="3ccd" class="pw-post-body-paragraph kz la it lb b lc na ju le lf nb jx lh li nc lk ll lm nd lo lp lq ne ls lt lu im bi translated">今天，您已经学习了气流 XComs 的基础知识。现在，您已经具备了在 Dag 中的任务之间进行有效通信所需的一切。请记住，Airflow 不是一个数据处理框架，而是一个数据编排器。不要使用 XComs 来交换庞大的数据集，这样就可以了。</p><p id="394b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在接下来的文章中，您将学习在 Airflow 中使用<code class="fe lv lw lx ly b">HttpSensor</code>和<code class="fe lv lw lx ly b">HttpOperator</code>与 REST APIs 通信的正确方式。敬请关注，我会确保在几天内发表这篇文章。</p><h2 id="46a4" class="nj mj it bd mk oh oi dn mo oj ok dp ms li ol om mu lm on oo mw lq op oq my or bi translated">推荐阅读</h2><ul class=""><li id="c59e" class="ns nt it lb b lc na lf nb li os lm ot lq ou lu nx ny nz oa bi translated"><a class="ae ky" href="https://betterdatascience.com/best-data-science-prerequisite-books/" rel="noopener ugc nofollow" target="_blank">学习数据科学先决条件(数学、统计和编程)的 5 本最佳书籍</a></li><li id="c91f" class="ns nt it lb b lc ob lf oc li od lm oe lq of lu nx ny nz oa bi translated"><a class="ae ky" href="https://betterdatascience.com/top-books-to-learn-data-science/" rel="noopener ugc nofollow" target="_blank">2022 年学习数据科学的前 5 本书</a></li><li id="0033" class="ns nt it lb b lc ob lf oc li od lm oe lq of lu nx ny nz oa bi translated"><a class="ae ky" href="https://betterdatascience.com/apache-airflow-install/" rel="noopener ugc nofollow" target="_blank">如何在本地安装 Apache air flow</a></li></ul><h2 id="1fa4" class="nj mj it bd mk oh oi dn mo oj ok dp ms li ol om mu lm on oo mw lq op oq my or bi translated">保持联系</h2><ul class=""><li id="fe54" class="ns nt it lb b lc na lf nb li os lm ot lq ou lu nx ny nz oa bi translated">雇用我作为一名技术作家</li><li id="06a8" class="ns nt it lb b lc ob lf oc li od lm oe lq of lu nx ny nz oa bi translated">订阅<a class="ae ky" href="https://www.youtube.com/c/BetterDataScience" rel="noopener ugc nofollow" target="_blank"> YouTube </a></li><li id="eb23" class="ns nt it lb b lc ob lf oc li od lm oe lq of lu nx ny nz oa bi translated">在<a class="ae ky" href="https://www.linkedin.com/in/darioradecic/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上连接</li></ul></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><p id="c7f0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nq">喜欢这篇文章吗？成为</em> <a class="ae ky" href="https://medium.com/@radecicdario/membership" rel="noopener"> <em class="nq">中等会员</em> </a> <em class="nq">继续无限制学习。如果你使用下面的链接，我会收到你的一部分会员费，不需要你额外付费。</em></p><div class="ov ow gp gr ox oy"><a href="https://medium.com/@radecicdario/membership" rel="noopener follow" target="_blank"><div class="oz ab fo"><div class="pa ab pb cl cj pc"><h2 class="bd iu gy z fp pd fr fs pe fu fw is bi translated">通过我的推荐链接加入 Medium-Dario rade ci</h2><div class="pf l"><h3 class="bd b gy z fp pd fr fs pe fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="pg l"><p class="bd b dl z fp pd fr fs pe fu fw dk translated">medium.com</p></div></div><div class="ph l"><div class="pi l pj pk pl ph pm ks oy"/></div></div></a></div></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><p id="cfe7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nq">原载于 2022 年 3 月 14 日 https://betterdatascience.com</em><a class="ae ky" href="https://betterdatascience.com/apache-airflow-xcoms/" rel="noopener ugc nofollow" target="_blank"><em class="nq"/></a><em class="nq">。</em></p></div></div>    
</body>
</html>