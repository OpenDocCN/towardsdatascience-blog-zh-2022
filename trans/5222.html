<html>
<head>
<title>BigQuery SQL Procedural Language to Simplify Data Engineering</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">简化数据工程的 BigQuery SQL 过程语言</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/bigquery-sql-procedural-language-to-simplify-data-engineering-66ecfc47f3ac#2022-11-22">https://towardsdatascience.com/bigquery-sql-procedural-language-to-simplify-data-engineering-66ecfc47f3ac#2022-11-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="0e5e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">介绍</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/d5c3a1f760a52e30e7dad004c487220d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ha47_PFVbIriXCw7"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">安妮·斯普拉特在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="9563" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">作为一名长期的 SQL 用户，我经常不得不一遍又一遍地运行相同的代码，只在 where 语句中稍作修改。在 Python 这样的编程语言中，这种复制和替换是不必要的，因为我可以创建一个函数来传入不同的参数值以重新运行相同的代码。今天我想分享如何使用 BigQuery 的<a class="ae ky" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/procedural-language" rel="noopener ugc nofollow" target="_blank">过程语言</a>来设置变量和条件逻辑以运行 SQL 语句。</p><h2 id="b61d" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">声明并设置</h2><p id="6756" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated"><a class="ae ky" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/procedural-language#declare" rel="noopener ugc nofollow" target="_blank">声明</a>语句初始化变量，而<a class="ae ky" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/procedural-language#set" rel="noopener ugc nofollow" target="_blank">设置</a>语句将设置变量的值。如果您需要运行除了几个值之外基本相同的 SQL 代码，这将非常有用。在下面的例子中，我们有一个名为<strong class="lb iu"> <em class="mt"> product </em> </strong>的表，它有两个字段:<strong class="lb iu"> <em class="mt"> item_name </em> </strong>和<strong class="lb iu"> <em class="mt"> quantity </em> </strong>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/87323e1abb330ca5fb069efe07d5aeb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:830/1*rIifmvYxuQYRENXGbpWYsw.gif"/></div></figure><p id="c349" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了得到苹果的数量，我们将使用 where 语句来查找<strong class="lb iu"> <em class="mt"> item_name </em> </strong>等于<strong class="lb iu"> <em class="mt"> apple </em> </strong>(第 3 行)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/f08c47a0f98cbeee7615e311340166c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:818/1*FTyEhEtqa0FtczhL_tQBFA.gif"/></div></figure><p id="3737" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，假设我们想要从这个表中查询不同的水果，但是我们不想多次复制整个 SQL 语句来更改 where 语句中的水果名称。在这种情况下，我们可以使用 DECLARE 初始化一个名为<strong class="lb iu"> <em class="mt"> fruit_name </em> </strong>(第 1 行)的变量，并将值设置为<strong class="lb iu"> <em class="mt"> lemon </em> </strong>(第 2 行)<strong class="lb iu"> <em class="mt">。</em> </strong>现在，当查询被运行时，where 语句查询<strong class="lb iu"> <em class="mt"> item_name </em> </strong>等于<strong class="lb iu"> <em class="mt"> fruit_name </em> </strong>变量即被设置为<strong class="lb iu"> <em class="mt"> lemon </em> </strong>(第 6 行)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/899e69df166f00a2e3df94f0339a31f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:842/1*g3BoIzCrHeekqglwJSctMQ.gif"/></div></figure><p id="4324" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要再次查询苹果，我们只需将<strong class="lb iu"> <em class="mt">水果名称</em> </strong>变量从<strong class="lb iu"> <em class="mt">柠檬</em> </strong>变回<strong class="lb iu"> <em class="mt">苹果(</em> </strong>第 2 行)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/4b931a41d145600ec74f98599b8c3c2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:828/1*TkEbXhEC-KIUZM3ZSTjHcQ.gif"/></div></figure><p id="5b77" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是一个简单的声明和设置的例子，但是它们可以用在比我上面展示的更多的地方。重复的 SQL 语句也可以放在<a class="ae ky" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/table-functions" rel="noopener ugc nofollow" target="_blank">表函数</a>中，这样用户就不需要用不同的 where 值多次编写相同的 SQL 代码。</p><h2 id="a51b" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">如果-那么</h2><p id="77b8" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">如果满足条件，您可以使用<a class="ae ky" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/procedural-language#if" rel="noopener ugc nofollow" target="_blank"> IF-THEN </a>条件语句来执行 SQL 语句。我遇到的一个典型场景是在为一个报告运行剩余的 SQL 之前检查一个表是否有最新的数据。从数据工程的角度来看，如果数据没有准备好，能够跳过代码会使事情变得容易得多。</p><p id="9a21" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在下面的例子中，我初始化了两个变量<strong class="lb iu"> <em class="mt"> rowcnt </em> </strong>(第 1 行)<strong class="lb iu"> <em class="mt"> </em> </strong>和<strong class="lb iu"> <em class="mt"> latest_date </em> </strong>(第 2 行)。我检查了<strong class="lb iu"> <em class="mt"> prod_data </em> </strong>表的行数，其中<strong class="lb iu"> <em class="mt"> daily_date </em> </strong>字段等于<strong class="lb iu"><em class="mt">2022–11–18</em></strong>，并将该值设置为<strong class="lb iu"> <em class="mt"> rowcnt </em> </strong>变量(第 4 行)。</p><p id="74e9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在使用 IF-THEN 条件语句，我检查 rowcnt  是否等于 1(第 6 行)，这意味着如果找到 2022–11–18 的数据，那么将显示字符串<strong class="lb iu"> <em class="mt">找到最新数据</em> </strong>。否则，<strong class="lb iu"> <em class="mt"> latest_date </em> </strong>被设置为<strong class="lb iu"> <em class="mt"> prod_data </em> </strong>表中最大日期的值(第 10 行)，并且<strong class="lb iu"> <em class="mt">数据延迟</em> </strong>与<strong class="lb iu"> <em class="mt"> latest_date </em> </strong>的值一起显示(第 12 行)。在这种情况下，没有找到数据，并且<strong class="lb iu"> <em class="mt"> latest_date </em> </strong>字段显示<strong class="lb iu"><em class="mt">2022–11–15</em></strong>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi my"><img src="../Images/f1012f3be400605dfe6002eddd2365de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*Z4k8pInuHRmZCVGbrHYeuw.gif"/></div></div></figure><p id="a06d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这也是一个简单的例子，但是您可以看到如果数据不可用，条件语句如何阻止 SQL 代码运行。</p><h2 id="77f8" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">循环并离开</h2><p id="c150" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">您可以结合使用<a class="ae ky" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/procedural-language#loop" rel="noopener ugc nofollow" target="_blank"> LOOP </a>和<a class="ae ky" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/procedural-language#leave" rel="noopener ugc nofollow" target="_blank"> LEAVE </a>来循环，直到在运行您的 SQL 语句之前满足一个条件。使用上面的例子，我添加了一个<strong class="lb iu"> <em class="mt">计数器</em> </strong>变量，并将值默认为-1(第 3 行)。我通过<strong class="lb iu"> <em class="mt">计数器</em> </strong>变量(第 9 行)使用<strong class="lb iu"> <em class="mt"> date_sub </em> </strong>函数继续从 2022–11–18 减去天数，直到<strong class="lb iu"> <em class="mt"> rowcnt </em> </strong>变量等于 1。</p><p id="d99f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦<strong class="lb iu"> <em class="mt"> rowcnt </em> </strong>等于 1，使用<strong class="lb iu"> <em class="mt"> LEAVE </em> </strong>语句(第 11 行)循环结束。</p><p id="ee6b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> <em class="mt"> last_date </em> </strong>字段显示循环在<strong class="lb iu"> <em class="mt"> prod_data </em> </strong>表中找到数据时停止(第 16 行)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/8b3e1f45ab374abc63c9d625fb1a6064.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*5QqsT4W8e_K5Ky43WC1HKw.gif"/></div></div></figure><p id="c50f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> <em class="mt">特别提及</em> </strong>:除循环和离开外，WHILE、CONTINUE 和 FOR..IN 也可用于控制<a class="ae ky" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/procedural-language#loops" rel="noopener ugc nofollow" target="_blank">循环</a>。</p><h2 id="f3da" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">最后的想法</h2><p id="3e4d" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">我仅仅触及了 BigQuery 过程语言的表面，但是我希望您看到简化数据工程任务的潜力。我强烈推荐阅读文档并尝试一下过程语言。</p><p id="25dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="mt">注意:以上所有查询都是在</em> <a class="ae ky" href="https://cloud.google.com/bigquery/docs/sandbox" rel="noopener ugc nofollow" target="_blank"> <em class="mt"> BigQuery 沙箱</em> </a> <em class="mt">上运行的，这对任何拥有谷歌账户的人都是免费的。</em></p></div><div class="ab cl na nb hx nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="im in io ip iq"><h2 id="99b4" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">你可能也会喜欢…</h2><div class="nh ni gp gr nj nk"><a rel="noopener follow" target="_blank" href="/4-bigquery-sql-shortcuts-that-can-simplify-your-queries-30f94666a046"><div class="nl ab fo"><div class="nm ab nn cl cj no"><h2 class="bd iu gy z fp np fr fs nq fu fw is bi translated">4 个可以简化查询的 BigQuery SQL 快捷方式</h2><div class="nr l"><h3 class="bd b gy z fp np fr fs nq fu fw dk translated">检查您的数据库是否也有它们</h3></div><div class="ns l"><p class="bd b dl z fp np fr fs nq fu fw dk translated">towardsdatascience.com</p></div></div><div class="nt l"><div class="nu l nv nw nx nt ny ks nk"/></div></div></a></div><div class="nh ni gp gr nj nk"><a rel="noopener follow" target="_blank" href="/6-bigquery-sql-functions-every-user-should-know-9ed97b1cf72e"><div class="nl ab fo"><div class="nm ab nn cl cj no"><h2 class="bd iu gy z fp np fr fs nq fu fw is bi translated">每个用户都应该知道的 6 个大查询 SQL 函数</h2><div class="nr l"><h3 class="bd b gy z fp np fr fs nq fu fw dk translated">检查您的数据库是否也有它们</h3></div><div class="ns l"><p class="bd b dl z fp np fr fs nq fu fw dk translated">towardsdatascience.com</p></div></div><div class="nt l"><div class="nz l nv nw nx nt ny ks nk"/></div></div></a></div><div class="nh ni gp gr nj nk"><a rel="noopener follow" target="_blank" href="/how-data-scientists-can-reduce-data-wrangling-time-with-a-data-mart-809eefbe0bc2"><div class="nl ab fo"><div class="nm ab nn cl cj no"><h2 class="bd iu gy z fp np fr fs nq fu fw is bi translated">数据科学家如何通过数据集市减少数据争论的时间</h2><div class="nr l"><h3 class="bd b gy z fp np fr fs nq fu fw dk translated">什么是数据集市，为什么数据科学家应该使用数据集市</h3></div><div class="ns l"><p class="bd b dl z fp np fr fs nq fu fw dk translated">towardsdatascience.com</p></div></div><div class="nt l"><div class="oa l nv nw nx nt ny ks nk"/></div></div></a></div></div></div>    
</body>
</html>