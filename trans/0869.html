<html>
<head>
<title>Best of Both Worlds: Automated and Dynamic SQL Queries from Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">两全其美:来自 Python 的自动化和动态 SQL 查询</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/best-of-both-worlds-automated-and-dynamic-sql-queries-from-python-5b74a24501b0#2022-03-09">https://towardsdatascience.com/best-of-both-worlds-automated-and-dynamic-sql-queries-from-python-5b74a24501b0#2022-03-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9bdd" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过 SQL 和 Python 集成将自动化带到新的高度</h2></div><p id="f810" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现实世界的分析应用程序通常使用各种编程语言构建，每种语言都需要直接访问存储在数据库中的数据。最终目标是创建一个从数据提取(使用 SQL)到模型开发，再到持续性能监控的自动分析管道。通过独立的平面文件传输数据的时代已经过去了！</p><p id="861d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">SQL 和关系数据库垄断了几十年，作为分析的全明星脚本语言，Python 对 SQL APIs 有很好的支持，允许用户直接拉取数据。在这篇博客中，我将分享 3 种方法以及集成 SQL 和 Python 来创建无缝分析工作流的用例。</p><h2 id="915e" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated">分析数据集-在线零售数据</h2><p id="97b2" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">Python 连接关系数据库有两种方式:(1)使用<a class="ae mc" href="https://docs.microsoft.com/en-us/sql/odbc/reference/what-is-odbc?view=sql-server-ver15#:~:text=To%20the%20end%20user%2C%20it,specification%20for%20a%20database%20API." rel="noopener ugc nofollow" target="_blank"> ODBC(开放式数据库连接)</a>作为连接引擎，访问托管在远程 SQL server 中的数据库；(2)使用<a class="ae mc" href="https://en.wikipedia.org/wiki/Object%E2%80%93relational_mapping" rel="noopener ugc nofollow" target="_blank"> ORM(对象关系映射器)</a>作为位于最终用户和数据库之间的抽象层，这提供了更多的灵活性。</p><p id="3a48" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这个练习中，我们将在<em class="md"> MS SQL </em>服务器中实现 ORM 方法。我们正在处理的数据集是<a class="ae mc" href="https://archive.ics.uci.edu/ml/datasets/online+retail" rel="noopener ugc nofollow" target="_blank">在线零售</a>数据；包含来自英国在线零售商的各种交易的纵向数据集。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi me"><img src="../Images/00b7c5dc2ffa296f7dbd1a2617f234e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*edH_WPvt91wtNMlN2RwjwA.png"/></div></div></figure><p id="c66f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">正如我们所看到的，每个记录由<em class="md">产品、数量、价格/单位和客户、县</em>信息组成。</p><h2 id="83cf" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated">先决条件-将 Python 连接到 SQL server</h2><blockquote class="mq mr ms"><p id="a8aa" class="ki kj md kk b kl km ju kn ko kp jx kq mt ks kt ku mu kw kx ky mv la lb lc ld im bi translated">Python {urlib} + {SQLAlchemy}</p></blockquote><p id="0487" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">尽管{ <em class="md"> SQLAlchemy </em> }在数据科学家和程序员中非常受欢迎，但以理想的形式获得连接字符串可能很棘手。要用 Python 连接 SQL，我们需要我们的驱动程序名、服务器名和数据库名。这里演示了如何为我的本地服务器<code class="fe mw mx my mz b">localhost\SQLEXPRESS</code>和名为<code class="fe mw mx my mz b">master</code>的数据库指定这些参数，</p><figure class="mf mg mh mi gt mj"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="5bb3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">加入我们的 YouTube 社区🎦  <a class="ae mc" href="https://www.youtube.com/channel/UCbGx9Om38Ywlqi0x8RljNdw" rel="noopener ugc nofollow" target="_blank"> <strong class="kk iu"> <em class="md">【数据说话带吉】</em> </strong> </a> <strong class="kk iu"> <em class="md">😄</em> </strong></p><figure class="mf mg mh mi gt mj"><div class="bz fp l di"><div class="nc nb l"/></div></figure><h2 id="2813" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated">用例 1:用 Python 编写的简短查询</h2><p id="62a8" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">建立了 SQL 连接引擎后，我们可以编写一个简短的查询，使用{ <em class="md">熊猫</em> }将数据拉入 Python，</p><figure class="mf mg mh mi gt mj"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="0cc6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本例中，我们提取了 2010 年 12 月 1 日和 2011 年 1 月 1 日之间两种产品——巧克力热水瓶和灰心热水瓶——的所有交易，然后得出每种产品按日期计算的总销售额。以下是返回的数据框:</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/2b9885f26e6e11a9dd95f58198ce6c44.png" data-original-src="https://miro.medium.com/v2/resize:fit:970/format:webp/1*LyMYW2o-dCn17TZmTF8ETw.png"/></div></figure><p id="22b0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，作为我们分析工作流程的一部分，让我们创建一个可视化图，例如纵向折线图，向我们的利益相关者展示趋势。</p><figure class="mf mg mh mi gt mj"><div class="bz fp l di"><div class="na nb l"/></div></figure><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi ne"><img src="../Images/cd8b04228088ec55121fc98569b051b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/1*UEqyy3Gc7hYgDEMLNGQXOQ.png"/></div></div></figure><h2 id="909e" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated">用户案例#2:读取外部的。sql 文件</h2><p id="72f5" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">我们刚刚经历的是将 SQL 纳入整个分析管道的最简单方法。然而，在我们的实践中，用 Python 编写或复制/粘贴每一个查询<strong class="kk iu">是低效的，甚至是不可能的。原因是双重的:</strong></p><ol class=""><li id="1377" class="nf ng it kk b kl km ko kp kr nh kv ni kz nj ld nk nl nm nn bi translated">现实世界的项目通常需要通过连接多个表和视图来进行长达数千行的查询；</li><li id="9534" class="nf ng it kk b kl no ko np kr nq kv nr kz ns ld nk nl nm nn bi translated">从可重用性的角度来看，如果我们经常需要更新或修改这些查询，维护和调试代码将会非常困难。</li></ol><p id="aa03" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">那么解决办法是什么呢？阅读现存的不是很好吗？sql 文件直接导入 Python？出于演示的目的，让我们将上面的查询保存为一个. sql 文件<code class="fe mw mx my mz b"><em class="md">OnlineRetailPull.sql</em></code>。</p><p id="ab37" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，诀窍是<strong class="kk iu">扫描</strong>这个查询文件，就像它是一个字符串对象一样:</p><figure class="mf mg mh mi gt mj"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="a5d0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">输出<code class="fe mw mx my mz b">OnlineRetailData</code>与上面用例 1 的返回完全相同。</p><h2 id="6e0e" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated">用例 3:来自应用程序的动态查询</h2><p id="daae" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">现在，让我们回到最初的目标——将数据提取整合到我们的应用程序中，对用户的输入做出反应。我们将使用 Python<em class="md">{</em><strong class="kk iu"><em class="md">streamlit }</em></strong><em class="md"/>和<em class="md"> </em>创建一个小 app，探索如何动态运行 SQL 查询。</p><p id="76da" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> <em class="md">第一步</em> </strong>:通过添加占位符来修改我们的查询。在本练习中，我们定义了两个交互变量<em class="md"> {date} </em>和<em class="md"> {product}，</em></p><figure class="mf mg mh mi gt mj"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="dced" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> <em class="md">第二步</em> </strong>:设置我们的<strong class="kk iu"><em class="md">streamlit</em></strong>app，根据用户选择可视化产品销售趋势，</p><figure class="mf mg mh mi gt mj"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="5e1e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里的技巧是在我们的查询和应用程序的用户选项中的占位符使用相同的对象名称(即<strong class="kk iu">日期和</strong>产品)。这样，<em class="md"> f 字符串</em>可以自动接受用户选择的任何值。</p><p id="5146" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">运行此应用程序让我们…</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nt"><img src="../Images/4bb7d6f46a2399fc5282c92c08fde632.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*C94_c6-9XkroOY3qvxBKTQ.gif"/></div></div></figure><p id="2767" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">最后的话</strong></p><p id="6176" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你有它！动态集成 SQL 和 Python 的三个不同用例。希望这篇文章能给你一些新项目的灵感，感谢阅读！</p><p id="c2c1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> <em class="md">想要更多数据科学和编程技巧？使用</em> </strong> <a class="ae mc" href="https://yilistats.medium.com/membership" rel="noopener"> <strong class="kk iu"> <em class="md">我的链接</em> </strong> </a> <strong class="kk iu"> <em class="md">注册 Medium，获得我所有内容的全部访问权限。</em>T13】</strong></p><p id="85e4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> <em class="md">还订阅我新创建的 YouTube 频道</em> </strong> <a class="ae mc" href="https://www.youtube.com/channel/UCbGx9Om38Ywlqi0x8RljNdw" rel="noopener ugc nofollow" target="_blank"> <strong class="kk iu"> <em class="md">《数据与吉谈》</em> </strong> </a> <strong class="kk iu"> <em class="md">😀</em> </strong></p><h1 id="4777" class="nu lf it bd lg nv nw nx lj ny nz oa lm jz ob ka lp kc oc kd ls kf od kg lv oe bi translated">进一步阅读</h1><div class="of og gp gr oh oi"><a rel="noopener follow" target="_blank" href="/6-sql-tricks-every-data-scientist-should-know-f84be499aea5"><div class="oj ab fo"><div class="ok ab ol cl cj om"><h2 class="bd iu gy z fp on fr fs oo fu fw is bi translated">每个数据科学家都应该知道的 6 个 SQL 技巧</h2><div class="op l"><h3 class="bd b gy z fp on fr fs oo fu fw dk translated">提高分析效率的 SQL 技巧</h3></div><div class="oq l"><p class="bd b dl z fp on fr fs oo fu fw dk translated">towardsdatascience.com</p></div></div><div class="or l"><div class="os l ot ou ov or ow mo oi"/></div></div></a></div><div class="of og gp gr oh oi"><a rel="noopener follow" target="_blank" href="/data-reshaping-in-sql-r-and-python-d44ca19e71b8"><div class="oj ab fo"><div class="ok ab ol cl cj om"><h2 class="bd iu gy z fp on fr fs oo fu fw is bi translated">SQL、R 和 Python 中的数据整形</h2><div class="op l"><h3 class="bd b gy z fp on fr fs oo fu fw dk translated">从 Python vs. R 到 Python &amp; R</h3></div><div class="oq l"><p class="bd b dl z fp on fr fs oo fu fw dk translated">towardsdatascience.com</p></div></div><div class="or l"><div class="ox l ot ou ov or ow mo oi"/></div></div></a></div><div class="of og gp gr oh oi"><a href="https://levelup.gitconnected.com/6-hilarious-programmers-data-scientists-jokes-to-kick-start-2021-187f86dd6a4c" rel="noopener  ugc nofollow" target="_blank"><div class="oj ab fo"><div class="ok ab ol cl cj om"><h2 class="bd iu gy z fp on fr fs oo fu fw is bi translated">6 个令人捧腹的程序员/数据科学家笑话开启 2021 年</h2><div class="op l"><h3 class="bd b gy z fp on fr fs oo fu fw dk translated">做好准备:这些愚蠢的老笑话会让你捧腹大笑😁</h3></div><div class="oq l"><p class="bd b dl z fp on fr fs oo fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="or l"><div class="oy l ot ou ov or ow mo oi"/></div></div></a></div></div></div>    
</body>
</html>