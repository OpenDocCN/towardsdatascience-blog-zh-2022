<html>
<head>
<title>PyTorch Stable Diffusion Using Hugging Face and Intel Arc</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用拥抱面和英特尔弧的PyTorch稳定扩散</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/pytorch-stable-diffusion-using-hugging-face-and-intel-arc-77010e9eead6#2022-11-09">https://towardsdatascience.com/pytorch-stable-diffusion-using-hugging-face-and-intel-arc-77010e9eead6#2022-11-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="a9b4" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用英特尔GPU运行稳定的扩散</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/a448a5e588286a6c426dd67a9295c047.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5dIcBvoZOcsM7GjYTuN7Sg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者创造的稳定扩散的图像</p></figure><h1 id="abf1" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">介绍</h1><p id="ab7a" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">文本到图像的人工智能模型在过去几年里变得非常流行。最受欢迎的模型之一是稳定扩散，由<a class="ae mj" href="https://github.com/CompVis" rel="noopener ugc nofollow" target="_blank">康普维斯</a>、<a class="ae mj" href="https://stability.ai/" rel="noopener ugc nofollow" target="_blank">稳定人工智能</a>和<a class="ae mj" href="https://laion.ai/" rel="noopener ugc nofollow" target="_blank">莱恩</a>合作创建。尝试稳定扩散的最简单方法之一是通过<a class="ae mj" href="https://huggingface.co/blog/stable_diffusion" rel="noopener ugc nofollow" target="_blank">拥抱面部扩散器库</a>。</p><p id="1ecf" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">随着最新英特尔Arc GPU的发布，我们收到了许多关于英特尔Arc卡是否支持运行Tensorflow和PyTorch模型的问题，答案是肯定的！使用oneAPI规范构建的<a class="ae mj" href="https://www.intel.com/content/www/us/en/developer/articles/guide/optimization-for-tensorflow-installation-guide.html" rel="noopener ugc nofollow" target="_blank">面向TensorFlow* </a>的英特尔优化和<a class="ae mj" href="https://www.intel.com/content/www/us/en/developer/tools/oneapi/extension-for-pytorch.html" rel="noopener ugc nofollow" target="_blank">面向PyTorch的英特尔扩展</a>允许用户在最新的英特尔GPU上运行这些框架。</p><p id="9c90" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">为了帮助人们了解如何在英特尔GPU上运行PyTorch，本文将快速展示我们如何在过去几年中在英特尔Arc A770 GPU上运行一个更有趣的人工智能工作负载。</p><h1 id="4b9b" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">设置</h1><p id="4e5d" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">从我之前的<a class="ae mj" href="https://medium.com/@tonymongkolsmai" rel="noopener">帖子</a>中，你可能知道我有一个英特尔Alder Lake Core i9–12900 KF外星人R13系统。实际上，我不会使用该系统作为本演练的基础，因为我刚刚使用MSI z690 Carbon WiFi主板和64GB 5600 DDR 5 RAM以及全新的英特尔Arc A770组装了一个Raptor Lake第13代英特尔酷睿i7-13700KF系统进行测试。系统正在运行全新安装的Ubuntu 22.04.1。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mp"><img src="../Images/1734e9acdf03c6feafbbbf956c405a9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rM5f_vsCVfNHOQbZQ8aE_A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">测试系统图片由作者提供</p></figure><h1 id="a7f6" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">英特尔弧上的稳定扩散</h1><p id="323f" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">以此为硬件基础，让我们完成在该系统上实现稳定扩散所需的所有步骤。</p><h2 id="9cc7" class="mq kw iq bd kx mr ms dn lb mt mu dp lf lw mv mw lh ma mx my lj me mz na ll nb bi translated">设置基础软件堆栈</h2><p id="c56e" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">首先，我们需要安装英特尔Arc驱动程序和<a class="ae mj" href="https://www.intel.com/content/www/us/en/developer/tools/oneapi/base-toolkit.html" rel="noopener ugc nofollow" target="_blank">英特尔oneAPI基础工具包</a>，因此我们遵循以下说明:</p><div class="nc nd gp gr ne nf"><a href="https://www.intel.com/content/www/us/en/develop/documentation/installation-guide-for-intel-oneapi-toolkits-linux/top.html" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd ir gy z fp nk fr fs nl fu fw ip bi translated">面向Linux*操作系统的英特尔oneAPI工具包安装指南</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">本指南涵盖了在Linux*操作系统上安装英特尔oneAPI工具包。在…之前检查先决条件信息</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">www.intel.com</p></div></div><div class="no l"><div class="np l nq nr ns no nt kp nf"/></div></div></a></div><p id="f678" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">具体来说，我正在使用位于<a class="ae mj" href="https://www.intel.com/content/www/us/en/develop/documentation/installation-guide-for-intel-oneapi-toolkits-linux/top/installation/install-using-package-managers/apt.html#apt" rel="noopener ugc nofollow" target="_blank">这里</a>的APT指令，特别注意准确地遵循安装英特尔GPU驱动程序(步骤2)中的指令。我用Linux 6.0.x内核中包含的驱动程序尝试了这一点，遇到了一些问题，所以我建议您尝试DKMS指令，并在指令中使用内核5.17.xxx。</p><p id="89ce" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">因为我们将使用拥抱脸库，我们安装Git和Git大文件存储(Git LFS ),因为拥抱脸库需要它们。</p><pre class="kg kh ki kj gt nu nv nw nx aw ny bi"><span id="5d26" class="mq kw iq nv b gy nz oa l ob oc">&gt; sudo apt-get install git git-lfs</span></pre><h2 id="83f3" class="mq kw iq bd kx mr ms dn lb mt mu dp lf lw mv mw lh ma mx my lj me mz na ll nb bi translated">Python设置</h2><p id="17f5" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">接下来，让我们设置Python环境，以便与英特尔Arc协同工作。我使用的是Python 3.9.15，所以如果你有不同版本的Python，说明可能会稍有不同。</p><p id="e800" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">由于这是一个全新的Ubuntu安装，由于某种原因我没有安装pip Python包管理器，所以快速修复方法是运行:</p><pre class="kg kh ki kj gt nu nv nw nx aw ny bi"><span id="bcb4" class="mq kw iq nv b gy nz oa l ob oc">&gt; wget <a class="ae mj" href="https://bootstrap.pypa.io/get-pip.py" rel="noopener ugc nofollow" target="_blank">https://bootstrap.pypa.io/get-pip.py</a><br/>&gt; python get-pip.py</span></pre><p id="48f1" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">安装pip有很多种方法，根据你的Ubuntu版本，你可以直接使用APT。</p><p id="2e5f" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">为了保持我们的Python环境整洁，我们可以设置Python virtualenv模块并创建一个虚拟环境。</p><pre class="kg kh ki kj gt nu nv nw nx aw ny bi"><span id="3ae9" class="mq kw iq nv b gy nz oa l ob oc">&gt; python3 -m pip install --user virtualenv<br/>&gt; python3 -m venv venv<br/>&gt; source venv/bin/activate</span></pre><p id="447e" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">之后的每一步都将在我们的Python虚拟环境中运行。</p><h2 id="ac5f" class="mq kw iq bd kx mr ms dn lb mt mu dp lf lw mv mw lh ma mx my lj me mz na ll nb bi translated">拥抱面部设置</h2><p id="4760" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">下一步是建立稳定的扩散。大多数情况下，我们只是按照<a class="ae mj" href="https://huggingface.co/blog/stable_diffusion" rel="noopener ugc nofollow" target="_blank">拥抱面部的指示来做</a>，但我会把它们嵌入以使它更简单。</p><p id="af4f" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">如果您没有拥抱脸帐户，您需要在此处创建一个:</p><div class="nc nd gp gr ne nf"><a href="https://huggingface.co" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd ir gy z fp nk fr fs nl fu fw ip bi translated">拥抱脸-人工智能社区建设未来。</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">构建、训练和部署由机器学习中的参考开源提供支持的最先进的模型。不止…</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">huggingface.co</p></div></div><div class="no l"><div class="od l nq nr ns no nt kp nf"/></div></div></a></div><p id="55db" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">回到我们的系统，我们设置了Hugging Face Hub和一些基本库，并从Hugging Face中获取了扩散器和稳定的扩散代码:</p><pre class="kg kh ki kj gt nu nv nw nx aw ny bi"><span id="2260" class="mq kw iq nv b gy nz oa l ob oc">&gt; pip install transformers scipy ftfy huggingface_hub<br/>&gt; git clone <a class="ae mj" href="https://github.com/huggingface/diffusers.git" rel="noopener ugc nofollow" target="_blank">https://github.com/huggingface/diffusers.git</a><br/>&gt; git clone <a class="ae mj" href="https://huggingface.co/CompVis/stable-diffusion-v1-4" rel="noopener ugc nofollow" target="_blank">https://huggingface.co/CompVis/stable-diffusion-v1-4</a> -b fp16</span></pre><p id="9ca9" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">这些签出应该要求您使用huggingface-cli登录，如下所示:</p><pre class="kg kh ki kj gt nu nv nw nx aw ny bi"><span id="4019" class="mq kw iq nv b gy nz oa l ob oc">Username for ‘<a class="ae mj" href="https://huggingface.co'" rel="noopener ugc nofollow" target="_blank">https://huggingface.co'</a>: &lt;your_user_name&gt;<br/>Password for ‘<a class="ae mj" href="https://tonym-intel@huggingface.co'" rel="noopener ugc nofollow" target="_blank">https://</a>&lt;your_user_name&gt;<a class="ae mj" href="https://tonym-intel@huggingface.co'" rel="noopener ugc nofollow" target="_blank">@huggingface.co'</a>:</span></pre><p id="a056" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">最后的步骤是使用pip安装扩散器库需要的一些基本组件和库本身，并将其指向扩散器目录:</p><pre class="kg kh ki kj gt nu nv nw nx aw ny bi"><span id="1f8b" class="mq kw iq nv b gy nz oa l ob oc">&gt; pip install diffusers</span></pre><h2 id="050d" class="mq kw iq bd kx mr ms dn lb mt mu dp lf lw mv mw lh ma mx my lj me mz na ll nb bi translated">PyTorch和用于PyTorch安装的英特尔扩展</h2><p id="ca23" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">最后，我们需要设置我们的英特尔GPU配置。下载PyTorch和PyTorch的英特尔扩展:</p><pre class="kg kh ki kj gt nu nv nw nx aw ny bi"><span id="6efe" class="mq kw iq nv b gy nz oa l ob oc">&gt; wget <a class="ae mj" href="https://github.com/intel/intel-extension-for-pytorch/releases/download/v1.10.200%2Bgpu/intel_extension_for_pytorch-1.10.200+gpu-cp39-cp39-linux_x86_64.whl" rel="noopener ugc nofollow" target="_blank">https://github.com/intel/intel-extension-for-pytorch/releases/download/v1.10.200%2Bgpu/intel_extension_for_pytorch-1.10.200+gpu-cp39-cp39-linux_x86_64.whl</a><br/>&gt; wget <a class="ae mj" href="https://github.com/intel/intel-extension-for-pytorch/releases/download/v1.10.200%2Bgpu/torch-1.10.0a0+git3d5f2d4-cp39-cp39-linux_x86_64.whl" rel="noopener ugc nofollow" target="_blank">https://github.com/intel/intel-extension-for-pytorch/releases/download/v1.10.200%2Bgpu/torch-1.10.0a0+git3d5f2d4-cp39-cp39-linux_x86_64.whl</a></span></pre><p id="c684" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">并使用pip安装车轮:</p><pre class="kg kh ki kj gt nu nv nw nx aw ny bi"><span id="6299" class="mq kw iq nv b gy nz oa l ob oc">&gt; source /opt/intel/oneapi/setvars.sh<br/>&gt; pip install torch-1.10.0a0+git3d5f2d4-cp39-cp39-linux_x86_64.whl<br/>&gt; pip install intel_extension_for_pytorch-1.10.200+gpu-cp39-cp39-linux_x86_64.whl</span></pre><p id="02b3" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">现在，一切都已就绪，可以在英特尔Arc GPU上运行PyTorch工作负载了。如果您希望使用低CPU内存使用模式，可以安装accelerate库。这一步应该在安装Intel wheels之后完成，否则您将在NumPy中得到一些错误。</p><pre class="kg kh ki kj gt nu nv nw nx aw ny bi"><span id="cbd5" class="mq kw iq nv b gy nz oa l ob oc">&gt; pip install accelerate</span></pre><h2 id="ecec" class="mq kw iq bd kx mr ms dn lb mt mu dp lf lw mv mw lh ma mx my lj me mz na ll nb bi translated">运行稳定扩散</h2><p id="924b" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">接下来是有趣的部分！通过拥抱脸扩散器库，稳定扩散已准备好使用，英特尔Arc GPU已准备好通过oneAPI加速它。为了便于运行，我创建了这个简单的Python脚本，它提示用户输入，然后打开结果输出图像:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="7ce9" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">我们可以简单地运行脚本，输入一些内容，然后查看输出:</p><pre class="kg kh ki kj gt nu nv nw nx aw ny bi"><span id="397f" class="mq kw iq nv b gy nz oa l ob oc">&gt; python run-stable-diffusion.py<br/>Enter keywords:<br/>AI GPU image for medium post</span></pre><p id="2c0f" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">它在这篇文章的顶部输出图像。</p><h1 id="ac04" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">结论</h1><p id="f78c" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">在独立英特尔GPU上支持PyTorch和Tensorflow！虽然许多人对英特尔GPU如何影响游戏GPU市场感到兴奋，但也有许多人使用GPU来加速非游戏工作负载。</p><p id="fc5d" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">正如<a class="ae mj" href="https://code.blender.org/2022/09/intel-arc-gpu-support-for-cycles/" rel="noopener ugc nofollow" target="_blank">英特尔GPU对Blender </a>的支持令许多人兴奋一样，对流行的人工智能框架的支持只是英特尔GPU故事的另一个里程碑。对于我们这些从事渲染、视频编辑、人工智能和其他计算工作负载的人来说，现在是对英特尔GPU感到兴奋的时候了。</p><p id="74d3" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated"><em class="og">如果你想看看我在看什么科技新闻，你可以在Twitter上关注我</em><a class="ae mj" href="https://twitter.com/tonymongkolsmai" rel="noopener ugc nofollow" target="_blank"><em class="og"/></a><em class="og">。此外，一起查看</em> <a class="ae mj" href="https://connectedsocialmedia.com/category/code-together/" rel="noopener ugc nofollow" target="_blank"> <em class="og">代码</em> </a> <em class="og">，这是我主持的面向开发者的英特尔播客，我们在这里讨论技术。</em></p><p id="055e" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated"><em class="og"> Tony是英特尔的一名软件架构师和技术宣传员。他开发过多种软件开发工具，最近领导软件工程团队构建了数据中心平台，实现了Habana的可扩展MLPerf解决方案。</em></p><p id="03db" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated"><em class="og">英特尔和其他英特尔标志是英特尔公司或其子公司的商标。其他名称和品牌可能是其他人的财产。</em></p></div></div>    
</body>
</html>