<html>
<head>
<title>Introducing Snapshot Testing for Jupyter Notebooks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Jupyter笔记本电脑快照测试简介</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/introducing-snapshot-testing-for-jupyter-notebooks-896512971df8#2022-07-05">https://towardsdatascience.com/introducing-snapshot-testing-for-jupyter-notebooks-896512971df8#2022-07-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="732e" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph">数据科学软件工程</h2><div class=""/><div class=""><h2 id="7829" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">nbsnapshot是一个开源软件包，它可以对笔记本的输出进行基准测试，以自动检测问题</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/5c6ae5184b07afb1c2cf550a60e55730.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VEwFOZgDdxzvjqPpXuhF6Q.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">图片作者。</p></figure><blockquote class="le lf lg"><p id="ffdb" class="lh li lj lk b ll lm ka ln lo lp kd lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">如果您想了解我的最新内容。<strong class="lk ja">跟我上</strong> <a class="ae me" href="https://medium.com/@edublancas" rel="noopener"> <strong class="lk ja">中</strong> </a> <strong class="lk ja">或</strong> <a class="ae me" href="https://twitter.com/edublancas" rel="noopener ugc nofollow" target="_blank"> <strong class="lk ja">推特</strong> </a> <strong class="lk ja">。</strong>感谢阅读！</p></blockquote><h1 id="595a" class="mf mg iq bd mh mi mj mk ml mm mn mo mp kf mq kg mr ki ms kj mt kl mu km mv mw bi translated">动机</h1><p id="cbea" class="pw-post-body-paragraph lh li iq lk b ll mx ka ln lo my kd lq mz na lt lu nb nc lx ly nd ne mb mc md ij bi translated">当在Jupyter笔记本上分析数据时，我会无意识地记住“经验法则”来确定我的结果是否正确。例如，我可能会打印一些汇总统计数据，如果这些数据与我过去看到的相差太多，我就会对这些数据产生怀疑。对于更复杂的分析，我经常创建诊断图(例如直方图)，并在新数据到达时检查它们。</p><p id="eee8" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated">我做这种半手工测试已经很多年了，在与其他数据科学家交谈时，我意识到这很常见；然而，没有工具可以简化这个过程。所以我开始问自己，我们是否可以自动化这个测试过程。在与一名前端开发人员交谈时，我清楚地知道了解决方案，他向我介绍了<a class="ae me" href="https://jestjs.io/docs/snapshot-testing" rel="noopener ugc nofollow" target="_blank">快照测试</a>的想法。</p><p id="f4eb" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated">想象一个前端开发人员使用HTML、CSS和Javascript创作UI。开发人员如何测试用户界面是否正确？你可以说一些用户界面比其他的更好(如果它们更容易使用的话)，但是正确性的论点在这里并不适用。所以我们最好的办法是使用我们以前的实现作为基准。例如，如果按钮的位置发生了意外变化，我们可能会引发错误。</p><p id="d472" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated">我们可以将同样的想法应用于笔记本测试。假设您有一个笔记本，它清理输入数据集，计算一些指标(例如，给定列上NAs的百分比)，然后存储清理后的数据集以供进一步分析:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="8084" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated">假设我们今天运行这个笔记本。然后，一个星期过去了，我们运行笔记本并获得相同的结果。然后，两个星期过去了，我们运行笔记本，并意识到我们的指标看起来与前两个值非常不同。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/8815d330d6d9cb60ffcaf8a5aaa49fbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:856/format:webp/1*94fJsmdDGeR-XDtRQUaIZQ.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">第三周的结果与前两周相差太多。</p></figure><p id="90c2" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated">我们不知道原因是什么，但我们知道发生了一些事情。因此，我们继续分析这种情况:可能是输入数据发生了变化，也可能是我们的代码包含了一些错误。不管那是什么，很高兴我们发现了这个，这样我们就可以进一步调查了。</p><p id="9ce1" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated">快照测试旨在促进这一过程:我们将自动对笔记本电脑的输出进行基准测试，以检测潜在的问题。</p><h1 id="86ab" class="mf mg iq bd mh mi mj mk ml mm mn mo mp kf mq kg mr ki ms kj mt kl mu km mv mw bi translated">介绍<code class="fe ni nj nk nl b">nbsnapshot</code></h1><p id="ada0" class="pw-post-body-paragraph lh li iq lk b ll mx ka ln lo my kd lq mz na lt lu nb nc lx ly nd ne mb mc md ij bi translated">据我们所知，<a class="ae me" href="https://github.com/ploomber/nbsnapshot" rel="noopener ugc nofollow" target="_blank"> nbsnapshot </a>是Jupyter笔记本的第一个快照测试实现，我们很高兴发布它！</p><blockquote class="le lf lg"><p id="adc2" class="lh li lj lk b ll lm ka ln lo lp kd lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">通过主演<a class="ae me" href="https://github.com/ploomber/nbsnapshot" rel="noopener ugc nofollow" target="_blank"> GitHub库来表示你的支持！</a>谢谢！</p></blockquote><p id="7138" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated">想法很简单，每次我们运行我们的笔记本，我们记录我们想要基准的输出。然后，一旦我们有了至少两个历史记录，我们就开始将新值与历史值进行比较。最后，如果新值偏离(默认情况下，它使用三个标准差作为阈值)记录的值，我们会显示一个错误。让我们来看一个完整的例子。</p><p id="b767" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated">首先，让我们导入几个包，并声明我们将使用的两个函数:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="da03" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated">下载笔记本样本:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="0b52" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated">让我们创建一个假的历史文件来模拟我们运行一个笔记本(只有一个单元格)10次。为了生成一个假输出，我们从以<code class="fe ni nj nk nl b">10</code>(和<code class="fe ni nj nk nl b">1</code>的标准偏差)为中心的正态分布中提取值:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="2587" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated"><strong class="lk ja">控制台输出:(1/1): </strong></p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nm"><img src="../Images/51616c6a5879edcaa48d4016c2f1a2be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7dRbC8SkW39RlBKsV2pzWQ.png"/></div></div></figure><p id="8012" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated">让我们运行示例笔记本(<code class="fe ni nj nk nl b">constant.ipynb</code>)。这个笔记本只有一个打印数字<code class="fe ni nj nk nl b">10</code>的单元格。因为这个数字在我们的假历史的界限内，所以测试通过:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="c4e0" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated"><strong class="lk ja">控制台输出:(1/1): </strong></p><pre class="kp kq kr ks gt nn nl no np aw nq bi"><span id="ae16" class="nr mg iq nl b gy ns nt l nu nv">Testing: 'metric' - OK!</span></pre><p id="49de" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated">现在，让我们改写现有的历史，并用从以<code class="fe ni nj nk nl b">0</code>为中心的正态分布中抽取的数字来替换它:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="a61a" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated"><strong class="lk ja">控制台输出:(1/1): </strong></p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nm"><img src="../Images/1b20ed233dc41c7b959823f3911a4861.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l30KrYv4V2lb-1JeWYRP0Q.png"/></div></div></figure><p id="6443" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated">重新运行笔记本。这一次，笔记本里的数值(<code class="fe ni nj nk nl b">10</code>)偏离历史记录太多。因此，测试失败:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="6caa" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated"><strong class="lk ja">控制台输出:(1/1): </strong></p><pre class="kp kq kr ks gt nn nl no np aw nq bi"><span id="25f7" class="nr mg iq nl b gy ns nt l nu nv">Testing 'metric' - FAIL! Value is too high (10), expected one between -4.17 and 3.92</span></pre><p id="2396" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated">就是这样！这种简单的方法让我们无需额外的努力就能检测出笔记本中的问题！</p><h1 id="9669" class="mf mg iq bd mh mi mj mk ml mm mn mo mp kf mq kg mr ki ms kj mt kl mu km mv mw bi translated">用例</h1><p id="cbc8" class="pw-post-body-paragraph lh li iq lk b ll mx ka ln lo my kd lq mz na lt lu nb nc lx ly nd ne mb mc md ij bi translated">这里有两个重要的用例，其中快照测试非常有用。</p><p id="fbff" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated"><strong class="lk ja">监测数据质量</strong></p><p id="c531" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated">假设你有一个笔记本，每周都要接收数据。您可以使用快照测试来衡量所接收数据的质量，如果质量突然下降，就抛出一个错误。例如，您可能有一个在名为<code class="fe ni nj nk nl b">age</code>的列中打印NAs百分比的单元格:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/8e5018b9c60ae0f043a02865a29e0c77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/1*Y4OeuA5L8LxoaBYH5a6lvg.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">nbsnapshot将在星期五抛出一个错误，因为该值是意外的。</p></figure><p id="2636" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated">在上表中可以看到，从周一到周四，NAs的百分比与<code class="fe ni nj nk nl b">1%</code>有一点偏离，但是到了周五，却暴涨到了<code class="fe ni nj nk nl b">5%</code>，一定是发生了什么事情。</p><p id="02b5" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated">另一个示例测试是计算<code class="fe ni nj nk nl b">age</code>列中具有负值的观察值的数量。该测试将允许您检测诸如<code class="fe ni nj nk nl b">-2</code>或<code class="fe ni nj nk nl b">-10</code>之类的损坏值何时进入笔记本。</p><p id="fc14" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated"><strong class="lk ja">监控模特训练表现</strong></p><p id="f1a3" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated">假设您有一个笔记本，它使用一个训练数据集作为输入，并输出一个训练好的模型。如果模型性能指标(例如准确性)突然下降，您可以使用快照测试来抛出一个错误。快照测试可以帮助您检测诸如损坏的数据、模型错误配置或数据泄漏等问题。</p><p id="a950" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated">例如，假设您一直在训练模型，突然，模型精度下降了:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/be0ca8bcaca62a825794c8a61b5dec13.png" data-original-src="https://miro.medium.com/v2/resize:fit:892/format:webp/1*d91Kp1nDpHyL9v-X7qwLbA.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">由于性能显著下降，nbsnapshot将在第五次实验时抛出错误。</p></figure><p id="4a66" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated">了解这种突然的变化将允许你进一步调查，找出发生了什么。</p><h1 id="9104" class="mf mg iq bd mh mi mj mk ml mm mn mo mp kf mq kg mr ki ms kj mt kl mu km mv mw bi translated">使用快照测试进行持续集成</h1><p id="d0e5" class="pw-post-body-paragraph lh li iq lk b ll mx ka ln lo my kd lq mz na lt lu nb nc lx ly nd ne mb mc md ij bi translated">为了有效地测试，我们建议您以持续集成的方式实现快照测试；这意味着无论何时修改源代码都要运行测试。例如，您可以使用<a class="ae me" href="https://github.com/features/actions" rel="noopener ugc nofollow" target="_blank"> GitHub Actions </a>并在每次提交项目时运行以下命令:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="21ff" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated">每当您将更改推送到您的存储库时，这个命令将运行测试。</p><h1 id="761b" class="mf mg iq bd mh mi mj mk ml mm mn mo mp kf mq kg mr ki ms kj mt kl mu km mv mw bi translated">考虑</h1><p id="598c" class="pw-post-body-paragraph lh li iq lk b ll mx ka ln lo my kd lq mz na lt lu nb nc lx ly nd ne mb mc md ij bi translated"><code class="fe ni nj nk nl b">nbsnapshot</code>支持查看同一笔记本中的多个单元格；然而，考虑到您进行的测试越多，由于<a class="ae me" href="https://en.wikipedia.org/wiki/Multiple_comparisons_problem" rel="noopener ugc nofollow" target="_blank">假阳性</a>而导致任何检查失败的可能性就越大。所以我们建议只测试几个基本的指标。在输出具有确定性的情况下，您可以根据需要检查任意多个像元。</p><p id="0b93" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated">快照测试需要手动更新历史结果。例如，假设您一直在训练一个模型，并且在最近十次实验中，历史精度一直在0.80左右；然后，你意识到那些实验有数据泄漏。修复问题后，精度下降到0.70。因此，如果您运行快照测试，它将会失败。但是，在这种情况下，错误出现在历史记录中，因此您应该删除它们并用新值0.70替换它们。进行这种清理需要额外的努力，但是从长远来看，快照测试节省的时间是值得的。</p><h1 id="9031" class="mf mg iq bd mh mi mj mk ml mm mn mo mp kf mq kg mr ki ms kj mt kl mu km mv mw bi translated">结束语</h1><p id="d767" class="pw-post-body-paragraph lh li iq lk b ll mx ka ln lo my kd lq mz na lt lu nb nc lx ly nd ne mb mc md ij bi translated">在这篇博文中，我们介绍了Jupyter笔记本的快照测试，这个简单的想法可以极大地改善数据科学家的工作流程。请给<a class="ae me" href="https://github.com/ploomber/nbsnapshot" rel="noopener ugc nofollow" target="_blank"> nbsnapshot </a>一个尝试。该库是新的，所以如果您有任何功能需求，请告诉我们！nbsnapshot的完美补充是<a class="ae me" href="https://github.com/ploomber/ploomber" rel="noopener ugc nofollow" target="_blank"> Ploomber </a>，我们的开源框架用于编排基于笔记本的管道。</p></div><div class="ab cl ny nz hu oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="ij ik il im in"><blockquote class="le lf lg"><p id="524c" class="lh li lj lk b ll lm ka ln lo lp kd lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">嗨！我叫爱德华多！我喜欢写所有关于数据科学的东西，并为开源项目做贡献。如果您想了解我的最新内容。<strong class="lk ja">跟我上</strong> <a class="ae me" href="https://medium.com/@edublancas" rel="noopener"> <strong class="lk ja">中</strong> </a> <strong class="lk ja">或</strong> <a class="ae me" href="https://twitter.com/edublancas" rel="noopener ugc nofollow" target="_blank"> <strong class="lk ja">碎碎念</strong> </a> <strong class="lk ja">。</strong>感谢阅读！</p></blockquote><p id="5c58" class="pw-post-body-paragraph lh li iq lk b ll lm ka ln lo lp kd lq mz ls lt lu nb lw lx ly nd ma mb mc md ij bi translated"><em class="lj">原载于</em><a class="ae me" href="https://ploomber.io/blog/snapshot-testing/" rel="noopener ugc nofollow" target="_blank"><em class="lj">ploomber . io</em></a></p></div></div>    
</body>
</html>