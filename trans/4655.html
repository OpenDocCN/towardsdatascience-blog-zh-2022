<html>
<head>
<title>SQLAlchemy for absolute beginners</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">绝对初学者的SQLAlchemy</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/sqlalchemy-for-absolute-beginners-22227a287ef3#2022-10-17">https://towardsdatascience.com/sqlalchemy-for-absolute-beginners-22227a287ef3#2022-10-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5081" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">创建数据库引擎并从Python执行SQL</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/bae906252f184afb1332c5e6e490acc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DCJlkga7JQLeThhu"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">一些适当的炼金术(图片由<a class="ae ky" href="https://unsplash.com/@miracleday" rel="noopener ugc nofollow" target="_blank">埃琳娜·莫日维洛</a>在<a class="ae ky" href="https://unsplash.com/photos/JWtNpyXy-fQ" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄)</p></figure><p id="4738" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">SqlAlchemy是一种允许Python处理来自数据库的数据的简单快捷的方法。用引擎<strong class="lb iu">创建到数据库</strong>的连接非常简单。此外，用引擎和ORM查询数据库和检索数据也非常容易。</p><p id="f789" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们将做两件事:</p><ol class=""><li id="6ce2" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">用引擎创建到我们数据库的连接)</li><li id="55cd" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">使用引擎执行原始SQL</li></ol><p id="3cce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们将关注接下来的步骤:我们可以使用数据库引擎的所有其他事情；比如一个迁移模型。我们将开始创建连接；我们来编码吧！</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="e882" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">1.创建数据库引擎</h1><p id="7ac6" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">数据库引擎允许我们与数据库通信。创造一个并不难。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h2 id="f481" class="nn mr it bd ms no np dn mw nq nr dp na li ns nt nc lm nu nv ne lq nw nx ng ny bi translated">步骤1-创建连接字符串</h2><p id="ce54" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">首先，我们将创建一个连接字符串。这指定了关于我们的数据库的详细信息:它的托管位置和凭证。</p><pre class="kj kk kl km gt nz oa ob oc aw od bi"><span id="6a34" class="nn mr it oa b gy oe of l og oh">import sqlalchemy as sa</span><span id="9b5c" class="nn mr it oa b gy oi of l og oh"># Step 1: Create connection string<br/>constring: sa.engine.url.URL = sa.engine.URL.create(<br/>    drivername="postgresql",<br/>    username="postgres",<br/>    password="mysecretpassword",<br/>    host="localhost",<br/>    port=5432,<br/>    database="mydb"<br/>)</span></pre><p id="d5e5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，我们正在连接到本地主机上的Postgres数据库。</p><blockquote class="oj ok ol"><p id="9eb6" class="kz la om lb b lc ld ju le lf lg jx lh on lj lk ll oo ln lo lp op lr ls lt lu im bi translated">通常，硬编码您的凭证是一个非常糟糕的想法。如果我在Github上把这个文件提交给我的repo，每个人都可以看到我的凭证。强烈建议将您的凭证保存在一个<code class="fe oq or os oa b"><em class="it">.env</em></code>文件中，这是一个<strong class="lb iu">简单的技术，可以防止您的机密信息落入坏人之手</strong>。查看下面的文章，了解如何做到这一点。</p></blockquote><div class="ot ou gp gr ov ow"><a rel="noopener follow" target="_blank" href="/keep-your-code-secure-by-using-environment-variables-and-env-files-4688a70ea286"><div class="ox ab fo"><div class="oy ab oz cl cj pa"><h2 class="bd iu gy z fp pb fr fs pc fu fw is bi translated">通过使用环境变量和env文件来保证代码的安全</h2><div class="pd l"><h3 class="bd b gy z fp pb fr fs pc fu fw dk translated">安全地加载一个文件，其中包含我们的应用程序所需的所有机密数据，如密码、令牌等</h3></div><div class="pe l"><p class="bd b dl z fp pb fr fs pc fu fw dk translated">towardsdatascience.com</p></div></div><div class="pf l"><div class="pg l ph pi pj pf pk ks ow"/></div></div></a></div></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h2 id="6a03" class="nn mr it bd ms no np dn mw nq nr dp na li ns nt nc lm nu nv ne lq nw nx ng ny bi translated">步骤2:创建引擎</h2><p id="17a6" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">然后我们使用<code class="fe oq or os oa b">constring</code>来创建一个引擎。</p><pre class="kj kk kl km gt nz oa ob oc aw od bi"><span id="2faa" class="nn mr it oa b gy oe of l og oh"># Step 2: Create and configure engine with the connection string<br/>dbEngine= sa.create_engine(<br/>    url=constring,<br/>    # fast_executemany=True,<br/>)</span></pre><p id="f679" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我通过<code class="fe oq or os oa b">fast_executemany</code>作为补充论证。这是SQL Server针对更快插入的特定优化。阅读以下文章了解更多信息:</p><div class="ot ou gp gr ov ow"><a rel="noopener follow" target="_blank" href="/dramatically-improve-your-database-inserts-with-a-simple-upgrade-6dfa672f1424"><div class="ox ab fo"><div class="oy ab oz cl cj pa"><h2 class="bd iu gy z fp pb fr fs pc fu fw is bi translated">通过简单的升级，显著提高数据库插入速度</h2><div class="pd l"><h3 class="bd b gy z fp pb fr fs pc fu fw dk translated">用Python创建速度惊人的数据库连接的4个层次</h3></div><div class="pe l"><p class="bd b dl z fp pb fr fs pc fu fw dk translated">towardsdatascience.com</p></div></div><div class="pf l"><div class="pl l ph pi pj pf pk ks ow"/></div></div></a></div></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h2 id="b8b1" class="nn mr it bd ms no np dn mw nq nr dp na li ns nt nc lm nu nv ne lq nw nx ng ny bi translated">步骤3:连接和测试发动机</h2><p id="e71a" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">在上一步中，我们已经定义了引擎。在这一步中，我们将尝试连接并检查连接是否有效。</p><pre class="kj kk kl km gt nz oa ob oc aw od bi"><span id="7b51" class="nn mr it oa b gy oe of l og oh"># Step 3: Testing my engine<br/>try:<br/>    with dbEngine_sqlserver_localhost.connect() as con:<br/>        con.execute("SELECT 1")<br/>    print("Engine valid")<br/>except Exception as e:<br/>    print(f"Engine invalid: {e}")</span></pre><p id="620e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们<code class="fe oq or os oa b">try</code>执行一些简单的SQL。如果这没有引起错误，我们知道我们连接正确。否则，我们可以检查错误，看看哪里出错了。</p><p id="ce75" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，您可能会得到一个错误，因为SQLAlchemy缺少必需的包。例如，为了连接到Postgres数据库，我们需要<code class="fe oq or os oa b">pip install psycopg2</code>。SQL Server需要<code class="fe oq or os oa b">pyodbc</code>。SQLAlchemy非常清楚这一点，所以只需遵循说明。</p><div class="ot ou gp gr ov ow"><a rel="noopener follow" target="_blank" href="/python-to-sql-upsert-safely-easily-and-fast-17a854d4ec5a"><div class="ox ab fo"><div class="oy ab oz cl cj pa"><h2 class="bd iu gy z fp pb fr fs pc fu fw is bi translated">Python到SQL —安全、轻松、快速地向上插入</h2><div class="pd l"><h3 class="bd b gy z fp pb fr fs pc fu fw dk translated">使用Python进行闪电般的插入和/或更新</h3></div><div class="pe l"><p class="bd b dl z fp pb fr fs pc fu fw dk translated">towardsdatascience.com</p></div></div><div class="pf l"><div class="pm l ph pi pj pf pk ks ow"/></div></div></a></div></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="5d7d" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">2.使用引擎执行SQL</h1><p id="a9c0" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">现在我们已经创建了数据库引擎，我们可以开始使用它了。在前一章中，我们已经先睹为快地执行了<code class="fe oq or os oa b">SELECT 1</code>。在本章中，我们将讨论在引擎上执行原始SQL的优点和缺点。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h2 id="b74e" class="nn mr it bd ms no np dn mw nq nr dp na li ns nt nc lm nu nv ne lq nw nx ng ny bi translated">原始SQL示例:创建表</h2><p id="2f2a" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">在下面的示例中，我们将看到执行原始SQL的缺点:</p><pre class="kj kk kl km gt nz oa ob oc aw od bi"><span id="6dee" class="nn mr it oa b gy oe of l og oh">statement_create = """<br/>    CREATE TABLE IF NOT EXISTS Students (<br/>        ID SERIAL PRIMARY KEY,<br/>        Name TEXT,<br/>        Age INT<br/>    )<br/>"""<br/>with dbEngine_sqlserver_localhost.connect() as con:<br/>    con.execute(statement_create)</span></pre><p id="9869" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将使用一些PostgreSQL来创建一个语句，然后使用连接来执行它。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h2 id="702f" class="nn mr it bd ms no np dn mw nq nr dp na li ns nt nc lm nu nv ne lq nw nx ng ny bi translated">原始SQL的问题是</h2><p id="5af1" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">尽管这很容易；执行原始SQL有一些缺点:</p><ol class=""><li id="4dc6" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">容易出错:在SQL语法中很容易出错</li><li id="84b3" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><strong class="lb iu">特定于数据库的</strong>:也许您只想在Postgres上测试和开发，但是您的生产数据库是另一种类型。例如，如果你使用SQL Server，你不能使用<code class="fe oq or os oa b">ID SERIAL PRIMARY KEY</code>，而应该使用类似<code class="fe oq or os oa b">ID INT IDENTITY(1,1) PRIMARY KEY</code>的东西。</li><li id="6ce4" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><strong class="lb iu">组织</strong>:你的存储库将会充满SQL语句。想象一下，如果一个列名改变了；您需要浏览所有这些SQL语句并调整您的查询。</li></ol><div class="ot ou gp gr ov ow"><a rel="noopener follow" target="_blank" href="/sql-understand-how-indices-work-under-the-hood-to-speed-up-your-queries-a7f07eef4080"><div class="ox ab fo"><div class="oy ab oz cl cj pa"><h2 class="bd iu gy z fp pb fr fs pc fu fw is bi translated">SQL——理解索引如何在幕后加速查询。</h2><div class="pd l"><h3 class="bd b gy z fp pb fr fs pc fu fw dk translated">不用再等待缓慢的查询完成</h3></div><div class="pe l"><p class="bd b dl z fp pb fr fs pc fu fw dk translated">towardsdatascience.com</p></div></div><div class="pf l"><div class="pn l ph pi pj pf pk ks ow"/></div></div></a></div></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h2 id="c711" class="nn mr it bd ms no np dn mw nq nr dp na li ns nt nc lm nu nv ne lq nw nx ng ny bi translated">解决方案:与数据库无关的模型</h2><p id="a284" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">SqlAlchemy通过创建映射到数据库中的表的<strong class="lb iu">对象来解决这个问题(这是ORM中的对象关系映射)。这有许多优点:</strong></p><ol class=""><li id="0eb8" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">模型是<strong class="lb iu">数据库不可知的</strong>。这意味着对象不知道需要哪个数据库和语法。例如，在插入SQLAlchemy时，它会将对象编译成一条语句，这条语句适合我们正在使用的数据库(-engine)。这意味着<strong class="lb iu">您的Python代码<em class="om">会运行</em>，即使您的开发环境使用与您的生产环境相比的另一个数据库</strong>。这使得使用数据库更加灵活，在使用<a class="ae ky" href="https://mikehuls.medium.com/python-database-migrations-for-beginners-getting-started-with-alembic-84e4a73a2cca" rel="noopener">迁移模型</a>时尤其有用。</li><li id="063d" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">不易出错:<strong class="lb iu"> SQL是为您生成的</strong>,因此几乎不可能出现语法错误。此外，你只在你的Python-IDE中使用Python类，所以很难打错字。</li><li id="888a" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">你所有的模型都整齐地<strong class="lb iu">组织在一个地方</strong>，并导入到你的项目中。如果有人更改了数据库表的列名，您只需要调整一个模型，而不是修复许多原始SQL查询。</li></ol><p id="e34e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我目前正在写一篇文章，演示如何将SQLAlchemy的ORM用于数据库引擎。<a class="ae ky" href="https://mikehuls.medium.com/membership" rel="noopener"> <strong class="lb iu">跟我来</strong> </a> <strong class="lb iu">敬请关注</strong>！</p><div class="ot ou gp gr ov ow"><a rel="noopener follow" target="_blank" href="/find-the-top-n-most-expensive-queries-48e46d8e9752"><div class="ox ab fo"><div class="oy ab oz cl cj pa"><h2 class="bd iu gy z fp pb fr fs pc fu fw is bi translated">查找数据库中前n个最慢的查询</h2><div class="pd l"><h3 class="bd b gy z fp pb fr fs pc fu fw dk translated">找到降低数据库处理速度的瓶颈查询</h3></div><div class="pe l"><p class="bd b dl z fp pb fr fs pc fu fw dk translated">towardsdatascience.com</p></div></div><div class="pf l"><div class="po l ph pi pj pf pk ks ow"/></div></div></a></div></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="9aeb" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">结论</h1><p id="4dde" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">在本文中，我们探索了SQL炼金术的起源；我们知道如何连接到数据库，以及如何执行原始SQL。我们还讨论了执行原始SQL的利弊，并理解对于大多数项目来说，使用ORM是更好的选择。在下一篇文章中，我们将了解ORM以及如何使用它。</p><p id="1f64" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望一切都像我希望的那样清楚，但如果不是这样，请让我知道我能做些什么来进一步澄清。同时，看看我的其他关于各种编程相关主题的文章:</p><ul class=""><li id="6a71" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu pp mb mc md bi translated"><a class="ae ky" href="https://mikehuls.medium.com/why-is-python-so-slow-and-how-to-speed-it-up-485b5a84154e" rel="noopener">Python为什么这么慢，如何加速</a></li><li id="0c4d" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu pp mb mc md bi translated"><a class="ae ky" href="https://mikehuls.medium.com/git-for-absolute-beginners-understanding-git-with-the-help-of-a-video-game-88826054459a" rel="noopener"> <strong class="lb iu"> Git </strong>绝对初学者:借助视频游戏理解Git</a></li><li id="a1c1" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu pp mb mc md bi translated"><a class="ae ky" href="https://mikehuls.medium.com/create-and-publish-your-own-python-package-ea45bee41cdc" rel="noopener">创建并发布自己的<strong class="lb iu"> Python包</strong> </a></li><li id="e339" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu pp mb mc md bi translated"><a class="ae ky" href="https://mikehuls.medium.com/virtual-environments-for-absolute-beginners-what-is-it-and-how-to-create-one-examples-a48da8982d4b" rel="noopener"> <strong class="lb iu">虚拟环境</strong>面向绝对初学者——什么是虚拟环境以及如何创建虚拟环境(+示例</a>)</li><li id="b279" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu pp mb mc md bi translated"><a class="ae ky" href="https://mikehuls.medium.com/create-a-fast-auto-documented-maintainable-and-easy-to-use-python-api-in-5-lines-of-code-with-4e574c00f70e" rel="noopener">用FastAPI </a>用5行代码创建一个快速自动归档、可维护且易于使用的Python <strong class="lb iu"> API</strong></li><li id="16f9" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu pp mb mc md bi translated"><a class="ae ky" href="https://mikehuls.medium.com/cython-for-absolute-beginners-30x-faster-code-in-two-simple-steps-bbb6c10d06ad" rel="noopener"/></li><li id="4425" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu pp mb mc md bi translated"><a class="ae ky" href="https://mikehuls.medium.com/docker-for-absolute-beginners-what-is-docker-and-how-to-use-it-examples-3d3b11efd830" rel="noopener"> <strong class="lb iu"> Docker </strong>适合绝对初学者——Docker是什么，怎么用(+举例)</a></li></ul><p id="bd40" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编码快乐！</p><p id="8bf9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">—迈克</p><p id="6381" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">附注:喜欢我正在做的事吗？ <a class="ae ky" href="https://mikehuls.medium.com/membership" rel="noopener"> <em class="om">跟我来！</em>T13】</a></p><div class="ot ou gp gr ov ow"><a href="https://mikehuls.medium.com/membership" rel="noopener follow" target="_blank"><div class="ox ab fo"><div class="oy ab oz cl cj pa"><h2 class="bd iu gy z fp pb fr fs pc fu fw is bi translated">通过我的推荐链接加入媒体-迈克·赫斯</h2><div class="pd l"><h3 class="bd b gy z fp pb fr fs pc fu fw dk translated">阅读迈克·赫斯(以及媒体上成千上万的其他作家)的每一个故事。你的会员费直接支持麦克…</h3></div><div class="pe l"><p class="bd b dl z fp pb fr fs pc fu fw dk translated">mikehuls.medium.com</p></div></div><div class="pf l"><div class="pq l ph pi pj pf pk ks ow"/></div></div></a></div></div></div>    
</body>
</html>