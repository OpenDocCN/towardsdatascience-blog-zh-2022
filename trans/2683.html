<html>
<head>
<title>How to Design Better DAGs in Apache Airflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Apache气流中设计更好的Dag</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-design-better-dags-in-apache-airflow-494f5cb0c9ab#2022-06-09">https://towardsdatascience.com/how-to-design-better-dags-in-apache-airflow-494f5cb0c9ab#2022-06-09</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><h2 id="c8ad" class="is it iu bd b dl iv iw ix iy iz ja dk jb translated" aria-label="kicker paragraph">数据工程</h2><div class=""/><div class=""><h2 id="0e58" class="pw-subtitle-paragraph ka jd iu bd b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr dk translated">设计工作流时需要知道的两个最重要的属性</h2></div><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj ks"><img src="../Images/050cc0ba20f84f566ba3d13e4ad733f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Qv9Imt-nkaFpb_Cf"/></div></div><p class="le lf gk gi gj lg lh bd b be z dk translated"><a class="ae li" href="https://unsplash.com/@campaign_creators?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">活动发起人</a>在<a class="ae li" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="d9fd" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated"><a class="ae li" rel="noopener" target="_blank" href="/setting-up-apache-airflow-with-docker-compose-in-5-minutes-56a1110f4122"> <strong class="ll je">上周</strong> </a>，我们学习了如何快速搭建Apache Airflow的开发环境。</p><p id="0a36" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">这太棒了。</p><p id="95ce" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">然而，我们还需要学习如何设计一个高效的工作流程。不幸的是，仅仅在我们的指尖有一个伟大的工具并不能单独解决问题。</p><p id="49fc" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">虽然Apache Airflow在为我们做大部分繁重的工作方面做得很好，但是我们仍然需要<strong class="ll je">确保每个Airflow任务的某些关键属性</strong>，以便获得正确和一致的结果。</p><p id="a3ec" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">幸运的是，存在许多最佳实践。</p><p id="d98f" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">今天，我们从普遍适用于所有工作流的两个最重要的概念开始。</p><p id="530e" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">今天，我们学习<strong class="ll je">原子性</strong>和<strong class="ll je">幂等性</strong>。</p></div><div class="ab cl mf mg hy mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="in io ip iq ir"><h1 id="a270" class="mm mn iu bd mo mp mq mr ms mt mu mv mw kj mx kk my km mz kn na kp nb kq nc nd bi translated">全有或全无:原子性</h1><p id="92c9" class="pw-post-body-paragraph lj lk iu ll b lm ne ke lo lp nf kh lr ls ng lu lv lw nh ly lz ma ni mc md me in bi translated">通常在数据库系统的上下文中使用，原子性是ACID属性之一，被认为是一系列不可分割、不可约的操作，因此要么全部发生，要么什么都不发生。要么完全执行，要么根本不执行。</p><p id="474c" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">就Apache Airflow而言，这意味着任务应该以这样一种方式定义，即<strong class="ll je">允许成功</strong>和适当的结果<strong class="ll je">或者完全失败</strong>，而不影响系统的状态。</p><p id="b5ec" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">让我们想象一下，我们必须从CSV文件中提取数据，对其进行一些转换，并将结果写入数据库。</p><p id="6933" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">很简单，对吧？</p><p id="82c2" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">一个不好的，<strong class="ll je">非原子方法</strong>如下。</p><p id="819d" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">我们逐行提取数据，立即应用转换，并将结果立即上传到数据库。<strong class="ll je">都在同一个任务</strong>内。</p><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj nj"><img src="../Images/ec8b628e3b26f10fb27e5939ba2f9b67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hddzFzwBnQqtxJRkwAxGRg.png"/></div></div><p class="le lf gk gi gj lg lh bd b be z dk translated">非原子方法[图片由作者提供]</p></figure><p id="21f6" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">现在，如果一些行被破坏，任务中途失败，我们只剩下期望结果的一部分。一些行已经被处理和插入——一些根本不存在。在避免重复的同时调试和重新运行这项任务将是一场噩梦。</p><p id="1b2d" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">一个改进的，<strong class="ll je">原子工作流</strong>可以这样定义。</p><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj nk"><img src="../Images/77e80f65a42a57eb3bd7296f0b4f7ce2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bh8Sc3Rf5fmdnmWiQpq5ZA.png"/></div></div><p class="le lf gk gi gj lg lh bd b be z dk translated">原子任务的更好方法[图片由作者提供]</p></figure><p id="187a" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">所以要记住的一般经验是<strong class="ll je">将操作</strong>分成不同的任务。一个操作等于一个单一任务——想想<a class="ae li" href="https://en.wikipedia.org/wiki/Single-responsibility_principle" rel="noopener ugc nofollow" target="_blank">单一责任原则</a>。</p><blockquote class="nl"><p id="fce9" class="nm nn iu bd no np nq nr ns nt nu me dk translated">不幸的是，这个简单的规则不能每次都适用。</p></blockquote><p id="9f2a" class="pw-post-body-paragraph lj lk iu ll b lm nv ke lo lp nw kh lr ls nx lu lv lw ny ly lz ma nz mc md me in bi translated">一些操作是如此的<strong class="ll je">紧密耦合</strong>，以至于最好<strong class="ll je">将它们保持在一个</strong> <strong class="ll je">一致的工作单元</strong>。例如，在执行请求之前对API进行身份验证。</p><p id="31be" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">幸运的是，大多数<strong class="ll je">气流操作器都是以原子方式</strong>设计的，可以直接使用。然而，对于更灵活的操作符类型，如Bash或Python操作符，我们在设计工作流时必须更加小心谨慎。</p><p id="6db3" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">创建原子气流任务允许<strong class="ll je">从失败中恢复</strong>的能力，并且只重新运行失败的和下游的任务。原子性提供了更容易维护和<strong class="ll je">透明的工作流</strong>，没有隐藏的依赖性和副作用。</p></div><div class="ab cl mf mg hy mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="in io ip iq ir"><h1 id="e08c" class="mm mn iu bd mo mp mq mr ms mt mu mv mw kj mx kk my km mz kn na kp nb kq nc nd bi translated">开始、停止、倒带:等幂</h1><p id="c66b" class="pw-post-body-paragraph lj lk iu ll b lm ne ke lo lp nf kh lr ls ng lu lv lw nh ly lz ma ni mc md me in bi translated">幂等性的概念与原子性的概念密切相关，并描述了数学和计算机科学中某些运算的属性。因此操作可以<strong class="ll je">多次应用，而不改变初始应用之外的结果</strong>。</p><p id="d6a8" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">把按下控制面板上的“on-button”想象成一种操作。多次按下此按钮与只按一次效果相同。</p><blockquote class="nl"><p id="c962" class="nm nn iu bd no np nq nr ns nt nu me dk translated">那么这在阿帕奇气流的上下文中意味着什么呢？</p></blockquote><p id="d24e" class="pw-post-body-paragraph lj lk iu ll b lm nv ke lo lp nw kh lr ls nx lu lv lw ny ly lz ma nz mc md me in bi translated">使用相同的输入多次调用相同的任务没有额外的效果。换句话说，如果<strong class="ll je">在不改变输入</strong> <strong class="ll je">的情况下重新运行一个任务产生了</strong> <strong class="ll je">相同的输出</strong>，则可以认为它是幂等的。</p><p id="18b9" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">幂等性允许<strong class="ll je">减少故障恢复时间</strong>，并且<strong class="ll je">减少数据丢失</strong>。</p><p id="5ffd" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">现在，假设我们的工作是从数据库中获取特定日期的数据，并将结果写入CSV文件。在同一天重新运行该任务应该会覆盖现有文件，并且每次执行时<strong class="ll je">都会产生相同的输出</strong>。</p><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj oa"><img src="../Images/fa717de4892a16192331d19eb256bc90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X0Oy0735iOArATNYUo_lAw.png"/></div></div><p class="le lf gk gi gj lg lh bd b be z dk translated">每次都产生相同输出的幂等任务[图片由作者提供]</p></figure><p id="8954" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">假设，我们以不同的方式设计我们的任务，在每次重新运行时，我们简单地将记录附加到一个现有的文件中。</p><p id="cf50" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">现在，我们<strong class="ll je">违背了</strong> <strong class="ll je">幂等</strong>的概念。任务的每次重新运行都会产生不同的结果，其中包含重复的记录。</p><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div class="gi gj ob"><img src="../Images/57a12164ed1bbee706cb1e0d29c387b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1316/format:webp/1*l9FS-rUpwxDjDULjb8XA9w.png"/></div><p class="le lf gk gi gj lg lh bd b be z dk translated">产生重复结果的非等幂任务[图片由作者提供]</p></figure><p id="5f5a" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">一般来说，写的任务应该<strong class="ll je">检查现有记录</strong>，<strong class="ll je">覆盖</strong>或者使用<strong class="ll je">上插</strong>操作，以符合等幂规则。</p><p id="6133" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">然而，对于更一般的应用，我们必须仔细考虑所有可能的副作用。</p><h1 id="60b1" class="mm mn iu bd mo mp oc mr ms mt od mv mw kj oe kk my km of kn na kp og kq nc nd bi translated">结论:</h1><p id="68fd" class="pw-post-body-paragraph lj lk iu ll b lm ne ke lo lp nf kh lr ls ng lu lv lw nh ly lz ma ni mc md me in bi translated">在本文中，我们讨论了在Apache Airflow中设计Dag时的两个最重要的原则:<strong class="ll je">原子性</strong>和<strong class="ll je">幂等性</strong>。</p><p id="a088" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">记住这些概念使我们能够<strong class="ll je">创建更好的工作流</strong>，这些工作流是可恢复的、可重新运行的、容错的、一致的、可维护的、透明的，并且更容易理解。</p><p id="5ad2" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">然而，在编码和创建下一个工作流时，有更多的<a class="ae li" href="https://www.astronomer.io/guides/dag-best-practices/" rel="noopener ugc nofollow" target="_blank">最佳实践</a>需要遵循和考虑。</p><p id="aad2" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">但这是改天的话题…</p><div class="oh oi gq gs oj ok"><a rel="noopener follow" target="_blank" href="/setting-up-apache-airflow-with-docker-compose-in-5-minutes-56a1110f4122"><div class="ol ab fp"><div class="om ab on cl cj oo"><h2 class="bd je gz z fq op fs ft oq fv fx jd bi translated">用Docker-Compose在5分钟内设置Apache气流</h2><div class="or l"><h3 class="bd b gz z fq op fs ft oq fv fx dk translated">创建一个开发环境并开始构建Dag</h3></div><div class="os l"><p class="bd b dl z fq op fs ft oq fv fx dk translated">towardsdatascience.com</p></div></div><div class="ot l"><div class="ou l ov ow ox ot oy lc ok"/></div></div></a></div></div><div class="ab cl mf mg hy mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="in io ip iq ir"><p id="fb48" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated"><em class="oz">喜欢这篇文章吗？成为</em> <a class="ae li" href="https://medium.com/@marvinlanhenke/membership" rel="noopener"> <em class="oz">中等会员</em> </a> <em class="oz">继续无限学习。如果你使用下面的链接，我会收到你的一部分会员费，不需要你额外付费。</em></p><div class="oh oi gq gs oj ok"><a href="https://medium.com/@marvinlanhenke/membership" rel="noopener follow" target="_blank"><div class="ol ab fp"><div class="om ab on cl cj oo"><h2 class="bd je gz z fq op fs ft oq fv fx jd bi translated">通过我的推荐链接加入Medium—Marvin Lanhenke</h2><div class="or l"><h3 class="bd b gz z fq op fs ft oq fv fx dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="os l"><p class="bd b dl z fq op fs ft oq fv fx dk translated">medium.com</p></div></div><div class="ot l"><div class="pa l ov ow ox ot oy lc ok"/></div></div></a></div><p id="9a47" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated"><strong class="ll je">参考资料/更多资料:</strong></p><ul class=""><li id="5894" class="pb pc iu ll b lm ln lp lq ls pd lw pe ma pf me pg ph pi pj bi translated">[1]<a class="ae li" href="https://en.wikipedia.org/wiki/Atomicity_(database_systems)" rel="noopener ugc nofollow" target="_blank">https://en . Wikipedia . org/wiki/Atomicity _(database _ systems)</a></li><li id="51c5" class="pb pc iu ll b lm pk lp pl ls pm lw pn ma po me pg ph pi pj bi translated"><a class="ae li" href="https://www.webopedia.com/definitions/atomic-operation/" rel="noopener ugc nofollow" target="_blank">https://www.webopedia.com/definitions/atomic-operation/</a></li><li id="718a" class="pb pc iu ll b lm pk lp pl ls pm lw pn ma po me pg ph pi pj bi translated"><a class="ae li" href="https://en.wikipedia.org/wiki/Idempotence" rel="noopener ugc nofollow" target="_blank">https://en.wikipedia.org/wiki/Idempotence</a></li><li id="c30d" class="pb pc iu ll b lm pk lp pl ls pm lw pn ma po me pg ph pi pj bi translated"><a class="ae li" href="https://en.wikipedia.org/wiki/ACID" rel="noopener ugc nofollow" target="_blank">https://en.wikipedia.org/wiki/ACID</a></li><li id="ef9d" class="pb pc iu ll b lm pk lp pl ls pm lw pn ma po me pg ph pi pj bi translated"><a class="ae li" href="https://en.wikipedia.org/wiki/Single-responsibility_principle" rel="noopener ugc nofollow" target="_blank">https://en . Wikipedia . org/wiki/Single-respons ibility _ principal</a></li><li id="89e5" class="pb pc iu ll b lm pk lp pl ls pm lw pn ma po me pg ph pi pj bi translated"><a class="ae li" href="https://www.astronomer.io/guides/dag-best-practices/" rel="noopener ugc nofollow" target="_blank">https://www.astronomer.io/guides/dag-best-practices/</a></li><li id="c221" class="pb pc iu ll b lm pk lp pl ls pm lw pn ma po me pg ph pi pj bi translated">朱利安.德.鲁特.巴斯.哈伦斯克。阿帕奇气流的数据管道。纽约:曼宁，2021。</li></ul></div></div>    
</body>
</html>