<html>
<head>
<title>Secure Your Public Docker Images</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">保护您的公共 Docker 图像</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/secure-your-public-docker-images-6758f7ddb687#2022-02-18">https://towardsdatascience.com/secure-your-public-docker-images-6758f7ddb687#2022-02-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8397" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如果计算机病毒应该算作生命，那么我们已经按照自己的形象创造了生命。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a110e93d741b8311e5200e8325130a70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zf_aTfDQ8l3hvJS7"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@ventiviews?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">通风视图</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="e779" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您刚刚完成了新的闪亮工具的实现，并准备将其打包到 Docker 容器中，并将其推送到公共存储库中供他人查找。你会怎么做？好吧，如果你的大脑说执行<code class="fe lv lw lx ly b">docker push</code>命令，那你就错了！</p><p id="3b49" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你如何公证你的身份和你的 docker 图片的完整性？谁能证明他们下载的图片是你的呢？为什么有人要相信你？</p><p id="d29c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当把你的图片推送到一个注册中心，比如 Docker Hub，你的信息会通过一个不可信的媒介:互联网。因此，以某种方式验证 Docker 映像的完整性是至关重要的。</p><p id="2931" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Docker 内容信任(DCT)使您能够验证您正在使用的图像的完整性以及该图像发布者的完整性。因此，DCT 充当反欺骗控制。</p><div class="lz ma gp gr mb mc"><a href="https://medium.com/geekculture/the-docker-attack-surface-5184a36a23ca" rel="noopener follow" target="_blank"><div class="md ab fo"><div class="me ab mf cl cj mg"><h2 class="bd iu gy z fp mh fr fs mi fu fw is bi translated">码头工人攻击面</h2><div class="mj l"><h3 class="bd b gy z fp mh fr fs mi fu fw dk translated">什么会出错？</h3></div><div class="mk l"><p class="bd b dl z fp mh fr fs mi fu fw dk translated">medium.com</p></div></div><div class="ml l"><div class="mm l mn mo mp ml mq ks mc"/></div></div></a></div><blockquote class="mr ms mt"><p id="fd57" class="kz la mu lb b lc ld ju le lf lg jx lh mv lj lk ll mw ln lo lp mx lr ls lt lu im bi translated"><a class="ae ky" href="https://www.dimpo.me/newsletter?utm_source=medium&amp;utm_medium=article&amp;utm_campaign=docker-notary" rel="noopener ugc nofollow" target="_blank">学习率</a>是为那些对 AI 和 MLOps 的世界感到好奇的人准备的时事通讯。你会在每个月的第一个星期六收到我关于最新人工智能新闻和文章的更新和想法。在这里订阅<a class="ae ky" href="https://www.dimpo.me/newsletter?utm_source=medium&amp;utm_medium=article&amp;utm_campaign=docker-notary" rel="noopener ugc nofollow" target="_blank"/>！</p></blockquote></div><div class="ab cl my mz hx na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="im in io ip iq"><h1 id="dcf8" class="nf ng it bd nh ni nj nk nl nm nn no np jz nq ka nr kc ns kd nt kf nu kg nv nw bi translated">Docker 公证服务器</h1><p id="59f8" class="pw-post-body-paragraph kz la it lb b lc nx ju le lf ny jx lh li nz lk ll lm oa lo lp lq ob ls lt lu im bi translated">DCT 的第一个组件是 Docker 公证服务器。这个组件就像一个人类公证人，一个被授权在法律事务中执行行为的独立的人。在我们的案例中，Docker 图像就像一个需要公证的法律文件。</p><p id="6e42" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为此，您应该获得一个签名密钥，并将其委托给公证服务器来实施图像签名。让我们先把理论搞清楚，看看如何准确地公证任何 Docker 图像。</p><h2 id="b3c8" class="oc ng it bd nh od oe dn nl of og dp np li oh oi nr lm oj ok nt lq ol om nv on bi translated">用 DCT 签名图像</h2><p id="479d" class="pw-post-body-paragraph kz la it lb b lc nx ju le lf ny jx lh li nz lk ll lm oa lo lp lq ob ls lt lu im bi translated">要在 Docker Hub 上推送 Docker 图像之前对其进行签名，您需要部署您的公证服务器并获得签名密钥。</p><p id="f885" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，您可以使用两种方法获得签名密钥:</p><ul class=""><li id="91c4" class="oo op it lb b lc ld lf lg li oq lm or lq os lu ot ou ov ow bi translated">使用命令<code class="fe lv lw lx ly b">docker trust key generate NAME</code>生成它</li><li id="af13" class="oo op it lb b lc ox lf oy li oz lm pa lq pb lu ot ou ov ow bi translated">从证书颁发机构(CA)获取它</li></ul><p id="aeff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦您有了签名密钥，我们需要部署公证服务器。Docker 公司提供了 Docker 公证服务器，您可以使用<code class="fe lv lw lx ly b">docker-compose</code>快速部署它。</p><p id="0abe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们需要将密钥委托给 Docker 公证服务器来签署图像。在这一步中，您需要将公钥和私钥都添加到公证服务器。</p><p id="f8c3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们需要强制客户端使用 DCT。这意味着当您通过 Docker CLI 使用<code class="fe lv lw lx ly b">push</code>和<code class="fe lv lw lx ly b">pull</code>命令时，您只能从注册表中推送和提取已经使用 DCT 签名的映像。</p><h2 id="aff6" class="oc ng it bd nh od oe dn nl of og dp np li oh oi nr lm oj ok nt lq ol om nv on bi translated">例子</h2><p id="8799" class="pw-post-body-paragraph kz la it lb b lc nx ju le lf ny jx lh li nz lk ll lm oa lo lp lq ob ls lt lu im bi translated">在本演示中，您将设置 DCT 公证服务器，生成签名密钥，并在将 Docker 映像推送到 Docker Hub 之前对其进行签名。让我们首先生成签名密钥。要获取密钥，请运行以下命令:</p><pre class="kj kk kl km gt pc ly pd pe aw pf bi"><span id="1252" class="oc ng it ly b gy pg ph l pi pj">docker trust key generate NAME — dir ~/.docker/trust</span></pre><p id="3763" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">NAME</code>变量可以是你想要的任何东西。这个我会用<code class="fe lv lw lx ly b">medium_demo</code>。因此，该命令变成了:</p><pre class="kj kk kl km gt pc ly pd pe aw pf bi"><span id="6400" class="oc ng it ly b gy pg ph l pi pj">docker trust key generate medium_demo — dir ~/.docker/trust </span></pre><p id="a5d9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果<code class="fe lv lw lx ly b">~/.docker/trust</code>路径不存在，您可以通过从您的<code class="fe lv lw lx ly b">/home</code>目录运行以下命令来创建它:</p><pre class="kj kk kl km gt pc ly pd pe aw pf bi"><span id="dbf4" class="oc ng it ly b gy pg ph l pi pj">mkdir -p .docker/trust</span></pre><p id="bea0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">CLI 将要求您提供密码。你想用什么就用什么，但要确保你会记住它。如果一切顺利，您应该会看到以下消息:</p><pre class="kj kk kl km gt pc ly pd pe aw pf bi"><span id="1926" class="oc ng it ly b gy pg ph l pi pj">Successfully generated and loaded private key. Corresponding public key available: /home/vagrant/.docker/trust/medium_demo.pub</span></pre><p id="4df7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，您将打开公证服务器。为此，您需要克隆公证服务器 repo:</p><pre class="kj kk kl km gt pc ly pd pe aw pf bi"><span id="0585" class="oc ng it ly b gy pg ph l pi pj">git clone <a class="ae ky" href="https://github.com/theupdateframework/notary.git" rel="noopener ugc nofollow" target="_blank">https://github.com/theupdateframework/notary.git</a></span></pre><p id="30cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Docker 公证人服务器是一个容器化的应用程序，您可以使用<code class="fe lv lw lx ly b">docker-compose</code>来部署它。将您的工作目录更改为您克隆的<code class="fe lv lw lx ly b">notary</code>目录，并运行以下命令:</p><pre class="kj kk kl km gt pc ly pd pe aw pf bi"><span id="a93c" class="oc ng it ly b gy pg ph l pi pj">docker-compose up -d</span></pre><p id="bd7f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您的系统中没有安装“docker-compose ”,请按照<a class="ae ky" href="https://docs.docker.com/compose/install/#install-compose-on-linux-systems" rel="noopener ugc nofollow" target="_blank">文档</a>中的说明进行安装。</p><p id="5439" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，您将添加在本示例开始时生成的密钥。为此，您需要运行以下命令:</p><pre class="kj kk kl km gt pc ly pd pe aw pf bi"><span id="7d50" class="oc ng it ly b gy pg ph l pi pj">docker trust signer add — key PATH NAME ACCOUNT/REPO</span></pre><p id="2b5c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们分解这个命令:</p><p id="051a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">- <code class="fe lv lw lx ly b">PATH</code>:存储签名密钥的目录。<br/> - <code class="fe lv lw lx ly b">NAME</code>:签名密钥名称<br/> - <code class="fe lv lw lx ly b">ACCOUNT</code>:您的 Docker Hub 账户名称<br/> - <code class="fe lv lw lx ly b">REPO</code>:您的 Docker Hub repo</p><p id="893c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我的例子中，命令应该是:</p><pre class="kj kk kl km gt pc ly pd pe aw pf bi"><span id="2cef" class="oc ng it ly b gy pg ph l pi pj">docker trust signer add — key ~/.docker/trust/medium_demo.pub medium_demo dpoulopoulos/ubuntu-hardened</span></pre><p id="60e3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为新的根密钥和存储库密钥提供密码后，您应该会看到以下结果:</p><pre class="kj kk kl km gt pc ly pd pe aw pf bi"><span id="63e9" class="oc ng it ly b gy pg ph l pi pj">Successfully initialized “dpoulopoulos/ubuntu-hardened”<br/>Successfully added signer: medium_demo to dpoulopoulos/ubuntu-hardened</span></pre><p id="2cc2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，您需要使用以下命令确保内容信任服务器指向公证服务器:</p><pre class="kj kk kl km gt pc ly pd pe aw pf bi"><span id="32f7" class="oc ng it ly b gy pg ph l pi pj">export DOCKER_CONTENT_TRUST_SERVER=<a class="ae ky" href="https://notary.docker.io" rel="noopener ugc nofollow" target="_blank">https://notary.docker.io</a></span></pre><p id="74c3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在准备签署一个图像，并将其推送到 Docker Hub。所以，首先，让我们得到一个图像。为此，您将使用官方的 Ubuntu 映像:</p><pre class="kj kk kl km gt pc ly pd pe aw pf bi"><span id="520a" class="oc ng it ly b gy pg ph l pi pj">docker pull ubuntu</span></pre><p id="a57c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，相应地标记图像。对我来说，这是:</p><pre class="kj kk kl km gt pc ly pd pe aw pf bi"><span id="5787" class="oc ng it ly b gy pg ph l pi pj">docker tag ubuntu:latest dpoulopoulos/ubuntu-hardened:v1.0.0</span></pre><p id="b0f3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通常，您应该遵循以下格式:</p><pre class="kj kk kl km gt pc ly pd pe aw pf bi"><span id="c0ed" class="oc ng it ly b gy pg ph l pi pj">docker tag ubuntu:latest ACCOUNT/REPO:TAG</span></pre><p id="eba9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">ACCOUNT</code>和<code class="fe lv lw lx ly b">REPO</code>变量应该与您之前使用的相同。<code class="fe lv lw lx ly b">TAG</code>可以是你想要的任何东西，但是你必须指定一个。</p><p id="0ae8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，在我的例子中，为了对图像进行签名，我需要运行以下命令:</p><pre class="kj kk kl km gt pc ly pd pe aw pf bi"><span id="2500" class="oc ng it ly b gy pg ph l pi pj">docker trust sign dpoulopoulos/ubuntu-hardened:v1.0.0</span></pre><p id="c43d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，当我们推进和推送映像时，您需要在 Docker 守护进程上对所有映像操作强制使用 DCT。对于第一次运行:</p><pre class="kj kk kl km gt pc ly pd pe aw pf bi"><span id="e8b9" class="oc ng it ly b gy pg ph l pi pj">export DOCKER_CONTENT_TRUST=1</span></pre><p id="b6a7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对我来说，推动这个形象:</p><pre class="kj kk kl km gt pc ly pd pe aw pf bi"><span id="24d2" class="oc ng it ly b gy pg ph l pi pj">docker push dpoulopoulos/ubuntu-hardened:v1.0.0</span></pre><p id="5756" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">恭喜您，您已经通过本地公证服务器签署了您的 Docker 图像，并将其推送到 Docker Hub！如果您想要检查图像中的 DCT 设置，您可以运行:</p><pre class="kj kk kl km gt pc ly pd pe aw pf bi"><span id="451c" class="oc ng it ly b gy pg ph l pi pj">docker trust inspect — pretty ACCOUNT/REPO:TAG</span></pre><h1 id="2313" class="nf ng it bd nh ni pk nk nl nm pl no np jz pm ka nr kc pn kd nt kf po kg nv nw bi translated">结论</h1><p id="ec76" class="pw-post-body-paragraph kz la it lb b lc nx ju le lf ny jx lh li nz lk ll lm oa lo lp lq ob ls lt lu im bi translated">保护您的公共 Docker 映像是一项简单的任务，如果您要将这些映像投入生产，这也是一项必要的任务。当然，当您进入生产阶段时，您会希望从 CA 获得您的签名密钥，但是在此之后，过程仍然是相同的。</p><p id="7cd0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">看起来可能涉及到很多步骤，但是大多数步骤只需执行一次。因此，没有什么可以阻止你签署你的图像，并告诉你的用户，他们可以信任你！</p><h1 id="7da9" class="nf ng it bd nh ni pk nk nl nm pl no np jz pm ka nr kc pn kd nt kf po kg nv nw bi translated">关于作者</h1><p id="19c1" class="pw-post-body-paragraph kz la it lb b lc nx ju le lf ny jx lh li nz lk ll lm oa lo lp lq ob ls lt lu im bi translated">我的名字是<a class="ae ky" href="https://www.dimpo.me/?utm_source=medium&amp;utm_medium=article&amp;utm_campaign=docker-notary" rel="noopener ugc nofollow" target="_blank">迪米特里斯·波罗普洛斯</a>，我是一名为<a class="ae ky" href="https://www.arrikto.com/" rel="noopener ugc nofollow" target="_blank">阿里克托</a>工作的机器学习工程师。我曾为欧洲委员会、欧盟统计局、国际货币基金组织、欧洲央行、经合组织和宜家等主要客户设计和实施过人工智能和软件解决方案。</p><p id="62b5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你有兴趣阅读更多关于机器学习、深度学习、数据科学和数据操作的帖子，请关注我的<a class="ae ky" href="https://towardsdatascience.com/medium.com/@dpoulopoulos/follow" rel="noopener" target="_blank"> Medium </a>、<a class="ae ky" href="https://www.linkedin.com/in/dpoulopoulos/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>或 Twitter 上的<a class="ae ky" href="https://twitter.com/james2pl" rel="noopener ugc nofollow" target="_blank"> @james2pl </a>。</p><p id="dcde" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所表达的观点仅代表我个人，并不代表我的雇主的观点或意见。</p></div></div>    
</body>
</html>