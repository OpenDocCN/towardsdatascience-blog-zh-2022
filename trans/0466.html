<html>
<head>
<title>Forward and Backward propagation in Convolutional Neural Networks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">卷积神经网络中的前向和后向传播</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/forward-and-backward-propagation-in-convolutional-neural-networks-64365925fdfa#2022-02-18">https://towardsdatascience.com/forward-and-backward-propagation-in-convolutional-neural-networks-64365925fdfa#2022-02-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1377" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">理论与代码</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/632362ca5ce79e42bd9a69a5b3337a44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JSEqnz1i_YEMQAlh"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@fabioha" rel="noopener ugc nofollow" target="_blank">https://unsplash.com/@fabioha</a></p></figure><h2 id="454a" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">介绍</h2><p id="2b6e" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated">如果你在这里，你一定听说过卷积神经网络，也许你现在正试图了解它们是如何工作的。在这种情况下，本文将通过使用一些可视化的例子来帮助您了解 CNN 中的向前和向后传球是如何执行的。<br/>我假设你熟悉 CNN 中的填充和步长，并且对反向传播和链式法则有一些基本的了解。</p><h2 id="9616" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">正向传播</h2><p id="9a35" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated">我们从形状为<strong class="lu ir"> 5x5 </strong>的<strong class="lu ir">一个输入</strong>和形状为<strong class="lu ir"> 3x3 </strong>的<strong class="lu ir">一个滤波器</strong>开始。我们假设通道数<strong class="lu ir"> C = 1 </strong>，<strong class="lu ir"> stride = 1 </strong>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/72d4ee34b415187bfaf122c95ca3a89e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1274/format:webp/1*qAzegtFfpWudbmKqUY4QUw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">按作者分类的图像—输入和过滤器权重(图 1)</p></figure><p id="cf17" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">我们用<strong class="lu ir"> pad = 1 </strong>进行填充，使卷积运算后的输出和输入的形状相同。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/2e678650e61f563204128c6d09bac35a.png" data-original-src="https://miro.medium.com/v2/resize:fit:856/format:webp/1*BwdSf-1TKg_25xcGsAxppA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">按作者分类的图像—填充输入(图 2)</p></figure><p id="4075" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">实际上，我们可以使用下面的公式来计算<strong class="lu ir">输出形状</strong>:<br/><em class="ms">H _ out = floor(1+(H+2 * pad-HH)/stride)<br/>W _ out = floor(1+(W+2 * pad-WW)/stride)</em><br/>其中<em class="ms"> H </em>是输入的高度，<em class="ms"> HH </em>是滤波器的高度<br/> <em class="ms"> W </em>是输入的宽度</p><p id="6c18" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">在我们的例子中我们得到:<br/><em class="ms">H _ out</em>= floor(1+(5+2 * 1–3)/1)= 5<br/><em class="ms">W _ out</em>= floor(1+(5+2 * 1–3)/1)= 5</p><p id="b1e8" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">卷积运算中的前向传递由输入上的重叠滤波器权重组成，将它们相乘并将结果相加以获得输出。下面的动画显示了对<em class="ms"> y </em> ₁₁、<em class="ms">y</em>₁₂<em class="ms">t44】和<em class="ms"> y </em> ₅₅的计算(类似地，其他输出<em class="ms">yᵢ</em>ⱼ<em class="ms">T50】也被计算)</em></em></p><div class="kg kh ki kj gt ab cb"><figure class="mt kk mu mv mw mx my paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/46f86c3b97516593438b4e6500a0348a.png" data-original-src="https://miro.medium.com/v2/resize:fit:964/1*oWhjjHgmmuxljoql06PXpg.gif"/></div></figure><figure class="mt kk mz mv mw mx my paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/6ddb9b3bba003754dca7bf5893487f39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1038/1*lMtkB9FpMaINPUS_zLairA.gif"/></div><p class="kr ks gj gh gi kt ku bd b be z dk na di nb nc translated">作者提供的图像—正向卷积运算(图 3)</p></figure></div><p id="ba2f" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">在代码中:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nd ne l"/></div></figure><h2 id="b7aa" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">反向传播</h2><p id="397f" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated">我们需要计算输出 Y 相对于输入 X、滤波器 W 和偏置 b 的导数，计算相对于偏置 b 的导数很容易，我建议您在阅读完本教程后亲自尝试一下，您一定能够做到！现在让我们最后从<strong class="lu ir">∂<em class="ms">y/</em></strong><em class="ms"/><strong class="lu ir">∂<em class="ms">x</em></strong>开始:</p><p id="dc23" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">让我们先看看输出 y 对 x 的第一个元素的导数是什么，也就是说，我们要计算<em class="ms"> ∂Y/ ∂x₁₁ </em>。我们可以注意到 x₁₁影响了<em class="ms"> y </em> ₁₁ <em class="ms">，y </em> ₁₂ <em class="ms">，y</em>₂₁<em class="ms">T9】和<em class="ms"> y </em> ₂₂，因为它参与了这些输出单元格的计算。于是我们得到<br/><em class="ms"/>∂<em class="ms">y/</em>∂<em class="ms">x</em>₁₁<em class="ms">=</em>∂<em class="ms">y</em>₁₁<em class="ms">/</em>∂<em class="ms">x</em>₁₁<em class="ms">+</em>∂<em class="ms">y</em><em class="ms">/</em>∩<em class="ms">x【t34 </em>∂<em class="ms">x</em>₁₁<em class="ms">= w</em>₂₂<em class="ms">+w</em>₂₁<em class="ms">+w</em>₁₂<em class="ms">+w</em>₁₁<br/>以类似的方式我们可以计算 x 的元素的其他偏导数</em></p><blockquote class="nf ng nh"><p id="2ac5" class="ls lt ms lu b lv mm jr lx ly mn ju ma ni mo mc md nj mp mf mg nk mq mi mj mk ij bi translated">还要注意，∂X 的形状与<strong class="lu ir">未填充的</strong> X 的形状相同，所以我们不需要计算关于填充元素的导数</p></blockquote><div class="kg kh ki kj gt ab cb"><figure class="mt kk nl mv mw mx my paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/272566fd4638fef552f3e50c18f92228.png" data-original-src="https://miro.medium.com/v2/resize:fit:978/format:webp/1*Wx2WhCywE9l9pU0z2FPwNA.png"/></div></figure><figure class="mt kk nm mv mw mx my paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/2b9d13b70c3936f563dc17359811c404.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*c5rrDNiaOfgHJKfqZ4amhQ.png"/></div></figure></div><div class="ab cb"><figure class="mt kk nn mv mw mx my paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/ecdf5d3f420dc4e2951f812094c74407.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/format:webp/1*wIPy-13NsqggP9CPyeaJ-w.png"/></div></figure><figure class="mt kk no mv mw mx my paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/9389d4290d44f6379c99a7fb6aff02e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*UJ79CsPNPa1DHornQkUoKg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk np di nq nc translated">来自作者的图像-输入反向传播(图 4)</p></figure></div><p id="42a6" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">还有更多的内容。当进行反向传播时，当我们按照链式法则进行反向传播时，我们通常有来自下一层的输入梯度。在这种情况下，我们假设卷积层之后是，我们将得到 y 相对于损耗 l，∂L/∂Y.的入射梯度，它与 y 的形状相同，这是我们唯一需要知道的，因为我们不会在本文中计算这一导数。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/61e992b019a6a8f4f512d176de6da5a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:526/format:webp/1*SMhILamx1hBaAccTO0e4GA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片— ∂L/∂Y 衍生矩阵(图 5)</p></figure><p id="9d3a" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">因此，当计算∂Y/∂x11 时，我们还需要将∂Y/∂x 乘以相应的引入导数∂l/∂y:<br/>(1)∂<em class="ms">y/</em>∂<em class="ms">x</em>₁₁<em class="ms">=</em>∂<em class="ms">l/</em>∂<em class="ms">y</em>t73】*≈<em class="ms">y</em> ∂<em class="ms">x</em>₁₁<em class="ms">+</em>∂<em class="ms">l/</em>∂<em class="ms">y</em>₂₁<em class="ms">*</em>∂<em class="ms">y</em>₂₁<em class="ms">/</em>∂<em class="ms">x</em>⃈<em class="ms">+</em>∂<em class="ms">l/</em> w₂₁<em class="ms">+dy</em>₂₁<em class="ms">* w</em>₁₂<em class="ms">+dy</em>₂₂<em class="ms">* w</em>₁₁</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="2d45" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">如果我们在通过所有宽度(<em class="ms"> W1 </em>)和高度(<em class="ms"> H1 </em>)的第一次循环后打印出<em class="ms"> w_idxs </em>和<em class="ms"> y_idxs </em>，我们将得到 w 和∂L/∂Y 矩阵的相应单元格，以计算∂ <em class="ms"> Y/ </em> ∂ <em class="ms"> x </em> ₁₁:</p><pre class="kg kh ki kj gt ns nt nu nv aw nw bi"><span id="ce86" class="kw kx iq nt b gy nx ny l nz oa">w_idxs = [(1, 1), (1, 0), (0, 1), (0, 0)]<br/>y_idxs = [(0, 0), (0, 1), (1, 0), (1, 1)]</span></pre><p id="e70c" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">在<em class="ms">图 4 </em>中，我们从 1 开始索引，因此如果我们将 1 加到<em class="ms"> w_idxs </em>和<em class="ms"> y_idxs </em>中，我们会看到，在最后一行中，为了获得关于 x，dx₁₁的第一个元素的导数，我们将与上面公式中完全相同的元素相乘。</p><p id="a5bf" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">为了计算<strong class="lu ir"> <em class="ms"> ∂Y/ ∂W </em> </strong>，我们以类似的方式进行(注意，为了避免图像过多，我们没有显示所有的操作):</p><div class="kg kh ki kj gt ab cb"><figure class="mt kk ob mv mw mx my paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/92d5c7080c97bfba41102ce695b6e647.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/format:webp/1*oAZKRskwmPw95CNZe3xRtA.png"/></div></figure><figure class="mt kk oc mv mw mx my paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/a32e32c0beaad016291c79c394b3ce57.png" data-original-src="https://miro.medium.com/v2/resize:fit:672/format:webp/1*i_XywWVthXxRVwXITOqoUQ.png"/></div></figure><figure class="mt kk od mv mw mx my paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/192f870a7c8fce2cebd03f327e263de0.png" data-original-src="https://miro.medium.com/v2/resize:fit:692/format:webp/1*_z3JDvhY2GvTSBRH5bRECA.png"/></div></figure></div><div class="ab cb"><figure class="mt kk oe mv mw mx my paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/b708a857564cd9bde3a9957fb31765b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*bonkaviSYn1AOOZEywCDjQ.png"/></div></figure><figure class="mt kk of mv mw mx my paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/f0e7f81a5c95e2b9a17b4257b217bab1.png" data-original-src="https://miro.medium.com/v2/resize:fit:664/format:webp/1*72E9Y3MIIwS5BihpWW_g2A.png"/></div></figure><figure class="mt kk og mv mw mx my paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/6fb33cac556050b356b9aebeb4777935.png" data-original-src="https://miro.medium.com/v2/resize:fit:670/format:webp/1*MpG74E91RhGlC7Zxy_AwLA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk oh di oi nc translated">作者图片—权重反向传播(图 6)</p></figure></div><p id="7531" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">查看<em class="ms"> dY/dw </em> ₁₁ <em class="ms">，</em>我们可以看到<em class="ms">w</em>₁₁<em class="ms">t29】的变化会影响<strong class="lu ir">所有<em class="ms"> yᵢ </em> ⱼ </strong>的每一个<em class="ms"> i，j </em>。现在，我们需要考虑 X_padded，而不是从 1 到 5 进行索引，X_padded 将从 0 到 6 进行索引。</em></p><p id="f119" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">(2)∂<em class="ms">y/</em>∂<em class="ms">w</em>₁₁<em class="ms">=</em>∂<em class="ms">l/</em>∂<em class="ms">y</em>₁₁<em class="ms">*</em>∂<em class="ms">y</em>₁₁<em class="ms">/</em>∩<em class="ms">w</em>≿<em class="ms">+</em>∩<em class="ms">l </em>∂<em class="ms">y</em>₄₅<em class="ms">*</em>∂<em class="ms">y</em>₄₅<em class="ms">/</em>∂<em class="ms">w</em>₁₁<em class="ms">+</em>∂<em class="ms">l/</em>∂<em class="ms">y</em>t89】*∂<em class="ms">y<em class="ms"/></em></p><p id="4578" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">正如我们可以看到的，因为每一个权重影响每一个输出所有元素传入的导数∂ <em class="ms"> L/ </em> ∂ <em class="ms"> Y </em>被用来计算∂<em class="ms">y/</em>∂<em class="ms">w</em>ᵢⱼ</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="c567" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">如果我们查看被求和以计算<em class="ms"> dw[0，0] </em>(忽略滤波器和通道):<br/>给定<em class="ms"> padded_x </em>:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/639f4834bc3d4c7392ff96cbe2584c58.png" data-original-src="https://miro.medium.com/v2/resize:fit:726/format:webp/1*na2LIszc6jfzXiyhQsCM_w.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片—填充输入具体示例(图 7)</p></figure><p id="a265" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">和<em class="ms"> dout </em>导数:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/aefe3fe285fa9b63f633003d37329218.png" data-original-src="https://miro.medium.com/v2/resize:fit:624/format:webp/1*3MlNpK2S01W0PzEeSdc1og.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片由作者—∂L/∂Y 具体举例(图 8)</p></figure><p id="89d4" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">我们将从<em class="ms"> padded_x </em>从<em class="ms"> x₀₀ </em>到<em class="ms"> x₄₄ </em>中选择的元素相乘</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/d16369510d36dea275f282179b516e6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1172/format:webp/1*YnZ-9JgWTFhCidP0vXPsbw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">按作者分类的图像—选定的填充输入(图 9)</p></figure><p id="545b" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">用<em class="ms">的所有元素对</em>进行 dout，然后像(2)中那样对所有元素求和:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi om"><img src="../Images/2678440a50315bc251d3341f965c09c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FUhLWzN0f9BIVUnQYOOuDQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者提供的图片—渐变结果 W 矩阵的第一个元素(图 10)</p></figure><p id="ed7a" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">请注意，我们已经看到了假设 1 个通道和 1 个滤波器的向前和向后传递，但是代码能够处理多个通道和滤波器，并且到目前为止您已经阅读的解释很容易推广。</p><h2 id="c0de" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">结论</h2><p id="717b" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated">你现在应该很好的理解了在 CNN 中向后和向前传球是如何完成的。显然，你不需要手动实现它们——在上面的代码片段中，我们使用的循环很容易理解，但是非常慢而且效率很低！不过不要担心，有很多包可以使用非常高效的实现为您完成所有工作。</p><h2 id="cc20" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">参考</h2><p id="707f" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated"><a class="ae kv" href="http://cs231n.stanford.edu/" rel="noopener ugc nofollow" target="_blank">http://cs231n.stanford.edu/</a></p></div></div>    
</body>
</html>