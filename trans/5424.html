<html>
<head>
<title>How to Test PySpark ETL Data Pipeline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何测试 PySpark ETL 数据管道</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-test-pyspark-etl-data-pipeline-1c5a6ab6a04b#2022-12-06">https://towardsdatascience.com/how-to-test-pyspark-etl-data-pipeline-1c5a6ab6a04b#2022-12-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a240" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">满怀期望地验证大数据管道</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/da07b2f8e320f320c07a98345e69d3b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SuPZ_e0cRFflEL0B"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae ky" href="https://unsplash.com/@er1end?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Erlend Ekseth </a>拍摄的照片</p></figure><h1 id="5ee4" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">介绍</h1><p id="c7db" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">Garbage in garbage out 是一个常用的表达方式，用于强调数据质量对于机器学习、数据分析和商业智能等任务的重要性。随着创建和存储的数据量不断增加，构建高质量的数据管道变得前所未有的具有挑战性。</p><p id="9284" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">PySpark 是为大型数据集构建 ETL 管道的常用工具。构建数据管道时出现的一个常见问题是“我们如何知道我们的数据管道正在以预期的方式转换数据？”。为了回答这个问题，我们从软件开发范例中借用了单元测试的思想。单元测试的目的是通过使用测试来检查输出是否符合预期，从而验证代码的每个组件是否按预期执行。以类似的方式，我们可以通过编写一个测试来检查输出数据，从而验证我们的数据管道是否如预期的那样工作。</p><h1 id="2318" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">例子</h1><p id="aba5" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在本节中，我们将通过一个例子来说明如何利用 Great Expectation 来验证您的 PySpark 数据管道。</p><h1 id="46c3" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">设置</h1><p id="f901" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">此示例使用以下设置:</p><ol class=""><li id="0b20" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm mx my mz na bi translated">PySpark</li><li id="1007" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">远大前程==0.15.34</li><li id="937e" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">数据砖笔记本</li></ol><p id="d3eb" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们将在 Databricks 社区版中使用 Databricks 笔记本。但是，您可以自由使用任何集成开发环境和云或本地 spark 集群。</p><h1 id="3842" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">数据</h1><p id="b654" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们使用的是 UCI 银行营销数据集[2]，其中包含一家葡萄牙银行的直接营销活动信息。这是数据的样子。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/8756a4fa099062a4a1d903def8ace791.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JD2AnGvR50uKGq3w"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片作者。</p></figure><p id="6d62" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">理解数据对于为 PySpark 数据管道创建全面的测试至关重要。数据质量方面的常见考虑因素包括但不限于:</p><ul class=""><li id="df37" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm nh my mz na bi translated">完全</li><li id="585e" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm nh my mz na bi translated">一致性</li><li id="ca70" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm nh my mz na bi translated">正确性</li><li id="c9b9" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm nh my mz na bi translated">独特性</li></ul><p id="9006" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">上述每一项的可接受质量在很大程度上取决于上下文和用例。</p><h1 id="78ec" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">创造期望</h1><p id="b612" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在本节中，我们探索并创建预期，这些预期将在后面的部分中用于测试新的未知数据。</p><p id="e32b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">那么什么是期望呢？期望是对数据的断言。顾名思义，我们正在验证数据是否是我们所期望的。对常见数据质量检查的<a class="ae ky" href="https://greatexpectations.io/expectations/" rel="noopener ugc nofollow" target="_blank">预定义期望</a>带来了巨大的期望。下面是一些预定义期望的例子。</p><pre class="kj kk kl km gt ni nj nk bn nl nm bi"><span id="be5c" class="nn la it nj b be no np l nq nr">expect_column_values_to_be_not_null<br/>expect_column_values_tpytho_be_unique<br/>expect_column_values_to_match_regex<br/>expect_column_median_to_be_between<br/>expect_table_row_count_to_be_between</span></pre><p id="d24f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这些期望的名字很好地描述了期望的表现。如果预定义的期望不符合您的需求，远大期望还允许您创建<a class="ae ky" href="https://docs.greatexpectations.io/docs/guides/expectations/creating_custom_expectations" rel="noopener ugc nofollow" target="_blank">自定义期望</a>。</p><p id="7b91" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu">进口</strong></p><pre class="kj kk kl km gt ni nj nk bn nl nm bi"><span id="b872" class="nn la it nj b be no np l ns nr">import great_expectations as ge<br/>from great_expectations.dataset.sparkdf_dataset import SparkDFDataset<br/>from pyspark.sql import functions as f, Window<br/>import json</span></pre><p id="8e53" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu">加载数据</strong></p><p id="8496" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们从 csv 文件加载数据，并对数据集执行一些处理步骤:</p><ul class=""><li id="e789" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm nh my mz na bi translated">将<code class="fe nt nu nv nj b">job</code>栏中的“未知”值更改为“空”</li><li id="e977" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm nh my mz na bi translated">创建一个“id”列，其中包含每行的唯一标识符</li></ul><pre class="kj kk kl km gt ni nj nk bn nl nm bi"><span id="a387" class="nn la it nj b be no np l ns nr">df = \\<br/>  spark\\<br/>  .read\\<br/>  .format('csv')\\<br/>  .option('header', True)\\<br/>  .load('/FileStore/tables/bank_full.csv', sep = ';')\\<br/>  .withColumn('job', f.when(f.col('job') == 'unknown', f.lit(None)).otherwise(f.col('job')))\\<br/>  .withColumn('id', f.monotonically_increasing_id())</span></pre><p id="ee6a" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><code class="fe nt nu nv nj b">SparkDFDataset</code>是 PySpark 数据帧的一个薄薄的包装器，它允许我们在 Pyspark 数据帧上使用大期望方法。</p><pre class="kj kk kl km gt ni nj nk bn nl nm bi"><span id="e92a" class="nn la it nj b be no np l ns nr">gdf = SparkDFDataset(df)</span></pre><p id="fc13" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu">检查列名</strong></p><p id="b1fb" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">让我们通过向<code class="fe nt nu nv nj b">expect_table_columns_to_match_set</code>方法提供预期列的列表来验证 DataFrame 是否包含正确的列集。</p><pre class="kj kk kl km gt ni nj nk bn nl nm bi"><span id="7c31" class="nn la it nj b be no np l ns nr">expected_columns = ['age', 'job', 'marital',<br/>                    'education', 'default', 'balance',<br/>                    'housing', 'loan', 'contact',<br/>                    'day', 'month', 'duration',<br/>                    'campaign', 'pdays', 'previous',<br/>                    'poutcome', 'y']</span></pre><pre class="nw ni nj nx ny aw nz bi"><span id="f124" class="oa la it nj b gy ob oc l nq nr">gdf.expect_table_columns_to_match_set(column_set = expected_columns)</span></pre><p id="e723" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">运行上面的代码会返回下面的输出。<code class="fe nt nu nv nj b">"success":true</code>表示测试已通过。</p><pre class="kj kk kl km gt ni nj nk bn nl nm bi"><span id="620d" class="nn la it nj b be no np l ns nr"># output<br/>{<br/>  "result": {<br/>    "observed_value": [<br/>      "age",<br/>      "job",<br/>      "marital",<br/>      "education",<br/>      "default",<br/>      "balance",<br/>      "housing",<br/>      "loan",<br/>      "contact",<br/>      "day",<br/>      "month",<br/>      "duration",<br/>      "campaign",<br/>      "pdays",<br/>      "previous",<br/>      "poutcome",<br/>      "y"<br/>    ]<br/>  },<br/>  "exception_info": {<br/>    "raised_exception": false,<br/>    "exception_traceback": null,<br/>    "exception_message": null<br/>  },<br/>  "meta": {},<br/>  "success": true<br/>}</span></pre><p id="73ef" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu">检查分类栏中的值</strong></p><p id="6650" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们可以使用<code class="fe nt nu nv nj b">expect_column_values_to_be_in_set</code>方法检查分类列是否包含意外数据。我们期望<code class="fe nt nu nv nj b">marital</code>列只包含以下值<code class="fe nt nu nv nj b">single</code>、<code class="fe nt nu nv nj b">married</code>和<code class="fe nt nu nv nj b">divorced</code>。</p><pre class="kj kk kl km gt ni nj nk bn nl nm bi"><span id="2b89" class="nn la it nj b be no np l ns nr">gdf.expect_column_values_to_be_in_set(column = 'marital', value_set = {'single', 'married', 'divorced'})</span></pre><p id="553e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果<code class="fe nt nu nv nj b">marital</code>列包含任何在值集中找不到的值，Great Expectation 将无法通过检查。</p><pre class="kj kk kl km gt ni nj nk bn nl nm bi"><span id="314c" class="nn la it nj b be no np l ns nr"># output<br/>{<br/>  "result": {<br/>    "element_count": 45211,<br/>    "missing_count": 0,<br/>    "missing_percent": 0.0,<br/>    "unexpected_count": 0,<br/>    "unexpected_percent": 0.0,<br/>    "unexpected_percent_total": 0.0,<br/>    "unexpected_percent_nonmissing": 0.0,<br/>    "partial_unexpected_list": []<br/>  },<br/>  "exception_info": {<br/>    "raised_exception": false,<br/>    "exception_traceback": null,<br/>    "exception_message": null<br/>  },<br/>  "meta": {},<br/>  "success": true<br/>}</span></pre><p id="0583" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu">检查列不包含空值</strong></p><p id="1c9e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果我们希望列不包含任何空值，我们可以使用<code class="fe nt nu nv nj b">expect_column_values_to_not_be_null</code>方法并在参数中指定感兴趣的列。</p><pre class="kj kk kl km gt ni nj nk bn nl nm bi"><span id="ac64" class="nn la it nj b be no np l ns nr">gdf.expect_column_values_to_not_be_null(column = 'job')</span></pre><p id="7e79" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在这种情况下，<code class="fe nt nu nv nj b">job</code>列检查失败，因为该列中有空值。</p><pre class="kj kk kl km gt ni nj nk bn nl nm bi"><span id="52fb" class="nn la it nj b be no np l ns nr">{<br/>  "result": {<br/>    "element_count": 45211,<br/>    "unexpected_count": 288,<br/>    "unexpected_percent": 0.6370131162770122,<br/>    "unexpected_percent_total": 0.6370131162770122,<br/>    "partial_unexpected_list": [<br/>      null,<br/>      null,<br/>      null,<br/>      null,<br/>      null,<br/>      null,<br/>      null,<br/>      null,<br/>      null,<br/>      null,<br/>      null,<br/>      null,<br/>      null,<br/>      null,<br/>      null,<br/>      null,<br/>      null,<br/>      null,<br/>      null,<br/>      null<br/>    ]<br/>  },<br/>  "exception_info": {<br/>    "raised_exception": false,<br/>    "exception_traceback": null,<br/>    "exception_message": null<br/>  },<br/>  "meta": {},<br/>  "success": false<br/>}</span></pre><p id="9a62" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu">检查</strong>列的唯一性</p><p id="f4e8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">Great Expectation 还提供了开箱即用的方法来检查给定列中的值是否唯一。让我们检查一下<code class="fe nt nu nv nj b">id</code>列是否包含唯一值。</p><pre class="kj kk kl km gt ni nj nk bn nl nm bi"><span id="34a7" class="nn la it nj b be no np l ns nr">gdf.expect_column_values_to_be_unique('id')</span></pre><p id="0af2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">正如我们所料，该列包含唯一的值。</p><pre class="kj kk kl km gt ni nj nk bn nl nm bi"><span id="ffee" class="nn la it nj b be no np l ns nr"># output<br/>{<br/>  "result": {<br/>    "element_count": 45211,<br/>    "missing_count": 0,<br/>    "missing_percent": 0.0,<br/>    "unexpected_count": 0,<br/>    "unexpected_percent": 0.0,<br/>    "unexpected_percent_total": 0.0,<br/>    "unexpected_percent_nonmissing": 0.0,<br/>    "partial_unexpected_list": []<br/>  },<br/>  "exception_info": {<br/>    "raised_exception": false,<br/>    "exception_traceback": null,<br/>    "exception_message": null<br/>  },<br/>  "meta": {},<br/>  "success": true<br/>}</span></pre><h1 id="cdde" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">创建期望套件</h1><p id="f71e" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">既然我们已经创建了各种期望，我们可以将它们放在一个期望套件中。</p><pre class="kj kk kl km gt ni nj nk bn nl nm bi"><span id="da04" class="nn la it nj b be no np l ns nr">expectation_suite = gdf.get_expectation_suite(discard_failed_expectations=False)</span></pre><p id="86ad" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">期望只不过是期望的集合。</p><pre class="kj kk kl km gt ni nj nk bn nl nm bi"><span id="fa26" class="nn la it nj b be no np l ns nr">#expectation_suite<br/>{<br/>  "expectations": [<br/>    {<br/>      "kwargs": {<br/>        "column_set": [<br/>          "age",<br/>          "job",<br/>          "marital",<br/>          "education",<br/>          "default",<br/>          "balance",<br/>          "housing",<br/>          "loan",<br/>          "contact",<br/>          "day",<br/>          "month",<br/>          "duration",<br/>          "campaign",<br/>          "pdays",<br/>          "previous",<br/>          "poutcome",<br/>          "y"<br/>        ]<br/>      },<br/>      "expectation_type": "expect_table_columns_to_match_set",<br/>      "meta": {}<br/>    },<br/>    {<br/>      "kwargs": {<br/>        "column": "marital",<br/>        "value_set": [<br/>          "married",<br/>          "divorced",<br/>          "single"<br/>        ]<br/>      },<br/>      "expectation_type": "expect_column_values_to_be_in_set",<br/>      "meta": {}<br/>    },<br/>    {<br/>      "kwargs": {<br/>        "column": "job"<br/>      },<br/>      "expectation_type": "expect_column_values_to_not_be_null",<br/>      "meta": {}<br/>    },<br/>    {<br/>      "kwargs": {<br/>        "column": "id"<br/>      },<br/>      "expectation_type": "expect_column_values_to_be_unique",<br/>      "meta": {}<br/>    }<br/>  ],<br/>  "data_asset_type": "Dataset",<br/>  "meta": {<br/>    "great_expectations_version": "0.15.34"<br/>  },<br/>  "expectation_suite_name": "default",<br/>  "ge_cloud_id": null<br/>}</span></pre><p id="116f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">让我们以 JSON 格式保存期望套件。</p><pre class="kj kk kl km gt ni nj nk bn nl nm bi"><span id="41a8" class="nn la it nj b be no np l ns nr"># save expectation suite<br/>with open('my_expectation_suite.json', 'w') as my_file:<br/>    my_file.write(<br/>        json.dumps(expectation_suite.to_json_dict())<br/>    )</span></pre><h1 id="b1e0" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">运行期望套件</h1><p id="6778" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">假设我们有一组新的数据，它需要检查。我们使用之前保存的 expect suite 对新笔记本中的未知数据执行数据质量检查。</p><p id="fdbf" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu">进口</strong></p><pre class="kj kk kl km gt ni nj nk bn nl nm bi"><span id="5f5a" class="nn la it nj b be no np l ns nr">import great_expectations as ge<br/>from great_expectations.dataset.sparkdf_dataset import SparkDFDataset<br/>import pyspark<br/>from pyspark.sql import functions as f, Window<br/>import json</span></pre><p id="8b08" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu">加载数据</strong></p><pre class="kj kk kl km gt ni nj nk bn nl nm bi"><span id="7dd8" class="nn la it nj b be no np l ns nr">df = \\<br/>  spark\\<br/>  .read\\<br/>  .format('csv')\\<br/>  .option('header', True)\\<br/>  .load('/FileStore/tables/bank_full_new.csv', sep = ';')\\<br/>  .withColumn('job', f.when(f.col('job') == 'unknown', f.lit(None)).otherwise(f.col('job')))\\<br/>  .withColumn('id', f.monotonically_increasing_id())</span></pre><p id="3ec2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们创建两个函数来(a)加载期望套件和(b)根据期望套件验证数据。</p><pre class="kj kk kl km gt ni nj nk bn nl nm bi"><span id="afc1" class="nn la it nj b be no np l ns nr">def load_expectation_suite(path: str) -&gt; dict:<br/>    """Load expectation suite stored in JSON format<br/>    and convert into dictionary.<br/>    Args:<br/>        path (str): path to expectation suite json file<br/>    Returns:<br/>        dict: expectation suite<br/>    """<br/>    with open(path, 'r') as f:<br/>        expectation_suite = json.load(f)<br/>    return expectation_suite<br/>  <br/>def great_expectation_validation(df: pyspark.sql.DataFrame,<br/>                                 expectation_suite_path: str) -&gt; dict:<br/>    """Run validation on DataFrame based on expecation suite<br/>    Args:<br/>        df (pyspark.sql.DataFrame): DataFrame to validate<br/>        expectation_suite_path (str): path to expectation suite json file<br/>    Returns:<br/>        dict: Validation result<br/>    """<br/>    expectation_suite = load_expectation_suite(expectation_suite_path)<br/>    gdf = SparkDFDataset(df)<br/>    validation_results = gdf.validate(expectation_suite = expectation_suite, result_format = 'SUMMARY', catch_exceptions = True)<br/>    return validation_results</span></pre><p id="103f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu">运行验证</strong></p><pre class="kj kk kl km gt ni nj nk bn nl nm bi"><span id="4f17" class="nn la it nj b be no np l ns nr">validation_result = \\<br/>    great_expectation_validation(df = df, <br/>                                 expectation_suite_path = 'my_expectation_suite.json')</span></pre><p id="658f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu">执行检查</strong></p><p id="925f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><code class="fe nt nu nv nj b">False</code>表示验证失败，因为我们在期望套件中至少有一个期望失败。</p><pre class="kj kk kl km gt ni nj nk bn nl nm bi"><span id="9c6e" class="nn la it nj b be no np l ns nr">validation_result['success']<br/><br/># output:<br/># False</span></pre><p id="3664" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">巨大的期望也显示了成功和失败测试的数量。</p><pre class="kj kk kl km gt ni nj nk bn nl nm bi"><span id="db83" class="nn la it nj b be no np l ns nr">validation_result['statistics']<br/><br/>#output:<br/>#{'evaluated_expectations': 4,<br/># 'successful_expectations': 2,<br/># 'unsuccessful_expectations': 2,<br/># 'success_percent': 50.0}</span></pre><h1 id="ab0b" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">结论</h1><p id="29eb" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在本文中，我们讨论了测试数据管道的重要性，并通过一个例子说明了我们如何利用 Great Expectation 来创建一套全面的测试。</p></div><div class="ab cl od oe hx of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="im in io ip iq"><p id="0fcd" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><a class="ae ky" href="https://medium.com/@edwin.tan/membership" rel="noopener">加入 medium </a>阅读更多这样的文章！</p></div><div class="ab cl od oe hx of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="im in io ip iq"><h1 id="bce2" class="kz la it bd lb lc ok le lf lg ol li lj jz om ka ll kc on kd ln kf oo kg lp lq bi translated">参考</h1><p id="a525" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">[1] <a class="ae ky" href="https://greatexpectations.io/" rel="noopener ugc nofollow" target="_blank">远大前程首页远大前程</a></p><p id="ba2b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">[2] <code class="fe nt nu nv nj b">Moro,S., Rita,P. &amp; Cortez,P.. (2012). Bank Marketing. UCI Machine Learning Repository.</code> CC 乘 4.0。</p></div></div>    
</body>
</html>