<html>
<head>
<title>Concatenate Multiple (and Messy) Dataframes Efficiently</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">有效地连接多个(混乱的)数据帧</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/concatenate-multiple-and-messy-dataframes-efficiently-80847b4da12b#2022-04-21">https://towardsdatascience.com/concatenate-multiple-and-messy-dataframes-efficiently-80847b4da12b#2022-04-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f5aa" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何批处理和连接带有杂乱数据的数据帧</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/4544efe305290f71fd9a45731bb03618.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nc6Qf7WLrvkVV55OgxhDjg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由<a class="ae ky" href="https://pixabay.com/photos/a-book-book-stack-stacked-books-3346785/" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>提供(作者修改)</p></figure><p id="7b7b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在数据世界中，连接数据集是一项非常常见的数据管理任务。根据您的需要，您可能需要通过垂直堆叠来连接多个数据帧(与SQL中的“union”操作相同)。或者，您可能需要通过基于一些公共键水平连接或合并它们来连接它们。</p><p id="9aab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当垂直连接数据集时，假设数据帧具有相同的列名，并且列的顺序相同，我们可以简单地使用<code class="fe lv lw lx ly b">pandas.concat()</code>方法来执行连接。我们只需要指定<code class="fe lv lw lx ly b">axis=0</code>，它告诉<code class="fe lv lw lx ly b">pandas</code>将第二个数据帧堆叠在第一个之下，将第三个堆叠在第二个之下，依此类推。</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="7ccc" class="md me it ly b gy mf mg l mh mi">pd.concat([df1, df2, df3], axis=0)</span></pre><p id="19bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您有相当多的数据集(比如8个或10个)要连接，并且这些数据集可能有不同的列名或者列的顺序不同，该怎么办？当然，您可以逐个导入和处理每个数据集，然后将它们连接起来。但是，有没有更优雅、更高效的方法呢？</p><p id="08f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇文章中，我将带你看一个真实世界的例子，在这个例子中，我们可以使用<code class="fe lv lw lx ly b">for loop</code>和一些<code class="fe lv lw lx ly b">Pandas</code>技巧有效地批处理和连接多个混乱的数据帧。用于演示的数据文件可以从<a class="ae ky" href="https://www.kaggle.com/datasets/mathurinache/world-happiness-report" rel="noopener ugc nofollow" target="_blank"> Kaggle </a>下载。总共有8个csv文件。从2015年到2022年的每一年，每个文件都包含了153个国家的幸福得分以及用于解释得分的因素。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/1ec9ce2b21475dca8e533859aa4b42a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1246/format:webp/1*x2M8MNjLbk1NuKl9plYp4w.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="b5ad" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的目标是将这些文件连接成一个包含三列的数据框架——一个“年份”列、“国家”列和“幸福指数”列。稍后，我们可以创建一些有趣的数据可视化来显示幸福分数在不同国家之间的差异以及随时间的变化。让我们看看它是如何工作的。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h2 id="b499" class="md me it bd mr ms mt dn mu mv mw dp mx li my mz na lm nb nc nd lq ne nf ng nh bi translated">第一步:</h2><p id="2f79" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">让我们首先使用Python的<code class="fe lv lw lx ly b">glob</code>函数返回所有文件路径的列表。这将有助于我们使用<code class="fe lv lw lx ly b">for loop</code>一次将所有文件读入pandas数据帧。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/47f15d22e7d78c422e7ee35152152e9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gey9zrU1X1l4Il6r6uyB1g.png"/></div></div></figure></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h2 id="dec5" class="md me it bd mr ms mt dn mu mv mw dp mx li my mz na lm nb nc nd lq ne nf ng nh bi translated">第二步:</h2><p id="c6ef" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">接下来，让我们使用<code class="fe lv lw lx ly b">for loop</code>将所有文件读入pandas数据帧。如果这些数据集都有相同的列名，并且列的顺序相同，我们可以使用<code class="fe lv lw lx ly b">pd.concat()</code>轻松地将它们连接起来。让我们使用下面的代码来检查一下是否是这种情况(注意，在第4行中，为了方便检查，我将所有的列名都改成了小写)。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/36fd6f9e7e970d44c4425eabeb5f8952.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4qjpjD7IaEKSxt2gCxIo3w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="a351" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这8个数据集有不同的列，它们有不同的列数、不同的列名和不同的列顺序。例如，如上面的屏幕截图所示，在一个数据帧中，幸福分数的列名为“幸福分数”，而在其他数据帧中，该列名为“幸福分数”、“分数”或“阶梯分数”。</p><p id="16c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">鉴于数据的混乱，直接连接这8个数据帧是不可行的。在拼接之前我们需要做一些预处理，我们可以使用<code class="fe lv lw lx ly b">for loop</code>来批量处理它们。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="c857" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第1行:我们创建一个空列表<code class="fe lv lw lx ly b">dfs</code>。稍后，我们将用<code class="fe lv lw lx ly b">for loop</code>迭代将每个数据帧添加到这个列表中。</p><p id="4d8c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第6–7行:我们根据从列名中观察到的特定模式，从每个数据帧中迭代并提取“国家”列和“幸福指数”列。</p><p id="e799" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第9–11行:我们创建了一个新的dataframe <code class="fe lv lw lx ly b">df1</code>，它只有我们需要的三列——country _ col、score_col和year_col。</p><p id="ce28" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第13行:我们使用<code class="fe lv lw lx ly b">for loop</code>迭代将8个预处理数据帧中的每一个添加到列表<code class="fe lv lw lx ly b">dfs</code>中。</p><p id="43e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第14行:我们将相同的列名分配给列表中的所有数据帧，以便在下一步中连接它们，这需要相同的列名。</p><p id="c4de" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过参考dfs[0]、dfs[1]、dfs[2]等，您可以快速查看我们刚刚创建的每个数据帧的外观。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/59cc5f0200f2bc9b1dbebbe7c2df812a.png" data-original-src="https://miro.medium.com/v2/resize:fit:710/format:webp/1*38PK5a_iqsim-lMzxCe5nQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图像</p></figure></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h2 id="de49" class="md me it bd mr ms mt dn mu mv mw dp mx li my mz na lm nb nc nd lq ne nf ng nh bi translated">第三步:</h2><p id="ab45" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">最后，由于所有数据帧都有相同的列名和顺序，我们可以使用<code class="fe lv lw lx ly b">pd.concat()</code>方法轻松地将它们连接起来。在第1行中，我们连接了列表<code class="fe lv lw lx ly b">dfs,</code>中的所有数据帧，在第2–3行中，我们清理了“幸福分数”和“国家”列，以确保我们的数据为下一部分的可视化做好准备。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/8217cfcfdced240f70fbdec2756dcd06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hZ3h-RAmc9Cf_uW0RFmC8w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h2 id="eb25" class="md me it bd mr ms mt dn mu mv mw dp mx li my mz na lm nb nc nd lq ne nf ng nh bi translated">额外收获:一张显示全球幸福水平的动画地图</h2><p id="bca7" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">在充分准备和清理了我们的数据后，让我们使用<code class="fe lv lw lx ly b">plotly.express</code>创建一个动画choropleth地图，显示全球的幸福水平。</p><p id="8344" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">关于<code class="fe lv lw lx ly b">Plotly</code>的一个好处是，它有自然地球数据集中定义的国家的内置几何图形，并且不需要外部GeoJSON文件来绘制choropleth地图。要使用内置的国家几何图形，我们只需提供<code class="fe lv lw lx ly b">locations</code>作为<a class="ae ky" href="https://en.wikipedia.org/wiki/ISO_3166-1_alpha-3" rel="noopener ugc nofollow" target="_blank">三个字母的ISO国家代码</a>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="a2f1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第3–6行:我们通过将df_all与df_ISO连接来添加三个字母的ISO国家代码，df _ ISO具有ISO代码，可以在<a class="ae ky" href="https://www.kaggle.com/datasets/andreshg/countries-iso-codes-continent-flags-url" rel="noopener ugc nofollow" target="_blank"> Kaggle </a>上下载。</p><p id="075b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第9–14行:我们使用<code class="fe lv lw lx ly b">px.choropleth()</code>创建了一个动画的choropleth地图。<code class="fe lv lw lx ly b">locations</code>参数接受数据集中表示3个字母的ISO代码的任何列。此外，我们可以通过在<code class="fe lv lw lx ly b">animation_frame</code>参数中指定“年份”来轻松地将动画添加到choropleth地图中。</p><p id="7af9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第16–22行:我们添加了一个地图标题，并调整了它的字体、大小、颜色和位置。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/96738d17d53a00241ee9b90f074cde12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*9m3WKSGIWDZ8Ym0pUk1RYQ.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者GIF</p></figure><p id="b5fd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就对了。我们批量处理了多个原始的杂乱数据文件，并将它们连接起来，以创建一个数据帧，为分析和可视化做好准备。感谢阅读，我希望你喜欢这篇文章！</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h2 id="a228" class="md me it bd mr ms mt dn mu mv mw dp mx li my mz na lm nb nc nd lq ne nf ng nh bi translated"><strong class="ak">数据来源:</strong></h2><ol class=""><li id="bf43" class="nu nv it lb b lc ni lf nj li nw lm nx lq ny lu nz oa ob oc bi translated">《2022年世界幸福报告》于<a class="ae ky" href="https://www.kaggle.com/datasets/mathurinache/world-happiness-report" rel="noopener ugc nofollow" target="_blank"> Kaggle </a>发布。许可证:<a class="ae ky" href="https://creativecommons.org/publicdomain/zero/1.0/" rel="noopener ugc nofollow" target="_blank"> CC0:公共领域</a>。引文:Helliwell，John F .，Richard Layard，Jeffrey Sachs和Jan-Emmanuel德·内维编辑。2020.2020年世界幸福报告。纽约:可持续发展解决方案网络</li></ol><p id="f775" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">2.<a class="ae ky" href="https://www.kaggle.com/datasets/andreshg/countries-iso-codes-continent-flags-url" rel="noopener ugc nofollow" target="_blank"> Kaggle </a>上的“国家ISO代码|洲|标志URL”。许可证:<a class="ae ky" href="http://www.gnu.org/licenses/old-licenses/gpl-2.0.en.html" rel="noopener ugc nofollow" target="_blank"> GPL 2 </a></p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><p id="becb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以通过这个<a class="ae ky" href="https://medium.com/@insightsbees/membership" rel="noopener">推荐链接</a>注册Medium会员(每月5美元)来获得我的作品和Medium的其他内容。通过这个链接注册，我将收到你的一部分会员费，不需要你额外付费。谢谢大家！</p></div></div>    
</body>
</html>