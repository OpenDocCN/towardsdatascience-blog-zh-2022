<html>
<head>
<title>How to Write dbt Macros Using Jinja2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用 Jinja2 编写 dbt 宏</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-write-dbt-macros-using-jinja2-ff021d535bf3#2022-03-28">https://towardsdatascience.com/how-to-write-dbt-macros-using-jinja2-ff021d535bf3#2022-03-28</a></blockquote><div><div class="fc ij ik il im in"/><div class="io ip iq ir is"><div class=""/><div class=""><h2 id="1d9b" class="pw-subtitle-paragraph js iu iv bd b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj dk translated">编写第一个 dbt 宏的教程和备忘单</h2></div><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi kk"><img src="../Images/43e0ef24bc205b171f374eb016084396.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i7RJoSt2RqzBjShOaCKvTQ.jpeg"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">照片由<a class="ae la" href="https://unsplash.com/@hishahadat?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">沙哈达特·拉赫曼</a>在<a class="ae la" href="https://unsplash.com/s/photos/function?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="e44f" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">我最近遇到了一个难倒我的问题。那些不是最好的吗？他们立刻让我们变得卑微。</p><p id="1475" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">这个问题导致了我写的代码如何工作的许多挫折。这是我第一次和<a class="ae la" href="https://docs.getdbt.com/docs/building-a-dbt-project/jinja-macros" rel="noopener ugc nofollow" target="_blank"> dbt 宏</a>一起深入挖掘。我以前使用过它们，但从未添加定制逻辑，我只是复制了我在 dbt 文档中找到的内容。</p><p id="5c01" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">我没有纠结，而是将这个架构问题作为一个机会来学习更多关于 dbt 宏和 Jinja 函数的知识。并且，通过写这篇文章，我希望填补关于宏如何工作的知识空白。</p><h1 id="ff74" class="lx ly iv bd lz ma mb mc md me mf mg mh kb mi kc mj ke mk kf ml kh mm ki mn mo bi translated">什么是 dbt 宏？</h1><p id="bc2b" class="pw-post-body-paragraph lb lc iv ld b le mp jw lg lh mq jz lj lk mr lm ln lo ms lq lr ls mt lu lv lw io bi translated">如果你不知道，<strong class="ld iw"> dbt 宏</strong>基本上就是嵌入在你的 SQL 代码中的函数。逻辑非常类似于一个简单的 Python 函数。他们利用一种叫做 Jinja 的语言来编写这些函数。虽然对于那些用 Python 编写函数的人来说，Jinja 非常简单，但是你仍然需要通读文档来理解它是如何工作的。</p><h1 id="97f2" class="lx ly iv bd lz ma mb mc md me mf mg mh kb mi kc mj ke mk kf ml kh mm ki mn mo bi translated">让我们复习一些基本的 Jinja 语法:</h1><h2 id="7bc8" class="mu ly iv bd lz mv mw dn md mx my dp mh lk mz na mj lo nb nc ml ls nd ne mn nf bi translated">变量</h2><p id="c3d4" class="pw-post-body-paragraph lb lc iv ld b le mp jw lg lh mq jz lj lk mr lm ln lo ms lq lr ls mt lu lv lw io bi translated">如果你想<strong class="ld iw">设置一个变量</strong>，你可以这样写:</p><p id="28a8" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated"><code class="fe ng nh ni nj b">{%- set default = development -%}</code></p><p id="fcd3" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated"><code class="fe ng nh ni nj b">default</code>是变量的名称，<code class="fe ng nh ni nj b">development</code>是被设置为等于变量的对象。记得用正确的语法将它包装起来:<code class="fe ng nh ni nj b">{%- -%}</code>。</p><p id="f8cb" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">如果你想<strong class="ld iw">引用一个变量</strong>，你需要用两个弯曲的大括号把它括起来。像这样:</p><pre class="kl km kn ko gt nk nj nl nm aw nn bi"><span id="384a" class="mu ly iv nj b gy no np l nq nr">{{ default }}</span></pre><h2 id="e6eb" class="mu ly iv bd lz mv mw dn md mx my dp mh lk mz na mj lo nb nc ml ls nd ne mn nf bi translated">If 语句</h2><p id="3039" class="pw-post-body-paragraph lb lc iv ld b le mp jw lg lh mq jz lj lk mr lm ln lo ms lq lr ls mt lu lv lw io bi translated">编写<strong class="ld iw"> if 块</strong> is <strong class="ld iw"> </strong>几乎与 Python 相同，只是用适当的 Jinja 语法包装它们:</p><pre class="kl km kn ko gt nk nj nl nm aw nn bi"><span id="9733" class="mu ly iv nj b gy no np l nq nr">-- if <br/>{%- if default = development -%}</span><span id="5e9c" class="mu ly iv nj b gy ns np l nq nr">-- else if<br/>{%- elif default = production -%}</span><span id="dfe9" class="mu ly iv nj b gy ns np l nq nr">-- else <br/>{%- else -%}</span><span id="d8e7" class="mu ly iv nj b gy ns np l nq nr">-- closing the function<br/>{%- endif -%}</span></pre><p id="506c" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">确保用<code class="fe ng nh ni nj b">{%- endif -%}</code>块关闭中频功能。</p><h2 id="bfcb" class="mu ly iv bd lz mv mw dn md mx my dp mh lk mz na mj lo nb nc ml ls nd ne mn nf bi translated">记录</h2><p id="d084" class="pw-post-body-paragraph lb lc iv ld b le mp jw lg lh mq jz lj lk mr lm ln lo ms lq lr ls mt lu lv lw io bi translated">记录变量是调试你编写的任何函数的重要部分。为了在 Jinja 中做到这一点，只需使用以下语法插入您希望打印到控制台的变量:</p><p id="0045" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated"><code class="fe ng nh ni nj b">{% do log(node, info=true) %}</code></p><p id="8b96" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">在这里，您将把节点的信息记录到您的控制台。请记住，您需要设置<code class="fe ng nh ni nj b">info=true</code>来将信息记录到您的控制台上，而不仅仅是记录在日志文件中。</p><h1 id="958e" class="lx ly iv bd lz ma mb mc md me mf mg mh kb mi kc mj ke mk kf ml kh mm ki mn mo bi translated">编写宏</h1><p id="6dd4" class="pw-post-body-paragraph lb lc iv ld b le mp jw lg lh mq jz lj lk mr lm ln lo ms lq lr ls mt lu lv lw io bi translated">现在，如何将所有这些放在一起编写 dbt 宏呢？您可以像定义 Python 函数一样定义它。</p><p id="8933" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">首先，必须用 word macro 打开它，并用适当的 Jinja 语法包装它。像这样:</p><pre class="kl km kn ko gt nk nj nl nm aw nn bi"><span id="d020" class="mu ly iv nj b gy no np l nq nr">{% macro -%}</span></pre><p id="8c33" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">然后，在单词<code class="fe ng nh ni nj b">macro</code>之后，必须指定宏的名称，类似于指定 Python 函数的名称。</p><pre class="kl km kn ko gt nk nj nl nm aw nn bi"><span id="7179" class="mu ly iv nj b gy no np l nq nr">{% macro generate_schema_name() -%}</span></pre><p id="6549" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">如果函数接受任何变量作为输入，则将这些变量添加到括号中。</p><pre class="kl km kn ko gt nk nj nl nm aw nn bi"><span id="d9a0" class="mu ly iv nj b gy no np l nq nr">{% macro generate_schema_name(custom_schema_name, node) -%}</span></pre><p id="94e8" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">同样，类似于 Python(我听起来像一个坏掉的记录)，您可以为这些变量设置默认值，以防在引用函数时没有变量传入。</p><pre class="kl km kn ko gt nk nj nl nm aw nn bi"><span id="7e1e" class="mu ly iv nj b gy no np l nq nr">{% macro generate_schema_name(custom_schema_name=none, node=none) -%}</span></pre><p id="459b" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">最后但同样重要的是，当您在宏中编写完逻辑后，必须用下面的代码块关闭它:</p><pre class="kl km kn ko gt nk nj nl nm aw nn bi"><span id="0bca" class="mu ly iv nj b gy no np l nq nr">{%- endmacro %}</span></pre><p id="16f0" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">不算太坏，对吧？</p><h1 id="8b6f" class="lx ly iv bd lz ma mb mc md me mf mg mh kb mi kc mj ke mk kf ml kh mm ki mn mo bi translated">要引用的 dbt 变量</h1><p id="d503" class="pw-post-body-paragraph lb lc iv ld b le mp jw lg lh mq jz lj lk mr lm ln lo ms lq lr ls mt lu lv lw io bi translated">文档太多总比太少好。但是，有时候，当有这么多好的信息时，你不可能找到你所需要的。纠结了几天，终于找到 dbt 的<a class="ae la" href="https://docs.getdbt.com/reference/dbt-jinja-functions" rel="noopener ugc nofollow" target="_blank"> Jinja 函数文档</a>。</p><p id="3e65" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">这在尝试创建自定义宏时非常有用。它会给你一个好主意，告诉你如何利用现有资源实现你的愿景。</p><p id="bdfc" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">不要逐一查看每个人，你可以自己完成，让我们回顾一下我发现最有帮助的。</p><h2 id="db52" class="mu ly iv bd lz mv mw dn md mx my dp mh lk mz na mj lo nb nc ml ls nd ne mn nf bi translated">结节</h2><p id="2eb8" class="pw-post-body-paragraph lb lc iv ld b le mp jw lg lh mq jz lj lk mr lm ln lo ms lq lr ls mt lu lv lw io bi translated">节点引用特定 dbt 模型的所有配置设置。这在提取模型的名称或路径时经常被引用。我强烈建议像我们上面所做的那样记录节点，以查看您可以从中提取用于宏的所有不同信息。</p><pre class="kl km kn ko gt nk nj nl nm aw nn bi"><span id="66aa" class="mu ly iv nj b gy no np l nq nr">{% do log(node, info=true) %}</span></pre><p id="35b7" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">例如，我经常在宏代码中使用<code class="fe ng nh ni nj b">node.path</code>,以便获得我的模型的文件路径。如果一个模型在某个文件夹中，我写代码做一件事。如果它在另一个文件夹中，我写代码做另一件事。</p><h2 id="8e81" class="mu ly iv bd lz mv mw dn md mx my dp mh lk mz na mj lo nb nc ml ls nd ne mn nf bi translated">目标</h2><p id="2c04" class="pw-post-body-paragraph lb lc iv ld b le mp jw lg lh mq jz lj lk mr lm ln lo ms lq lr ls mt lu lv lw io bi translated">这是宏中另一个常用的变量。如果您熟悉 dbt，那么您应该知道目标是用来设置您的开发环境的。你的大多数项目可能都有一个<code class="fe ng nh ni nj b">dev</code>目标和一个<code class="fe ng nh ni nj b">prod</code>目标。每种模式下的数据库和模式信息都有所不同。</p><p id="44f4" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">目标变量是您希望如何引用这些不同的信息。您可以通过调用<code class="fe ng nh ni nj b">target.name</code>使用当前目标名称，通过调用<code class="fe ng nh ni nj b">target.database</code>使用当前目标的数据库。</p><p id="cd15" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">这在根据您的工作环境设置不同条件时特别有用。您可以通过在 if 语句中使用<code class="fe ng nh ni nj b">target.name</code>来查看您是在 dev 还是 prod 中。</p><h1 id="b17d" class="lx ly iv bd lz ma mb mc md me mf mg mh kb mi kc mj ke mk kf ml kh mm ki mn mo bi translated">我们写个宏吧！</h1><p id="5d2c" class="pw-post-body-paragraph lb lc iv ld b le mp jw lg lh mq jz lj lk mr lm ln lo ms lq lr ls mt lu lv lw io bi translated">现在，是时候用我们刚刚学过的东西来写你的第一个宏了。虽然 dbt 已经在每个项目中内置了一些<a class="ae la" href="https://docs.getdbt.com/docs/building-a-dbt-project/building-models/using-custom-schemas" rel="noopener ugc nofollow" target="_blank">宏</a>，比如<code class="fe ng nh ni nj b">create_schema_name</code>和<code class="fe ng nh ni nj b">drop_old_relations</code>，但是知道如何定制这些宏来满足您的需求也很重要。就我个人而言，我重新配置了<code class="fe ng nh ni nj b">create_schema_name</code>来匹配我想要如何命名我的 dbt 模型。</p><h2 id="b931" class="mu ly iv bd lz mv mw dn md mx my dp mh lk mz na mj lo nb nc ml ls nd ne mn nf bi translated">我来分享一下我的做法。</h2><p id="a977" class="pw-post-body-paragraph lb lc iv ld b le mp jw lg lh mq jz lj lk mr lm ln lo ms lq lr ls mt lu lv lw io bi translated">首先，我从宏的基本外壳开始。这包括起始行和结束行，起始行包含函数的名称。</p><pre class="kl km kn ko gt nk nj nl nm aw nn bi"><span id="fa0c" class="mu ly iv nj b gy no np l nq nr">{% macro generate_schema_name() -%}</span><span id="9986" class="mu ly iv nj b gy ns np l nq nr">{%- endmacro %}</span></pre><p id="1233" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">接下来，我添加了两个 if 语句和一个 else 语句。我知道我想要包含两个条件和一个 else 块来捕捉任何不满足任一条件的情况。不要忘记你的结尾部分！</p><pre class="kl km kn ko gt nk nj nl nm aw nn bi"><span id="97f6" class="mu ly iv nj b gy no np l nq nr">{% macro generate_schema_name() -%}</span><span id="21c9" class="mu ly iv nj b gy ns np l nq nr">   {%- if -%}</span><span id="f913" class="mu ly iv nj b gy ns np l nq nr"><br/>   {%- elif -%}</span><span id="00dd" class="mu ly iv nj b gy ns np l nq nr"><br/>   {%- else -%}</span><span id="f410" class="mu ly iv nj b gy ns np l nq nr"><br/>   {%- endif -%}</span><span id="d298" class="mu ly iv nj b gy ns np l nq nr">{%- endmacro %}</span></pre><p id="9fbc" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">现在，我要设置什么条件呢？让我们根据目标中设置的环境来执行每项操作。一个用于开发场景，另一个用于生产场景。</p><pre class="kl km kn ko gt nk nj nl nm aw nn bi"><span id="fa41" class="mu ly iv nj b gy no np l nq nr">{% macro generate_schema_name() -%}</span><span id="0284" class="mu ly iv nj b gy ns np l nq nr">   {%- if target.name == 'dev'-%}</span><span id="52eb" class="mu ly iv nj b gy ns np l nq nr">   {%- elif target.name == 'prod' -%}</span><span id="8a91" class="mu ly iv nj b gy ns np l nq nr">   {%- else -%}</span><span id="4063" class="mu ly iv nj b gy ns np l nq nr">   {%- endif -%}</span><span id="982b" class="mu ly iv nj b gy ns np l nq nr">{%- endmacro %}</span></pre><p id="861d" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">注意，我们的函数名是<code class="fe ng nh ni nj b">generate_schema_name()</code>。这意味着我们希望根据环境设置不同的模式。命名 dev 和 prod 中的模式有什么意义？</p><p id="6eaa" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">这都是个人喜好。这并不是我的数据库和模式实际上是如何建立的，只是在这个例子中我将如何使用它们。</p><p id="dd51" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">我想编写一个宏，将开发中的所有模型的模式设置为<code class="fe ng nh ni nj b">data_mart_dev</code>。然而，我希望所有的生产模型都是我的<code class="fe ng nh ni nj b">dbt_project.yml</code>中定义的。</p><p id="4494" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">注意，这个宏<code class="fe ng nh ni nj b">generate_schema_name()</code>是一个已经由 dbt 编写的宏，它接受一个变量<code class="fe ng nh ni nj b">custom_schema_name</code>作为输入。<code class="fe ng nh ni nj b">Custom_schema_name</code>指项目文件中指定的内容。此外，我们还想传入模型的节点。</p><pre class="kl km kn ko gt nk nj nl nm aw nn bi"><span id="8d19" class="mu ly iv nj b gy no np l nq nr">{% macro generate_schema_name(custom_schema_name, node) -%}</span><span id="1614" class="mu ly iv nj b gy ns np l nq nr">   {%- if target.name == 'dev'-%}</span><span id="b879" class="mu ly iv nj b gy ns np l nq nr">   {%- elif target.name == 'prod' -%}</span><span id="22cf" class="mu ly iv nj b gy ns np l nq nr">   {%- else -%}</span><span id="d3b9" class="mu ly iv nj b gy ns np l nq nr">   {%- endif -%}</span><span id="9cf9" class="mu ly iv nj b gy ns np l nq nr">{%- endmacro %}</span></pre><p id="2d40" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">现在，我们希望将<code class="fe ng nh ni nj b">data_mart_dev</code>设置为宏中第一个 if 块内的模式，因为我们希望所有的开发模型都在这里构建。字符串被简单地写成不带任何引号的普通文本。</p><pre class="kl km kn ko gt nk nj nl nm aw nn bi"><span id="d680" class="mu ly iv nj b gy no np l nq nr">{% macro generate_schema_name(custom_schema_name, node) -%}</span><span id="1a2a" class="mu ly iv nj b gy ns np l nq nr">   {%- if target.name == 'dev'-%}</span><span id="657e" class="mu ly iv nj b gy ns np l nq nr">      data_mart_dev</span><span id="1408" class="mu ly iv nj b gy ns np l nq nr">   {%- elif target.name == 'prod' -%}</span><span id="974e" class="mu ly iv nj b gy ns np l nq nr">   {%- else -%}</span><span id="1889" class="mu ly iv nj b gy ns np l nq nr">   {%- endif -%}</span><span id="6f24" class="mu ly iv nj b gy ns np l nq nr">{%- endmacro %}</span></pre><p id="d7bc" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">接下来，我们需要在第二个 if 块中将模式设置为<code class="fe ng nh ni nj b">custom_schema_name</code>。用<code class="fe ng nh ni nj b">{{ }}</code>引用变量。在管道后面添加<code class="fe ng nh ni nj b">trim</code>将在调用变量时消除任何空白。</p><pre class="kl km kn ko gt nk nj nl nm aw nn bi"><span id="757c" class="mu ly iv nj b gy no np l nq nr">{% macro generate_schema_name(custom_schema_name, node) -%}</span><span id="a874" class="mu ly iv nj b gy ns np l nq nr">   {%- if target.name == 'dev'-%}</span><span id="b3f1" class="mu ly iv nj b gy ns np l nq nr">      data_mart_dev</span><span id="9d9e" class="mu ly iv nj b gy ns np l nq nr">   {%- elif target.name == 'prod' -%}<br/>      <br/>      {{ custom_schema_name | trim }} </span><span id="9794" class="mu ly iv nj b gy ns np l nq nr">   {%- else -%}</span><span id="0c79" class="mu ly iv nj b gy ns np l nq nr">   {%- endif -%}</span><span id="6c89" class="mu ly iv nj b gy ns np l nq nr">{%- endmacro %}</span></pre><p id="0af4" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">最后，我们需要定义当这些条件都不满足时，模式应该是什么。让我们创建一个默认变量，并将其设置为等于目标模式。</p><pre class="kl km kn ko gt nk nj nl nm aw nn bi"><span id="8d99" class="mu ly iv nj b gy no np l nq nr">{% macro generate_schema_name(custom_schema_name, node) -%}</span><span id="5229" class="mu ly iv nj b gy ns np l nq nr">   default_schema = target.schema </span><span id="0729" class="mu ly iv nj b gy ns np l nq nr">   {%- if target.name == 'dev'-%}</span><span id="a813" class="mu ly iv nj b gy ns np l nq nr">      data_mart_dev</span><span id="e48d" class="mu ly iv nj b gy ns np l nq nr">   {%- elif target.name == 'prod' -%}<br/>      <br/>      {{ custom_schema_name | trim }}</span><span id="e64c" class="mu ly iv nj b gy ns np l nq nr">   {%- else -%}</span><span id="7c40" class="mu ly iv nj b gy ns np l nq nr">      {{ default_schema | trim }}</span><span id="6557" class="mu ly iv nj b gy ns np l nq nr">   {%- endif -%}</span><span id="a867" class="mu ly iv nj b gy ns np l nq nr">{%- endmacro %}</span></pre><p id="5be8" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">现在我们的宏完成了！您选择运行的每个 dbt 模型都会自动调用这个函数。您的<code class="fe ng nh ni nj b">dev</code>模型将在模式<code class="fe ng nh ni nj b">data_mart_dev</code>中创建，您的<code class="fe ng nh ni nj b">prod</code>模型将在您的<code class="fe ng nh ni nj b">dbt_project.yml</code>文件中定义的模式中创建。</p><h1 id="fcde" class="lx ly iv bd lz ma mb mc md me mf mg mh kb mi kc mj ke mk kf ml kh mm ki mn mo bi translated">结论</h1><p id="3e33" class="pw-post-body-paragraph lb lc iv ld b le mp jw lg lh mq jz lj lk mr lm ln lo ms lq lr ls mt lu lv lw io bi translated">恭喜你。您已经编写了第一个 dbt 宏，它为不同的开发环境设置了不同的模式名。dbt 宏可能很难理解，但是一旦你理解了，你可以用它做很多很酷的事情。定制您的项目，使它们更有效，以及测试您的模型的可能性是无穷无尽的。</p><p id="f8be" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">但是，要确保不要过度。使用 dbt 的好处是它使您的代码模块化。您的代码应该被存储起来，以便可以在多个地方重复使用。宏也是如此。你不想为一个非常小的用例编写宏。您希望宏应用于项目中的多个位置。当您决定是否应该编写新宏时，请记住这一点。</p><p id="4241" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">如果你有兴趣学习更多关于 dbt 宏的知识，一定要订阅我在 Substack 上的<a class="ae la" href="https://madisonmae.substack.com/p/hey-there-heres-what-you-can-expect" rel="noopener ugc nofollow" target="_blank">新闻简报</a>。很快我将分享一篇关于我最近为一个非常具体的用例编写的宏的独家文章。它将包含大量有价值的信息，您可能希望将这些信息应用到您自己的 dbt 模型中！快乐编码。</p></div></div>    
</body>
</html>