<html>
<head>
<title>Dynamic Time Intelligence in DAX made easy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">DAX 中的动态时间智能变得简单</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/dynamic-time-intelligence-in-dax-made-easy-640b4e531ca8#2022-02-07">https://towardsdatascience.com/dynamic-time-intelligence-in-dax-made-easy-640b4e531ca8#2022-02-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="1fe3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当你的客户要求你创建一个动态时间智能测量。根据所选期间，该度量应返回不同的值。让我们看看你如何做到这一点。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/f7b5adf76c822ec81c5aab920a8f224a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XWVdmiH4QRy7JahR"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">克劳迪奥·施瓦兹在<a class="ae le" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="a5d2" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">介绍</h1><p id="cf2e" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">几周前，一位客户向我们提出了以下问题:是否可以根据 Power BI 报告中所选的时间段显示之前时间段的值？</p><p id="a6b5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">假设他在查看月份级别。然后，他希望看到前一个月的值。在季度级别，他希望看到前一季度，在年度级别，前一年。</p><p id="dea3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">见下图，看看我们的客户描述的要求:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/7ab8b99a1c588eb932651f7f7bad20fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1290/format:webp/1*NIY9gzyP8M7mZhL1GZFH5A.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">图 1 —目标结果(作者提供的图)</p></figure><p id="cc79" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在我们找到解决办法之前，有一些令人挠头的时刻。</p><p id="2d33" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我的同行考虑使用标准的 DAX 函数来获取以前的周期，如 PARALLELPERIOD()、SAMEPERIODLASTYEAR()、DATEADD()等。</p><p id="ca19" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是它们都是基于特定的时间段(年、月、日等)获得值的。).因此，它们都无助于满足这一特定要求。</p><p id="9724" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因此，我们必须创建自定义逻辑来满足这一需求。</p><h1 id="239d" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">获取所选期间</h1><p id="ccdd" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">第一步是确定哪个是当前期间。</p><p id="5718" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先使用的方法是 FILTERED()、ISINSCOPE()和类似的函数。但是这些功能并没有提供所需的结果。</p><p id="d89d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后有人问我什么是正确的方法。我建议使用函数 HASONEVALUE()。</p><p id="b923" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们从获取实际日历级别(日、月、季度或年)并根据所选级别返回值的方法开始:</p><pre class="kp kq kr ks gt mj mk ml mm aw mn bi"><span id="23c0" class="mo lg it mk b gy mp mq l mr ms">Dynamic Time Int. =<br/>VAR SelectedPeriod = IF(HASONEVALUE(‘Date’[Date])<br/>                     ,1<br/>                     ,IF(HASONEVALUE(‘Date’[MonthKey])<br/>                       ,2<br/>                       ,IF(HASONEVALUE(‘Date’[QuarterKey])<br/>                         ,3<br/>                        ,4<br/>                        )<br/>                       )<br/>                      )</span><span id="5eca" class="mo lg it mk b gy mt mq l mr ms">RETURN<br/>    SelectedPeriod</span></pre><p id="4814" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">结果是:</p><ul class=""><li id="27eb" class="mu mv it js b jt ju jx jy kb mw kf mx kj my kn mz na nb nc bi translated">1 在日常水平</li><li id="f1f7" class="mu mv it js b jt nd jx ne kb nf kf ng kj nh kn mz na nb nc bi translated">每月 2 次</li><li id="7ed8" class="mu mv it js b jt nd jx ne kb nf kf ng kj nh kn mz na nb nc bi translated">3 在季度一级</li><li id="748d" class="mu mv it js b jt nd jx ne kb nf kf ng kj nh kn mz na nb nc bi translated">每年 4 次</li></ul><p id="2f35" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你可以在下图中看到结果:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ni"><img src="../Images/e4d0a267ea51a60a798d4de56d3b89de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m1nAwLn3TVYGemNpX3FH3g.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">图 2—中间结果(作者提供的图)</p></figure><p id="fc4d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如您所见，该度量返回每个选定期间的正确值。</p><p id="4101" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有趣的一点是，我可以使用我的日期表中与一个被检查的级别相关的任何属性，并且我将总是得到正确的结果。</p><p id="5026" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">稍后我会解释这种方法的工作原理。</p><h1 id="be2c" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">计算前期</h1><p id="21e1" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">现在，我必须添加逻辑以获得基本度量，并添加基于正确时间段的时间智能逻辑:</p><pre class="kp kq kr ks gt mj mk ml mm aw mn bi"><span id="6a5c" class="mo lg it mk b gy mp mq l mr ms">Dynamic Time Int. =<br/>VAR SelectedPeriod = IF(HASONEVALUE(‘Date’[Date])<br/>                     ,1<br/>                     ,IF(HASONEVALUE(‘Date’[MonthKey])<br/>                       ,2<br/>                       ,IF(HASONEVALUE(‘Date’[QuarterKey])<br/>                         ,3<br/>                        ,4<br/>                        )<br/>                       )<br/>                      )</span><span id="6de9" class="mo lg it mk b gy mt mq l mr ms">RETURN<br/>    SWITCH(SelectedPeriod<br/>          ,1, CALCULATE([Sum Online Sales]<br/>             ,DATEADD(‘Date’[Date], -1, DAY)<br/>                      )<br/>          ,2, CALCULATE([Sum Online Sales]<br/>             ,DATEADD(‘Date’[Date], -1, MONTH)<br/>                      )<br/>          ,3, CALCULATE([Sum Online Sales]<br/>             ,DATEADD(‘Date’[Date], -1, QUARTER)<br/>                      )<br/>            ,CALCULATE([Sum Online Sales]<br/>              ,DATEADD(‘Date’[Date], -1, YEAR)<br/>                      )<br/>           )</span></pre><p id="fd99" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当然，我可以在 IF 函数中添加 CALCULATE()代码部分。</p><p id="5cc1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是这将导致复杂和混乱的代码，难以理解。<br/>这样，所选期间的选择与计算部分是分开的，两部分都简单易懂。</p><p id="3701" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下图显示了结果:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/ab35c828eafb93e744eccdf785f04792.png" data-original-src="https://miro.medium.com/v2/resize:fit:1366/format:webp/1*6mHw40V5feYLplyedRpETg.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">图 3—结果(作者提供的数据)</p></figure><p id="0524" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如您所见，该措施如预期一样有效。</p><p id="fa9e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是为什么呢？</p><h1 id="b84a" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">说明</h1><p id="aa3c" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">在你继续之前，试着找出你自己的原因。</p><p id="5a76" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi">.</p><p id="217b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi">.</p><p id="33cf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi">.</p><p id="0ef4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，让我们来看看这个措施为什么有效。</p><p id="c124" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里的关键概念是“Filter-context”:当过滤一个表中的一个或多个列时，所有其他列也会受到影响。</p><p id="9a5d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请看下面从一个简单的日期表中摘录的内容:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nk"><img src="../Images/684aae14ee6ae47c5164af540515ec7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kBrwa99pkaU506ZPxlIqwg.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">图 4—摘自日期表(作者提供的图表)</p></figure><p id="5e62" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当你选择月=一月，年= 2012 时会发生什么？<br/>当这两个值过滤这两列时，对这两列的过滤也会影响所有其他表列。</p><p id="3e3e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因此，列 MonthKey 只有一个不同的值:201201</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nl"><img src="../Images/750f69b046ada888cd7fa0252e2bf966.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EExi9gHfJx1p3_vBVXtmJQ.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">图 5—选定时间段的数据表摘录(作者提供的图表)</p></figure><p id="d6bf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当您选择“季度= 2”和“年份= 2012”时，也会发生同样的情况。</p><p id="6902" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">列 QuarterKey 也包含一个不同的值。</p><p id="2398" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因此，我们可以在键列上使用 HASONEVALUE()来确定所选的周期:</p><p id="37f5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">HASONEVALUE('Date'[MonthKey])</p><p id="fb27" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用 HASONEVALUE()的查询既高效又快速，而且整个度量几乎完全可以在存储引擎中计算:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/b87f823eba2fc28d2e0a7107499c3da4.png" data-original-src="https://miro.medium.com/v2/resize:fit:374/format:webp/1*y94okrdWQlGa0dViBZPPcQ.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">图 6—测量的服务器计时(由作者提供)</p></figure><h1 id="dfab" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">结论</h1><p id="173b" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">理解 DAX 的所有含义和复杂性以及表格模型中的筛选器上下文对于解决此类挑战至关重要。</p><p id="c9b7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有时，它是关于连接你的知识点，以找到正确的解决方案。</p><p id="cce9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这种情况下，我们需要意识到选择年份和月份会将 MonthKey 列限制为只有一个值。剩下的就简单了。</p><p id="6d19" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最初的方法并非完全错误。但是它们太复杂了，不能在所有情况下都提供正确的结果。</p><p id="034d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个解决方案的美妙之处在于，您可以轻松地将这个逻辑添加到计算组中，并在其他度量中重用这个逻辑。</p><p id="67fa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里我想强调的另一个主题是如何构建解决方案。</p><p id="7166" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们从第一个版本开始，它只返回我们用来标记所选时间段的标志。<br/>这种方法遵循我构建复杂度量的一种常见模式:</p><ol class=""><li id="d8f6" class="mu mv it js b jt ju jx jy kb mw kf mx kj my kn nn na nb nc bi translated">构建中间版本，计算可理解且易于验证的值</li><li id="7575" class="mu mv it js b jt nd jx ne kb nf kf ng kj nh kn nn na nb nc bi translated">向代码中添加更多的逻辑，并检查每一步是否有错误或不想要的结果</li><li id="0977" class="mu mv it js b jt nd jx ne kb nf kf ng kj nh kn nn na nb nc bi translated">完成代码</li></ol><p id="d977" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这种方法帮助我根据需求和期望不断地验证结果。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi no"><img src="../Images/a26a998ffa8c6448aa79cf89c03e43c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5gYGhet9nz952w-V"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">由<a class="ae le" href="https://unsplash.com/@juniorferreir_?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">朱尼尔·费雷拉</a>在<a class="ae le" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="c304" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">参考</h1><p id="4f2e" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">我使用 Contoso 样本数据集，就像我以前的文章一样。你可以从微软<a class="ae le" href="https://www.microsoft.com/en-us/download/details.aspx?id=18279" rel="noopener ugc nofollow" target="_blank">这里</a>免费下载 ContosoRetailDW 数据集。</p><p id="7945" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Contoso 数据可以在 MIT 许可下自由使用，如这里的<a class="ae le" href="https://github.com/microsoft/Power-BI-Embedded-Contoso-Sales-Demo" rel="noopener ugc nofollow" target="_blank">所述</a>。</p><p id="ce10" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我扩大了数据集，使 DAX 引擎工作更努力。<br/>在线销售表包含 6300 万行(而不是 1260 万行)，零售表包含 1550 万行(而不是 340 万行)。</p><div class="np nq gp gr nr ns"><a href="https://medium.com/@salvatorecagliari/membership" rel="noopener follow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd iu gy z fp nx fr fs ny fu fw is bi translated">通过我的推荐链接加入 Medium-Salvatore Cagliari</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">medium.com</p></div></div><div class="ob l"><div class="oc l od oe of ob og ky ns"/></div></div></a></div></div></div>    
</body>
</html>