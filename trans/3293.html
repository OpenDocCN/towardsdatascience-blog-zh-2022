<html>
<head>
<title>Pivot and Unpivot Functions in BigQuery For Better Data Manipulation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">BigQuery中的Pivot和Unpivot函数用于更好的数据操作</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/pivot-and-unpivot-functions-in-bigquery-for-better-data-manipulation-f0230295bd5e#2022-07-22">https://towardsdatascience.com/pivot-and-unpivot-functions-in-bigquery-for-better-data-manipulation-f0230295bd5e#2022-07-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/541ac548ee80aef7abb1eda53af03be3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TR24J5q49X3XpOV7"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">马龙·玛雅在<a class="ae jg" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><div class=""/><div class=""><h2 id="3bec" class="pw-subtitle-paragraph kg ji jj bd b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dk translated">详细的教程</h2></div><p id="1e0a" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Pivot是BigQuery中一个非常简单的函数，当您需要将行旋转成列时，它会非常有用。它对行使用聚合函数，并将行中的类别转换为列。有一个unpivot函数做完全相反的操作。如果你是Google云平台的大查询用户，还没有用过Pivot和Unpivot函数，那么很值得学习。</p><p id="3864" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">本文将重点用例子解释Pivot和Unpivot函数。为此，我们将创建一个虚拟表，如下所示:</p><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="1044" class="md me jj lz b gy mf mg l mh mi">WITH Produce AS (</span><span id="4848" class="md me jj lz b gy mj mg l mh mi">SELECT 'Kale' as product, 51 as sales, 'Q1' as quarter, 2020 as year UNION ALL</span><span id="5631" class="md me jj lz b gy mj mg l mh mi">SELECT 'Kale', 23, 'Q2', 2020 UNION ALL</span><span id="d54f" class="md me jj lz b gy mj mg l mh mi">SELECT 'Kale', 45, 'Q3', 2020 UNION ALL</span><span id="0ee9" class="md me jj lz b gy mj mg l mh mi">WITH sale AS (</span><span id="fe81" class="md me jj lz b gy mj mg l mh mi">Select 'Laptop' as Item, 'Miami' as City, 10 as No_of_Items, 'January' as Month UNION ALL</span><span id="94b4" class="md me jj lz b gy mj mg l mh mi">SELECT 'Mobile', 'Houston', 25, 'March' UNION ALL</span><span id="239e" class="md me jj lz b gy mj mg l mh mi">SELECT 'Laptop', 'Miami', 8, 'March' UNION ALL</span><span id="e8e5" class="md me jj lz b gy mj mg l mh mi">SELECT 'TV', 'Austin', 7, 'February' UNION ALL</span><span id="5192" class="md me jj lz b gy mj mg l mh mi">SELECT 'Mobile', 'Austin', 18, 'January' UNION ALL</span><span id="36e2" class="md me jj lz b gy mj mg l mh mi">SELECT 'Mobile', 'Miami', 22, 'June' UNION ALL</span><span id="ead4" class="md me jj lz b gy mj mg l mh mi">SELECT 'TV', 'Houston', 9, 'May' UNION ALL</span><span id="49bd" class="md me jj lz b gy mj mg l mh mi">SELECT 'Laptop', 'Austin', 11, 'April' UNION ALL</span><span id="e22c" class="md me jj lz b gy mj mg l mh mi">SELECT 'Mobile', 'Miami', 15, 'May')</span><span id="0729" class="md me jj lz b gy mj mg l mh mi">SELECT * from sale;</span></pre><figure class="lu lv lw lx gt iv gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/f59c96d5f9a15f3d6f731f1f2ca69ce4.png" data-original-src="https://miro.medium.com/v2/resize:fit:586/format:webp/1*sNVl9maxOWvVkIR1dmRR6g.png"/></div></figure><p id="347f" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">请随意将其保存为视图，以便在下面的示例中使用该表。否则，您需要在我们稍后使用的每个查询中使用这个“WITH”子句。</p><p id="d49b" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这里，我们将项目作为行。每行代表关于笔记本电脑、手机或电视的信息。如果您希望这些项目作为列，pivot函数会有所帮助。</p><p id="4f7d" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在第一个练习中，我们将使用“SUM”汇总每个项目的项目数，并将项目作为列:</p><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="f72b" class="md me jj lz b gy mf mg l mh mi">SELECT * FROM sale pivot(sum(No_of_Items) for Item in ('Laptop', 'Mobile', 'TV'));</span></pre><figure class="lu lv lw lx gt iv gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/e7aacade8c2cbea03f48cc47b01838f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:622/format:webp/1*LTvpT-JsEZGCi8ndv3nzGg.png"/></div></figure><p id="892e" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这里，我们的透视表列是No_of_Items和Items。pivot函数中没有提到另外两列(城市和月份)。因此，默认情况下，透视函数使用城市和月份列进行分组。</p><p id="ee2f" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">还可以使用另一个select语句来指定要透视的列和要分组的列。</p><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="7671" class="md me jj lz b gy mf mg l mh mi">select * from (select Item, No_of_Items, Month from sale)</span><span id="2f06" class="md me jj lz b gy mj mg l mh mi">pivot(sum(No_of_Items) for Item in ('Laptop', 'Mobile', 'TV'));</span></pre><figure class="lu lv lw lx gt iv gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/1462ab0b9efda7d93d2570cacae3c45d.png" data-original-src="https://miro.medium.com/v2/resize:fit:480/format:webp/1*6cRJPA2M3XZAaoNt1uc0yQ.png"/></div></figure><p id="a764" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这个查询中，我们使用select语句选择三列:Item、No_of_Items和Month。No_of_Items和Items用作pivot函数中的pivot列，而Month列仅用于分组，我们使用sum作为聚合函数。</p><p id="1a77" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们在项目栏中有三个项目:笔记本电脑、手机和电视。在前面的所有查询中，这三项都被转换为列。如有必要，您也可以排除某个项目。例如，您可以使用:</p><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="6cc7" class="md me jj lz b gy mf mg l mh mi">select * from (select Item, No_of_Items, Month from sale)</span><span id="3d48" class="md me jj lz b gy mj mg l mh mi">pivot(sum(No_of_Items) for Item in ('Laptop', 'Mobile'));</span></pre><p id="8b28" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">pivot函数中也可以使用多个聚合函数:</p><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="b625" class="md me jj lz b gy mf mg l mh mi">select * from (select No_of_Items, Item, City from sale)</span><span id="fb1d" class="md me jj lz b gy mj mg l mh mi">pivot(sum(No_of_Items) Total_num, AVG(No_of_Items) Avg_num</span><span id="faef" class="md me jj lz b gy mj mg l mh mi">for Item in ('Laptop', 'Mobile'))</span></pre><figure class="lu lv lw lx gt iv gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/668091d977f55e67749f4b2930213520.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*D2eQk1ky-jmqk3dH6_vjhw.png"/></div></figure><p id="904f" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这里我们使用“sum”和“average”作为聚合函数。注意我们在这里使用了一个别名。当您想要使用多个聚合函数时，pivot函数会要求别名。</p><h2 id="990d" class="md me jj bd mo mp mq dn mr ms mt dp mu lh mv mw mx ll my mz na lp nb nc nd ne bi translated">让我们拆开</h2><p id="6a85" class="pw-post-body-paragraph ky kz jj la b lb nf kk ld le ng kn lg lh nh lj lk ll ni ln lo lp nj lr ls lt im bi translated">在大型查询环境中，还有一个unpivot函数，它的作用正好相反。现在让我们以另一种方式制作数据集:</p><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="6f7f" class="md me jj lz b gy mf mg l mh mi">WITH sale AS (</span><span id="810b" class="md me jj lz b gy mj mg l mh mi">Select 'January' as Month, 31 as Laptop, 42 as TV, 75 as Mobile UNION ALL</span><span id="5e80" class="md me jj lz b gy mj mg l mh mi">select 'February', 35, 34, 61 UNION ALL</span><span id="63dd" class="md me jj lz b gy mj mg l mh mi">select 'March', 23, 23, 66 UNION ALL</span><span id="c244" class="md me jj lz b gy mj mg l mh mi">select 'April', 29, 25, 55</span><span id="c3db" class="md me jj lz b gy mj mg l mh mi">)</span><span id="eff3" class="md me jj lz b gy mj mg l mh mi">select * from sale;</span></pre><figure class="lu lv lw lx gt iv gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/33ad400f4c090a93d2bbbb24af783636.png" data-original-src="https://miro.medium.com/v2/resize:fit:452/format:webp/1*RQSQ1jJoLkEjdzpyJBdK2Q.png"/></div></figure><p id="8984" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这次我们使用笔记本电脑、电视和手机的数量作为列。让我们把它们排成行:</p><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="2d84" class="md me jj lz b gy mf mg l mh mi">select * from sale</span><span id="6f21" class="md me jj lz b gy mj mg l mh mi">unpivot(Sales_No for Items in (Laptop, TV, Mobile))</span></pre><figure class="lu lv lw lx gt iv gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/1ebf82c5a51c824b90309101b0a9c618.png" data-original-src="https://miro.medium.com/v2/resize:fit:416/format:webp/1*s4Ek0SrO4mMi2F3O9SUYKg.png"/></div></figure><p id="72e8" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">注意，它是如何重新排列的。你可以更进一步。我将用另外一张表重新创建该表:</p><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="630a" class="md me jj lz b gy mf mg l mh mi">WITH sale AS (</span><span id="24c4" class="md me jj lz b gy mj mg l mh mi">Select 'January' as Month, 31 as Laptop, 42 as TV,</span><span id="7f63" class="md me jj lz b gy mj mg l mh mi">75 as Mobile, 58 as Tablet UNION ALL</span><span id="a51e" class="md me jj lz b gy mj mg l mh mi">select 'February', 35, 34, 61, 73 UNION ALL</span><span id="c783" class="md me jj lz b gy mj mg l mh mi">select 'March', 23, 23, 66, 63 UNION ALL</span><span id="3d9b" class="md me jj lz b gy mj mg l mh mi">select 'April', 29, 25, 55, 45</span><span id="4b64" class="md me jj lz b gy mj mg l mh mi">)</span><span id="2ae7" class="md me jj lz b gy mj mg l mh mi">select * from sale</span><span id="e6ed" class="md me jj lz b gy mj mg l mh mi">unpivot(</span><span id="d6b4" class="md me jj lz b gy mj mg l mh mi">(Category1, Category2)</span><span id="4317" class="md me jj lz b gy mj mg l mh mi">for Series</span><span id="b102" class="md me jj lz b gy mj mg l mh mi">in ((Laptop, TV) as 'S1', (Tablet, Mobile) as 'S2')</span><span id="2a05" class="md me jj lz b gy mj mg l mh mi">)</span></pre><figure class="lu lv lw lx gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nm"><img src="../Images/3c2586c5b11f4fc45457384c287e2826.png" data-original-src="https://miro.medium.com/v2/resize:fit:556/format:webp/1*RgmsgVgnDBYTVAg6lTj3UA.png"/></div></div></figure><p id="dc48" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在我们有四样东西:笔记本电脑、手机、电视和平板电脑。我想把它们分成两类。类别1和类别2成为两列。同时，我们将它们分为两个系列，并以行的形式显示。我不得不再添加一项，因为当我们将它们分为两类时，我们需要每个类别中相同数量的列。</p><h2 id="15b3" class="md me jj bd mo mp mq dn mr ms mt dp mu lh mv mw mx ll my mz na lp nb nc nd ne bi translated">结论</h2><p id="27dd" class="pw-post-body-paragraph ky kz jj la b lb nf kk ld le ng kn lg lh nh lj lk ll ni ln lo lp nj lr ls lt im bi translated">不使用Pivot和Unpivot函数也可以达到同样的效果。但那将是一段漫长的路。这两个函数可以在必要时使您的查询更简短、更优雅。</p><h2 id="4e33" class="md me jj bd mo mp mq dn mr ms mt dp mu lh mv mw mx ll my mz na lp nb nc nd ne bi translated">更多阅读:</h2><div class="is it gp gr iu nn"><a rel="noopener follow" target="_blank" href="/precision-recall-and-f1-score-of-multiclass-classification-learn-in-depth-6c194b217629"><div class="no ab fo"><div class="np ab nq cl cj nr"><h2 class="bd jk gy z fp ns fr fs nt fu fw ji bi translated">多类分类的精确度、召回率和F1分数—深入学习</h2><div class="nu l"><h3 class="bd b gy z fp ns fr fs nt fu fw dk translated">从混淆矩阵手动计算和sklearn库的语法</h3></div><div class="nv l"><p class="bd b dl z fp ns fr fs nt fu fw dk translated">towardsdatascience.com</p></div></div><div class="nw l"><div class="nx l ny nz oa nw ob ja nn"/></div></div></a></div><div class="is it gp gr iu nn"><a rel="noopener follow" target="_blank" href="/complete-explanation-on-sql-joins-and-unions-with-examples-in-postgresql-cbd868fe9e95"><div class="no ab fo"><div class="np ab nq cl cj nr"><h2 class="bd jk gy z fp ns fr fs nt fu fw ji bi translated">用PostgreSQL中的例子完整解释SQL连接和联合</h2><div class="nu l"><h3 class="bd b gy z fp ns fr fs nt fu fw dk translated">所有常用的连接类型和一些有趣的类型</h3></div><div class="nv l"><p class="bd b dl z fp ns fr fs nt fu fw dk translated">towardsdatascience.com</p></div></div><div class="nw l"><div class="oc l ny nz oa nw ob ja nn"/></div></div></a></div><div class="is it gp gr iu nn"><a href="https://pub.towardsai.net/an-overview-of-the-major-sql-query-clauses-and-most-commonly-used-functions-60720e2a20d7" rel="noopener  ugc nofollow" target="_blank"><div class="no ab fo"><div class="np ab nq cl cj nr"><h2 class="bd jk gy z fp ns fr fs nt fu fw ji bi translated">SQL查询子句和函数概述</h2><div class="nu l"><h3 class="bd b gy z fp ns fr fs nt fu fw dk translated">可以用作SQL的备忘单</h3></div><div class="nv l"><p class="bd b dl z fp ns fr fs nt fu fw dk translated">pub.towardsai.net</p></div></div><div class="nw l"><div class="od l ny nz oa nw ob ja nn"/></div></div></a></div><div class="is it gp gr iu nn"><a rel="noopener follow" target="_blank" href="/regression-in-tensorflow-using-both-sequential-and-function-apis-314e74b537ca"><div class="no ab fo"><div class="np ab nq cl cj nr"><h2 class="bd jk gy z fp ns fr fs nt fu fw ji bi translated">TensorFlow中使用顺序API和函数API的回归</h2><div class="nu l"><h3 class="bd b gy z fp ns fr fs nt fu fw dk translated">演示几种不同类型的模型结构</h3></div><div class="nv l"><p class="bd b dl z fp ns fr fs nt fu fw dk translated">towardsdatascience.com</p></div></div><div class="nw l"><div class="oe l ny nz oa nw ob ja nn"/></div></div></a></div><div class="is it gp gr iu nn"><a href="https://pub.towardsai.net/data-analysis-91a38207c92b" rel="noopener  ugc nofollow" target="_blank"><div class="no ab fo"><div class="np ab nq cl cj nr"><h2 class="bd jk gy z fp ns fr fs nt fu fw ji bi translated">数据分析</h2><div class="nu l"><h3 class="bd b gy z fp ns fr fs nt fu fw dk translated">Python中数据科学家/分析师日常工作中的常见数据清理任务</h3></div><div class="nv l"><p class="bd b dl z fp ns fr fs nt fu fw dk translated">pub.towardsai.net</p></div></div><div class="nw l"><div class="of l ny nz oa nw ob ja nn"/></div></div></a></div></div></div>    
</body>
</html>