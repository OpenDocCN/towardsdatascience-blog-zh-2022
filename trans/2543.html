<html>
<head>
<title>Deconfounding like a pro with DoWhy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">像专业人士一样和DoWhy解除关系</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deconfounding-like-a-pro-with-dowhy-c7e03fa03a3f#2022-06-02">https://towardsdatascience.com/deconfounding-like-a-pro-with-dowhy-c7e03fa03a3f#2022-06-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="8b21" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">因果分析帮助你解决很多关键的决策问题。许多开源框架都来帮忙了，微软的DoWhy是最有前途的一个。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/5d7b1b7fd0e319dfc165d4af2e230d58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ABYVgak5ZbrUe5xi"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae kv" href="https://unsplash.com/@nadir_syzygy?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Nadir sYzYgY </a>拍摄的照片</p></figure><p id="8e6b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" rel="noopener" target="_blank" href="/a-gentle-intro-to-causality-in-a-business-setting-4285aee4b83">在之前的一篇文章</a>中，我提出了因果关系的理由，奠定了一些理论基础，并认为对因果机制的深刻理解应该成为每个数据科学家通过数据做出关键决策的工具。</p><p id="1c58" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因果推断分析通常需要绘制一张什么可能导致什么的图表，识别<a class="ae kv" href="https://en.wikipedia.org/wiki/Confounding" rel="noopener ugc nofollow" target="_blank">混杂因素</a>，并对其进行分层，以发现治疗对结果的影响。这样做可以让你远离虚假的相关性和荒谬的主张。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ls"><img src="../Images/048e64f3d191e54c1a782c6b690d3c37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a9Oz_qfwvPJ192wyrHwaew.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图1 —来自<a class="ae kv" href="https://www.tylervigen.com/spurious-correlations" rel="noopener ugc nofollow" target="_blank">https://www.tylervigen.com/spurious-correlations</a>。人造黄油主要消费量和人均消费量之间似乎有因果关系，但事实上并非如此。</p></figure><p id="32b5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，找到正确的混杂因素，即影响治疗和结果的因素，是解决因果关系的关键。</p><p id="c0dd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">DoWhy是最强大的库之一，由微软研究团队完全开源。5月31日，亚马逊科学与微软联手创建了一个更广泛的因果分析生态系统，名为PyWhy，增强了技术和数据科学界对简化该领域的巨大兴趣。下面是公告。</p><p id="6501" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，我将用一个真实的案例场景(出于显而易见的原因，使用假数据)来简要介绍它的潜力。</p><h2 id="1730" class="lt lu iq bd lv lw lx dn ly lz ma dp mb lf mc md me lj mf mg mh ln mi mj mk ml bi translated">DoWhy底漆</h2><p id="c7fb" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">用例是衡量一个媒体公司中增加流媒体数量的活动的实际影响。假设不可能为一项试验抽取一个随机对照组，那么唯一可能的测量方法就是通过观察研究。我们可以通过比较目标群体与所有因为未同意联系而未包括在活动中的客户来衡量活动的结果。</p><p id="10c2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">第一步是将问题构建成有向无环图(DAG)。DoWhy既支持<em class="mr"> gml </em>又支持<em class="mr">点</em>格式，我在这里使用的就是这两种格式。我初始化一个有向图，然后设置节点和边。我选择了一个平凡的用例，但是这些图会很快变得复杂。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="b290" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">用Graphviz打印图表后，我们可以识别两个混杂因素。社会人口统计聚类可能会影响治疗，因为一些群体可能更倾向于同意联系并参与活动，但也可能直接影响流的数量。对于活动前的流数量也可以进行同样的考虑。为了衡量治疗(活动)如何偶然影响接受治疗的客户的平均流媒体数量，有必要控制<em class="mr">集群</em>和<em class="mr">流媒体_pre。</em>在随意推理的行话中，这被称为<strong class="ky ir">阻塞从变量到结果的后门路径</strong>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/4849e85c483b66396a69f5032da540bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:628/format:webp/1*xcwCMHYRtrieTpSDGjlQlQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图2 —因果图。作者图片</p></figure><p id="476d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在下面的步骤中，我为不同的客户使用不同的正态分布组合来生成一些假数据。在现实世界中，您几乎不会看到客户的行为可以用高斯钟形曲线来建模，但是对于这个示例来说，这就足够了。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="130d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上面的代码生成了下面这个非常简单的数据集。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/cf33a2075a1a517976d27dd39223ba0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1058/format:webp/1*XxbRReAnMMAfKIH4m9xcag.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图3 —合成数据集。作者图片</p></figure><p id="4bb1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在进行分析之前，我们可以观察到营销活动后的平均流差异为2.5，但这一差异中有多大一部分归因于营销活动？</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/10ef3539672e86060cb4dce7400ee38a.png" data-original-src="https://miro.medium.com/v2/resize:fit:514/format:webp/1*e47qy7osTETnkOonFBFl2A.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图4 —活动后按客户划分的平均流。作者图片</p></figure><p id="8a63" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有了手头的数据，我们现在可以从工具箱中取出DoWhy了。我通过传递用Graphviz定义的图来初始化因果模型(注意删除示例中显示的制表符和换行符),并指定目标和结果变量。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="de44" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以继续确定一个估计量，这是我们需要控制的变量，以便计算因果效应。这就是道威通过从上面定义的DAG推断来施展他的魔法的地方。</p><p id="42fb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来的步骤是实际的评估，软件包提供了许多方法。我在这里选择了倾向得分分层，其中DoWhy计算了每个虚假客户的治疗倾向，然后根据该得分将每个客户分配到一个阶层，并计算目标群体和对照组之间在活动后的结果差异。这应该足以抵消假设的混杂因素的影响。<strong class="ky ir">我们基本上是在比较非常相似的群体，其中相似性是通过分享对活动的相同倾向来给出的。</strong></p><p id="7484" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">目标单位是被治疗者的平均治疗效果(att ),因为在这种情况下，我只对参加活动的人的效果感兴趣。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="c233" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最终的因果估计值是活动产生的平均<strong class="ky ir"> 1.92 </strong>个流，低于最初分析的<strong class="ky ir"> 2.5 </strong>个流。这两个值之间的差异可以解释为客户的惯性行为，不管活动如何，我们都会看到这一点。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/ce1378f7b29962858d88aaa5e8e77e08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1316/format:webp/1*w8X_i2QqIfRhKa2ng6-EDA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图5 —估计效果方法的输出。作者图片</p></figure><p id="359c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对我们分析的正确性的最后检查是通过一个反驳测试，使用安慰剂治疗。这里我们用一个随机值代替治疗变量，重新计算效果。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="db56" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，新效果的值应该为0，其概率高于阈值(p值)。在这种情况下会发生！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi my"><img src="../Images/d2b822274dd311bbb9b2b212a9f30597.png" data-original-src="https://miro.medium.com/v2/resize:fit:740/format:webp/1*nFkvb2ILTLsSll6Ftpn6Ow.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图6 —反驳输出。作者图片</p></figure><p id="f941" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，我们可以通过倾向水平来形象化提升。DoWhy向初始数据集添加了一些变量。特别是倾向分数和阶层。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mz"><img src="../Images/2c1ff5a04ea8c79e6cc571b4bf714488.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9eQb1wV7b0AxazRGWsm2yA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图7 —初始数据集的额外属性。作者图片</p></figure><p id="898e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">按阶层比较运动前治疗组和对照组的分组，我们可以看到橙色曲线如何在不同阶层一致地向上移动。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi na"><img src="../Images/a6c47be7934e7ff879ed6e67d8ec021e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n5yqgdmzbZNBggbAHJ6a4g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图8。—按阶层划分的活动前流。作者图片</p></figure><p id="e7c3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这为该活动如何影响所有倾向群体提供了一些额外的视觉洞察。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nb"><img src="../Images/020c5b75aa99a39c430f16ad30420a4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LewEna95qEnlaqI7D0HOvg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图九。—按阶层划分的活动后流。作者图片</p></figure><p id="c834" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我只是用一个小例子触及了解开因果关系的潜在可能性的表面。与ALICE项目(因果关系和经济学的自动学习和智能)的<a class="ae kv" href="https://github.com/microsoft/EconML" rel="noopener ugc nofollow" target="_blank"> EconMl库</a>的集成以及最近与亚马逊的合作极大地扩展了它的功能。看到因果关系将如何有助于向人工智能进军将是令人兴奋的。</p><p id="1340" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">注:</strong>本笔记本中的代码也可在<a class="ae kv" href="https://colab.research.google.com/drive/1yabfh8826W0FMLKFRD12OHBIP8oU1QeM#scrollTo=_3q0uqyWf8lf" rel="noopener ugc nofollow" target="_blank">本笔记本中找到</a>:</p></div></div>    
</body>
</html>