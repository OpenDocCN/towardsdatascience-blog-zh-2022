<html>
<head>
<title>BigQuery SQL: Evolution of the running total on a dataset with missing dates</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">BigQuery SQL:带有缺失日期的数据集上运行总数的演变</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/bigquery-sql-evolution-of-the-running-total-on-a-dataset-with-missing-dates-44b6d22f7d20#2022-06-15">https://towardsdatascience.com/bigquery-sql-evolution-of-the-running-total-on-a-dataset-with-missing-dates-44b6d22f7d20#2022-06-15</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="03bd" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">用BigQuery SQL处理缺失值、窗口函数和嵌套查询</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj kg"><img src="../Images/e2cd4c644f1f883e167c7835f854e9d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Fd-h0NAuF3146Ipw"/></div></div><p class="ks kt gk gi gj ku kv bd b be z dk translated">托德·迪默在<a class="ae kw" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="7cdf" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">我们的数据和分析团队最近收到了一个问题:<strong class="kz is">“今年迄今为止，每家商店列出的商品数量是多少，这个数字是如何演变的？”</strong></p><p id="4c68" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">找到今年迄今为止列出的文章总数并不是一项复杂的分析任务。然而，当我们想展示这个数字是如何随着时间的推移而增加时，问题就出现了。</p><p id="7f93" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">原因是源数据集中的<strong class="kz is">缺少值</strong>。换句话说，在保存每个特定商店新列出的商品条目的数据集中，我们没有每个日期 <strong class="kz is">的<strong class="kz is">记录。</strong></strong></p><p id="40cc" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">这是挑战开始的地方。</p><p id="7654" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">首先，我们需要弄清楚<strong class="kz is">如何为每个商店填充缺失的日期</strong>。在此步骤之后，<strong class="kz is">需要对每个日期和商店组合的缺失值</strong>进行正向填充。最后，作为最后一步，必须计算<strong class="kz is">运行总数</strong>。</p><p id="089c" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">在花了一些时间研究和挖掘BigQuery SQL教程之后，我们找到了一个简单的解决方案。</p><p id="a872" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">现在，我们将与您分享我们的实施方法。</p><p id="20ed" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">如果您使用<strong class="kz is"> BigQuery </strong>，解决方案是几个步骤，或者更好地说是几个嵌套查询<strong class="kz is">。:)</strong></p><h1 id="3ae5" class="lt lu ir bd lv lw lx ly lz ma mb mc md jx me jy mf ka mg kb mh kd mi ke mj mk bi translated"><strong class="ak">问题解释:从源到目标</strong></h1><p id="0faf" class="pw-post-body-paragraph kx ky ir kz b la ml js lc ld mm jv lf lg mn li lj lk mo lm ln lo mp lq lr ls ik bi translated">让我们以<strong class="kz is">视觉形式呈现问题，即源数据看起来如何，预期结果是什么</strong>。</p><p id="854b" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">对于图形表示，我们使用<a class="ae kw" href="https://www.looker.com/" rel="noopener ugc nofollow" target="_blank"> Looker </a>在时序图上显示源记录和目标结果的样本。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj mq"><img src="../Images/2d43d0284fae656ae2df644cf9367a81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DN--Se9fbGbjvHH03G_D0A.png"/></div></div><p class="ks kt gk gi gj ku kv bd b be z dk translated">源数据集中记录的时间序列表示和预期结果[图片由作者提供]</p></figure><p id="561f" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">从上图的第一部分(<strong class="kz is">源数据集</strong>)可以看出，在所选的日期范围内，我们遗漏了每个商店级别的日期和相应的数值。</p><p id="39f4" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">因此，我们将我们的解决方案分为三个步骤来实现<strong class="kz is">目标结果</strong>，并计算在<code class="fe mr ms mt mu b">article_online_since_date</code>日期和每个分区<code class="fe mr ms mt mu b">shop</code>的度量<code class="fe mr ms mt mu b">new_article_count</code>的运行总数。</p><h1 id="3b24" class="lt lu ir bd lv lw lx ly lz ma mb mc md jx me jy mf ka mg kb mh kd mi ke mj mk bi translated">自下而上的实现方法</h1><p id="b563" class="pw-post-body-paragraph kx ky ir kz b la ml js lc ld mm jv lf lg mn li lj lk mo lm ln lo mp lq lr ls ik bi translated">首先，通过以下查询，我们能够创建虚拟输入数据集:</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="mv mw l"/></div></figure><p id="04eb" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">查询的结果是:</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj mx"><img src="../Images/66f1a3402760da15d71536487fe8526e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-4gHFiOY-21sX4kYo-QpDA.png"/></div></div></figure><p id="0166" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">有了输入表<code class="fe mr ms mt mu b">ListedArticlesPerShop</code>，我们就可以开始研究自下而上的解决方案来<strong class="kz is">计算每个商店一段时间内的运行总数。</strong></p><p id="3613" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated"><strong class="kz is">步骤#1:填写每个分区(车间)缺少的日期范围</strong></p><p id="8698" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">BigQuery SQL提供了一个简洁的<a class="ae kw" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/array_functions#generate_date_array" rel="noopener ugc nofollow" target="_blank">数组函数</a> <code class="fe mr ms mt mu b">GENERATE_DATE_ARAY</code>，您可以在其中指定以下输入[1]:</p><ul class=""><li id="5c84" class="my mz ir kz b la lb ld le lg na lk nb lo nc ls nd ne nf ng bi translated"><code class="fe mr ms mt mu b">start_date</code> —必须是日期</li><li id="ea5f" class="my mz ir kz b la nh ld ni lg nj lk nk lo nl ls nd ne nf ng bi translated"><code class="fe mr ms mt mu b">end_date</code> —必须是日期</li><li id="3963" class="my mz ir kz b la nh ld ni lg nj lk nk lo nl ls nd ne nf ng bi translated"><code class="fe mr ms mt mu b">INT64_expr</code> —确定用于生成日期的增量的参数；该参数的默认值是一天</li><li id="b55e" class="my mz ir kz b la nh ld ni lg nj lk nk lo nl ls nd ne nf ng bi translated"><code class="fe mr ms mt mu b">date_part</code> —必须是日、周、月、季或年。</li></ul><p id="828a" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">通过<code class="fe mr ms mt mu b">GENERATE_ARRAY</code>功能，我们能够创建一个包含每个商店完整日期范围的表格:</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="mv mw l"/></div></figure><p id="6ef2" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">查询的结果如下:</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div class="gi gj nm"><img src="../Images/2a3840ec9c1492f088c4a1a057486c0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:616/0*0cETlBMiUtpBhKFt"/></div></figure><p id="03df" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">成功完成步骤#1后，我们现在可以将新创建的查询连接到输入表<code class="fe mr ms mt mu b">ListedArticlesPerShop</code>。</p><p id="e4dd" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated"><strong class="kz is">步骤#2:将填充了日期范围的表连接到缺少日期范围的输入表</strong><strong class="kz is"/></p><p id="bd05" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">这一步很简单，因为任务是:</p><ul class=""><li id="6067" class="my mz ir kz b la lb ld le lg na lk nb lo nc ls nd ne nf ng bi translated">使用<code class="fe mr ms mt mu b"><strong class="kz is">LEFT JOIN</strong></code>类型连接两个表，和</li><li id="3e0d" class="my mz ir kz b la nh ld ni lg nj lk nk lo nl ls nd ne nf ng bi translated">从每个表中选择相应的属性；<code class="fe mr ms mt mu b"><strong class="kz is">table_a</strong></code>中的<code class="fe mr ms mt mu b">ascending_date</code>和<code class="fe mr ms mt mu b">shop</code>，以及<code class="fe mr ms mt mu b"><strong class="kz is">table_b</strong></code>中的<code class="fe mr ms mt mu b">new_article_count</code>(现在别名为<code class="fe mr ms mt mu b">number_of_listed_articles</code>)。</li></ul><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="mv mw l"/></div></figure><p id="90c4" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">成功完成这部分任务后，我们现在可以计算运行总数了。</p><p id="52d1" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated"><strong class="kz is">第3步:计算每个分区(车间)的总运行时间</strong></p><p id="8487" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">运行总数是使用顶部查询中的<a class="ae kw" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/window-function-calls#compute_a_grand_total" rel="noopener ugc nofollow" target="_blank">窗口函数</a>计算的:</p><p id="0508" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated"><code class="fe mr ms mt mu b">SUM (number_of_listed_articles) OVER (PARTITION BY shop) ORDER BY (ascending_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)</code></p><p id="89e4" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">现在，让我们一起来呈现<strong class="kz is">热门查询</strong>:</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="mv mw l"/></div></figure><p id="c8bb" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">最终的查询结果如下:</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj nn"><img src="../Images/36d2edb5aefbc9e7d5b1a0d187624e4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rnzMhkpIlb7KBD6x"/></div></div></figure><p id="f7c5" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">随着这最后一步，我们成功地结束了我们的任务。:)</p><h1 id="93b1" class="lt lu ir bd lv lw lx ly lz ma mb mc md jx me jy mf ka mg kb mh kd mi ke mj mk bi translated">摘要</h1><p id="6bdb" class="pw-post-body-paragraph kx ky ir kz b la ml js lc ld mm jv lf lg mn li lj lk mo lm ln lo mp lq lr ls ik bi translated">在本文中，我们展示了如何仅使用BigQuery SQL 来填充缺失值，并计算特定指标随时间和每个特定分区的演变模式。</p><p id="fdc7" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">我们还介绍了如何组合不同的<strong class="kz is"> BigQuery函数</strong> : <a class="ae kw" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/array_functions" rel="noopener ugc nofollow" target="_blank">窗口</a>和<a class="ae kw" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/array_functions" rel="noopener ugc nofollow" target="_blank">数组函数</a>，以解决复杂的分析任务并提供所需的数据洞察。</p><p id="2439" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">最后，我们希望你会喜欢我们的教程，并在你的用例中找到它的用法。:)</p></div><div class="ab cl no np hv nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="ik il im in io"><p id="0911" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated"><strong class="kz is">参考文献:</strong></p><p id="3719" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">[1] BigQuery SQL文档，访问时间:2022年6月3日，<a class="ae kw" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/array_functions#generate_date_array" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/big query/docs/reference/standard-SQL/array _ functions # generate _ date _ array</a></p></div></div>    
</body>
</html>