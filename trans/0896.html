<html>
<head>
<title>Website visitor forecast with Facebook Prophet: A Complete Tutorial</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">网站访客预测与脸书先知:完整教程</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/website-visitor-forecast-with-facebook-prophet-a-complete-tutorial-1d0a5bcd1f8f#2022-03-10">https://towardsdatascience.com/website-visitor-forecast-with-facebook-prophet-a-complete-tutorial-1d0a5bcd1f8f#2022-03-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="fe97" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">安装说明、数据、参数调整以及简单和复杂的预测—第 2 部分</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/52c1eb82d0660a5175cfd44414083ac1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-FUoQvBWZIIA1Pwol-JAaQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">卢克·房龙在<a class="ae kv" href="https://unsplash.com/s/photos/pit?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="0e19" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是<a class="ae kv" rel="noopener" target="_blank" href="/real-world-website-visitor-forecast-with-facebook-prophet-a-complete-tutorial-8d135b848c5e">教程的第 2 部分——用脸书预言家 2022 的所有教程进行网站访客预测(</a>安装说明、数据、参数调整，以及简单的&amp;复杂预测)。</p><p id="8dc1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" rel="noopener" target="_blank" href="/real-world-website-visitor-forecast-with-facebook-prophet-a-complete-tutorial-8d135b848c5e">原文</a>封面，</p><ol class=""><li id="ce88" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated"><a class="ae kv" rel="noopener" target="_blank" href="/real-world-website-visitor-forecast-with-facebook-prophet-a-complete-tutorial-8d135b848c5e"> <strong class="ky ir">安装先知</strong> </a></li><li id="7baa" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><a class="ae kv" rel="noopener" target="_blank" href="/real-world-website-visitor-forecast-with-facebook-prophet-a-complete-tutorial-8d135b848c5e"> <strong class="ky ir">简单的 ETL，以及数据可视化</strong> </a></li><li id="60b6" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><a class="ae kv" rel="noopener" target="_blank" href="/real-world-website-visitor-forecast-with-facebook-prophet-a-complete-tutorial-8d135b848c5e"> <strong class="ky ir">简单预测(默认设置的预测)</strong> </a></li><li id="3744" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><a class="ae kv" rel="noopener" target="_blank" href="/website-visitor-forecast-with-facebook-prophet-a-complete-tutorial-1d0a5bcd1f8f"> <strong class="ky ir">预测与模型评估</strong> </a></li><li id="3aab" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><a class="ae kv" rel="noopener" target="_blank" href="/website-visitor-forecast-with-facebook-prophet-a-complete-tutorial-1d0a5bcd1f8f"> <strong class="ky ir">用调好的参数进行预测</strong> </a></li></ol><p id="ab4b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是，原文太长了。因此它现在被分成两部分——<a class="ae kv" rel="noopener" target="_blank" href="/real-world-website-visitor-forecast-with-facebook-prophet-a-complete-tutorial-8d135b848c5e">前 3 节在第 1 部分</a>中，而<a class="ae kv" rel="noopener" target="_blank" href="/website-visitor-forecast-with-facebook-prophet-a-complete-tutorial-1d0a5bcd1f8f">第 4 节</a>和<a class="ae kv" rel="noopener" target="_blank" href="/website-visitor-forecast-with-facebook-prophet-a-complete-tutorial-1d0a5bcd1f8f">第 5 节</a>在<a class="ae kv" rel="noopener" target="_blank" href="/website-visitor-forecast-with-facebook-prophet-a-complete-tutorial-1d0a5bcd1f8f">第 2 部分</a>中。如果您对安装和简单预测不感兴趣，请<a class="ae kv" rel="noopener" target="_blank" href="/website-visitor-forecast-with-facebook-prophet-a-complete-tutorial-1d0a5bcd1f8f">点击此处进入第 2 部分</a>。</p></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="f7db" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">4.利用模态评估进行预测</h1><p id="b058" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">评估模型的准确性对于创建机器学习模型来描述模型在预测中的表现至关重要。幸运的是，当评估我们的先知在预测中的表现时，我们可以采用一些常见而简单的评估标准。</p><h2 id="746e" class="nk mo iq bd mp nl nm dn mt nn no dp mx lf np nq mz lj nr ns nb ln nt nu nd nv bi translated">* MAE(平均绝对误差)</h2><ul class=""><li id="437a" class="ls lt iq ky b kz nf lc ng lf nw lj nx ln ny lr nz ly lz ma bi translated">对数据集上原始值(y)和预测值(yhat)之间的绝对差值求平均值。越小越好。</li></ul><h2 id="5cb1" class="nk mo iq bd mp nl nm dn mt nn no dp mx lf np nq mz lj nr ns nb ln nt nu nd nv bi translated">* MSE(均方误差)</h2><ul class=""><li id="0b73" class="ls lt iq ky b kz nf lc ng lf nw lj nx ln ny lr nz ly lz ma bi translated">对数据集上的原始值(y)和预测值(yhat)之间的平方差进行平均。这对于具有异常值的数据集来说是很好的，这将会受到这个度量的严重惩罚。同样，该值越小，模型越好。</li></ul><h2 id="3e3b" class="nk mo iq bd mp nl nm dn mt nn no dp mx lf np nq mz lj nr ns nb ln nt nu nd nv bi translated">* RMSE(均方根误差)</h2><ul class=""><li id="de53" class="ls lt iq ky b kz nf lc ng lf nw lj nx ln ny lr nz ly lz ma bi translated">就是取 MSE 的平方根。</li></ul><h2 id="e4be" class="nk mo iq bd mp nl nm dn mt nn no dp mx lf np nq mz lj nr ns nb ln nt nu nd nv bi translated">* R 平方(决定系数)</h2><ul class=""><li id="d2f8" class="ls lt iq ky b kz nf lc ng lf nw lj nx ln ny lr nz ly lz ma bi translated">模型解释被研究对象的程度的系数。它的值从 0 到 1。越大越好。</li></ul><pre class="kg kh ki kj gt oa ob oc od aw oe bi"><span id="5103" class="nk mo iq ob b gy of og l oh oi">def evaluate(y_true, y_pred):</span><span id="5357" class="nk mo iq ob b gy oj og l oh oi">dict = {</span><span id="bb8a" class="nk mo iq ob b gy oj og l oh oi">‘MAE’: mean_absolute_error(y_true, y_pred),</span><span id="18c4" class="nk mo iq ob b gy oj og l oh oi">‘MSE’: mean_squared_error(y_true, y_pred),</span><span id="a5f6" class="nk mo iq ob b gy oj og l oh oi">‘RMSE’: sqrt(mean_squared_error(y_true, y_pred)),</span><span id="a22a" class="nk mo iq ob b gy oj og l oh oi">‘R2’: r2_score(y_true, y_pred)</span><span id="c430" class="nk mo iq ob b gy oj og l oh oi">}</span><span id="378a" class="nk mo iq ob b gy oj og l oh oi">return dict</span></pre><p id="1018" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们的分析中，我们将只关注<strong class="ky ir"> MAE </strong>和<strong class="ky ir"> R 平方</strong>。但是我仍然会在代码中包含 MSE 和 RMSE。</p><p id="093a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我首先将数据集分成 2 份，一份用于训练和测试。</p><pre class="kg kh ki kj gt oa ob oc od aw oe bi"><span id="99a3" class="nk mo iq ob b gy of og l oh oi">test_len_assess = 8</span><span id="cdc6" class="nk mo iq ob b gy oj og l oh oi">train_df_assess = train_test_df_assess.iloc[:-test_len_assess, :]</span><span id="dfdd" class="nk mo iq ob b gy oj og l oh oi">test_df_assess = train_test_df_assess.iloc[int(-test_len_assess):, :]</span></pre><p id="6144" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">8 这个数字不是随机的。之前有读者问，为什么是 8 号？它是数据集的最后 10%除以 2。它是为了匹配本教程调优部分的数据集。</p><p id="342d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在让我们预测和评估我们的模型。</p><pre class="kg kh ki kj gt oa ob oc od aw oe bi"><span id="ab5e" class="nk mo iq ob b gy of og l oh oi">m = Prophet(interval_width=0.95, weekly_seasonality=False, daily_seasonality=False)</span><span id="9afc" class="nk mo iq ob b gy oj og l oh oi">m.add_country_holidays(country_name=’DE’)<br/>m.fit(train_df_assess)</span><span id="ed0e" class="nk mo iq ob b gy oj og l oh oi">predict_df_assess = m.predict(test_df_assess)</span><span id="4f6c" class="nk mo iq ob b gy oj og l oh oi">evaluate(test_df_assess[‘y’], predict_df_assess[‘yhat’])</span></pre><p id="d58e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">predict _ df _ assess 数据框架中有许多列。它们都是有意义的，但是超出了本教程的范围。我会解释更多，如果我有另一篇文章。<strong class="ky ir">请在 Medium 上关注我，了解我的最新数据科学文章。</strong>你的追随和喜欢是我坚持写作的巨大动力。</p><p id="5e8e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本教程中，我们将只关注数据框最后一列中的 yhat。没有科学的评估，Prophet 的默认参数模型总是看起来很好。现在我们可以看到它有 60%的解释力。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/69a47305794be33dc32b1094f0ed63fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1036/format:webp/1*kZ9AQRE6gPybov-1ufP5KA.jpeg"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">其余仅为 0.6。一点也不令人印象深刻。作者图片</p></figure><p id="4e21" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">将我们的结果和预测部分可视化。</p><pre class="kg kh ki kj gt oa ob oc od aw oe bi"><span id="6c19" class="nk mo iq ob b gy of og l oh oi">plot_measure = m.plot(predict_df_assess)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ol"><img src="../Images/dda19dbb2a9b526ad0e7c3795ea072d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MMiZKIXy2CCB3BHkcbfsMg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">蓝色部分是这个未经调整的脸书先知模型的测试部分。作者图片</p></figure><p id="014c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们用这个评估模型来预测未来。</p><pre class="kg kh ki kj gt oa ob oc od aw oe bi"><span id="62bb" class="nk mo iq ob b gy of og l oh oi">future_assess_input = m.make_future_dataframe(periods=60,freq=’W’)</span><span id="9d61" class="nk mo iq ob b gy oj og l oh oi">future_assess_output = m.predict(future_assess_input)</span><span id="546f" class="nk mo iq ob b gy oj og l oh oi">plot_assess = m.plot(future_assess_output)</span></pre><p id="ce65" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你可以看到这个模型在训练时少了八行；这就是为什么预测与上一节中的简单预测模型略有不同，后者多了八行。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ol"><img src="../Images/6f651b2d812a869acf44f151351a7010.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5z16161N5ntTxNZliryv3w.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="9279" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">5.使用 Optuna 优化</h1><p id="2c50" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">Optuna 是一个自动超参数优化软件框架，主要用于机器学习。Optuna 的用户可以很容易地动态构造超参数的搜索空间。</p><p id="c58f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我仍然不是这个图书馆的专家。如需了解更多信息，请点击此处:(https://optuna . readthe docs . io/en/stable/index . html)</p><p id="c80c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在深入参数调优之前，让我们先深入了解一下参数。</p><p id="079b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Prophet 模型有几个可以考虑调整的输入参数。一开始，这些参数有点让人不知所措。但是，盲调并不理想。因此，需要事先了解参数。这里有一些关于超参数调优的一般性建议，可能是一个很好的起点。</p><ul class=""><li id="a54e" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr nz ly lz ma bi translated"><strong class="ky ir">变化点</strong></li></ul><p id="ee2b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">变化点是趋势发生变化的点。默认情况下，<strong class="ky ir"> n_changepoints </strong>，代表“变化点数量”，有 25 个变化点。<strong class="ky ir"> changepoint_prior_scale </strong>控制变化的幅度。如果发现趋势变化过拟合(弹性过大)，可以加大；或者如果它不合适(没有足够的灵活性)，则减小它。默认值为 0.05。</p><p id="2d57" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通常不建议你调优<strong class="ky ir"> n_changepoints </strong>。根据我的经验，调整<strong class="ky ir">季节性 _ 先验 _ 规模</strong>可能会更有效。</p><ul class=""><li id="29d5" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr nz ly lz ma bi translated"><strong class="ky ir">改变点 _ 范围</strong></li></ul><p id="2c72" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这基本上是当 Prophet 设置<strong class="ky ir"> change_point </strong>时将考虑多少数据。默认值为 0.8，这意味着只对时间序列的前 80%推断变点，以便有足够的时间预测未来趋势，并避免时间序列结束时的过度拟合波动。我的经验是，0.8 左右的数字，例如 0.82、0.70，就能很好地完成工作。</p><ul class=""><li id="3266" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr nz ly lz ma bi translated"><strong class="ky ir">成长</strong></li></ul><p id="2194" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是一个非常棘手的参数。选项有“线性”和“逻辑”。我建议，只有当你知道你的数据将在你的预测期内饱和时，才把它改为逻辑。如果不是，保持简单，保持线性。因为 Prophet 会尽最大努力让你的未来预测在包含期内朝着这个饱和点移动。</p><p id="3a61" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您非常清楚您的数据正在达到这个饱和点，例如，您确定在未来几个月您的网站将有 1000 个访问者，您可以在此处选择逻辑并在您的数据框中包括“上限”和“下限”值。</p><ul class=""><li id="3bc6" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr nz ly lz ma bi translated"><strong class="ky ir">季节性 _ 模式</strong></li></ul><p id="5893" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">选项有['加法'，'乘法']。默认为‘相加’，但很多业务时间序列会有相乘的季节性。最好通过观察时间序列来确定这一点，看看季节性波动的幅度是否随着时间序列的幅度而增长。我的经验是，默认的添加剂大多数时候符合我的需要。</p><ul class=""><li id="43ac" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr nz ly lz ma bi translated"><strong class="ky ir">季节性 _ 先验 _ 规模</strong></li></ul><p id="3e5f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该参数控制季节性的灵活性。类似地，一个显著的值允许季节性适应大的波动；较小的值会缩小季节性的幅度。默认值为 10。合理的调整范围可能是[0.01，10]。</p><ul class=""><li id="8f22" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr nz ly lz ma bi translated"><strong class="ky ir">节假日 _ 事前 _ 规模</strong></li></ul><p id="c136" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这控制了适应假日效果的灵活性。类似于<strong class="ky ir">季节性 _ 先验 _ 规模</strong>，默认为 10。合理的调整范围可能是[0.01，10]。</p><ul class=""><li id="4158" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr nz ly lz ma bi translated"><strong class="ky ir">每年 _ 季节性</strong></li></ul><p id="fe9b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">默认情况下，它是“自动”。“真”将打开年度季节性，否则为“假”。选项有['自动'，真，假]。</p><p id="8c59" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因为我们有每周数据，没有每天或每小时的数据，所以我们不会应用每周季节性和每天季节性参数。</p><p id="99bd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如上所述，我们将从主数据集中分离出一个数据框，尤其是用于验证的数据框。</p><pre class="kg kh ki kj gt oa ob oc od aw oe bi"><span id="d536" class="nk mo iq ob b gy of og l oh oi">test_len_tun = int(train_test_df_tun.shape[0] / 10) # take only 1/10 as the test size</span><span id="cd42" class="nk mo iq ob b gy oj og l oh oi">train_df_tun = train_test_df_tun.iloc[:-test_len_tun, :]</span><span id="ee05" class="nk mo iq ob b gy oj og l oh oi">val_df_tun = train_test_df_tun.iloc[-test_len_tun:int(-test_len_tun/2), :] # within the test pool, the first half is taken for validation</span><span id="4559" class="nk mo iq ob b gy oj og l oh oi">test_df_tun = train_test_df_tun.iloc[int(-test_len_tun/2):, :] # only the final half of the test pool is for the test</span></pre><p id="9524" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后我们创建一个名为<strong class="ky ir"> find_params </strong>的函数，用 Optuna 库寻找最佳参数。</p><pre class="kg kh ki kj gt oa ob oc od aw oe bi"><span id="077a" class="nk mo iq ob b gy of og l oh oi">def find_params(trial):</span><span id="32d9" class="nk mo iq ob b gy oj og l oh oi">parameters = {</span><span id="e132" class="nk mo iq ob b gy oj og l oh oi">‘changepoint_prior_scale’: trial.suggest_float(‘changepoint_prior_scale’, 0.005, 5),</span><span id="8751" class="nk mo iq ob b gy oj og l oh oi">‘changepoint_range’: trial.suggest_float(‘changepoint_range’, 0.1, 0.9),</span><span id="0cf4" class="nk mo iq ob b gy oj og l oh oi">‘seasonality_mode’: trial.suggest_categorical(‘seasonality_mode’, [‘multiplicative’, ‘additive’]),</span><span id="1630" class="nk mo iq ob b gy oj og l oh oi">‘seasonality_prior_scale’: trial.suggest_float(‘seasonality_prior_scale’, 0.1, 10),</span><span id="de6f" class="nk mo iq ob b gy oj og l oh oi">‘yearly_seasonality’: trial.suggest_int(‘yearly_seasonality’, 1, 50),</span><span id="3583" class="nk mo iq ob b gy oj og l oh oi">‘holidays_prior_scale’: trial.suggest_float(‘holidays_prior_scale’, 0.1, 10)</span><span id="6456" class="nk mo iq ob b gy oj og l oh oi">}</span><span id="6756" class="nk mo iq ob b gy oj og l oh oi">m = Prophet(**parameters, # ** means unpack</span><span id="7438" class="nk mo iq ob b gy oj og l oh oi">interval_width=0.95,</span><span id="71a9" class="nk mo iq ob b gy oj og l oh oi">weekly_seasonality=False,</span><span id="9083" class="nk mo iq ob b gy oj og l oh oi">daily_seasonality=False</span><span id="3f36" class="nk mo iq ob b gy oj og l oh oi">)</span><span id="d5f5" class="nk mo iq ob b gy oj og l oh oi">m.add_country_holidays(country_name=’DE’)</span><span id="abee" class="nk mo iq ob b gy oj og l oh oi">m.fit(train_df_tun)</span><span id="bf60" class="nk mo iq ob b gy oj og l oh oi">validation = m.predict(val_df_tun)</span><span id="3e6f" class="nk mo iq ob b gy oj og l oh oi">mae_for_optuna = mean_absolute_error(val_df_tun[‘y’], validation[‘yhat’])</span><span id="13cb" class="nk mo iq ob b gy oj og l oh oi">return mae_for_optuna</span></pre><p id="562e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后我们通过<strong class="ky ir"> study.best_params </strong>应用该函数。我们将在这一步中指定试验的次数。我建议至少 1000。在我们的 Jupyter 笔记本中，你会发现我的一些其他试验，包括一些只有 500 次试验。</p><pre class="kg kh ki kj gt oa ob oc od aw oe bi"><span id="1396" class="nk mo iq ob b gy of og l oh oi">study = optuna.create_study(direction=’minimize’)</span><span id="4114" class="nk mo iq ob b gy oj og l oh oi">study.optimize(find_params, n_trials=1000) #1000</span><span id="ccc0" class="nk mo iq ob b gy oj og l oh oi">study.best_params</span></pre><p id="3b03" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在搜索过程中，您可以在打印输出中找到单个结果。下面圈起来的数字是试用号。第一个下划线是试验的 MAE，越低越好。最后一个带下划线的是存储在进程中的最佳结果。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi om"><img src="../Images/6058a7c53b9a13377b5428513d7ab99b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ASsJLQIjqpokGzip3GO6ug.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">等待 2-3 小时后，搜索完成，找到最佳参数。作者图片</p></figure><p id="e454" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">经过 2-3 个小时的等待时间，搜索完成，结果如下。</p><pre class="kg kh ki kj gt oa ob oc od aw oe bi"><span id="9679" class="nk mo iq ob b gy of og l oh oi">para = {‘changepoint_prior_scale’: 1.9804273036896098,</span><span id="8b32" class="nk mo iq ob b gy oj og l oh oi">‘changepoint_range’: 0.6543491388579227,</span><span id="0c73" class="nk mo iq ob b gy oj og l oh oi">‘seasonality_mode’: ‘multiplicative’,</span><span id="25c4" class="nk mo iq ob b gy oj og l oh oi">‘seasonality_prior_scale’: 4.465868155817663,</span><span id="01e7" class="nk mo iq ob b gy oj og l oh oi">‘yearly_seasonality’: 18,</span><span id="02f8" class="nk mo iq ob b gy oj og l oh oi">‘holidays_prior_scale’: 2.650571507054187</span><span id="c17c" class="nk mo iq ob b gy oj og l oh oi">}</span></pre><p id="eaf8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们再次使用匹配长度的数据帧，用找到的最佳参数来训练我们的模型。</p><pre class="kg kh ki kj gt oa ob oc od aw oe bi"><span id="9207" class="nk mo iq ob b gy of og l oh oi">train_df_tun2 = pd.concat([train_df_tun, val_df_tun])</span><span id="4829" class="nk mo iq ob b gy oj og l oh oi">m = Prophet(**para,</span><span id="264b" class="nk mo iq ob b gy oj og l oh oi">interval_width=0.95,</span><span id="801d" class="nk mo iq ob b gy oj og l oh oi">weekly_seasonality=False,</span><span id="8e5c" class="nk mo iq ob b gy oj og l oh oi">daily_seasonality=False</span><span id="ec05" class="nk mo iq ob b gy oj og l oh oi">)</span><span id="8932" class="nk mo iq ob b gy oj og l oh oi">m.add_country_holidays(country_name=’DE’)</span><span id="31ba" class="nk mo iq ob b gy oj og l oh oi">m.fit(train_df_tun2)</span><span id="ed60" class="nk mo iq ob b gy oj og l oh oi"># Then we test our newly trained model with the test df.</span><span id="b065" class="nk mo iq ob b gy oj og l oh oi">predict_df_tun = m.predict(test_df_tun)</span><span id="939c" class="nk mo iq ob b gy oj og l oh oi">evaluate(test_df_tun[‘y’], predict_df_tun[‘yhat’])</span></pre><blockquote class="on oo op"><p id="73b4" class="kw kx oq ky b kz la jr lb lc ld ju le or lg lh li os lk ll lm ot lo lp lq lr ij bi translated">{ '梅':18960.888888888617</p><p id="d113" class="kw kx oq ky b kz la jr lb lc ld ju le or lg lh li os lk ll lm ot lo lp lq lr ij bi translated">' MSE ':78969 . 18678678671</p><p id="26fc" class="kw kx oq ky b kz la jr lb lc ld ju le or lg lh li os lk ll lm ot lo lp lq lr ij bi translated">RMSE:19967.888686868616</p><p id="9adf" class="kw kx oq ky b kz la jr lb lc ld ju le or lg lh li os lk ll lm ot lo lp lq lr ij bi translated">R2': 0.7987997251205757}</p></blockquote><p id="1847" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">r 说明我们新训练的先知模型有<strong class="ky ir"> 80%的解释力。</strong>一点都不差！比之前未调模型的 60%好多了。令人印象深刻的是<strong class="ky ir"> 32%的车型改进</strong>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ol"><img src="../Images/65dcc118061574cb9f92bd998f02beb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dC2MDRVD2BjVR_WCMlzZpQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">蓝色部分是这个调整后的脸书先知模型的测试部分。作者图片</p></figure><p id="b591" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们创建最终的数据框架，并将其可视化。</p><pre class="kg kh ki kj gt oa ob oc od aw oe bi"><span id="ed44" class="nk mo iq ob b gy of og l oh oi">future_optuna_df = m.make_future_dataframe(periods=60,freq=’W’)</span><span id="b23a" class="nk mo iq ob b gy oj og l oh oi">predict_optuna2 = m.predict(future_optuna_df)</span><span id="c08d" class="nk mo iq ob b gy oj og l oh oi">predict_optuna2.columns</span><span id="dc03" class="nk mo iq ob b gy oj og l oh oi">forecast_final = predict_optuna2[[‘ds’, ‘trend’,’yhat’]]</span><span id="959d" class="nk mo iq ob b gy oj og l oh oi">forecast_fig_final = px.line(forecast_final, x=”ds”, y=”yhat”, title=’The number of unique visitors of <a class="ae kv" href="http://www.lorentzyeung.com" rel="noopener ugc nofollow" target="_blank">www.lorentzyeung.com</a> forecast one year into the future.’)</span><span id="0032" class="nk mo iq ob b gy oj og l oh oi">fig_final.show()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/d0fe6c31009a0ed4af11791c29340e2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sFaDfPDYctZ9fyMVtEz6sQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">恭喜你，你的先知和最好的参数已经完成了。作者图片</p></figure></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="5413" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">结论</h1><p id="5ae6" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">恭喜你！您刚刚学习了如何使用 Prophet 进行即时设置和优化预测。通过参数指定，可以在不过度拟合的情况下显著改进模型。在我们的案例中，我们将模型改进了 32%。它可能会更高，但我现在会停止。</p><p id="6738" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢您的阅读。如果你喜欢这个教程，请分享给你的数据科学朋友，并<strong class="ky ir">关注我</strong>。以下是我继续为社区做贡献的动力。</p><h2 id="dd43" class="nk mo iq bd mp nl nm dn mt nn no dp mx lf np nq mz lj nr ns nb ln nt nu nd nv bi translated">如果你好奇或者想知道我在<a class="ae kv" rel="noopener" target="_blank" href="/real-world-website-visitor-forecast-with-facebook-prophet-a-complete-tutorial-8d135b848c5e">的文章第一部分</a>中做了什么，<a class="ae kv" rel="noopener" target="_blank" href="/real-world-website-visitor-forecast-with-facebook-prophet-a-complete-tutorial-8d135b848c5e">请点击这里进入第一部分</a>。</h2></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h2 id="c2a2" class="nk mo iq bd mp nl nm dn mt nn no dp mx lf np nq mz lj nr ns nb ln nt nu nd nv bi translated">参考:</h2><div class="ov ow gp gr ox oy"><a href="https://facebook.github.io/prophet/" rel="noopener  ugc nofollow" target="_blank"><div class="oz ab fo"><div class="pa ab pb cl cj pc"><h2 class="bd ir gy z fp pd fr fs pe fu fw ip bi translated">先知</h2><div class="pf l"><h3 class="bd b gy z fp pd fr fs pe fu fw dk translated">Prophet 是一个用 R 和 Python 实现的预测程序。它速度很快，并提供完全自动化的预测…</h3></div><div class="pg l"><p class="bd b dl z fp pd fr fs pe fu fw dk translated">facebook.github.io</p></div></div><div class="ph l"><div class="pi l pj pk pl ph pm kp oy"/></div></div></a></div><h2 id="85a9" class="nk mo iq bd mp nl nm dn mt nn no dp mx lf np nq mz lj nr ns nb ln nt nu nd nv bi translated">您可能还喜欢:</h2><div class="ov ow gp gr ox oy"><a href="https://medium.com/analytics-vidhya/sales-analytics-churn-analysis-and-prediction-with-pyspark-98fffc169f36" rel="noopener follow" target="_blank"><div class="oz ab fo"><div class="pa ab pb cl cj pc"><h2 class="bd ir gy z fp pd fr fs pe fu fw ip bi translated">销售分析:使用 PySpark 进行流失分析和预测</h2><div class="pf l"><h3 class="bd b gy z fp pd fr fs pe fu fw dk translated">最后用保存的模型和管道进行基础数据可视化和预测</h3></div><div class="pg l"><p class="bd b dl z fp pd fr fs pe fu fw dk translated">medium.com</p></div></div><div class="ph l"><div class="pn l pj pk pl ph pm kp oy"/></div></div></a></div><div class="ov ow gp gr ox oy"><a rel="noopener follow" target="_blank" href="/pandas-data-wrangling-cheat-sheet-2021-cf70f577bcdd"><div class="oz ab fo"><div class="pa ab pb cl cj pc"><h2 class="bd ir gy z fp pd fr fs pe fu fw ip bi translated">熊猫数据争论备忘单 2021</h2><div class="pf l"><h3 class="bd b gy z fp pd fr fs pe fu fw dk translated">要在 Python 中 excel 数据分析/数据科学/机器学习，熊猫是你需要掌握的库。这里有一个骗局…</h3></div><div class="pg l"><p class="bd b dl z fp pd fr fs pe fu fw dk translated">towardsdatascience.com</p></div></div><div class="ph l"><div class="po l pj pk pl ph pm kp oy"/></div></div></a></div><div class="ov ow gp gr ox oy"><a rel="noopener follow" target="_blank" href="/fundamental-marketing-analytics-f875018391d5"><div class="oz ab fo"><div class="pa ab pb cl cj pc"><h2 class="bd ir gy z fp pd fr fs pe fu fw ip bi translated">基础营销分析</h2><div class="pf l"><h3 class="bd b gy z fp pd fr fs pe fu fw dk translated">通过最近-频率-货币模型和使用 Python 的管理细分</h3></div><div class="pg l"><p class="bd b dl z fp pd fr fs pe fu fw dk translated">towardsdatascience.com</p></div></div><div class="ph l"><div class="pp l pj pk pl ph pm kp oy"/></div></div></a></div></div></div>    
</body>
</html>