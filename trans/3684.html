<html>
<head>
<title>Deploying SageMaker Endpoints With CloudFormation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用CloudFormation部署SageMaker端点</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploying-sagemaker-endpoints-with-cloudformation-b43f7d495640#2022-08-16">https://towardsdatascience.com/deploying-sagemaker-endpoints-with-cloudformation-b43f7d495640#2022-08-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6486" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用SageMaker将基础设施作为代码</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e8188f19e0d3977430a710fac8a407ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*N4l1ccrrWqadeFbi"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自<a class="ae ky" href="https://unsplash.com/@abebarrera" rel="noopener ugc nofollow" target="_blank"> Abraham Barrera </a>的<a class="ae ky" href="https://unsplash.com/@abebarrera" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><p id="4a70" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">过去，我通过Jupyter笔记本和Python脚本与<a class="ae ky" href="https://docs.aws.amazon.com/sagemaker/latest/dg/deploy-model.html" rel="noopener ugc nofollow" target="_blank"> SageMaker Deployment </a>合作过。这完全没问题，但通常在较大的应用程序范围内，您需要能够在一个中心模板中定义SageMaker资源和基础设施的其余部分。这引入了作为代码的<a class="ae ky" href="https://www.redhat.com/en/topics/automation/what-is-infrastructure-as-code-iac" rel="noopener ugc nofollow" target="_blank">基础设施的概念，然后引入</a><a class="ae ky" href="https://aws.amazon.com/cloudformation/" rel="noopener ugc nofollow" target="_blank"> AWS CloudFormation </a>。当涉及到生产应用程序时，能够在各种中央模板中捕获您的资源是至关重要的，维护或管理笔记本或单个脚本的隔离流程变得非常困难。</p><p id="ae2d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们将了解如何使用CloudFormation来定义SageMaker资源并创建实时端点。利用这个模板，您应该能够为其他SageMaker推理选项(如多模型端点、无服务器推理和异步推理)推断和创建云信息模板。</p><p id="e018" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">注意</strong>:对于刚接触AWS的人来说，如果你想继续下去，请确保在下面的<a class="ae ky" href="https://aws.amazon.com/console/" rel="noopener ugc nofollow" target="_blank">链接</a>中建立账户。确保还安装了<a class="ae ky" href="https://aws.amazon.com/cli/" rel="noopener ugc nofollow" target="_blank"> AWS CLI </a>来处理该示例。这篇文章也将假设云形成的基本知识，如果你需要一个入门指南，在这里看一下这篇文章。本文还假设对SageMaker部署有一个中级理解，我建议遵循本文<a class="ae ky" rel="noopener" target="_blank" href="/deploying-a-pre-trained-sklearn-model-on-amazon-sagemaker-826a2b5ac0b6">为了更深入地理解部署/推理，我们将在本文中使用相同的模型，并将其映射到CloudFormation。</a></p><h2 id="4d7f" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">设置</h2><p id="3668" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">在开始构建CloudFormation模板之前，我们需要了解我们的SageMaker端点需要什么。对于这个用例，我们将在SageMaker实时端点上部署一个预训练的Sklearn模型。利用下面的脚本，我们可以快速运行一个<a class="ae ky" href="https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.LinearRegression.html" rel="noopener ugc nofollow" target="_blank">线性回归模型</a>并生成一个模型数据工件。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mt mu l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">本地模型</p></figure><p id="ff81" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">运行这个脚本后，您应该得到一个model.joblib文件，它包含部署所需的模型元数据。一般来说，使用SageMaker推理，您还需要一个推理脚本来控制自定义代码的前/后处理。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mt mu l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">推理脚本</p></figure><p id="e5e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">SageMaker推理期望将这个模型数据和推理脚本打包成一个tarball，因此我们运行下面的脚本将这些资源转换成期望的格式，并将其上传到S3存储桶。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mt mu l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">创建并上传model.tar.gz</p></figure><p id="8a26" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们已经有了模型工件，我们可以继续处理云的形成。</p><h2 id="9640" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">定义云形成参数</h2><p id="2196" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">一个<a class="ae ky" href="https://aws.amazon.com/cloudformation/resources/templates/" rel="noopener ugc nofollow" target="_blank"> CloudFormation模板</a>是一个yaml或json文件，你可以在其中定义你所有的基础设施。<a class="ae ky" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html" rel="noopener ugc nofollow" target="_blank"> CloudFormation参数</a>允许你在模板中注入自定义值。然后在定义资源时，您可以引用这些参数。在这种情况下，我们提供默认值，但是如果您愿意，您可以通过<a class="ae ky" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-using-cli.html" rel="noopener ugc nofollow" target="_blank"> CLI </a>覆盖它们。对于SageMaker端点，我们必须定义以下参数(注意，您可以随意命名这些参数，但要确保在命名时引用它们):</p><ul class=""><li id="409e" class="mv mw it lb b lc ld lf lg li mx lm my lq mz lu na nb nc nd bi translated"><strong class="lb iu"> RoleARN </strong>:您授予权限的SageMaker执行角色。用您为SageMaker资源定义的IAM角色替换默认角色值。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mt mu l"/></div></figure><ul class=""><li id="b52c" class="mv mw it lb b lc ld lf lg li mx lm my lq mz lu na nb nc nd bi translated"><strong class="lb iu"> ImageURI </strong>:这是URI的图像，你可以从现有的<a class="ae ky" href="https://github.com/aws/deep-learning-containers/blob/master/available_images.md" rel="noopener ugc nofollow" target="_blank">深度学习容器</a>中检索到，或者如果你做了<a class="ae ky" rel="noopener" target="_blank" href="/bring-your-own-container-with-amazon-sagemaker-37211d8412f4"> BYOC部署</a>，你可以从ECR中自己定制图像URI。对于这个例子，我们有一个Sklearn模型，所以我们已经用<a class="ae ky" href="https://aws.plainenglish.io/how-to-retrieve-amazon-sagemaker-deep-learning-images-ff4a5866299e" rel="noopener ugc nofollow" target="_blank">检索了</a>那个托管容器的适当版本。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mt mu l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Sklearn图像</p></figure><ul class=""><li id="2c91" class="mv mw it lb b lc ld lf lg li mx lm my lq mz lu na nb nc nd bi translated">这是我们打包在一起并上传到S3桶的模型工件和推理脚本。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mt mu l"/></div></figure><ul class=""><li id="a357" class="mv mw it lb b lc ld lf lg li mx lm my lq mz lu na nb nc nd bi translated"><strong class="lb iu">instance type&amp;instance count</strong>:您正在为端点定义的硬件，针对无服务器推理(内存大小&amp;并发)对其进行适当的更改。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mt mu l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">实例配置</p></figure><p id="5322" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在已经有了部署SageMaker实时端点所必需的参数，接下来让我们专注于定义我们的资源。</p><h2 id="2a7f" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">云信息资源和部署</h2><p id="e782" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">为了部署SageMaker端点，有三个主要的实体协同工作:<a class="ae ky" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sagemaker.html#SageMaker.Client.create_model" rel="noopener ugc nofollow" target="_blank"> SageMaker模型</a>、<a class="ae ky" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sagemaker.html#SageMaker.Client.create_endpoint_config" rel="noopener ugc nofollow" target="_blank"> SageMaker端点配置</a>和<a class="ae ky" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sagemaker.html#SageMaker.Client.create_endpoint" rel="noopener ugc nofollow" target="_blank"> SageMaker端点</a>。SageMaker模型实体定义了我们用于部署的模型数据和图像，并且是我们创建的第一个资源。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mt mu l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">SageMaker模型实体</p></figure><p id="031d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意，我们引用了我们已经定义的ImageURI和模型数据参数。接下来，我们对端点配置做了同样的事情，我们在端点后面定义了实例配置。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mt mu l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">SageMaker端点配置</p></figure><p id="68e5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们在定义SageMaker端点的最后一步时指向这个资源。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mt mu l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">SageMaker端点创建</p></figure><p id="b68f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用AWS CLI，我们可以通过指向我们的yaml文件来<a class="ae ky" href="https://docs.aws.amazon.com/cli/latest/reference/cloudformation/deploy/index.html" rel="noopener ugc nofollow" target="_blank">部署</a>这个CloudFormation堆栈。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mt mu l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">部署云架构堆栈</p></figure><p id="b414" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以在控制台中验证这一点，几分钟后，您应该会看到所有三个资源都已创建。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ne"><img src="../Images/47cf71bf970a8f3f6cb8de854adade10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JF_LjD495ImyDq6UZl8ksg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">云形成堆栈完成(作者截图)</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/9b5f8e040b92ffab68db08f23f0eafbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IWduICvF-vr0bkWDD32QSA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">SageMaker端点已创建(作者截图)</p></figure><h2 id="3db8" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">其他资源和结论</h2><div class="ng nh gp gr ni nj"><a href="https://github.com/RamVegiraju/cloudformation-sagemaker-ep" rel="noopener  ugc nofollow" target="_blank"><div class="nk ab fo"><div class="nl ab nm cl cj nn"><h2 class="bd iu gy z fp no fr fs np fu fw is bi translated">GitHub-RamVegiraju/cloudformation-sage maker-EP:使用cloud formation部署SM端点</h2><div class="nq l"><h3 class="bd b gy z fp no fr fs np fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="nr l"><p class="bd b dl z fp no fr fs np fu fw dk translated">github.com</p></div></div><div class="ns l"><div class="nt l nu nv nw ns nx ks nj"/></div></div></a></div><p id="dbfe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以在上面的链接中找到示例的完整代码。AWS CloudFormation是一个非常强大的工具，它使得在一个中央模板中捕获您的AWS资源变得非常容易。没有作为代码的基础设施，在软件生命周期中迭代变得非常困难，这也适用于ML服务，如SageMaker。我希望这篇文章对那些对SageMaker、CloudFormation和AWS感兴趣的人有用。</p><ul class=""><li id="94f4" class="mv mw it lb b lc ld lf lg li mx lm my lq mz lu na nb nc nd bi translated"><a class="ae ky" href="https://github.com/RamVegiraju/SageMaker-Deployment" rel="noopener ugc nofollow" target="_blank"> SageMaker部署示例</a></li><li id="d882" class="mv mw it lb b lc ny lf nz li oa lm ob lq oc lu na nb nc nd bi translated"><a class="ae ky" href="https://ram-vegiraju.medium.com/list/amazon-sagemaker-f1b06f720fba" rel="noopener"> SageMaker文章列表</a></li><li id="174f" class="mv mw it lb b lc ny lf nz li oa lm ob lq oc lu na nb nc nd bi translated"><a class="ae ky" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/sample-templates-services-us-west-2.html" rel="noopener ugc nofollow" target="_blank">样本模板</a></li></ul></div><div class="ab cl od oe hx of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="im in io ip iq"><p id="2143" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="ok">如果你喜欢这篇文章，请在</em><a class="ae ky" href="https://www.linkedin.com/in/ram-vegiraju-81272b162/" rel="noopener ugc nofollow" target="_blank"><em class="ok">LinkedIn</em></a><em class="ok">上与我联系，并订阅我的媒体</em> <a class="ae ky" href="https://ram-vegiraju.medium.com/subscribe" rel="noopener"> <em class="ok">简讯</em> </a> <em class="ok">。如果你是新来的中号，用我的</em> <a class="ae ky" href="https://ram-vegiraju.medium.com/membership" rel="noopener"> <em class="ok">会员推荐</em> </a> <em class="ok">报名吧。</em></p></div></div>    
</body>
</html>