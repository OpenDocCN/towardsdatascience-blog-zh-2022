<html>
<head>
<title>Apache Airflow for Data Science — How to Upload Files to Amazon S3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Apache Airflow for Data Science —如何将文件上传到亚马逊 S3</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/apache-airflow-for-data-science-how-to-upload-files-to-amazon-s3-5bdf6fcb1cea#2022-03-24">https://towardsdatascience.com/apache-airflow-for-data-science-how-to-upload-files-to-amazon-s3-5bdf6fcb1cea#2022-03-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="086a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated"><strong class="ak">设置一个 S3 桶并用 Apache Airflow 上传本地文件</strong></h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/3311586c5a2ae83580acbacb053b5b74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JuBTqeWaSjDQwpv7"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@joshstyle?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">乔舒亚·科尔曼</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="4403" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">到目前为止，我们已经编写了几个气流 Dag，但是它们都在本地存储数据，要么存储到文件，要么存储到数据库。如果你想把数据存储在云端呢？嗯，你很幸运——今天你将学习如何用几行代码使用亚马逊 S3。</p><p id="b953" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Amazon<em class="lv">Simple Storage Service</em>(S3)是一个可扩展的对象存储解决方案，你可以开始免费使用，如果你需要，可以相对便宜地扩展。本文假设您已经建立了一个 AWS 帐户，因为我们不会经历这个过程。从设置存储桶到下载安全凭证的所有其他内容都将在下面介绍。</p><p id="127c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不想看书？请观看我的视频:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lw lx l"/></div></figure></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><h1 id="908d" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">如何在亚马逊 S3 上创建一个桶</h1><p id="ae0c" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li mz lk ll lm na lo lp lq nb ls lt lu im bi translated">首先，打开你的 AWS 控制台，进入<em class="lv"> S3 </em> — <em class="lv">桶</em> — <em class="lv">创建桶</em>。您将看到以下屏幕:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nc"><img src="../Images/4515bf0c77a85903f883a209d7b3a302.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vGplzv9wv71bobnAu0SjIw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 1 —在亚马逊 S3 上创建一个桶(图片由作者提供)</p></figure><p id="8e9a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以随意命名您的存储桶。注意不能使用特殊字符和大写字母。保持其他选项不变(不建议生产使用),并滚动到屏幕底部。</p><p id="ba2f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦到达，点击大橙色<em class="lv">创建桶</em>按钮:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nc"><img src="../Images/22aaf1f3dcbb34f6f2d35b34499f32c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P6iLHZBrctWVFRFfvduSSg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 2——在亚马逊 S3 上创建一个桶(图片由作者提供)</p></figure><p id="13c7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您指定的名称符合条件且未被占用，将立即创建您的存储桶:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nc"><img src="../Images/fce3dc526e8f3b56453c1506759d66bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CK4pOWeU1p7XBExf2s2ang.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 3——在亚马逊 S3 上创建一个桶(图片由作者提供)</p></figure><p id="7bbc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">看到这有多简单了吗？现在，让我们获取凭证并设置气流连接。</p></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><h1 id="cc10" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">如何在气流中创建 S3 连接</h1><p id="87a8" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li mz lk ll lm na lo lp lq nb ls lt lu im bi translated">在做任何事情之前，确保安装 Apache Airflow 的 Amazon provider 否则，您将无法创建 S3 连接:</p><pre class="kj kk kl km gt nd ne nf ng aw nh bi"><span id="7797" class="ni mg it ne b gy nj nk l nl nm">pip install 'apache-airflow[amazon]'</span></pre><p id="8d04" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">安装完成后，重启 Airflow 服务器和调度程序，你就可以开始工作了。</p><p id="5d8a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">再次打开 AWS 页面，点击右上角你的用户名(我的是<em class="lv"> darioddd </em>)，选择<em class="lv">安全凭证</em>。在<em class="lv">访问键</em>下，点击<em class="lv">创建新的访问键</em>。这将产生两件事:</p><ul class=""><li id="06f5" class="nn no it lb b lc ld lf lg li np lm nq lq nr lu ns nt nu nv bi translated">访问密钥 ID</li><li id="bd10" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ns nt nu nv bi translated">秘密访问密钥</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/7b0756d6502c2b643efa56b772baa38c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rODrz5IcRMxiG1Wz_HwFEg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 4 —获取 S3 访问密钥 ID 和秘密访问密钥(图片由作者提供)</p></figure><p id="63b8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以随意下载 CSV 格式的密钥文件，但现在这不是强制性的。</p><p id="4072" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">前往 Airflow webserver，然后进入<em class="lv">管理</em> — <em class="lv">连接</em>。单击加号定义一个新的。以下是您应该指定的内容:</p><ul class=""><li id="3222" class="nn no it lb b lc ld lf lg li np lm nq lq nr lu ns nt nu nv bi translated"><strong class="lb iu">连接 Id </strong> —任意字符串，您可以随意命名。</li><li id="0166" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ns nt nu nv bi translated"><strong class="lb iu">连接类型</strong> —亚马逊 S3</li><li id="9dfd" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ns nt nu nv bi translated"><strong class="lb iu"> Extra </strong> —类似 JSON 的对象，带<code class="fe oc od oe ne b">aws_access_key_id</code>和<code class="fe oc od oe ne b">aws_secret_access_key</code>键。你知道什么是关键值。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/51695a904aaa75a27d87e5de25c71533.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZuOSnmBm230uKdOJX7n1Xg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 5-在气流中设置 S3 连接(图片由作者提供)</p></figure><p id="dd14" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就配置而言，这就是您需要做的一切。接下来让我们写下实际的气流 DAG。</p></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><h1 id="81cd" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">如何编写一个气流 DAG 上传文件到 S3</h1><p id="e50d" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li mz lk ll lm na lo lp lq nb ls lt lu im bi translated">在<code class="fe oc od oe ne b">~/airflow/dags</code>文件夹中新建一个 Python 文件。我已经把我的命名为<code class="fe oc od oe ne b">s3_upload.py</code>。我们将从库导入和 DAG 样板代码开始。注意这里有一个新的导入- <code class="fe oc od oe ne b">S3Hook</code> -它将负责与 S3 桶通信:</p><pre class="kj kk kl km gt nd ne nf ng aw nh bi"><span id="1e5f" class="ni mg it ne b gy nj nk l nl nm">from datetime import datetime<br/>from airflow.models import DAG<br/>from airflow.operators.python import PythonOperator<br/>from airflow.hooks.S3_hook import S3Hook<br/></span><span id="8062" class="ni mg it ne b gy of nk l nl nm">with DAG(<br/>    dag_id='s3_dag',<br/>    schedule_interval='@daily',<br/>    start_date=datetime(2022, 3, 1),<br/>    catchup=False<br/>) as dag:<br/>	pass</span></pre><p id="e2ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上传文件的任务可以归结为使用一个<code class="fe oc od oe ne b">PythonOperator</code>来调用一个函数。<code class="fe oc od oe ne b">upload_to_s3()</code>函数接受三个参数——确保它们是正确的:</p><ul class=""><li id="126b" class="nn no it lb b lc ld lf lg li np lm nq lq nr lu ns nt nu nv bi translated"><code class="fe oc od oe ne b">filename</code> - string，你要上传的文件的完整路径。任何文件都可以，但是我使用的是在<a class="ae ky" href="https://betterdatascience.com/apache-airflow-rest-api/" rel="noopener ugc nofollow" target="_blank"> Airflow REST API 文章</a>中下载的文件。</li><li id="aa82" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ns nt nu nv bi translated"><code class="fe oc od oe ne b">key</code> - string，上传文件将获得的名称。例如，<code class="fe oc od oe ne b">posts.json</code>将文件上传到 S3 的斗根。你也可以指定路径，比如<code class="fe oc od oe ne b">/data/posts/posts.json</code>，S3 会自动为你创建文件夹结构。</li><li id="9a28" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ns nt nu nv bi translated"><code class="fe oc od oe ne b">bucket_name</code> -字符串，您要将文件上传到的存储桶的名称。</li></ul><p id="3ef4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">同一个函数首先创建一个<code class="fe oc od oe ne b">S3Hook</code>类的实例，并使用之前建立的连接。然后，您可以调用<code class="fe oc od oe ne b">load_file()</code>方法将本地文件上传到 S3 存储桶:</p><pre class="kj kk kl km gt nd ne nf ng aw nh bi"><span id="f6f6" class="ni mg it ne b gy nj nk l nl nm">from datetime import datetime<br/>from airflow.models import DAG<br/>from airflow.operators.python import PythonOperator<br/>from airflow.hooks.S3_hook import S3Hook<br/></span><span id="3e1d" class="ni mg it ne b gy of nk l nl nm">def upload_to_s3(filename: str, key: str, bucket_name: str) -&gt; None:<br/>    hook = S3Hook('s3_conn')<br/>    hook.load_file(filename=filename, key=key, bucket_name=bucket_name)<br/></span><span id="7b06" class="ni mg it ne b gy of nk l nl nm">with DAG(<br/>    dag_id='s3_dag',<br/>    schedule_interval='@daily',<br/>    start_date=datetime(2022, 3, 1),<br/>    catchup=False<br/>) as dag:</span><span id="340c" class="ni mg it ne b gy of nk l nl nm">    # Upload the file<br/>    task_upload_to_s3 = PythonOperator(<br/>        task_id='upload_to_s3',<br/>        python_callable=upload_to_s3,<br/>        op_kwargs={<br/>            'filename': '/Users/dradecic/airflow/data/posts.json',<br/>            'key': 'posts.json',<br/>            'bucket_name': 'bds-airflow-bucket'<br/>        }<br/>    )</span></pre><p id="213a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一切看起来都很好，所以让我们测试这个任务:</p><pre class="kj kk kl km gt nd ne nf ng aw nh bi"><span id="4eed" class="ni mg it ne b gy nj nk l nl nm">airflow tasks test s3_dag upload_to_s3 2022-3-1</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/733d90d83a0d81ff067e21fcf02f243f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2DqArFi0YiOz6peEkQiY4Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 6 —测试 S3 上传任务(图片由作者提供)</p></figure><p id="4a2b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">任务成功完成，这意味着您应该在 S3 存储桶中看到上传的文件:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/8a5cc852b37ed6f42d599d2020a9cd43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r9kT8ZqCz-pVNxCwiUKj0w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 7 —验证文件是否上传到 S3(图片由作者提供)</p></figure><p id="2d55" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">任务完成。在结束之前，我们先做个总结。</p><h1 id="1f13" class="mf mg it bd mh mi oh mk ml mm oi mo mp jz oj ka mr kc ok kd mt kf ol kg mv mw bi translated">结论</h1><p id="4933" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li mz lk ll lm na lo lp lq nb ls lt lu im bi translated">Apache Airflow 使云存储工作变得轻而易举。在短短几分钟内，您已经创建了一个新的 S3 桶，配置了一个气流连接，并编写了一个将本地文件上传到云的气流任务。这是一个巨大的里程碑，因为大多数企业都将 S3 用于这样或那样的事情。</p><p id="1c76" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请继续关注下面的文章，在这篇文章中，我们将从 S3 桶中下载一个文件。</p><h2 id="0320" class="ni mg it bd mh om on dn ml oo op dp mp li oq or mr lm os ot mt lq ou ov mv ow bi translated">推荐阅读</h2><ul class=""><li id="3650" class="nn no it lb b lc mx lf my li ox lm oy lq oz lu ns nt nu nv bi translated"><a class="ae ky" href="https://betterdatascience.com/best-data-science-prerequisite-books/" rel="noopener ugc nofollow" target="_blank">学习数据科学先决条件(数学、统计和编程)的 5 本最佳书籍</a></li><li id="06dd" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ns nt nu nv bi translated"><a class="ae ky" href="https://betterdatascience.com/top-books-to-learn-data-science/" rel="noopener ugc nofollow" target="_blank">2022 年学习数据科学的前 5 本书</a></li><li id="c11e" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ns nt nu nv bi translated"><a class="ae ky" href="https://betterdatascience.com/apache-airflow-install/" rel="noopener ugc nofollow" target="_blank">如何在本地安装阿帕奇气流</a></li></ul><h2 id="df00" class="ni mg it bd mh om on dn ml oo op dp mp li oq or mr lm os ot mt lq ou ov mv ow bi translated">保持联系</h2><ul class=""><li id="d9de" class="nn no it lb b lc mx lf my li ox lm oy lq oz lu ns nt nu nv bi translated">雇用我作为一名技术作家</li><li id="6536" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ns nt nu nv bi translated">订阅<a class="ae ky" href="https://www.youtube.com/c/BetterDataScience" rel="noopener ugc nofollow" target="_blank"> YouTube </a></li><li id="1bf9" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ns nt nu nv bi translated">在<a class="ae ky" href="https://www.linkedin.com/in/darioradecic/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上连接</li></ul></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><p id="825a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">喜欢这篇文章吗？成为</em> <a class="ae ky" href="https://medium.com/@radecicdario/membership" rel="noopener"> <em class="lv">中等会员</em> </a> <em class="lv">继续无限制学习。如果你使用下面的链接，我会收到你的一部分会员费，不需要你额外付费。</em></p><div class="pa pb gp gr pc pd"><a href="https://medium.com/@radecicdario/membership" rel="noopener follow" target="_blank"><div class="pe ab fo"><div class="pf ab pg cl cj ph"><h2 class="bd iu gy z fp pi fr fs pj fu fw is bi translated">通过我的推荐链接加入 Medium-Dario rade ci</h2><div class="pk l"><h3 class="bd b gy z fp pi fr fs pj fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="pl l"><p class="bd b dl z fp pi fr fs pj fu fw dk translated">medium.com</p></div></div><div class="pm l"><div class="pn l po pp pq pm pr ks pd"/></div></div></a></div></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><p id="d02c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">原载于 2022 年 3 月 24 日 https://betterdatascience.com</em><em class="lv">的</em> <a class="ae ky" href="https://betterdatascience.com/apache-airflow-amazon-s3/" rel="noopener ugc nofollow" target="_blank"> <em class="lv">。</em></a></p></div></div>    
</body>
</html>