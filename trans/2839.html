<html>
<head>
<title>Pydantic or dataclasses? Why not both? Convert Between Them</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Pydantic还是dataclasses？为什么不两者都要？在它们之间转换</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/pydantic-or-dataclasses-why-not-both-convert-between-them-ba382f0f9a9c#2022-06-21">https://towardsdatascience.com/pydantic-or-dataclasses-why-not-both-convert-between-them-ba382f0f9a9c#2022-06-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="175d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在FastAPI项目中使用dataclasses，并加速您的pydantic模型操作</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/86a7feab4145615f48028406e5ba1fbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/format:webp/1*h6WKhKfK3PU169NGy7DUCw.png"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">图片作者。</p></figure><p id="6e9e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">Python数据类非常棒。Pydantic太棒了。如果我们真的面临选择一个或另一个，这是一个艰难的选择。我会说，比较这两个伟大的模块就像比较梨和苹果，尽管在某些方面相似，但总体上不同。</p><p id="c9b0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu"> Pydantic的竞技场是数据解析和净化</strong>，而<strong class="kw iu"> dataclasses a是一个快速且内存高效的</strong>(尤其是使用slots，Python 3.10+) <strong class="kw iu">通用数据容器</strong>。查看这个故事，在这里我彻底比较了Python数据容器，包括pydantic和dataclasses。</p><p id="7f65" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然而，有时，似乎某些代码依赖试图让我们做出选择。一个很好的例子是使用FastAPI时；它建立在pydantic之上。如果我们的应用程序很简单，我们也可以用pydantic做所有的数据模型，避免任何兼容性问题。另一个例子是当我们继承一个已经在使用dataclasses的代码库时。为什么我们在使用FastAPI时会错过数据类的性能呢？当我们需要使用FastAPI实现web API时，如何将我们的dataclasses模式转换为pydantic模式呢？顺便说一下，FastAPI也很棒。</p><p id="c781" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在这个故事中，我们使用一些简单的技巧将动态平面数据类转换成pydantic，反之亦然。最后，我们将使用一个FastAPI测试这种实际转换的实现。</p><h2 id="cbee" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">故事结构</h2><ul class=""><li id="0427" class="mk ml it kw b kx mm la mn ld mo lh mp ll mq lp mr ms mt mu bi translated">数据类(无默认值)转换为pydantic</li><li id="6dd8" class="mk ml it kw b kx mv la mw ld mx lh my ll mz lp mr ms mt mu bi translated">默认为pydantic的数据类</li><li id="4d72" class="mk ml it kw b kx mv la mw ld mx lh my ll mz lp mr ms mt mu bi translated">数据类中的pydantic(无默认值)</li><li id="97fa" class="mk ml it kw b kx mv la mw ld mx lh my ll mz lp mr ms mt mu bi translated">数据类中有默认值的pydantic</li><li id="9560" class="mk ml it kw b kx mv la mw ld mx lh my ll mz lp mr ms mt mu bi translated">构建工具:数据类到pydantic</li><li id="fd1c" class="mk ml it kw b kx mv la mw ld mx lh my ll mz lp mr ms mt mu bi translated">构建工具:从pydantic到dataclass</li><li id="a001" class="mk ml it kw b kx mv la mw ld mx lh my ll mz lp mr ms mt mu bi translated">FastAPI示例</li></ul><h2 id="6e7a" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">数据类(无默认值)到pydantic</h2><p id="d02e" class="pw-post-body-paragraph ku kv it kw b kx mm ju kz la mn jx lc ld na lf lg lh nb lj lk ll nc ln lo lp im bi translated">问题是:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="50ba" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了解决这个问题，我们使用pydantic的实用程序来动态创建模型，<em class="nf"> pydantic.create_model </em>。我们需要为这个函数提供一个动态创建的模型的名称。我们还需要为kwargs(每个关键字参数都是动态创建的模型中的属性名称)提供一个属性类型和默认值的元组(如果没有默认值，那么使用…代替)。</p><p id="bdef" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了获得pydantic模型所需的信息，我们使用dataclasses模块中的<em class="nf">字段</em>实用程序；使用<em class="nf">字段</em>，我们可以访问属性的特性。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="979b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在，我们可以创建动态生成的pydantic模型的实例:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="c500" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">打印模型及其类型:<br/>name = ' Diego ' age = 33<br/>&lt;class ' pydantic . main . dynamicpydanticancer '&gt;</p><p id="8185" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">所以我们在这里是金色的。</p><h2 id="7f9f" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">数据类中的pydantic(无默认值)</h2><p id="29bb" class="pw-post-body-paragraph ku kv it kw b kx mm ju kz la mn jx lc ld na lf lg lh nb lj lk ll nc ln lo lp im bi translated">问题是:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="d838" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们现在使用dataclasses实用程序来动态创建类(<em class="nf"> dataclasses.make_dataclass)，</em>其中<em class="nf"> </em>需要动态创建的类的名称和每个属性的元组列表；每个元组应该包含属性的名称和类型。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="42d2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们可以从dataclasses模块中用<em class="nf"> is_dataclass </em>来检查这个类是否确实是一个dataclass。所以我们这样做并实例化这个类:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="0ea8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">prints:<br/>True<br/>dynamic person(姓名='Diego '，年龄=33岁)</p><p id="527c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这是我们预期的结果。</p><h2 id="589d" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">默认为pydantic的数据类</h2><p id="dcb1" class="pw-post-body-paragraph ku kv it kw b kx mm ju kz la mn jx lc ld na lf lg lh nb lj lk ll nc ln lo lp im bi translated">现在我们来看看dataclass有默认值的情况，我们想把它转换成pydantic。</p><p id="524f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">问题是:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="7246" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这个想法类似于没有违约的情况；然而，现在我们需要将…替换为默认值。此外，为了检查dataclass的字段中的默认值是否丢失(没有默认值)，我们检查字段default是否是dataclasses模块中的<em class="nf"> _MISSING_TYPE </em>类的实例(这里有点麻烦，但是我们需要把事情做好)。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="669b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们继续测试我们的<em class="nf">dynamicpydanticancer:</em></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="fd90" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">打印数据类及其类型:</p><p id="b650" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">使用默认:<br/>age = 33 name = ' Jane '<br/>&lt;class ' pydantic . main . dynamicpydanticancer '&gt;</p><p id="5a76" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">覆盖默认:<br/>age = 33 name = ' Diego '<br/>&lt;class ' _ _ main _ _。PydanticPerson' &gt;</p><p id="8c66" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">正如我们所料。</p><h2 id="8590" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">数据类中有默认值的pydantic</h2><p id="d223" class="pw-post-body-paragraph ku kv it kw b kx mm ju kz la mn jx lc ld na lf lg lh nb lj lk ll nc ln lo lp im bi translated">问题是:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="0ab5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">请注意默认字段。</p><p id="1da4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这种情况与没有违约的情况非常相似。如果属性有默认值，则每个属性的元组有三个元素，而不是两个，第三个元素是默认值(<em class="nf"> _field.required </em>表示没有默认值):</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="aec6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">测试它实际上是一个数据类，以及default和default override的实例:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="cda6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">prints:<br/>True<br/>dynamic person(年龄=33岁，姓名='John') <br/> DynamicPerson(年龄=33岁，姓名='Diego ')</p><p id="3d9a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们准备好了。</p><h2 id="6fae" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">构建工具:数据类到pydantic</h2><p id="35ac" class="pw-post-body-paragraph ku kv it kw b kx mm ju kz la mn jx lc ld na lf lg lh nb lj lk ll nc ln lo lp im bi translated">我们将数据类转换成pydantic模型的代码片段是成功的，有默认值和没有默认值。现在是时候用更有用的工具来包装它们了。一个为我们完成转换的函数:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="6d67" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们来测试一下。<br/>目标数据类:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="61b6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">将其转化为pydantic:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="c6e5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">印刷品:</p><blockquote class="ng nh ni"><p id="38af" class="ku kv nf kw b kx ky ju kz la lb jx lc nj le lf lg nk li lj lk nl lm ln lo lp im bi translated">PydanticPerson</p><p id="fe7c" class="ku kv nf kw b kx ky ju kz la lb jx lc nj le lf lg nk li lj lk nl lm ln lo lp im bi translated">年龄=33姓名= '简'</p></blockquote><p id="1de1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意__name__取自原始数据类(Person)的名称，前缀“Pydantic”是通过转换函数中的f字符串添加的。也可以选择提供自定义名称。</p><h2 id="9b8b" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">构建工具:从pydantic到dataclass</h2><p id="c1f9" class="pw-post-body-paragraph ku kv it kw b kx mm ju kz la mn jx lc ld na lf lg lh nb lj lk ll nc ln lo lp im bi translated">将数据类转换为pydantic的函数:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="7a63" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们来测试一下。<br/>目标分解模型:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="7b1e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">将其转换为数据类:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="1ddd" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">印刷品:</p><blockquote class="ng nh ni"><p id="79ef" class="ku kv nf kw b kx ky ju kz la lb jx lc nj le lf lg nk li lj lk nl lm ln lo lp im bi translated">DataClassPerson</p><p id="9aa9" class="ku kv nf kw b kx ky ju kz la lb jx lc nj le lf lg nk li lj lk nl lm ln lo lp im bi translated">DataClassPerson(年龄=33岁，姓名= '约翰')</p></blockquote><p id="ea0f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意__name__取自原始pydantic模型类(Person)的名称，并且在转换函数中添加了前缀“DataClass”。这是默认行为，或者可以将自定义名称传递给转换函数。</p><h2 id="3028" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">FastAPI示例</h2><p id="e14f" class="pw-post-body-paragraph ku kv it kw b kx mm ju kz la mn jx lc ld na lf lg lh nb lj lk ll nc ln lo lp im bi translated">最后给出了一个使用FastAPI的例子。这个简单的例子展示了在FastAPI中使用dataclass是多么容易。要使此示例生效，请将前两节中的代码保存到名为“dataclass_to_pydantic.py”的文件中，并将其放在运行以下示例的同一目录中。下面的例子应该被命名为“fast_api_example.py”，这对uvicorn服务器在脚本中运行非常重要。</p><p id="cbcb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们创建一个数据类<em class="nf"> FooQuery </em>，然后将其转换为pydantic，作为类型传递给<em class="nf"> foo </em>端点:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="8526" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了测试它，我们执行脚本并使用<em class="nf">请求</em>模块对foo端点进行简单测试:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="f406" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">一切按预期运行。</p><h2 id="3139" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">最后的话</h2><p id="9efc" class="pw-post-body-paragraph ku kv it kw b kx mm ju kz la mn jx lc ld na lf lg lh nb lj lk ll nc ln lo lp im bi translated">现在我们知道了如何以简单的方式将平面pydantic转换为dataclasses，反之亦然。这种转换在几种情况下可能很方便，包括将dataclasses与FastAPI一起使用。</p><p id="0f3d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然而，我认为首先要仔细考虑你的应用程序的架构，尽量避免不必要的转换。pydantic和dataclasses都有很多特性和定制，其中大部分在翻译时会丢失。</p><p id="fd4f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">最后，关于嵌套模型，它们的转换很棘手。使用故事中的代码中的工具转换成嵌套模型的实例非常简单。但是要转换成一个类型(非实例化类)，我们必须首先声明所有嵌套模型的转换。如我所说，这部分很棘手。</p></div><div class="ab cl nm nn hx no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="im in io ip iq"><p id="90a7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我希望这个故事对你有用。如果你想知道更多类似的故事，请订阅。</p><div class="nt nu gp gr nv nw"><a href="https://medium.com/subscribe/@diego-barba" rel="noopener follow" target="_blank"><div class="nx ab fo"><div class="ny ab nz cl cj oa"><h2 class="bd iu gy z fp ob fr fs oc fu fw is bi translated">每当迭戈·巴尔巴出版时，就收到一封电子邮件。</h2><div class="od l"><h3 class="bd b gy z fp ob fr fs oc fu fw dk translated">每当迭戈·巴尔巴发表作品时，就收到一封电子邮件。注册后，如果您还没有，您将创建一个中型帐户…</h3></div><div class="oe l"><p class="bd b dl z fp ob fr fs oc fu fw dk translated">medium.com</p></div></div><div class="of l"><div class="og l oh oi oj of ok ko nw"/></div></div></a></div></div><div class="ab cl nm nn hx no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="im in io ip iq"><p id="7898" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">喜欢这个故事吗？通过我下面的推荐链接成为一个媒体成员来支持我的写作。无限制地访问我的故事和许多其他内容。</p><div class="nt nu gp gr nv nw"><a href="https://medium.com/@diego-barba/membership" rel="noopener follow" target="_blank"><div class="nx ab fo"><div class="ny ab nz cl cj oa"><h2 class="bd iu gy z fp ob fr fs oc fu fw is bi translated">通过我的推荐链接加入Medium-Diego Barba</h2><div class="od l"><h3 class="bd b gy z fp ob fr fs oc fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="oe l"><p class="bd b dl z fp ob fr fs oc fu fw dk translated">medium.com</p></div></div><div class="of l"><div class="ol l oh oi oj of ok ko nw"/></div></div></a></div></div></div>    
</body>
</html>