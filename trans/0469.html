<html>
<head>
<title>5 easy-to-implement tricks to trim down your Docker image size</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">5 个易于实施的小技巧来缩小你的 Docker 图片尺寸</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/5-easy-to-implement-tricks-to-trim-down-your-docker-image-size-263978a6ed29#2022-02-18">https://towardsdatascience.com/5-easy-to-implement-tricks-to-trim-down-your-docker-image-size-263978a6ed29#2022-02-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="46e3" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">最小化你的码头工人形象(外加一个加分)</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f644e84cbceadc80a79c04eabaeaafb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EtRbODsWnowISCei"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">这是一个非常小的建筑！(图片由<a class="ae ky" href="https://unsplash.com/photos/5EXvJvqqhEo" rel="noopener ugc nofollow" target="_blank"> unsplash </a>上的<a class="ae ky" href="https://unsplash.com/@edgeeffectmedia" rel="noopener ugc nofollow" target="_blank"> edgeeffectmedia </a>提供)</p></figure><p id="3d66" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇短文中，我们将介绍如何缩小 docker 图片尺寸的 5 个技巧(和一个好处)。通过这样做，我们更多地了解了 Docker 如何构建映像以及如何使用基本映像。我们来编码吧！</p><p id="f229" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们开始之前:我们使用了很多终端命令。不熟悉的话可以看看<a class="ae ky" href="https://mikehuls.medium.com/terminals-consoles-command-line-for-absolute-beginners-de7853c7f5e8" rel="noopener"> <strong class="lb iu">这篇文章</strong> </a>。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="2d5a" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">1.捆绑层</h1><p id="087e" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">Docker 图像的大小是其图层的总和。因为每一层都有一点点开销，所以我们可以通过减少层数来做一点点但非常容易的改进。</p><p id="a7f6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">只是改变:</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="ebba" class="nf me it nb b gy ng nh l ni nj">FROM python:3.9-slim<br/>RUN apt-get update -y<br/>RUN apt-get install some_package<br/>RUN apt-get install some_other_package</span></pre><p id="4d91" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">收件人:</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="bf62" class="nf me it nb b gy ng nh l ni nj">FROM python:3.9-slim<br/>RUN apt-get update -y &amp;&amp; apt install -y \<br/>   package_one \<br/>   package_two</span></pre><p id="0100" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我已经用一些用于构建的包对此进行了测试，并在下面列出了它们。正如你所看到的，我们通过捆绑层节省了大约 10MB。虽然这不是一个巨大的尺寸减少，但它非常令人印象深刻，因为它是这样一个小的努力。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/3466b7e1404a2e418a489af6b90ce631.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xAqDwi8qcUUJnah12iaAuQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">捆绑这些层在下面的包列表中节省了大约 10MB(图片由作者提供)</p></figure><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="5c21" class="nf me it nb b gy ng nh l ni nj"># packages:<br/>git, cmake, build-essential, jq, liblua5.2-dev, libboost-all-dev, libprotobuf-dev, libtbb-dev, libstxxl-dev, libbz2-d</span></pre></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="7243" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">2.避免安装不必要的软件包</h1><p id="cc37" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">如果你用 apt-get 安装软件包，添加<code class="fe nk nl nm nb b">--no-install-recommends</code>标签。这避免了在您正在安装的软件包旁边安装<em class="lv">推荐</em>但<em class="lv">不需要</em>的软件包。看起来是这样的:</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="947a" class="nf me it nb b gy ng nh l ni nj">FROM python:3.9-slim<br/>RUN apt-get update -y &amp;&amp; apt install -y --no-install-recommends \<br/>   package_one \<br/>   package_two</span></pre><p id="cef9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过添加这个标志，我们节省了大约 40MB。同样，这在整个计划中并不算多，但却非常重要，因为我们仅仅添加了一个标志。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/6e53cdc9347da211c7d1f1d10eb28b86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TNC-fnr820RIgXiJGmll2w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">通过添加一个简单的标志又减少了 40MB。让我们继续修剪这张图片(图片作者)</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/2e366c7bcc45ef8cf137fab3cd3f67fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nQBWbAM04dYMCI2Z"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">清理也会减少我们的图像尺寸(图片由<a class="ae ky" href="https://unsplash.com/@jeshoots" rel="noopener ugc nofollow" target="_blank">jeshoots.com</a>在<a class="ae ky" href="https://unsplash.com/photos/__ZMnefoI3k" rel="noopener ugc nofollow" target="_blank"> unsplash </a>上提供)</p></figure><h1 id="6acd" class="md me it bd mf mg no mi mj mk np mm mn jz nq ka mp kc nr kd mr kf ns kg mt mu bi translated">3.安装后清理</h1><p id="426a" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">安装包也有一些开销。我们可以通过将<code class="fe nk nl nm nb b">rm -rf /var/lib/apt/lists<em class="lv">/*</em></code> <strong class="lb iu"> <em class="lv"> </em> </strong>添加到<strong class="lb iu"> <em class="lv"> </em> </strong>来清理这个问题，就像这样:</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="bd45" class="nf me it nb b gy ng nh l ni nj">FROM python:3.9-slim<br/>RUN apt-get update -y &amp;&amp; apt install -y --no-install-recommends \<br/>    package_one \<br/>    package_two \<br/>    &amp;&amp; <!-- -->rm -rf /var/lib/apt/lists<em class="lv">/*</em></span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/cfe5871de33729e7d097bbd540b37194.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uQr4pDGYZ0J1q1v8hDLHtw.png"/></div></div></figure><p id="f7ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">用简单的一行代码又救了一个<strong class="lb iu"> 40MB </strong>！</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="699f" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">4.小一点的图像怎么样？</h1><p id="553d" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">这一点非常明显；用小一点的图像就好！正如您可能已经注意到的，在之前的代码片段中，我们已经使用了<code class="fe nk nl nm nb b">python:3.9-slim</code>，这导致图像总大小几乎为<strong class="lb iu"> 1GB </strong>，增加了所有之前的优化。与<code class="fe nk nl nm nb b">python:3.9</code>相比，这已经是一个很好的改进了(这将导致总大小为<strong class="lb iu"> 1.3GB </strong>)。</p><p id="cf9b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一个改进是使用<code class="fe nk nl nm nb b">python:3.9-alpine</code>。Alpine 集装箱是专门为在集装箱中运行而建造的，非常小，重量约为 49MB。这比我们使用<code class="fe nk nl nm nb b">python:3.9</code>时要小 20 倍以上。那么为什么不一直用阿尔卑斯呢？有一些缺点:</p><ul class=""><li id="94ec" class="nu nv it lb b lc ld lf lg li nw lm nx lq ny lu nz oa ob oc bi translated"><strong class="lb iu">兼容性问题</strong>:一些 Python 轮子是为 Debian 构建的，需要重新构建以兼容 Alpine。由于很难调试的兼容性问题，这可能会导致一些非常奇怪的错误。</li><li id="d482" class="nu nv it lb b lc od lf oe li of lm og lq oh lu nz oa ob oc bi translated"><strong class="lb iu">依赖关系</strong> : Alpine 用<code class="fe nk nl nm nb b">apk add</code>代替<code class="fe nk nl nm nb b">apt-get install</code>安装依赖关系。此外，并非所有的封装都可用，或者与 alpine 兼容。</li></ul><p id="2c90" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果磁盘空间是一个主要问题，我只建议使用 alpine。还可以查看下一部分，了解如何通过将 alpine 与构建阶段相结合来减轻其缺点。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="0aea" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">5.使用. dockerignore</h1><p id="3768" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">如果您创建了一个新的 Docker 映像，那么 Docker 需要访问您想要从中创建映像的文件。这些文件被称为构建上下文。每次构建图像时都会发送它们，因此最好尽量保持较小的规模。</p><p id="57a7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，添加一个 dockerignore 是一个非常好的想法，以防止机密的暴露。如果您使用<code class="fe nk nl nm nb b">ADD</code>或<code class="fe nk nl nm nb b">COPY</code>将文件复制到您的映像中，您可能会无意中复制到您不想烘焙到映像中的文件或文件夹(如<code class="fe nk nl nm nb b">.git</code>)。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="8242" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">奖励:多阶段构建</h1><p id="5305" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">有时候你需要像<code class="fe nk nl nm nb b">curl</code>、<code class="fe nk nl nm nb b">git</code>或<code class="fe nk nl nm nb b">make</code>这样的工具来建立你的形象。完成后，你就不再需要这些包了。他们现在所做的只是让我们的形象更大。解决这个问题的一个好方法是使用多阶段构建。下面我们将看一个简单的例子，它使用<code class="fe nk nl nm nb b">curl</code>作为我们构建映像所需的包之一，但是一旦我们的映像构建完成，它就变得多余了:</p><ol class=""><li id="0d6a" class="nu nv it lb b lc ld lf lg li nw lm nx lq ny lu oi oa ob oc bi translated">拍一个像<code class="fe nk nl nm nb b">ubuntu</code>的图像</li><li id="9305" class="nu nv it lb b lc od lf oe li of lm og lq oh lu oi oa ob oc bi translated">安装卷曲</li><li id="57e7" class="nu nv it lb b lc od lf oe li of lm og lq oh lu oi oa ob oc bi translated">将数据文件卷曲成图像(例如分类器)</li><li id="4de4" class="nu nv it lb b lc od lf oe li of lm og lq oh lu oi oa ob oc bi translated">现在我们再拍一张像<code class="fe nk nl nm nb b">python:3.9-slim</code>一样的照片</li><li id="306e" class="nu nv it lb b lc od lf oe li of lm og lq oh lu oi oa ob oc bi translated">将卷曲的文件从<code class="fe nk nl nm nb b">ubuntu</code>复制到<code class="fe nk nl nm nb b">python:3.9-slim</code>阶段</li><li id="9584" class="nu nv it lb b lc od lf oe li of lm og lq oh lu oi oa ob oc bi translated">其余的(例如，用 pip 安装包等。)</li></ol><p id="b617" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当这样做的时候，我们在我们的最终图像<em class="lv">中有了我们的分类器文件，而没有</em>我们的图像被卷曲<em class="lv">弄得臃肿。</em>另一个优势是，我们可以使用更丰富的映像来执行我们的安装(例如<code class="fe nk nl nm nb b">python:3.9</code>，然后将所有生成的文件复制到一个非常小的映像中(例如<code class="fe nk nl nm nb b">python:3.9-alpine</code>)。</p><p id="67c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个解决方案的想法很简单，但是执行起来有点棘手。查看这篇文章 获得一个不错的演练。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="75b5" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">结论</h1><p id="9af8" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">在这篇文章中，我们讨论了 5 个快速简单的方法来缩小你的 Docker 图片尺寸。一路上，我们对 Docker 构建图像的方式有了更多的了解。这篇文章主要集中在清理上，但是减少图像尺寸的最好方法是把构建层一起留下。这样我们甚至可以使用更小的图像，因为我们已经完成了所有复杂的任务。查看本文 了解更多关于这些所谓的多阶段构建的信息。</p><p id="5d10" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望这篇文章是清楚的，但如果你有建议/澄清，请评论，以便我可以做出改进。与此同时，请查看我的关于各种编程相关主题的其他文章:</p><ul class=""><li id="de49" class="nu nv it lb b lc ld lf lg li nw lm nx lq ny lu nz oa ob oc bi translated"><a class="ae ky" href="https://mikehuls.medium.com/docker-for-absolute-beginners-what-is-docker-and-how-to-use-it-examples-3d3b11efd830" rel="noopener">适合绝对初学者的 Docker</a></li><li id="29f2" class="nu nv it lb b lc od lf oe li of lm og lq oh lu nz oa ob oc bi translated">面向绝对初学者的 Docker 作曲</li><li id="7225" class="nu nv it lb b lc od lf oe li of lm og lq oh lu nz oa ob oc bi translated">将你的代码变成一个真正的程序:使用 Docker 打包、运行和分发脚本</li><li id="55bb" class="nu nv it lb b lc od lf oe li of lm og lq oh lu nz oa ob oc bi translated"><a class="ae ky" href="https://mikehuls.medium.com/why-is-python-so-slow-and-how-to-speed-it-up-485b5a84154e" rel="noopener">Python 为什么慢，如何加速</a></li><li id="ddb0" class="nu nv it lb b lc od lf oe li of lm og lq oh lu nz oa ob oc bi translated"><a class="ae ky" href="https://mikehuls.medium.com/advanced-multi-tasking-in-python-applying-and-benchmarking-threadpools-and-processpools-90452e0f7d40" rel="noopener">Python 中的高级多任务处理:应用线程池和进程池并进行基准测试</a></li><li id="5579" class="nu nv it lb b lc od lf oe li of lm og lq oh lu nz oa ob oc bi translated"><a class="ae ky" href="https://mikehuls.medium.com/write-your-own-c-extension-to-speed-up-python-x100-626bb9d166e7" rel="noopener">编写自己的 C 扩展来加速 Python x100 </a></li><li id="ae28" class="nu nv it lb b lc od lf oe li of lm og lq oh lu nz oa ob oc bi translated">【Cython 入门:如何用 Python 执行&gt;每秒 17 亿次计算</li><li id="dc80" class="nu nv it lb b lc od lf oe li of lm og lq oh lu nz oa ob oc bi translated"><a class="ae ky" href="https://mikehuls.medium.com/create-a-fast-auto-documented-maintainable-and-easy-to-use-python-api-in-5-lines-of-code-with-4e574c00f70e" rel="noopener">用 FastAPI 用 5 行代码创建一个快速自动归档、可维护且易于使用的 Python API</a></li></ul><p id="e887" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编码快乐！</p><p id="961d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">—迈克</p><p id="5bc6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">页（page 的缩写）学生:比如我正在做的事情？<a class="ae ky" href="https://mikehuls.medium.com/membership" rel="noopener">跟我来</a>！</p><div class="oj ok gp gr ol om"><a href="https://mikehuls.medium.com/membership" rel="noopener follow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd iu gy z fp or fr fs os fu fw is bi translated">通过我的推荐链接加入 Medium—Mike Huls</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">mikehuls.medium.com</p></div></div><div class="ov l"><div class="ow l ox oy oz ov pa ks om"/></div></div></a></div></div></div>    
</body>
</html>