<html>
<head>
<title>How to Connect to GCP Cloud SQL Instances in Cloud Run Services</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何连接到云运行服务中的GCP云SQL实例</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-connect-to-gcp-cloud-sql-instances-in-cloud-run-servies-1e60a908e8f2#2022-06-07">https://towardsdatascience.com/how-to-connect-to-gcp-cloud-sql-instances-in-cloud-run-servies-1e60a908e8f2#2022-06-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2cdf" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用私有IP在几分钟内连接到云SQL实例</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/933a0eaa5e4497272677c462454da761.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*v8LfuoGqw2yramdZ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由Pixabay的崔斯特·多·乌尔登提供</p></figure><p id="f71b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你使用谷歌云平台(GCP)，在你的云运行服务中访问云SQL是很常见的。这应该是一个简单的任务，因为云SQL和云Run都在同一个网络中。但是，当你自己做的时候，你可能无法在短时间内成功完成，因为网上的许多文档要么已经过时，要么过于复杂。经过几个小时的反复试验，我终于让它工作了。我认为写下我的解决方案是值得的，这样也可以节省其他人的时间。如果你做对了，其实很简单。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="7a7e" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">设置云SQL</h2><p id="97ed" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">由于Cloud SQL和Cloud Run都在Google云平台上，所以最好通过私有IP连接，以最小化网络延迟。如果“私有IP”选项尚未启用，请启用它。记下稍后将使用的网络和私有IP地址。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi na"><img src="../Images/a1ba531c0343ca4631c99a5b7d42ed2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uopfP_VWtVo87j_07iEgvw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/140dc22c13dffabee05b19c90d554741.png" data-original-src="https://miro.medium.com/v2/resize:fit:1384/format:webp/1*1X1Ut6o0k6sZp_U8IimjOg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="c863" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">创建VPC连接器</h2><p id="6423" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated"><a class="ae ky" href="https://cloud.google.com/vpc/docs/vpc" rel="noopener ugc nofollow" target="_blank">虚拟专用云(VPC) </a>是物理网络的虚拟版本，在谷歌的生产网络内部实施，可用于连接平台上创建的所有类型的资源。这实际上是一个非常复杂和抽象的概念。现在，你只需要明白<em class="nc">无服务器VPC访问</em>允许云功能、云运行服务和应用引擎应用使用它们的私有IP访问VPC网络中的资源。让我们创建一个VPC连接器，我们的云运行服务可以使用它来连接到我们的云SQL实例。</p><p id="cb10" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在顶部搜索框中搜索“无服务器VPC接入”，然后选择“无服务器VPC接入(VPC网络)”。然后单击“创建连接器”创建一个新的VPC连接器:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nd"><img src="../Images/e43d945dd2f2e3c716cf84e8cc8766b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3SZQhAmmCLWrgyBCL4FK-Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="48bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">按如下方式填写表格:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ne"><img src="../Images/9694e4732360ba0a273a88ae2e97bf1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MoGaM7iMA1EZoCgmNVsP4w.png"/></div></div></figure><ul class=""><li id="2660" class="nf ng it lb b lc ld lf lg li nh lm ni lq nj lu nk nl nm nn bi translated">给它一个唯一的名称。</li><li id="e0cc" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">选择与您的云SQL实例和云运行服务相同的区域。这一点非常重要，否则您将无法使用这个连接器连接到云SQL实例。</li><li id="8fa8" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">选择与您的云SQL实例相同的网络。如果你有多个网络，这也很重要。</li><li id="5239" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">为“子网”选择“自定义IP范围”。</li><li id="266c" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">指定IP范围以覆盖您的云SQL实例的私有IP地址。在本例中，它被设置为“10.104.0.0”。IP范围不能与现有范围冲突。</li></ul><p id="9019" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您可以单击“创建”来创建VPC连接器。应该注意的是，VPC连接器不是免费的。它们实际上使用起来相当昂贵。因此，当不再需要它们时，一定要记得删除它们。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="c616" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">配置云运行服务帐户</h2><p id="f575" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">云运行服务账号，默认为<strong class="lb iu"> <em class="nc">计算引擎默认服务账号</em> </strong>，应该有<strong class="lb iu"> <em class="nc">云SQL客户端</em> </strong>角色，有权限连接云SQL。</p><p id="1d43" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在IAM页面上，搜索“计算引擎默认服务帐户”，然后单击铅笔按钮为其添加云SQL客户端角色:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/7731f698ced713b805e3163e6c0c5329.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SGRx8oV0zTGGh-oYf_KXBw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/e46fcff3f059f66d44baa52e5791f948.png" data-original-src="https://miro.medium.com/v2/resize:fit:1108/format:webp/1*W3_pkxfoQXsBK5aBiAJWpQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="c12a" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">创建云运行服务</h2><p id="bb6b" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">最后，让我们创建一个云运行服务，并使用刚刚创建的VPC连接器将它连接到我们的云SQL实例。尝试在GCP平台找到“云跑”，点击“创建服务”创建一个新的:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/b5c1e84f5b08db75b50916491fcd0ecb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1226/format:webp/1*To98bTMpBpLPhkai1ez2rA.png"/></div></figure><p id="27f5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">重要的是，选择与云SQL实例和VPC连接器相同的区域。关于如何自动部署云运行服务的更详细介绍，<a class="ae ky" href="https://betterprogramming.pub/how-to-deploy-a-web-application-to-cloud-run-automatically-6967d7c7d42a" rel="noopener ugc nofollow" target="_blank">这篇文章</a>可能会有所帮助。</p><p id="da42" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">出于演示目的，我们通常会选择“允许所有流量”和“允许未经身份验证的调用”。如果需要，您可以使用IAM添加更细粒度的身份验证。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/6cc014cb9ce9cd2c01cafce50b6e7d52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1074/format:webp/1*F5qZdvr4JQtLQNws-yxXKQ.png"/></div></figure><p id="b2d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在展开“容器、变量和秘密、连接、安全性”部分，并指定连接和环境变量。我们先设置连接。单击“连接”选项卡，然后单击“添加连接”来添加新的连接。选择要连接的云SQL实例。然后选择在上一步中创建的“VPC连接器”。请注意，如果连接器的区域不同于正在创建的云运行服务的区域，则不会显示VPC连接器。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/3d8555bebbdf8d7385b28561c5d52920.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*6g28NIOKcfYyX_Bj-D7kLA.png"/></div></figure><p id="38d4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后我们需要为我们的数据库连接创建一些环境变量，这些变量将在我们的云运行服务中使用:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/aad7953bfb52b30b0e8531eadf630ec3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*YPKBmCmX_JxqSGtysDdoSA.png"/></div></figure><p id="3fb4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">非常重要！我们需要将我们的云SQL实例的私有IP地址指定为DB主机，而不是像某些教程中显示的“127.0.0.1”或“localhost”，否则无法工作。</p><p id="7331" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">环境变量将在您的云运行服务的代码中使用，以连接到云SQL实例。如果您使用SQLAlchemy连接到MySQL数据库，代码将如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="e0de" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果需要，您可以查看相应的文章，了解如何使用SQLAlchemy来<a class="ae ky" href="https://betterprogramming.pub/how-to-execute-plain-sql-queries-with-sqlalchemy-627a3741fdb1" rel="noopener ugc nofollow" target="_blank">执行普通SQL查询</a>和<a class="ae ky" href="https://levelup.gitconnected.com/learn-the-basics-and-get-started-with-sqlalchemy-orm-from-scratch-66c8624b069" rel="noopener ugc nofollow" target="_blank">创建ORM模型</a>。</p><p id="48f4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您应该能够从云运行服务连接到您的云SQL实例。试一试！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="1f2b" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">结论</h2><p id="66ed" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">如果我们在Cloud Run上托管我们的后端代码，我们需要连接到Cloud SQL是很常见的。然而，虽然看起来微不足道，但是有很多陷阱会导致连接失败。在本文中，我们已经介绍了一般的设置过程，还强调了可能会导致几个小时的努力时间的陷阱。这篇文章的主要内容如下:</p><ul class=""><li id="e4e2" class="nf ng it lb b lc ld lf lg li nh lm ni lq nj lu nk nl nm nn bi translated">SQL实例和VPC连接器的网络应该相同。</li><li id="9868" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">SQL实例、VPC连接器和云运行服务的区域应该相同。</li><li id="ebff" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">应该在云运行服务中使用SQL实例的私有IP进行连接。</li></ul></div></div>    
</body>
</html>