<html>
<head>
<title>Deploy Machine Learning Model Using Python Dash and Pipenv</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Python Dash 和 Pipenv 部署机器学习模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploy-machine-learning-model-using-dash-and-pipenv-c543569c33a6#2022-03-14">https://towardsdatascience.com/deploy-machine-learning-model-using-dash-and-pipenv-c543569c33a6#2022-03-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c091" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用 Github 和 Heroku 公开托管一个 Web 应用</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/52dfcead2f70ed5d20436e515acec170.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fsz7x0s7rMnOgYkfw_-80w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="40b0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">数据科学家和机器学习工程师花费大量时间进行探索性数据分析(EDA)、ML 模型开发和超参数调整。通常，项目的最终目标是在生产中部署机器学习模型<strong class="la iu">。本文旨在介绍一种简单而有效的方法来开发一个<strong class="la iu"> web 应用程序</strong>，将一个经过训练的 ML 模型投入生产:<strong class="la iu"> Dash 和 Pipenv </strong>。</strong></p><h1 id="ed33" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">步骤 1:创建虚拟环境</h1><p id="bafa" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">虚拟环境是一种工具，它创建一个隔离的空间来存储所有程序和文件，并保留项目所需的 Python 包的依赖关系。</p><h2 id="22d5" class="mr lv it bd lw ms mt dn ma mu mv dp me lh mw mx mg ll my mz mi lp na nb mk nc bi translated">为什么虚拟环境是必要的？</h2><p id="f3b6" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">其他人可能会问你“<strong class="la iu">为什么你的程序会在我的电脑上崩溃？</strong>“Python 有其独特的安装、存储和加载其包的方式，以便底层程序能够正常运行。<em class="nd">如果您要在不同的项目之间切换或与其他人共享您的项目，创建一个虚拟环境会使管理所需的包变得更加容易</em>。它是一个有用的工具，可以给项目带来很多好处。</p><ul class=""><li id="9c6c" class="ne nf it la b lb lc le lf lh ng ll nh lp ni lt nj nk nl nm bi translated">它可以<strong class="la iu">在每个项目的基础上保持包</strong>的依赖性。例如，您可以在同一台计算机上对一个项目使用 Dash 2.1，对另一个项目使用 Dash 2.2。</li><li id="3b0f" class="ne nf it la b lb nn le no lh np ll nq lp nr lt nj nk nl nm bi translated">它可以为你的程序创建一个<strong class="la iu">隔离空间</strong>，这样你的项目就是独立的，并且<strong class="la iu">可以用所需的包</strong>进行复制。</li><li id="6882" class="ne nf it la b lb nn le no lh np ll nq lp nr lt nj nk nl nm bi translated">在虚拟环境中，您可以安装软件包<strong class="la iu">而无需管理员权限</strong>。</li></ul><p id="5a51" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">创建虚拟环境有不同的工具。对于本文，我将使用<code class="fe ns nt nu nv b">pipenv</code>为我们的 ML 项目建立一个虚拟环境。</p><h2 id="8111" class="mr lv it bd lw ms mt dn ma mu mv dp me lh mw mx mg ll my mz mi lp na nb mk nc bi translated">安装管道</h2><pre class="kj kk kl km gt nw nv nx ny aw nz bi"><span id="0f45" class="mr lv it nv b gy oa ob l oc od">pip install pipenv</span></pre><h2 id="86a4" class="mr lv it bd lw ms mt dn ma mu mv dp me lh mw mx mg ll my mz mi lp na nb mk nc bi translated">初始化虚拟环境</h2><p id="35df" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">打开 anaconda 提示符或命令提示符，键入以下命令来初始化虚拟环境。最初，它将在项目文件夹中创建一个名为“<strong class="la iu"> Pipfile </strong>”的文件。该文件将包含项目所需的所有包。</p><pre class="kj kk kl km gt nw nv nx ny aw nz bi"><span id="0739" class="mr lv it nv b gy oa ob l oc od">cd "project folder path"<br/>pipenv shell</span></pre><h2 id="32b3" class="mr lv it bd lw ms mt dn ma mu mv dp me lh mw mx mg ll my mz mi lp na nb mk nc bi translated">在虚拟环境中安装 Python 包</h2><p id="6229" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">在命令提示符下键入以下命令。<code class="fe ns nt nu nv b">pipenv install [package]</code>将在虚拟环境中安装软件包，并更新“Pipfile”文件以包含所有已安装的软件包。<code class="fe ns nt nu nv b">pipenv lock</code>将创建一个名为“<strong class="la iu"> Pipfile.lock </strong>”的文件，其中包含项目的依赖项和子依赖项、已安装的版本以及已下载文件的散列。这确保了<em class="nd">确定性的</em>构建。</p><pre class="kj kk kl km gt nw nv nx ny aw nz bi"><span id="c495" class="mr lv it nv b gy oa ob l oc od">pipenv install "scikit-learn==1.0.2"<br/>pipenv install "xgboost==1.4.2"<br/>pipenv install "dash==2.3.0"<br/>pipenv install "dash-bootstrap-components==1.0.3"<br/>pipenv install "numpy==1.22.3"<br/>pipenv lock</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/e241452089ab9389fca56bb0a933c69e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9d_2zhbCuNtaEAaiWGvroA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Pipfile(作者图片)</p></figure><p id="a023" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在虚拟环境中卸载包。您可以在移除包后使用<code class="fe ns nt nu nv b">pipenv uninstall [package1] [package2] [package3] ...</code>，运行<code class="fe ns nt nu nv b">pipenv lock</code>来更新“Pipfile.lock”。</p><h1 id="f523" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">步骤 2:开发一个 ML 模型</h1><p id="507b" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">在我们创建了一个虚拟环境并安装了所有必要的 Python 包之后，我们就可以开始开发我们的机器学习模型了。对于本文，我们不打算关注模型开发和超参数调整，所以我使用 XGBoost 开发了一个简单的分类模型来预测鸢尾花的种类。</p><p id="47d4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在我们训练完 ML 模型(即 clf)之后，我们可以使用<code class="fe ns nt nu nv b">pickle</code>导出模型，这是一个序列化和反序列化 Python 对象的有用工具。确保导出项目文件夹中的 ML 模型，因为我们将在 Dash 程序中部署 ML 模型。</p><pre class="kj kk kl km gt nw nv nx ny aw nz bi"><span id="0d29" class="mr lv it nv b gy oa ob l oc od"><strong class="nv iu"># ML_model.py</strong><br/>from sklearn import datasets<br/>from <strong class="nv iu">xgboost </strong>import XGBClassifier<br/>import pickle</span><span id="f34b" class="mr lv it nv b gy of ob l oc od">#Importing dataset from sklearn<br/>iris = datasets.load_iris() <br/>X = iris.data               <br/>y = iris.target</span><span id="89c1" class="mr lv it nv b gy of ob l oc od">#Create an XGB classifier<br/><strong class="nv iu">clf = XGBClassifier()<br/>clf.fit(X, y)</strong></span><span id="cf32" class="mr lv it nv b gy of ob l oc od"># Export the ML model<br/>with open(r'<strong class="nv iu">xgb_model_iris.pickle</strong>', 'wb') as f:<br/>    <strong class="nv iu">pickle</strong>.dump(clf, f)</span></pre><h1 id="8ef3" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">步骤 3:使用 Dash 开发一个 Web 应用程序</h1><p id="60d2" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">现在我们可以开始开发一个漂亮的前端 Web 应用程序来部署我们的 ML 模型。我们将使用由<strong class="la iu"> Flask </strong>、<strong class="la iu"> Plotly.js </strong>和<strong class="la iu"> React.js </strong>编写的轻量级 Python 框架<a class="ae og" href="https://dash.plotly.com/" rel="noopener ugc nofollow" target="_blank">、Dash  </a>来构建 web 应用。</p><p id="a7d6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Dash 程序需要几个步骤。</p><ul class=""><li id="3725" class="ne nf it la b lb lc le lf lh ng ll nh lp ni lt nj nk nl nm bi translated">导入所需的库(例如，dash、dash_bootstrap_components、pickle 等)</li><li id="64ac" class="ne nf it la b lb nn le no lh np ll nq lp nr lt nj nk nl nm bi translated">dash 环境的设置</li><li id="2f80" class="ne nf it la b lb nn le no lh np ll nq lp nr lt nj nk nl nm bi translated">使用 Pickle 加载 ML 模型</li><li id="7249" class="ne nf it la b lb nn le no lh np ll nq lp nr lt nj nk nl nm bi translated">为 web 应用程序准备<strong class="la iu">布局</strong>，以便用户可以为 ML 模型输入他们的输入(例如，萼片长度、萼片宽度、花瓣长度和花瓣宽度)。输入可以采取不同的形式，例如，下拉菜单、文本框、滑块<strong class="la iu">和复选框。为了让 app 结构看起来漂亮，我们将使用<code class="fe ns nt nu nv b">dash_bootstrap_components</code>这个包，它将<a class="ae og" href="https://getbootstrap.com/" rel="noopener ugc nofollow" target="_blank"> <em class="nd"> Bootstrap </em> </a>框架集成到 Dash app 中。</strong></li><li id="ae4a" class="ne nf it la b lb nn le no lh np ll nq lp nr lt nj nk nl nm bi translated">创建<strong class="la iu">回调</strong>以接收来自用户的输入，运行 ML 模型，然后输出预测(例如，鸢尾花的种类)。</li></ul><pre class="kj kk kl km gt nw nv nx ny aw nz bi"><span id="68e0" class="mr lv it nv b gy oa ob l oc od"><strong class="nv iu"># Dash_App.py</strong><br/><strong class="nv iu">### Import Packages ########################################</strong><br/>import <strong class="nv iu">dash</strong><br/>from dash import dcc<br/>from dash import html<br/>from dash.dependencies import Input, Output, State<br/>import dash_bootstrap_components as dbc<br/>import numpy as np<br/>import pickle</span><span id="de3e" class="mr lv it nv b gy of ob l oc od"><strong class="nv iu">### Setup ###################################################</strong><br/>app = dash.Dash(__name__)<br/>app.title = 'Machine Learning Model Deployment'<br/>server = app.server</span><span id="d978" class="mr lv it nv b gy of ob l oc od"><strong class="nv iu">### load ML model ###########################################</strong><br/>with open('<strong class="nv iu">xgb_model_iris.pickle</strong>', 'rb') as f:<br/>    clf = pickle.load(f)</span><span id="8895" class="mr lv it nv b gy of ob l oc od"><strong class="nv iu">### App Layout ###############################################</strong><br/>app.layout = html.Div([<br/>    <strong class="nv iu">dbc.Row</strong>([html.H3(children='Predict Iris Flower Species')]),<br/>    dbc.Row([<br/>        <strong class="nv iu">dbc.Col</strong>(html.Label(children='Sepal Length (CM):'), width={"order": "first"}),<br/>        dbc.Col(<strong class="nv iu">dcc.Slider</strong>(min=4, max=8, value = 5.8, id='sepal_length')) <br/>    ]),<br/>    dbc.Row([<br/>        dbc.Col(html.Label(children='Sepal Width (CM):'), width={"order": "first"}),<br/>        dbc.Col(dcc.Slider(min=2.0, max=5,  value = 3.0, id='sepal_width')) <br/>    ]),<br/>    dbc.Row([<br/>        dbc.Col(html.Label(children='Petal Length (CM):'), width={"order": "first"}),<br/>        dbc.Col(dcc.Slider(min=1.0, max=7,  value = 3.8, id='petal_length')) <br/>    ]),<br/>    dbc.Row([<br/>        dbc.Col(html.Label(children='Petal Width (CM):'), width={"order": "first"}),<br/>       dbc.Col( dcc.Slider(min=0.1, max=3,  value = 1.2, id='petal_width')) <br/>    ]),   <br/>    dbc.Row([dbc.Button('Submit', id='submit-val', n_clicks=0, color="primary")]),<br/>    html.Br(),<br/>    dbc.Row([html.Div(id='prediction output')])<br/>    <br/>    ], style = {'padding': '0px 0px 0px 150px', 'width': '50%'})</span><span id="589f" class="mr lv it nv b gy of ob l oc od"><strong class="nv iu">### Callback to produce the prediction #########################</strong> <br/><a class="ae og" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.<strong class="nv iu">callback</strong>(<br/>    <strong class="nv iu">Output</strong>('prediction output', 'children'),<br/>    <strong class="nv iu">Input</strong>('submit-val', 'n_clicks'),<br/>    State('sepal_length', 'value'),<br/>    State('sepal_width', 'value'),<br/>    State('petal_length', 'value'), <br/>    State('petal_width', 'value')<br/>)<br/>   <br/>def update_output(n_clicks, sepal_length, sepal_width, petal_length, petal_width):    <br/>    x = np.array([[float(sepal_length), float(sepal_width), float(petal_length), float(petal_width)]])<br/>    prediction = <strong class="nv iu">clf.predict</strong>(x)[0]<br/>    if prediction == 0:<br/>        output = 'Iris-Setosa'<br/>    elif prediction == 1:<br/>        output = 'Iris-Versicolor'<br/>    else:<br/>        output = 'Iris-Virginica'<br/>    return f'The predicted Iris species is {output}.'</span><span id="b42b" class="mr lv it nv b gy of ob l oc od"><strong class="nv iu">### Run the App ###############################################</strong><br/>if __name__ == '__main__':<br/>    app.run_server(debug=True)</span></pre><h1 id="3eee" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">步骤 4:在本地部署 ML 应用程序</h1><p id="4329" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">完成 Dash 程序后，我们现在可以在本地机器上部署 web 应用程序。打开 anaconda 提示符或命令提示符，并键入以下命令。</p><pre class="kj kk kl km gt nw nv nx ny aw nz bi"><span id="5ce9" class="mr lv it nv b gy oa ob l oc od">cd [project folder path]<br/>pipenv shell<br/>python <strong class="nv iu">Dash_App.py</strong></span></pre><p id="d48b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">它将运行我们的应用程序，该应用程序将在<a class="ae og" href="http://localhost:8050/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8050/ </a>或<a class="ae og" href="http://127.0.0.1:8050/" rel="noopener ugc nofollow" target="_blank"> http://127.0.0.1:8050/ </a>上提供。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/02fb2f6a1ad49b7a03130f22b003e9ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fDz-T5J04TjzVJYKfZ_pdw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><h1 id="7551" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">第五步:用 GitHub 和 Heroku 公开部署 ML 应用</h1><p id="3359" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">在公共网站上部署 web 应用程序最简单的方法之一是使用<a class="ae og" href="https://www.heroku.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu"> Heroku </strong> </a>，这是一种云平台服务，只需一个免费帐户即可托管 web 应用程序。我们可以将所有的文件和程序导出到一个<a class="ae og" href="https://github.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu"> Github </strong> </a>仓库，然后将 Github 仓库链接到你的 Heroku 账户，并在仓库中部署一个分支。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/bd72944cc8d6aa143f68592e54db35d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mhXqPs2XGXq9hLtXx_TVYg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="d09b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">除了我们上面提到的文件和程序，我们还需要存储库中的两个附加文件来在 Heroku 中正确运行应用程序，<strong class="la iu"> Procfile </strong>和<strong class="la iu"> runtime.txt. </strong></p><p id="fc9c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以下是<strong class="la iu"> Procfile 的一个例子。</strong>这是一个没有文件扩展名的简单文本文件。“gunicorn”是一个用于 WSGI 应用程序的纯 Python HTTP 服务器，允许多个用户同时访问应用程序。这里的“Dash_App:server”表示 Dash_App.py 内部的服务器对象。</p><pre class="kj kk kl km gt nw nv nx ny aw nz bi"><span id="7861" class="mr lv it nv b gy oa ob l oc od">web: gunicorn Dash_App:server</span></pre><p id="a4a0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下面是一个<strong class="la iu"> runtime.txt 的例子。</strong>它指定了一个 Python 运行时(例如，主要、次要和补丁)。它区分大小写，不得包含空格。</p><pre class="kj kk kl km gt nw nv nx ny aw nz bi"><span id="2967" class="mr lv it nv b gy oa ob l oc od">python-3.8.5</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/7406262b2606f153dfc41be6f50d9b95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VbJugllosxenu-96N2jgKg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><h1 id="c671" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">感谢您的阅读！！！</h1><p id="6728" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">如果你喜欢这篇文章，并且想<strong class="la iu">请我喝杯咖啡，请</strong>点击这里。</p><p id="b863" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您可以注册一个<a class="ae og" href="https://aaron-zhu.medium.com/membership" rel="noopener"> <strong class="la iu">会员</strong> </a>来解锁我的文章的全部访问权限，并且可以无限制地访问介质上的所有内容。如果你想在我发表新文章时收到电子邮件通知，请订阅。</p></div></div>    
</body>
</html>