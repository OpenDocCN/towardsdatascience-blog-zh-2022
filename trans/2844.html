<html>
<head>
<title>Build a data pipeline on AWS with Kafka, Kafka connect and DynamoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Kafka、Kafka connect和DynamoDB在AWS上构建数据管道</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/build-a-data-pipeline-on-aws-with-kafka-kafka-connect-and-dynamodb-97642cdb0cfb#2022-06-21">https://towardsdatascience.com/build-a-data-pipeline-on-aws-with-kafka-kafka-connect-and-dynamodb-97642cdb0cfb#2022-06-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="6206" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated"><strong class="ak">集成DynamoDB与MSK和MSK连接</strong></h2></div><p id="6fbd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有许多方法可以缝合数据管道——开源组件、托管服务、ETL工具等。在卡夫卡的世界里，<a class="ae lb" href="https://kafka.apache.org/documentation/#connect" rel="noopener ugc nofollow" target="_blank"> Kafka Connect </a>是<em class="lc">“Apache Kafka和其他系统之间的流数据”</em>的首选工具。它有一套广泛的预建源和接收器连接器，以及<em class="lc">Kafka连接器的通用框架</em>，该框架将其他数据系统与Kafka的集成标准化，并使开发自己的连接器变得更加简单，如果有必要的话。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi ld"><img src="../Images/9ac133f5ce74c3900f3eee7380e87bc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kPiQ6elBZv4ah3xb"/></div></div><p class="lp lq gj gh gi lr ls bd b be z dk translated">照片由<a class="ae lb" href="https://unsplash.com/@mbenna?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">迈克·本纳</a>在<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="644d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是一个由两部分组成的博客系列<strong class="kh ir">,它提供了Kafka和Kafka Connect的数据管道的逐步演示。出于演示目的，我将使用AWS，但是这些概念适用于任何等效的选项(例如，使用Docker在本地运行这些选项)。以下是我将使用的一些关键AWS服务:</strong></p><ul class=""><li id="9fa2" class="lt lu iq kh b ki kj kl km ko lv ks lw kw lx la ly lz ma mb bi translated"><a class="ae lb" href="https://docs.aws.amazon.com/msk/latest/developerguide/what-is-msk.html" rel="noopener ugc nofollow" target="_blank">亚马逊为Apache Kafka (MSK)管理流媒体</a> —数据基础设施的核心组件。</li><li id="80e4" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la ly lz ma mb bi translated"><a class="ae lb" href="https://docs.aws.amazon.com/msk/latest/developerguide/msk-connect.html" rel="noopener ugc nofollow" target="_blank"> MSK连接</a> —它将用于部署为Kafka Connect构建的完全受管连接器，以便将数据移入各种源或从各种源提取数据。</li><li id="ec61" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la ly lz ma mb bi translated"><a class="ae lb" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Introduction.html" rel="noopener ugc nofollow" target="_blank"> Amazon DynamoDB </a>是一个完全托管的NoSQL数据库服务，在这个博客系列的上下文中，它充当我们的数据管道的目标/接收器。</li><li id="615c" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la ly lz ma mb bi translated">亚马逊Aurora MySQL 是一个完全托管的、兼容MySQL的关系数据库引擎，在本博客系列的第二部分中使用。</li></ul><p id="bc15" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">以下是每个部分将涵盖的内容:</p><ul class=""><li id="3d45" class="lt lu iq kh b ki kj kl km ko lv ks lw kw lx la ly lz ma mb bi translated">第一部分将保持事情相对简单——它是关于容易地开始。我将使用<a class="ae lb" href="https://github.com/confluentinc/kafka-connect-datagen" rel="noopener ugc nofollow" target="_blank"> Kafka Connect Datagen source连接器</a>将一些样本数据泵入MSK主题，然后使用<a class="ae lb" href="https://docs.confluent.io/kafka-connect-aws-dynamodb/current/overview.html" rel="noopener ugc nofollow" target="_blank"> AWS DynamoDB接收器连接器</a>将这些数据保存在DynamoDB表中。</li><li id="0332" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la ly lz ma mb bi translated">第二部分将更上一层楼，我们将探索变更数据捕获。Datagen连接器将被MySQL的<a class="ae lb" href="https://debezium.io/documentation/reference/1.9/connectors/mysql.html" rel="noopener ugc nofollow" target="_blank"> Debezium连接器</a>所取代，它将从Aurora MySQL的表中实时提取数据，并将其推送到MSK主题。然后，我们将像以前一样继续使用DynamoDB接收器连接器。</li></ul></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h1 id="7624" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">准备基础设施组件和服务</h1><p id="6805" class="pw-post-body-paragraph kf kg iq kh b ki ng jr kk kl nh ju kn ko ni kq kr ks nj ku kv kw nk ky kz la ij bi translated">首先，您需要部署本教程所需的所有资源。有很多，但不要担心，因为我已经为你准备好了云形成模板！</p><p id="2e37" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">继续之前，请从</strong> <a class="ae lb" href="https://gist.github.com/abhirockzz/6ab9a653f1edd7aa612917a1f596b4d4" rel="noopener ugc nofollow" target="_blank"> <strong class="kh ir">此链接</strong> </a>下载模板</p><p id="02ab" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是这篇博文中提出的解决方案的高级示意图。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi nl"><img src="../Images/699fad731d4bfce10a2bbb2abc055d47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5MRaZ2JZ6izRHUUy.png"/></div></div><p class="lp lq gj gh gi lr ls bd b be z dk translated">高层架构(图片由作者提供)</p></figure><blockquote class="nm nn no"><p id="ead5" class="kf kg lc kh b ki kj jr kk kl km ju kn np kp kq kr nq kt ku kv nr kx ky kz la ij bi translated"><em class="iq">有关逐步说明，请参考官方文档</em>中的 <a class="ae lb" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-console-create-stack.html" rel="noopener ugc nofollow" target="_blank"> <em class="iq">在AWS CloudFormation控制台</em> </a> <em class="iq">上创建堆栈</em></p></blockquote><p id="1779" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用AWS控制台部署CloudFormation模板——在<strong class="kh ir">创建堆栈</strong>向导上，选择<strong class="kh ir">上传模板文件</strong>并上传您刚刚下载的文件。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi nl"><img src="../Images/48c7ab7d4f0181f85612930e59cf1718.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*VrftIotE90z6t9Af.png"/></div></div></figure><p id="63ad" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">点击<strong class="kh ir">下一个</strong>，输入堆栈的名称。单击<strong class="kh ir">下一步</strong>继续—在向导的最后一页，单击<strong class="kh ir">创建堆栈</strong>开始创建资源。</p><p id="44df" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以在CloudFormation控制台中跟踪进度。一旦成功，您应该拥有所有资源，包括:</p><ul class=""><li id="cf39" class="lt lu iq kh b ki kj kl km ko lv ks lw kw lx la ly lz ma mb bi translated">核心基础设施:VPC、子网等。</li><li id="022a" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la ly lz ma mb bi translated">服务:MSK集群，极光MySQL等。</li><li id="66f3" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la ly lz ma mb bi translated">其他:IAM角色、CloudWatch日志组等。</li></ul><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi nl"><img src="../Images/4c70e37c8a64571833026972acfbac09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*BHJv8pt1KQEg7OPh.png"/></div></div></figure><p id="04ab" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">通过会话管理器</strong>连接到EC2实例</p><p id="110f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在CloudFormation资源列表中，找到<code class="fe ns nt nu nv b">KafkaClientEC2Instance</code> EC2实例(在上图中突出显示)</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi nl"><img src="../Images/97e4c4a650c01a39384958a9c244421d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hCCryBcGcmTzyRFG.png"/></div></div></figure><p id="e028" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用会话管理器连接到它:</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi nl"><img src="../Images/937cc83d09476436c5dbf2045c3cf380.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*axMH7XpIn96r8jHO.png"/></div></div></figure><p id="82e4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">启用自动主题创建</strong></p><p id="d45a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">MSK连接要求即时创建主题。我们可以在MSK创建一个<a class="ae lb" href="https://docs.aws.amazon.com/msk/latest/developerguide/msk-configuration-properties.html" rel="noopener ugc nofollow" target="_blank">定制配置</a>来实现自动主题创建。</p><p id="d630" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从EC2实例中，运行以下命令来创建自定义配置:</p><pre class="le lf lg lh gt nw nv nx ny aw nz bi"><span id="c716" class="oa mp iq nv b gy ob oc l od oe">sudo -u ec2-user -i<br/>mkdir kafka-configuration &amp;&amp; cd kafka-configuration</span><span id="557d" class="oa mp iq nv b gy of oc l od oe">cat &lt;&lt;EOF &gt; configuration.txt <br/>auto.create.topics.enable=true<br/>EOF</span><span id="f5bf" class="oa mp iq nv b gy of oc l od oe">export AWS_REGION=&lt;enter MSK cluster region e.g. us-east-1&gt;<br/>export AWS_REGION=us-east-1</span><span id="6dc0" class="oa mp iq nv b gy of oc l od oe">aws kafka create-configuration \<br/>    --name "CustomConfiguration" \<br/>    --description "Topic auto-creation enabled" \<br/>    --kafka-versions "2.6.2" \<br/>    --region $AWS_REGION \<br/>    --server-properties file://configuration.txt</span></pre><p id="a9f4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">继续并应用此配置:</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi nl"><img src="../Images/7f0d3106ea1681a5dcb6de0a92673af8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Yub1OJRV5aesadjz.png"/></div></div></figure><p id="1295" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">转到您的<code class="fe ns nt nu nv b">MSK cluster &gt; Properties &gt; Configuration</code>并选择<strong class="kh ir">编辑</strong>。<br/>选择您刚刚创建的配置，然后<strong class="kh ir">保存</strong>。这将<em class="lc">重启</em>您的MSK集群——请等待此操作完成后再继续。</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h1 id="55d7" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">数据管道:第1部分</h1><p id="39cf" class="pw-post-body-paragraph kf kg iq kh b ki ng jr kk kl nh ju kn ko ni kq kr ks nj ku kv kw nk ky kz la ij bi translated">让我们首先创建管道的前半部分，它将利用Datagen source connector将样本事件抽取到MSK的一个主题中。</p><p id="6fee" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本节中，您将:</p><ul class=""><li id="d7a8" class="lt lu iq kh b ki kj kl km ko lv ks lw kw lx la ly lz ma mb bi translated">下载Datagen连接器产品</li><li id="9ced" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la ly lz ma mb bi translated">在MSK创建自定义插件</li><li id="9c35" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la ly lz ma mb bi translated">将Datagen源连接器部署到MSK连接</li></ul><p id="59b0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，数据管道的前半部分将准备就绪！</p><h2 id="06fa" class="oa mp iq bd mq og oh dn mu oi oj dp my ko ok ol na ks om on nc kw oo op ne oq bi translated">创建自定义插件和连接器</h2><p id="2b05" class="pw-post-body-paragraph kf kg iq kh b ki ng jr kk kl nh ju kn ko ni kq kr ks nj ku kv kw nk ky kz la ij bi translated"><strong class="kh ir">将Datagen连接器文件上传到</strong>T1</p><p id="2986" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从Kafka客户端EC2实例中，运行以下命令:</p><pre class="le lf lg lh gt nw nv nx ny aw nz bi"><span id="acd0" class="oa mp iq nv b gy ob oc l od oe">sudo -u ec2-user -i<br/>mkdir kafka-connect-datagen &amp;&amp; cd kafka-connect-datagen</span><span id="6eec" class="oa mp iq nv b gy of oc l od oe">wget https://d1i4a15mxbxib1.cloudfront.net/api/plugins/confluentinc/kafka-connect-datagen/versions/0.5.3/confluentinc-kafka-connect-datagen-0.5.3.zip<br/>aws s3 cp ./confluentinc-kafka-connect-datagen-0.5.3.zip s3://msk-lab-&lt;ENTER_YOUR_AWS_ACCOUNT_ID&gt;-plugins-bucket/</span><span id="ef38" class="oa mp iq nv b gy of oc l od oe">cd ..</span></pre><p id="6da0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">创建自定义插件</strong></p><blockquote class="nm nn no"><p id="32a7" class="kf kg lc kh b ki kj jr kk kl km ju kn np kp kq kr nq kt ku kv nr kx ky kz la ij bi translated"><em class="iq">有关如何创建MSK连接插件的分步说明，请参考官方文档中的</em> <a class="ae lb" href="https://docs.aws.amazon.com/msk/latest/developerguide/msk-connect-plugins.html" rel="noopener ugc nofollow" target="_blank"> <em class="iq">使用AWS管理控制台</em> </a> <em class="iq">创建自定义插件。</em></p></blockquote><p id="7208" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建定制插件时，确保选择你在上一步上传到<code class="fe ns nt nu nv b">Amazon S3</code>的Datagen连接器zip文件。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi nl"><img src="../Images/33f202f96041a0f7ba71715e44f4cc45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*j52r-WG3xyzmAPlY.png"/></div></div></figure><p id="97fc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">创建数据生成源连接器</strong></p><blockquote class="nm nn no"><p id="5bb8" class="kf kg lc kh b ki kj jr kk kl km ju kn np kp kq kr nq kt ku kv nr kx ky kz la ij bi translated"><em class="iq">关于如何创建MSK连接连接器的逐步说明，请参考官方文档中的</em> <a class="ae lb" href="https://docs.aws.amazon.com/msk/latest/developerguide/msk-connect-connectors.html#mkc-create-connector-intro" rel="noopener ugc nofollow" target="_blank"> <em class="iq">创建连接器</em> </a> <em class="iq">。</em></p></blockquote><p id="c667" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要创建连接器:</p><ol class=""><li id="3d62" class="lt lu iq kh b ki kj kl km ko lv ks lw kw lx la or lz ma mb bi translated">选择您刚刚创建的插件。</li><li id="210f" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la or lz ma mb bi translated">输入连接器名称，并选择MSK集群和IAM身份验证</li><li id="8e6c" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la or lz ma mb bi translated">您可以在连接器配置部分输入下面提供的内容</li></ol><pre class="le lf lg lh gt nw nv nx ny aw nz bi"><span id="ec88" class="oa mp iq nv b gy ob oc l od oe">connector.class=io.confluent.kafka.connect.datagen.DatagenConnector<br/>kafka.topic=orders<br/>quickstart=orders<br/>key.converter=org.apache.kafka.connect.storage.StringConverter<br/>value.converter=org.apache.kafka.connect.json.JsonConverter<br/>value.converter.schemas.enable=false<br/>max.interval=10000<br/>iterations=-1<br/>tasks.max=1</span></pre><blockquote class="nm nn no"><p id="1c07" class="kf kg lc kh b ki kj jr kk kl km ju kn np kp kq kr nq kt ku kv nr kx ky kz la ij bi translated"><em class="iq">保持其余配置不变</em></p></blockquote><ol class=""><li id="0b1a" class="lt lu iq kh b ki kj kl km ko lv ks lw kw lx la or lz ma mb bi translated">在<strong class="kh ir">访问权限</strong>下，为连接器选择正确的IAM角色(名称中带有<code class="fe ns nt nu nv b">DatagenConnectorIAMRole</code>的角色)</li><li id="82e6" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la or lz ma mb bi translated">点击下一步的<strong class="kh ir">进入<strong class="kh ir">安全</strong>选项——保持不变</strong></li><li id="18e9" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la or lz ma mb bi translated">点击<strong class="kh ir">下一个</strong>。对于<strong class="kh ir">日志交付</strong>，选择<strong class="kh ir">交付到亚马逊CloudWatch日志</strong>。找到并选择<code class="fe ns nt nu nv b">/msk-connect-demo-cwlog-group</code></li><li id="5e34" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la or lz ma mb bi translated">点击<strong class="kh ir">下一步</strong> —在最后一页，向下滚动并点击<strong class="kh ir">创建连接器</strong>以启动流程并等待连接器启动。</li></ol><p id="4c22" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">完成后，连接器转换到<strong class="kh ir">运行</strong>状态，继续以下步骤。</p><h2 id="3f63" class="oa mp iq bd mq og oh dn mu oi oj dp my ko ok ol na ks om on nc kw oo op ne oq bi translated">测试管道</h2><p id="4780" class="pw-post-body-paragraph kf kg iq kh b ki ng jr kk kl nh ju kn ko ni kq kr ks nj ku kv kw nk ky kz la ij bi translated">在您继续下一步之前:</p><ul class=""><li id="9013" class="lt lu iq kh b ki kj kl km ko lv ks lw kw lx la ly lz ma mb bi translated">下载AWS IAM JAR文件，并将其包含在类路径中</li><li id="0e9b" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la ly lz ma mb bi translated">为Kafka CLI使用者创建属性文件</li></ul><p id="c529" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在EC2实例中，运行以下命令:</p><pre class="le lf lg lh gt nw nv nx ny aw nz bi"><span id="242a" class="oa mp iq nv b gy ob oc l od oe">sudo -u ec2-user -i</span><span id="a477" class="oa mp iq nv b gy of oc l od oe">mkdir iam-auth &amp;&amp; cd ./iam-auth<br/>wget https://github.com/aws/aws-msk-iam-auth/releases/download/1.1.0/aws-msk-iam-auth-1.1.0-all.jar<br/>cd ../</span><span id="bde8" class="oa mp iq nv b gy of oc l od oe">cat &lt;&lt;EOF &gt; /home/ec2-user/kafka/config/client-config.properties<br/># Sets up TLS for encryption and SASL for authN.<br/>security.protocol = SASL_SSL</span><span id="f25d" class="oa mp iq nv b gy of oc l od oe"># Identifies the SASL mechanism to use.<br/>sasl.mechanism = AWS_MSK_IAM</span><span id="27ed" class="oa mp iq nv b gy of oc l od oe"># Binds SASL client implementation.<br/>sasl.jaas.config = software.amazon.msk.auth.iam.IAMLoginModule required;</span><span id="2f0b" class="oa mp iq nv b gy of oc l od oe"># Encapsulates constructing a SigV4 signature based on extracted credentials.<br/># The SASL client bound by "sasl.jaas.config" invokes this class.<br/>sasl.client.callback.handler.class = software.amazon.msk.auth.iam.IAMClientCallbackHandler<br/>EOF</span><span id="6b5c" class="oa mp iq nv b gy of oc l od oe">export CLASSPATH=/home/ec2-user/iam-auth/aws-msk-iam-auth-1.1.0-all.jar<br/>echo "export CLASSPATH=${CLASSPATH}" | tee -a ~/.bash_profile</span></pre><p id="faa8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，列出卡夫卡的主题:</p><pre class="le lf lg lh gt nw nv nx ny aw nz bi"><span id="6cdc" class="oa mp iq nv b gy ob oc l od oe">export MSK_BOOTSTRAP_ADDRESS=&lt;ENTER MSK CLUSTER ENDPOINT&gt;</span><span id="461d" class="oa mp iq nv b gy of oc l od oe">/home/ec2-user/kafka/bin/kafka-topics.sh --bootstrap-server $MSK_BOOTSTRAP_ADDRESS --command-config /home/ec2-user/kafka/config/client-config.properties --list</span></pre><p id="efd7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">启动Kafka CLI消费者:</p><pre class="le lf lg lh gt nw nv nx ny aw nz bi"><span id="b62c" class="oa mp iq nv b gy ob oc l od oe">/home/ec2-user/kafka/bin/kafka-console-consumer.sh --bootstrap-server $MSK_BOOTSTRAP_ADDRESS --consumer.config /home/ec2-user/kafka/config/client-config.properties --from-beginning --topic orders | jq --color-output .</span></pre><p id="5262" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果一切设置正确，您应该会看到类似如下的JSON输出:</p><pre class="le lf lg lh gt nw nv nx ny aw nz bi"><span id="08e7" class="oa mp iq nv b gy ob oc l od oe">...<br/>{<br/>  "ordertime": 1488059390707,<br/>  "orderid": 50,<br/>  "itemid": "Item_845",<br/>  "orderunits": 4.801443003705596,<br/>  "address": {<br/>    "city": "City_",<br/>    "state": "State_6",<br/>    "zipcode": 34225<br/>  }<br/>}<br/>{<br/>  "ordertime": 1496655341559,<br/>  "orderid": 51,<br/>  "itemid": "Item_71",<br/>  "orderunits": 6.184874231875158,<br/>  "address": {<br/>    "city": "City_63",<br/>    "state": "State_91",<br/>    "zipcode": 77633<br/>  }<br/>}<br/>...</span></pre></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h1 id="0247" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">数据管道:第2部分</h1><p id="f6bb" class="pw-post-body-paragraph kf kg iq kh b ki ng jr kk kl nh ju kn ko ni kq kr ks nj ku kv kw nk ky kz la ij bi translated">只要Datagen source连接器在运行，它就会继续生成样本订单数据。根据我们的配置(<code class="fe ns nt nu nv b">max.interval=10000</code>和<code class="fe ns nt nu nv b">iterations=-1</code>)，它将每10秒产生一条记录。</p><p id="762c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我们将实现管道的另一半，它负责在DynamoDB接收器连接器的帮助下，将数据从MSK主题传送到DynamoDB表。</p><p id="9b81" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本节中，您将:</p><ul class=""><li id="c2ed" class="lt lu iq kh b ki kj kl km ko lv ks lw kw lx la ly lz ma mb bi translated">下载DynamoDB连接器构件</li><li id="3b27" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la ly lz ma mb bi translated">在MSK创建自定义插件</li><li id="ba9a" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la ly lz ma mb bi translated">将DynamoDB接收器连接器部署到MSK连接</li></ul><h2 id="4921" class="oa mp iq bd mq og oh dn mu oi oj dp my ko ok ol na ks om on nc kw oo op ne oq bi translated">创建自定义插件和连接器</h2><p id="cd3e" class="pw-post-body-paragraph kf kg iq kh b ki ng jr kk kl nh ju kn ko ni kq kr ks nj ku kv kw nk ky kz la ij bi translated"><strong class="kh ir">将DynamoDB连接器上传到</strong>T3</p><p id="4752" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">登录Kafka客户端EC2实例:</p><pre class="le lf lg lh gt nw nv nx ny aw nz bi"><span id="8217" class="oa mp iq nv b gy ob oc l od oe">sudo -u ec2-user -i</span><span id="920b" class="oa mp iq nv b gy of oc l od oe">mkdir kafka-connect-dynamodb &amp;&amp; cd kafka-connect-dynamodb</span><span id="e156" class="oa mp iq nv b gy of oc l od oe">wget https://d1i4a15mxbxib1.cloudfront.net/api/plugins/confluentinc/kafka-connect-aws-dynamodb/versions/1.3.0/confluentinc-kafka-connect-aws-dynamodb-1.3.0.zip</span><span id="5bfa" class="oa mp iq nv b gy of oc l od oe">aws s3 cp ./confluentinc-kafka-connect-aws-dynamodb-1.3.0.zip s3://msk-lab-&lt;ENTER_YOUR_AWS_ACCOUNT_ID&gt;-plugins-bucket/</span><span id="332d" class="oa mp iq nv b gy of oc l od oe">cd ..</span></pre><p id="f292" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">创建自定义插件</strong></p><blockquote class="nm nn no"><p id="35c0" class="kf kg lc kh b ki kj jr kk kl km ju kn np kp kq kr nq kt ku kv nr kx ky kz la ij bi translated"><em class="iq">关于如何创建MSK连接插件的分步说明，请参考官方文档中的</em> <a class="ae lb" href="https://docs.aws.amazon.com/msk/latest/developerguide/msk-connect-plugins.html" rel="noopener ugc nofollow" target="_blank"> <em class="iq">使用AWS管理控制台</em> </a> <em class="iq">创建自定义插件。</em></p></blockquote><p id="1065" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建自定义插件时，确保选择您在上一步上传到<code class="fe ns nt nu nv b">Amazon S3</code>的DynamoDB连接器zip文件。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi nl"><img src="../Images/becd3ba390b31f5bb092be189f428997.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7rz-mO0ohrileUmk.png"/></div></div></figure><p id="7d05" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">创建DynamoDB接收器连接器</strong></p><blockquote class="nm nn no"><p id="1df2" class="kf kg lc kh b ki kj jr kk kl km ju kn np kp kq kr nq kt ku kv nr kx ky kz la ij bi translated"><em class="iq">关于如何创建MSK连接器的逐步说明，请参考官方文档中的</em> <a class="ae lb" href="https://docs.aws.amazon.com/msk/latest/developerguide/msk-connect-connectors.html#mkc-create-connector-intro" rel="noopener ugc nofollow" target="_blank"> <em class="iq">创建连接器</em> </a> <em class="iq">。</em></p></blockquote><p id="500c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要创建连接器:</p><ol class=""><li id="5b7d" class="lt lu iq kh b ki kj kl km ko lv ks lw kw lx la or lz ma mb bi translated">选择您刚刚创建的插件。</li><li id="3edf" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la or lz ma mb bi translated">输入连接器名称，并选择MSK集群和IAM身份验证</li><li id="f503" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la or lz ma mb bi translated">您可以在连接器配置部分输入下面提供的内容。确保根据您的设置替换以下配置:</li></ol><ul class=""><li id="712a" class="lt lu iq kh b ki kj kl km ko lv ks lw kw lx la ly lz ma mb bi translated">使用正确的主题名(在我们的例子中是<code class="fe ns nt nu nv b">orders</code>)</li><li id="6cd1" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la ly lz ma mb bi translated">在<code class="fe ns nt nu nv b">confluent.topic.bootstrap.servers</code>中输入MSK代理端点</li><li id="0a0f" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la ly lz ma mb bi translated">对于<code class="fe ns nt nu nv b">aws.dynamodb.endpoint</code>和<code class="fe ns nt nu nv b">aws.dynamodb.region</code>，输入您创建DynamoDB表的地区，例如<code class="fe ns nt nu nv b">us-east-1</code></li></ul><blockquote class="nm nn no"><p id="a299" class="kf kg lc kh b ki kj jr kk kl km ju kn np kp kq kr nq kt ku kv nr kx ky kz la ij bi translated"><em class="iq">保持其余配置不变</em></p></blockquote><pre class="le lf lg lh gt nw nv nx ny aw nz bi"><span id="48b6" class="oa mp iq nv b gy ob oc l od oe">connector.class=io.confluent.connect.aws.dynamodb.DynamoDbSinkConnector<br/>tasks.max=1<br/>topics=orders<br/>aws.dynamodb.region=&lt;ENTER AWS REGION e.g. us-east-1&gt;<br/>aws.dynamodb.endpoint=https://dynamodb.&lt;ENTER AWS REGION&gt;.amazonaws.com<br/>aws.dynamodb.pk.hash=value.orderid<br/>aws.dynamodb.pk.sort=<br/>table.name.format=kafka_${topic}<br/>transforms=flatten<br/>transforms.flatten.type=org.apache.kafka.connect.transforms.Flatten$Value<br/>transforms.flatten.delimiter=_<br/>key.converter.schemas.enable=false<br/>value.converter.schemas.enable=false<br/>key.converter=org.apache.kafka.connect.storage.StringConverter<br/>value.converter=org.apache.kafka.connect.json.JsonConverter<br/>confluent.topic.bootstrap.servers=&lt;ENTER MSK CLUSTER ENDPOINT&gt;<br/>confluent.topic.security.protocol=SASL_SSL<br/>confluent.topic.sasl.mechanism=AWS_MSK_IAM<br/>confluent.topic.sasl.jaas.config=software.amazon.msk.auth.iam.IAMLoginModule required;<br/>confluent.topic.sasl.client.callback.handler.class=software.amazon.msk.auth.iam.IAMClientCallbackHandler</span></pre><ol class=""><li id="e3d3" class="lt lu iq kh b ki kj kl km ko lv ks lw kw lx la or lz ma mb bi translated">在<strong class="kh ir">访问权限</strong>下，为连接器选择正确的IAM角色(名称中带有<code class="fe ns nt nu nv b">DynamoDBConnectorIAMRole</code>的角色)</li><li id="1b8b" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la or lz ma mb bi translated">点击<strong class="kh ir">下一步</strong>进入<strong class="kh ir">安全</strong>选项——保持不变</li><li id="ebd2" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la or lz ma mb bi translated">点击<strong class="kh ir">下一个</strong>。对于<strong class="kh ir">日志交付</strong>，选择<strong class="kh ir">交付至亚马逊云观察日志</strong>。找到并选择<code class="fe ns nt nu nv b">/msk-connect-demo-cwlog-group</code></li><li id="fb68" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la or lz ma mb bi translated">点击下一个的<strong class="kh ir">—在最后一页，向下滚动并点击<strong class="kh ir">创建连接器</strong>以启动流程并等待连接器启动。</strong></li></ol><p id="7b40" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">完成后，连接器转换到<strong class="kh ir">运行</strong>状态，继续以下步骤。</p><p id="5b06" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们继续测试管道之前，您应该知道一些事情:</p><p id="abb4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">选择DynamoDB主键</strong></p><p id="5bda" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在上面的配置中，我们将<code class="fe ns nt nu nv b">aws.dynamodb.pk.hash</code>设置为<code class="fe ns nt nu nv b">value.orderid</code>，这意味着Kafka主题事件有效负载中的<code class="fe ns nt nu nv b">orderid</code>字段将被用作分区键(将<code class="fe ns nt nu nv b">aws.dynamodb.pk.sort</code>留空，但如果需要，可以用来指定<a class="ae lb" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/HowItWorks.CoreComponents.html#HowItWorks.CoreComponents.PrimaryKey" rel="noopener ugc nofollow" target="_blank"> DynamoDB排序/范围键</a>)。</p><p id="a2ae" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">使用Kafka Connect SMT展平记录</strong></p><p id="b46d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">事件有效负载中的<code class="fe ns nt nu nv b">address</code>字段具有嵌套结构。</p><pre class="le lf lg lh gt nw nv nx ny aw nz bi"><span id="3e2a" class="oa mp iq nv b gy ob oc l od oe">"address": {<br/>    "city": "City_63",<br/>    "state": "State_91",<br/>    "zipcode": 77633<br/>  }</span></pre><p id="1931" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了取消嵌套或展平(因为没有更好的词)它，我们使用了<a class="ae lb" href="https://docs.confluent.io/platform/current/connect/transforms/flatten.html#flatten" rel="noopener ugc nofollow" target="_blank">展平</a>变换(<code class="fe ns nt nu nv b">org.apache.kafka.connect.transforms.Flatten$Value</code>)。这将从<code class="fe ns nt nu nv b">address</code>中提取单个字段，并使它们作为单个属性- <code class="fe ns nt nu nv b">address_city</code>、<code class="fe ns nt nu nv b">address_state</code>、<code class="fe ns nt nu nv b">address_zipcode</code>可用。很快您将在DynamoDB表中看到相同的内容！</p><h2 id="38c0" class="oa mp iq bd mq og oh dn mu oi oj dp my ko ok ol na ks om on nc kw oo op ne oq bi translated">测试端到端管道</h2><p id="9d3f" class="pw-post-body-paragraph kf kg iq kh b ki ng jr kk kl nh ju kn ko ni kq kr ks nj ku kv kw nk ky kz la ij bi translated">导航到DynamoDB控制台。您将看到<code class="fe ns nt nu nv b">kafka_orders</code>表已经存在——这是由DynamoDB sink连接器自动创建的。</p><blockquote class="nm nn no"><p id="29e3" class="kf kg lc kh b ki kj jr kk kl km ju kn np kp kq kr nq kt ku kv nr kx ky kz la ij bi translated"><em class="iq">该表有</em> <code class="fe ns nt nu nv b"><em class="iq">orderid</em></code> <em class="iq">作为分区键</em></p></blockquote><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi nl"><img src="../Images/2807ef61b0760202718d9bc788e381b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6AbQk-mPPGEMmgiu.png"/></div></div></figure><p id="73d1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果手头有AWS CLI，您可以使用<code class="fe ns nt nu nv b">aws dynamodb scan --table-name kafka_orders</code>快速查看数据。</p><p id="353b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您将得到类似的输出(注意<code class="fe ns nt nu nv b">address_*</code>字段):</p><pre class="le lf lg lh gt nw nv nx ny aw nz bi"><span id="992d" class="oa mp iq nv b gy ob oc l od oe">{<br/>    "Items": [<br/>        {<br/>            "orderid": {<br/>                "N": "251"<br/>            },<br/>            "address_zipcode": {<br/>                "N": "68100"<br/>            },<br/>            "address_state": {<br/>                "S": "State_2"<br/>            },<br/>            "itemid": {<br/>                "S": "Item_46"<br/>            },<br/>            "ordertime": {<br/>                "N": "1491423463934"<br/>            },<br/>            "address_city": {<br/>                "S": "City_6"<br/>            },<br/>            "orderunits": {<br/>                "N": "3.1272028351151926"<br/>            }<br/>        },<br/>.....</span></pre><p id="8e3a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">继续，按照您喜欢的方式查询和处理DynamoDB表中的数据。那是你的作业！</p><p id="781b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">随着连接器变得神奇，它将继续将Kafka主题中的记录同步到DynamoDB表中。请记住，只要连接器在运行，数据管道(来自<code class="fe ns nt nu nv b">Datagen source -&gt; MSK topic -&gt; DynamoDB</code>)就将继续运行——记录将不断被添加到MSK的<code class="fe ns nt nu nv b">orders</code>主题中，并将被保存到DynamoDB表中。</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h1 id="0207" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">删除资源</h1><p id="3ac6" class="pw-post-body-paragraph kf kg iq kh b ki ng jr kk kl nh ju kn ko ni kq kr ks nj ku kv kw nk ky kz la ij bi translated">除非您打算阅读本博客系列的第二部分(即将发布)，否则请删除参考资料。</p><ul class=""><li id="046a" class="lt lu iq kh b ki kj kl km ko lv ks lw kw lx la ly lz ma mb bi translated">删除<code class="fe ns nt nu nv b">Amazon S3</code>桶的内容(<code class="fe ns nt nu nv b">msk-lab-&lt;YOUR ACCOUNT_ID&gt;-plugins-bucket</code>)</li><li id="e906" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la ly lz ma mb bi translated">删除云形成堆栈</li><li id="d99e" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la ly lz ma mb bi translated">删除DynamoDB表</li><li id="92ae" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la ly lz ma mb bi translated">删除MSK连接连接器、插件和自定义配置</li></ul><h1 id="e41a" class="mo mp iq bd mq mr os mt mu mv ot mx my jw ou jx na jz ov ka nc kc ow kd ne nf bi translated">结论</h1><p id="d3c9" class="pw-post-body-paragraph kf kg iq kh b ki ng jr kk kl nh ju kn ko ni kq kr ks nj ku kv kw nk ky kz la ij bi translated">像MSK互联这样的托管环境负责处理繁重的工作，让您专注于构建数据架构。这篇博客的重点是让您使用一个简单的数据管道，以DynamoDB作为接收器。下一部分将包括变更数据捕获，并向您介绍如何使用本文中介绍的组件构建解决方案。</p></div></div>    
</body>
</html>