<html>
<head>
<title>Creating Infrastructure for Training Machine Learning Models</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为训练机器学习模型创建基础设施</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/creating-infrastructure-for-training-machine-learning-models-aec52cf37929#2022-06-08">https://towardsdatascience.com/creating-infrastructure-for-training-machine-learning-models-aec52cf37929#2022-06-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1792" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">引入用于训练、跟踪和比较机器学习实验的自动管道</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/2838be18f6eb7a0e524b2a58467b90d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*snKc3ZJjof1O42K1"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@firmbee?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Firmbee.com</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><p id="54e8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们想象一下下面的场景:你有一个新项目要做。对于这个项目，你需要开发一个机器学习模型，这将需要运行和训练几个实验。每个实验可能需要几个小时甚至几天，并且需要跟踪。</p><p id="eb4d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在开发阶段，你有自己的笔记本电脑，但是用自己的笔记本电脑进行培训和运行所有的实验是不现实的。首先，您的计算机可能没有所需的硬件，例如GPU。第二，浪费时间。如果你可以<strong class="ky ir">并行运行和训练所有的实验</strong>，为什么要在一台计算机上顺序训练？</p><p id="2dfc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你平行训练，每次实验在不同的机器上进行，你如何容易地<strong class="ky ir">跟踪和比较</strong>他们？你如何<strong class="ky ir">访问训练数据</strong>？你能实时意识到任何故障以便你能够修复并再次运行它吗？</p><p id="c113" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所有这些问题都将得到解答。在这篇博文中，我想描述一个解决上述所有问题的可能方案。</p><p id="577d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该解决方案结合了不同的服务，并将它们联合起来，以创建一个用于训练机器学习模型的完整管道解决方案。</p><p id="d101" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在下图中，您可以找到该管道的方案。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ls"><img src="../Images/a2df8d36d84765693fce5ce3e51e0523.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cZZwm4u2umy3EGr_s7spXw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="e558" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">流水线由三个步骤组成——将代码容器化，以便我们以后能够运行它，在几台独立的机器上执行代码，以及跟踪所有的实验。</p><h1 id="1eee" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">(1)集装箱化</h1><p id="3540" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">大规模运行训练实验的最佳方式是构建一个<a class="ae kv" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> docker </strong> </a>映像。创建这种图像的一种方法是使用<a class="ae kv" href="https://www.jenkins.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir">詹金斯</strong> </a>。开源自动化服务器，支持构建、测试和部署软件。另一种方法是使用<a class="ae kv" href="https://github.com/features/actions" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> GitHub动作</strong> </a> <strong class="ky ir">。</strong>持续集成和持续交付(CI/CD)平台，允许您自动化您的构建、测试和部署管道。这可以直接从你的GitHub账户上完成。</p><p id="e64a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我描述一个可能的场景——每个对我们的<strong class="ky ir"> git </strong>分支的推送都会触发一个Jenkins管道。这个管道构建docker映像(除了它能做的其他事情之外)，标记它，并将其存储在docker注册表中。</p><p id="92ed" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦我们有了这个图像，我们就可以执行它，并使用虚拟云机器大规模地训练我们的模型。</p><h1 id="d7da" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">(二)执行</h1><p id="2705" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">我们已经准备好代码，我们想开始训练。假设我们有10个实验要运行，我们希望并行运行它们。一种选择是使用10个<strong class="ky ir">虚拟机</strong>，使用ssh连接每个虚拟机，并在每个虚拟机上手动执行我们的代码。我想你明白这不是最优的。</p><p id="ff3f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由于我们已经在上一步中容器化了我们的应用程序，我们可以利用最流行的容器编排平台来运行我们的培训— <a class="ae kv" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> Kubernetes </strong> </a>。Kubernetes是一个开源系统，用于自动化容器化应用程序的部署、扩展和管理。这意味着，通过使用它，我们可以获得docker映像并大规模部署它。我们可以使用一个简单的bash脚本在10台独立的机器上运行10个实验。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="0548" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你可以在这里阅读更多相关信息<a class="ae kv" href="https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="3073" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">(3)跟踪</h1><h2 id="365d" class="ms lu iq bd lv mt mu dn lz mv mw dp md lf mx my mf lj mz na mh ln nb nc mj nd bi translated">训练数据采集</h2><p id="26a3" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">为了执行培训，我们首先需要访问我们的培训数据。最好的方法是从训练机器直接访问<strong class="ky ir">存储器</strong>中所需的训练文件(<a class="ae kv" href="https://aws.amazon.com/s3/" rel="noopener ugc nofollow" target="_blank"> S3 </a>、<a class="ae kv" href="https://cloud.google.com/storage" rel="noopener ugc nofollow" target="_blank"> GCS </a>等)以及<strong class="ky ir">数据库</strong>中所需的表格信息。为了确定这一点，我们可能需要帮助来访问相关的凭证和<a class="ae kv" href="https://cloud.google.com/secret-manager#:~:text=Secret%20Manager%20is%20a%20secure,audit%20secrets%20across%20Google%20Cloud." rel="noopener ugc nofollow" target="_blank">秘密管理器</a>(一个用于API密钥、密码、证书和其他敏感数据的安全而方便的存储系统)。一旦配置完成，我们就可以开始了。</p><h2 id="c3ee" class="ms lu iq bd lv mt mu dn lz mv mw dp md lf mx my mf lj mz na mh ln nb nc mj nd bi translated">NFS磁盘—共享磁盘</h2><p id="7248" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">用于培训的所有机器都连接到一个NFS磁盘(在我们的例子中，我们使用GCP的托管解决方案，称为<a class="ae kv" href="https://cloud.google.com/filestore" rel="noopener ugc nofollow" target="_blank">文件存储</a>)，这是一个额外的共享磁盘，所有机器都可以对其进行读写访问。我们添加这个共享磁盘有三个主要原因—</p><ol class=""><li id="4628" class="ne nf iq ky b kz la lc ld lf ng lj nh ln ni lr nj nk nl nm bi translated">当在不同的机器上训练时，我们不想为每台机器反复下载我们的训练数据。相反，我们可以将所有机器连接到一个共享文件存储，这是一个所有机器都可以访问的附加磁盘。这样我们可以<strong class="ky ir">只下载一次数据</strong>。</li><li id="6363" class="ne nf iq ky b kz nn lc no lf np lj nq ln nr lr nj nk nl nm bi translated">培训模型可能需要时间，因此成本可能很高。让训练更便宜的一个选择是使用<a class="ae kv" href="https://cloud.google.com/spot-vms" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir">现货实例</strong> </a>，价格低得多。但是，如果需要回收计算容量以分配给其他虚拟机，您的云提供商可能会停止(抢占)这些实例。使用Kubernetes，一旦实例停止，它会被自动替换并再次执行相同的实验。在这种情况下，我们希望从停止加载最后一个保存的检查点的地方继续训练。只有使用共享磁盘才能做到这一点，没有共享磁盘，我们将无法访问先前机器中保存的检查点。其他解决方案，如将所有检查点上传到云存储并在其上应用逻辑，也是可行的，但开销(和成本)很高。</li><li id="e69d" class="ne nf iq ky b kz nn lc no lf np lj nq ln nr lr nj nk nl nm bi translated"><a class="ae kv" href="https://www.tensorflow.org/tensorboard#:~:text=TensorBoard%20provides%20the%20visualization%20and,as%20they%20change%20over%20time" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> TensorBoard </strong> </a> —使用TensorBoard比较不同机器的不同实验，所有信息必须写入同一父目录。我们将把所有信息写入同一个父日志目录，TensorBoard UI将从中读取。</li></ol><h2 id="e849" class="ms lu iq bd lv mt mu dn lz mv mw dp md lf mx my mf lj mz na mh ln nb nc mj nd bi translated">实验跟踪</h2><p id="86a9" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">训练模型中最重要的一点是能够跟踪训练进度并比较不同的实验。对于每个实验，我们希望保存我们使用的参数、我们训练的数据、损失值、结果等等。我们将使用这些数据进行跟踪、追踪和比较。</p><p id="0e52" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有许多跟踪工具。当我想要高级可视化时，我使用<a class="ae kv" href="https://mlflow.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> MLflow </strong> </a>和<strong class="ky ir"> TensorBoard </strong>。它们都是以这样一种方式部署的，即所有团队都可以访问同一个实例，并看到团队的所有实验。</p><p id="51fd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">MLflow是一个管理端到端机器学习生命周期的开源平台。它提供了一个简单的API来集成，并提供了一个很好的UI来跟踪和比较结果。</p><p id="b95f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">TensorBoard提供了机器学习实验所需的可视化和工具。它提供了一个API，将我们的信息记录到机器磁盘上的文件中。TensorBoard UI从传递的输入目录中读取这些文件。</p><h2 id="9681" class="ms lu iq bd lv mt mu dn lz mv mw dp md lf mx my mf lj mz na mh ln nb nc mj nd bi translated">错误警报</h2><p id="4053" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">由于培训可能需要时间、几个小时甚至几天，因此如果出现错误，我们希望得到实时通知。一种方法是将我们的代码与<a class="ae kv" href="https://sentry.io/welcome/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> Sentry </strong> </a>集成，将Sentry与<strong class="ky ir"> Slack </strong>集成。这样，代码中出现的每个错误都将作为事件发送给Sentry，并触发Slack通知。</p><p id="1e6b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我可以实时收到错误通知。这不仅减少了我监视运行的需要(不管它们是崩溃了还是还在运行)，而且还减少了错误发生和触发下一次运行之间的时间，代码是固定的。</p><h1 id="1709" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">摘要</h1><p id="f949" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">当我第一次训练模型时，是在我的笔记本电脑上完成的。很快，它就不可伸缩了，所以我使用ssh转移到虚拟机上。这种选择也有缺陷。对于每台机器，我不得不登录、提取代码、下载数据、手动运行代码，并希望我没有混淆我传递的参数。数据部分是最容易解决的，我们为我的所有虚拟机添加了一个共享磁盘。但我仍然对参数感到困惑，并在几台机器上传递了相同的参数。<strong class="ky ir">正如我在这篇文章中所描述的，是时候使用可扩展的、更加自动化的基础设施了。</strong>与DevOps团队一起，我们定义并构建了我们今天拥有的强大渠道。现在，我有了一个可伸缩、易于执行的管道，甚至在每次出现错误时都发送一个Slack通知。这种流水线不仅由于实验的并行性而节省了时间，而且最大限度地减少了参数错误和由于错误而导致的空闲时间，除非主动检查每台机器，否则我们不会知道这些错误。</p><div class="ns nt gp gr nu nv"><a href="https://www.docker.com/" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd ir gy z fp oa fr fs ob fu fw ip bi translated">家庭码头工人</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">新内容参加5月9日至10日举行的DockerCon 2022是一次免费的沉浸式在线体验，包括产品…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">www.docker.com</p></div></div><div class="oe l"><div class="of l og oh oi oe oj kp nv"/></div></div></a></div><div class="ns nt gp gr nu nv"><a href="https://www.jenkins.io/" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd ir gy z fp oa fr fs ob fu fw ip bi translated">詹金斯</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">领先的开源自动化服务器，Jenkins提供了数百个插件…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">www.jenkins.io</p></div></div><div class="oe l"><div class="ok l og oh oi oe oj kp nv"/></div></div></a></div><div class="ns nt gp gr nu nv"><a href="https://kubernetes.io/" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd ir gy z fp oa fr fs ob fu fw ip bi translated">生产级容器编排</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">Kubernetes，也称为K8s，是一个开源系统，用于自动部署、扩展和管理…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">kubernetes.io</p></div></div><div class="oe l"><div class="ol l og oh oi oe oj kp nv"/></div></div></a></div><div class="ns nt gp gr nu nv"><a href="https://mlflow.org/" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd ir gy z fp oa fr fs ob fu fw ip bi translated">MLflow -机器学习生命周期的平台</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">机器学习生命周期的开源平台MLflow是一个管理机器学习生命周期的开源平台</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">mlflow.org</p></div></div><div class="oe l"><div class="om l og oh oi oe oj kp nv"/></div></div></a></div><div class="ns nt gp gr nu nv"><a href="https://www.tensorflow.org/tensorboard" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd ir gy z fp oa fr fs ob fu fw ip bi translated">张量板|张量流</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">TensorBoard提供机器学习实验所需的可视化和工具:跟踪和…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">www.tensorflow.org</p></div></div><div class="oe l"><div class="on l og oh oi oe oj kp nv"/></div></div></a></div><div class="ns nt gp gr nu nv"><a href="https://cloud.google.com/" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd ir gy z fp oa fr fs ob fu fw ip bi translated">云计算服务|谷歌云</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">利用谷歌的云计算服务，包括数据管理、混合…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">cloud.google.com</p></div></div><div class="oe l"><div class="oo l og oh oi oe oj kp nv"/></div></div></a></div><div class="ns nt gp gr nu nv"><a href="https://sentry.io/welcome/" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd ir gy z fp oa fr fs ob fu fw ip bi translated">应用程序监控和错误跟踪软件</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">从错误跟踪到性能监控，开发人员可以看到真正重要的事情，更快地解决问题，并了解…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">哨兵. io</p></div></div><div class="oe l"><div class="op l og oh oi oe oj kp nv"/></div></div></a></div><div class="ns nt gp gr nu nv"><a href="https://docs.github.com/en/actions" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd ir gy z fp oa fr fs ob fu fw ip bi translated">GitHub操作文档- GitHub文档</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">使用GitHub Actions在您的存储库中自动化、定制和执行您的软件开发工作流。你…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">docs.github.com</p></div></div><div class="oe l"><div class="oq l og oh oi oe oj kp nv"/></div></div></a></div></div></div>    
</body>
</html>