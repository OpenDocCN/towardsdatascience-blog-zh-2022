<html>
<head>
<title>How to Add an Escape Hatch to Your Python Run in Two Steps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何分两步在Python运行中添加转义</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-add-an-escape-hatch-to-your-python-run-in-two-steps-7d6818f58f14#2022-05-07">https://towardsdatascience.com/how-to-add-an-escape-hatch-to-your-python-run-in-two-steps-7d6818f58f14#2022-05-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="9016" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">Python技巧和窍门</h2><div class=""/><div class=""><h2 id="a9a2" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">使用装饰函数为Python应用程序创建一个简单的出口</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/5de5e338d1521db06bbb5087f17ad2aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jPVS1itJiQmBjph5cJHJMw.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">作者创建的图片|使用了来自<a class="ae lh" href="http://canva.com/" rel="noopener ugc nofollow" target="_blank">canva.com</a>的免费内容许可元素</p></figure><p id="6cb7" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">你有一个运行在无限循环上的Python脚本/应用程序/函数，或者你有一些功能需要你在运行时间过长时安全退出程序。怎样才能安全退出程序？也许ctrl+C，但这并不总是最安全的方式，非技术人员可能不知道这一点。也许你已经有了一个启动ML建模的函数，这个函数可能需要太长时间。</p><p id="d955" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在这里，我将为您提供一个装饰框架，您可以在任何函数上使用它来添加安全停止程序的能力，如果您按下指定的键。在我们的例子中是“退出”键。</p><p id="3f34" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">那么这里的标准是什么呢？</p><ul class=""><li id="7a1d" class="me mf it lk b ll lm lo lp lr mg lv mh lz mi md mj mk ml mm bi translated">创建一个可以包装任何函数的装饰器，这样如果函数运行时间过长，我们可以用escape键安全地停止它</li></ul><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/f287087f57a28529505d8cd5fd386c68.png" data-original-src="https://miro.medium.com/v2/resize:fit:992/format:webp/1*QoFtYcoL7jglbV6Gtvb14g.png"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">图片由作者创建|使用来自canva.com<a class="ae lh" href="http://canva.com/" rel="noopener ugc nofollow" target="_blank">的免费内容许可元素</a></p></figure><h1 id="92a7" class="mo mp it bd mq mr ms mt mu mv mw mx my ki mz kj na kl nb km nc ko nd kp ne nf bi translated">Github存储库</h1><p id="d311" class="pw-post-body-paragraph li lj it lk b ll ng kd ln lo nh kg lq lr ni lt lu lv nj lx ly lz nk mb mc md im bi translated">我已经把这个框架放在了GitHub的仓库里，你可以在这里找到:</p><div class="nl nm gp gr nn no"><a href="https://github.com/Causb1A/escape-hatch/tree/main" rel="noopener  ugc nofollow" target="_blank"><div class="np ab fo"><div class="nq ab nr cl cj ns"><h2 class="bd jd gy z fp nt fr fs nu fu fw jc bi translated">GitHub-caus B1 a/Escape-hatch:Escape hatch python库，以补充TDS文章</h2><div class="nv l"><p class="bd b dl z fp nt fr fs nu fu fw dk translated">github.com</p></div></div><div class="nw l"><div class="nx l ny nz oa nw ob lb no"/></div></div></a></div><p id="36fc" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我可能会提到知识库的各个方面。如果使用存储库，从main.py开始，然后从那里进入调试模式。你可以在my_app/api_utils.py中找到escape hatch</p><h1 id="77c9" class="mo mp it bd mq mr ms mt mu mv mw mx my ki mz kj na kl nb km nc ko nd kp ne nf bi translated">必备知识</h1><p id="0e58" class="pw-post-body-paragraph li lj it lk b ll ng kd ln lo nh kg lq lr ni lt lu lv nj lx ly lz nk mb mc md im bi translated">在深入细节之前，我只想介绍一下我使用装饰函数和装饰工厂来做这件事。如果你不确定这些是如何工作的，请在这里阅读更多信息:</p><div class="nl nm gp gr nn no"><a rel="noopener follow" target="_blank" href="/decorators-in-python-9cf8ba95e8e7"><div class="np ab fo"><div class="nq ab nr cl cj ns"><h2 class="bd jd gy z fp nt fr fs nu fu fw jc bi translated">Python中的装饰者</h2><div class="oc l"><h3 class="bd b gy z fp nt fr fs nu fu fw dk translated">了解如何改变obj的行为</h3></div><div class="nv l"><p class="bd b dl z fp nt fr fs nu fu fw dk translated">towardsdatascience.com</p></div></div><div class="nw l"><div class="od l ny nz oa nw ob lb no"/></div></div></a></div><p id="a1a8" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在一个非常高的层次上，装饰器是一个接受另一个函数并扩展后一个函数的行为的函数。</p><p id="f34c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">把它想象成一个包装器:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oe"><img src="../Images/55951d4aad0dbee59d36b38fcaa21dae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MN652dsFuSvDbyKkm_lA0Q.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">图片由作者创建|使用来自canva.com<a class="ae lh" href="http://canva.com/" rel="noopener ugc nofollow" target="_blank">的免费内容许可元素</a></p></figure><p id="a87c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">你可以用装饰器包装任何函数，它基本上会围绕函数执行一些东西。所以无论何时你调用一个包装了装饰器的函数，它都会执行装饰器，并且函数会在装饰器中执行。这将使我们的例子更有意义。</p><h1 id="f0c9" class="mo mp it bd mq mr ms mt mu mv mw mx my ki mz kj na kl nb km nc ko nd kp ne nf bi translated">步伐</h1><h2 id="93b9" class="of mp it bd mq og oh dn mu oi oj dp my lr ok ol na lv om on nc lz oo op ne iz bi translated">步骤1:定义装饰器</h2><p id="806c" class="pw-post-body-paragraph li lj it lk b ll ng kd ln lo nh kg lq lr ni lt lu lv nj lx ly lz nk mb mc md im bi translated">创建一个新的模块，在资源库中，我把这个模块叫做api_utils.py，我在这里定义了decorator函数，把它叫做escape hatch。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="oq or l"/></div></figure><p id="6ffe" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">上面的函数是我们的装饰器，我们可以用它包装任何函数。如果我启动一个由这个装饰器包装的函数，每当我按下escape键，它就会暂停程序(杀死主线程)。</p><p id="df37" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">有几点需要注意:</p><ul class=""><li id="9c5f" class="me mf it lk b ll lm lo lp lr mg lv mh lz mi md mj mk ml mm bi translated">第34行表示一个上下文管理器，它监听任何键盘动作，如果有一个要发生，它将启动第26行，暂停程序</li><li id="938a" class="me mf it lk b ll os lo ot lr ou lv ov lz ow md mj mk ml mm bi translated">第40行是执行函数的地方</li></ul><h2 id="b32c" class="of mp it bd mq og oh dn mu oi oj dp my lr ok ol na lv om on nc lz oo op ne iz bi translated">步骤2:使用我们的装饰函数</h2><p id="34ba" class="pw-post-body-paragraph li lj it lk b ll ng kd ln lo nh kg lq lr ni lt lu lv nj lx ly lz nk mb mc md im bi translated">现在我们如何使用它？很简单，就像这样:</p><p id="437d" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">注意——如果您在存储库中跟踪，这个文件在my_app/module_1.py中</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="oq or l"/></div></figure><p id="685a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">就像上面一样简单，现在无论何时你想使用escape hatch，只要像上面第5行那样在任何函数之前简单地包装它。之后使用@escape_hatch和函数。开始消息和结束消息是可选的。</p><p id="8dba" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">Function_that_runs_forever()是一个永远运行的函数，用来测试逃生舱。让我们来测试一下:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi ox"><img src="../Images/449abff923ac03dc9e052b268031dcfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:744/format:webp/1*C5VvLPEesEm4188O7XLfUw.png"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">作者创建的图像</p></figure><p id="1c7d" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我特意将一些消息移到右边，这样我们可以清楚地看到哪个部分是装饰包装器。</p><p id="5309" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">发生了什么事？</p><ol class=""><li id="26ea" class="me mf it lk b ll lm lo lp lr mg lv mh lz mi md oy mk ml mm bi translated">逃生舱装饰开始，打印出一些东西，它听我们的键盘，看看我们是否按下退出。</li><li id="b0de" class="me mf it lk b ll os lo ot lr ou lv ov lz ow md oy mk ml mm bi translated">我们的实际函数_that_runs_forever()开始运行。这种打印机正在运行，除非我停止它，否则它会一直运行下去。</li><li id="69d6" class="me mf it lk b ll os lo ot lr ou lv ov lz ow md oy mk ml mm bi translated">然后我按下escape键，装饰器停止这个函数并打印出用户终止的程序。</li></ol><p id="f09f" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">这就对了。功能正常的逃生出口。</p><h2 id="a8e1" class="of mp it bd mq og oh dn mu oi oj dp my lr ok ol na lv om on nc lz oo op ne iz bi translated">额外步骤3:捕捉键盘中断</h2><p id="2ff8" class="pw-post-body-paragraph li lj it lk b ll ng kd ln lo nh kg lq lr ni lt lu lv nj lx ly lz nk mb mc md im bi translated">有时，取决于你的应用程序做什么，使用键盘杀死主线程有时会引发KeyboardInterrupt异常并输出回溯。输出回溯可能不是您想要的。要解决这个问题，您可以添加一个try，除了我在存储库的main.py中所做的:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="oq or l"/></div></figure><p id="dd40" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">注意在第11行我捕捉到了异常。</p><h1 id="ff54" class="mo mp it bd mq mr ms mt mu mv mw mx my ki mz kj na kl nb km nc ko nd kp ne nf bi translated">最后的话</h1><p id="c95d" class="pw-post-body-paragraph li lj it lk b ll ng kd ln lo nh kg lq lr ni lt lu lv nj lx ly lz nk mb mc md im bi translated">希望以上内容可以帮助你更好地理解装饰函数，并允许你为那些运行时间过长的函数提供一个逃生出口。您可以操纵装饰器来使用不同的键，或者甚至是其他东西来启动stop。一切触手可及。</p><blockquote class="oz"><p id="f077" class="pa pb it bd pc pd pe pf pg ph pi md dk translated">如果你喜欢这篇文章，请留下掌声和关注支持！</p></blockquote><p id="5139" class="pw-post-body-paragraph li lj it lk b ll pj kd ln lo pk kg lq lr pl lt lu lv pm lx ly lz pn mb mc md im bi translated">或者，如果您有兴趣加入Medium社区，这里有一个推荐链接:</p><div class="nl nm gp gr nn no"><a href="https://medium.com/@adrian.causby15/membership" rel="noopener follow" target="_blank"><div class="np ab fo"><div class="nq ab nr cl cj ns"><h2 class="bd jd gy z fp nt fr fs nu fu fw jc bi translated">通过我的推荐链接加入Medium-Adrian caus by</h2><div class="nv l"><p class="bd b dl z fp nt fr fs nu fu fw dk translated">medium.com</p></div></div><div class="nw l"><div class="po l ny nz oa nw ob lb no"/></div></div></a></div><p id="cf02" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">感谢Marcell Orban与我一起为我们的应用程序编写框架。</p></div></div>    
</body>
</html>