<html>
<head>
<title>The Battle of Interactive Geographic Visualization Part 7 — Bokeh</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">交互式地理可视化之战第七部分——散景</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/the-battle-of-interactive-geographic-visualization-part-7-bokeh-57e40e159354#2022-04-13">https://towardsdatascience.com/the-battle-of-interactive-geographic-visualization-part-7-bokeh-57e40e159354#2022-04-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="c3c7" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">PYTHON。数据科学。地理可视化</h2><div class=""/><div class=""><h2 id="ec4e" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">使用散景库创建漂亮的交互式Geoplots</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/e74e48ab5961f92a97c149781520a55f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MBtQM8K0CzJAfZB2"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">德尔菲·德拉鲁阿在<a class="ae lh" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="1a80" class="li lj it bd lk ll lm ln lo lp lq lr ls ki lt kj lu kl lv km lw ko lx kp ly lz bi translated">我们离开的地方</h1><p id="ce6a" class="pw-post-body-paragraph ma mb it mc b md me kd mf mg mh kg mi mj mk ml mm mn mo mp mq mr ms mt mu mv im bi translated">在这个系列中，我们已经确定了六(6)种制作美丽地理散射图的方法。</p><ul class=""><li id="23a7" class="mw mx it mc b md my mg mz mj na mn nb mr nc mv nd ne nf ng bi translated"><strong class="mc jd">全息视图</strong> — <a class="ae lh" rel="noopener" target="_blank" href="/the-battle-of-interactive-geographic-visualization-part-1-interactive-geoplot-using-one-line-of-8214e9ed1bb4">交互式地理可视化之战第一部分——使用一行代码的交互式地理地图</a></li><li id="60da" class="mw mx it mc b md nh mg ni mj nj mn nk mr nl mv nd ne nf ng bi translated"><strong class="mc jd"> Plotly Express — </strong> <a class="ae lh" rel="noopener" target="_blank" href="/the-battle-of-interactive-geographic-visualization-part-2-interactive-geoplot-using-one-line-of-2118af59a77c">交互式地理可视化之战第二部分——使用一行代码的交互式geo plot</a></li><li id="3393" class="mw mx it mc b md nh mg ni mj nj mn nk mr nl mv nd ne nf ng bi translated"><strong class="mc jd"> Plotly Go </strong> — <a class="ae lh" rel="noopener" target="_blank" href="/the-battle-of-interactive-geographic-visualization-part-3-plotly-graph-objects-go-c3d3f2a00132">交互式地理可视化之战第三部分——Plotly图形对象(Go) </a></li><li id="ae19" class="mw mx it mc b md nh mg ni mj nj mn nk mr nl mv nd ne nf ng bi translated"><strong class="mc jd">牛郎星</strong>——<a class="ae lh" rel="noopener" target="_blank" href="/the-battle-of-interactive-geographic-visualization-part-4-altair-5b67e3e5e29e">交互式地理可视化之战第四集——牛郎星</a></li><li id="6f26" class="mw mx it mc b md nh mg ni mj nj mn nk mr nl mv nd ne nf ng bi translated"><strong class="mc jd">叶</strong> — <a class="ae lh" href="https://medium.com/towards-data-science/the-battle-of-interactive-geographic-visualization-part-5-folium-cc2213d29a7?source=user_profile---------0-------------------------------" rel="noopener">交互式地理可视化之战第五部分—叶</a></li><li id="a175" class="mw mx it mc b md nh mg ni mj nj mn nk mr nl mv nd ne nf ng bi translated"><strong class="mc jd"> Greppo </strong> — <a class="ae lh" rel="noopener" target="_blank" href="/the-battle-of-interactive-geographic-visualization-part-6-greppo-4f615a1dae43">交互式地理可视化之战第六部分— Greppo </a></li></ul><p id="35a8" class="pw-post-body-paragraph ma mb it mc b md my kd mf mg mz kg mi mj nm ml mm mn nn mp mq mr no mt mu mv im bi translated">在这篇文章中，我们将学习如何用散景来做到这一点。现在，散景是内置在面板上的，这是我们在本系列的第一篇文章中使用的。</p><h1 id="8e2d" class="li lj it bd lk ll lm ln lo lp lq lr ls ki lt kj lu kl lv km lw ko lx kp ly lz bi translated">PLOTLY VS. BOKEH</h1><p id="add3" class="pw-post-body-paragraph ma mb it mc b md me kd mf mg mh kg mi mj mk ml mm mn mo mp mq mr ms mt mu mv im bi translated">一篇关于此的文章总结了这两个库的主要区别。当我们谈论易用性时，Plotly更好，并且推而广之，在制作单独的(包括3D)地图时更容易使用。</p><p id="20f9" class="pw-post-body-paragraph ma mb it mc b md my kd mf mg mz kg mi mj nm ml mm mn nn mp mq mr no mt mu mv im bi translated">散景的亮点在于它的仪表板功能。这意味着更容易创建、托管和样式化仪表板。</p><p id="bc7d" class="pw-post-body-paragraph ma mb it mc b md my kd mf mg mz kg mi mj nm ml mm mn nn mp mq mr no mt mu mv im bi translated">不再赘述，让我们开始编码吧。</p><h1 id="78da" class="li lj it bd lk ll lm ln lo lp lq lr ls ki lt kj lu kl lv km lw ko lx kp ly lz bi translated">编码</h1><h2 id="939d" class="np lj it bd lk nq nr dn lo ns nt dp ls mj nu nv lu mn nw nx lw mr ny nz ly iz bi translated">预赛</h2><p id="23ad" class="pw-post-body-paragraph ma mb it mc b md me kd mf mg mh kg mi mj mk ml mm mn mo mp mq mr ms mt mu mv im bi translated">我们将使用以下软件包重新创建我们与其他文章的互动地图:</p><pre class="ks kt ku kv gt oa ob oc od aw oe bi"><span id="3e64" class="np lj it ob b gy of og l oh oi">import pandas as pd</span><span id="bb44" class="np lj it ob b gy oj og l oh oi">#Transformation of Geocodes<br/>from pyproj import Proj, transform</span><span id="f2fc" class="np lj it ob b gy oj og l oh oi">from bokeh.plotting import figure, save, show<br/>from bokeh.io import output_notebook</span><span id="146e" class="np lj it ob b gy oj og l oh oi">#For the Map Tiles<br/>from bokeh.tile_providers import get_provider, WIKIMEDIA, CARTODBPOSITRON, STAMEN_TERRAIN, STAMEN_TONER, ESRI_IMAGERY, OSM<br/>tile_provider = get_provider(xyz.OpenStreetMap.Mapnik)</span><span id="18a3" class="np lj it ob b gy oj og l oh oi">#To display properly the maps<br/>import panel as pn<br/>pn.extension()<br/>import warnings<br/>warnings.filterwarnings("ignore")</span></pre><p id="9a57" class="pw-post-body-paragraph ma mb it mc b md my kd mf mg mz kg mi mj nm ml mm mn nn mp mq mr no mt mu mv im bi translated">这里只是简单解释一下面板库的用法:<strong class="mc jd">我们需要使用它来使地图在我们的笔记本上可用。</strong>如果我们想在同一个地图上添加多个数据集，这一点很重要。然而，通常不使用这些，地图将显示在单独的网页上。</p><h2 id="0a75" class="np lj it bd lk nq nr dn lo ns nt dp ls mj nu nv lu mn nw nx lw mr ny nz ly iz bi translated">加载数据</h2><pre class="ks kt ku kv gt oa ob oc od aw oe bi"><span id="6e15" class="np lj it ob b gy of og l oh oi">df = pd.read_csv('Coffee Brands Footprint.csv',<br/>                index_col=0)</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/e3398786d9e28463cf83c0920f21c027.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pQzDOZDdfEhSH_pk.png"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">作者图片:我们数据集的前五次观察。</p></figure><h2 id="3a2f" class="np lj it bd lk nq nr dn lo ns nt dp ls mj nu nv lu mn nw nx lw mr ny nz ly iz bi translated">创建底图-地理编码的转换</h2><p id="092a" class="pw-post-body-paragraph ma mb it mc b md me kd mf mg mh kg mi mj mk ml mm mn mo mp mq mr ms mt mu mv im bi translated">正如在其他文章中一样，我们需要创建一个底图，在其中对附加数据进行分层。</p><p id="5078" class="pw-post-body-paragraph ma mb it mc b md my kd mf mg mz kg mi mj nm ml mm mn nn mp mq mr no mt mu mv im bi translated">但是，请注意，与其他文章不同，我们没有使用GeoPandas。因此，散景需要一种理解<code class="fe ol om on ob b">geometry</code>数据类型的方法。</p><p id="2be1" class="pw-post-body-paragraph ma mb it mc b md my kd mf mg mz kg mi mj nm ml mm mn nn mp mq mr no mt mu mv im bi translated">为此，我们需要始终转换我们的地理编码集，或者更准确地说，使用投影比例，以便散景可以正确地绘制它们。</p><pre class="ks kt ku kv gt oa ob oc od aw oe bi"><span id="0055" class="np lj it ob b gy of og l oh oi">inProj = Proj(init='epsg:3857')<br/>outProj = Proj(init='epsg:4326')</span><span id="b7cf" class="np lj it ob b gy oj og l oh oi">ph_lon1, ph_lat1 = transform(outProj,inProj,115,0)<br/>ph_lon2, ph_lat2 = transform(outProj,inProj,130,25)</span></pre><p id="d07a" class="pw-post-body-paragraph ma mb it mc b md my kd mf mg mz kg mi mj nm ml mm mn nn mp mq mr no mt mu mv im bi translated">上面的地理编码是通过反复试验为我们的地图生成最佳边界而生成的。如果您想将地图限制在特定的地区、国家或城市，以便更好地聚焦，我建议您也这样做。</p><p id="b331" class="pw-post-body-paragraph ma mb it mc b md my kd mf mg mz kg mi mj nm ml mm mn nn mp mq mr no mt mu mv im bi translated">要初始化基本地图:</p><pre class="ks kt ku kv gt oa ob oc od aw oe bi"><span id="c947" class="np lj it ob b gy of og l oh oi">#Initialize the tile that we will use<br/>cartodb = get_provider(CARTODBPOSITRON)</span><span id="ccb5" class="np lj it ob b gy oj og l oh oi">#Initialize the fig object<br/>fig = figure(plot_width=800, plot_height=700,<br/>             x_range=(ph_lon1, ph_lon2),<br/>             y_range=(ph_lat1, ph_lat2),<br/>             x_axis_type="mercator", <br/>             y_axis_type="mercator",<br/>             tooltips=[<br/>                    ("Cofee Brand", "<a class="ae lh" href="http://twitter.com/brand" rel="noopener ugc nofollow" target="_blank">@brand</a>"), ("Location", "<a class="ae lh" href="http://twitter.com/vicinity" rel="noopener ugc nofollow" target="_blank">@vicinity</a>")<br/>                    ],<br/>            title="Coffee Shops in the Philippines")</span><span id="5392" class="np lj it ob b gy oj og l oh oi">fig.add_tile(cartodb)</span><span id="1503" class="np lj it ob b gy oj og l oh oi">fig.xaxis.visible = False <br/>fig.yaxis.visible = False</span><span id="c498" class="np lj it ob b gy oj og l oh oi">show(fig)</span></pre><p id="332c" class="pw-post-body-paragraph ma mb it mc b md my kd mf mg mz kg mi mj nm ml mm mn nn mp mq mr no mt mu mv im bi translated">让我们讨论一下散景的人物功能所特有的代码部分:</p><ul class=""><li id="5dce" class="mw mx it mc b md my mg mz mj na mn nb mr nc mv nd ne nf ng bi translated"><strong class="mc jd"> x_range，y_range </strong> —这些是图形的边界。X轴指的是经度，Y轴指的是纬度。相应地调整这些以创建所需的地图边界。</li><li id="3474" class="mw mx it mc b md nh mg ni mj nj mn nk mr nl mv nd ne nf ng bi translated"><strong class="mc jd"> x_axis_type，y_axis_type </strong> —这告诉散景如何解释您的轴。“墨卡托”应该特别为非美国地图选择。</li><li id="2142" class="mw mx it mc b md nh mg ni mj nj mn nk mr nl mv nd ne nf ng bi translated">工具提示—要在工具提示中显示的变量列表。交互式工具提示的格式应该遵循一个元组。元组的第一个元素是将为工具提示显示的名称，第二个元素应该是对dataframe源的引用。格式应该是“@column_name”。</li></ul><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oo"><img src="../Images/66d6cf8056757891559a7ccf081a1c1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hB92A1XmtNJYYewfMla40w.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">作者图片:底图已创建。请注意，在试图找到完美的边界时，轴应该理想地显示出来，以便经度和纬度值可见。</p></figure><h2 id="9256" class="np lj it bd lk nq nr dn lo ns nt dp ls mj nu nv lu mn nw nx lw mr ny nz ly iz bi translated">转换地理编码</h2><p id="1e8f" class="pw-post-body-paragraph ma mb it mc b md me kd mf mg mh kg mi mj mk ml mm mn mo mp mq mr ms mt mu mv im bi translated">正如我们所指出的，成对的地理编码需要被转换或“投影”才能对散景有意义。因此，我们需要使用以下代码:</p><pre class="ks kt ku kv gt oa ob oc od aw oe bi"><span id="488e" class="np lj it ob b gy of og l oh oi">lons, lats = [], []<br/>for lon, lat in list(zip(df["lng"], df["lat"])):<br/>    x, y = transform(outProj,inProj,lon,lat)<br/>    lons.append(x)<br/>    lats.append(y)<br/>    <br/>df["MercatorX"] = lons<br/>df["MercatorY"] = lats</span></pre><p id="9ee5" class="pw-post-body-paragraph ma mb it mc b md my kd mf mg mz kg mi mj nm ml mm mn nn mp mq mr no mt mu mv im bi translated">转换后，如果我们想一次显示整个数据集，而不引用品牌，我们可以使用以下代码:</p><pre class="ks kt ku kv gt oa ob oc od aw oe bi"><span id="39d7" class="np lj it ob b gy of og l oh oi">fig.circle('MercatorX', 'MercatorY', <br/>           source=df, <br/>           size=7,<br/>           fill_color='red',<br/>           line_color='red',<br/>           line_alpha=0.5,<br/>             fill_alpha=0.3)<br/>show(fig)</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oo"><img src="../Images/7ade6cf985fb2efdaac93b9b01ae1eb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*q0QNixdX59MLn-NuRDWbog.gif"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">作者提供的GIF:第一张显示菲律宾所有咖啡店位置的交互式地图</p></figure><p id="6d09" class="pw-post-body-paragraph ma mb it mc b md my kd mf mg mz kg mi mj nm ml mm mn nn mp mq mr no mt mu mv im bi translated">因为我们想用不同的颜色展示每个品牌，所以我们需要分别添加它们。这种方法，对于该系列的追随者来说，被比作是叶的方法。</p><h2 id="bc68" class="np lj it bd lk nq nr dn lo ns nt dp ls mj nu nv lu mn nw nx lw mr ny nz ly iz bi translated">将每个品牌视为不同的数据集</h2><p id="5eb5" class="pw-post-body-paragraph ma mb it mc b md me kd mf mg mh kg mi mj mk ml mm mn mo mp mq mr ms mt mu mv im bi translated">为不同品牌添加不同颜色的方法是将每个品牌视为一个单独的数据集。</p><p id="de73" class="pw-post-body-paragraph ma mb it mc b md my kd mf mg mz kg mi mj nm ml mm mn nn mp mq mr no mt mu mv im bi translated">但是首先，我们需要建立一个颜色字典:</p><pre class="ks kt ku kv gt oa ob oc od aw oe bi"><span id="84c7" class="np lj it ob b gy of og l oh oi">color_dict = {<br/>    "Starbucks": ' #00704A',<br/>    "Coffee Bean and Tea Leaf": '#362d26',<br/>    "Coffee Project": '#654321',<br/>    "Tim Hortons": '#dd0f2d'<br/>}</span></pre><p id="0dd4" class="pw-post-body-paragraph ma mb it mc b md my kd mf mg mz kg mi mj nm ml mm mn nn mp mq mr no mt mu mv im bi translated">我们需要一套新的fig，因为上一套已经用红点编码了。</p><pre class="ks kt ku kv gt oa ob oc od aw oe bi"><span id="8071" class="np lj it ob b gy of og l oh oi">#Doing the Fig<br/>fig = figure(plot_width=800, plot_height=700,<br/>             x_range=(ph_lon1, ph_lon2),<br/>             y_range=(ph_lat1, ph_lat2),<br/>             x_axis_type="mercator", <br/>             y_axis_type="mercator",<br/>             tooltips=[<br/>                    ("Cofee Brand", "<a class="ae lh" href="http://twitter.com/brand" rel="noopener ugc nofollow" target="_blank">@brand</a>"), ("Location", "<a class="ae lh" href="http://twitter.com/vicinity" rel="noopener ugc nofollow" target="_blank">@vicinity</a>")<br/>                    ],<br/>            title="Coffee Shops in the Philippines")</span><span id="1464" class="np lj it ob b gy oj og l oh oi">fig.add_tile(cartodb)</span></pre><p id="1617" class="pw-post-body-paragraph ma mb it mc b md my kd mf mg mz kg mi mj nm ml mm mn nn mp mq mr no mt mu mv im bi translated">要循环遍历数据集:</p><pre class="ks kt ku kv gt oa ob oc od aw oe bi"><span id="3f54" class="np lj it ob b gy of og l oh oi">#Looping over the dataset<br/>for i in color_dict.keys():<br/>    temp = df[df.brand==i]<br/>    fig.circle('MercatorX', 'MercatorY', <br/>           source=temp, <br/>           size=7,<br/>           fill_color=color_dict[i],<br/>           line_color=color_dict[i],<br/>           line_alpha=0.5,<br/>             fill_alpha=0.5)</span></pre><p id="9517" class="pw-post-body-paragraph ma mb it mc b md my kd mf mg mz kg mi mj nm ml mm mn nn mp mq mr no mt mu mv im bi translated">最后，为了显示代码，我们需要这样做:</p><pre class="ks kt ku kv gt oa ob oc od aw oe bi"><span id="2e84" class="np lj it ob b gy of og l oh oi">pn.pane(fig)</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oo"><img src="../Images/52a6be3dc9035ac94635cef58b97c53a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*smTPYT0ldVl_PQy6mpCYIw.gif"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">GIF由作者:类似的互动地图，就像我们在以前的文章</p></figure><p id="3922" class="pw-post-body-paragraph ma mb it mc b md my kd mf mg mz kg mi mj nm ml mm mn nn mp mq mr no mt mu mv im bi translated">请注意，<code class="fe ol om on ob b">show(fig)</code>可以正常工作，但可能会显示一条错误消息，所以这不是我们在文章中使用的。</p><h1 id="e989" class="li lj it bd lk ll lm ln lo lp lq lr ls ki lt kj lu kl lv km lw ko lx kp ly lz bi translated">结束语</h1><p id="0dd7" class="pw-post-body-paragraph ma mb it mc b md me kd mf mg mh kg mi mj mk ml mm mn mo mp mq mr ms mt mu mv im bi translated">从这篇文章中我们可以看出，用散景复制其他库的地图是可能的。</p><p id="0906" class="pw-post-body-paragraph ma mb it mc b md my kd mf mg mz kg mi mj nm ml mm mn nn mp mq mr no mt mu mv im bi translated">然而，我们确实看到，我们必须采取某些步骤来确保散景理解我们的数据类型(<em class="op">非地理空间数据类型也是如此)</em>，一些数据科学家需要熟悉这些数据类型。</p><p id="49fc" class="pw-post-body-paragraph ma mb it mc b md my kd mf mg mz kg mi mj nm ml mm mn nn mp mq mr no mt mu mv im bi translated">散景在创建仪表板方面很棒，但我们还没有创建一个，所以就其完整的功能和特性而言，我们还没有看到全部。这可能是一个在未来开展的好项目，Bokeh是一个学习和添加到现代地理空间数据科学家工具箱中的惊人工具。</p><p id="4027" class="pw-post-body-paragraph ma mb it mc b md my kd mf mg mz kg mi mj nm ml mm mn nn mp mq mr no mt mu mv im bi translated">让我知道你的想法！</p></div></div>    
</body>
</html>