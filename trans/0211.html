<html>
<head>
<title>Which tool should you use for database migrations?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">您应该使用哪种工具进行数据库迁移？</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/which-tool-should-you-use-for-database-migrations-4e0b9c44b790#2022-02-09">https://towardsdatascience.com/which-tool-should-you-use-for-database-migrations-4e0b9c44b790#2022-02-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="e8e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">根据您的需求选择一个范例。</p><p id="26f9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我所有的数据团队都有一个关系数据库作为我们运营的核心。当你有一个关系数据库，你将不可避免地要改变它！这篇文章将帮助你在三个有用的版本化数据库迁移框架之间做出选择——分别是<a class="ae kl" href="https://sqitch.org/" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir"/></a><a class="ae kl" href="https://flywaydb.org/" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir"/></a>和<a class="ae kl" href="https://www.liquibase.com/pricing?utm_term=liquibase&amp;utm_campaign=brandsearch&amp;utm_source=google&amp;utm_medium=ppc&amp;hsa_acc=7217304035&amp;hsa_cam=12808646352&amp;hsa_grp=119923141903&amp;hsa_ad=517707365974&amp;hsa_src=g&amp;hsa_tgt=kwd-370520217004&amp;hsa_kw=liquibase&amp;hsa_mt=e&amp;hsa_net=adwords&amp;hsa_ver=3&amp;gclid=Cj0KCQiAxoiQBhCRARIsAPsvo-wjD1EMdIGF00wKitSh_7kJhUUUIsxq6bHntP0Q8DzrpU3yq0iZI7YaAqDIEALw_wcB" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> liquibase </strong> </a>。GitHub中有一个关联的<a class="ae kl" href="https://github.com/nathansutton/database-migrations" rel="noopener ugc nofollow" target="_blank">存储库</a>，它遍历dockerized PostgreSQL数据库中相同表的每个实现。</p><h1 id="a777" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">TL；博士；医生</h1><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi lk"><img src="../Images/25ebaf1ff5884340157fa8752e6e1a5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YXTcL3QGjGg2c9YIhcaqAw.png"/></div></div><p class="lw lx gj gh gi ly lz bd b be z dk translated">帮助你决定的快速决策树(图片由作者提供)</p></figure><h1 id="8d36" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated"><strong class="ak">为什么是这三种？</strong></h1><p id="579b" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">我将本指南的重点放在sqitch、flyway和liquibase上，因为它们都有两个重要的特征。首先，它们几乎可以与任何关系数据库一起工作——这就排除了微软优秀的DACPACs。第二，它们都允许用户用普通的SQL编写迁移——这省去了像Alembic和T21这样的迁移的ORM实现。</p><h1 id="cdc9" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">您的数据来自CRUD应用程序吗？</h1><blockquote class="mf mg mh"><p id="deee" class="jn jo mi jp b jq jr js jt ju jv jw jx mj jz ka kb mk kd ke kf ml kh ki kj kk ij bi translated">你有选择</p></blockquote><p id="2be7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">许多OLTP工作负载的定义特征是后端从应用程序层接收和存储数据。所有这三种迁移工具都擅长于保持数据库及其应用程序同步的基本功能。迁移是自动应用于数据库的，而数据仍然保持在相同的表中。</p><h1 id="2351" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">你的数据来自云存储吗？</h1><blockquote class="mf mg mh"><p id="b441" class="jn jo mi jp b jq jr js jt ju jv jw jx mj jz ka kb mk kd ke kf ml kh ki kj kk ij bi translated">考虑飞行路线</p></blockquote><p id="afe9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">相比之下，许多OLAP工作负载可以通过从云存储(如S3或Azure Blob存储)再次加载所有暂存文件来轻松复制。Flyway作为一个SQL执行器在这里大放异彩，它可以可靠地再现给定数据库的状态。特别是，在不同类型的普通SQL文件中，很容易将DML与DDL分开。这允许您再次运行相同的转换，但是加载最新的数据。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi mm"><img src="../Images/0df7ca92cd19ee278fdc18f43a6a2662.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4NlWzAUjZtR3aWaLYAsHAw.png"/></div></div><p class="lw lx gj gh gi ly lz bd b be z dk translated">Flyway擅长在“回调”中用新数据重复相同的任务</p></figure><h1 id="f7ef" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">有很多有序的DML变换吗？</h1><blockquote class="mf mg mh"><p id="e865" class="jn jo mi jp b jq jr js jt ju jv jw jx mj jz ka kb mk kd ke kf ml kh ki kj kk ij bi translated">考虑飞行路线</p></blockquote><p id="f0db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您的数据操作语言在准备好用于下游之前在多个表之间移动数据，那么flyway比sqitch具有独特的优势，因为您可以很容易地从文件名中推断出执行的顺序。 Flyway分为“版本化迁移”(V*前缀，通常是您的DDL)和“回调”(afterMigrate*前缀，通常是您的DML)。我的大多数团队都使用XXXX数字脚本作为命名约定。在下面的简化示例中，很容易看出毛表是在价格表之后加载的<a class="ae kl" href="https://github.com/nathansutton/database-migrations/tree/main/src/migrations/flyway" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="b2a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这种可解释性对于负责批量分析工作负载的开发人员来说是超级有帮助的。【<em class="mi">警告:由于我专注于数据科学</em>，所以有所偏颇。事实上，我部署的所有统计模型都依赖于管道，这些管道迭代地清理和聚集数据，直到它们为模型做好准备。如果您不受实时操作的约束，这就意味着在某个时间间隔会出现大量的“请按顺序执行这个SQL”。Flyway是一种每次都能得到相同结果的可靠方法。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi mn"><img src="../Images/5f2db87f0d9dd4bdffaf2b5059139978.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EgL1XrKzMYEBvyyzt-MbHA.png"/></div></div><p class="lw lx gj gh gi ly lz bd b be z dk translated">执行的顺序在文件系统中是清楚的(图片由作者提供)</p></figure><p id="421d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">相比之下，sqitch.plan文件中的sqitch隐藏了相同的排序逻辑。当团队使用交叉引用的票号作为他们的文件名时，这变得更加困难。现在，你必须在三个地方查找，以找出什么(文件系统)，什么时候(sqitch.plan)，以及为什么(JIRA等人)做了任何事情。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi mo"><img src="../Images/504ba6e968c32a8b28297f1f5f60f10b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ugNhJ2w9JC9sbpBIqyE6Cw.png"/></div></div><p class="lw lx gj gh gi ly lz bd b be z dk translated">执行顺序在sqitch.plan中是显而易见的，但在文件系统中却不明显(图片由作者提供)</p></figure><h1 id="f4bf" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">您需要恢复迁移吗？</h1><blockquote class="mf mg mh"><p id="2899" class="jn jo mi jp b jq jr js jt ju jv jw jx mj jz ka kb mk kd ke kf ml kh ki kj kk ij bi translated">考虑sqitch</p></blockquote><p id="84a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Sqitch在开发中有更多的开销，因为您必须编写逻辑来进行更改，编写逻辑来测试它是否工作，编写逻辑来在测试失败时恢复更改。这在开始时需要做更多的工作，但是它有一个很好的特性，即您可以将迁移回滚到历史上的任何给定时间点。<strong class="jp ir">不幸的是，</strong> <a class="ae kl" href="https://flywaydb.org/documentation/command/undo" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">回滚迁移是flyway </strong> </a>中的一项付费功能。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi mp"><img src="../Images/0f49ea0115d523e846eef275ee96866d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YNOcvIZvUyTIMCnn06vmDA.png"/></div></div><p class="lw lx gj gh gi ly lz bd b be z dk translated">信任但用sqitch验证(图片由作者提供)</p></figure><h1 id="06c1" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">您使用环境变量来参数化您的部署吗？</h1><blockquote class="mf mg mh"><p id="7e47" class="jn jo mi jp b jq jr js jt ju jv jw jx mj jz ka kb mk kd ke kf ml kh ki kj kk ij bi translated">避免liquibase</p></blockquote><p id="9af7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你还没这么做，我会很惊讶的。将数据库秘密置于版本控制之外是安全性101。<strong class="jp ir">不幸的是，使用环境变量是liqui base</strong>T5<a class="ae kl" href="https://docs.liquibase.com/commands/liquibase-environment-variables.html" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">的付费特性。flyway和sqitch都支持现成的参数化。当然，您可以深入并修改它们的docker入口点，但是为什么有必要这样做呢？！</strong></a></p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi mq"><img src="../Images/f4e666ef3837f9a5799a6bf346970789.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ubLIwW2GvHa9KrcmGPM1Ww.png"/></div></div><p class="lw lx gj gh gi ly lz bd b be z dk translated">请将您的秘密置于版本控制之外(图片由作者提供)</p></figure><h1 id="9d5b" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">还是不确定？</h1><p id="39c8" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated"><a class="ae kl" href="https://github.com/nathansutton/database-migrations" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">分叉这个存储库</strong> </a>来尝试构建一些您的核心表结构。配置文件和卷映射等所有棘手的事情都已解决，您可以简单地将迁移切换到这三个工具中的任何一个。</p></div></div>    
</body>
</html>