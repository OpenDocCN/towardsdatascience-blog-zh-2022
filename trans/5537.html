<html>
<head>
<title>Guide to Implementing Custom Accelerated AI Libraries in SageMaker with oneAPI and Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 oneAPI 和 Docker 在 SageMaker 中实现定制加速 AI 库的指南</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/guide-to-implementing-custom-accelerated-ai-libraries-in-sagemaker-with-oneapi-and-docker-97547692cb6e#2022-12-13">https://towardsdatascience.com/guide-to-implementing-custom-accelerated-ai-libraries-in-sagemaker-with-oneapi-and-docker-97547692cb6e#2022-12-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="135b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">了解如何为加速的 ML 库构建定制的 SageMaker 模型</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/c35c32cf2957d6f70cbd3392654d087f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X7rIB1RDdu9SkC5rsH1bVg.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://www.freepik.com/free-photo/image-engineering-objects-workplace-top-view-construction-concept-engineering-tools-vintage-tone-retro-filter-effect-soft-focus-selective-focus_1239496.htm#query=architect&amp;position=2&amp;from_view=search&amp;track=sph" rel="noopener ugc nofollow" target="_blank">图像来源</a></p></figure><p id="a32a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">AWS 为 SageMaker 提供了开箱即用的机器学习图像，但是当您想要部署您的自定义推理和训练解决方案时，会发生什么情况呢？</p><p id="49c4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">本教程将探索定制 ML 训练和推理的具体实现，它利用<a class="ae kv" href="https://www.intel.com/content/www/us/en/developer/articles/technical/improve-performance-xgboost-lightgbm-inference.html#gs.khqx45" rel="noopener ugc nofollow" target="_blank"> daal4py </a>来优化 XGBoost 以实现英特尔硬件加速性能。本文假设您正在使用 SageMaker 模型和端点。</p><p id="9db3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="ls">本教程是关于使用英特尔人工智能分析工具包构建硬件优化的 SageMaker 端点系列的一部分。你可以在这里</em>   <em class="ls">找到本教程</em> <a class="ae kv" href="https://github.com/eduand-alvarez/ai-kit-sagemaker-templates/tree/main/xgboost-daal4py/0_xgboost-daal4py-container" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> <em class="ls">的所有代码。</em></strong></a></p><h2 id="6584" class="lt lu iq bd lv lw lx dn ly lz ma dp mb lf mc md me lj mf mg mh ln mi mj mk ml bi translated">配置 Dockerfile 和容器设置</h2><p id="b67e" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">我们将使用 AWS Cloud9，因为它已经拥有构建容器映像的所有权限和应用程序。欢迎您在本地机器上构建这些。</p><p id="0cd6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们快速回顾一下映像中关键文件的用途。在本文的<a class="ae kv" href="https://github.com/eduand-alvarez/ai-kit-sagemaker-templates/tree/main/xgboost-daal4py/0_xgboost-daal4py-container" rel="noopener ugc nofollow" target="_blank"> GitHub Repo </a>中，我已经将每个描述链接到适当的文件:</p><ul class=""><li id="7c7b" class="mr ms iq ky b kz la lc ld lf mt lj mu ln mv lr mw mx my mz bi translated"><a class="ae kv" href="https://github.com/eduand-alvarez/ai-kit-sagemaker-templates/blob/main/xgboost-daal4py/0_xgboost-daal4py-container/train" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir">训练</strong> </a> <strong class="ky ir"> : </strong>这个脚本将包含训练我们模型的程序。当您构建算法时，您将编辑它以包含您的训练代码。</li><li id="0a69" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated"><a class="ae kv" href="https://github.com/eduand-alvarez/ai-kit-sagemaker-templates/blob/main/xgboost-daal4py/0_xgboost-daal4py-container/serve" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">serve</strong></a><strong class="ky ir">:</strong>这个脚本包含一个推理服务器的包装器。在大多数情况下，您可以按原样使用该文件。</li><li id="71a0" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated"><a class="ae kv" href="https://github.com/eduand-alvarez/ai-kit-sagemaker-templates/blob/main/xgboost-daal4py/0_xgboost-daal4py-container/wsgi.py" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> wsgi.py </strong> </a> <strong class="ky ir"> : </strong>用于个体服务器工作者的启动 shell。只有当您更改 predictor.py 的位置或名称时，才需要更改此设置。</li><li id="9a89" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated"><a class="ae kv" href="https://github.com/eduand-alvarez/ai-kit-sagemaker-templates/blob/main/xgboost-daal4py/0_xgboost-daal4py-container/predictor.py" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">predictor . py</strong></a><strong class="ky ir">:</strong>算法特定的推理代码。这是最棘手的脚本，因为它需要大量修改以适应您的原始数据处理方案——<strong class="ky ir">ping</strong>和<strong class="ky ir">调用</strong>函数，因为它们具有重要的性质。ping 功能确定容器是否正常工作。在这个示例容器中，如果我们可以成功地加载模型，我们就声明它是健康的。当向 SageMaker 端点发出 POST 请求时，就会执行调用函数。</li></ul><p id="5cae" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> ScoringService </strong>类包含两个方法，<strong class="ky ir"> get_model </strong>和<strong class="ky ir"> predict </strong>。<strong class="ky ir"> predict </strong>方法有条件地将我们训练好的 xgboost 模型转换为 daal4py 模型。Daal4py 通过利用英特尔 oneAPI 数据分析库(oneDAL)，使 xgboost 机器学习算法的执行速度更快，从而在底层硬件上获得更好的性能。</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="8c3d" class="nk lu iq ng b be nl nm l nn no">class ScoringService(object):<br/>    model = None  # Where we keep the model when it's loaded<br/><br/>    @classmethod<br/>    def get_model(cls):<br/>        """Get the model object for this instance, loading it if it's not already loaded."""<br/>        if cls.model == None:<br/>            with open(os.path.join(model_path, "xgboost-model"), "rb") as inp:<br/>                cls.model = pickle.load(inp)<br/>        return cls.model<br/><br/>    @classmethod<br/>    def predict(cls, input, daal_opt=False):<br/>        """Receives an input and conditionally optimizes xgboost model using daal4py conversion.<br/>        Args:<br/>            input (a pandas dataframe): The data on which to do the predictions. There will be<br/>                one prediction per row in the dataframe"""<br/><br/>        clf = cls.get_model()<br/>        <br/>        if daal_opt:<br/>            daal_model = d4p.get_gbt_model_from_xgboost(clf.get_booster())<br/>            return d4p.gbt_classification_prediction(nClasses=2, resultsToEvaluate='computeClassProbabilities', fptype='float').compute(input, daal_model).probabilities[:,1]<br/>            <br/>        return clf.predict(input)</span></pre><ul class=""><li id="c394" class="mr ms iq ky b kz la lc ld lf mt lj mu ln mv lr mw mx my mz bi translated"><a class="ae kv" href="https://github.com/eduand-alvarez/ai-kit-sagemaker-templates/blob/main/xgboost-daal4py/0_xgboost-daal4py-container/nginx.conf" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">nginx . conf</strong></a><strong class="ky ir">:</strong>管理多个 workers 的 nginx 主服务器的配置。在大多数情况下，您可以按原样使用该文件。</li><li id="4b9c" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated"><a class="ae kv" href="https://github.com/eduand-alvarez/ai-kit-sagemaker-templates/blob/main/xgboost-daal4py/0_xgboost-daal4py-container/requirements.txt" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">requirements . txt</strong></a><strong class="ky ir">:</strong>定义了我们的映像所需的所有依赖项。</li></ul><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="8a12" class="nk lu iq ng b be nl nm l np no">boto3<br/>flask <br/>gunicorn<br/>numpy==1.21.4<br/>pandas==1.3.5<br/>sagemaker==2.93.0<br/>scikit-learn==0.24.2<br/>xgboost==1.5.0<br/>daal4py==2021.7.1</span></pre><ul class=""><li id="77c4" class="mr ms iq ky b kz la lc ld lf mt lj mu ln mv lr mw mx my mz bi translated"><a class="ae kv" href="https://github.com/eduand-alvarez/ai-kit-sagemaker-templates/blob/main/xgboost-daal4py/0_xgboost-daal4py-container/Dockerfile" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> Dockerfile: </strong> </a>这个文件负责配置我们自定义的 SageMaker 映像。</li></ul><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="d7d9" class="nk lu iq ng b be nl nm l np no">FROM public.ecr.aws/docker/library/python:3.8<br/><br/># copy requirement file and install python lib<br/>COPY requirements.txt /build/<br/>RUN pip --no-cache-dir install -r /build/requirements.txt<br/><br/># install programs for proper hosting of our endpoint server<br/>RUN apt-get -y update &amp;&amp; apt-get install -y --no-install-recommends \<br/>         nginx \<br/>         ca-certificates \<br/>    &amp;&amp; rm -rf /var/lib/apt/lists/*<br/><br/># We update PATH so that the train and serve programs are found when the container is invoked.<br/>ENV PATH="/opt/program:${PATH}"<br/><br/># Set up the program in the image<br/>COPY xgboost_model_code/train /opt/program/train<br/>COPY xgboost_model_code/serve /opt/program/serve<br/>COPY xgboost_model_code/nginx.conf /opt/program/nginx.conf<br/>COPY xgboost_model_code/predictor.py /opt/program/predictor.py<br/>COPY xgboost_model_code/wsgi.py /opt/program/wsgi.py<br/><br/>#set executable permissions for all scripts<br/>RUN chmod +x /opt/program/train<br/>RUN chmod +x /opt/program/serve<br/>RUN chmod +x /opt/program/nginx.conf<br/>RUN chmod +x /opt/program/predictor.py<br/>RUN chmod +x /opt/program/wsgi.py<br/><br/># set the working directory<br/>WORKDIR /opt/program</span></pre><p id="a9c8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们的 docker 执行 docker 文件中定义的以下步骤从 AWS 公共容器注册表安装一个基础映像，复制并安装 requirements.txt 文件中定义的依赖项，安装用于托管端点服务器的程序，更新路径的位置，将所有相关文件复制到我们的映像中，为所有文件提供可执行权限，并将工作目录设置为/opt/program。</p><h2 id="ab64" class="lt lu iq bd lv lw lx dn ly lz ma dp mb lf mc md me lj mf mg mh ln mi mj mk ml bi translated">了解 SageMaker 将如何使用我们的形象</h2><p id="6b35" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">因为我们在训练或托管中运行相同的映像，所以 Amazon SageMaker 在训练时使用参数<code class="fe nq nr ns ng b">train</code>运行容器，在托管端点时使用参数<code class="fe nq nr ns ng b">serve</code>。现在让我们来分析一下在培训和托管阶段到底发生了什么。</p><p id="c25c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">培训阶段:</strong></p><ul class=""><li id="4269" class="mr ms iq ky b kz la lc ld lf mt lj mu ln mv lr mw mx my mz bi translated">你的<code class="fe nq nr ns ng b">train</code>脚本就像一个普通的 Python 程序一样运行。在<code class="fe nq nr ns ng b">/opt/ml</code>目录下有几个文件供您使用:</li></ul><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="e227" class="nk lu iq ng b be nl nm l np no">/opt/ml<br/>|-- input<br/>|   |-- config<br/>|   |   |-- hyperparameters.json<br/>|   | <br/>|   `-- data<br/>|       `-- <br/>|           `-- <br/>|-- model<br/>|   `-- <br/>`-- output<br/>    `-- failure</span></pre><ul class=""><li id="d2e0" class="mr ms iq ky b kz la lc ld lf mt lj mu ln mv lr mw mx my mz bi translated"><code class="fe nq nr ns ng b">/opt/ml/input/config</code>包含控制程序运行方式的信息。<code class="fe nq nr ns ng b">hyperparameters.json</code>是一个 JSON 格式的超参数名称到值的字典。</li><li id="a8fb" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated"><code class="fe nq nr ns ng b">/opt/ml/input/data/</code>(文件模式)包含模型训练的数据。</li><li id="0f2a" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated"><code class="fe nq nr ns ng b">/opt/ml/model/</code>是您编写算法生成的模型的目录。SageMaker 会将这个目录中的所有文件打包成一个压缩的 tar 归档文件。</li><li id="60f0" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated"><code class="fe nq nr ns ng b">/opt/ml/output</code>是算法可以写入文件<code class="fe nq nr ns ng b">failure</code>的目录，该文件描述了作业失败的原因。</li></ul><p id="cfda" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">托管阶段:</strong></p><p id="de90" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">托管与训练有着非常不同的模型，因为托管通过 HTTP 响应推理请求。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/046649069e842f92e8c736100c946a23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_p9tTvvMdtp9MuNqLfQ7sQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图一。本教程中的代码实现的堆栈—图片由作者提供</p></figure><p id="4f5f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">SageMaker 将针对容器中的两个端点:</p><ul class=""><li id="6c53" class="mr ms iq ky b kz la lc ld lf mt lj mu ln mv lr mw mx my mz bi translated"><code class="fe nq nr ns ng b">/ping</code>将从基础设施接收<code class="fe nq nr ns ng b">GET</code>请求。如果容器启动并接受请求，程序返回 200。</li><li id="0b98" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated"><code class="fe nq nr ns ng b">/invocations</code>是接收客户端推理<code class="fe nq nr ns ng b">POST</code>请求的端点。请求和响应的格式取决于算法。</li></ul><h2 id="1053" class="lt lu iq bd lv lw lx dn ly lz ma dp mb lf mc md me lj mf mg mh ln mi mj mk ml bi translated"><strong class="ak">构建图像并注册到 ECR </strong></h2><p id="5fe6" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">我们将需要使我们的形象提供给 SageMaker。还有其他的图像注册中心，但是我们将使用 AWS 弹性容器注册中心(ECR)。</p><p id="8b0f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="ls">将您的自定义映像提供给 SageMaker 管道的步骤在随附的文章中进行了概述:</em> <a class="ae kv" href="https://medium.com/@eduand-alvarez/a-detailed-guide-for-building-hardware-accelerated-mlops-pipelines-in-sagemaker-5d32459665b3" rel="noopener"> <strong class="ky ir"> <em class="ls">在 SageMaker 中构建硬件加速 MLOps 管道的详细指南</em> </strong> </a></p><p id="1924" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="ls">如果您需要帮助构建您的映像并将其推送到 ECR，请遵循本教程:</em><strong class="ky ir"><em class="ls"/></strong><a class="ae kv" href="https://medium.com/@eduand-alvarez/creating-an-ecr-registry-and-pushing-a-docker-image-93e372e74ff7?source=your_stories_page-------------------------------------" rel="noopener"><strong class="ky ir"><em class="ls">创建 ECR 注册表并推送到 Docker 映像</em> </strong> </a></p><h2 id="979d" class="lt lu iq bd lv lw lx dn ly lz ma dp mb lf mc md me lj mf mg mh ln mi mj mk ml bi translated">结论和讨论</h2><p id="ec75" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">AWS Sagemaker 为原型开发和部署机器学习管道提供了一个有用的平台。然而，由于按照 SageMaker 的规范构建底层映像的复杂性，利用您自己的定制训练/推理代码并不容易。在本文中，我们通过教您如何来应对这一挑战:</p><ul class=""><li id="5bf4" class="mr ms iq ky b kz la lc ld lf mt lj mu ln mv lr mw mx my mz bi translated">如何配置 XGBoost 培训脚本</li><li id="9a18" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated">为推理端点配置 Flask APIs</li><li id="1f8c" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated">转换模型 Daal4Py 格式以加速推理</li><li id="4967" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated">如何将上述所有内容打包到 Docker 映像中</li><li id="fbdc" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated">如何注册我们的自定义 SageMaker 图像到 AWS 弹性容器注册表？</li></ul><h2 id="b411" class="lt lu iq bd lv lw lx dn ly lz ma dp mb lf mc md me lj mf mg mh ln mi mj mk ml bi translated">来源:</h2><ul class=""><li id="ae22" class="mr ms iq ky b kz mm lc mn lf nu lj nv ln nw lr mw mx my mz bi translated">Sagemaker XGBoost 集装箱回购|<a class="ae kv" href="https://github.com/aws/sagemaker-xgboost-container" rel="noopener ugc nofollow" target="_blank">https://github.com/aws/sagemaker-xgboost-container</a></li><li id="9451" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated">AI Kit sage maker Templates Repo |<a class="ae kv" href="https://github.com/eduand-alvarez/ai-kit-sagemaker-templates" rel="noopener ugc nofollow" target="_blank">https://github . com/edu and-Alvarez/AI-Kit-sage maker-Templates</a></li></ul></div></div>    
</body>
</html>