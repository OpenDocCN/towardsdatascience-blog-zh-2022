<html>
<head>
<title>Handling historisations in Power BI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Power BI中处理历史记录</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/handling-historisations-in-power-bi-30dc43e9e6f#2022-09-07">https://towardsdatascience.com/handling-historisations-in-power-bi-30dc43e9e6f#2022-09-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f834" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在报道中，历史化就是一切。但是除了通常的时间序列数据之外，我们需要查看维度表的历史化。我们可以这样做。</h2></div><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/2f07662faa589d955478dc7fd63d59b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*K4xS0B8QzzJT5DzM"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated"><a class="ae kz" href="https://unsplash.com/@towfiqu999999?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Towfiqu barbhuiya </a>在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="ad56" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">介绍</h1><p id="e894" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">最常见的报告轴是时间。以天、月或年为粒度。</p><p id="9301" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">至关重要的是，我们能够不带任何扭曲地看待过去。</p><p id="c851" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">本主题中的一个因素是值随时间变化的“通常”时间序列。</p><p id="252c" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">但是报告解决方案的另一部分是维度。</p><p id="ffd6" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">当某个东西发生变化，会改变过去数据的结果，会发生什么？这种变化会带来灾难性的后果。</p><p id="2756" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在本文中，我将讨论以下主题:</p><ul class=""><li id="ac5c" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn my mz na nb bi translated">为什么我们需要维度表的数据历史化？</li><li id="45d2" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">我们如何在Power BI中实现这样的解决方案，我们需要考虑什么？</li><li id="1361" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">行级安全性的安全性设置会发生什么变化？</li></ul><p id="ba20" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我不会讨论如何生成历史数据。</p><p id="d7e3" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">您可以在下面的参考资料部分找到一些关于这个主题的资源。</p><p id="fd3f" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">如果你想让我写一篇关于如何建立历史维度数据的文章，请发表评论。</p><p id="54ab" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">但是请注意，构建历史化数据的机制会根据您的数据平台和用于加载数据的工具而变化。</p><h1 id="1bcb" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">为什么我们要历史化我们的维度？</h1><p id="671c" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">考虑以下虚构的组织MyCorp.com:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nh"><img src="../Images/a7d68f65f1d030e3a4c1963089decfc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PUZUqKYxB989EoeetSxbdw.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图1—MyCorp.com的组织结构图(作者提供的图)</p></figure><p id="427a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">2022年9月1日，组织中的一些人将被提升或改变职位。</p><p id="d774" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">现在，新的组织结构图如下图所示:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi ni"><img src="../Images/58bf1b29ba07aeeebe243addb3272625.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kuWChShgtQVFbeRZ3BiQhA.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图2-晋升后的组织结构图(作者提供的图)</p></figure><p id="f9d4" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">该组织的所有成员都完成了销售。因此，我们可以开始创建销售报告。</p><p id="61fa" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">让我们看看修改前的报告:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nj"><img src="../Images/9fc234dcf947502b400120537f95fef8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iKZW4DU2TYfMtOEwwn3c3w.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图3 —变更前的销售报告(作者提供的图)</p></figure><p id="e2db" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在实现了数据的更改后，我们将得到以下报告:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nk"><img src="../Images/4d786e1e9ea44e607b3ca17164b5d664.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G1xACXNBnUqjF3pGQBkvfQ.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图4 —变更后的销售报告(作者提供的图)</p></figure><p id="d36c" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">如你所见，所有的数据都变了。这是因为有些人换了部门，关于过去的数据被移到了新的部门。</p><p id="24ca" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">通常，这不是我想要的。</p><p id="686a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">由于更改发生在9月1日，我希望在此日期之前的数据不会更改，并且销售额将分配给更改后的新部门。</p><h1 id="a263" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">更改数据</h1><p id="536b" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">在基本窗体中，雇员表如下图所示:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nl"><img src="../Images/848bfe76ddecfa4c0982f766b6d328df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1pXsPMNqwCASgIQrzQCvnQ.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图5 —基本雇员表(由作者提供)</p></figure><p id="6e9a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">该表与带有PersID列的sales表有关系，以构建下图所示的基本数据模型:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nm"><img src="../Images/9ac1ebbd77fcee22d9cbacebcf7d869a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z9WG0GEZBkKARuwCU5Uolg.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图6 —数据模型(由作者提供)</p></figure><p id="0446" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">当我们希望确保背面不被更改时，当维度表中的数据发生更改时，例如，通过部门的更改，我们必须更改雇员表:</p><ol class=""><li id="3e17" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn nn mz na nb bi translated">每个雇员可以有多个具有相同PersID的行，因此我们需要一个技术键列作为代理键(SurrID)。每一行都有自己的代理键，而PersID是业务键</li><li id="07de" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn nn mz na nb bi translated">我们必须将经理的PersID映射到代理键</li><li id="6eb1" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn nn mz na nb bi translated">我们必须记录数据的有效性。为此，我们必须添加两个新列:<br/> a. ValidFrom:每一行有效的开始日期<br/> b. ValidTo:每一行有效的结束日期<br/>通常，ValidTo列包含一个遥远未来的虚拟日期，例如31.12.2199</li></ol><p id="0af6" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">9月1日，我们的组织发生了上述变化。</p><p id="a271" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我要做的是:</p><ol class=""><li id="1d88" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn nn mz na nb bi translated">关闭行:将ValidTo列设置为31.08.2022</li><li id="6a7b" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn nn mz na nb bi translated">添加生效日期为01.09.2022的新行</li><li id="a69e" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn nn mz na nb bi translated">将添加的行的ValidTo列设置为31.12，2199</li></ol><p id="b5a1" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">最后一步是将管理器映射到代理键。</p><p id="5e3d" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在我的Azure SQL数据库上，我使用以下SQL查询完成了这项工作:</p><pre class="kk kl km kn gt no np nq nr aw ns bi"><span id="45c4" class="nt lb it np b gy nu nv l nw nx">SELECT [E].[SurrID]<br/>        ,[E].[PersID]<br/>        ,[E].[Name]<br/>        ,[E].[Email]<br/>        ,[E].[Position]<br/>        ,[E].[ManagerID]<br/>        ,[M].[SurrID] AS [Mgr_SurrID]<br/>        ,[E].[Department]<br/>        ,[E].[ValidFrom]<br/>        ,[E].[ValidTo]<br/>   FROM [dbo].[EMP_Hist_2] AS [E] → 18 Rows<br/>    LEFT OUTER JOIN [dbo].[EMP_Hist_2] AS [M]<br/>      ON [M].[PersID] = [E].[ManagerID]<br/>      AND [E].[ValidFrom] BETWEEN [M].[ValidFrom] AND [M].[ValidTo];</span></pre><p id="f77f" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">您可以看到，我必须考虑每一行的有效性，以获得正确的映射。</p><p id="399e" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">经过这些更改后，雇员表如下所示:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi ny"><img src="../Images/a5d497f5732177c87a6398fe814ad6e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YqcgypILShgm7PsXqe2gbA.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图7 —修改后的雇员表(由作者提供)</p></figure><p id="77de" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">这种方法称为渐变维度类型2 (SCD2)。</p><p id="c9ac" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">SCD Type 1覆盖了所有属性，这就是我在更改维度表之前向您展示的内容。</p><p id="20bb" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">当数据发生变化时，SCD类型2生成一个新行。每一行都有描述有效性的列(ValidFrom和ValidTo)。</p><p id="a13f" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">通常，您会将第一种和第二种类型结合起来:</p><ul class=""><li id="ce81" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn my mz na nb bi translated">对于可以被覆盖的所有列(属性),使用类型1，例如，邮件地址、电话号码和包含信息的所有属性，对于这些信息，旧值在更改后是无用的</li><li id="dcd3" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">您对所有属性使用Type 2，这可能会改变结果，如上所示</li></ul><p id="7da9" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">您可以在下面参考资料部分的第二个和第三个资源中找到关于这个主题的资源。</p><p id="409b" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">让我们看看我是如何在Power BI中实现这些变化的，以及结果如何。</p><h1 id="4ba7" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">在Power BI中实现</h1><p id="61a0" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">基本的数据模型没有改变。</p><p id="fd4d" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">但是现在，Sales表通过SurrID列与Employees表建立了关系。</p><p id="1a29" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">为了得到这个结果，我在我的Azure SQL数据库上使用了以下查询，根据Sales表中的日期匹配Employees表中的正确行:</p><pre class="kk kl km kn gt no np nq nr aw ns bi"><span id="6500" class="nt lb it np b gy nu nv l nw nx">SELECT [E].[SurrID]<br/>        ,[S].PersID<br/>        ,[S].[Date]<br/>        ,[S].[Amount]<br/>   FROM [dbo].[Sales] AS [S]<br/>      INNER JOIN [EMP_Hist_2] AS [E]<br/>         ON [E].[PersID] = [S].[PersID]<br/>   WHERE [S].[Date] BETWEEN [E].[ValidFrom] AND [E].[ValidTo];</span></pre><p id="101e" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">结果看起来像这样:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nz"><img src="../Images/bb7c0a037431dd5ed2287dfec134cb61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XNT1lWRcneJLe0cde_fLUw.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图8 —历史化员工表的结果(由作者提供)</p></figure><p id="103d" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">将此图中的值与上面图3中的值进行比较可以看出，2022年9月之前的值没有变化。但是从2022年9月开始，新的分配是活动的，销售被分配到新的部门。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi oa"><img src="../Images/ed49adc1572ac3cc829fab7d3ddcb9dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mLDAlvi4fwc1zcAb"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">拉兹万·苏驰在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="dc28" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">但是在处理历史化(SCD2)数据时，还有一个我们必须考虑的话题:历史化维度表的行级安全性。</p><h1 id="4996" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">使用SCD的行级安全性</h1><p id="0f7b" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">我们希望根据组织中每个成员的职位，根据他在组织结构中的位置，来限制对数据的访问。</p><p id="8989" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">例如:</p><ul class=""><li id="0671" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn my mz na nb bi translated">威廉会看到一切</li><li id="588c" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">马丁只能看到研究部门下属的数据</li><li id="b9e4" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">Jimmy只能看到他和他的职员Jordan的数据</li><li id="7cf3" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">乔丹只看到他的数据</li></ul><p id="70da" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">实现这一点；我们需要将父子结构分成单独的列。</p><p id="b446" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">当您查看下图时，您将看到从列路径开始的结果:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi ob"><img src="../Images/32699582a20dbaf300638075b9a3e346.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HRjyYp_dQevxgPWKdLN6fg.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图9 —具有扁平层次结构的表格(由作者绘制)</p></figure><p id="8d75" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我使用了下面“在DAX中扁平化父子层次结构”中引用的文章中描述的技术。<br/>那里的描述非常详尽，非常有帮助。</p><p id="f7b4" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我们将实现一个行级安全(RLS-)规则来实现访问控制。</p><p id="2973" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">首先，我们必须打开RLS对话:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi oc"><img src="../Images/58bc0880e3b95c1b3731b7d73fa0d0ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IhsnNvmPjaxRWvbQZECuLw.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图10 —设置RLS —打开对话(图由作者提供)</p></figure><p id="b61c" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">接下来，在对话中，我们必须添加一条新规则:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi od"><img src="../Images/d77522b18a4ac4d6263a6fde183fba62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6DmO-3qmh0dNY4Yy2jdtAA.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图11——设置RLS——创建一个新规则(由作者提供)</p></figure><p id="3fbf" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">单击Create按钮，输入新规则的名称。接下来，单击要创建新规则的表，并在表名右侧的区域中输入新的表达式。</p><p id="3a3e" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我们想要创建一个规则来检查当前用户的电子邮件地址，并将其与Path列中的id列表进行比较。<br/>我们可以通过这种方法满足上述要求。</p><p id="0c51" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">所需的DAX表达式如下:</p><pre class="kk kl km kn gt no np nq nr aw ns bi"><span id="c24f" class="nt lb it np b gy nu nv l nw nx">PATHCONTAINS(<br/>    Employees[Path],<br/>      LOOKUPVALUE(‘Employees’[PersID]<br/>              ,’Employees’[Email]<br/>              ,USERPRINCIPALNAME()<br/>              )<br/>      )</span></pre><p id="e89b" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">让我们从里到外分析一下这个表达式:</p><ol class=""><li id="645b" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn nn mz na nb bi translated">函数的作用是:获取当前用户的用户名(电子邮件地址)</li><li id="5877" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn nn mz na nb bi translated"><a class="ae kz" href="https://dax.guide/lookupvalue/" rel="noopener ugc nofollow" target="_blank"> LOOKUPVALUE() </a>函数获取这个电子邮件地址的用户的PersID</li><li id="713f" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn nn mz na nb bi translated"><a class="ae kz" href="https://dax.guide/pathcontains/" rel="noopener ugc nofollow" target="_blank"> PATHCONTAINS() </a>函数在Employee表中搜索路径列中包含当前用户PersID的所有行</li></ol><p id="7ef7" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">单击保存按钮保存该表达式。</p><p id="f2cc" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">现在，我们可以测试这条规则:</p><ol class=""><li id="9e59" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn nn mz na nb bi translated">我点击建模功能区中的查看按钮</li><li id="3b39" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn nn mz na nb bi translated">我选择要测试的规则，并勾选“<em class="oe">其他用户”</em>复选框</li><li id="b1c0" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn nn mz na nb bi translated">我输入了马丁的邮件地址:<a class="ae kz" href="mailto:martin@mycorp.com" rel="noopener ugc nofollow" target="_blank">martin@mycorp.com</a></li></ol><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi of"><img src="../Images/db6765f7d2b23cda65efd04c59086b17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1048/format:webp/1*oEdCtYBLEc4WEy8HJ3CSmw.png"/></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图12——设置RLS——测试规则(图由作者提供)</p></figure><p id="29a3" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">现在，我们只看到马丁的数据:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi og"><img src="../Images/e8cf8d024ae41112ea6e887305c7cc2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AYDFpiJAR-Rwrb6UceN91w.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图13 —设置RLS —查看结果(图由作者提供)</p></figure><p id="58d0" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">直到我们在历史化的雇员表中引入变化，这才完美地工作。</p><p id="5e81" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">当我们用历史化的表尝试(由于表名的变化而稍作修改)DAX表达式时，我们得到一个错误:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/e54727713c3bfcdf0bc6250ed16a9177.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*iPXDKv1pdxfG7CMU25Q0Nw.png"/></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图14 —历史数据的RLS误差(作者提供的图)</p></figure><p id="343b" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">这个错误只出现在用一个用户测试我们的RLS规则时，这个规则会随着时间而改变，比如Thomas。</p><p id="3be2" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">为了纠正这一点，我们必须创建一个全新的RLS表达式。</p><p id="d5cd" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在向您展示新的DAX表达式之前，我必须讨论解决问题需要什么。</p><p id="1cb4" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">当计算结果时，我们可以想象使用当前的过滤器上下文对结果中的每个数字评估RLS规则。</p><p id="8bb8" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">请看托马斯的下图:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi oi"><img src="../Images/aba525e4dd9b402d4f6a20e8d5b9b765.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Avd92fVsASWpI5aG1joGgw.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图15—Thomas使用正确RLS规则的结果(由作者提供)</p></figure><p id="4e58" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">当我们查看2022年11月的结果时，我们可以想象引擎执行以下步骤:</p><ol class=""><li id="eb84" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn nn mz na nb bi translated">评估过滤器上下文:2022年11月</li><li id="f131" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn nn mz na nb bi translated">考虑筛选器上下文，添加RLS规则中的表达式</li><li id="da8e" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn nn mz na nb bi translated">仅对托马斯计算2022年11月的结果</li></ol><p id="698c" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">因为我们知道结果将在哪个日期计算(30。2022年11月)，考虑到ValidTo和ValidFrom列，我们必须获得Thomas的正确行。</p><p id="ac0a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">使用这种方法，我们将只收到每个日期的一行。</p><p id="40c6" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">为此，我们需要一个如下所示的DAX表达式:</p><pre class="kk kl km kn gt no np nq nr aw ns bi"><span id="e377" class="nt lb it np b gy nu nv l nw nx">VAR ActDate = MAX(‘Date’[Date])</span><span id="e9ae" class="nt lb it np b gy oj nv l nw nx">RETURN<br/>  PATHCONTAINS(<br/>    ‘Employees_Hist’[Path],<br/>      CONCATENATEX(<br/>        FILTER(<br/>          SUMMARIZE(ALL(‘Employees_Hist’)<br/>                      ,’Employees_Hist’[SurrID]<br/>                      ,’Employees_Hist’[ValidFrom]<br/>                      ,’Employees_Hist’[ValidTo]<br/>                      ,’Employees_Hist’[Email]<br/>                     )<br/>            ,[ValidFrom] &lt;= ActDate &amp;&amp;<br/>                [ValidTo] &gt;= ActDate &amp;&amp;<br/>                [Email] = USERPRINCIPALNAME()<br/>           )<br/>           ,’Employees_Hist’[SurrID]<br/>      )<br/>)</span></pre><p id="e0b2" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">以下是DAX表达式的解释:</p><ol class=""><li id="ffac" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn nn mz na nb bi translated">我用当前过滤器上下文中的最新日期(ActDate)创建了一个变量</li><li id="4838" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn nn mz na nb bi translated">我使用<a class="ae kz" href="https://dax.guide/summarize/" rel="noopener ugc nofollow" target="_blank">summary()</a>来获得所有雇员的列表，列有SurrID、ValidFrom、ValidTo和Email <br/>我使用ALL(Employee_Hist)来删除这个表上的实际过滤器</li><li id="b5aa" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn nn mz na nb bi translated">这个函数包含在一个<a class="ae kz" href="https://dax.guide/filter/" rel="noopener ugc nofollow" target="_blank"> FILTER() </a>函数中，用来限制行，只获取活动的行([valid from]&lt;= act date&amp;&amp;【valid to】&gt;= act date)和那些带有当前用户电子邮件地址的行([Email]=<a class="ae kz" href="https://dax.guide/userprincipalname/" rel="noopener ugc nofollow" target="_blank">USERPRINCIPALNAME()</a>)</li><li id="de3c" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn nn mz na nb bi translated"><a class="ae kz" href="https://dax.guide/concatenatex/" rel="noopener ugc nofollow" target="_blank"> CONCATENATEX() </a>使用FILTER()的结果作为输入来获得正确的SurrID</li><li id="b761" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn nn mz na nb bi translated">CONCATENATEX)的结果被传递给<a class="ae kz" href="https://dax.guide/pathcontains/" rel="noopener ugc nofollow" target="_blank"> PATHCONTAINS() </a>函数，以检查Employee_Hist表中在Path列中具有匹配SurrID的行</li></ol><p id="3da1" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">但是为什么我需要使用这个CONCATENATEX(…)的东西呢？</p><p id="c388" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我需要它，因为PATHCONTAINS()请求一个值作为第二个参数。而且，因为FILTER()返回一个表，所以我必须聚合结果。</p><p id="c83f" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">为此，我使用CONCATENATEX()。</p><p id="c735" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我也可以使用SUMX、MAXX或MINXX。</p><p id="a63d" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">因为过滤函数总是返回单个值，所以这无关紧要。</p><p id="2924" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">但是当我创建一个计算列来验证结果时，CONCATENATEX()在表达式的开发过程中非常有用。<br/>我可以在使用FILTER()找到正确的解决方案之前检查结果。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi ok"><img src="../Images/adcddb41fe170be683de4be451aaa860.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_PmuvcsSGot-VVGY"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">由<a class="ae kz" href="https://unsplash.com/@markusspiske?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">马库斯·斯皮斯克</a>在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="c9c9" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">结论</h1><p id="7190" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">历史化的表格给我们的数据模型带来了新的复杂性。</p><p id="4676" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">但是，只要在数据源中相应地准备好数据，Power BI中的数据模型仍然很简单。</p><p id="f0f2" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">但是，在使用RLS时，您需要考虑历史化表中行的有效性，以获得正确的结果。</p><p id="66a8" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">可能还有其他需要增加更多复杂性的场景。例如，当其中一个员工发生了变化，但他的下属没有发生变化时，未变化的行将映射到哪个维度行？原版的还是新的？您是否也需要为下属创建一个新行？</p><p id="1234" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">您必须检查您的数据和可能的场景，以决定是否需要增加所需的复杂程度。</p><p id="63be" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">最初，我计划只写关于RLS主题的这篇文章。但是我意识到我需要先解释一下历史化的原理，以免混淆，以防你不知道我们为什么需要这个概念。</p><p id="cfb1" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我希望您能在下面参考资料的帮助下，将我的示例转化为您的用例以及您的数据平台。</p><p id="480f" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">谢谢你陪我到最后。</p><h1 id="b1b5" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">参考</h1><p id="aade" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">我用随机数据和虚构的名字创建了这里显示的数据集。</p><p id="7ffc" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">设计和构建数据仓库的最佳书籍是由<a class="ae kz" href="https://www.kimballgroup.com/" rel="noopener ugc nofollow" target="_blank"> Kimball Group |维度数据仓库专家</a>撰写的<a class="ae kz" href="https://www.kimballgroup.com/data-warehouse-business-intelligence-resources/books/data-warehouse-dw-toolkit/" rel="noopener ugc nofollow" target="_blank">数据仓库工具包，第三版— Kimball Group </a>。</p><p id="9434" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在SQL Server中使用时态表实现SCD2: <a class="ae kz" href="https://www.zartis.com/scd-implementation-with-temporal-tables-in-power-bi/" rel="noopener ugc nofollow" target="_blank">在Power BI-zart is中使用时态表实现SCD2】。</a></p><p id="4853" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">深入探讨不同级别的SCD: <a class="ae kz" href="https://www.sqlshack.com/implementing-slowly-changing-dimensions-scds-in-data-warehouses/" rel="noopener ugc nofollow" target="_blank">在数据仓库中实施渐变维度(SCD)(sqlshack.com)</a></p><p id="64bf" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">如何在关系数据库中实现SCD2的描述:【DWgeek.com】设计SQL中缓变维度类型2</p><p id="c8bb" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><a class="ae kz" href="https://medium.com/analytics-vidhya/scd-type2-implementation-in-python-95bb08878ce2" rel="noopener">用Python实现SCD Type2作者Vivek chaud hary | Analytics vid hya | Medium</a></p><p id="0b81" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">你可以通过互联网搜索找到更多关于SCD和你的数据平台的资源。</p><p id="0d58" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在DAX中展平父子层次结构:</p><ul class=""><li id="991f" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn my mz na nb bi translated"><a class="ae kz" href="https://docs.microsoft.com/en-us/dax/understanding-functions-for-parent-child-hierarchies-in-dax" rel="noopener ugc nofollow" target="_blank">了解DAX中父子层次结构的函数— DAX | Microsoft Docs </a></li><li id="4060" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated"><a class="ae kz" href="https://docs.microsoft.com/en-us/dax/pathitem-function-dax" rel="noopener ugc nofollow" target="_blank">路径项函数(DAX) — DAX |微软文档</a></li><li id="e455" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated"><a class="ae kz" href="https://simplebiinsights.com/parent-child-hierarchies-in-dax/" rel="noopener ugc nofollow" target="_blank">Power BI—DAX中的父子层次结构—简单BI洞察</a></li><li id="f5d2" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated"><a class="ae kz" href="https://www.daxpatterns.com/parent-child-hierarchies/" rel="noopener ugc nofollow" target="_blank">父子层次结构— DAX模式</a></li></ul><p id="d7bd" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">用父子结构实现动态RLS:<a class="ae kz" href="https://urldefense.proofpoint.com/v2/url?u=https-3A__community.powerbi.com_t5_Desktop_dynamic-2DRLS_m-2Dp_1219642&amp;d=DwMFAg&amp;c=eIGjsITfXP_y-DLLX0uEHXJvU8nOHrUK8IrwNKOtkVU&amp;r=ZqPxQ-KsPgtWk7-5IsCGGjWC4rFt4Of6e_QaPwMyJ8uHsqW5Nl18C5H3JDxMLHOq&amp;m=rjcYcKP8S9KjM6XA4tRZ80LUGRqesZZH6ALgLp3U96gzkoTiG5cnsiUqQ15QfGNF&amp;s=rEisI1k6Us22xoY9_GdTZUbcB7lTjqckBXuWgfLeGtw&amp;e=" rel="noopener ugc nofollow" target="_blank">已解决:动态RLS —微软Power BI社区</a>。</p><div class="ol om gp gr on oo"><a href="https://medium.com/@salvatorecagliari/membership" rel="noopener follow" target="_blank"><div class="op ab fo"><div class="oq ab or cl cj os"><h2 class="bd iu gy z fp ot fr fs ou fu fw is bi translated">通过我的推荐链接加入Medium-Salvatore Cagliari</h2><div class="ov l"><h3 class="bd b gy z fp ot fr fs ou fu fw dk translated">阅读萨尔瓦托勒·卡利亚里的每一个故事(以及媒体上成千上万的其他作家)。您的会员费直接…</h3></div><div class="ow l"><p class="bd b dl z fp ot fr fs ou fu fw dk translated">medium.com</p></div></div><div class="ox l"><div class="oy l oz pa pb ox pc kt oo"/></div></div></a></div></div></div>    
</body>
</html>