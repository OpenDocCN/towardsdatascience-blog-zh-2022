<html>
<head>
<title>Goodbye Scatterplot, Welcome Binned Scatterplot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">再见散点图，欢迎入库散点图</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/goodbye-scatterplot-welcome-binned-scatterplot-a928f67413e4#2022-05-09">https://towardsdatascience.com/goodbye-scatterplot-welcome-binned-scatterplot-a928f67413e4#2022-05-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="35d8" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/causal-data-science" rel="noopener" target="_blank">因果数据科学</a></h2><div class=""/><div class=""><h2 id="7787" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">如何可视化并对条件手段进行推理</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/8c65822aa9889e0bc567fb75e2789fa4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j4kdPN6CzoPe0Wv9lzoxUg.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">作者图片</p></figure><p id="803b" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">当我们想要可视化两个连续变量之间的关系时，定位图就是<strong class="lg ja">散点图</strong>。这是一个非常直观的可视化工具，允许我们直接查看数据，无需任何操作。然而，当我们有大量数据和/或数据有偏差时，散点图可能噪声太大，无法提供信息。</p><p id="d0fb" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">在这篇博文中，我将回顾散点图的一个非常强大的替代方案，来可视化两个变量之间的相关性:装箱散点图。装箱散点图不仅是一个很好的可视化工具，而且还可以用来对条件均值进行推断，等等。</p><h1 id="88cd" class="ma mb iq bd mc md me mf mg mh mi mj mk kf ml kg mm ki mn kj mo kl mp km mq mr bi translated">散点图</h1><p id="0674" class="pw-post-body-paragraph le lf iq lg b lh ms ka lj lk mt kd lm ln mu lp lq lr mv lt lu lv mw lx ly lz ij bi translated">先说个例子。假设我们是一个网上市场，多家公司提供商品，消费者可以有效地浏览、比较和购买。我们的数据集包含了活跃在市场上的公司的快照。</p><p id="15d7" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">让我们加载数据并查看一下。你可以在这里找到数据生成过程<code class="fe mx my mz na b">dgp_marketplace</code> <a class="ae nb" href="https://github.com/matteocourthoud/Blog-Posts/blob/main/notebooks/src/dgp.py" rel="noopener ugc nofollow" target="_blank">的代码。我还从<code class="fe mx my mz na b"><a class="ae nb" href="https://github.com/matteocourthoud/Blog-Posts/blob/main/notebooks/src/utils.py" rel="noopener ugc nofollow" target="_blank">utils</a></code>导入了一些代码来制作更好的图形。</a></p><pre class="kp kq kr ks gt nc na nd ne aw nf bi"><span id="70ff" class="ng mb iq na b gy nh ni l nj nk">from src.utils import *<br/>from src.dgp import dgp_marketplace<br/><br/>df = dgp_marketplace().generate_data(N=10_000)<br/>df.head()</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="ab gu cl nl"><img src="../Images/5c0e2aad64a8a4ff4937b0ebbdeae340.png" data-original-src="https://miro.medium.com/v2/format:webp/1*HzRZHh36Y3QLBU_TAIA8zQ.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">作者图片</p></figure><p id="c122" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">我们有10000家公司的信息。对于我们知道的每个公司:</p><ul class=""><li id="9640" class="nm nn iq lg b lh li lk ll ln no lr np lv nq lz nr ns nt nu bi translated"><code class="fe mx my mz na b">age</code>:公司的时代</li><li id="f16a" class="nm nn iq lg b lh nv lk nw ln nx lr ny lv nz lz nr ns nt nu bi translated"><code class="fe mx my mz na b">sales</code>:上月的月销售额</li><li id="5028" class="nm nn iq lg b lh nv lk nw ln nx lr ny lv nz lz nr ns nt nu bi translated"><code class="fe mx my mz na b">online</code>:公司是否只在网上活动</li><li id="84bc" class="nm nn iq lg b lh nv lk nw ln nx lr ny lv nz lz nr ns nt nu bi translated"><code class="fe mx my mz na b">products</code>:公司提供的产品数量</li></ul><p id="21bd" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">假设我们有兴趣了解<code class="fe mx my mz na b">age</code>和<code class="fe mx my mz na b">sales</code>之间的关系。销售的生命周期是什么？</p><p id="f21d" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">让我们从一个简单的<code class="fe mx my mz na b">sales</code>对<code class="fe mx my mz na b">age</code>的<strong class="lg ja">散点图</strong>开始。</p><pre class="kp kq kr ks gt nc na nd ne aw nf bi"><span id="e155" class="ng mb iq na b gy nh ni l nj nk">sns.scatterplot(x='age', y='sales', data=df);<br/>plt.title("Sales by firm's age");</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="ab gu cl nl"><img src="../Images/29aa3d065c152e899266f792f1da573b.png" data-original-src="https://miro.medium.com/v2/format:webp/1*3fAmGHZt-gAYuVHX4pe1Rg.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">作者图片</p></figure><p id="fb4c" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">剧情极其<strong class="lg ja">吵</strong>。我们有许多观察结果，因此，很难将它们全部形象化。如果我们必须猜测，我们可以说这种关系看起来是负的(<code class="fe mx my mz na b">sales</code>随<code class="fe mx my mz na b">age</code>减少)，但这将是一个非常无知的猜测。</p><p id="ba11" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">我们现在要探索一些合理的调整和替代方案。</p><h1 id="3c64" class="ma mb iq bd mc md me mf mg mh mi mj mk kf ml kg mm ki mn kj mo kl mp km mq mr bi translated">散点图备选方案</h1><p id="0465" class="pw-post-body-paragraph le lf iq lg b lh ms ka lj lk mt kd lm ln mu lp lq lr mv lt lu lv mw lx ly lz ij bi translated">当我们有一个非常密集的散点图时，我们能做什么？一种解决方案是绘制观测值的密度图，而不是观测值本身。</p><p id="68a0" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">Python中有多种解决方案来可视化二维分布的密度。很有用的一个就是<a class="ae nb" href="https://seaborn.pydata.org/" rel="noopener ugc nofollow" target="_blank">seaborn</a>T15】joint plot。<code class="fe mx my mz na b">jointplot</code>绘制两个变量的联合分布，以及沿轴的边际分布。默认选项是散点图，但也可以选择添加回归线(<code class="fe mx my mz na b">reg</code>)，将图更改为直方图(<code class="fe mx my mz na b">hist</code>)，六边形图(<code class="fe mx my mz na b">hex</code>)，或<a class="ae nb" href="https://en.wikipedia.org/wiki/Kernel_density_estimation" rel="noopener ugc nofollow" target="_blank">核密度估计值</a> ( <code class="fe mx my mz na b">kde</code>)。</p><p id="9cec" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">让我们试试<strong class="lg ja"> hexplot </strong>，它基本上是数据的直方图，其中的条柱是二维空间中的六边形。</p><pre class="kp kq kr ks gt nc na nd ne aw nf bi"><span id="1df9" class="ng mb iq na b gy nh ni l nj nk">s = sns.jointplot(x='age', y='sales', data=df, kind='hex', );<br/>s.ax_joint.grid(False);<br/>s.ax_marg_y.grid(False);<br/>s.fig.suptitle("Sales by firm's age");</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="ab gu cl nl"><img src="../Images/86ddf8ce64ddc476729994ac5916e693.png" data-original-src="https://miro.medium.com/v2/format:webp/1*nH9_fsbk1SpmLdWrbW8WEQ.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">作者图片</p></figure><p id="4a03" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">没什么变化。看起来<code class="fe mx my mz na b">age</code>和<code class="fe mx my mz na b">sales</code>的分布都非常<strong class="lg ja">偏斜</strong>，因此，大部分动作都集中在非常小的子空间中。</p><p id="db65" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">也许我们可以移除<strong class="lg ja">异常值</strong>并放大大部分数据所在的区域。让我们放大左下角，有<code class="fe mx my mz na b">age &lt; 3</code>和<code class="fe mx my mz na b">sales &lt; 3000</code>的观察。</p><pre class="kp kq kr ks gt nc na nd ne aw nf bi"><span id="05d8" class="ng mb iq na b gy nh ni l nj nk">s = sns.jointplot(x='age', y='sales', data=df.query("age &lt; 3 &amp; sales &lt; 3000"), kind="hex");<br/>s.ax_joint.grid(False);<br/>s.ax_marg_y.grid(False);<br/>s.fig.suptitle("Sales by firm's age");</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="ab gu cl nl"><img src="../Images/898a54cde4d4952483586b9906f749cf.png" data-original-src="https://miro.medium.com/v2/format:webp/1*p27fUjrmpaNXS2KFIvD1ow.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">作者图片</p></figure><p id="4a86" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">现在空地少了很多，但看起来我们并没有走远。关节分布<strong class="lg ja">还是太偏</strong>。当数据遵循某种幂分布时就是这种情况，业务数据通常就是这种情况。</p><p id="0483" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">一种解决方案是通过取<a class="ae nb" href="https://en.wikipedia.org/wiki/Natural_logarithm" rel="noopener ugc nofollow" target="_blank"><strong class="lg ja"/></a><strong class="lg ja">转换</strong>变量。</p><pre class="kp kq kr ks gt nc na nd ne aw nf bi"><span id="9cc5" class="ng mb iq na b gy nh ni l nj nk">df['log_age'] = np.log(df['age'])<br/>df['log_sales'] = np.log(df['sales'])</span></pre><p id="97a3" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">我们现在可以画出<code class="fe mx my mz na b">age</code>和<code class="fe mx my mz na b">sales</code>的对数之间的关系。</p><pre class="kp kq kr ks gt nc na nd ne aw nf bi"><span id="a566" class="ng mb iq na b gy nh ni l nj nk">s = sns.jointplot(x='log_age', y='log_sales', data=df, kind='hex');<br/>s.ax_joint.grid(False);<br/>s.ax_marg_y.grid(False);<br/>s.fig.suptitle("Sales by firm's age", y=1.02);</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="ab gu cl nl"><img src="../Images/8d7d7d36b8513fc9659ba216876eb8ed.png" data-original-src="https://miro.medium.com/v2/format:webp/1*P5ga1CKs0vO7XYINJcS1UQ.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">作者图片</p></figure><p id="fcec" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">对数绝对有帮助。现在，数据在空间上更加分散，这意味着可视化提供了更多信息。此外，看起来这两个变量之间没有关系。</p><p id="22c0" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">不过还是有<strong class="lg ja">噪音太大</strong>。也许光靠数据可视化不足以得出结论。</p><p id="8fe3" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">让我们换一种更结构化的方法:<a class="ae nb" href="https://en.wikipedia.org/wiki/Linear_regression" rel="noopener ugc nofollow" target="_blank"> <strong class="lg ja">线性回归</strong> </a>。让我们在<code class="fe mx my mz na b">log_age</code>上线性回归<code class="fe mx my mz na b">log_sales</code>。</p><pre class="kp kq kr ks gt nc na nd ne aw nf bi"><span id="bb16" class="ng mb iq na b gy nh ni l nj nk">smf.ols('log_sales ~ log_age', df).fit().summary().tables[1]</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oa"><img src="../Images/74666fd90a95b25d735bd5363e3072ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EXXSjL_ah3c5YFC9btvlqQ.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">作者图片</p></figure><p id="ab3d" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated"><code class="fe mx my mz na b">log_age</code>的回归系数为<strong class="lg ja">正</strong>且具有统计显著性(即不同于零)。似乎所有以前的想象都非常误导。从上面的图表中，我们没有一个能猜到如此强的正相关关系。</p><p id="dd11" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">然而，也许这种关系对于<code class="fe mx my mz na b">online</code>-仅仅是公司和样本中的其他公司是不同的。我们需要控制这个变量，以避免<a class="ae nb" href="https://en.wikipedia.org/wiki/Simpson's_paradox" rel="noopener ugc nofollow" target="_blank">辛普森悖论</a>以及更普遍的偏见。</p><p id="97b5" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">通过线性回归，我们可以<strong class="lg ja">对协变量</strong>进行条件分析。让我们添加二进制指标为<code class="fe mx my mz na b">online</code>-只有公司和变量计数的数量<code class="fe mx my mz na b">products</code>回归。</p><pre class="kp kq kr ks gt nc na nd ne aw nf bi"><span id="774a" class="ng mb iq na b gy nh ni l nj nk">smf.ols('log_sales ~ log_age + online + products', df).fit().summary().tables[1]</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ob"><img src="../Images/914a210deb44eecf361f1c3f3449bb85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4LtGbzoaoEYRoDzw-Q-7EQ.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">作者图片</p></figure><p id="a588" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated"><code class="fe mx my mz na b">log_age</code>的系数仍然是正的，并且在统计上是显著的，但是它的<strong class="lg ja">大小</strong>已经减半。</p><p id="30bc" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">我们应该得出什么结论？平均来说，似乎随着年龄的增长而增加。然而，这种模式可能是非常非线性的。</p><p id="f7cf" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">在线性回归框架内，一种方法可以是<strong class="lg ja">添加额外的项</strong>，例如多项式(<code class="fe mx my mz na b">age^2</code>)或分类特征(例如<code class="fe mx my mz na b">age &lt; 2</code>)。然而，如果有一种更灵活的方法可以告诉我们公司<code class="fe mx my mz na b">age</code>和<code class="fe mx my mz na b">sales</code>之间的关系，那就太棒了。</p><p id="289b" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">要是……</p><h1 id="531f" class="ma mb iq bd mc md me mf mg mh mi mj mk kf ml kg mm ki mn kj mo kl mp km mq mr bi translated">装箱散点图</h1><p id="4e3b" class="pw-post-body-paragraph le lf iq lg b lh ms ka lj lk mt kd lm ln mu lp lq lr mv lt lu lv mw lx ly lz ij bi translated"><strong class="lg ja">装箱散点图</strong>是一个非常强大的工具，它提供了一种<strong class="lg ja">灵活</strong>和<strong class="lg ja">简约</strong>的方式来可视化和总结大型数据集中的条件均值(不仅仅是)。</p><p id="7c3b" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">面元散点图背后的<strong class="lg ja">思想</strong>是将条件变量<code class="fe mx my mz na b">age</code>分成<strong class="lg ja">个大小相等的面元或分位数</strong>，然后在每个面元内绘制因变量<code class="fe mx my mz na b">sales</code>的条件均值。</p><h2 id="3ea3" class="ng mb iq bd mc oc od dn mg oe of dp mk ln og oh mm lr oi oj mo lv ok ol mq iw bi translated">细节</h2><p id="435a" class="pw-post-body-paragraph le lf iq lg b lh ms ka lj lk mt kd lm ln mu lp lq lr mv lt lu lv mw lx ly lz ij bi translated"><a class="ae nb" href="https://arxiv.org/abs/1902.09608" rel="noopener ugc nofollow" target="_blank"> Cattaneo，Crump，Farrell，Feng (2021) </a>在R，<a class="ae nb" href="https://cran.r-project.org/web/packages/binsreg/index.html" rel="noopener ugc nofollow" target="_blank"> binsreg </a>中构建了一个非常好的分箱散点图包。而且，他们已经把包移植到Python上了。我们可以使用<code class="fe mx my mz na b">pip install binsreg</code>直接从pip安装<code class="fe mx my mz na b">binsreg</code>。你可以在这里找到关于Python包<a class="ae nb" href="https://pypi.org/project/binsreg/" rel="noopener ugc nofollow" target="_blank">的更多信息，而原始和详细的R包文档可以在这里</a>找到<a class="ae nb" href="https://www.rdocumentation.org/packages/binsreg/versions/0.7/topics/binsreg" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="9009" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">构建面元散点图时最重要的选择是<strong class="lg ja">面元数量</strong>。这个权衡就是通常的<a class="ae nb" href="https://en.wikipedia.org/wiki/Bias%E2%80%93variance_tradeoff" rel="noopener ugc nofollow" target="_blank"> <strong class="lg ja">偏差-方差权衡</strong> </a>。通过选择更多数量的箱，我们在图中有更多的点。在极端情况下，我们最终得到一个标准的<strong class="lg ja">散点图</strong>(假设条件变量是连续的)。另一方面，通过减少箱的数量，情节将更加稳定。然而，在极端情况下，我们将有一个代表样本平均值的单点<strong class="lg ja">。</strong></p><p id="3540" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated"><a class="ae nb" href="https://arxiv.org/abs/1902.09608" rel="noopener ugc nofollow" target="_blank"> Cattaneo，Crump，Farrell，Feng (2021) </a>证明，在基本分格散点图中，最小化均方误差的分格数与<em class="om">、</em>成正比，其中<em class="om"> n </em>为观察次数。因此，一般来说，更多的观察导致更多的箱。</p><p id="cbe5" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated"><a class="ae nb" href="https://onlinelibrary.wiley.com/doi/abs/10.1002/smj.3199" rel="noopener ugc nofollow" target="_blank">斯塔尔和戈德法布(2020) </a>增加以下考虑因素:</p><blockquote class="on oo op"><p id="c3c1" class="le lf om lg b lh li ka lj lk ll kd lm oq lo lp lq or ls lt lu os lw lx ly lz ij bi translated"><em class="iq"/>然而其他元素也很重要。例如，保持x的分布不变，x和y之间的真实关系曲线越多，算法将选择越多的箱(否则均方误差将增加)。这意味着即使有大的n，也将为相对平坦的关系选择很少的箱。因此，计算基本分箱散点图中的最佳箱数时，考虑了可用于识别x和y之间关系的数据的变化量和位置。”</p></blockquote><p id="1ca8" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">强烈建议使用默认的最佳箱数。然而，用户也可以使用<code class="fe mx my mz na b">nbins</code>选项通过<code class="fe mx my mz na b">binsreg</code>设置定制的箱数。</p><p id="890a" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">然而，分格散点图不仅仅计算最优选择区间的条件均值，还可以为这些均值提供<strong class="lg ja">推断</strong>。特别是，我们可以围绕每个数据点建立<strong class="lg ja">置信区间</strong>。在<code class="fe mx my mz na b">binsreg</code>包中，选项<code class="fe mx my mz na b">ci</code>将置信区间添加到估计结果中。该选项将一组参数<code class="fe mx my mz na b">(p, s)</code>作为输入，并使用带有<code class="fe mx my mz na b">s</code>平滑度约束的<code class="fe mx my mz na b">p</code>次分段多项式来构建置信区间。默认情况下，置信区间不包含在图中。关于<code class="fe mx my mz na b">p</code>和<code class="fe mx my mz na b">s</code>的选择，<a class="ae nb" href="https://www.rdocumentation.org/packages/binsreg/versions/0.7/topics/binsreg" rel="noopener ugc nofollow" target="_blank">包文档</a>报告:</p><blockquote class="on oo op"><p id="5a39" class="le lf om lg b lh li ka lj lk ll kd lm oq lo lp lq or ls lt lu os lw lx ly lz ij bi translated"><em class="iq"> " </em>推荐的规格是<code class="fe mx my mz na b">ci=c(3,3)</code>，它将基于感兴趣的回归函数的三次B样条估计的置信区间添加到装箱散点图中。"</p></blockquote><h2 id="f19b" class="ng mb iq bd mc oc od dn mg oe of dp mk ln og oh mm lr oi oj mo lv ok ol mq iw bi translated">宾斯雷格</h2><p id="9bdc" class="pw-post-body-paragraph le lf iq lg b lh ms ka lj lk mt kd lm ln mu lp lq lr mv lt lu lv mw lx ly lz ij bi translated">这个包的Python版本的一个问题是它不太像Python。因此，我将<code class="fe mx my mz na b">binsreg</code>包包装到一个函数<code class="fe mx my mz na b">binscatter</code>中，该函数负责清理和格式化可读性良好的<a class="ae nb" href="https://pandas.pydata.org/" rel="noopener ugc nofollow" target="_blank"> Pandas </a> DataFrame中的输出。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ot ou l"/></div></figure><p id="7725" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">我们现在可以进行<strong class="lg ja">估计</strong>和<strong class="lg ja">可视化</strong>基于<code class="fe mx my mz na b">sales</code>的<code class="fe mx my mz na b">age</code>的分级散点图。</p><pre class="kp kq kr ks gt nc na nd ne aw nf bi"><span id="6c5e" class="ng mb iq na b gy nh ni l nj nk"># Estimate binsreg<br/>df_est = binscatter(x='age', y='sales', data=df, ci=(3,3))<br/>df_est.head()</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="ab gu cl nl"><img src="../Images/c2f6292061b5d793265bae96a682c8a1.png" data-original-src="https://miro.medium.com/v2/format:webp/1*F60F_XMXvJMLoyKP6GSVGg.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">作者图片</p></figure><p id="003c" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated"><code class="fe mx my mz na b">binscatter</code>函数输出一个数据集，其中，对于条件变量<code class="fe mx my mz na b">age</code>的每个箱，我们有结果变量<code class="fe mx my mz na b">sales</code>的值和置信区间。</p><p id="97a4" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">我们现在可以画出估计值。</p><pre class="kp kq kr ks gt nc na nd ne aw nf bi"><span id="2704" class="ng mb iq na b gy nh ni l nj nk"># Plot binned scatterplot<br/>sns.scatterplot(x='age', y='sales', data=df_est);<br/>plt.errorbar('age', 'sales', yerr='ci', data=df_est, ls='', lw=2, alpha=0.2);<br/>plt.title("Sales by firm's age");</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ov"><img src="../Images/901af386f813862a2debe1ee29be6b72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_aeDR2WMwoYsanXvwWpzSg.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">作者图片</p></figure><p id="d156" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">情节相当暴露。现在，这种关系看起来非常的<strong class="lg ja">非线性</strong>，在一个公司生命周期的开始<code class="fe mx my mz na b">sales</code>急剧增加，然后是一个平台期。</p><p id="281e" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">此外，该图还告诉我们关于<code class="fe mx my mz na b">age</code>和<code class="fe mx my mz na b">sales</code>分布的信息。其实左边的地块更密集，这里集中了<code class="fe mx my mz na b">age</code>的分布。此外，左边的置信区间更小，这里是大多数条件分布的所在地。</p><p id="a98d" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">正如我们在上一节已经讨论过的，控制其他变量可能很重要。例如，<code class="fe mx my mz na b">products</code>的数字，因为销售更多产品的公司可能在市场上生存得更久，并且也销售得更多。</p><p id="d7be" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">通过<code class="fe mx my mz na b">w</code>选项，<code class="fe mx my mz na b">binsreg</code>允许<strong class="lg ja">限制</strong>对任意数量变量的分析。</p><pre class="kp kq kr ks gt nc na nd ne aw nf bi"><span id="c104" class="ng mb iq na b gy nh ni l nj nk"># Estimate binsreg<br/>df_est = binscatter(x='age', y='sales', w=['products'], data=df, ci=(3,3))<br/><br/># Plot binned scatterplot<br/>sns.scatterplot(x='age', y='sales', data=df_est);<br/>plt.errorbar('age', 'sales', yerr='ci', data=df_est, ls='', lw=2, alpha=0.2);<br/>plt.title("Sales by firm's age");</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ov"><img src="../Images/a31e06106076656d94298da6cd2a19b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w1ipjVaUkvAhQ7wETK3WMQ.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">作者图片</p></figure><p id="d0b5" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">根据<code class="fe mx my mz na b">products</code>的数量，<code class="fe mx my mz na b">sales</code>生命周期的形状会进一步改变。现在，在最初的销售增长后，我们观察到随着时间的推移逐渐下降。</p><p id="9acc" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">相对于混合的线上-线下企业，只有<code class="fe mx my mz na b">online</code>企业有不同的<code class="fe mx my mz na b">sales</code>生命周期吗？我们可以使用选项<code class="fe mx my mz na b">by</code>按组生成不同的分级散点图<strong class="lg ja">。</strong></p><pre class="kp kq kr ks gt nc na nd ne aw nf bi"><span id="97dc" class="ng mb iq na b gy nh ni l nj nk"># Estimate binsreg<br/>df_est = binscatter(x='age', y='sales', by='online', w=['products'], data=df, ci=(3,3))<br/><br/># Plot binned scatterplot<br/>sns.scatterplot(x='age', y='sales', data=df_est, hue='online');<br/>plt.errorbar('age', 'sales', yerr='ci', data=df_est.query("online==0"), ls='', lw=2, alpha=0.2);<br/>plt.errorbar('age', 'sales', yerr='ci', data=df_est.query("online==1"), ls='', lw=2, alpha=0.2);<br/>plt.title("Sales by firm's age");</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ov"><img src="../Images/23ecb5b3ac1734205d1035ceaa6bbdff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8enoIljiSw8XP-yb2P_xQw.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">作者图片</p></figure><p id="d26e" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">从分箱散点图中，我们可以看到<code class="fe mx my mz na b">online</code>产品的平均寿命更短，在<code class="fe mx my mz na b">sales</code>中有一个更高的初始峰值，随后是更急剧的下降。</p><h1 id="020a" class="ma mb iq bd mc md me mf mg mh mi mj mk kf ml kg mm ki mn kj mo kl mp km mq mr bi translated">结论</h1><p id="b8d0" class="pw-post-body-paragraph le lf iq lg b lh ms ka lj lk mt kd lm ln mu lp lq lr mv lt lu lv mw lx ly lz ij bi translated">在这篇博文中，我们分析了一个非常强大的数据可视化工具:<strong class="lg ja">装箱散点图</strong>。特别是，我们已经看到了如何使用<code class="fe mx my mz na b">binsreg</code>包来自动挑选最佳数量的箱，并对条件均值执行非参数推断。然而，<code class="fe mx my mz na b">binsreg</code>套件提供的远不止这些，我强烈建议更深入地查看<a class="ae nb" href="https://cran.r-project.org/web/packages/binsreg/binsreg.pdf" rel="noopener ugc nofollow" target="_blank">的手册。</a></p><h2 id="4a73" class="ng mb iq bd mc oc od dn mg oe of dp mk ln og oh mm lr oi oj mo lv ok ol mq iw bi translated">参考</h2><p id="7c1e" class="pw-post-body-paragraph le lf iq lg b lh ms ka lj lk mt kd lm ln mu lp lq lr mv lt lu lv mw lx ly lz ij bi translated">[1]E . Starr，B . goldf ARB，<a class="ae nb" href="https://onlinelibrary.wiley.com/doi/abs/10.1002/smj.3199" rel="noopener ugc nofollow" target="_blank">分箱散点图:使研究更容易和更好的简单工具</a> (2020)，战略管理杂志。</p><p id="aaf1" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">[2] M. D. Cattaneo，R. K. Crump，M. H. Farrell，Y. Feng，<a class="ae nb" href="https://arxiv.org/abs/1902.09608" rel="noopener ugc nofollow" target="_blank"> On Binscatter </a> (2021)，工作文件。</p><p id="3f85" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">[3]p·戈德史密斯-平克姆，<a class="ae nb" href="https://www.youtube.com/watch?v=fg9T2gPZCIs" rel="noopener ugc nofollow" target="_blank">第六讲。线性回归II:半参数和可视化</a>，应用计量学博士课程。</p><h2 id="d305" class="ng mb iq bd mc oc od dn mg oe of dp mk ln og oh mm lr oi oj mo lv ok ol mq iw bi translated">密码</h2><p id="bc76" class="pw-post-body-paragraph le lf iq lg b lh ms ka lj lk mt kd lm ln mu lp lq lr mv lt lu lv mw lx ly lz ij bi translated">你可以在这里找到Jupyter的原版笔记本。</p><div class="ow ox gp gr oy oz"><a href="https://github.com/matteocourthoud/Blog-Posts/blob/main/notebooks/binscatter.ipynb" rel="noopener  ugc nofollow" target="_blank"><div class="pa ab fo"><div class="pb ab pc cl cj pd"><h2 class="bd ja gy z fp pe fr fs pf fu fw iz bi translated">Blog-Posts/bin scatter . ipynb at main matter courthoud/Blog-Posts</h2><div class="pg l"><h3 class="bd b gy z fp pe fr fs pf fu fw dk translated">我博客文章的代码和笔记本。通过在…上创建帐户，为matteocourthoud/Blog-Posts的发展做出贡献</h3></div><div class="ph l"><p class="bd b dl z fp pe fr fs pf fu fw dk translated">github.com</p></div></div><div class="pi l"><div class="pj l pk pl pm pi pn ky oz"/></div></div></a></div></div><div class="ab cl po pp hu pq" role="separator"><span class="pr bw bk ps pt pu"/><span class="pr bw bk ps pt pu"/><span class="pr bw bk ps pt"/></div><div class="ij ik il im in"><h2 id="29bb" class="ng mb iq bd mc oc od dn mg oe of dp mk ln og oh mm lr oi oj mo lv ok ol mq iw bi translated">感谢您的阅读！</h2><p id="a168" class="pw-post-body-paragraph le lf iq lg b lh ms ka lj lk mt kd lm ln mu lp lq lr mv lt lu lv mw lx ly lz ij bi translated">非常感谢！🤗<em class="om">如果你喜欢这个帖子并且想看更多，可以考虑</em> <a class="ae nb" href="https://medium.com/@matteo.courthoud" rel="noopener"> <strong class="lg ja"> <em class="om">关注我</em> </strong> </a> <em class="om">。我每周发布一次与因果推断和数据分析相关的主题。我尽量让我的帖子简单而精确，总是提供代码、例子和模拟。</em></p><p id="9638" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated"><em class="om">还有，一个小小的</em> <strong class="lg ja"> <em class="om">免责声明</em> </strong> <em class="om">:我写作是为了学习所以错误是家常便饭，尽管我尽了最大努力。当你发现他们的时候，请告诉我。也很欣赏新话题的建议！</em></p></div></div>    
</body>
</html>