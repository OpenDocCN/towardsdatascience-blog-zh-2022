<html>
<head>
<title>How to Automate Your Mongo Database Backups on Kubernetes and S3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Kubernetes和S3上自动化您的Mongo数据库备份</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-automate-your-mongo-database-backups-on-kubernetes-795bb9a6c9eb#2022-11-04">https://towardsdatascience.com/how-to-automate-your-mongo-database-backups-on-kubernetes-795bb9a6c9eb#2022-11-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="2cf0" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">计划并自动执行从Kubernetes集群到AWS S3的数据库备份</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/0cdd3105ea1340db7ee5acf0f170064f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OsyJ9ZxHPTf7RZQD"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com/@artwall_hd?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">艺术壁纸拍摄的照片</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上</p></figure><p id="52ad" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您运行的是MongoDB之类的自托管数据库，那么您很可能享受不到托管服务提供的自动备份的好处。</p><p id="6bf9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">本文是关于如何使用<a class="ae kv" href="https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/" rel="noopener ugc nofollow" target="_blank"> Kubernetes CronJobs </a>在Kubernetes集群上为MongoDB安排自动备份作业，并将这些备份存储在<a class="ae kv" href="https://aws.amazon.com/s3/" rel="noopener ugc nofollow" target="_blank"> AWS S3桶</a>中。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ls"><img src="../Images/2928b06d690a0ca1a9e2c1e3ccd1070c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*brxE8DH9v3Ek0xBK6dkViA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">计划定期执行备份作业，从数据库中提取数据，承担IAM角色以获取凭据，然后上传到S3—按作者排序的图像</p></figure><p id="c498" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将关注一个独立的MongoDB设置，同样的原则也适用于副本集和其他数据库。</p><p id="7b5e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由于许多组织使用Terraform来管理基础设施，我们将直接用Terraform格式编写CronJob。</p><h2 id="bbf7" class="lt lu iq bd lv lw lx dn ly lz ma dp mb lf mc md me lj mf mg mh ln mi mj mk ml bi translated">技术栈</h2><ul class=""><li id="4f56" class="mm mn iq ky b kz mo lc mp lf mq lj mr ln ms lr mt mu mv mw bi translated">MongoDB</li><li id="6f1d" class="mm mn iq ky b kz mx lc my lf mz lj na ln nb lr mt mu mv mw bi translated">库伯内特斯</li><li id="7ea7" class="mm mn iq ky b kz mx lc my lf mz lj na ln nb lr mt mu mv mw bi translated">AWS S3</li><li id="3282" class="mm mn iq ky b kz mx lc my lf mz lj na ln nb lr mt mu mv mw bi translated">将（行星）地球化（以适合人类居住）</li><li id="4483" class="mm mn iq ky b kz mx lc my lf mz lj na ln nb lr mt mu mv mw bi translated">码头工人</li></ul><h2 id="1a4a" class="lt lu iq bd lv lw lx dn ly lz ma dp mb lf mc md me lj mf mg mh ln mi mj mk ml bi translated">内容</h2><ul class=""><li id="e03b" class="mm mn iq ky b kz mo lc mp lf mq lj mr ln ms lr mt mu mv mw bi translated">创建地形模块(可选)</li><li id="3c8e" class="mm mn iq ky b kz mx lc my lf mz lj na ln nb lr mt mu mv mw bi translated">使用所需的工具创建Docker映像</li><li id="6100" class="mm mn iq ky b kz mx lc my lf mz lj na ln nb lr mt mu mv mw bi translated">定义变量和数据</li><li id="b6ad" class="mm mn iq ky b kz mx lc my lf mz lj na ln nb lr mt mu mv mw bi translated">创建一个S3存储桶来存储备份</li><li id="f52b" class="mm mn iq ky b kz mx lc my lf mz lj na ln nb lr mt mu mv mw bi translated">创建IAM角色和Kubernetes服务帐户</li><li id="3e87" class="mm mn iq ky b kz mx lc my lf mz lj na ln nb lr mt mu mv mw bi translated">将MongoDB的密码存储为Kubernetes的秘密</li><li id="3e80" class="mm mn iq ky b kz mx lc my lf mz lj na ln nb lr mt mu mv mw bi translated">创建库伯内特克朗乔布</li><li id="f5af" class="mm mn iq ky b kz mx lc my lf mz lj na ln nb lr mt mu mv mw bi translated">部署基础设施</li><li id="82d8" class="mm mn iq ky b kz mx lc my lf mz lj na ln nb lr mt mu mv mw bi translated">说明</li></ul><p id="a20d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们开始吧！</p></div><div class="ab cl nc nd hu ne" role="separator"><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh"/></div><div class="ij ik il im in"><blockquote class="nj nk nl"><p id="918a" class="kw kx nm ky b kz la jr lb lc ld ju le nn lg lh li no lk ll lm np lo lp lq lr ij bi translated"><strong class="ky ir">需求:</strong> <br/>本项目使用Terraform与<a class="ae kv" href="https://registry.terraform.io/providers/hashicorp/aws/4.38.0" rel="noopener ugc nofollow" target="_blank"> AWS提供商</a>和<a class="ae kv" href="https://registry.terraform.io/providers/hashicorp/kubernetes/2.15.0" rel="noopener ugc nofollow" target="_blank"> Kubernetes提供商</a>。<br/>请随意查看官方教程<a class="ae kv" href="https://developer.hashicorp.com/terraform/tutorials/kubernetes/eks" rel="noopener ugc nofollow" target="_blank">配置EKS集群</a>以启动并运行Kubernetes集群。</p></blockquote><h1 id="3b7c" class="nq lu iq bd lv nr ns nt ly nu nv nw mb jw nx jx me jz ny ka mh kc nz kd mk oa bi translated">创建地形模块(可选)</h1><p id="60d9" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf ob lh li lj oc ll lm ln od lp lq lr ij bi translated">为了在基础设施即代码存储库中保持结构化和整洁，我喜欢将逻辑任务划分为子模块。</p><p id="dfbe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请注意，这是可选的，您可以将下面创建的模板包含在基础设施源代码中的任何位置。</p><p id="5bd0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们在<strong class="ky ir">模块</strong>目录中创建一个目录<strong class="ky ir">数据库备份</strong>:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/bc52d292e3997789d9ac91efdd62bfdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:988/format:webp/1*EZZ0ZtoxgLm0W7YgcNgdYw.png"/></div></figure><h1 id="f8bc" class="nq lu iq bd lv nr ns nt ly nu nv nw mb jw nx jx me jz ny ka mh kc nz kd mk oa bi translated">使用所需的工具创建Docker映像</h1><p id="ab82" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf ob lh li lj oc ll lm ln od lp lq lr ij bi translated">为了执行备份，我们需要从数据库中转储数据，并将其上传到S3。</p><p id="f27a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将使用方便的<a class="ae kv" href="https://www.mongodb.com/docs/database-tools/mongodump/" rel="noopener ugc nofollow" target="_blank"><em class="nm">mongodump</em></a><em class="nm"/>来转储数据，并使用<a class="ae kv" href="https://aws.amazon.com/cli/" rel="noopener ugc nofollow" target="_blank"> <em class="nm"> AWS CLI </em> </a>将数据转储上传到S3。</p><p id="0a7b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在上面创建的Terraform模块中，添加一个目录<strong class="ky ir"> mongodb </strong>，并在这个新目录中创建一个<strong class="ky ir"> Dockerfile </strong>，其内容如下:</p><pre class="kg kh ki kj gt of og oh oi aw oj bi"><span id="9079" class="lt lu iq og b gy ok ol l om on"># Dockerfile</span><span id="e585" class="lt lu iq og b gy oo ol l om on"># Base on Amazon Linux 2 (will be running on AWS EKS)<br/>FROM amazonlinux:2</span><span id="28b7" class="lt lu iq og b gy oo ol l om on">RUN yum install -y unzip</span><span id="f481" class="lt lu iq og b gy oo ol l om on"># Install AWS CLI<br/>RUN curl -sOL <a class="ae kv" href="https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" rel="noopener ugc nofollow" target="_blank">https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip</a> \<br/> &amp;&amp; unzip awscli-exe-linux-x86_64.zip \<br/> &amp;&amp; ./aws/install</span><span id="862b" class="lt lu iq og b gy oo ol l om on"># Install MongoDB CLI tools<br/>RUN curl -sOL <a class="ae kv" href="https://fastdl.mongodb.org/tools/db/mongodb-database-tools-amazon2-x86_64-100.6.0.rpm" rel="noopener ugc nofollow" target="_blank">https://fastdl.mongodb.org/tools/db/mongodb-database-tools-amazon2-x86_64-100.6.0.rpm</a> \<br/> &amp;&amp; yum install -y mongodb-database-tools-amazon2-x86_64-100.6.0.rpm</span></pre><h2 id="d728" class="lt lu iq bd lv lw lx dn ly lz ma dp mb lf mc md me lj mf mg mh ln mi mj mk ml bi translated">构建该映像并将其推送到您的映像存储库</h2><p id="d95a" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf ob lh li lj oc ll lm ln od lp lq lr ij bi translated">让我们构建这个映像，并确保以正确的平台为目标——如果您在运行集群的机器之外的其他机器上进行开发(比如带有M1芯片的Macbook ),这一点尤其重要。</p><pre class="kg kh ki kj gt of og oh oi aw oj bi"><span id="56bd" class="lt lu iq og b gy ok ol l om on">export REPOSITORY_URL=&lt;your repository URL, e.g. on AWS ECR&gt;<br/>export TAG=&lt;COMMIT_HASH&gt; # Should be commit hash, but can be an arbitrary string</span><span id="8bc3" class="lt lu iq og b gy oo ol l om on">docker build --tag="$REPOSITORY_URL:$TAG" --platform=linux/amd64 .</span></pre><p id="815e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要推送映像，请确保您已登录到您的存储库(运行<em class="nm"> docker登录</em>，然后运行:</p><pre class="kg kh ki kj gt of og oh oi aw oj bi"><span id="95c4" class="lt lu iq og b gy ok ol l om on">docker push "$REPOSITORY_URL:$TAG"</span></pre><h1 id="53f5" class="nq lu iq bd lv nr ns nt ly nu nv nw mb jw nx jx me jz ny ka mh kc nz kd mk oa bi translated">定义变量并获取数据</h1><p id="06a1" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf ob lh li lj oc ll lm ln od lp lq lr ij bi translated">我们需要定义一些Terraform配置变量，并获取将在该项目的其余部分使用的数据。请随意调整这些以适应您当前的设置。</p><p id="b500" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在文件名<strong class="ky ir"> variables.tf </strong>中，添加以下内容:</p><pre class="kg kh ki kj gt of og oh oi aw oj bi"><span id="8505" class="lt lu iq og b gy ok ol l om on"># variables.tf</span><span id="d735" class="lt lu iq og b gy oo ol l om on">variable "kubernetes_namespace" {<br/>  type = string<br/>}</span><span id="7689" class="lt lu iq og b gy oo ol l om on">variable "kubernetes_cluster_name" {<br/>  description = "Kubernetes cluster where the backup job and permissions service account should be deployed"<br/>  type        = string<br/>}</span><span id="b3c7" class="lt lu iq og b gy oo ol l om on">variable "container_image_repository" {<br/>  description = "URL of the Docker image used in the CronJob container"<br/>  type        = string<br/>}</span><span id="d21b" class="lt lu iq og b gy oo ol l om on">variable "container_image_tag" {<br/>  description = "Tag of the Docker image used in the CronJob container"<br/>  type        = string<br/>}</span><span id="94c3" class="lt lu iq og b gy oo ol l om on">variable "database_host" {<br/>  description = "MongoDB host URL"<br/>  type        = string<br/>}</span><span id="e5e9" class="lt lu iq og b gy oo ol l om on">variable "database_user" {<br/>  description = "MongoDB user"<br/>  type        = string<br/>}</span><span id="c80c" class="lt lu iq og b gy oo ol l om on">variable "database_password" {<br/>  description = "MongoDB password"<br/>  type        = string<br/>  sensitive   = true<br/>}</span></pre><p id="e641" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在名为<strong class="ky ir"> data.tf </strong>的文件中，添加以下内容:</p><pre class="kg kh ki kj gt of og oh oi aw oj bi"><span id="c14f" class="lt lu iq og b gy ok ol l om on"># data.tf</span><span id="bd49" class="lt lu iq og b gy oo ol l om on">data "aws_caller_identity" "current" {}</span><span id="1a4c" class="lt lu iq og b gy oo ol l om on">data "aws_eks_cluster" "kubernetes_cluster" {<br/>  name = var.kubernetes_cluster_name<br/>}</span></pre><h1 id="b6e7" class="nq lu iq bd lv nr ns nt ly nu nv nw mb jw nx jx me jz ny ka mh kc nz kd mk oa bi translated">创建一个S3存储桶来存储备份</h1><p id="d027" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf ob lh li lj oc ll lm ln od lp lq lr ij bi translated">我们需要一个可靠的位置来存储我们的备份，AWS S3公司提供了<a class="ae kv" href="https://aws.amazon.com/s3/faqs/#:~:text=Q%3A%20How%20reliable%20is%20Amazon%20S3%3F" rel="noopener ugc nofollow" target="_blank">良好的保证</a>，而且价格实惠，使用方便。</p><p id="23a3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建一个地形文件<strong class="ky ir"> s3-bucket.tf </strong>，内容如下:</p><pre class="kg kh ki kj gt of og oh oi aw oj bi"><span id="b037" class="lt lu iq og b gy ok ol l om on"># s3-bucket.tf</span><span id="9678" class="lt lu iq og b gy oo ol l om on">resource "aws_s3_bucket" "database_backup_storage" {<br/>  lifecycle {<br/>    # Prevent destroying the backups storage in case of accidental tear down<br/>    prevent_destroy = true<br/>  }</span><span id="ae5d" class="lt lu iq og b gy oo ol l om on">  bucket = "database-backup-storage"<br/>}</span></pre><p id="5b56" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">或者，我们可以添加一个生命周期策略来自动删除超过7天的备份。在同一文件中，添加以下内容:</p><pre class="kg kh ki kj gt of og oh oi aw oj bi"><span id="4da1" class="lt lu iq og b gy ok ol l om on"># s3-bucket.tf</span><span id="e2ce" class="lt lu iq og b gy oo ol l om on">...</span><span id="b34a" class="lt lu iq og b gy oo ol l om on">resource "aws_s3_bucket_lifecycle_configuration" "database_backup_storage_lifecycle" {<br/>  bucket = aws_s3_bucket.database_backup_storage.bucket<br/>  rule {<br/>    id     = "delete-old-backups-7d"<br/>    status = "Enabled"<br/>    <br/>    filter {}</span><span id="d796" class="lt lu iq og b gy oo ol l om on">    expiration {<br/>      days = 7<br/>    }<br/>  }<br/>}</span></pre><h1 id="b5d5" class="nq lu iq bd lv nr ns nt ly nu nv nw mb jw nx jx me jz ny ka mh kc nz kd mk oa bi translated">创建IAM角色和Kubernetes服务帐户</h1><p id="2280" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf ob lh li lj oc ll lm ln od lp lq lr ij bi translated">我们的备份作业需要将备份上传到S3的权限。更具体地说，我们需要创建:</p><ul class=""><li id="650e" class="mm mn iq ky b kz la lc ld lf op lj oq ln or lr mt mu mv mw bi translated">一个<a class="ae kv" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html" rel="noopener ugc nofollow" target="_blank"> IAM角色</a>，其策略允许<strong class="ky ir"> S3:PutObject </strong>在备份S3桶中操作</li><li id="f42b" class="mm mn iq ky b kz mx lc my lf mz lj na ln nb lr mt mu mv mw bi translated">一个<a class="ae kv" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/" rel="noopener ugc nofollow" target="_blank"> Kubernetes服务帐户</a>提供一个web身份令牌，允许备份作业承担IAM角色上传到S3</li></ul><p id="bffe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要了解更多信息，这里有关于AWS EKS 上服务帐户的<a class="ae kv" href="https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html" rel="noopener ugc nofollow" target="_blank"> IAM角色的文档。</a></p><p id="62c1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在名为<strong class="ky ir"> access-control.tf </strong>的文件中，添加以下内容:</p><pre class="kg kh ki kj gt of og oh oi aw oj bi"><span id="4bc2" class="lt lu iq og b gy ok ol l om on"># access-control.tf</span><span id="1bfd" class="lt lu iq og b gy oo ol l om on">locals {<br/>  service_account_name = "database-backup"</span><span id="c066" class="lt lu iq og b gy oo ol l om on">  oidc_provider = replace(<br/>    data.aws_eks_cluster.kubernetes_cluster.identity[0].oidc[0].issuer,<br/>    "/^<a class="ae kv" href="https:///" rel="noopener ugc nofollow" target="_blank">https:///</a>",<br/>    ""<br/>  )<br/>}</span><span id="6091" class="lt lu iq og b gy oo ol l om on">resource "aws_iam_role" "role" {<br/>  name = "database-backup-role"</span><span id="a622" class="lt lu iq og b gy oo ol l om on">  assume_role_policy = jsonencode({<br/>    Version = "2012-10-17",<br/>    Statement = [<br/>      {<br/>        Effect = "Allow",<br/>        Principal = {<br/>          Federated = "arn:aws:iam::${data.aws_caller_identity.current.account_id}:oidc-provider/${local.oidc_provider}"<br/>        },<br/>        Action = "sts:AssumeRoleWithWebIdentity",<br/>        Condition = {<br/>          StringEquals = {<br/>            "${local.oidc_provider}:aud" = "sts.amazonaws.com",<br/>            "${local.oidc_provider}:sub" = "system:serviceaccount:${var.kubernetes_namespace}:${local.service_account_name}"<br/>          }<br/>        }<br/>      }<br/>    ]<br/>  })</span><span id="061a" class="lt lu iq og b gy oo ol l om on">  inline_policy {<br/>    name = "AllowS3PutObject"<br/>    policy = jsonencode({<br/>      Version = "2012-10-17"<br/>      Statement = [<br/>        {<br/>          Action = [<br/>            "S3:PutObject",<br/>          ]<br/>          Effect   = "Allow"<br/>          Resource = "${aws_s3_bucket.database_backup_storage.arn}/*"<br/>        }<br/>      ]<br/>    })<br/>  }<br/>}</span><span id="08dd" class="lt lu iq og b gy oo ol l om on">resource "kubernetes_service_account" "iam" {<br/>  metadata {<br/>    name      = local.service_account_name<br/>    namespace = var.kubernetes_namespace</span><span id="277d" class="lt lu iq og b gy oo ol l om on">  annotations = {<br/>      "eks.amazonaws.com/role-arn" = aws_iam_role.role.arn<br/>      "eks.amazonaws.com/sts-regional-endpoints" = true<br/>    }<br/>  }<br/>}</span></pre><h1 id="4b46" class="nq lu iq bd lv nr ns nt ly nu nv nw mb jw nx jx me jz ny ka mh kc nz kd mk oa bi translated">创建库伯内特克朗乔布</h1><p id="2021" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf ob lh li lj oc ll lm ln od lp lq lr ij bi translated">我们可以使用Terraform以HCL格式定义我们的CronJob(参见<a class="ae kv" href="https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/cron_job" rel="noopener ugc nofollow" target="_blank"> kubernetes_cron_job </a>)。注意，我们可以在Kubernetes清单格式(yaml/json)中应用相同的配置。</p><p id="dac2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在名为<strong class="ky ir"> backup-cronjob.tf </strong>的文件中，添加以下内容:</p><pre class="kg kh ki kj gt of og oh oi aw oj bi"><span id="8743" class="lt lu iq og b gy ok ol l om on"># backup-cronjob.tf</span><span id="aed3" class="lt lu iq og b gy oo ol l om on">resource "kubernetes_cron_job" "database_backup_cronjob" {<br/>  metadata {<br/>    name      = "database-backup-mongodb-daily"<br/>    namespace = var.kubernetes_namespace<br/>  }</span><span id="72ca" class="lt lu iq og b gy oo ol l om on">  spec {<br/>    schedule                      = "0 5 * * *" // At 05:00<br/>    concurrency_policy            = "Replace"<br/>    suspend                       = false<br/>    successful_jobs_history_limit = 3<br/>    failed_jobs_history_limit     = 3</span><span id="324c" class="lt lu iq og b gy oo ol l om on">    job_template {<br/>      metadata {}<br/>      spec {<br/>        template {<br/>          metadata {}<br/>          spec {<br/>            restart_policy = "Never"</span><span id="fb5b" class="lt lu iq og b gy oo ol l om on">            service_account_name = kubernetes_service_account.iam.metadata[0].name</span><span id="4a9d" class="lt lu iq og b gy oo ol l om on">            container {<br/>              name    = "database-backup"<br/>              image   = "${var.container_image_repository}:${var.container_image_tag}"<br/>              command = ["/bin/sh", "-c"]<br/>              args = [<br/>                "mongodump --host=\"$MONGODB_HOST\" --username=\"$MONGODB_USER\" --password=\"$MONGODB_PASSWORD\" --gzip --archive | aws s3 cp - s3://$S3_BUCKET/$S3_BUCKET_PREFIX/$(date +\"%Y%m%d-%H%M%S-%Z\").archive.gz"<br/>              ]</span><span id="0d3b" class="lt lu iq og b gy oo ol l om on">              env {<br/>                name  = "MONGODB_HOST"<br/>                value = var.database_host<br/>              }<br/>              env {<br/>                name  = "MONGODB_USER"<br/>                value = var.database_user<br/>              }<br/>              env {<br/>                name  = "MONGODB_PASSWORD"<br/>                value = var.database_password<br/>              }</span><span id="846d" class="lt lu iq og b gy oo ol l om on">              # Note that you can also set the DB password as a Kubernetes Secret then get it as<br/>              # env {<br/>              #   name = "MONGODB_PASSWORD"<br/>              #   value_from {<br/>              #     secret_key_ref {<br/>              #       name = "mongodb"<br/>              #       key  = "mongodb-password"<br/>              #     }<br/>              #   }<br/>              # }</span><span id="0f4d" class="lt lu iq og b gy oo ol l om on">              env {<br/>                name  = "S3_BUCKET"<br/>                value = aws_s3_bucket.database_backup_storage.bucket<br/>              }<br/>              env {<br/>                name  = "S3_BUCKET_PREFIX"<br/>                value = "mongodb"<br/>              }</span><span id="f26b" class="lt lu iq og b gy oo ol l om on">resources {<br/>                limits = {<br/>                  cpu    = "1000m"<br/>                  memory = "1000Mi"<br/>                }<br/>                requests = {<br/>                  cpu    = "100m"<br/>                  memory = "256Mi"<br/>                }<br/>              }<br/>            }<br/>          }<br/>        }<br/>      }<br/>    }<br/>  }<br/>}</span></pre><h1 id="94d9" class="nq lu iq bd lv nr ns nt ly nu nv nw mb jw nx jx me jz ny ka mh kc nz kd mk oa bi translated">部署基础设施</h1><p id="e2cf" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf ob lh li lj oc ll lm ln od lp lq lr ij bi translated">既然我们的备份模块已经准备就绪，我们就可以将其与基础架构的其余部分一起部署了。</p><p id="3583" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以在Terraform代码中放置以下代码片段，例如在<strong class="ky ir"> main.tf </strong>中:</p><pre class="kg kh ki kj gt of og oh oi aw oj bi"><span id="b703" class="lt lu iq og b gy ok ol l om on">module "mongodb_backup" {<br/>  source = "${path.root}/modules/database-backup"</span><span id="5fbf" class="lt lu iq og b gy oo ol l om on">  kubernetes_namespace       = "&lt;your namespace&gt;"<br/>  kubernetes_cluster_name    = "&lt;your cluster name&gt;"<br/>  container_image_repository = "&lt;Value of REPOSITORY_URL&gt;"<br/>  container_image_tag        = "&lt;Value of TAG&gt;"<br/>  database_host              = &lt;MongoDB host&gt;<br/>  database_user              = &lt;MongoDB user&gt;<br/>  database_password          = &lt;MongoDB password&gt;</span><span id="ebac" class="lt lu iq og b gy oo ol l om on">  tags = {<br/>    Name = "database-backup-mongodb"<br/>  }<br/>}</span></pre><p id="1f68" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦应用了terraform基础设施(<em class="nm"> terraform apply) </em>，您应该会看到有一个CronJob启动并运行:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi os"><img src="../Images/b2e37e4d2ae9c95c9c71b3a169bc9194.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LRKtN5nGSdIxM9xivwevjA.png"/></div></div></figure></div><div class="ab cl nc nd hu ne" role="separator"><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh"/></div><div class="ij ik il im in"><h1 id="354a" class="nq lu iq bd lv nr ot nt ly nu ou nw mb jw ov jx me jz ow ka mh kc ox kd mk oa bi translated">说明</h1><h2 id="2784" class="lt lu iq bd lv lw lx dn ly lz ma dp mb lf mc md me lj mf mg mh ln mi mj mk ml bi translated">它是如何工作的</h2><p id="74c2" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf ob lh li lj oc ll lm ln od lp lq lr ij bi translated">A <a class="ae kv" href="https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/" rel="noopener ugc nofollow" target="_blank"> Kubernetes CronJob </a>调度<em class="nm">作业</em>作为能够执行给定任务的pod运行。在这种数据库备份实施的情况下，每个计划的作业将执行以下步骤:</p><ol class=""><li id="8852" class="mm mn iq ky b kz la lc ld lf op lj oq ln or lr oy mu mv mw bi translated">连接到位于$MONGODB_HOST的独立主机</li><li id="51a5" class="mm mn iq ky b kz mx lc my lf mz lj na ln nb lr oy mu mv mw bi translated">使用<a class="ae kv" href="https://www.mongodb.com/docs/database-tools/mongodump/" rel="noopener ugc nofollow" target="_blank"><em class="nm">mongodump</em></a><em class="nm"/>将数据转储为压缩(gzip)文件，并将结果打印到标准输出。这里有三件事:(1)我们压缩以减少上传负载的大小，(2)我们存档以将数据转储到单个文件中(这是可选的，但可以防止转储到不区分大小写的文件系统时出现问题——参见<a class="ae kv" href="https://www.mongodb.com/docs/database-tools/mongodump/#behavior" rel="noopener ugc nofollow" target="_blank">警告这里的</a>)，(3)我们将转储打印到标准输出，以便能够通过管道将其传输到AWS CLI。</li><li id="625c" class="mm mn iq ky b kz mx lc my lf mz lj na ln nb lr oy mu mv mw bi translated">将压缩的归档文件通过管道传输到AWS CLI</li><li id="ee40" class="mm mn iq ky b kz mx lc my lf mz lj na ln nb lr oy mu mv mw bi translated">通过以下方式从标准输入(管道)复制到S3时段:</li></ol><pre class="kg kh ki kj gt of og oh oi aw oj bi"><span id="fcb7" class="lt lu iq og b gy ok ol l om on">aws s3 cp - s3://$S3_BUCKET</span></pre><h2 id="a9f3" class="lt lu iq bd lv lw lx dn ly lz ma dp mb lf mc md me lj mf mg mh ln mi mj mk ml bi translated">如何恢复数据</h2><ol class=""><li id="52b8" class="mm mn iq ky b kz mo lc mp lf mq lj mr ln ms lr oy mu mv mw bi translated">将最新的数据从S3下载到您的本地或目标Mongo主机(即您希望恢复数据的位置):</li></ol><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oz"><img src="../Images/2971e43f931c15434afa4a0a7fd988fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fPWc-Wm2fc0J4esxcoz9-Q.png"/></div></div></figure><p id="fb53" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2.使用<a class="ae kv" href="https://www.mongodb.com/docs/database-tools/mongorestore/" rel="noopener ugc nofollow" target="_blank"> <em class="nm"> mongorestore </em> </a>实用程序:</p><pre class="kg kh ki kj gt of og oh oi aw oj bi"><span id="acd3" class="lt lu iq og b gy ok ol l om on">mongorestore --gzip --archive=/path/to/backup [--host $HOST --username $USERNAME --password $PASSWORD]</span></pre><h2 id="463f" class="lt lu iq bd lv lw lx dn ly lz ma dp mb lf mc md me lj mf mg mh ln mi mj mk ml bi translated">重要的</h2><ul class=""><li id="d889" class="mm mn iq ky b kz mo lc mp lf mq lj mr ln ms lr mt mu mv mw bi translated">该时间表应该根据您的需要进行更改——上面的设置是相对于您的Kubernetes集群时区的5:00。</li><li id="0edf" class="mm mn iq ky b kz mx lc my lf mz lj na ln nb lr mt mu mv mw bi translated">MongoDB备份被配置为使用单个实例。相应地更改副本集的配置(参见<a class="ae kv" href="https://www.mongodb.com/docs/database-tools/mongodump/#std-option-mongodump.--oplog" rel="noopener ugc nofollow" target="_blank"> <em class="nm">操作日志</em> </a>的用法)。</li><li id="9486" class="mm mn iq ky b kz mx lc my lf mz lj na ln nb lr mt mu mv mw bi translated">MongoDB服务器的版本必须与备份转储所源自的数据库的版本相匹配。</li></ul></div><div class="ab cl nc nd hu ne" role="separator"><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh"/></div><div class="ij ik il im in"><h1 id="b386" class="nq lu iq bd lv nr ot nt ly nu ou nw mb jw ov jx me jz ow ka mh kc ox kd mk oa bi translated">最终注释</h1><p id="48f4" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf ob lh li lj oc ll lm ln od lp lq lr ij bi translated">当运行自托管数据库时，需要采取额外的步骤来设置防止数据丢失的措施—以防灾难、意外删除、硬件故障等。</p><p id="e065" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">令人欣慰的是，最常见的数据库提供了生成和恢复备份的工具，像AWS S3这样的云存储解决方案是可靠的，经济的，并且使用方便。</p><p id="ea4b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">利用像Kubernetes CronJob 这样的作业调度程序，我们可以创建一个自动解决方案，在专注于构建令人惊叹的应用程序的同时，负责备份数据🎉！</p></div><div class="ab cl nc nd hu ne" role="separator"><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh"/></div><div class="ij ik il im in"><p id="98e3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你觉得这个教程有用，并且你想支持高质量文章的制作，考虑<a class="ae kv" href="https://www.buymeacoffee.com/redouaneachouri" rel="noopener ugc nofollow" target="_blank">给我买杯咖啡</a>！</p><p id="a5b7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你可以点击“关注”按钮来获取我的最新文章和帖子！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pa"><img src="../Images/c6cac29c20a9cdd325be670a3ceb550f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*unAZ0wJciBonN2DADyGhtw.gif"/></div></div></figure></div></div>    
</body>
</html>