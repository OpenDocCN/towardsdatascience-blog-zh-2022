<html>
<head>
<title>MySQL to DynamoDB: Build a streaming data pipeline on AWS using Kafka</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">MySQL到DynamoDB:使用Kafka在AWS上构建流数据管道</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/mysql-to-dynamodb-build-a-streaming-data-pipeline-on-aws-using-kafka-c2cf0b6e35b6#2022-06-28">https://towardsdatascience.com/mysql-to-dynamodb-build-a-streaming-data-pipeline-on-aws-using-kafka-c2cf0b6e35b6#2022-06-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d380" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated"><strong class="ak">通过MSK连接使用变更数据捕获在Aurora MySQL和DynamoDB之间同步数据</strong></h2></div><p id="93fa" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是博客系列的第二部分，它提供了Kafka和Kafka Connect的数据管道的逐步演示。出于演示目的，我将使用AWS，但是这些概念适用于任何等效的选项(例如，在Docker中本地运行这些选项)。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/0cab2562e5e438fe011d2841549123f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RPMqnoRxvshzlhuY"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">由<a class="ae lr" href="https://unsplash.com/@darya_jumelya?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">达丽娅·朱姆</a>在<a class="ae lr" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="aaeb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这一部分将展示<em class="ls">变更数据捕获</em>的作用，它让您可以跟踪数据库表中的行级变更，以响应创建、更新和删除操作。例如，在MySQL中，这些变更数据事件通过<a class="ae lr" href="https://dev.mysql.com/doc/internals/en/binary-log-overview.html" rel="noopener ugc nofollow" target="_blank"> MySQL二进制日志(binlog) </a>公开。在第1部分中，我们在数据管道的源部分使用了Datagen连接器——它帮助我们为MSK主题生成模拟数据，并使事情变得简单。</p><div class="lt lu gp gr lv lw"><a rel="noopener follow" target="_blank" href="/build-a-data-pipeline-on-aws-with-kafka-kafka-connect-and-dynamodb-97642cdb0cfb"><div class="lx ab fo"><div class="ly ab lz cl cj ma"><h2 class="bd ir gy z fp mb fr fs mc fu fw ip bi translated">使用Kafka、Kafka connect和DynamoDB在AWS上构建数据管道</h2><div class="md l"><h3 class="bd b gy z fp mb fr fs mc fu fw dk translated">将DynamoDB与MSK和MSK连接集成</h3></div><div class="me l"><p class="bd b dl z fp mb fr fs mc fu fw dk translated">towardsdatascience.com</p></div></div><div class="mf l"><div class="mg l mh mi mj mf mk ll lw"/></div></div></a></div><p id="1f64" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将使用Aurora MySQL作为数据源，并通过<a class="ae lr" href="https://debezium.io/documentation/reference/1.9/connectors/mysql.html" rel="noopener ugc nofollow" target="_blank">Debezium connector for MySQL</a>利用其变更数据捕获功能，从<a class="ae lr" href="https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/Aurora.AuroraMySQL.html" rel="noopener ugc nofollow" target="_blank"> Aurora MySQL </a>中的表中实时提取数据，并将其推送到MSK主题。然后，我们将像以前一样继续使用DynamoDB接收器连接器。</p><p id="0d17" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">如果你刚接触</strong><a class="ae lr" href="https://debezium.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kh ir">Debezium</strong></a><strong class="kh ir">…</strong></p><p id="febc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它是一个分布式平台，构建在不同数据库中可用的变更数据捕获功能之上。它提供了一组<a class="ae lr" href="https://debezium.io/documentation/reference/1.2/connectors/index.html" rel="noopener ugc nofollow" target="_blank"> Kafka Connect连接器</a>，这些连接器利用数据库表中的行级更改(使用CDC)并将它们转换成事件流。这些被发送到Kafka，并可用于所有下游应用程序。</p></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><p id="8c67" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是这篇博文中提出的解决方案的高级示意图。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi ms"><img src="../Images/3540322749408c296fd98a927415a050.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*nnxHtAkuJb5BepdB.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">高层架构(图片由作者提供)</p></figure><p id="dbfa" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我假设您是从第1部分开始学习的，在第1部分中，已经介绍了本教程所需的基础设施和服务的创建过程。如果您还没有，请参考<a class="ae lr" rel="noopener" target="_blank" href="/build-a-data-pipeline-on-aws-with-kafka-kafka-connect-and-dynamodb-97642cdb0cfb">第1部分</a>章节中的<strong class="kh ir">准备基础设施组件和服务</strong>章节</p><h1 id="7e0a" class="mt mu iq bd mv mw mx my mz na nb nc nd jw ne jx nf jz ng ka nh kc ni kd nj nk bi translated">数据管道第1部分:Aurora MySQL到MSK</h1><p id="ee6f" class="pw-post-body-paragraph kf kg iq kh b ki nl jr kk kl nm ju kn ko nn kq kr ks no ku kv kw np ky kz la ij bi translated">让我们首先创建管道的前半部分，将Aurora MySQL表中的数据同步到MSK的一个主题。</p><p id="0c0e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本节中，您将:</p><ul class=""><li id="a89c" class="nq nr iq kh b ki kj kl km ko ns ks nt kw nu la nv nw nx ny bi translated">下载Debezium连接器产品</li><li id="2b7c" class="nq nr iq kh b ki nz kl oa ko ob ks oc kw od la nv nw nx ny bi translated">在MSK创建自定义插件</li><li id="438f" class="nq nr iq kh b ki nz kl oa ko ob ks oc kw od la nv nw nx ny bi translated">将Debezium源连接器部署到MSK连接</li></ul><p id="57dd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，数据管道的前半部分将准备就绪！</p><h2 id="b649" class="oe mu iq bd mv of og dn mz oh oi dp nd ko oj ok nf ks ol om nh kw on oo nj op bi translated">创建自定义插件和连接器</h2><p id="0a1c" class="pw-post-body-paragraph kf kg iq kh b ki nl jr kk kl nm ju kn ko nn kq kr ks no ku kv kw np ky kz la ij bi translated"><strong class="kh ir">将Debezium连接器上传到亚马逊S3 </strong></p><p id="d59e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">登录Kafka客户端EC2实例并运行以下命令:</p><pre class="lc ld le lf gt oq or os ot aw ou bi"><span id="e440" class="oe mu iq or b gy ov ow l ox oy">sudo -u ec2-user -i<br/>mkdir debezium &amp;&amp; cd debezium</span><span id="783e" class="oe mu iq or b gy oz ow l ox oy">wget https://repo1.maven.org/maven2/io/debezium/debezium-connector-mysql/1.9.0.Final/debezium-connector-mysql-1.9.0.Final-plugin.tar.gz<br/>tar xzf debezium-connector-mysql-1.9.0.Final-plugin.tar.gz</span><span id="d481" class="oe mu iq or b gy oz ow l ox oy">cd debezium-connector-mysql<br/>zip -9 ../debezium-connector-mysql-1.9.0.Final-plugin.zip *</span><span id="5aec" class="oe mu iq or b gy oz ow l ox oy">cd ..<br/>aws s3 cp ./debezium-connector-mysql-1.9.0.Final-plugin.zip s3://msk-lab-&lt;ENTER_YOUR_AWS_ACCOUNT_ID&gt;-plugins-bucket/</span></pre><p id="a472" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">创建自定义插件</strong></p><blockquote class="pa pb pc"><p id="c88e" class="kf kg ls kh b ki kj jr kk kl km ju kn pd kp kq kr pe kt ku kv pf kx ky kz la ij bi translated"><em class="iq">有关如何创建MSK连接插件的分步说明，请参考官方文档中的</em> <a class="ae lr" href="https://docs.aws.amazon.com/msk/latest/developerguide/msk-connect-plugins.html" rel="noopener ugc nofollow" target="_blank"> <em class="iq">使用AWS管理控制台</em> </a> <em class="iq">创建自定义插件。</em></p></blockquote><p id="c40f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建定制插件时，确保选择您在上一步上传到<code class="fe pg ph pi or b">S3</code>的Debezium连接器zip文件。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi ms"><img src="../Images/ac24d2a0fac5c889818f0928994249d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*AdyzcM5zFT1QcJTR.png"/></div></div></figure><p id="1e39" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">创建Debezium源连接器</strong></p><blockquote class="pa pb pc"><p id="4139" class="kf kg ls kh b ki kj jr kk kl km ju kn pd kp kq kr pe kt ku kv pf kx ky kz la ij bi translated"><em class="iq">关于如何创建MSK连接连接器的逐步说明，请参考官方文档中的</em> <a class="ae lr" href="https://docs.aws.amazon.com/msk/latest/developerguide/msk-connect-connectors.html#mkc-create-connector-intro" rel="noopener ugc nofollow" target="_blank"> <em class="iq">创建连接器</em> </a> <em class="iq">。</em></p></blockquote><p id="8215" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要创建连接器:</p><ol class=""><li id="32a8" class="nq nr iq kh b ki kj kl km ko ns ks nt kw nu la pj nw nx ny bi translated">选择您刚刚创建的插件。</li><li id="c242" class="nq nr iq kh b ki nz kl oa ko ob ks oc kw od la pj nw nx ny bi translated">输入连接器名称，并选择MSK集群和IAM身份验证</li><li id="710d" class="nq nr iq kh b ki nz kl oa ko ob ks oc kw od la pj nw nx ny bi translated">您可以在连接器配置部分输入下面提供的内容。确保根据您的设置替换以下配置:</li></ol><ul class=""><li id="6f56" class="nq nr iq kh b ki kj kl km ko ns ks nt kw nu la nv nw nx ny bi translated"><code class="fe pg ph pi or b">database.history.kafka.bootstrap.servers</code> -输入MSK集群端点</li><li id="219d" class="nq nr iq kh b ki nz kl oa ko ob ks oc kw od la nv nw nx ny bi translated"><code class="fe pg ph pi or b">database.hostname</code> -输入Aurora RDS MySQL端点</li></ul><blockquote class="pa pb pc"><p id="834a" class="kf kg ls kh b ki kj jr kk kl km ju kn pd kp kq kr pe kt ku kv pf kx ky kz la ij bi translated"><em class="iq">保持其余配置不变</em></p></blockquote><pre class="lc ld le lf gt oq or os ot aw ou bi"><span id="0f98" class="oe mu iq or b gy ov ow l ox oy">connector.class=io.debezium.connector.mysql.MySqlConnector<br/>database.user=master<br/>database.server.id=123456<br/>tasks.max=1<br/>database.history.kafka.topic=dbhistory.salesdb<br/>database.history.kafka.bootstrap.servers=&lt;ENTER MSK CLUSTER ENDPOINT&gt;<br/>database.server.name=salesdb<br/>database.port=3306<br/>include.schema.changes=true<br/>database.hostname=&lt;ENTER RDS MySQL ENDPOINT&gt;<br/>database.password=S3cretPwd99<br/>database.include.list=salesdb<br/>value.converter.schemas.enable=false<br/>key.converter.schemas.enable=false<br/>key.converter=org.apache.kafka.connect.storage.StringConverter<br/>value.converter=org.apache.kafka.connect.json.JsonConverter<br/>database.history.consumer.security.protocol=SASL_SSL<br/>database.history.consumer.sasl.mechanism=AWS_MSK_IAM<br/>database.history.consumer.sasl.jaas.config=software.amazon.msk.auth.iam.IAMLoginModule required;<br/>database.history.consumer.sasl.client.callback.handler.class=software.amazon.msk.auth.iam.IAMClientCallbackHandler<br/>database.history.producer.security.protocol=SASL_SSL<br/>database.history.producer.sasl.mechanism=AWS_MSK_IAM<br/>database.history.producer.sasl.jaas.config=software.amazon.msk.auth.iam.IAMLoginModule required;<br/>database.history.producer.sasl.client.callback.handler.class=software.amazon.msk.auth.iam.IAMClientCallbackHandler<br/>transforms=unwrap<br/>transforms.unwrap.type=io.debezium.transforms.ExtractNewRecordState</span></pre><ol class=""><li id="b792" class="nq nr iq kh b ki kj kl km ko ns ks nt kw nu la pj nw nx ny bi translated">在<strong class="kh ir">访问权限</strong>下，为连接器选择正确的IAM角色(名称中带有<code class="fe pg ph pi or b">AuroraConnectorIAMRole</code>的角色)</li><li id="9c02" class="nq nr iq kh b ki nz kl oa ko ob ks oc kw od la pj nw nx ny bi translated">点击下一个的<strong class="kh ir">进入<strong class="kh ir">安全</strong>选项——保持不变</strong></li><li id="f288" class="nq nr iq kh b ki nz kl oa ko ob ks oc kw od la pj nw nx ny bi translated">点击<strong class="kh ir">下一个</strong>。对于<strong class="kh ir">日志交付</strong>，选择<strong class="kh ir">交付至亚马逊云观察日志</strong>。找到并选择<code class="fe pg ph pi or b">/msk-connect-demo-cwlog-group</code></li><li id="a405" class="nq nr iq kh b ki nz kl oa ko ob ks oc kw od la pj nw nx ny bi translated">点击<strong class="kh ir">下一步</strong> —在最后一页，向下滚动并点击<strong class="kh ir">创建连接器</strong>以启动流程并等待连接器启动。</li></ol><p id="b06c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">完成后，连接器转换到<strong class="kh ir">运行</strong>状态，继续以下步骤。</p><h2 id="ac5b" class="oe mu iq bd mv of og dn mz oh oi dp nd ko oj ok nf ks ol om nh kw on oo nj op bi translated">测试管道</h2><p id="f8fe" class="pw-post-body-paragraph kf kg iq kh b ki nl jr kk kl nm ju kn ko nn kq kr ks no ku kv kw np ky kz la ij bi translated">我们想要确认来自<code class="fe pg ph pi or b">salesdb</code>数据库中的<code class="fe pg ph pi or b">SALES_ORDER</code>表的记录是否已经被推送到MSK主题。为此，从EC2主机运行Kafka CLI消费程序。</p><blockquote class="pa pb pc"><p id="734c" class="kf kg ls kh b ki kj jr kk kl km ju kn pd kp kq kr pe kt ku kv pf kx ky kz la ij bi translated"><em class="iq">注意题目名称</em><code class="fe pg ph pi or b"><em class="iq">salesdb.salesdb.SALES_ORDER</em></code><em class="iq">——这是根据Debezium约定</em></p></blockquote><pre class="lc ld le lf gt oq or os ot aw ou bi"><span id="8bf2" class="oe mu iq or b gy ov ow l ox oy">sudo -u ec2-user -i</span><span id="8167" class="oe mu iq or b gy oz ow l ox oy">export MSK_BOOTSTRAP_ADDRESS=&lt;ENTER MSK CLUSTER ENDPOINT&gt;</span><span id="4180" class="oe mu iq or b gy oz ow l ox oy">/home/ec2-user/kafka/bin/kafka-console-consumer.sh --bootstrap-server $MSK_BOOTSTRAP_ADDRESS --consumer.config /home/ec2-user/kafka/config/client-config.properties --from-beginning --topic salesdb.salesdb.SALES_ORDER | jq --color-output .</span></pre><p id="28fb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在另一个终端中，使用MySQL客户端连接到Aurora数据库并插入几条记录:</p><pre class="lc ld le lf gt oq or os ot aw ou bi"><span id="0e09" class="oe mu iq or b gy ov ow l ox oy">sudo -u ec2-user -i</span><span id="2f21" class="oe mu iq or b gy oz ow l ox oy">export RDS_AURORA_ENDPOINT=&lt;ENTER RDS MySQL ENDPOINT&gt;</span><span id="6714" class="oe mu iq or b gy oz ow l ox oy">mysql -f -u master -h $RDS_AURORA_ENDPOINT  --password=S3cretPwd99</span><span id="ef63" class="oe mu iq or b gy oz ow l ox oy">USE salesdb;</span><span id="71f5" class="oe mu iq or b gy oz ow l ox oy">select * from SALES_ORDER limit 5;</span><span id="d705" class="oe mu iq or b gy oz ow l ox oy">INSERT INTO SALES_ORDER (ORDER_ID, SITE_ID, ORDER_DATE, SHIP_MODE) VALUES (29001, 2568, now(), 'STANDARD');<br/>INSERT INTO SALES_ORDER (ORDER_ID, SITE_ID, ORDER_DATE, SHIP_MODE) VALUES (29002, 1649, now(), 'ONE-DAY');<br/>INSERT INTO SALES_ORDER (ORDER_ID, SITE_ID, ORDER_DATE, SHIP_MODE) VALUES (29003, 3861, now(), 'TWO-DAY');<br/>INSERT INTO SALES_ORDER (ORDER_ID, SITE_ID, ORDER_DATE, SHIP_MODE) VALUES (29004, 2568, now(), 'STANDARD');<br/>INSERT INTO SALES_ORDER (ORDER_ID, SITE_ID, ORDER_DATE, SHIP_MODE) VALUES (29005, 1649, now(), 'ONE-DAY');<br/>INSERT INTO SALES_ORDER (ORDER_ID, SITE_ID, ORDER_DATE, SHIP_MODE) VALUES (29006, 3861, now(), 'TWO-DAY');</span></pre><p id="f54e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果一切都设置正确，您应该在消费者终端中看到记录。</p><pre class="lc ld le lf gt oq or os ot aw ou bi"><span id="7eaf" class="oe mu iq or b gy ov ow l ox oy">{<br/>  "ORDER_ID": 29001,<br/>  "SITE_ID": 2568,<br/>  "ORDER_DATE": 1655279536000,<br/>  "SHIP_MODE": "STANDARD"<br/>}<br/>{<br/>  "ORDER_ID": 29002,<br/>  "SITE_ID": 1649,<br/>  "ORDER_DATE": 1655279536000,<br/>  "SHIP_MODE": "ONE-DAY"<br/>}<br/>{<br/>  "ORDER_ID": 29003,<br/>  "SITE_ID": 3861,<br/>  "ORDER_DATE": 1655279563000,<br/>  "SHIP_MODE": "TWO-DAY"<br/>}<br/>...</span></pre><p id="9f8b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">压缩变更事件有效负载的秘密</strong></p><p id="80ef" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请注意变更数据捕获事件负载有多紧凑。这是因为我们将连接器配置为使用Kafka <a class="ae lr" href="https://kafka.apache.org/documentation/#connect_transforms" rel="noopener ugc nofollow" target="_blank">单消息转换</a> (SMT)的<code class="fe pg ph pi or b">io.debezium.transforms.ExtractNewRecordState</code>。默认情况下，Debezium的变更事件结构非常复杂——除了变更事件，它还包括元数据，如模式、源数据库信息等。它看起来像这样:</p><pre class="lc ld le lf gt oq or os ot aw ou bi"><span id="23d0" class="oe mu iq or b gy ov ow l ox oy">{<br/>  "before": null,<br/>  "after": {<br/>    "ORDER_ID": 29003,<br/>    "SITE_ID": 3861,<br/>    "ORDER_DATE": 1655279563000,<br/>    "SHIP_MODE": "TWO-DAY"<br/>  },<br/>  "source": {<br/>    "version": "1.9.0.Final",<br/>    "connector": "mysql",<br/>    "name": "salesdb",<br/>    "ts_ms": 1634569283000,<br/>    "snapshot": "false",<br/>    "db": "salesdb",<br/>    "sequence": null,<br/>    "table": "SALES_ORDER",<br/>    "server_id": 1733046080,<br/>    "gtid": null,<br/>    "file": "mysql-bin-changelog.000003",<br/>    "pos": 43275145,<br/>    "row": 0,<br/>    "thread": null,<br/>    "query": null<br/>  },<br/>  "op": "c",<br/>  "ts_ms": 1655279563000,<br/>  "transaction": null<br/>...</span></pre><p id="df84" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">多亏了Kafka SMT(使用<code class="fe pg ph pi or b">transforms.unwrap.type=io.debezium.transforms.ExtractNewRecordState</code>指定)，我们可以有效地<code class="fe pg ph pi or b">flatten</code>事件有效负载，并根据我们的需求定制它。</p><blockquote class="pa pb pc"><p id="6008" class="kf kg ls kh b ki kj jr kk kl km ju kn pd kp kq kr pe kt ku kv pf kx ky kz la ij bi translated"><em class="iq">详见Debezium文档中的</em> <a class="ae lr" href="https://debezium.io/documentation/reference/stable/transformations/event-flattening.html" rel="noopener ugc nofollow" target="_blank"> <em class="iq">新记录状态提取</em> </a> <em class="iq">。</em></p></blockquote></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><h1 id="7cb4" class="mt mu iq bd mv mw pk my mz na pl nc nd jw pm jx nf jz pn ka nh kc po kd nj nk bi translated">数据管道第2部分:MSK到DynamoDB</h1><p id="820a" class="pw-post-body-paragraph kf kg iq kh b ki nl jr kk kl nm ju kn ko nn kq kr ks no ku kv kw np ky kz la ij bi translated">现在，我们可以将注意力转移到管道的后半部分，在DynamoDB Sink连接器的帮助下，该部分负责将数据从MSK主题传递到DynamoDB表。</p><p id="fe57" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果DynamoDB表不存在，连接器会自动为您创建一个，但它使用默认设置，即在<a class="ae lr" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/HowItWorks.ReadWriteCapacityMode.html#HowItWorks.ProvisionedThroughput.Manual" rel="noopener ugc nofollow" target="_blank">配置模式</a>下创建一个表，其中包含<code class="fe pg ph pi or b">10</code>读取容量单元(rcu)和<code class="fe pg ph pi or b">10</code>写入容量单元(wcu)。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi ms"><img src="../Images/a333e12ea1773f5c78e7a366f1d73133.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TQsYHqjgNs71Re6n.png"/></div></div></figure><p id="5e69" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是您的用例可能需要一个配置。例如，为了处理大量数据，您可能想要配置<a class="ae lr" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/AutoScaling.html" rel="noopener ugc nofollow" target="_blank">自动缩放</a>，或者更好的是，为您的表激活<a class="ae lr" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/HowItWorks.ReadWriteCapacityMode.html#HowItWorks.OnDemand" rel="noopener ugc nofollow" target="_blank">按需模式</a>。</p><p id="066b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这正是我们要做的。</p><h2 id="4b30" class="oe mu iq bd mv of og dn mz oh oi dp nd ko oj ok nf ks ol om nh kw on oo nj op bi translated">在继续之前，创建一个DynamoDB表</h2><p id="7b76" class="pw-post-body-paragraph kf kg iq kh b ki nl jr kk kl nm ju kn ko nn kq kr ks no ku kv kw np ky kz la ij bi translated">使用以下设置:</p><ul class=""><li id="446e" class="nq nr iq kh b ki kj kl km ko ns ks nt kw nu la nv nw nx ny bi translated">表名— <code class="fe pg ph pi or b">kafka_salesdb.salesdb.SALES_ORDER</code>(不要<em class="ls">而要</em>改变表名)</li><li id="f279" class="nq nr iq kh b ki nz kl oa ko ob ks oc kw od la nv nw nx ny bi translated">分区键— <code class="fe pg ph pi or b">ORDER_ID</code>(数字)</li><li id="66cc" class="nq nr iq kh b ki nz kl oa ko ob ks oc kw od la nv nw nx ny bi translated">范围键— <code class="fe pg ph pi or b">SITE_ID</code>(数字)</li><li id="3155" class="nq nr iq kh b ki nz kl oa ko ob ks oc kw od la nv nw nx ny bi translated">容量模式—按需</li></ul><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi ms"><img src="../Images/b7d34a659bca5998f35bd133ddd17fd8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*cV9a_p3pIs49erSO.png"/></div></div></figure><p id="9bb2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就这样，你可以走了！</p><h2 id="37b2" class="oe mu iq bd mv of og dn mz oh oi dp nd ko oj ok nf ks ol om nh kw on oo nj op bi translated">创建自定义插件和连接器</h2><blockquote class="pa pb pc"><p id="b364" class="kf kg ls kh b ki kj jr kk kl km ju kn pd kp kq kr pe kt ku kv pf kx ky kz la ij bi translated"><em class="iq">有关如何创建MSK连接插件的分步说明，请参考官方文档中的</em> <a class="ae lr" href="https://docs.aws.amazon.com/msk/latest/developerguide/msk-connect-plugins.html" rel="noopener ugc nofollow" target="_blank"> <em class="iq">使用AWS管理控制台</em> </a> <em class="iq">创建自定义插件。</em></p></blockquote><p id="de93" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建自定义插件时，确保选择您在上一步上传到<code class="fe pg ph pi or b">S3</code>的DynamoDB连接器zip文件。</p><blockquote class="pa pb pc"><p id="3b75" class="kf kg ls kh b ki kj jr kk kl km ju kn pd kp kq kr pe kt ku kv pf kx ky kz la ij bi translated"><em class="iq">关于如何创建MSK连接连接器的逐步说明，请参考官方文档中的</em> <a class="ae lr" href="https://docs.aws.amazon.com/msk/latest/developerguide/msk-connect-connectors.html#mkc-create-connector-intro" rel="noopener ugc nofollow" target="_blank"> <em class="iq">创建连接器</em> </a> <em class="iq">。</em></p></blockquote><p id="cb95" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要创建连接器:</p><ol class=""><li id="618b" class="nq nr iq kh b ki kj kl km ko ns ks nt kw nu la pj nw nx ny bi translated">选择您刚刚创建的插件。</li><li id="582d" class="nq nr iq kh b ki nz kl oa ko ob ks oc kw od la pj nw nx ny bi translated">输入连接器名称，并选择MSK集群和IAM身份验证</li><li id="f346" class="nq nr iq kh b ki nz kl oa ko ob ks oc kw od la pj nw nx ny bi translated">您可以在连接器配置部分输入下面提供的内容。确保根据您的设置替换以下配置:</li></ol><ul class=""><li id="4e72" class="nq nr iq kh b ki kj kl km ko ns ks nt kw nu la nv nw nx ny bi translated">为<code class="fe pg ph pi or b">topics</code>属性使用正确的主题名称(在本例中我们使用<code class="fe pg ph pi or b">salesdb.salesdb.SALES_ORDER</code>，因为这是Debezium source connector采用的主题名称格式)</li><li id="8d75" class="nq nr iq kh b ki nz kl oa ko ob ks oc kw od la nv nw nx ny bi translated">对于<code class="fe pg ph pi or b">confluent.topic.bootstrap.servers</code>，输入MSK集群端点</li><li id="c56c" class="nq nr iq kh b ki nz kl oa ko ob ks oc kw od la nv nw nx ny bi translated">对于<code class="fe pg ph pi or b">aws.dynamodb.endpoint</code>和<code class="fe pg ph pi or b">aws.dynamodb.region</code>，输入您创建DynamoDB表的地区，例如<code class="fe pg ph pi or b">us-east-1</code></li></ul><blockquote class="pa pb pc"><p id="6ce3" class="kf kg ls kh b ki kj jr kk kl km ju kn pd kp kq kr pe kt ku kv pf kx ky kz la ij bi translated"><em class="iq">保持其余配置不变</em></p></blockquote><pre class="lc ld le lf gt oq or os ot aw ou bi"><span id="484a" class="oe mu iq or b gy ov ow l ox oy">connector.class=io.confluent.connect.aws.dynamodb.DynamoDbSinkConnector<br/>tasks.max=2<br/>aws.dynamodb.region=&lt;ENTER AWS REGION e.g. us-east-1&gt;<br/>aws.dynamodb.endpoint=https://dynamodb.&lt;ENTER AWS REGION&gt;.amazonaws.com<br/>topics=salesdb.salesdb.SALES_ORDER<br/>value.converter.schemas.enable=false<br/>key.converter=org.apache.kafka.connect.storage.StringConverter<br/>value.converter=org.apache.kafka.connect.json.JsonConverter<br/>table.name.format=kafka_${topic}<br/>confluent.topic.bootstrap.servers=&lt;ENTER MSK CLUSTER ENDPOINT&gt;<br/>confluent.topic.security.protocol=SASL_SSL<br/>confluent.topic.sasl.mechanism=AWS_MSK_IAM<br/>confluent.topic.sasl.jaas.config=software.amazon.msk.auth.iam.IAMLoginModule required;<br/>confluent.topic.sasl.client.callback.handler.class=software.amazon.msk.auth.iam.IAMClientCallbackHandler<br/>aws.dynamodb.pk.hash=value.ORDER_ID<br/>aws.dynamodb.pk.sort=value.SITE_ID</span></pre><ol class=""><li id="fbc9" class="nq nr iq kh b ki kj kl km ko ns ks nt kw nu la pj nw nx ny bi translated">在<strong class="kh ir">访问权限</strong>下，为连接器选择正确的IAM角色(名称中带有<code class="fe pg ph pi or b">DynamoDBConnectorIAMRole</code>的角色)</li><li id="7509" class="nq nr iq kh b ki nz kl oa ko ob ks oc kw od la pj nw nx ny bi translated">点击<strong class="kh ir">下一步</strong>进入<strong class="kh ir">安全</strong>选项——保持不变</li><li id="b104" class="nq nr iq kh b ki nz kl oa ko ob ks oc kw od la pj nw nx ny bi translated">点击下一个的<strong class="kh ir">。对于<strong class="kh ir">日志交付</strong>，选择<strong class="kh ir">交付到亚马逊云观察日志</strong>。找到并选择<code class="fe pg ph pi or b">/msk-connect-demo-cwlog-group</code></strong></li><li id="069e" class="nq nr iq kh b ki nz kl oa ko ob ks oc kw od la pj nw nx ny bi translated">点击<strong class="kh ir">下一个</strong> —在最后一页，向下滚动并点击<strong class="kh ir">创建连接器</strong>以启动该过程并等待连接器启动。</li></ol><p id="d147" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">完成后，连接器转换到<strong class="kh ir">运行</strong>状态，继续以下步骤。</p><p id="e65c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">选择DynamoDB主键</strong></p><p id="afb2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在上述配置中，我们将<code class="fe pg ph pi or b">aws.dynamodb.pk.hash</code>和<code class="fe pg ph pi or b">aws.dynamodb.pk.sort</code>分别设置为<code class="fe pg ph pi or b">value.ORDER_ID</code>和<code class="fe pg ph pi or b">value.SITE_ID</code>。这意味着Kafka主题事件有效负载中的<code class="fe pg ph pi or b">ORDER_ID</code>字段将被用作分区键，而<code class="fe pg ph pi or b">SITE_ID</code>的值将被指定为范围键(根据您的需求，您也可以将<code class="fe pg ph pi or b">aws.dynamodb.pk.sort</code>留空)。</p><h1 id="e6bf" class="mt mu iq bd mv mw mx my mz na nb nc nd jw ne jx nf jz ng ka nh kc ni kd nj nk bi translated">测试端到端管道</h1><p id="1741" class="pw-post-body-paragraph kf kg iq kh b ki nl jr kk kl nm ju kn ko nn kq kr ks no ku kv kw np ky kz la ij bi translated">作为初始加载过程的一部分，连接器确保Kafka topic中的所有现有记录都被持久化到连接器配置中指定的DynamoDB表中。在这种情况下，您应该在DynamoDB中看到不止<code class="fe pg ph pi or b">29000</code>条记录(根据<code class="fe pg ph pi or b">SALES_ORDER</code>表),并且您可以运行查询来浏览数据。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi ms"><img src="../Images/d1e54cedea1379bc4e621c0053ab62ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fbmeHe3f5pBUljw9.png"/></div></div></figure><p id="74b1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了继续测试端到端管道，您可以在<code class="fe pg ph pi or b">SALES_ORDER</code>表中插入更多数据，并确认它们通过Debezium source连接器同步到Kafka，并通过sink连接器同步到DynamoDB。</p></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><h1 id="9017" class="mt mu iq bd mv mw pk my mz na pl nc nd jw pm jx nf jz pn ka nh kc po kd nj nk bi translated">删除资源</h1><p id="dbcc" class="pw-post-body-paragraph kf kg iq kh b ki nl jr kk kl nm ju kn ko nn kq kr ks no ku kv kw np ky kz la ij bi translated">完成后，删除您创建的资源。</p><ul class=""><li id="d672" class="nq nr iq kh b ki kj kl km ko ns ks nt kw nu la nv nw nx ny bi translated">删除S3桶的内容(<code class="fe pg ph pi or b">msk-lab-&lt;YOUR ACCOUNT_ID&gt;-plugins-bucket</code>)</li><li id="49e3" class="nq nr iq kh b ki nz kl oa ko ob ks oc kw od la nv nw nx ny bi translated">删除云形成堆栈</li><li id="a64f" class="nq nr iq kh b ki nz kl oa ko ob ks oc kw od la nv nw nx ny bi translated">删除DynamoDB表</li><li id="e581" class="nq nr iq kh b ki nz kl oa ko ob ks oc kw od la nv nw nx ny bi translated">删除MSK连接连接器、插件和自定义配置</li></ul><h1 id="ad47" class="mt mu iq bd mv mw mx my mz na nb nc nd jw ne jx nf jz ng ka nh kc ni kd nj nk bi translated">结论和总结</h1><p id="aff9" class="pw-post-body-paragraph kf kg iq kh b ki nl jr kk kl nm ju kn ko nn kq kr ks no ku kv kw np ky kz la ij bi translated">变更数据捕获是一个强大的工具，但我们需要一种方法来利用这些事件日志，并使其对依赖于该数据的其他服务可用。在这一部分中，您看到了我们如何利用这一功能，使用Kafka Connect在MySQL和DynamoDB之间建立流数据管道。</p><p id="33cd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是本系列的一个总结，以后还会有更多(当然！).快乐大厦！</p></div></div>    
</body>
</html>