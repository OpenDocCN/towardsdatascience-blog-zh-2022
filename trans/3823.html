<html>
<head>
<title>Scaling Hamilton with Ray in 5 minutes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用雷在5分钟内爬上汉密尔顿</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/scaling-hamilton-with-ray-in-5-minutes-3beb1755fc09#2022-08-24">https://towardsdatascience.com/scaling-hamilton-with-ray-in-5-minutes-3beb1755fc09#2022-08-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e6c9" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">扩展数据转换中人的方面以及计算方面</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/d0a9af8f9c3a489f83054b78244d4bb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yCcqdQ5YG2W0MXG0V43ldg.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Hamilton + Ray —帮助您扩大产量。托马斯·凯利在<a class="ae kv" href="https://unsplash.com/s/photos/efficiency?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片。</p></figure><p id="1bbf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://github.com/DAGWorks-Inc/hamilton" rel="noopener ugc nofollow" target="_blank"> Hamilton </a>是一个用于Python的开源、声明性数据流微框架。在这篇文章中，我将解释通过利用汉密尔顿的光线集成来扩展用于汉密尔顿工作流的数据和CPU的要求。这篇文章假设读者事先熟悉什么是汉密尔顿。对于背景故事和更长的介绍，我们邀请你阅读这个<a class="ae kv" rel="noopener" target="_blank" href="/functions-dags-introducing-hamilton-a-microframework-for-dataframe-generation-more-8e34b84efc1d"> TDS帖子</a>，或者对于更短的五分钟介绍见这个<a class="ae kv" rel="noopener" target="_blank" href="/how-to-use-hamilton-with-pandas-in-5-minutes-89f63e5af8f5"> TDS帖子</a>，或者对于它如何帮助规模团队&amp;保持他们的代码库有组织见<a class="ae kv" rel="noopener" target="_blank" href="/tidy-production-pandas-with-hamilton-3b759a2bf562">这个TDS帖子</a>。</p><p id="953e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于那些不熟悉<a class="ae kv" href="https://ray.io/" rel="noopener ugc nofollow" target="_blank"> Ray </a>的人来说，它是一个开源框架，可以扩展来自<a class="ae kv" href="https://rise.cs.berkeley.edu/projects/ray/" rel="noopener ugc nofollow" target="_blank">加州大学伯克利分校</a>的python应用。它有一个不断增长的工具生态系统，可以帮助许多机器学习相关的工作流。例如，它将自己标榜为使您能够非常容易地从笔记本电脑扩展到集群，而无需更改太多代码。就现实世界的使用而言，我喜欢使用Ray作为在python 中实现<a class="ae kv" href="https://machinelearningmastery.com/multiprocessing-in-python/" rel="noopener ugc nofollow" target="_blank">多重处理的一种非常快速的方式，而不用担心细节！</a></p><h1 id="08b5" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">射线底漆</h1><p id="97c8" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">这里有一个射线引物。好消息是，你不需要了解太多关于雷的知识就可以和汉密尔顿一起使用它。你只需要知道<strong class="ky ir">它将轻松地在多个CPU内核上并行化你的工作流</strong>，并允许你<strong class="ky ir">扩展到你的笔记本电脑之外</strong>，如果你设置了一个Ray集群的话。但是为了让你理解汉密尔顿是如何与它联系起来的，让我们快速回顾一下如何使用雷。</p><h2 id="3e45" class="mp lt iq bd lu mq mr dn ly ms mt dp mc lf mu mv me lj mw mx mg ln my mz mi na bi translated">光线使用前提</h2><p id="a7ab" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">使用Ray的基本前提是，您必须注释您希望通过Ray调度执行的函数。例如(从<a class="ae kv" href="https://docs.ray.io/en/latest/ray-core/tasks.html#ray-remote-functions" rel="noopener ugc nofollow" target="_blank">他们的文档</a>):</p><pre class="kg kh ki kj gt nb nc nd ne aw nf bi"><span id="64af" class="mp lt iq nc b gy ng nh l ni nj"><em class="nk"># This is a regular Python function.</em><br/>def normal_function():<br/>    return 1<br/><br/><br/><em class="nk"># By adding the `@ray.remote` decorator, a regular Python function</em><br/><em class="nk"># becomes a Ray remote function.</em><br/>@ray.remote<br/>def my_ray_function():<br/>    return 1</span></pre><p id="abc9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后要执行<code class="fe nl nm nn nc b">my_ray_function</code>函数，您应该做:</p><pre class="kg kh ki kj gt nb nc nd ne aw nf bi"><span id="2290" class="mp lt iq nc b gy ng nh l ni nj">my_ray_function.remote()</span></pre><p id="6f67" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后它会告诉Ray调度函数的执行。要在本地运行而不是在集群上运行，您所要做的就是在调用上面的代码之前以不同的方式实例化“Ray”。</p><pre class="kg kh ki kj gt nb nc nd ne aw nf bi"><span id="f1e5" class="mp lt iq nc b gy ng nh l ni nj">import ray<br/>ray.init() # local execution over multiple cores.<br/>ray.init({... cluster details ...}) # connect to cluster.</span></pre><p id="7402" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，🤔，您可能会想，要让我现有的代码运行起来，似乎需要做很多工作，例如，我如何向函数传递参数？我应该如何更改我的应用程序以更好地使用Ray？等等。好消息！和汉密尔顿在一起你根本不用考虑这些！您只需编写您的标准Hamilton函数，只需更改一些“<em class="nk"> driver </em>”代码就可以让它在Ray上运行。下一节将详细介绍这一点。</p><h1 id="d7fa" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">汉密尔顿+雷</h1><p id="6c8b" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">要将Ray与Hamilton一起使用，首先需要安装它。</p><pre class="kg kh ki kj gt nb nc nd ne aw nf bi"><span id="bfb5" class="mp lt iq nc b gy ng nh l ni nj">pip install "sf-hamilton[ray]"</span></pre><p id="d30d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，默认情况下使用Hamilton，所有的逻辑都写成python函数。所以你可以像平常一样写哈密顿函数。这里没有变化。</p><p id="7420" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在执行时，在Hamilton框架级别，Hamilton可以很容易地为您的函数定义的有向无环图(DAG)中的每个函数注入<code class="fe nl nm nn nc b">@ray.remote</code>。重申一下<em class="nk">，你不需要修改任何Hamilton代码来使用Ray！</em>要让Hamilton在Ray上运行，你需要做的就是提供一个"<code class="fe nl nm nn nc b"><em class="nk">GraphAdapter</em></code><em class="nk"/>对象给Hamilton "<code class="fe nl nm nn nc b"><em class="nk">Driver</em></code><em class="nk"/>类你实例化。</p><p id="f012" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一个<code class="fe nl nm nn nc b">GraphAdapter</code>，只是一个简单的类，它定义了一些函数，使您能够增加DAG的遍历和执行方式。更多信息见文件<a class="ae kv" href="https://hamilton.readthedocs.io/en/latest/reference/api-reference/graph-adapters.html" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="2300" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">就要添加/更改的代码而言，以下是增加标准Hamilton驱动程序代码所需的内容—参见<strong class="ky ir"> bold </strong> font:</p><pre class="kg kh ki kj gt nb nc nd ne aw nf bi"><span id="d805" class="mp lt iq nc b gy ng nh l ni nj">import ray<br/>from hamilton import <strong class="nc ir">base</strong>, driver<br/><strong class="nc ir">from hamilton.experimental import h_ray</strong></span><span id="7bea" class="mp lt iq nc b gy no nh l ni nj">...</span><span id="fab0" class="mp lt iq nc b gy no nh l ni nj"><strong class="nc ir">ray.init() # instantiate Ray</strong><br/>config = {...} # instantiate your config<br/>modules = [...] # provide modules where your Hamilton functions live<br/><strong class="nc ir">rga = h_ray.RayGraphAdapter( # object to tell Hamilton to run on Ray<br/>     result_builder=base.PandasDataFrameResult())  </strong>  <br/>dr = driver.Driver(config, *modules, <strong class="nc ir">adapter=rga</strong>) <strong class="nc ir"># tell Hamilton</strong><br/>df = dr.execute([...]) # execute Hamilton as you normally would<br/><strong class="nc ir">ray.shutdown()</strong></span></pre><p id="4a40" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于那些不熟悉Hamilton的人来说，如果您要删除加粗的代码，这就是您运行开箱即用的普通Hamilton的方式。</p><p id="b72d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">具体来说，我们需要:</p><ol class=""><li id="eea1" class="np nq iq ky b kz la lc ld lf nr lj ns ln nt lr nu nv nw nx bi translated">实例化射线:<code class="fe nl nm nn nc b">ray.init()</code>。</li><li id="03ae" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">实例化一个<code class="fe nl nm nn nc b">RayGraphAdapter</code>，传入一个<code class="fe nl nm nn nc b">ResultBuilder</code>对象，该对象设置当在<code class="fe nl nm nn nc b">driver.Driver</code>对象上调用<code class="fe nl nm nn nc b">.execute()</code>时返回什么对象类型。在这个例子中，我们指定它应该返回一个熊猫数据帧。</li><li id="1556" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">然后在创建<code class="fe nl nm nn nc b">driver.Driver</code>对象时，<code class="fe nl nm nn nc b">RayGraphAdapter</code>作为关键字参数<code class="fe nl nm nn nc b">adapter=rga</code>被传递，这将告诉Hamilton增加DAG的行走并使用Ray。</li><li id="f329" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">不需要其他的改变，所以在你完成之后，你只需要关闭你和Ray <code class="fe nl nm nn nc b">ray.shutdown()</code>的连接。</li></ol><h2 id="4719" class="mp lt iq bd lu mq mr dn ly ms mt dp mc lf mu mv me lj mw mx mg ln my mz mi na bi translated">缩放就是这么简单！</h2><p id="644f" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">通过添加几行代码，您现在可以:</p><ol class=""><li id="a320" class="np nq iq ky b kz la lc ld lf nr lj ns ln nt lr nu nv nw nx bi translated">并行计算您的哈密尔顿函数。</li><li id="0f43" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">扩展到在集群规模数据上运行。</li></ol><p id="f934" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">概括一下，使用Ray和Hamilton的方法与使用普通的Hamilton没有太大的不同:</p><ol class=""><li id="4282" class="np nq iq ky b kz la lc ld lf nr lj ns ln nt lr nu nv nw nx bi translated">装汉密尔顿+雷。<code class="fe nl nm nn nc b">pip install "sf-hamilton[ray]"</code>。</li><li id="8e37" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">写哈密尔顿函数。</li><li id="843a" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">编写你的驱动程序代码——如果你想让它在Ray上运行，调整这个部分。</li><li id="fffd" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">执行你的驱动脚本。</li></ol><p id="2a05" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由于切换到使用Ray或不使用Ray是如此容易，我们很想知道切换到Ray会在多大程度上提高数据流操作的速度或规模！</p><p id="34a4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要获得完整的“Ray Hello World”代码示例，我们会将您引向这里的<a class="ae kv" href="https://github.com/stitchfix/hamilton/tree/main/examples/ray/hello_world" rel="noopener ugc nofollow" target="_blank">示例目录</a>。</p><h1 id="3520" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">最后</h1><p id="05a4" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">通过使用Hamilton，您可以组织和扩展编写数据转换的人的方面(<em class="nk">不，我在这篇文章中没有谈到这一点，请参见简介中的链接或下面的说服自己的链接</em>😉).借助Ray，您可以扩展您的数据工作流，以超越笔记本电脑的限制。一起，天空的极限！</p><p id="aa4e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您喜欢汉密尔顿，并希望继续关注该项目:</p><ol class=""><li id="19af" class="np nq iq ky b kz la lc ld lf nr lj ns ln nt lr nu nv nw nx bi translated">我们想要github上的<a class="ae kv" href="https://github.com/DAGWorks-Inc/hamilton" rel="noopener ugc nofollow" target="_blank">⭐️</a>！</li><li id="e8ed" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">📣加入我们在slack上的羽翼未丰的社区！</li><li id="7fd0" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">查看我们的文档📚。</li></ol><h1 id="6afb" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">警告</h1><p id="f4de" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">关于使用Hamilton + Ray的注意事项。</p><ol class=""><li id="955e" class="np nq iq ky b kz la lc ld lf nr lj ns ln nt lr nu nv nw nx bi translated">我们希望从“<em class="nk">”实验“</em>”中获得射线支持，但为此我们需要您的反馈！该API一直非常稳定(自发布以来一直没有改变)，但为了让它永久化，我们很想知道你的想法。</li><li id="6b1b" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">我们不会公开Ray的所有功能，但是我们可以。例如存储器感知调度或为特定功能指定资源。如果你想曝光什么，请告诉我们——请在github上发表一篇文章——<a class="ae kv" href="https://github.com/DAGWorks-Inc/hamilton" rel="noopener ugc nofollow" target="_blank">https://github.com/dagworks-inc/hamilton</a>🙏。</li></ol><h1 id="8005" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">相关职位</h1><p id="32fe" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">有关汉密尔顿的更多信息，我们邀请您查看:</p><ul class=""><li id="f090" class="np nq iq ky b kz la lc ld lf nr lj ns ln nt lr od nv nw nx bi translated"><a class="ae kv" rel="noopener" target="_blank" href="/functions-dags-introducing-hamilton-a-microframework-for-dataframe-generation-more-8e34b84efc1d">介绍汉密尔顿</a></li><li id="0b93" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr od nv nw nx bi translated"><a class="ae kv" rel="noopener" target="_blank" href="/how-to-use-hamilton-with-pandas-in-5-minutes-89f63e5af8f5">5分钟内汉密尔顿+熊猫</a></li><li id="7b9c" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr od nv nw nx bi translated"><a class="ae kv" rel="noopener" target="_blank" href="/how-to-iterate-with-hamilton-in-a-notebook-8ec0f85851ed">在笔记本上与汉密尔顿迭代</a></li><li id="b156" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr od nv nw nx bi translated"><a class="ae kv" rel="noopener" target="_blank" href="/tidy-production-pandas-with-hamilton-3b759a2bf562">与汉密尔顿一起整理生产熊猫</a></li><li id="236f" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr od nv nw nx bi translated">【未来邮报】5分钟内汉密尔顿+达斯克</li></ul></div></div>    
</body>
</html>