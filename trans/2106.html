<html>
<head>
<title>Analyzing and Plotting NFL Data with nfl-data-py and Plotly</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用nfl-data-py和Plotly分析和绘制NFL数据</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/analyzing-and-plotting-nfl-data-with-nflfastpy-and-plotly-a170a09cad6#2022-05-11">https://towardsdatascience.com/analyzing-and-plotting-nfl-data-with-nflfastpy-and-plotly-a170a09cad6#2022-05-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8a9a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用nfl-data-py从NFL比赛数据中创建可视化</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b42a1b52a2a38cfa5bd172982d5c1f12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Wm4WNWXyl3s1nR9q"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@naveenv92?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">纳文·文卡特桑</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="1b3f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我是旧金山49人队的超级粉丝，也是数据可视化的爱好者，所以我一直在寻找机会将体育数据与数据科学和分析相结合。对我们来说幸运的是，有一个名为<code class="fe lv lw lx ly b">nfl_data_py</code>的很棒的Python包，它允许我们提取NFL的详细数据并进行分析。在这篇文章中，我将使用<code class="fe lv lw lx ly b">nfl_data_py</code>引入数据，并使用<code class="fe lv lw lx ly b">plotly</code>创建两个传球码和达阵的可视化。</p><h2 id="0fd8" class="lz ma it bd mb mc md dn me mf mg dp mh li mi mj mk lm ml mm mn lq mo mp mq mr bi translated">获取详细数据</h2><p id="8b9c" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">开始之前，我们需要确保我们有分析所需的包。</p><pre class="kj kk kl km gt mx ly my mz aw na bi"><span id="d1c7" class="lz ma it ly b gy nb nc l nd ne">pip install pandas plotly nfl_data_py</span></pre><p id="6dd6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们导入我们的包并加载2021–22 NFL赛季的三个数据集:详细比赛数据、花名册数据和球队信息。</p><pre class="kj kk kl km gt mx ly my mz aw na bi"><span id="9657" class="lz ma it ly b gy nb nc l nd ne"># import packages<br/>import pandas as pd<br/>import plotly.graph_objects as go<br/>import nfl_data_py as nfl</span><span id="ed39" class="lz ma it ly b gy nf nc l nd ne"># load data<br/>df_2021 = nfl.import_pbp_data([2021])<br/>df_players = nfl.import_rosters([2021])<br/>df_teams = nfl.import_team_desc()</span></pre><p id="4ba0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们已经加载到<code class="fe lv lw lx ly b">df_2021</code>中的数据包含了来自NFL API的极其丰富的详细数据。举个例子，让我们打印出数据集中的列:</p><pre class="kj kk kl km gt mx ly my mz aw na bi"><span id="6dac" class="lz ma it ly b gy nb nc l nd ne"># print columns<br/>df_2021.columns</span><span id="e283" class="lz ma it ly b gy nf nc l nd ne">&gt;&gt; Index(['play_id', 'game_id', 'old_game_id', 'home_team', 'away_team',<br/>       'season_type', 'week', 'posteam', 'posteam_type', 'defteam',<br/>       ...<br/>       'out_of_bounds', 'home_opening_kickoff', 'qb_epa', 'xyac_epa',<br/>       'xyac_mean_yardage', 'xyac_median_yardage', 'xyac_success', 'xyac_fd',<br/>       'xpass', 'pass_oe'],<br/>      dtype='object', length=372)</span></pre><p id="4351" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们每部戏都有372个独特的栏目！数量如此之多，以至于在默认情况下不会全部打印出来-有了这个数据集，您可以进行的分析的可能性基本上是无限的。在这篇文章中，我们将检查传球码和达阵，所以我们必须先用<code class="fe lv lw lx ly b">pandas</code>做一点过滤，以得到我们想要的数据帧形式。</p><h2 id="98ec" class="lz ma it bd mb mc md dn me mf mg dp mh li mi mj mk lm ml mm mn lq mo mp mq mr bi translated">过滤数据以传递播放</h2><p id="b7b7" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">首先，当前的逐场比赛数据帧包含了常规赛和季后赛的所有比赛，所以我们将只过滤常规赛的比赛。</p><pre class="kj kk kl km gt mx ly my mz aw na bi"><span id="0f74" class="lz ma it ly b gy nb nc l nd ne"># filter to regular season<br/>df_2021 = df_2021[df_2021["season_type"] == "REG"]</span></pre><p id="3c0a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们必须处理的下一个微妙之处是过滤掉任何两点转换，因为这些码对整体统计数据没有贡献。幸运的是，有一个名为<code class="fe lv lw lx ly b">two_point_attempt</code>的布尔列，我们可以直接使用它来完成这项工作。</p><pre class="kj kk kl km gt mx ly my mz aw na bi"><span id="ea64" class="lz ma it ly b gy nb nc l nd ne"># remove two point attempts<br/>df_2021 = df_2021[df_2021["two_point_attempt"] == False]</span></pre><p id="4dc2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，自然地，由于我们对传球统计感兴趣，我们可以额外过滤掉传球。同样，我们有一个名为<code class="fe lv lw lx ly b">play_type</code>的键，可以用来过滤传球。希望现在你开始看到<code class="fe lv lw lx ly b">nfl_data_py</code>向我们展示的高粒度的力量。</p><pre class="kj kk kl km gt mx ly my mz aw na bi"><span id="1641" class="lz ma it ly b gy nb nc l nd ne"># filter to pass plays<br/>df_2021 = df_2021[df_2021["play_type"] == "pass"]</span></pre><p id="c0e4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在应该有了所有感兴趣的剧本供我们分析。现在，我们需要将过滤后的数据帧与花名册和球队数据连接起来，为我们的绘图获取球员姓名和球队颜色。</p><h2 id="fa88" class="lz ma it bd mb mc md dn me mf mg dp mh li mi mj mk lm ml mm mn lq mo mp mq mr bi translated">获取球员姓名和球队颜色</h2><p id="2469" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">由<code class="fe lv lw lx ly b">import_pbp_data([2021])</code>返回的数据不包括任何玩家名字，但是我们有玩家id的列。此外，我们为传球、抢球和接球的球员id设置了单独的列，这样我们可以更好地控制从花名册中提取的球员姓名。在这种情况下，因为我们正在进行传递分析，所以我们将使用列<code class="fe lv lw lx ly b">passer_player_id</code>。</p><p id="f755" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们加载的玩家表中，我们看到有以下几列:</p><pre class="kj kk kl km gt mx ly my mz aw na bi"><span id="a661" class="lz ma it ly b gy nb nc l nd ne">df_players.columns</span><span id="f5b7" class="lz ma it ly b gy nf nc l nd ne">&gt;&gt; Index(['season', 'team', 'position', 'depth_chart_position', 'jersey_number',<br/>       'status', 'player_name', 'first_name', 'last_name', 'birth_date',<br/>       'height', 'weight', 'college', 'player_id', 'espn_id', 'sportradar_id',<br/>       'yahoo_id', 'rotowire_id', 'pff_id', 'pfr_id', 'fantasy_data_id',<br/>       'sleeper_id', 'years_exp', 'headshot_url', 'ngs_position', 'week',<br/>       'game_type', 'status_description_abbr', 'football_name', 'esb_id',<br/>       'gsis_it_id', 'smart_id', 'entry_year', 'rookie_year', 'draft_club',<br/>       'draft_number'],<br/>      dtype='object')</span></pre><p id="f57d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们看到我们可以得到感兴趣的球员的<code class="fe lv lw lx ly b">player_name</code>。对于玩家ID，我们将加入到<code class="fe lv lw lx ly b">player_id</code>栏中以获得正确的匹配。</p><pre class="kj kk kl km gt mx ly my mz aw na bi"><span id="e8dd" class="lz ma it ly b gy nb nc l nd ne"># join with the roster table to get player names<br/>df_2021 = df_2021.merge(df_players[["player_id", "player_name"]], left_on="passer_player_id", right_on="player_id")</span></pre><p id="08ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了确保我们的连接有效，让我们检查一下<code class="fe lv lw lx ly b">player_name </code>的值现在是否出现在我们的原始数据帧中。</p><pre class="kj kk kl km gt mx ly my mz aw na bi"><span id="0090" class="lz ma it ly b gy nb nc l nd ne">df_2021["player_name"].unique()</span><span id="26ad" class="lz ma it ly b gy nf nc l nd ne">&gt;&gt; array(['Ryan Tannehill', 'Kyler Murray', 'Matthias Farley', 'Derek Carr',<br/>       'Lamar Jackson', 'Andy Dalton', 'Justin Fields',<br/>       'Matthew Stafford', 'Baker Mayfield', 'Patrick Mahomes',<br/>       'Tom Brady', 'Dak Prescott', 'Daniel Jones', 'Teddy Bridgewater',<br/>       'Jameis Winston', 'Aaron Rodgers', 'Taysom Hill', 'Jordan Love',<br/>       'Tyrod Taylor', 'Trevor Lawrence', 'Justin Herbert',<br/>       'Ryan Fitzpatrick', 'Taylor Heinicke', 'Mac Jones',<br/>       'Tua Tagovailoa', 'Kirk Cousins', 'Joe Burrow', 'Justin Jefferson',<br/>       'Zach Wilson', 'Sam Darnold', 'Matt Ryan', 'Jalen Hurts',<br/>       'Josh Allen', 'Ben Roethlisberger', 'Carson Wentz',<br/>       'Russell Wilson', 'Jared Goff', 'Jimmy Garoppolo', 'Trey Lance',<br/>       'Josh Rosen', 'Jacoby Brissett', 'Davis Mills', 'Jacob Eason',<br/>       'Greg Ward', "D'Andre Swift", 'Mitchell Trubisky', 'Drew Lock',<br/>       'Ty Long', 'Jakobi Meyers', 'Geno Smith', 'Blaine Gabbert',<br/>       'Kadarius Toney', 'Mike Glennon', 'Cedrick Wilson',<br/>       'Cordarrelle Patterson', 'Case Keenum', 'Dawson Knox',<br/>       'Brandon Allen', 'John Wolford', 'Dante Pettis', 'Phillip Walker',<br/>       'Tyler Huntley', 'Jack Fox', 'Derrick Henry', 'Chad Henne',<br/>       'Kendrick Bourne', 'Mike White', 'Brian Hoyer', 'Tyler Boyd',<br/>       'Josh Johnson', 'Jamison Crowder', 'Cooper Rush', 'Rex Burkhead',<br/>       'Cole Beasley', 'Gardner Minshew', 'David Blough', 'Chris Boswell',<br/>       'Trevor Siemian', 'Leonard Fournette', 'A.J. Brown', 'Colt McCoy',<br/>       'Christian Kirk', 'C.J. Beathard', 'Danny Amendola',<br/>       'Ezekiel Elliott', 'Albert Wilson', 'Joe Flacco', 'Cam Newton',<br/>       'Chris Streveler', 'Mason Rudolph', 'Tommy Townsend',<br/>       'Johnny Hekker', 'Tim Boyle', 'Feleipe Franks', 'Blake Gillikin',<br/>       'Jarvis Landry', 'Cooper Kupp', 'Andy Lee', 'Keenan Allen',<br/>       'Kyle Allen', 'Riley Dixon', 'Deebo Samuel', 'Jake Fromm',<br/>       'Nick Mullens', 'Keelan Cole', 'Garrett Gilbert', 'Nick Foles',<br/>       'Ian Book', 'Chris Banjo', 'Stefon Diggs', 'Brett Rypien',<br/>       'Kendall Hinton', 'Marcus Mariota', 'Mike Gesicki', 'Sean Mannion',<br/>       'Kellen Mond', 'David Montgomery', 'Brandon Zylstra',<br/>       'Tom Kennedy', 'Courtland Sutton', 'Sam Koch', 'Odell Beckham',<br/>       'Travis Kelce', 'Bryan Anger', 'Joe Mixon'], dtype=object)</span></pre><p id="d120" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，我们现在有了2021-22 NFL赛季期间与传球相关联的所有球员姓名。我们已经完成了大部分——我们还想获得每个玩家的团队颜色，这样我们在绘图时就有了一个调色板。为此，我们可以使用我们也加载的teams数据集，它有一个名为<code class="fe lv lw lx ly b">team_color</code>的列。就我们将用于加入的键而言，我们可以使用逐场比赛数据中的列<code class="fe lv lw lx ly b">posteam</code>,它对应于比赛开始时拥有的球队。这是有道理的，因为传球的球队自然是控球的球队。teams表中对应的键是<code class="fe lv lw lx ly b">team_abbr</code>。因此，使用这些信息，我们可以加入提取团队的颜色。</p><pre class="kj kk kl km gt mx ly my mz aw na bi"><span id="0a08" class="lz ma it ly b gy nb nc l nd ne"># join with team table to get team color for plot<br/>df_2021 = df_2021.merge(df_teams[["team_abbr", "team_color"]], left_on="posteam", right_on="team_abbr")</span></pre><p id="0c35" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在拥有了绘制图表所需的一切—首先我们必须进行汇总，然后我们可以自由绘制数据。</p><h2 id="0278" class="lz ma it bd mb mc md dn me mf mg dp mh li mi mj mk lm ml mm mn lq mo mp mq mr bi translated">聚合和绘图</h2><p id="9048" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">我们想要创建的两个图将是球员传球码数和触地得分的累计总和。为了做到这一点，我们必须首先做一个汇总—我们当前的表只是一堆单独的游戏，但我们希望按周和按玩家得到总数。对于<code class="fe lv lw lx ly b">pandas</code>中的<code class="fe lv lw lx ly b">groupby()</code>和<code class="fe lv lw lx ly b">agg</code>来说，这是一个完美的用例，我们可以很容易地做到如下:</p><pre class="kj kk kl km gt mx ly my mz aw na bi"><span id="0545" class="lz ma it ly b gy nb nc l nd ne"># get total passing yards and touchdowns by week<br/>df_agg = (<br/>    df_2021.groupby(["player_name", "team_abbr", "team_color", "week"], as_index=False)<br/>    .agg({"passing_yards": "sum", "pass_touchdown": "sum"})<br/>)</span></pre><p id="6a7b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们过滤到特定的玩家，让我们看看我们的牌桌是什么样的:</p><pre class="kj kk kl km gt mx ly my mz aw na bi"><span id="c9cb" class="lz ma it ly b gy nb nc l nd ne">df_agg[df_agg["player_name"] == "Josh Allen"]</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/6fa416bb6cec967842fcab3d6b21d886.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UalwvxVlLdMxMrZ3FurmDg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图一。乔希·艾伦的每周统计——由作者提供的数据</p></figure><p id="480b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们有了每周的总数(还没有累计，但是我们以后会处理)，所以我们可以开始绘图了。</p><p id="1b69" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们首先绘制我们的传球码——为了做到这一点，我们将按球员姓名分组，然后在<code class="fe lv lw lx ly b">plotly</code>中将每个单独的组绘制为一条新的轨迹。我以前的一篇文章更详细地介绍了我们如何获得这些代码，所以如果你有任何问题，我可以参考一下。此外，我将只过滤总共投掷了&gt; 1500码的玩家。通过在绘图时使用<code class="fe lv lw lx ly b">cumsum()</code>,我也将得到我想要的累计总数。</p><pre class="kj kk kl km gt mx ly my mz aw na bi"><span id="2501" class="lz ma it ly b gy nb nc l nd ne">fig = go.Figure()</span><span id="447c" class="lz ma it ly b gy nf nc l nd ne">for name, values in df_agg.groupby("player_name"):<br/>    if values["passing_yards"].sum() &gt; 1500:<br/>        fig.add_trace(<br/>            go.Scatter(<br/>                x=values["week"], <br/>                y=values["passing_yards"].cumsum(), <br/>                name=name, <br/>                mode="markers+lines", <br/>                line_color=values.iloc[0].team_color,<br/>                hovertemplate=f"&lt;b&gt;{name}&lt;/b&gt;&lt;br&gt;%{{y}} yds through week %{{x}}&lt;extra&gt;&lt;/extra&gt;"<br/>            )<br/>        )<br/>    <br/>fig.update_layout(<br/>    font_family="Averta, sans-serif",<br/>    hoverlabel_font_family="Averta, sans-serif",<br/>    xaxis_title_text="Week",<br/>    xaxis_title_font_size=18,<br/>    xaxis_tickfont_size=16,<br/>    yaxis_title_text="Passing Yards",<br/>    yaxis_title_font_size=18,<br/>    yaxis_tickfont_size=16,<br/>    hoverlabel_font_size=16,<br/>    legend_font_size=16,<br/>    height=1000,<br/>    width=1000<br/>)<br/>    <br/>fig.show()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/85a041fcf63b03230e316dd6a469e5f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wJHYPifjINmDUqMn4SX6_g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图二。2021-22 NFL赛季期间累积传球码数-作者数据</p></figure><p id="74b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们可以使用类似的代码来传递触地得分，并获得一个累积图。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/57efa1c68edb6be87f9d0f60eb6347d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PsGO05gIGq-jNyRHyMWqMw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图3。2021-22 NFL赛季累计传球触地得分-作者数据</p></figure><p id="b5a1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它们就在那里——你可以看到获取NFL的比赛数据并进行很酷的数据分析和可视化是多么简单！</p><p id="8b7a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你想看看我用<code class="fe lv lw lx ly b">nfl_data_py</code>制作的其他信息图，你可以看看这个<a class="ae ky" href="https://github.com/venkatesannaveen/nfl-infographics" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>。</p><h2 id="9a62" class="lz ma it bd mb mc md dn me mf mg dp mh li mi mj mk lm ml mm mn lq mo mp mq mr bi translated">结论</h2><p id="ce85" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">我希望这篇文章有助于介绍如何使用<code class="fe lv lw lx ly b">nfl_data_py</code>处理NFL的比赛数据，并进行分析和可视化。用于生成本文中所有代码的笔记本可以在这个<a class="ae ky" href="https://github.com/venkatesannaveen/medium-articles" rel="noopener ugc nofollow" target="_blank"> GitHub资源库</a>中找到。如果想了解更多更新，也可以在<a class="ae ky" href="https://twitter.com/naveenv_92" rel="noopener ugc nofollow" target="_blank"> Twitter </a>和<a class="ae ky" href="https://www.linkedin.com/in/naveenvenkatesan" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>关注我。</p><h2 id="addc" class="lz ma it bd mb mc md dn me mf mg dp mh li mi mj mk lm ml mm mn lq mo mp mq mr bi translated">参考</h2><p id="7589" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">[1]<a class="ae ky" href="https://github.com/cooperdff/nfl_data_py" rel="noopener ugc nofollow" target="_blank">https://github.com/cooperdff/nfl_data_py</a></p></div></div>    
</body>
</html>