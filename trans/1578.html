<html>
<head>
<title>Understanding your Neural Network’s predictions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">理解你的神经网络的预测</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/understanding-your-neural-networks-predictions-d9290f8b984f#2022-04-15">https://towardsdatascience.com/understanding-your-neural-networks-predictions-d9290f8b984f#2022-04-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1994" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">评估神经网络特征重要性的简明指南。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/33fbdfb40471077ed782e813706ba034.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Myh1yrYE0NRaM8tr3OBSww.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="ec19" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">神经网络极其方便。它们可用于回归和分类，处理结构化和非结构化数据，非常好地处理时态数据，如果给它们足够的数据量，通常可以达到高性能。</p><p id="27ff" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然而，便利性带来的好处却失去了可解释性，当模型被呈现给非技术观众，如客户或利益相关者时，这可能是一个重大的挫折。</p><p id="ddd4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">例如，去年，我所在的数据科学团队想要说服一个客户从决策树模型转向神经网络，理由很充分:我们可以访问大量数据，其中大部分都是暂时的。客户同意，但希望了解模型决策的基础，这意味着评估其特性的重要性。</p><h1 id="57b0" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">有意义吗？</h1><p id="5d11" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">这是有争议的。对于决策树或boosting模型，对于大多数决策树，可以使用拟合属性<code class="fe mo mp mq mr b">feature_importances_</code>直接检索特征的重要性，对于XGBoost模型，可以使用<code class="fe mo mp mq mr b">get_booster()</code>和<code class="fe mo mp mq mr b">get_score()</code>方法。</p><p id="8d0e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">对于神经网络来说，这些属性和方法是不存在的。每个神经元都被训练成根据它接收到的信号来学习何时激活或不激活，以便每一层都从原始输入中提取一些信息或概念，直到最终的预测层。因此，检索一个更“黑盒”类型的模型的特征重要性的有用性是值得怀疑的。</p><p id="c118" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我甚至听到深度学习专家说，最好让数据说话，不要试图过多地理解模型。基本上，知道猫的皮毛是否比它的眼睛对神经网络更有影响有用吗？也许不是。但是有必要知道，对于这个模型来说，桌子上的猫和地板上的猫是一样的，这就是我们在这里要做的。</p><h1 id="7659" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">置换、扰动和评估</h1><p id="591e" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">我们将使用排列重要性方法。对于经典的机器学习模型，Scikit-Learn提供了一个函数来做到这一点，甚至在处理高基数特性时推荐它。如果您想要在您的模型上使用这个函数，这个代码片段将计算并显示它的排列重要性:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ms mt l"/></div></figure><h1 id="8110" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">排列重要性背后的原理</h1><p id="a28c" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">假设你有几个学生，你想评估他们通过数学考试的可能性。要做到这一点，你可以使用3个变量:他们花在学习考试上的时间，他们在数学上的难易程度，以及他们的头发颜色。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mu"><img src="../Images/8096ea6e0471290112c3361de4d62951.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rhYDxlAaYjOc1Np_W_HO-A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">数学考试的学生数据。作者图片</p></figure><p id="083d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在这个例子中，Paul学习了很多，并且在数学方面有一定的天赋。他很有可能通过数学考试。迈克，另一方面，学习少得多，不是很有天赋，他不太可能成功。鲍勃根本没有学习，但他非常有天赋，因此他有机会。</p><p id="789f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们重新排列“学习时间”特性的值:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mv"><img src="../Images/1ae44c40c9690027eb065521456b8a76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kKQJ_lk37cfn0inNvJRELA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">调整第一列的影响。作者图片</p></figure><p id="6208" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">保罗从大量学习变成了完全不学习。他在数学上的中等轻松不足以弥补，他现在不太可能通过。同样，其他学生成功的可能性也受到这种干扰的极大影响。</p><p id="5321" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">因此，我们可以推断，学习时间是预测考试结果的一个重要特征。</p><p id="6eb5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当我们扰动数学中的ease特性时，我们得到了相同的结果:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mw"><img src="../Images/5ed19debb8487d40d3cfbf8f1e6a4726.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hXxst5rXU8jcPp7gmBLbEA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">调整第二列的影响。作者图片</p></figure><p id="9c16" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">鲍勃现在对数学毫无天赋，根本没有学习过。他通过考试的可能性极小。</p><p id="4ffc" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">和前面的推理一样，这个特性也很重要。</p><p id="371c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，当我们改变头发颜色特征时:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mx"><img src="../Images/0d70cb035152a1e79aa61ad744b1dfd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*621dZvv1DYJsAvry8f7ZHA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">调整第三列的影响。作者图片</p></figure><p id="9111" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">迈克从金发变成黑发不会增加他考试的机会，头发颜色的改变也不会对任何学生产生任何影响。因此，这个特征对我们的预测并不重要。</p><h1 id="f63d" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">这种方法的局限性</h1><p id="d31b" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">假设100个学生中，我们有一个作弊的人设法拿到了考试科目，这保证了他通过考试。如果我们改变“作弊者”一栏，我们将只有一个学生从作弊者变成非作弊者，另一个学生从非作弊者变成作弊者。100个学生中，只有两个会受到影响，我们会错误地认为这个特征不重要，因为它的患病率很低。</p><p id="8741" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">因此，这种方法对于不平衡的二进制特征和分类特征的罕见模态不能很好地工作。对于这些情况，最好将整个列设置为稀有值，并查看它如何影响预测(在我们的类比中，这意味着将每个学生的“作弊”列设置为True)。</p><h1 id="2840" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">履行</h1><p id="eb8a" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">第一步是在测试集上做出不受干扰的推断。然后，对于每一个特征，你将随机洗牌，做出我称之为扰动推断的结论。</p><p id="fe08" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">一旦所有被干扰的推论都被做出，将它们连接在一个单一的数据框架中，然后计算每个观察值与原始预测值相比有多远的偏差。</p><p id="74f8" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在此基础上，一个可视化每个扰动影响的好方法是制作一个所有观测偏差的箱线图。</p><p id="89e3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">例如，让我们使用<a class="ae my" href="https://www.kaggle.com/c/home-credit-default-risk/data" rel="noopener ugc nofollow" target="_blank"> Kaggle数据集进行家庭信用违约风险竞争</a>。<br/>在预处理和训练阶段之后，我得到了两个数据集，<code class="fe mo mp mq mr b">X_test</code>包含测试集的静态数据，<code class="fe mo mp mq mr b">X_test_batch</code>包含训练集的时态数据。</p><p id="e741" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">下面的代码片段遍历了每个特性，并创建了一个受干扰的推论:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="877c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然后，这个代码片段将计算每个扰动与原始推断的偏差:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="25fc" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后，这段代码将打印特性重要性:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="0af4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">你应该得到这样一个图:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mz"><img src="../Images/577f466d7ee565a0eacc3eb77af02974.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H7mFxFg224fJVTUHJgnVLg.png"/></div></div></figure><p id="b50c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你想看到整个数据科学管道，我制作了一个公共的docker图像，其中包含了从原始数据到功能重要性图的所有步骤:<a class="ae my" href="https://hub.docker.com/r/villatteae/neuralnet_feat_importance/tags" rel="noopener ugc nofollow" target="_blank">https://hub . docker . com/r/villatteae/neural net _ feat _ importance/tags</a></p><p id="04ad" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">只需运行以下docker命令:</p><p id="b9b2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">docker pull villatteae/neural net _ feat _ importance:最新</p><pre class="kg kh ki kj gt na mr nb nc aw nd bi"><span id="fc45" class="ne ls iq mr b gy nf ng l nh ni">docker pull villatteae/neuralnet_feat_importance<br/>docker run -p 10000:10000 -d villatteae/neuralnet_feat_importance</span></pre><p id="1fc1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">该映像将在您的localhost:10000地址上运行。实例的用户名和密码是admin和admin。注意图像相当重(~17 GB)。</p></div></div>    
</body>
</html>