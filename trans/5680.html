<html>
<head>
<title>Automatically Updating a BigQuery Table Using an External API and a Cloud Function</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用外部 API 和云函数自动更新 BigQuery 表</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/automatically-updating-a-bigquery-table-using-an-external-api-and-a-cloud-function-c05423ca3ed#2022-12-23">https://towardsdatascience.com/automatically-updating-a-bigquery-table-using-an-external-api-and-a-cloud-function-c05423ca3ed#2022-12-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="eda0" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">关于构建完全自动化的过程来定期更新 BigQuery 表的分步指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f4063fede519a5c5fd1c548298268e16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JKL7vPky0YjWWbk7"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@pluyar?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">沙恩·奥尔登多夫</a>在<a class="ae ky" href="https://unsplash.com/fr/photos/mQHEgroKw2k?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><h1 id="ad43" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">语境</h1><p id="2618" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">最近，Roquette Data &amp; Advanced Analytics 团队一直在研究 BigQuery 或 Snowflake 等分析数据仓库如何改善我们的最终用户对数据的访问。</p><p id="8f65" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这种数据仓库提供了一个全球平台，可以轻松地接收、处理结构化数据，并将其提供给业务用户或解决方案。</p><p id="82e5" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在这篇文章中，我将解释我们如何开发一个简单的过程来接收来自外部 API 的天气数据，并将其提供给我们的用户。</p><p id="0690" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">此类数据有助于检测本地温度和制造过程输出之间的任何相关性(有时就是这样！)或者我们的销售是否会受到温度变化的影响。</p><h1 id="1640" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">本教程需要的内容:</h1><ul class=""><li id="a74f" class="ms mt it lt b lu lv lx ly ma mu me mv mi mw mm mx my mz na bi translated">一个免费的 API 来获取全球各地的各种天气信息(我们的设施几乎遍布每个大洲)。我们的一位数据科学家(<a class="nb nc ep" href="https://medium.com/u/8853717eec87?source=post_page-----c05423ca3ed--------------------------------" rel="noopener" target="_blank">亚瑟·特尔德斯</a>)发现<a class="ae ky" href="https://open-meteo.com/en" rel="noopener ugc nofollow" target="_blank"> <strong class="lt iu"> OpenMeteo </strong> </a>很好地满足了我们的需求。</li><li id="a5d8" class="ms mt it lt b lu nd lx ne ma nf me ng mi nh mm mx my mz na bi translated">数据仓库平台。在本文中，我们将使用来自 Google 的:<strong class="lt iu"> BigQuery </strong>。</li></ul></div><div class="ab cl ni nj hx nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="im in io ip iq"><h1 id="3d82" class="kz la it bd lb lc np le lf lg nq li lj jz nr ka ll kc ns kd ln kf nt kg lp lq bi translated">在 Google 云平台中建立一个新项目</h1><p id="2b88" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我会假设你已经有一个 GCP 帐户。如果没有，你可以很容易地打开一个，并获得 300 美元的信用 30 天。如果你已经有了一个，记住这个例子几乎不会花你一分钱(&lt;0.05$).</p><p id="9b85" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">You should start by creating a new project to isolate your work. Click on the project selector in the top left and then “New Project”:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/37d9972fe1cc482af3a65739d0313128.png" data-original-src="https://miro.medium.com/v2/resize:fit:680/format:webp/1*2YVDYBXv4XlaNGr446SsNQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Project Selector on GCP— Image from Author</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/89060a1834a1c51e5747c7e2e10c228a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MSmHg136EhSHdVcHzWGJ9g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">New Project Button on GCP — Image from Author</p></figure><p id="6006" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">We call this new project “api-weather-test” and click on “create”:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/eaf839aa4aa5712e73aa0ea4de7e39ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1122/format:webp/1*9tj1qHzfuRoRb2-yojhxwg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">New Project Creation on GCP — Image from Author</p></figure></div><div class="ab cl ni nj hx nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="im in io ip iq"><h1 id="f1e5" class="kz la it bd lb lc np le lf lg nq li lj jz nr ka ll kc ns kd ln kf nt kg lp lq bi translated">Selecting your project and activating APIs</h1><p id="69d6" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">Once your project is created (it should take a few seconds only), we select it by using again the project selector to reach the project homepage:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/160e6118ae028ad4bc7ec18e6e21d1d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*duxkay0L9cf8trtghmjN8Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Project selection on GCP — Image from Author</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/2bc6d40f4ff6d08f9a653eff452a432e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1286/format:webp/1*hHxS29AFTtDpcg5-NZoZEw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nz">GCP 的项目主页——图片来自作者</em></p></figure><p id="bd8b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们的新项目来将已经嵌入的功能(如 BigQuery)，但我们需要激活一些额外的 API。我们应该在搜索栏中查找的第一个是“云发布/订阅 API”:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/ef45a344f4171de794bfcf3dc467f835.png" data-original-src="https://miro.medium.com/v2/resize:fit:898/format:webp/1*tbIUOdmKgr3VBo0o0k_arw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nz">GCP 的云发布/订阅搜索—图片来自作者</em></p></figure><p id="fdd3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">到达相应的页面后，我们只需启用 API。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/967e5b351c6e164683ee69e1da5c6950.png" data-original-src="https://miro.medium.com/v2/resize:fit:1184/format:webp/1*9H5oVV0HzVjVg52QrezKCQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nz">在 GCP 启用云发布/订阅 API 图片来自作者</em></p></figure></div><div class="ab cl ni nj hx nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="im in io ip iq"><h1 id="2027" class="kz la it bd lb lc np le lf lg nq li lj jz nr ka ll kc ns kd ln kf nt kg lp lq bi translated">我们的自动化概念</h1><p id="539c" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们打算定期从外部 API(例如每天)，然后将其转移到 BigQuery 表中。</p><p id="2443" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如下所述，实现这一目标的一种可能方式是:</p><ul class=""><li id="6d76" class="ms mt it lt b lu mn lx mo ma oc me od mi oe mm mx my mz na bi translated"><strong class="lt iu">创建能够查询外部 API 和更新 BigQuery 表的 Python 脚本</strong>，</li><li id="9c08" class="ms mt it lt b lu nd lx ne ma nf me ng mi nh mm mx my mz na bi translated"><strong class="lt iu">将这个 Python 脚本</strong>封装到一个云函数中，该云函数将“监听”发布/订阅消息并等待其触发，</li><li id="f37c" class="ms mt it lt b lu nd lx ne ma nf me ng mi nh mm mx my mz na bi translated"><strong class="lt iu">每天广播一条“Pub/Sub”消息</strong>(就说午夜吧！)将被填充到项目中。</li></ul><p id="2c07" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">因此，每次发送“发布/订阅”消息时，云函数都会执行 Python 脚本并更新大查询表。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi of"><img src="../Images/e5d5905c9b236ee02bde9cdb67e2d270.png" data-original-src="https://miro.medium.com/v2/resize:fit:1058/format:webp/1*wfKAMFbo6U7WxtNarip9FA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nz">自动化概念—图片来自作者</em></p></figure><h1 id="37d1" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">步骤 1:使用云调度程序创建作业</h1><p id="1fad" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们通过搜索栏进入“云调度程序”用户界面:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi og"><img src="../Images/d1c145526a8515ee63cb19dbdaededab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1278/format:webp/1*dQfRmlmvoN8uq0vI3pBFdQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nz">GCP 云调度搜索—图片来自作者</em></p></figure><p id="40c1" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们创建了一个新职位，并开始定义:</p><ul class=""><li id="bef2" class="ms mt it lt b lu mn lx mo ma oc me od mi oe mm mx my mz na bi translated">它的名字，</li><li id="1438" class="ms mt it lt b lu nd lx ne ma nf me ng mi nh mm mx my mz na bi translated">它被执行的区域，</li><li id="0d97" class="ms mt it lt b lu nd lx ne ma nf me ng mi nh mm mx my mz na bi translated">它的描述，</li><li id="f5ec" class="ms mt it lt b lu nd lx ne ma nf me ng mi nh mm mx my mz na bi translated">它的频率，在 Unix-cron 格式下指定(如果你不熟悉的话，你应该查一下<a class="ae ky" href="https://crontab.guru/" rel="noopener ugc nofollow" target="_blank"> CronGuru </a>)，</li><li id="4358" class="ms mt it lt b lu nd lx ne ma nf me ng mi nh mm mx my mz na bi translated">和它的时区。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/039a75bdc55b45c6b33e03fbb27bd49d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WsU_BfsYkLmBWTGOFmECVA.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/83743fd0422e9c0fe676306fc7efe3a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1072/format:webp/1*jqAKQhgj240hGgUj-xnFCg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nz">云调度程序——在 GCP 创造就业机会——图片来自作者</em></p></figure><p id="bfbc" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们还必须定义将要执行的目标的类型。我们选择“发布/订阅”并创建一个名为“天气”的新主题，因为所有消息都应该属于一个预定义的主题。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/eae61603382fc1def773c550743f7c9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1108/format:webp/1*fwO9Bj-c5dfcI9ASwLb4CA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nz">云调度程序—GCP 上的作业配置—图片来自作者</em></p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/34b752984780b189ad95467fd69903f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1008/format:webp/1*lcNWR5aTqtaKK8uH6Rylqg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nz">云调度程序——GCP 上的主题创建——图片来自作者</em></p></figure><p id="8db0" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们不会使用消息体的特性，所以您可以随意放置(这里是“更新”):</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/97d30b73bc50d7abab040f4a6037199a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1066/format:webp/1*7q0wxOMzkr9SNRCrgO3o1g.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nz">云调度程序——在 GCP 创造就业机会——图片来自作者</em></p></figure><p id="b087" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">创建完成后，这个新作业应该出现在列表中，其下一次计划的执行时间显示在“下次运行”列中。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/f9757f8519ae1081f55dda97d6dad0ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_oCkmGPPHgH2eE6_H2Iwaw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nz">云调度器用户界面—图片来自作者</em></p></figure><h1 id="f170" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">步骤 2:在 BigQuery 中创建我们的表</h1><p id="d762" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们再次使用搜索栏到达 BigQuery 页面，并单击“Create Dataset”(一个包含表或视图的数据集)</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi on"><img src="../Images/1222aa44aeef1a81acc30b4bbc20d65d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K30rCGHpLsom3A53Gy-vQA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nz"> BigQuery 主页——图片来自作者</em></p></figure><p id="1318" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">关于这个新数据集的重要信息是:</p><ul class=""><li id="3a35" class="ms mt it lt b lu mn lx mo ma oc me od mi oe mm mx my mz na bi translated"><strong class="lt iu">其 ID</strong>(=名称，此处为“天气”)</li><li id="323b" class="ms mt it lt b lu nd lx ne ma nf me ng mi nh mm mx my mz na bi translated"><strong class="lt iu">它的位置</strong></li></ul><p id="b570" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">(额外的设置是可用的，但对本例没有用)</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/c78017d6623d40abf483659ab0e71292.png" data-original-src="https://miro.medium.com/v2/resize:fit:1146/format:webp/1*lkZ591h0-OV7vygBQk0lLQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nz"> BigQuery —在 GCP 上创建数据集—图片来自作者</em></p></figure><p id="5f22" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">创建后，它应该出现在我们的项目结构下，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi op"><img src="../Images/adf0825ab8b597969e27d19204358e01.png" data-original-src="https://miro.medium.com/v2/resize:fit:722/format:webp/1*euvBl7lh-SlmtxqwMXYr0w.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nz"> BigQuery —数据集—图片来自作者</em></p></figure><p id="6e57" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">有几种方法可以创建空表。我们选择执行相应的 SQL 表。</p><p id="ab97" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">将“api-weather-test- <strong class="lt iu"> 372410 </strong>”替换为您自己的项目名称后，只需点击“<strong class="lt iu">编写一个新的查询</strong>，并运行以下指令:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/ed04c85bf68a416a1c1961f806ddecff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1354/format:webp/1*D4rrrvmB3X5JnDCFfi88vg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nz">big query—使用 SQL 创建表格—图片来自作者</em></p></figure><pre class="kj kk kl km gt or os ot bn ou ov bi"><span id="c412" class="ow la it os b be ox oy l oz pa">|CREATE TABLE `api-weather-test-372410.WEATHER.TEMPERATURES` (time TIMESTAMP,<br/>                                                             Portage_la_Prairie FLOAT64 OPTIONS (description = 'External temperatures in C° for Portage plant.'),<br/>                                                             Wuhan FLOAT64 OPTIONS (description = 'External temperatures in C° for Wuhan plant.'),<br/>                                                             Benifaio FLOAT64 OPTIONS (description = 'External temperatures in C° for Benifaio plant.'),<br/>                                                             Beinheim FLOAT64 OPTIONS (description = 'External temperatures in C° for Beinheim plant.'),<br/>                                                             )</span></pre><p id="f4de" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们可以观察到该表包含:</p><ul class=""><li id="32af" class="ms mt it lt b lu mn lx mo ma oc me od mi oe mm mx my mz na bi translated">一个带有时间戳类型的“时间”列，</li><li id="7447" class="ms mt it lt b lu nd lx ne ma nf me ng mi nh mm mx my mz na bi translated">4 个浮动柱对应于我们的四个罗盖特工厂(真实数据集包括 25 个罗盖特工厂)。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pb"><img src="../Images/1de07bd39aae7aac083ef8a4d2db1926.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9i4Khcbb-W7Etck62KwSMA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nz"> BigQuery —带有 SQL 的温度表—图片来自作者</em></p></figure><p id="d303" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">通过在 SQL 指令中使用“OPTIONS (description = '…')”，每个列的描述都包含在表方案中，使用户更容易理解其中包含什么类型的信息。</p><p id="5917" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们的(空)表已经准备好欢迎数据…让我们跳到下一步！</p></div><div class="ab cl ni nj hx nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="im in io ip iq"><h1 id="5f4c" class="kz la it bd lb lc np le lf lg nq li lj jz nr ka ll kc ns kd ln kf nt kg lp lq bi translated">步骤 3:创建云函数</h1><p id="f277" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们可以通过搜索栏导航到“Cloud Functions”页面，然后点击“Create Function”(<em class="pc">注:Google 可能会要求您激活其他 API，如 CloudBuild 和 CloudFunctions </em>)</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pd"><img src="../Images/a435b5aa838ac06bde98e5528bdcdff0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1104/format:webp/1*c_HtjqxPuz34z6akiO7rDg.png"/></div></figure><p id="5797" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><em class="pc">注意:云函数可以被认为是小容器，在其中执行代码。它们支持不同的语言，例如:。NEt，Go，Java，Node，PHP，Python，或者 Ruby。</em></p><p id="9654" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们创建了一个名为“天气更新”的功能，由“天气”主题的“发布/订阅”消息触发。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pe"><img src="../Images/b1d8a08e30508a83dff43ce3dafd9c80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1076/format:webp/1*YyvRxi3L-3ELHHjFNPDVZA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nz">云功能配置—图片来自作者</em></p></figure><p id="c0e0" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">一旦配置完成，我们需要选择相应的语言。我们选择 Python 3.9 作为运行时。</p><p id="6dc8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在只需要复制粘贴我的 GitHub 中的代码:</p><ul class=""><li id="2edd" class="ms mt it lt b lu mn lx mo ma oc me od mi oe mm mx my mz na bi translated"><a class="ae ky" href="https://github.com/pierrelouisbescond/medium_articles/blob/main/medium_api_main.py" rel="noopener ugc nofollow" target="_blank"> main.py </a></li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pf"><img src="../Images/b955a38c36579b0feea51f24f5acf234.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6JCXVT1BVE7m25I5AKTyVQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nz">云函数— main.py 配置—图片来自作者</em></p></figure><ul class=""><li id="06bd" class="ms mt it lt b lu mn lx mo ma oc me od mi oe mm mx my mz na bi translated"><a class="ae ky" href="https://github.com/pierrelouisbescond/medium_articles/blob/main/medium_api_requirements.txt" rel="noopener ugc nofollow" target="_blank">requirement . txt</a></li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pg"><img src="../Images/fa6ede78136443f1c596524b8ac17e33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RVwXr4CoDrtVaE-wHAtbZA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nz">云功能— requirements.txt 配置—图片来自作者</em></p></figure><p id="3fd9" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们点击“部署”并等待云功能激活:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ph"><img src="../Images/01cbab519af991a7af434758b1add2eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ETvaBuEWwXdn8Pmc7i0Waw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nz">云函数 UI——图片来自作者</em></p></figure><p id="4595" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">因为我们想确保该功能运行良好，而不需要等到午夜，所以我们单击“Test function”立即运行它:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pi"><img src="../Images/9d9cab68dee1f5b727ecbde4930ee98e.png" data-original-src="https://miro.medium.com/v2/resize:fit:366/format:webp/1*okG8nesLg6s2qrKzbIYQcA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nz">云函数 UI —动作—图片来自作者</em></p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pj"><img src="../Images/1f87b00f1726654f6c429f5f81a59a77.png" data-original-src="https://miro.medium.com/v2/resize:fit:376/format:webp/1*gIqMUBWrGJzIltBNH22r1A.png"/></div></figure><p id="2247" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">日志确实确认了该功能的正确执行。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pk"><img src="../Images/38702083465f5d1290b3e52b067d25ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rak81lfXWoKt4Fc5fsCLkg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nz">云函数日志——图片来自作者</em></p></figure><p id="593a" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们返回到“BigQuery”页面，执行下面的 SQL 指令(确保使用您自己的项目名称:api-weather-test- <strong class="lt iu"> XXXXXX </strong>)。</p><p id="36c7" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">该表现在包含从 2022 年 1 月 1 日至今的所有可用记录:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pl"><img src="../Images/9c58ad52f97c5298338fa94188db9bd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1332/format:webp/1*BL42KS8w6w9qP9JYzAnYCA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nz"> BigQuery — SQL 指令执行—图片来自作者</em></p></figure><p id="ad0e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><em class="pc">注:美国石油学会提供的数据为近似值。5 天的延迟，这意味着在 22/12 执行的查询将检索到 17/12 的数据。</em></p></div><div class="ab cl ni nj hx nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="im in io ip iq"><h1 id="4012" class="kz la it bd lb lc np le lf lg nq li lj jz nr ka ll kc ns kd ln kf nt kg lp lq bi translated">严峻的考验！</h1><p id="1ebd" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们可以去睡觉了😪并且等到第二天早上检查午夜更新是否顺利！</p><p id="d2f9" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们从检查“发布/订阅”消息是否运行开始…它确实运行了:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pm"><img src="../Images/b6250cc940cbe6dce80beaa6c262ab4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R-qY0_AkEivIc__cLFT1bg.png"/></div></div></figure><p id="d777" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们跳转到云函数日志，看到“天气更新”函数在午夜被正确执行，几秒钟后:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pn"><img src="../Images/34f4de526f0d11f93e2142250ad25798.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RwDZ415YfzPgFkFlsaI7ow.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nz">云函数日志——图片来自作者</em></p></figure><p id="beae" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">正如所料，BigQuery 表现在包含了新记录😁：</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pl"><img src="../Images/235f768986d4bd0f1148c9352e810e3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1332/format:webp/1*0iuWx9i6AvxxQ2DQdH7dVQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nz"> BigQuery — SQL 指令执行—图片来自作者</em></p></figure><h1 id="afb1" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">然后，瞧！</h1><p id="65f5" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">不需要任何额外的工作，BigQuery 将在每天午夜更新，没有进一步的行动。</p><p id="bfd0" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在我们结束这篇文章之前，请注意以下几点:</p><ul class=""><li id="af84" class="ms mt it lt b lu mn lx mo ma oc me od mi oe mm mx my mz na bi translated">为了使本文的代码尽可能简单，Python 脚本完全删除了表内容，每次都用所有可用的数据更新它。这不是优化资源的最佳方式。在生产中，我们应该以“增量模式”工作，只从 API 中检索自上次更新以来的新记录，并将它们传输到表中。</li><li id="5c5e" class="ms mt it lt b lu nd lx ne ma nf me ng mi nh mm mx my mz na bi translated">假设我们想要将“温度”表中的信息与另一个 BigQuery 表(例如:“流程 _ 输出”)。我们将不需要使用第二个云函数。我们可以直接使用“预定查询”来执行 SQL 指令(例如内部连接)。</li></ul><p id="386f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">像往常一样，我试图确定所有需要的步骤，但如果我的教程中有任何遗漏的说明，请不要犹豫来找我！</p><p id="0db1" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">请不要犹豫，浏览我在 Medium 上的其他文章:</p><div class="po pp gp gr pq pr"><a href="https://pl-bescond.medium.com/pierre-louis-besconds-articles-on-medium-f6632a6895ad" rel="noopener follow" target="_blank"><div class="ps ab fo"><div class="pt ab pu cl cj pv"><h2 class="bd iu gy z fp pw fr fs px fu fw is bi translated">皮埃尔-路易·贝斯康德关于媒介的文章</h2><div class="py l"><h3 class="bd b gy z fp pw fr fs px fu fw dk translated">数据科学、机器学习和创新</h3></div><div class="pz l"><p class="bd b dl z fp pw fr fs px fu fw dk translated">pl-bescond.medium.com</p></div></div><div class="qa l"><div class="qb l qc qd qe qa qf ks pr"/></div></div></a></div></div></div>    
</body>
</html>