<html>
<head>
<title>Apache Airflow for Data Science — How to Work with Variables</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Apache Airflow for Data Science —如何使用变量</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/apache-airflow-for-data-science-how-to-work-with-variables-891932b0d99f#2022-03-31">https://towardsdatascience.com/apache-airflow-for-data-science-how-to-work-with-variables-891932b0d99f#2022-03-31</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="96e1" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated"><strong class="ak">停止在气流 Dag 中硬编码数值——使用变量代替</strong></h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/babe9080753a325af96c1b896031bb4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jXUhgix2Ho6UBbly"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@pankajpatel?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Pankaj Patel </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="7779" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">气流变量是保存和访问不同类型内容的最佳方式。您可以存储几乎所有您能想到的东西，从纯文本内容、凭证到类似 JSON 的数据结构。有两种方法存储气流中的变量——从管理面板和从终端——我们今天将探讨这两种方法。</p><p id="62db" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不想看书？请观看我的视频:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="1a24" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">如何在阿帕奇气流中添加变量</h1><p id="8b1f" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">首先，确保 Airflow webserver 和 scheduler 都已启动并运行。进入气流主页(<code class="fe nb nc nd ne b">http://localhost:8080</code>)并导航至<em class="nf">管理</em> - <em class="nf">变量</em>。如果您是第一次来这里，您会看到一个空白列表:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/115614656228aca22d2b0c21762a03fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mrS0MbBaqjctFrBhRzuFlA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 1 —气流变量页面(作者图片)</p></figure><p id="584e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">单击蓝色加号按钮添加一个新变量。我们将保持这个简单，并将其指定如下:</p><ul class=""><li id="e83e" class="nh ni it lb b lc ld lf lg li nj lm nk lq nl lu nm nn no np bi translated"><strong class="lb iu">键</strong> : <code class="fe nb nc nd ne b">user_email</code></li><li id="2831" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated">瓦尔 : <code class="fe nb nc nd ne b">test@test.com</code></li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/2500b915aad214d476a0468ef8865471.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3P488XUheLN-LAn1WDE-5g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 2——如何在气流中添加变量(图片由作者提供)</p></figure><p id="0488" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">趁我们还在，再加一个吧。这会稍微复杂一点，并存储一个类似 JSON 的对象。当通过 DAG 访问这种类型的对象时，需要对其进行反序列化，这就是我们讨论它们的原因:</p><ul class=""><li id="f14f" class="nh ni it lb b lc ld lf lg li nj lm nk lq nl lu nm nn no np bi translated"><strong class="lb iu">键</strong> : <code class="fe nb nc nd ne b">sample_json</code></li><li id="ad0d" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated"><strong class="lb iu">瓦尔</strong> : <code class="fe nb nc nd ne b">{"user": "bob", "address": {"city": "NY", "street_name": "1st"}}</code></li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/a5785b085bb1629eb08f7beb547bde64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kGCMfkwIHYv529xyn-wqtw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 3——如何在 Airflow 中添加一个类似 JSON 的变量(图片由作者提供)</p></figure><p id="1750" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您做的一切都正确，您应该会看到在<em class="nf">管理</em> — <em class="nf">变量</em>下列出了两个变量。在继续之前，请确保您的外观相同:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/8be75192abc3caffe5f1339df84601cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7cFbqUR77Zt7wKHkTJ2pVQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 4-添加变量后的气流变量页面(图片由作者提供)</p></figure><p id="b36b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是你如何通过气流网页添加气流变量。还有另一种可能更简单的方法，但它有几个怪癖。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="0ed0" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">如何在通过终端的阿帕奇气流中添加变量</h1><p id="4d89" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">在气流版本 1.10.10 中，您可以从终端添加气流变量。完全清楚地说，这些只是具有特定命名约定的环境变量。</p><p id="24d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所有气流变量必须用语法<code class="fe nb nc nd ne b">AIRFLOW_VAR_{VARIABLE_NAME}</code>设置，全部大写。如果你想有一个名为<code class="fe nb nc nd ne b">TEST</code>的变量，就把它声明为<code class="fe nb nc nd ne b">AIRFLOW_VAR_TEST</code>。大写语法在这里是至关重要的，但是大写和小写都将在后面的 Airflow DAG 中起作用。</p><p id="833b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是如何这样声明两个变量——注意 JSON 是如何用单引号括起来的:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/d07e6c934376f36085f71ef58546f4d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DYoYZGlCXUXPIvaEO8zaSA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 5-添加通过终端的气流变量(图片由作者提供)</p></figure><p id="fa7a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用环境变量设置的变量不会出现在 Airflow 主页上的<em class="nf">管理</em> — <em class="nf">变量</em>下，所以请记住这一点。</p><p id="fc7d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么，你如何访问它们呢？那么，您可以使用以下 shell 命令来打印所有环境变量:</p><pre class="kj kk kl km gt nw ne nx ny aw nz bi"><span id="e308" class="oa mf it ne b gy ob oc l od oe">env</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/6ae08daf21fa43f94e78c26a287ec291.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8fLOD2IQks1otWyWGXl8Xg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 6 —打印所有环境变量(图片由作者提供)</p></figure><p id="0b42" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或者您可以打印一个特定的:</p><pre class="kj kk kl km gt nw ne nx ny aw nz bi"><span id="f3ee" class="oa mf it ne b gy ob oc l od oe">echo $AIRFLOW_VAR_TEST_JSON</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/b4aa7f94b4d5febdb5835a1d47308c9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*59xkLra9pSnIUx-OgOdi2Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 7 —打印单个环境变量(图片由作者提供)</p></figure><p id="a3c7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">两种方式都可行。唯一的区别是，如果您决定以这种方式声明变量，您将无法通过 Airflow 的 UI 检查和更改它们。</p><p id="3db2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">说得够多了——让我们看看如何从气流 DAG 中访问变量。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="c32b" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">如何从 DAG 访问气流变量</h1><p id="98bb" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">在<code class="fe nb nc nd ne b">~/airflow/dags</code>文件夹中创建一个新文件。我给我的取名为<code class="fe nb nc nd ne b">variables_dag.py</code>。我们将从库导入和 DAG 样板代码开始。注意额外的<code class="fe nb nc nd ne b">airflow.models.Variable</code>导入。这个类用于获取变量。</p><pre class="kj kk kl km gt nw ne nx ny aw nz bi"><span id="98fc" class="oa mf it ne b gy ob oc l od oe">from datetime import datetime<br/>from airflow.models import DAG, Variable<br/>from airflow.operators.python import PythonOperator<br/><br/><br/>with DAG(<br/>    dag_id="variables_dag",<br/>    schedule_interval="@daily",<br/>    start_date=datetime(2022, 3, 1),<br/>    catchup=False<br/>) as dag:<br/>    pass</span></pre><p id="a941" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将在这个 DAG 中声明的唯一任务将调用<code class="fe nb nc nd ne b">print_variables()</code>函数。在函数内部，使用<code class="fe nb nc nd ne b">Variable.get(key)</code>方法访问普通变量，使用<code class="fe nb nc nd ne b">Variable.get(key, deserialize_json=True)</code>方法访问类似 JSON 的变量。</p><p id="b7c0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该函数将把所有变量名及其值打印到控制台:</p><pre class="kj kk kl km gt nw ne nx ny aw nz bi"><span id="5398" class="oa mf it ne b gy ob oc l od oe">from datetime import datetime<br/>...<br/><br/><br/>def print_variables() -&gt; str:<br/>    var_user_email = Variable.get("user_email")<br/>    var_sample_json = Variable.get("sample_json", deserialize_json=True)<br/>    var_env_test = Variable.get("test")<br/>    var_env_test_json = Variable.get("test_json", deserialize_json=True)<br/><br/>    return f"""<br/>        var_user_email = {var_user_email},<br/>        var_sample_json = {var_sample_json},<br/>        var_env_test = {var_env_test},<br/>        var_env_test_json = {var_env_test_json}<br/>    """<br/><br/><br/>with DAG(...) as dag:<br/><br/>    task_print_variables = PythonOperator(<br/>        task_id="print_variables",<br/>        python_callable=print_variables<br/>    )</span></pre><p id="d591" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用以下 shell 命令测试任务:</p><pre class="kj kk kl km gt nw ne nx ny aw nz bi"><span id="0772" class="oa mf it ne b gy ob oc l od oe">airflow tasks test variables_dag print_variables 2022-3-1</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/50d0c4a3cc219c3a126ff9017087c435.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ycz8TjnbuAkISi21rf2ABw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 8 —在代码中访问气流变量(图片由作者提供)</p></figure><p id="aec7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，所有变量及其值都被成功打印出来。通过 Airflow 访问变量很容易，所以没有理由在代码中硬编码任何信息。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="2f2e" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">气流变量汇总</h1><p id="5a43" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">如果你懂编程的基础，你就知道变量的用途是什么。如果你没有，你为什么要学习气流？</p><p id="ad5a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">气流变量很容易理解。您可以通过 web UI 或终端将它们存储为环境变量。两种方式都可以，但后者有一点限制。如果您存储类似 JSON 的对象，请确保在 DAG 中访问变量时反序列化 JSON。</p><p id="de83" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你应该知道的就这些。</p><h2 id="8098" class="oa mf it bd mg og oh dn mk oi oj dp mo li ok ol mq lm om on ms lq oo op mu oq bi translated">推荐阅读</h2><ul class=""><li id="b346" class="nh ni it lb b lc mw lf mx li or lm os lq ot lu nm nn no np bi translated"><a class="ae ky" href="https://betterdatascience.com/best-data-science-prerequisite-books/" rel="noopener ugc nofollow" target="_blank">学习数据科学先决条件(数学、统计和编程)的 5 本最佳书籍</a></li><li id="4ca4" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated"><a class="ae ky" href="https://betterdatascience.com/top-books-to-learn-data-science/" rel="noopener ugc nofollow" target="_blank">2022 年学习数据科学的前 5 本书</a></li><li id="9536" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated"><a class="ae ky" href="https://betterdatascience.com/apache-airflow-install/" rel="noopener ugc nofollow" target="_blank">如何在本地安装阿帕奇气流</a></li></ul><h2 id="d92f" class="oa mf it bd mg og oh dn mk oi oj dp mo li ok ol mq lm om on ms lq oo op mu oq bi translated">保持联系</h2><ul class=""><li id="1a0b" class="nh ni it lb b lc mw lf mx li or lm os lq ot lu nm nn no np bi translated">雇用我作为一名技术作家</li><li id="e6f1" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated">订阅<a class="ae ky" href="https://www.youtube.com/c/BetterDataScience" rel="noopener ugc nofollow" target="_blank"> YouTube </a></li><li id="6af7" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated">在<a class="ae ky" href="https://www.linkedin.com/in/darioradecic/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上连接</li></ul></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><p id="3ee7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nf">喜欢这篇文章吗？成为</em> <a class="ae ky" href="https://medium.com/@radecicdario/membership" rel="noopener"> <em class="nf">中等会员</em> </a> <em class="nf">继续无限制学习。如果你使用下面的链接，我会收到你的一部分会员费，不需要你额外付费。</em></p><div class="ou ov gp gr ow ox"><a href="https://medium.com/@radecicdario/membership" rel="noopener follow" target="_blank"><div class="oy ab fo"><div class="oz ab pa cl cj pb"><h2 class="bd iu gy z fp pc fr fs pd fu fw is bi translated">通过我的推荐链接加入 Medium-Dario rade ci</h2><div class="pe l"><h3 class="bd b gy z fp pc fr fs pd fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="pf l"><p class="bd b dl z fp pc fr fs pd fu fw dk translated">medium.com</p></div></div><div class="pg l"><div class="ph l pi pj pk pg pl ks ox"/></div></div></a></div></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><p id="89f6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nf">原载于 2022 年 3 月 31 日 https://betterdatascience.com</em><em class="nf">的</em> <a class="ae ky" href="https://betterdatascience.com/apache-airflow-variables/" rel="noopener ugc nofollow" target="_blank"> <em class="nf">。</em></a></p></div></div>    
</body>
</html>