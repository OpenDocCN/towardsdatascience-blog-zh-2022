<html>
<head>
<title>Machine Learning Streaming with Kafka, Debezium, and BentoML</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kafka、Debezium和BentoML的机器学习流</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/machine-learning-streaming-with-kafka-debezium-and-bentoml-c5f3996afe8f#2022-08-22">https://towardsdatascience.com/machine-learning-streaming-with-kafka-debezium-and-bentoml-c5f3996afe8f#2022-08-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="f946" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用现代数据相关工具创建实时价格推荐系统</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/f526fdbcfe0286dd54ebeed2b9282858.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cOEnBC1EBjJOCTNj"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@xoforoct?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">EJ·斯特拉特</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h1 id="167c" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">介绍</h1><p id="4ba1" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">最近，GitHub宣布了预期的(也是有争议的)Copilot，这是一个能够生成和建议代码片段的人工智能，具有相当好的性能。</p><p id="caa0" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">然而，Copilot令人印象深刻的不仅是它的建议能力——这在科学论文中已经实现了——而且主要是因为它是一款<a class="ae kv" href="https://bdtechtalks.com/2022/07/05/github-copilot-large-language-model-product-management/" rel="noopener ugc nofollow" target="_blank">优秀产品</a>(我也是从用户的角度来说的)，能够通过简单的文本编辑器扩展同时为数百万开发者提供实时预测。</p><p id="1114" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">随着机器学习技术的成熟，不仅要了解人工智能模型如何工作以及如何提高它们的性能，还要了解如何将它们投入生产并与其他系统集成的技术部分，这变得越来越重要。</p><p id="9240" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">为了练习“人工智能基础设施”的这一部分，在这篇文章中，我们将模拟一个真实的情况(或几乎真实的情况)，在这种情况下，将有必要将机器学习模型与“生产”数据库相集成，以便随着新记录的增加而进行实时预测。</p><p id="6eee" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">也许这篇文章有点长，所以卷起你的袖子和我一起做这个项目吧。</p><h1 id="ce62" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">问题是</h1><p id="944d" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">假设我们有一个卖车平台，用户可以在那里注册并公布他们的车辆。随着新车注册(在数据库中)，应用程序应该建议(使用我们的机器学习模型)车辆的价格。当然，这个应用程序需要实时运行，这样用户才能快速收到适当的反馈。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mp"><img src="../Images/485bf3746c66c64ea483066fffd57641.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oSPwNcflFs5Ao-MVmZf9Uw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">提议的应用程序。图片作者。弗里皮克的图标。</p></figure><p id="73c0" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">为了模拟数据，我们将使用Kaggle的<a class="ae kv" href="https://www.kaggle.com/datasets/mysarahmadbhat/ford-used-car-listing" rel="noopener ugc nofollow" target="_blank"> <strong class="lq ir">福特二手车列表</strong> </a>数据集，该数据集包含超过15k辆汽车的销售价格及其各自的属性(燃料类型、里程、型号等)。</p><p id="34af" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我之前在数据集上做了一些实验，发现了一个足够好的模型，(完整代码将在GitHub上提供)，所以让我们跳过数据分析/数据科学部分，专注于我们的主要目标——让应用程序工作。</p><h1 id="f88a" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">提议的架构</h1><p id="b759" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">为了解决我们的问题，我们将需要以下东西:一种检测新条目何时添加到数据库的方法(更改数据捕获)，一种读取这些条目并使用机器学习模型预测价格的应用程序，以及一种将这些条目写回原始数据库(带有价格)的方法，所有这些都是实时的。</p><p id="1b0e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">幸运的是，我们不必重新发明轮子。下面几节中介绍的工具对我们帮助很大，只需要很少(或者根本不需要)代码。</p><h2 id="2f09" class="mq kx iq bd ky mr ms dn lc mt mu dp lg lx mv mw li mb mx my lk mf mz na lm nb bi translated">CDC与Debezium &amp; Kafka</h2><p id="bd4c" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">变更数据捕获，或简称为CDC，是监视和跟踪数据库中的变更的行为。您可以将CDC视为数据八卦，每次数据库内部发生一些事情时，CDC工具都会监听并与它的“朋友”共享消息。</p><p id="98b9" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">例如，如果将条目(joo，21)添加到表<em class="nc"> neighbors，</em>中，该工具将发出类似这样的声音:{ ' added ':{ ' name ':' joo '，' age':21，' id':214}}。</p><p id="a6e0" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这对于许多应用程序非常有用，因为捕获的更改可以用于许多任务，如数据库同步、数据处理和机器学习，这就是我们的情况。</p><p id="bc60" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">Debezium是一个专注于CDC的开源工具。它的工作原理是读取数据库(在本例中称为源)日志，并将检测到的更改转换为标准化的结构化消息，格式为AVRO或JSON，因此另一个应用程序可以使用它，而不用担心谁是源。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/19baffab98abd0bd05848a51216b2a38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1296/format:webp/1*W5BfSE6qdeyc-H_mwE74rQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">来源CDC与Debezium。图片作者。弗里皮克的图标。</p></figure><p id="3baa" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">它也可以用另一种方式来完成，通过接收描述变更的标准化消息，并将其反映到数据库中(在这种情况下称为sink)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/cb76c4341f4e3c9f3a937b88369cb139.png" data-original-src="https://miro.medium.com/v2/resize:fit:1296/format:webp/1*PYhQVZRxaTZnI8juiFb_Pg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">用Debezium吸收CDC。图片作者。弗里皮克的图标。</p></figure><p id="a291" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">Debezium建立在Apache Kafka的基础上，Apache Kafka是一个著名的开源<em class="nc">分布式事件流工具</em>，被许多大公司使用，如优步和网飞，每天移动千兆字节的数据。由于在数据移动方面的巨大可扩展性，<a class="ae kv" href="https://www.kai-waehner.de/blog/2020/10/27/streaming-machine-learning-kafka-native-model-server-deployment-rpc-embedded-streams/" rel="noopener ugc nofollow" target="_blank"> Kafka拥有巨大的潜力来帮助生产中的机器学习模型</a>。</p><p id="407c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">对于这个项目，我们不需要了解很多关于卡夫卡的知识，只需要了解它的基本概念。在Kafka中，我们有一个主题结构，包含由生产者编写并由消费者阅读的信息(字面上只是一串字节)。后两者可以是任何能够与Kafka连接的应用程序。</p><p id="5326" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">它已被证明是一个大规模应用程序的优秀工具，这肯定不是我们这个简单项目的情况，但它在使用中的简单性支付了任何额外的开销(在这个项目中)。</p><p id="1e5a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这就是我们的数据是如何移动的:当Debezium被配置为观察我们数据库中的某个表时，它会将检测到的变化转换为标准化的消息，将它们序列化为字节，然后将它们发送到Kafka主题。</p><p id="9424" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">然后，另一个应用程序可以连接到该主题，并根据需要使用数据。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ne"><img src="../Images/9b8dbafc0e879fdc5d85a96b7bb7ce32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TZ7nlTjDb004zKxc3MDdYQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">数据移动。图片作者。弗里皮克的图标。</p></figure><h2 id="8fa4" class="mq kx iq bd ky mr ms dn lc mt mu dp lg lx mv mw li mb mx my lk mf mz na lm nb bi translated">BentoML</h2><p id="587b" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">BentoML是一个服务于ML模型的开源框架。它允许我们用一个简单的python库对我们的机器学习模型进行版本控制和部署。</p><p id="b162" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这是一个非常好的工具，尤其是如果您来自数据科学领域，并且从未从Jupyter笔记本的“快乐领域”脱下模型进入“生产”世界。</p><p id="8aea" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">著名的用于机器学习的python库要么没有为模型服务的方法，因为他们认为这超出了范围，要么当他们有它时，它不那么容易使用。正因为如此，许多项目依赖于通过用FastAPI或Flask构建的API来交付他们的模型，这很好，但不是最佳的。</p><p id="295a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在我看来，BentoML非常好地缩小了模型训练和部署之间的差距。</p><p id="43b5" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们将在接下来的章节中了解更多。</p><h2 id="c8a9" class="mq kx iq bd ky mr ms dn lc mt mu dp lg lx mv mw li mb mx my lk mf mz na lm nb bi translated">将一切连接在一起</h2><p id="6575" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">现在我们知道了，至少是表面上知道了，所使用的工具，你可能已经知道我们将如何解决这个问题。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/f7f824240a579355145751dcb07cf3ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1334/format:webp/1*JOes2LvmNZ_UX0Ubzkp5Zw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">提议的架构。图片作者。弗里皮克的图标。</p></figure><p id="f232" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们将有一个Debezium实例监视我们的数据库，将检测到的每一个变化传输到Kafka主题。另一方面，python应用程序使用消息并将它们重定向到BentoML服务，后者返回预测价格。然后，python应用程序将记录与它们的预测价格结合起来，并将它们写回到另一个Kafka主题。最后，Debezium实例也在关注这个主题，它读取消息并将它们保存回数据库。</p><p id="cea6" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">好吧，这是很多步骤，但不要害怕，我保证做这一切的代码非常简单。</p><p id="d36c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">为了便于理解，让我们在上面的图像上做一个x光，看看我们的生物(建筑)的一些内部器官(组件)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ng"><img src="../Images/d88ed174045238f5c4f8dab847954bce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vb3uk46Gdq5e6IVp2vPang.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">建议的建筑X射线。图片作者。弗里皮克的图标。</p></figure><p id="11ba" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们需要做的就是创建数据库，配置Debezium连接器(源和宿)并使用Python部署我们的机器学习模型。</p><h1 id="004d" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">实施</h1><p id="de7a" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我会尽量简短，完整的详细代码将在GitHub上。</p><h2 id="13ba" class="mq kx iq bd ky mr ms dn lc mt mu dp lg lx mv mw li mb mx my lk mf mz na lm nb bi translated">环境</h2><p id="fb3f" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">首先要做的是配置环境，您所需要的是:</p><ol class=""><li id="70c6" class="nh ni iq lq b lr mk lu ml lx nj mb nk mf nl mj nm nn no np bi translated">包含以下包的Python环境:</li></ol><pre class="kg kh ki kj gt nq nr ns nt aw nu bi"><span id="6bf2" class="mq kx iq nr b gy nv nw l nx ny">numpy<br/>pandas<br/>scikit-learn==1.1.2<br/>xgboost==1.6.1<br/>bentoml<br/>pydantic</span></pre><p id="b826" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">用于训练和部署机器学习模型。</p><p id="3d2a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">2.Docker和docker-compose。</p><p id="cf25" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">所有的基础设施都是使用容器构建的。此外，我们将使用Postgres作为我们的数据库。</p><p id="8b34" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">仅此而已👍</p><h2 id="d1b7" class="mq kx iq bd ky mr ms dn lc mt mu dp lg lx mv mw li mb mx my lk mf mz na lm nb bi translated">配置Postgres</h2><p id="b7f9" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">Postgres的配置非常简单，我们只需要创建一个表来存储汽车数据，并设置配置wal_level=logical。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">在Postgres中创建表的SQL脚本。</p></figure><p id="cd68" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">因此，Postgres Dockerfile文件是这样的:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure><blockquote class="ob oc od"><p id="9c2f" class="lo lp nc lq b lr mk jr lt lu ml ju lw oe mm lz ma of mn md me og mo mh mi mj ij bi translated">wal_level=logical是Postgres正确使用Debezium所需的配置。</p></blockquote><h2 id="729d" class="mq kx iq bd ky mr ms dn lc mt mu dp lg lx mv mw li mb mx my lk mf mz na lm nb bi translated">配置Debezium和Kafka连接器</h2><p id="b94e" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">开始使用Kafka和Debezium(使用Docker)很简单，只需要正确配置图像和连接器。这个项目中使用的docker-compose和Dockerfile是基于官方库中Debezium的一个例子。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure><blockquote class="ob oc od"><p id="d0ba" class="lo lp nc lq b lr mk jr lt lu ml ju lw oe mm lz ma of mn md me og mo mh mi mj ij bi translated">注意:我隐藏了一些行以使这个代码块更短，请查看GitHub上的完整代码。</p></blockquote><p id="1b3e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">Debezium Dockerfile配置了Kafka Connect和Postgres的驱动程序。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="3513" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">有了这个docker-compose文件，我们就可以配置Debezium了。要启动容器，请在终端中键入:</p><pre class="kg kh ki kj gt nq nr ns nt aw nu bi"><span id="9e91" class="mq kx iq nr b gy nv nw l nx ny">docker-compose up --build</span></pre><p id="4762" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在一些初始配置(和大量日志)之后，容器应该可以正确启动。现在你可以在<strong class="lq ir"> localhost:8083 </strong>上打开你的浏览器。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/08262f940bab5665179234b637ac7900.png" data-original-src="https://miro.medium.com/v2/resize:fit:936/format:webp/1*BlQ_lv7ZQq49o6H-_jUYbA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">本地主机:8083。图片作者。</p></figure><p id="58c8" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这是Debezium的API的基本端点，所有的配置都发生在这里。例如，如果我们移动到<strong class="lq ir">localhost:8083/connector-plugins/</strong>，就可以看到所有可用于创建连接器的插件。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/ad11c95252849ae5b1c0d4a982a375b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1058/format:webp/1*VsWhBCLTNWinQqmcgHURrg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">localhost:8083/连接器插件。图片作者。</p></figure><p id="501c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">为了创建一个新的数据库连接器，我们需要向端点<strong class="lq ir">/连接器</strong>发送一个POST请求，其中包含连接器的配置。如前所述，有两种类型的连接器，源连接器从数据库中检索更改并将其传输到Kafka，接收器连接器从Kafka读取消息并将其反映到数据库。</p><p id="f152" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我们为Postgres数据库创建源连接器，看看它是如何工作的。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="1ecb" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们只需要传递数据库地址和凭证、连接器类(端点<strong class="lq ir"> /connector-plugins/ </strong>中可用的一个)以及我们想要捕获的表。</p><blockquote class="ob oc od"><p id="f203" class="lo lp nc lq b lr mk jr lt lu ml ju lw oe mm lz ma of mn md me og mo mh mi mj ij bi translated">你可以在这篇文章中了解更多关于这些连接器和配置的信息。</p></blockquote><p id="b874" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在，Debezium将创建一个名为<em class="nc">car _ database . public . car _ data</em>的Kafka主题，并开始对其进行流式修改。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oj"><img src="../Images/84825bab829ea021a282c5ed42b5b78e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G9GBRMWyuDeiG81vdB7MVg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">流向卡夫卡的记录示例。图片作者。</p></figure><p id="fe40" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在上面的图片中，在左边，我们可以看到我添加到数据库中的条目，在右边，是在Kafka上创建的消息。消息是用AVRO写的，<a class="ae kv" href="https://www.confluent.io/blog/avro-kafka-data/" rel="noopener ugc nofollow" target="_blank">可以理解为一个JSON，分为“payload”和“schema”</a>。</p><p id="2979" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">接收器连接器的配置遵循相同的逻辑，但是在这种情况下，我们还需要为我们的主题命名。Debezium将使用主题的标题自动创建sink表(如果它不存在),根据发送的第一条消息推断列。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="d878" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这就是为什么我们不需要在Postgres中创建第二个表:它将由Debezium自动生成。</p><h2 id="18ca" class="mq kx iq bd ky mr ms dn lc mt mu dp lg lx mv mw li mb mx my lk mf mz na lm nb bi translated">用BentoML部署我们的模型</h2><p id="eef5" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">接下来要做的就是用BentoML部署我们的机器学习模型。这是通过三个步骤实现的:保存我们的模型，构建一个便当，并将其转换为Docker容器。</p><p id="4818" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">保存一个模型与保存任何文件没有太大的不同，您只需给它一个名称，并使用save_model函数将它保存在磁盘上。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="5cab" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">BentoML提供了许多功能来<a class="ae kv" href="https://docs.bentoml.org/en/latest/concepts/model.html" rel="noopener ugc nofollow" target="_blank">监控和版本化保存的模型</a>，这些都是值得检查的。</p><p id="ccd7" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">有了保存的模型，我们可以构建一个服务来部署它。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="c4fd" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">训练好的模型作为<em class="nc">跑步者</em>被加载，这是BentoML用来表示模型的一种特殊类型的对象。<a class="ae kv" href="https://docs.bentoml.org/en/latest/concepts/service.html" rel="noopener ugc nofollow" target="_blank">runner用于创建一个<em class="nc">服务</em>对象</a>，并使用它定义<strong class="lq ir"> / <em class="nc">预测</em> </strong>端点，负责接收记录并返回其预测价格。</p><p id="d33f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在部署我们的模型之前要做的最后一件事是定义一个<strong class="lq ir"> bentofile </strong>，BentoML使用这个特殊的配置文件来描述部署环境。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="41c0" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">然后，通过运行下面的命令，<a class="ae kv" href="https://docs.bentoml.org/en/latest/concepts/deploy.html#containerize-bentos" rel="noopener ugc nofollow" target="_blank">我们用我们的名为<strong class="lq ir">Ford _ price _ predictor:1 . 0 . 0</strong>的服务创建一个Docker映像</a>。</p><pre class="kg kh ki kj gt nq nr ns nt aw nu bi"><span id="85ce" class="mq kx iq nr b gy nv nw l nx ny">bentoml build --version 1.0.0<br/>bentoml containerize ford_price_predictor:1.0.0</span></pre><p id="9d9a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">最后，我们可以启动服务的容器实例。</p><pre class="kg kh ki kj gt nq nr ns nt aw nu bi"><span id="7e94" class="mq kx iq nr b gy nv nw l nx ny">docker run -p 3000:3000 ford_price_predictor:1.0.0</span></pre><p id="561d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">并通过访问<strong class="lq ir"> localhost:3000 </strong>与之交互。</p><h2 id="b68c" class="mq kx iq bd ky mr ms dn lc mt mu dp lg lx mv mw li mb mx my lk mf mz na lm nb bi translated">连接流和模型</h2><p id="57bd" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">现在，我们已经构建了管道的两个主要部分，剩下的就是连接它们，这将使用python脚本来实现。</p><p id="5289" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">一方面，Debezium将数据流式传输到Kafka主题<em class="nc">car _ database . public . car _ data</em>，并等待<em class="nc"> car_data_predicted </em>中的消息。另一方面，BentoML服务被部署并等待端点上的预测<strong class="lq ir">/预测</strong>。</p><p id="b51d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">为了连接到Kafka，我们将使用<em class="nc"> confluent_kafka </em>包，并且为了连接到部署的模型，<em class="nc">请求</em>包。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="9565" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">接下来，我们定义Kafka主题和便当服务URL。<br/><em class="nc">URL不是localhost，因为这个脚本将在另一个容器中运行。</em></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="4c44" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">然后，为源主题创建一个Kafka消费者，为接收器主题创建一个生产者。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="8556" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">消费者从源主题中一次检索一条消息。然后，从每条消息中只提取进行预测所需的字段。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="0544" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">消息通过POST请求发送到机器学习模型，该请求返回预测价格。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="a3ef" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">最后，预测价格被添加到原始消息中，以便生产者可以将其发送到接收器主题。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="0697" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">Debezium将读取这个新消息，并在数据库中创建相应的记录。</p><p id="fcd2" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们可以收工了！</p><h2 id="fa88" class="mq kx iq bd ky mr ms dn lc mt mu dp lg lx mv mw li mb mx my lk mf mz na lm nb bi translated">看到它工作</h2><p id="47a9" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">终于到了看到我们的项目工作的时候了:)</p><p id="0054" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">不幸的是，我没有一个花哨的应用程序来测试我们的管道，所以我们将通过直接与数据库交互来完成。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ok"><img src="../Images/0d3d6a32218ca3629f1b9fd292baa037.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*jrh1-yPPlsHT99NAgQDYVw.gif"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">添加示例记录。图片作者。</p></figure><p id="a351" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">正如我们在gif中看到的，当在<em class="nc"> car_data、</em>中添加一条新记录时，在<em class="nc">car _ data _ predicted</em>表中会自动创建另一条记录，并给出建议价格。</p><p id="eb38" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">如果我们继续在<em class="nc"> car_data </em>表中添加越来越多的记录。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ol"><img src="../Images/9d92c2fbdb6f2d255c607920bf21f541.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yHmrDEixJn51JlkVHszUdA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">记录已添加。图片作者。</p></figure><p id="0412" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">它们将与建议价格一起复制到<em class="nc"> car_data_predicted </em>表中。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi om"><img src="../Images/07031f400f78e9e352fb4c8ed8a98da4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tu7Wli_L0YhWkJHY-YCxzQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">预测价格的记录。图片作者。</p></figure><p id="386a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">综上所述，奏效了！</p><h1 id="645f" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">结论</h1><p id="9514" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">将机器学习项目投入使用不是一项简单的任务，就像任何其他软件产品一样，它需要许多不同种类的知识:基础设施、商业、数据科学等。</p><p id="3bb2" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我必须承认，在很长一段时间里，我只是忽略了基础设施部分，让我的项目在Jupiter笔记本中平静地休息。但是当我开始学习它的时候，我意识到这是一个非常有趣的话题。</p><p id="4626" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">机器学习仍然是一个不断发展的领域，与其他IT相关领域(如Web开发)相比，社区仍然有很多东西需要学习。幸运的是，在过去的几年中，我们已经看到了许多新技术的出现，帮助我们构建一个ML应用程序，如Mlflow，Apache Spark的Mlib和BentoML，在这篇文章中进行了探讨。</p><p id="a3b1" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在这篇文章中，我们探索了一种机器学习架构，并利用其中的一些技术来构建一个实时价格推荐系统。为了将这一概念付诸实践，我们不仅需要与ML相关的工具(BentoML &amp; Scikit-learn)，还需要其他软件(Postgres、Debezium、Kafka)。</p><p id="63da" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">当然，这是一个简单的项目，甚至没有用户界面，但是这篇文章中探讨的概念可以很容易地扩展到许多情况和真实场景。</p><p id="22c9" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我希望这篇文章在某种程度上帮助了你，我不是所讨论的任何主题的专家，我强烈建议进一步阅读(见下面的一些参考资料)。</p><p id="0af9" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">感谢您的阅读！；)</p><h1 id="4db0" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">参考</h1><blockquote class="ob oc od"><p id="031a" class="lo lp nc lq b lr mk jr lt lu ml ju lw oe mm lz ma of mn md me og mo mh mi mj ij bi translated"><em class="iq">所有的代码都可以在</em> <a class="ae kv" href="https://github.com/jaumpedro214/ml-streming-kafka-cdc" rel="noopener ugc nofollow" target="_blank"> <em class="iq">这个GitHub资源库</em> </a> <em class="iq">中找到。</em></p></blockquote><p id="6580" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">[1] <a class="ae kv" href="https://debezium.io/" rel="noopener ugc nofollow" target="_blank"> Debezium官方文档</a><br/>【2】Jiri Pechanec(2017)<a class="ae kv" href="https://debezium.io/blog/2017/09/25/streaming-to-another-database/" rel="noopener ugc nofollow" target="_blank">将数据流式传输到下游数据库</a> — Debezium博客<br/>【3】<a class="ae kv" href="https://docs.bentoml.org/en/latest/reference/api_io_descriptors.html#structured-data-with-json" rel="noopener ugc nofollow" target="_blank">Bentoml API I/O描述符</a> — BentoML文档<br/>【4】<a class="ae kv" href="https://docs.bentoml.org/en/latest/concepts/bento.html" rel="noopener ugc nofollow" target="_blank">Bentoml概念</a> — BentoML文档<br/>【5】Kai Waehner(2020)<a class="ae kv" href="https://www.kai-waehner.de/blog/2020/10/27/streaming-machine-learning-kafka-native-model-server-deployment-rpc-embedded-streams/" rel="noopener ugc nofollow" target="_blank">流式机器学习与Kafka-原生模型</a> — BentoML博客<br/>【7】<a class="ae kv" href="https://github.com/debezium/debezium-examples/blob/main/unwrap-smt/docker-compose.yaml" rel="noopener ugc nofollow" target="_blank">Debezium实例</a> — Debezium官方知识库在Github上<br/>【8】本·迪克森(2022)<a class="ae kv" href="https://bdtechtalks.com/2022/07/05/github-copilot-large-language-model-product-management/" rel="noopener ugc nofollow" target="_blank">Github Copilot是首批基于大型语言模型的真实产品</a> —技术会谈<br/>【9】<a class="ae kv" href="https://www.kaggle.com/datasets/mysarahmadbhat/ford-used-car-listing" rel="noopener ugc nofollow" target="_blank">福特二手车上市</a>、<a class="ae kv" href="https://creativecommons.org/publicdomain/zero/1.0/" rel="noopener ugc nofollow" target="_blank"> CC0:公共领域</a> — Kaggle</p></div></div>    
</body>
</html>