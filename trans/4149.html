<html>
<head>
<title>How to deploy your ML model using DagsHub+MLflow+AWS Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用DagsHub+MLflow+AWS Lambda部署您的ML模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-deploy-your-ml-model-using-dagshub-mlflow-aws-lambda-c85e07b06ef6#2022-09-14">https://towardsdatascience.com/how-to-deploy-your-ml-model-using-dagshub-mlflow-aws-lambda-c85e07b06ef6#2022-09-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7658" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">一个直观的教程，展示了如何部署训练好的模型并对新数据进行预测</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/05e473179d2f72111f20ce6f7d8bf842.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7QhlCo4ejb2doP3C"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@z734923105" rel="noopener ugc nofollow" target="_blank">张杰瑞</a>在<a class="ae ky" href="https://unsplash.com/photos/OnXvKZldSJ0" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><p id="001a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">机器学习模型的部署是数据科学家最重要的技能之一。清理数据、从数据集中选择最佳要素、设置超参数并训练模型后，最后一步是将模型投入生产，以便根据新数据对其进行评估。</p><p id="6c2f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有许多方法可以部署模型。第一种方法是使用像Flask和Django这样的web托管框架。另一种方法是利用众所周知的云平台框架，如AWS Sagemaker和Azure ML framework。第三种也是最后一种方式是利用无服务器计算服务，如<strong class="lb iu"> </strong> <em class="lv"> AWS Lambda、</em> <strong class="lb iu"> </strong> Google Cloud函数和Azure函数。</p><p id="b88f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇文章中，我们将在<strong class="lb iu"> AWS Lambda </strong>上投入生产一个经过训练的模型，这是一个由亚马逊提供的计算平台，作为亚马逊Web服务的一部分，使开发人员能够部署模型和构建应用程序。它还允许避免设置任何环境，并加快我们的工作。我们开始吧！</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="fde1" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">我们试图解决什么问题？</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mv"><img src="../Images/aed4ffb00516f41c206b67caa1c5dca6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*59VrJ6yjD5Y3TVq0Pokkfw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">训练和部署模型以从ECG信号中检测异常。来源:<a class="ae ky" href="https://www.flaticon.com/premium-icon/programmer_3270999?related_id=3270999&amp;origin=search" rel="noopener ugc nofollow" target="_blank"> flaticon </a></p></figure><p id="8422" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将训练和部署一个模型来从ECG信号中检测不规则的心律。由于与正常心律相比，不规则心律通常占少数，我们正在解决异常检测问题。对于机器学习模型来说，这是一项具有挑战性的任务，但如果它工作良好，它将使专业技术人员和医生能够快速检测患者的心律失常，避免任何手动和重复工作。</p><p id="b6d1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本教程中，我们将使用<a class="ae ky" href="http://www.timeseriesclassification.com/description.php?Dataset=ECG5000" rel="noopener ugc nofollow" target="_blank"> ECG5000数据集</a>，其中包含从一名心力衰竭患者身上随机选取的5000次心跳。它最初是在PhysioNet中发现的，这是一个可供研究人员使用的医疗数据存储库，指示心律是否异常的类值是通过自动注释获得的。</p><h1 id="29b1" class="md me it bd mf mg mw mi mj mk mx mm mn jz my ka mp kc mz kd mr kf na kg mt mu bi translated">动机</h1><p id="4d84" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">数据科学家不仅需要建立机器模型，还需要跟踪实验、版本数据、代码和模型。其实不同的目的有不同的平台。GitHub拥有不同版本的代码和数据，并与其他队友协作，MLflow是最常用的跟踪和部署模型的平台之一。但是从一个平台到另一个平台可能是低效的。</p><p id="6b7e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">直接用一个平台不是更好吗？此外，GitHub在处理数据版本和不允许大文件方面并不真正高效。由于这些原因，我在这个项目中使用DagsHub。这是一个能够更有效地比较不同实验和数据版本的平台。界面很直观，和GitHub上的非常相似。换句话说，这就像在一个独特的地方使用GitHub和MLflow。在这里查看文档，开始使用<a class="ae ky" href="https://dagshub.com/docs/getting_started/create_a_dagshub_project/" rel="noopener ugc nofollow" target="_blank"> DagsHub </a>及其要求。</p><h1 id="8f10" class="md me it bd mf mg mw mi mj mk mx mm mn jz my ka mp kc mz kd mr kf na kg mt mu bi translated">设置DVC并将DagsHub配置为DVC远程存储</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/c0e95083750bd40913f1d69401db8cf6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pI9XbSeNAW7sOleZQaozrA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">最终DagsHub管道概述。作者插图。</p></figure><p id="71c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦您创建了DagsHub存储库，并且在您的本地PC上有了它的副本，我建议您将Visual Studio代码作为IDE来使用，因为它通过扩展支持多种语言，并且包含了一个终端，这在本部分和接下来的部分中是需要的。</p><p id="9164" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Dagshub的美妙之处在于，您可以在存储库中找到所有结果实验，并轻松地更改相关的列来比较这些实验。这是可能的，因为DagsHub是建立在GitHub和<a class="ae ky" href="https://dvc.org/" rel="noopener ugc nofollow" target="_blank"> DVC </a>之上的，这是一个工具，使您能够在Git提交中捕获您的数据和模型的版本。</p><p id="8f35" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们需要在本地环境中安装DVC:</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="6573" class="nm me it ni b gy nn no l np nq">pip install dvc</span></pre><p id="1458" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">关于更详细的说明，还有这个<a class="ae ky" href="https://dvc.org/doc/install/linux" rel="noopener ugc nofollow" target="_blank">网站</a>展示了与macOS、Windows和Linux一起工作时的不同解决方案。</p><p id="8429" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">安装完成后，我们可以在我们的项目中运行<code class="fe nr ns nt ni b">dvc init</code>。这是DVC初始化和创建包含配置的新的<code class="fe nr ns nt ni b"><a class="ae ky" href="https://dvc.org/doc/user-guide/project-structure/internal-files" rel="noopener ugc nofollow" target="_blank">.dvc/</a></code>目录的重要一步。</p><p id="569e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要在DagsHub上上传数据，您可以在您的存储库中找到必要的命令行。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/c6167b6571536488152efbd8676a350d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1264/format:webp/1*SlTHSAt3C-4m26lcGFuplQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">从DVC开始。作者插图。</p></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h2 id="cad8" class="nm me it bd mf nv nw dn mj nx ny dp mn li nz oa mp lm ob oc mr lq od oe mt of bi translated">目录:</h2><ul class=""><li id="4614" class="og oh it lb b lc nb lf nc li oi lm oj lq ok lu ol om on oo bi translated"><a class="ae ky" href="#807a" rel="noopener ugc nofollow"> <strong class="lb iu">第1部分:带MLflow跟踪的Keras模型训练</strong> </a></li><li id="81dc" class="og oh it lb b lc op lf oq li or lm os lq ot lu ol om on oo bi translated"><a class="ae ky" href="#e3ca" rel="noopener ugc nofollow"> <strong class="lb iu">第2部分:使用BentoML和AWS Lambda </strong> </a>部署模型</li></ul></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="807a" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">第1部分:使用MLflow跟踪的Keras模型训练</h1><p id="d517" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">在我们准备好环境之后，我们可以开始使用MLflow，这是一个非常高效的开源平台，可以跟踪实验，打包机器学习模型，并将其部署到生产中。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ou"><img src="../Images/361a586bde44da21b128f9d3f983e922.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*C1RRN5e_WkWEOhWyRyVEYQ.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者插图。</p></figure><p id="8a00" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面几行代码对于创建环境变量至关重要。通过单击Remote按钮下的MLflow选项，可以将您的凭据复制到DagsHub存储库中。用户名和密码包含在parameters.yaml文件中。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="c58e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">之后，我们终于可以利用MLflow来记录超参数、度量和模型人工制品。</p><p id="91f0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nr ns nt ni b">mlflow.tensorflow.autolog()</code>允许从Tensorflow到MLflow自动记录指标，如优化器和时期数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="d8df" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在脚本的最后，我们还使用<code class="fe nr ns nt ni b">Autoencoder.save(Path("Autoencoder"))</code>将模型保存到本地PC上的一个文件中。之后，我们加载模型并保存到BentoML本地存储</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="a91c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">这里</em>  <em class="lv">可以找到train.py </em> <a class="ae ky" href="https://dagshub.com/eugenia.anello/anomaly_detection_ecg/src/branch_2/src/train.py" rel="noopener ugc nofollow" target="_blank"> <em class="lv">的完整代码。</em></a></p><p id="227b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以运行python脚本train.py，并每次更改超参数，以了解哪些超参数对提高自动编码器检测ECG信号异常的性能贡献更大。</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="f93c" class="nm me it ni b gy nn no l np nq">cd src<br/>python train.py</span></pre><p id="b884" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Dagshub的美妙之处在于，您可以在存储库中找到所有结果实验，并轻松地更改相关的列来比较这些实验。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ou"><img src="../Images/b5f50ef9e934b23461cec2e119e2bd0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*iMm_5YkarMfmOWtB5GCuMw.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">显示MLflow实验的表格。作者GIF。</p></figure><p id="68f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它不仅允许将结果收集到一个表格中，而且还可以用一个更加直观和完整的表格来比较不同的运行，该表格包含为每个实验选择的所有超参数。此外，还有一个平行坐标图，用于关注前5个超参数对损失和其他图表的贡献，这些图表比较了不同实验的评估指标。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ou"><img src="../Images/b8e2cb1cbdc303afa163481d1376dd48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*i3IP2uWrspK4VW1YX9a_yQ.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">比较不同的实验。作者GIF。</p></figure><h1 id="e3ca" class="md me it bd mf mg mw mi mj mk mx mm mn jz my ka mp kc mz kd mr kf na kg mt mu bi translated">第2部分:用BentoML和AWS Lambda部署模型</h1><p id="b82b" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">这项任务可以分为不同的步骤:</p><ul class=""><li id="5f5e" class="og oh it lb b lc ld lf lg li ox lm oy lq oz lu ol om on oo bi translated">创建BentoML服务</li><li id="5bf1" class="og oh it lb b lc op lf oq li or lm os lq ot lu ol om on oo bi translated">做便当</li><li id="228d" class="og oh it lb b lc op lf oq li or lm os lq ot lu ol om on oo bi translated">部署到AWS Lambda</li></ul></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h2 id="e60f" class="nm me it bd mf nv nw dn mj nx ny dp mn li nz oa mp lm ob oc mr lq od oe mt of bi translated">创建BentoML服务</h2><p id="ca59" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">在继续之前，让我们通过在终端上编写以下命令行来检查存储在BentoML本地商店中的所有模型:</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="d589" class="nm me it ni b gy nn no l np nq">bentoml models list</span></pre><p id="f98f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它返回以下输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pa"><img src="../Images/a0d13d91b270d0d80eb80528abd7a7e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dK_C3WA813rF1lVqNZSi0A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者插图。</p></figure><p id="498e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如您可以从存储模型的列表中推断的那样，它们是根据创建时间以降序排列的。因此，我们对带有以下标签的模型感兴趣:<code class="fe nr ns nt ni b">keras_model:pdthevrih6w2iaav</code>。</p><p id="00e4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们已经确定模型存储在Bento中，我们可以创建一个名为<code class="fe nr ns nt ni b">service.py</code>的文件，在其中我们创建一个服务来部署我们的深度学习模型。这将导致API端点的创建。</p><p id="fd55" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们指定我们想要的模型标签，然后，我们在Keras模型上创建一个转轮实例。在我们创建了一个属于类<code class="fe nr ns nt ni b">bentoml.Service</code>的实例之后，我们指定服务的名称<code class="fe nr ns nt ni b">ecg_model</code>和之前定义的运行器。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="4278" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们为BentoML服务创建一个端点，称为<code class="fe nr ns nt ni b">predict</code>。您还可以注意到有一个由@，service表示的装饰器，它是前面定义的服务实例。输入和输出的类型也在装饰器中指定，都是<em class="lv"> bentoml.io.NumpyNdarray </em>。点击此处查看更多<a class="ae ky" href="https://docs.bentoml.org/en/v1.0.0-a7/concepts/api_io_descriptors.html" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="3b93" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">你可以在这里</em>  <em class="lv">找到service.py </em> <a class="ae ky" href="https://dagshub.com/eugenia.anello/anomaly_detection_ecg/src/branch_2/service.py" rel="noopener ugc nofollow" target="_blank"> <em class="lv">的完整代码。</em></a></p><p id="aa56" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在函数predict中，我们再次期望输入一个NumPy数组，因为我们有一个由140个要素和一个目标标签组成的数据集。输出的类型也是一个数组，它告诉我们ECG信号是否异常。在获得最终输出之前有几个步骤。</p><p id="16ba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第一步是使用预训练的自动编码器重建原始输入。然后，我们计算原始输入和自动编码器产生的输出之间的损耗，并检查损耗是否大于模型训练结束后计算的固定阈值。</p><p id="2f66" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们可以使用以下命令行运行服务:</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="7ccb" class="nm me it ni b gy nn no l np nq">bentoml serve service.py:service --reload</span></pre><p id="af9e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">输出:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="6a8e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">之后，我们可以发出服务请求，以检查经过培训的模型是否正常工作。所有的代码都在一个名为<code class="fe nr ns nt ni b">servicerequest.py</code>的文件中。我们从测试集中随机选择10个数据观察值，并将它们传递给训练好的模型，并通过向BentoML服务发出请求来提供基于这些观察值的预测。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="3b0e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">你可以在这里</em>  <em class="lv">找到service request . py</em><a class="ae ky" href="https://dagshub.com/eugenia.anello/anomaly_detection_ecg/src/branch_2/servicerequest.py" rel="noopener ugc nofollow" target="_blank"><em class="lv">的完整代码。</em></a></p><p id="c239" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当前面的命令行仍在运行时，我们可以在另一个终端中编写这个命令行:</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="7904" class="nm me it ni b gy nn no l np nq">python servicerequest.py</span></pre><p id="2a1d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">输出:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="a6fe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">似乎模型预测对10个数据点中的10个是正确的！在您的浏览器中打开<a class="ae ky" href="http://127.0.0.1:3000" rel="noopener ugc nofollow" target="_blank"> http://127.0.0.1:3000 </a>，您应该会看到这样一个窗口:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pb"><img src="../Images/91546b8c079c5bd2d5ccb6e2da7f5aa6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HEN7wMq13_YE_a0e6XSmnA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者插图。</p></figure><h2 id="2430" class="nm me it bd mf nv nw dn mj nx ny dp mn li nz oa mp lm ob oc mr lq od oe mt of bi translated">做便当</h2><p id="932b" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">一旦我们定义了BentoML服务，我们就可以将所有的源代码、模型文件和依赖项放入一个名为Bento的档案中。做便当，有尊重的要求。我们需要在项目文件夹中创建文件<code class="fe nr ns nt ni b">bentofile.yaml</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="3274" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们可以在终端中运行命令行<code class="fe nr ns nt ni b">bentoml build</code>,并获得如下输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pc"><img src="../Images/9528f98ada7d003c0dc5af82d198cff7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*prGc1-nKy8C9-QhBvX2hKg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者插图。</p></figure><p id="0f00" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以用命令行<code class="fe nr ns nt ni b">bentoml list</code>再次可视化我们的便当列表:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pd"><img src="../Images/b5cee08b07635d68a7b303a393b0bf8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*THIRdLcLuI54cgDurpokaA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者插图。</p></figure><p id="3945" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">恭喜你！困难的部分已经完成了。模型、服务、Python需求和Docker文件被保存到前面输出指定的文件夹中。</p><h2 id="87dc" class="nm me it bd mf nv nw dn mj nx ny dp mn li nz oa mp lm ob oc mr lq od oe mt of bi translated">部署到AWS Lambda</h2><p id="cf10" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">这是我们将要执行的步骤的摘要:</p><ol class=""><li id="b493" class="og oh it lb b lc ld lf lg li ox lm oy lq oz lu pe om on oo bi translated">创建AWS帐户并配置凭据</li><li id="31a5" class="og oh it lb b lc op lf oq li or lm os lq ot lu pe om on oo bi translated">用bentoctl初始化部署。</li><li id="7544" class="og oh it lb b lc op lf oq li or lm os lq ot lu pe om on oo bi translated">构建并推送与AWS Lambda兼容的Docker映像</li><li id="8188" class="og oh it lb b lc op lf oq li or lm os lq ot lu pe om on oo bi translated">使用Terraform应用部署</li></ol><p id="d9a5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您发现任何问题，这里还有这些步骤的详细文档。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><ol class=""><li id="01c2" class="og oh it lb b lc ld lf lg li ox lm oy lq oz lu pe om on oo bi translated"><strong class="lb iu">创建AWS帐户并配置凭证</strong></li></ol><p id="d78a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将把我们的异常检测模型作为Lambda函数部署在AWS上。首先，你需要在这里创建一个<strong class="lb iu"> AWS账户</strong> <a class="ae ky" href="https://aws.amazon.com/free/?trk=74082305-452d-479a-b9dd-603d703a3cd2&amp;sc_channel=ps&amp;s_kwcid=AL!4422!3!455721528479!e!!g!!aws&amp;ef_id=Cj0KCQjw6_CYBhDjARIsABnuSzpKbPLLcoY3c7gXWg98jRgpVJxTbY22LUz7MtYRuEXVJpG-H74_soMaAuvqEALw_wcB:G:s&amp;s_kwcid=AL!4422!3!455721528479!e!!g!!aws&amp;all-free-tier.sort-by=item.additionalFields.SortRank&amp;all-free-tier.sort-order=asc&amp;awsf.Free%20Tier%20Types=*all&amp;awsf.Free%20Tier%20Categories=*all" rel="noopener ugc nofollow" target="_blank">。不要担心，它允许您免费部署模型:免费层允许AWS Lambda每月100万个请求，这对于像我们这样的小项目来说没有问题。一旦创建了帐户，您需要<strong class="lb iu">配置AWS凭证</strong>。建议你关注这个</a><a class="ae ky" href="https://www.youtube.com/watch?v=qmtDRmplMG4&amp;ab_channel=Webiny" rel="noopener ugc nofollow" target="_blank"> youtube视频</a>。我还建议你在本地电脑上安装Docker Desktop。</p><p id="7b03" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于Linux或osX:</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="a18e" class="nm me it ni b gy nn no l np nq">export AWS_ACCESS_KEY_ID=&lt;YOUR_AWS_ACCESS_KEY_ID&gt;<br/>export AWS_SECRET_ACCESS_KEY=&lt;YOUR_AWS_SECRET_ACCESS_KEY&gt;</span></pre><p id="b73f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于Windows:</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="9328" class="nm me it ni b gy nn no l np nq">setx AWS_ACCESS_KEY_ID &lt;YOUR_AWS_ACCESS_KEY_ID&gt;<br/>setx AWS_SECRET_ACCESS_KEY &lt;YOUR_AWS_SECRET_ACCESS_KEY&gt;</span></pre><p id="1500" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还有两个包需要从终端安装，即<code class="fe nr ns nt ni b">aws-lambda</code>操作符和它的依赖项<code class="fe nr ns nt ni b">boto3</code>包。</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="b1e5" class="nm me it ni b gy nn no l np nq">pip install bentoctl boto3<br/>bentoctl operator install aws-lambda</span></pre><p id="bfdb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> 2。用bentoctl </strong>初始化部署</p><p id="b60b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们用bentoctl初始化部署之后，这是Bento的交互式CLI命令。</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="f8c0" class="nm me it ni b gy nn no l np nq">bentoctl init</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pf"><img src="../Images/7365ba6b2a97bf3daeedaf7c61f7d132.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*IBGlhq64oNXhby70gvDj2g.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者插图。</p></figure><p id="8401" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个命令行将生成三个文件，这是用AWS Lambda、<code class="fe nr ns nt ni b">deployment_config.yaml</code>、<code class="fe nr ns nt ni b">bentoctl.tfvars</code>和<code class="fe nr ns nt ni b">main.tf</code>部署模型所必需的。最后需要安装的软件包是<code class="fe nr ns nt ni b">terraform</code>。查看此处的安装说明<a class="ae ky" href="https://learn.hashicorp.com/tutorials/terraform/install-cli" rel="noopener ugc nofollow" target="_blank">。检查安装是否成功的一个好方法是编写命令行:</a></p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="297f" class="nm me it ni b gy nn no l np nq">terraform --version</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pg"><img src="../Images/71dd1ffabd73561c43bd75d22f9cb8ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CZkV7Fi7HN0YonGQXatiwg.png"/></div></div></figure><p id="3927" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> 3。构建一个AWS Lambda兼容的Docker映像</strong></p><p id="9ec4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们可以构建AWS Lambda兼容的docker映像并将其推送到AWS ECR存储库。</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="dcee" class="nm me it ni b gy nn no l np nq">bentoctl build -b keras_model_ad:latest -f deployment_config.yaml</span></pre><p id="09a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它返回以下输出:</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="f305" class="nm me it ni b gy nn no l np nq">Created the repository keras_model_ad<br/>The push refers to repository [849711432510.dkr.ecr.us-west-1.amazonaws.com/keras_model_ad]<br/>957db15fed12: Pushed <br/>1df100fb8cb9: Pushed <br/>3fef49d17991: Pushed <br/>11e8b0510c67: Pushed <br/>9e9bb09e42f7: Pushing 1022.1MiB/1.4GiB</span><span id="e1aa" class="nm me it ni b gy ph no l np nq">...</span><span id="85ab" class="nm me it ni b gy ph no l np nq">920ee87a2ed2: Pushed <br/>3ce7d4d72da9: Pushed <br/>630337cfb78d: Pushed <br/>6485bed63627: Pushed <br/>🚀 Image pushed!<br/>✨ generated template files.<br/>  - bentoctl.tfvars</span><span id="505b" class="nm me it ni b gy ph no l np nq">bentoctl has built and pushed the bento and generated the terraform files</span></pre><p id="9837" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> 4。使用Terraform应用部署</strong></p><p id="f51d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们可以初始化terraform项目，它将被应用于创建Lambda部署。</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="7324" class="nm me it ni b gy nn no l np nq">terraform init<br/>terraform apply -var-file=bentoctl.tfvars -auto-approve</span></pre><p id="99a1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是我们预期的输出:</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="9b2f" class="nm me it ni b gy nn no l np nq">aws_apigatewayv2_api.lambda: Creating...<br/>aws_iam_role.lambda_exec: Creating...<br/>aws_apigatewayv2_api.lambda: Creation complete after 2s [id=libobddgz8]<br/>aws_cloudwatch_log_group.api_gw: Creating...<br/>aws_iam_role.lambda_exec: Creation complete after 3s [id=keras_model_ad-iam]<br/>aws_iam_role_policy_attachment.lambda_policy: Creating...<br/>aws_lambda_function.fn: Creating...<br/>aws_iam_role_policy_attachment.lambda_policy: Creation complete after 1s [id=keras_model_ad-iam-20220910214539285200000001]<br/>aws_cloudwatch_log_group.api_gw: Creation complete after 5s [id=/aws/api_gw/keras_model_ad-gw]<br/>aws_apigatewayv2_stage.lambda: Creating...<br/>aws_apigatewayv2_stage.lambda: Creation complete after 5s [id=$default]<br/>...<br/></span></pre><p id="ec78" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我的API服务的链接是<a class="ae ky" href="https://libobddgz8.execute-api.us-west-1.amazonaws.com/" rel="noopener ugc nofollow" target="_blank">https://libobddgz8.execute-api.us-west-1.amazonaws.com/</a>。我们可以使用前面几节中显示的文件servicerequest.py快速测试部署的端点。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="35d7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果再次运行servicerequest.py，应该会得到以下输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pi"><img src="../Images/55055fd1137b8145a01613242e9408c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1010/format:webp/1*d4Wsoj1NQ9aYyckQfzrM6A.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者插图。</p></figure><h1 id="dab8" class="md me it bd mf mg mw mi mj mk mx mm mn jz my ka mp kc mz kd mr kf na kg mt mu bi translated">最终想法:</h1><p id="d62e" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">我希望你找到这篇教程，开始用MLflow跟踪你的实验，用BentoML和AWS Lambda部署你的机器学习模型。它是完全免费的，对于初学者来说是一个很好的入门方式。</p><p id="5469" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">查看我的DagsHub存储库中的代码:</p><div class="pj pk gp gr pl pm"><a href="https://dagshub.com/eugenia.anello/anomaly_detection_ecg" rel="noopener  ugc nofollow" target="_blank"><div class="pn ab fo"><div class="po ab pp cl cj pq"><h2 class="bd iu gy z fp pr fr fs ps fu fw is bi translated">eugenia.anello/anomaly_detection_ecg</h2><div class="pt l"><h3 class="bd b gy z fp pr fr fs ps fu fw dk translated">这个项目的目标是从心电图信号中检测出不规则的心律。附有解释的文章是…</h3></div><div class="pu l"><p class="bd b dl z fp pr fr fs ps fu fw dk translated">dagshub.com</p></div></div><div class="pv l"><div class="pw l px py pz pv qa ks pm"/></div></div></a></div></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><p id="bade" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你喜欢我的文章吗？<a class="ae ky" href="https://eugenia-anello.medium.com/membership" rel="noopener"> <em class="lv">成为会员</em> </a> <em class="lv">每天无限获取数据科学新帖！这是一种间接的支持我的方式，不会给你带来任何额外的费用。如果您已经是会员，</em> <a class="ae ky" href="https://eugenia-anello.medium.com/subscribe" rel="noopener"> <em class="lv">订阅</em> </a> <em class="lv">每当我发布新的数据科学和python指南时，您都可以收到电子邮件！</em></p></div></div>    
</body>
</html>