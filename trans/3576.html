<html>
<head>
<title>Rapid Prototyping Using Terraform, GitHub Action, Docker and Streamlit in GCP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在GCP使用Terraform、GitHub Action、Docker和Streamlit进行快速原型制作</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/rapid-prototyping-using-terraform-github-action-docker-and-streamlit-in-gcp-e623ae3fdd54#2022-08-09">https://towardsdatascience.com/rapid-prototyping-using-terraform-github-action-docker-and-streamlit-in-gcp-e623ae3fdd54#2022-08-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="63c6" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用CI/CD工具加速见解共享</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/cda8df6e081557aa2a49cf09891371bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lYrgfXjzRfHocz-C"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">马修·布罗德在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="8081" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">介绍</h1><p id="e1ea" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">数据科学家和分析师是许多组织的宝贵资源。他们将大部分时间用于理解业务需求，并通过数据收集、争论、清理和建模来寻找见解。支持这些数据专家的工具非常丰富，例如，像Jupyter和Colab这样的笔记本、Python或R库以及其他数据技术。</p><p id="5705" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">另一方面，当涉及到与利益相关者分享重要的发现和有价值的见解时，选择是有限的。对于非技术人员来说，笔记本可能不是最佳选择；在像Word和PowerPoint这样的办公文档中分享你的发现通常不能描述你的发现的动态和交互性质。对于数据专家来说，找到以合适的格式快速有效地向决策者展示调查结果的最佳方式通常是一件痛苦的事情。</p><p id="128e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在本文中，我们将展示一种使用CI/CD(持续集成和持续交付)工具(如Terraform、GitHub Actions和Docker with Streamlit applications)与利益相关方共享数据科学发现的方法，这些工具可以加速原型开发。我们将代码部署到谷歌云平台(GCP)的虚拟机上，但是你也可以将这些技术应用到其他云服务提供商。</p><h2 id="2f19" class="mp kx iq bd ky mq mr dn lc ms mt dp lg lx mu mv li mb mw mx lk mf my mz lm na bi translated">工作流程概述</h2><p id="2915" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">本文将指导您创建以下CI/CD管道。</p><p id="996c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">1.在本地写Terraform文件，推送到GitHub。<br/> 2。GitHub Action使用Terraform实现GCP供应自动化。<br/> 3。在本地编写Streamlit app代码和Dockerfile，并将代码推送到GitHub。<br/> 4。通过GitHub Action将代码部署到GCP的虚拟机实例中。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/66adfca33e2e13620f6441ff7fbab445.png" data-original-src="https://miro.medium.com/v2/resize:fit:768/0*qh3pweQXsD8dZTo8"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图一。工作流程概述(作者图片)</p></figure><h2 id="a330" class="mp kx iq bd ky mq mr dn lc ms mt dp lg lx mu mv li mb mw mx lk mf my mz lm na bi translated">先决条件</h2><p id="9baa" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">实施这些解决方案有四个要求。</p><p id="c7f0" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">● GitHub账号<br/> ● Terraform安装<br/> ● GCP服务账号<br/> ● Python库</p><h2 id="188a" class="mp kx iq bd ky mq mr dn lc ms mt dp lg lx mu mv li mb mw mx lk mf my mz lm na bi translated">开源代码库</h2><p id="0444" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">GitHub是一个使用Git的基于web的版本控制服务。它还提供一项名为GitHub Actions的服务。您不需要安装第三方应用程序来自动化测试、发布和将代码部署到生产中的工作流。您可以在<a class="ae kv" href="https://github.com/" rel="noopener ugc nofollow" target="_blank"> GitHub网站</a>上创建一个帐户。</p><h2 id="c66e" class="mp kx iq bd ky mq mr dn lc ms mt dp lg lx mu mv li mb mw mx lk mf my mz lm na bi translated">将（行星）地球化（以适合人类居住）</h2><p id="3975" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">Terraform是一个开源的CI/CD工具，它将基础设施作为代码(IaC)进行管理，由HashiCorp提供。IaC使用代码来管理和配置基础设施，消除了通过云供应商提供的UI手动配置物理硬件的需要。</p><p id="4623" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">使用Terraform进行原型开发有一些优点。例如:</p><ol class=""><li id="c2ef" class="nc nd iq lq b lr mk lu ml lx ne mb nf mf ng mj nh ni nj nk bi translated">避免手动调配基础架构。</li><li id="f13c" class="nc nd iq lq b lr nl lu nm lx nn mb no mf np mj nh ni nj nk bi translated">数据科学家和软件工程师可以自助。</li><li id="2b73" class="nc nd iq lq b lr nl lu nm lx nn mb no mf np mj nh ni nj nk bi translated">对当前设置的改变变得简单明了。</li><li id="80d3" class="nc nd iq lq b lr nl lu nm lx nn mb no mf np mj nh ni nj nk bi translated">易于传递知识和保持版本。</li></ol><p id="9729" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">不需要在本地安装Terraform，就可以通过GitHub Action实现流程自动化，因为GitHub在云中执行工作流。然而，在测试新资源或刚刚开始使用Terraform时，在本地安装软件可能是个好主意。在这种情况下，您需要向Terraform用户提供访问云资源的凭据，这在一些组织中可能是一个安全问题。你可以在<a class="ae kv" href="https://www.terraform.io/downloads" rel="noopener ugc nofollow" target="_blank"> Terraform网站</a>上找到安装说明。</p><h2 id="965f" class="mp kx iq bd ky mq mr dn lc ms mt dp lg lx mu mv li mb mw mx lk mf my mz lm na bi translated">GCP</h2><p id="aab7" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">服务账户(SA)代表谷歌云服务身份，例如，在计算引擎上运行的代码、在云存储中创建桶等。可以从<em class="nq"> IAM和管理</em>控制台创建sa。出于原型制作目的，请为帐户选择编辑者角色，以查看、创建、更新和删除资源。你可以参考谷歌云的<a class="ae kv" href="https://cloud.google.com/iam/docs/creating-managing-service-accounts" rel="noopener ugc nofollow" target="_blank">官方指南</a>。本文使用了计算引擎、云存储和VPC网络。</p><h2 id="5702" class="mp kx iq bd ky mq mr dn lc ms mt dp lg lx mu mv li mb mw mx lk mf my mz lm na bi translated">计算机编程语言</h2><p id="9ed3" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我们只用了三个库:Pandas、Yfinance和Streamlit。Pandas是一个开源的数据操作工具。yfinance是一个python API，用于从Yahoo！金融。Streamlit是一个基于Python的web应用框架；与Flask或Django等其他框架相比，您可以用更少的代码开发web应用程序。</p></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><h1 id="8a4b" class="kw kx iq bd ky kz ny lb lc ld nz lf lg jw oa jx li jz ob ka lk kc oc kd lm ln bi translated">1.地形文件</h1><p id="9006" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">Terraform是一个IaC工具。您可以通过编写代码来管理云基础架构。Terraform可以通过各种云提供商提供服务和资源。HashiCorp和Terraform社区编写和维护代码。你可以在Terraform Registry网站上找到你可以使用的提供商列表，包括AWS、Azure和GCP。</p><p id="1a36" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">Terraform的工作流程由三个步骤组成:定义、计划和应用。在定义步骤中，您将编写配置文件来声明提供者、服务和资源。配置文件可以由Terraform使用<em class="nq"> terraform fmt </em>和<em class="nq"> terraform validate </em>命令进行格式化和验证。在计划步骤中，Terraform根据配置文件和现有基础设施的状态创建一个执行计划。它可以创建新的服务或更新/删除现有的服务。最后，应用步骤执行计划的操作，并记录Terraform提供的基础设施的状态。</p><p id="69b9" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们将创建三个Terraform文件:main.tf、variables.tf和terraform.tfvars。</p><h2 id="e767" class="mp kx iq bd ky mq mr dn lc ms mt dp lg lx mu mv li mb mw mx lk mf my mz lm na bi translated">main.tf</h2><p id="cfa8" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">main.tf是一个包含主要配置集的文件。它定义了所需的提供者、提供者变量和资源。该文件的内容如下:</p><p id="4595" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">首先，定义提供者。在本文中，我们将使用google。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="e8d6" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">定义了提供者的变量。var。*将从单独的文件variables.tf中导入值。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="7c3b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">credentials_file应该是从GCP下载的json中服务帐户密钥的路径。</p><p id="d600" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">接下来的脚本创建了一个VPC网络。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="d176" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">然后，我们配置一个虚拟机实例。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="93b1" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们指定虚拟机实例名称、机器类型、磁盘映像和网络接口。我们还添加标签并定义启动脚本。标记允许您将防火墙规则应用于VM实例。我们创建了三个标记，分别对应于下面定义的三个防火墙规则。metadata_startup_script在启动时运行shell脚本。在我们的例子中，我们将运行脚本在虚拟机中预安装Docker引擎。</p><p id="6ee2" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">下一个特定的http访问防火墙规则。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="0a2c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">您可以通过CIDAR格式的source_ranges来限制访问。</p><p id="c9df" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们可能希望通过SSH访问VM实例。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="d036" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">第三个防火墙规则是针对Streamlit web应用程序的。端口8501将被打开。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="fda8" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">最终的资源定义是针对云存储的。它使用从variables.tf文件中读取的变量创建新的bucket。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><h2 id="df19" class="mp kx iq bd ky mq mr dn lc ms mt dp lg lx mu mv li mb mw mx lk mf my mz lm na bi translated">变量. tf</h2><p id="7817" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">var的值。*由variables.tf文件提供。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="c60f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">每个变量都可以有一个默认值。在我们的例子中，一些变量没有默认值。因为它们是必需的参数，所以Terraform需要提供它们。提供变量的方法之一是通过*。tfvar文件，减少了一些敏感信息的暴露。</p><h2 id="22a4" class="mp kx iq bd ky mq mr dn lc ms mt dp lg lx mu mv li mb mw mx lk mf my mz lm na bi translated">terraform.tfvars</h2><p id="6ef5" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我们在terraform.tfvars文件中有三行。请用您的值替换“***”。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><h2 id="325f" class="mp kx iq bd ky mq mr dn lc ms mt dp lg lx mu mv li mb mw mx lk mf my mz lm na bi translated">GCP机器类型和图像列表</h2><p id="b52d" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在main.tf中，我们指定了机器类型和磁盘映像。接受的值可能不总是与您在GCP控制台上看到的描述相同。您可以使用以下gcloud命令检索机器类型列表和计算引擎映像。(必须安装谷歌云SDK。如果没有，请参考<a class="ae kv" href="https://cloud.google.com/sdk/docs/install" rel="noopener ugc nofollow" target="_blank">官方指南</a></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="0573" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">g云计算映像列表</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><h1 id="3901" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">Docker安装脚本</h1><p id="01cc" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我们将docket安装到虚拟机实例中。在main.tf文件所在的目录中找到安装脚本install_docker.sh。Ubuntu的安装脚本复制自官方<a class="ae kv" href="https://docs.docker.com/engine/install/ubuntu/" rel="noopener ugc nofollow" target="_blank"> Docker Doc网站</a>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><h1 id="a87c" class="kw kx iq bd ky kz ny lb lc ld nz lf lg jw oa jx li jz ob ka lk kc oc kd lm ln bi translated">2.GitHub行动——GCP</h1><p id="9370" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">GitHub操作允许您构建自动化的CI/CD管道。公共存储库免费，私人存储库包含2000分钟<a class="ae kv" href="https://docs.github.com/en/billing/managing-billing-for-github-actions/about-billing-for-github-actions" rel="noopener ugc nofollow" target="_blank">【1】</a>。</p><p id="ca90" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">GitHub动作读取了<a class="ae kv" href="https://en.wikipedia.org/wiki/YAML" rel="noopener ugc nofollow" target="_blank">下保存的YAML </a>文件。github/workflows/repository中的目录并执行文件中定义的工作流。一个工作流可以有多个作业，每个作业都有一个或多个步骤。一个步骤可以有动作，但不是所有的步骤都可以执行一个动作。</p><p id="2981" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">文件内容如下:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="7598" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">首先，我们定义工作流名称和触发器，即<em class="nq"> push </em>到主分支。接下来，我们添加关于作业的信息</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="d857" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">上面的作业在服务器端的ubuntu机器上运行。每个作业在一个新的实例上运行；因此，每个作业下定义的环境变量不能用于另一个作业。</p><p id="1eda" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">接下来，我们指定步骤和动作。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="0a26" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">第二步，我们将使用秘密。GCP萨基。这些秘密存储在存储库的动作秘密中。GitHub支持base64编码的秘密。您可以使用Python将GCP服务帐户密钥编码为base64格式的JSON:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="7383" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">Terraform init步骤通过下载提供者插件启动工作目录的准备。我们还在后端配置中指定了一个GCS bucket名称。</p><p id="f8c4" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">如果您将目前准备好的文件从本地驱动器提交到主驱动器，GitHub工作流会自动运行并提供服务。你可以在GitHub Action页面查看执行日志。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi of"><img src="../Images/e594617f5bc316a8e162305813a22914.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*AoWV6m3QSy93OKhH"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图二。GitHub动作工作流程日志(图片由作者提供)</p></figure></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><h1 id="e640" class="kw kx iq bd ky kz ny lb lc ld nz lf lg jw oa jx li jz ob ka lk kc oc kd lm ln bi translated">3.Streamlit和Dockerfile</h1><p id="d7a6" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在前面的章节中，我们使用Terraform和GitHub操作准备了基础设施。我们现在用Streamlit和Docker准备运行在GCP虚拟机实例上的web应用程序代码。</p><p id="f85d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">作为一个简单的例子，我们将为Yahoo Finance的时间序列数据创建一个仪表板，显示每日回报率，以便用户可以比较不同的指数或外汇汇率。仪表板用户也可以修改日期范围。</p><p id="0dd8" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们将要创建的仪表板图像如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi og"><img src="../Images/0c22d781cbb495f7645a33b9d05ac69a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OhmwBGatdk6kxHHX"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图3。Streamlit Web应用程序用户界面(图片由作者提供)</p></figure><h2 id="8154" class="mp kx iq bd ky mq mr dn lc ms mt dp lg lx mu mv li mb mw mx lk mf my mz lm na bi translated">Python脚本</h2><p id="5067" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">上面显示的应用程序可以使用Streamlit创建。</p><p id="55fe" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">首先，我们导入三个库。如果没有安装，请使用pip(或pip3) install命令安装它们。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="b200" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们在st.title('text ')中指定web应用程序的名称。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="41ad" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">然后，我们准备选择题。st.multiselect()创建一个下拉选择。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="f1ca" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">Streamlit提供了date_input选项，可以从日历中选择日期。这里我们创建两个变量:from_date和to_date。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="b83f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">最后，我们用计算出的返回值设计图表。</p><p id="5c90" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">Streamlit动态读取选择器变量中的值，然后从yfinance API中检索收盘价数据。增长率是使用pandas pct_change()计算的。最后一步是使用st.line_chart()函数在折线图中表示数据框。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="b4e6" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们将脚本保存在app.py文件中。</p><h2 id="ceb6" class="mp kx iq bd ky mq mr dn lc ms mt dp lg lx mu mv li mb mw mx lk mf my mz lm na bi translated">Dockerfile文件</h2><p id="7fc8" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">dockerfile是一个文本文件，包含创建图像文件的所有命令。您可以使用docker build构建映像文件，并通过docker run命令将映像作为容器运行。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="9c80" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在上面的docker文件中，我们在最新的官方Python docker发行版上构建了自己的映像。因为我们需要三个库来运行Streamlit应用程序，所以我们在文本文件中指定依赖关系，然后运行pip install命令。Streamlit的默认端口是8501。然后，我们复制容器的/app目录中的app/py文件，并运行Streamlit web应用程序。</p></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><h1 id="f22e" class="kw kx iq bd ky kz ny lb lc ld nz lf lg jw oa jx li jz ob ka lk kc oc kd lm ln bi translated">4.GitHub Action — Web应用程序</h1><p id="e7b6" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在前面的小节中，我们为GitHub存储库中的基础设施供应准备了一个YAML文件。我们还必须创建一个存储库并定义一个工作流来部署docker容器，该容器在GCP的已调配虚拟机实例上运行Streamlit web应用程序。</p><p id="09fc" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">首先，我们为web应用程序代码创建一个新的私有GitHub存储库，然后重复相同的步骤，在GitHub Action secrets中添加GCP服务帐户凭证。</p><p id="6c47" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">接下来，我们在GitHub中准备一个私有访问令牌。该令牌用于从GCP的VM实例克隆GitHub中的这个存储库。</p><p id="5fd9" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在你的GitHub页面，进入<em class="nq">设置</em>-&gt;-<em class="nq">开发者设置</em>-&gt;-<em class="nq">个人访问令牌</em>，然后点击<em class="nq">生成新令牌</em>。在<em class="nq">新增个人访问令牌</em>页面:<em class="nq">回购</em>和<em class="nq">工作流</em>必须打勾。<em class="nq">工作流程</em>选项允许您更新GitHub动作工作流程。您只会看到一次生成的令牌，所以请将您的令牌复制到编辑器中。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oh"><img src="../Images/b6341c189dfd99fda7d39f706226a206.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WHexHCI8tge8-sep"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图4。新的个人访问令牌(图片由作者提供)</p></figure><p id="04c8" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们需要在存储库URL中插入您的用户名和个人访问令牌。比如<a class="ae kv" href="https://github.com/your-user-name/your-repository.git" rel="noopener ugc nofollow" target="_blank"><em class="nq">【https://github.com/your-user-name/your-repository.git】</em></a>会是<a class="ae kv" href="https://your-user-name:your-access-token@github.com/your-user-name" rel="noopener ugc nofollow" target="_blank"><em class="nq">https://</em><strong class="lq ir"><em class="nq">your-user-name:your-access-token @</em></strong><em class="nq">github.com/your-user-name</em></a><em class="nq">/your-repository . git</em>。将完整的URL保存在GitHub Action secrets中，这样我们就可以在工作流YAML文件中调用它。</p><p id="9a3e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在下面。github/workflows目录，我们创建deploy_dokcer.yaml文件。该工作流从Dockerfile构建docker映像，并将其部署在GCP虚拟机实例中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="10c6" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在jobs部分，我们设置了一些变量和权限。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="9a69" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在“步骤”部分，我们定义了操作。为了通过ssh在VM实例中运行bash，我们设置了gcloud CLI。在命令中，我们克隆GitHub存储库并创建docker映像，然后从映像运行容器。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="2ad0" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">当您将文件推送到GitHub repo时，工作流运行并将容器部署到VM。您可以从GitHub Actions UI查看工作流日志。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oi"><img src="../Images/8e01ea21cf265f8f64775685e47e9f40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gPOV2egZ-6Lz9J-u"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图5。GitHub动作工作流程日志(图片由作者提供)</p></figure><p id="67dd" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在，您可以修改app.py，将修改后的代码推送到存储库，并确认更改已应用到虚拟机。</p></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><h1 id="b830" class="kw kx iq bd ky kz ny lb lc ld nz lf lg jw oa jx li jz ob ka lk kc oc kd lm ln bi translated">结论</h1><p id="b159" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">本文解决了数据专家在分享来自数据分析阶段的有价值的见解方面的难题，并提出了一种使用Streamlit web应用程序呈现发现的方法。为了部署应用程序，CI/CD工具和服务(如Terraform和GitHub Actions)通过自动化工作流来帮助数据专家加速原型开发。</p><p id="765d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们使用的例子是一个简单的用例；然而，Streamlit可以做得更多。我们建议您访问<a class="ae kv" href="https://streamlit.io/" rel="noopener ugc nofollow" target="_blank"> Streamlit网站</a>了解它能提供什么。类似地，<a class="ae kv" href="https://registry.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform Registry </a>也有很多有用的资源，并且由HashiCorp和提供商积极更新。值得查看您感兴趣的提供商的文档，以找到工作流自动化的其他机会。最后，GitHub动作允许你设计更复杂的工作流程。如果你想在原型之外使用GitHub动作，强烈推荐阅读官方文档。</p></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><h1 id="3f86" class="kw kx iq bd ky kz ny lb lc ld nz lf lg jw oa jx li jz ob ka lk kc oc kd lm ln bi translated">参考</h1><p id="e0d8" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">[1]“关于GitHub操作的计费”，GitHub文档。<a class="ae kv" href="https://docs.github.com/en/billing/managing-billing-for-github-actions/about-billing-for-github-actions" rel="noopener ugc nofollow" target="_blank">https://docs . github . com/en/billing/managing-billing-for-github-actions/about-billing-for-github-actions</a>【访问时间:2022年8月7日】。</p><p id="a03e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi">‌</p></div></div>    
</body>
</html>