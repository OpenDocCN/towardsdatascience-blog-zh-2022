<html>
<head>
<title>The Joy of A/B Testing, Part II: Advanced Topics</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">A/B测试的乐趣，第二部分:高级主题</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/the-joy-of-a-b-testing-part-ii-advanced-topics-6c7f6cf71e4c#2022-08-13">https://towardsdatascience.com/the-joy-of-a-b-testing-part-ii-advanced-topics-6c7f6cf71e4c#2022-08-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="357f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">Cookies和隐私、交叉实验、干净的拨号和测试指标</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/aeab48f46cb7e9204e66fca8aebce68c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oSecphg01u5nisPm"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">美国宇航局在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="3697" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">A/B测试是机器学习生产中最关键的步骤之一:我们只希望推出一个新的ML模型，如果它可以在生产中被证明是更好的。<a class="ae ky" rel="noopener" target="_blank" href="/the-joy-of-a-b-testing-theory-practice-and-pitfalls-de58acbdb04a">在本系列的第一部分</a>中，我们介绍了如何建立一个人口分割的A/B实验，如何用统计意义解释测试结果，以及什么样的错误是可以预期的。在第二部分中，我们将深入一些实际的考虑。我们将涵盖:</p><ul class=""><li id="8615" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">cookies和隐私:如何对未登录的用户进行A/B测试，</li><li id="41fe" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">交叉实验:一种快速获得推荐模型测试结果的有效方法，</li><li id="206d" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">干净的拨号上网:如何避免测试结果中的统计偏差</li><li id="cf6c" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">通用模型性能度量:测量什么来确定新模型是否更好。</li></ul><p id="3a75" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们直接开始吧。</p><h2 id="0e9a" class="mj mk it bd ml mm mn dn mo mp mq dp mr li ms mt mu lm mv mw mx lq my mz na nb bi translated">Cookies和隐私</h2><p id="f2fd" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">如果用户使用自己的帐户登录，例如在亚马逊、脸书、Instagram、Twitter、网飞或谷歌上，那么将用户分配给控制或治疗就很简单:只需将用户id散列成一个二进制指示符，0表示控制，1表示治疗。</p><p id="2112" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，用户并不总是登录。例如，人们可以作为访客用户在谷歌或亚马逊上搜索。在这种情况下，我们仍然可以用<strong class="lb iu">浏览器cookie</strong>唯一地识别这些用户。提醒一下，cookie只是用户第一次访问网站时生成的文本文件，并存储在用户的计算机上。在A/B测试中,“分析cookie”可以简单地指定用户是在控制组还是治疗组。</p><p id="73bd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">基于cookie的A/B测试的一个缺点是cookie的寿命有限。例如，Safari的智能跟踪预防(ITP)会在7天后删除一些cookie<a class="ae ky" href="https://cookiesaver.io/archives/analytics-guides/how-safari-itp-impacts-cookies/" rel="noopener ugc nofollow" target="_blank">，因此如果测试运行超过一周，那么用户将在每周后被重新分配。这使得很难衡量一个新的ML模型的长期用户影响。</a></p><p id="ca8f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，还有用户隐私法规的作用。例如，欧盟的一般数据保护法规(<a class="ae ky" href="https://gdpr.eu/cookies/" rel="noopener ugc nofollow" target="_blank"> GDPR </a>)规定，网站所有者在使用任何cookies之前，必须得到用户的明确同意，除非是“绝对必要的”(很难说A/B测试对于运行一项服务是绝对必要的)。如果用户不同意，那么我们就不能使用分析cookies，不可能进行人口分割的A/B测试。不遵守GDPR的规定会导致公司被罚款数亿欧元(T2)。</p><h2 id="ddd1" class="mj mk it bd ml mm mn dn mo mp mq dp mr li ms mt mu lm mv mw mx lq my mz na nb bi translated">交叉实验</h2><p id="749c" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">交错是人口分割A/B测试的一种强有力的替代方法。基本的想法是向每个用户提供控制和处理，并查看他们更喜欢哪个版本。这就像让他们直接在可口可乐和百事可乐之间选择，而不是一次只给他们一个选项:由此产生的信号要直接得多。</p><p id="9bdd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个想法的一个具体实现是用于两个(或更多)推荐器模型的<strong class="lb iu">团队草案交错</strong>算法。在该方法中，向用户显示的推荐混合了来自模型A和模型B的结果:这两个模型简单地轮流贡献它们的排名最高的视频，该视频还不在交错列表中，如下例所示。通过抛硬币的方式选出最先挑选的模型。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/0c7b76fb0b6c09c4f905a18108339615.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NqBxmqjqGfB-HXclJsZZSA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">交错排列来自排序模型A和B的结果。A和B各自轮流挑选尚未选择的排名最高的项目。(来源:<a class="ae ky" href="https://netflixtechblog.com/interleaving-in-online-experiments-at-netflix-a04ee392ec55" rel="noopener ugc nofollow" target="_blank">奈芙丽丝</a>)</p></figure><p id="386d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">交错背后的直觉是，因为每个用户可以直接从对照和治疗中选择，所以与两个群体的传统A/B测试相比，我们应该更快地获得测试结果。事实上，这种直觉已经在实验中得到证实:<a class="ae ky" href="https://netflixtechblog.com/interleaving-in-online-experiments-at-netflix-a04ee392ec55" rel="noopener ugc nofollow" target="_blank">网飞</a>报告称，与传统的基于群体的A/B测试相比，他们需要少100倍的用户来实现95%的实验功效(相当于A/B实验中的回忆)。这是一个巨大的优势:这意味着他们可以运行100倍以上的实验，这使他们能够更快地了解用户的偏好。</p><h2 id="4771" class="mj mk it bd ml mm mn dn mo mp mq dp mr li ms mt mu lm mv mw mx lq my mz na nb bi translated">干净的拨号</h2><p id="b4ae" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">另一个重要的考虑是如何保守地运行A/B实验，而不损害可能更糟的新模型的业务指标(还记得在<a class="ae ky" rel="noopener" target="_blank" href="/the-joy-of-a-b-testing-theory-practice-and-pitfalls-de58acbdb04a">第一部分</a>中讨论的S型错误)。一个解决办法是逐渐提高你的A/B测试，例如从1%的治疗开始，一周后提高到5%，然后到10%，25%，最后到50%。</p><p id="60e9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这种逐步拨号方法的问题是，你不能在A/B测试中使用拨号期本身的数据，因为它可能会受到季节影响的影响。举个极端的例子，假设你建立了一个新的电子商务搜索排名模型，并在第一周将其上调至1%，在第二周上调至50%，而第一周恰好是全网站打折的一周。然后，当然控制组会比治疗组有更高的总购买率，因为它在打折周接触到了更多的流量。A/B测试设计违反了同一性假设:各组并不相同。</p><p id="db14" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">补救办法可能是丢弃拨号期间的数据，只考虑50/50拨号期间获得的数据。然而，由于<strong class="lb iu">预暴露效应</strong>，这种方法也可能产生有偏差的测试结果:治疗组中的一些用户之前已经暴露于该治疗，并且这种预暴露可能在测量的测试期间改变他们的行为。例如，如果一个新的电子商务搜索模型好得多，增加了用户回来的可能性，那么测试期间的治疗组不再完全是随机的，它包括因为已经看过新模型而回来的用户。这再次违反了同一性假设。</p><p id="733a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，更好的做法是所谓的<strong class="lb iu">门控拨号</strong>:对于每个用户，首先随机决定他们是否会成为实验的一部分。这个群体在开始时可能只是总人口的1%,然后从那里开始增加。然后，对于实验中的用户，以等概率随机分为对照组和治疗组。瞧，你已经解决了季节偏差问题(因为实验中的两个群体在任何时候都是一样大的)和预暴露问题(因为治疗中没有参与者被预暴露)。拨号可以被认为是“干净的”。</p><h2 id="6003" class="mj mk it bd ml mm mn dn mo mp mq dp mr li ms mt mu lm mv mw mx lq my mz na nb bi translated">您应该衡量哪些指标？</h2><p id="4afc" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">最后，让我们考虑在ML模型的A/B测试期间应该跟踪什么度量。这种选择取决于你要解决的问题，比如分类或排名，以及你到底想优化什么。</p><p id="68dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，考虑一个要么通过要么取消交易的信用卡欺诈检测模型。在这种情况下，您可以测量两件事，(1)从假阴性中收到的总退款量，以及(2)假阳性的总数——这些当然分别是召回率和精确度的代表。然后，如果新模型在这些指标中的一个或两个方面更好，您可能会认为它更好。除了退款金额之外，您可能还希望跟踪退款<em class="ni">计数</em>，这将表明受漏报影响的客户数量，而不仅仅是总的货币损失。如前所述，度量标准的选择取决于您到底想要优化什么。</p><p id="4659" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在用于搜索、广告选择或推荐的<a class="ae ky" rel="noopener" target="_blank" href="/learning-to-rank-a-primer-40d2ff9960af">排名模型</a>中，您可以测量和比较MAP@k，即排名最高的前k个印象中的平均精度。这里，对k个等级取“平均值”,对用户取“平均值”(例如，如果用户观看了等级为1、2、3和5的电影推荐，而不是4，则该用户的AP@5将是(1/1 + 2/2 + 3/3 + 3/4 + 4/5)/5 = 0.91)。更好的模型会有更好的地图@k，如何选择k？一个好的选择可能是第一页显示的结果数，比如Google的k=10。毕竟大部分人连第二页都不访问。</p><p id="7150" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，还有一些特定于问题的衡量标准，例如:</p><ul class=""><li id="bd7a" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">在广告排名中:广告点击总数和广告总收入，</li><li id="53e3" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">在电商搜索排名:总销售计数，总销售金额，总收入，</li><li id="41a4" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">在网站搜索排名中:会话成功率和平均会话时间:用户找到他们要找的东西需要多长时间？</li><li id="90a3" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">在视频推荐系统中:总点击量和平均观看时间:用户在一个视频上花费了多少时间？</li></ul><p id="dcba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">任何模型比较还需要考虑我们模型选择的短期收益<strong class="lb iu">和长期影响</strong>之间的权衡，后者可能不会立即显现。例如，如果一个新的视频推荐模型推广更多的短片(如抖音推广的那样)，点击量可能会在短期内上升，但用户可能会发现更没有意义的内容，并在长期内变得不满意。</p><h2 id="6eef" class="mj mk it bd ml mm mn dn mo mp mq dp mr li ms mt mu lm mv mw mx lq my mz na nb bi translated">结论</h2><p id="7a3d" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">总结一下:</p><ul class=""><li id="10e4" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">在没有登录用户的用户id的情况下，可以使用浏览器cookies运行A/B测试。然而，cookies受隐私法规的约束，如欧盟的GDPR。</li><li id="448d" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">与传统的群体分割测试相比，交错是一种更快获得A/B测试结果的强大方法。基本的想法是给每个用户提供控制和治疗，看他们自己选择哪个版本。团队草稿交错是网飞在制作中使用的一种特殊实现。</li><li id="4ae4" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">在拨号过程中，有几个统计效应会使您的A/B测试结果产生偏差。一个好的解决方案是门控拨号，我们只允许一小部分用户参与实验，控制和治疗各占一半。这种方法被认为是“干净的”拨号。</li><li id="31fc" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">A/B测试指标的选择取决于问题和我们试图优化的确切指标。我们还需要了解模型的长期影响，这可能无法从A/B测试结果中立即看到。</li></ul></div><div class="ab cl nj nk hx nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="im in io ip iq"><h2 id="c0c9" class="mj mk it bd ml mm mn dn mo mp mq dp mr li ms mt mu lm mv mw mx lq my mz na nb bi translated">在你走之前…</h2><p id="aa96" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated"><em class="ni">享受这个内容？在我的</em> <a class="ae ky" href="https://medium.com/@samuel.flender" rel="noopener"> <em class="ni">个人资料页面</em> </a> <em class="ni">找到更多我的文章。关注/订阅这样以后就不会错过我写的新帖了。</em> <a class="ae ky" href="https://medium.com/@samuel.flender/membership" rel="noopener"> <em class="ni">成为中等会员</em> </a> <em class="ni">这样就可以无限查看文章了。并确保在</em><a class="ae ky" href="https://www.linkedin.com/in/sflender/" rel="noopener ugc nofollow" target="_blank"><em class="ni">LinkedIn</em></a><em class="ni">和/或</em><a class="ae ky" href="https://twitter.com/samflender" rel="noopener ugc nofollow" target="_blank"><em class="ni">Twitter</em></a><em class="ni">上关注我！</em></p></div></div>    
</body>
</html>