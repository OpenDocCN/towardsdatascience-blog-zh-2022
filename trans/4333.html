<html>
<head>
<title>7 Cost Optimization Practices for BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">BigQuery的7个成本优化实践</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/7-cost-optimization-practices-for-bigquery-6f776582e62d#2022-09-26">https://towardsdatascience.com/7-cost-optimization-practices-for-bigquery-6f776582e62d#2022-09-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="db99" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在需要的时候花钱</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/02fc274b24f035fa1b6ebf12aee2ecf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Hz-DWNmGaekLNfEc"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在<a class="ae ky" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae ky" href="https://unsplash.com/@micheile" rel="noopener ugc nofollow" target="_blank"> micheile dot com </a>拍摄的照片</p></figure><p id="16c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi lv translated"><span class="l lw lx ly bm lz ma mb mc md di">云的好处之一是其无限的可扩展性。数据存储、计算能力和网络都可以在大多数云计算基础设施中扩展，如GCP和AWS。然而，可扩展性会导致云浪费—过度配置资源、非最佳数据存储、过多的闲置资源等。2021年，公司可能会浪费高达260亿美元，这是有史以来最高的云浪费金额。</span></p><p id="6a85" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，在本文中，让我们看看BigQuery的一些成本优化实践——一个无服务器和多云化的数据仓库。根据谷歌的说法，与其他基于云的平台相比，BigQuery已经是一个具有成本效益的数据仓库。但是我们仍然可以做很多事情来保持更低的成本。</p><p id="6774" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您想知道如何监控BigQuery的成本，您可以查看我的另一篇文章<a class="ae ky" rel="noopener" target="_blank" href="/how-i-build-a-real-time-bigquery-pipeline-for-cost-saving-and-capacity-planning-15712c97f058"> <em class="me">我如何为成本节约和容量规划构建实时BigQuery管道</em> </a> <em class="me">。</em></p></div><div class="ab cl mf mg hx mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="im in io ip iq"><h2 id="b373" class="mm mn it bd mo mp mq dn mr ms mt dp mu li mv mw mx lm my mz na lq nb nc nd ne bi translated">1.选择正确的定价模式</h2><p id="2ade" class="pw-post-body-paragraph kz la it lb b lc nf ju le lf ng jx lh li nh lk ll lm ni lo lp lq nj ls lt lu im bi translated">BigQuery提供了几种对成本有直接影响的计算定价模型。总的来说，BigQuery提供了两种定价模型，并增加了一些内容。</p><p id="31ee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://cloud.google.com/bigquery/pricing#on_demand_pricing" rel="noopener ugc nofollow" target="_blank">按需定价</a>:您为每个查询处理的字节数付费(每TB 5美元)。您可以通过<strong class="lb iu">减少查询处理的字节数</strong>来直接降低成本。</p><p id="812c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://cloud.google.com/bigquery/pricing#flat-rate_pricing" rel="noopener ugc nofollow" target="_blank">统一费率定价</a>:您需要为专用的查询处理能力付费，以时间段来衡量(2000美元/月/100个时间段)。您可以通过使用更少的槽让您的查询更有效地运行来降低成本。</p><p id="6868" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在选择定价模式方面，Google给出了<a class="ae ky" href="https://cloud.google.com/blog/products/data-analytics/choosing-bigquery-pricing" rel="noopener ugc nofollow" target="_blank">以下建议</a>:</p><ul class=""><li id="19aa" class="nk nl it lb b lc ld lf lg li nm lm nn lq no lu np nq nr ns bi translated">如果您刚开始使用少量数据，按需定价模式对您很有好处。您只需为您消费的内容付费，如果您不进行查询，这些插槽的容量将为零。如果您计划了具有可预测的扫描数据量的工作流(例如，在查询中使用重新加载窗口)，这种模式也是首选，因为您确切知道您将支付多少费用。</li><li id="1bb1" class="nk nl it lb b lc nt lf nu li nv lm nw lq nx lu np nq nr ns bi translated">随着数据的增长，成本也会相应增加。如果您开始有更繁重的工作流或临时请求，您可能希望切换到弹性费率定价模式。它确保您不会对未经优化的即席查询感到惊讶。如果您的BigQuery项目对整个组织开放，包括不一定了解所有这些SQL最佳实践的人，这种情况就会发生。</li><li id="ac68" class="nk nl it lb b lc nt lf nu li nv lm nw lq nx lu np nq nr ns bi translated">按需定价模式和弹性费率定价模式并不相互排斥。BigQuery引入了<strong class="lb iu"> Flex Slots </strong>,它为短期预留了插槽。您可以将它用于需要额外容量的周期性工作负载，或者需要在短时间内处理大量数据的工作负载。(例如，由于某些用户活动，需要每月运行一次的报告管道，在国庆节期间，等等)。</li></ul><p id="c55e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">很难说什么时候是转换到另一种定价模式的最佳时机。但是如果你觉得你支付的太多了(例如，超过$ 10K/月)，你可以随时为新的定价模式做一个概念验证，如果它不符合你的期望，就切换回来。</p><h2 id="1705" class="mm mn it bd mo mp mq dn mr ms mt dp mu li mv mw mx lm my mz na lq nb nc nd ne bi translated">2.为短期表设置表过期时间</h2><p id="5ab3" class="pw-post-body-paragraph kz la it lb b lc nf ju le lf ng jx lh li nh lk ll lm ni lo lp lq nj ls lt lu im bi translated">BigQuery的存储有两种价格:</p><ul class=""><li id="0095" class="nk nl it lb b lc ld lf lg li nm lm nn lq no lu np nq nr ns bi translated">0.02美元/GB用于活动存储，包括在过去90天内修改过的表或表分区。</li><li id="5ce6" class="nk nl it lb b lc nt lf nu li nv lm nw lq nx lu np nq nr ns bi translated">对于过去90天内未修改的长期存储，每GB 0.01美元。</li></ul><p id="baf4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以通过设置表的<a class="ae ky" href="https://cloud.google.com/bigquery/docs/managing-tables#updating_a_tables_expiration_time" rel="noopener ugc nofollow" target="_blank">到期时间</a>或数据集的<a class="ae ky" href="https://cloud.google.com/bigquery/docs/updating-datasets#table-expiration" rel="noopener ugc nofollow" target="_blank">默认表到期时间</a>以及分区表的<a class="ae ky" href="https://cloud.google.com/bigquery/docs/managing-partitioned-tables#partition-expiration" rel="noopener ugc nofollow" target="_blank">分区到期时间</a>来控制存储成本。这在以下几种情况下很有用:</p><ul class=""><li id="41db" class="nk nl it lb b lc ld lf lg li nm lm nn lq no lu np nq nr ns bi translated">您有许多每日快照表，并且只想保留最近X天的数据。然后，您可以将每个新快照表的到期时间设置为X天。</li><li id="cc63" class="nk nl it lb b lc nt lf nu li nv lm nw lq nx lu np nq nr ns bi translated">您有一个仅包含临时数据的操场数据集。然后，您可以将整个数据集的默认过期时间设置为X天。</li><li id="099b" class="nk nl it lb b lc nt lf nu li nv lm nw lq nx lu np nq nr ns bi translated">您有一个按天进行分区的表，并且您只想要最近X天的数据。然后，您可以设置分区过期时间。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/7b4e12488ff6ea12db636f070ed1eeaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mG05zcYvwWzFvQuhYF802Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">BigQuery中的表过期</p></figure><p id="a060" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这种简单的做法会自动清理空闲的表并节省存储成本。</p><h2 id="bb8a" class="mm mn it bd mo mp mq dn mr ms mt dp mu li mv mw mx lm my mz na lq nb nc nd ne bi translated">3.分区和集群</h2><p id="7995" class="pw-post-body-paragraph kz la it lb b lc nf ju le lf ng jx lh li nh lk ll lm ni lo lp lq nj ls lt lu im bi translated"><a class="ae ky" href="https://cloud.google.com/bigquery/docs/partitioned-tables" rel="noopener ugc nofollow" target="_blank">分区</a>您的数据可以帮助降低处理查询的成本并提高性能。您可以使用摄取时间或任何时间戳和日期列对表进行分区，并选择每天、每小时、每月和每年作为粒度。对于巨大的表，建议应用<strong class="lb iu">必需的分区过滤器</strong>，这样用户将被迫减少扫描的数据量。</p><p id="734b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，您对一个包含过去12个月的每日天气数据的<code class="fe nz oa ob oc b">weather</code>表进行分区。分区字段为<code class="fe nz oa ob oc b">date</code>，粒度为月。当你搜索<code class="fe nz oa ob oc b">2022–08–01</code>的天气时，BigQuery只扫描<code class="fe nz oa ob oc b">august</code>分区中的数据。您只需为该分区中的数据付费，而不是整个表。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi od"><img src="../Images/25a301581f081056f5c3797d1edd882b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1206/format:webp/1*yoIw51gX15fP2fRWKYBy5A.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">表分区(由作者创建)</p></figure><p id="4019" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最重要的是，您可以基于最多四列对您的表进行<a class="ae ky" href="https://cloud.google.com/bigquery/docs/clustered-tables" rel="noopener ugc nofollow" target="_blank">聚类。BigQuery根据指定的列顺序对每个分区中的数据进行排序。当您的查询搜索这些列时，BigQuery只扫描分区的相关块。</a></p><p id="1d8e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，我们向<code class="fe nz oa ob oc b">weather</code>表添加3个聚类字段:<code class="fe nz oa ob oc b">date</code>、<code class="fe nz oa ob oc b">country</code>和<code class="fe nz oa ob oc b">city</code>。当我搜索德国八月份的天气时，BigQuery只会扫描一个分区和有限的可以找到德国数据的区块。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/e4722341262bba9297eb54b7b0faaa5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f-pmV4oyXB0NDVxXbuOekA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">表聚类(由作者创建)</p></figure><p id="7973" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一个专业建议是使用更可能被筛选的列作为聚类字段。此外，划分字段也可以是聚类字段。在<code class="fe nz oa ob oc b">weather</code>表中，<code class="fe nz oa ob oc b">date</code>按月粒度进行分区，并按天级别在每个分区中排序。它将提高查询性能并降低成本。</p><h2 id="6439" class="mm mn it bd mo mp mq dn mr ms mt dp mu li mv mw mx lm my mz na lq nb nc nd ne bi translated">4.使用增量表更新</h2><p id="3b55" class="pw-post-body-paragraph kz la it lb b lc nf ju le lf ng jx lh li nh lk ll lm ni lo lp lq nj ls lt lu im bi translated">当您构建数据管道时，一个重要的步骤是将数据接收到BigQuery中。如果表很小，您可以定期完全重新加载表。但是如果表很大，每次进行完全刷新是非常昂贵和耗时的，通常的做法是执行增量表更新。</p><p id="9143" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，源表每天接收新记录，而每日计划查询捕获源表中的更改，并相应地更新目标表。执行完全刷新显然是浪费金钱，因为旧数据不会改变。</p><p id="3fad" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一个解决方案是定义一个重载窗口。为了不遗漏源表中的任何数据，通常重载窗口大于源表的更新频率。假设我们有一个3天的重装窗口。每天，该查询只从源表中选择最近3天的数据，并将其存储在CTE或临时表中。稍后，查询可以使用<code class="fe nz oa ob oc b">MERGE</code>语句来更新目标表。</p><p id="bd95" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本例中的<code class="fe nz oa ob oc b">MERGE</code>语句意味着‘如果临时表包含目标表中不存在的带有新<code class="fe nz oa ob oc b">date</code>的记录，则插入该记录，否则更新目标表。’在这种情况下，“更新目标表”实际上不会改变任何东西，它只是用相同的数据覆盖它。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi of"><img src="../Images/22855583eca2bd13062c178cf4865f51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/1*mE6w-rhEXfLIvGd-abbPgA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">增量更新(由作者创建)</p></figure><p id="6385" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">拥有一个重新加载窗口可以大大减少要扫描的数据量。您可以在数据管道中利用这种技术。</p><h2 id="1067" class="mm mn it bd mo mp mq dn mr ms mt dp mu li mv mw mx lm my mz na lq nb nc nd ne bi translated">5.避免选择*只要你能+限制100是一个幻想</h2><p id="8e71" class="pw-post-body-paragraph kz la it lb b lc nf ju le lf ng jx lh li nh lk ll lm ni lo lp lq nj ls lt lu im bi translated"><a class="ae ky" href="https://cloud.google.com/bigquery/docs/storage_overview#:~:text=BigQuery%20stores%20table%20data%20in,very%20large%20number%20of%20records." rel="noopener ugc nofollow" target="_blank"> BigQuery以列格式</a>存储数据，这意味着它单独存储每一列。这也意味着<code class="fe nz oa ob oc b">SELECT *</code>是一种非常昂贵的数据查询方式。一个简单的技巧是<strong class="lb iu">只选择您需要的列。</strong>您可以随时使用<code class="fe nz oa ob oc b">SCHEMA</code>和<code class="fe nz oa ob oc b">PREVIEW</code>选项卡来免费查看数据。</p><p id="2766" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还要注意，应用限制条款并不能节省一分钱。如果希望扫描较少的行，则应用分区筛选器。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/c1e7f955d22d7e04cd4307e9e860f608.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gRsBV97MG1UA-Uj2Q6RLIw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">有/没有限制的查询(由作者创建)</p></figure><h2 id="736b" class="mm mn it bd mo mp mq dn mr ms mt dp mu li mv mw mx lm my mz na lq nb nc nd ne bi translated">6.INT64列上的ORDER BY或JOIN</h2><p id="d6d4" class="pw-post-body-paragraph kz la it lb b lc nf ju le lf ng jx lh li nh lk ll lm ni lo lp lq nj ls lt lu im bi translated">在BigQuery中，使用<code class="fe nz oa ob oc b">INT64</code>而不是<code class="fe nz oa ob oc b">STRING</code>数据类型来连接列更便宜也更有效。这里有一篇关于<a class="ae ky" rel="noopener" target="_blank" href="/how-do-column-types-effect-join-speeds-in-data-warehouses-5ddd1933211e">列类型如何影响数据仓库中连接速度的有趣文章？</a></p><h2 id="f694" class="mm mn it bd mo mp mq dn mr ms mt dp mu li mv mw mx lm my mz na lq nb nc nd ne bi translated">7.使用实体化视图</h2><p id="3c34" class="pw-post-body-paragraph kz la it lb b lc nf ju le lf ng jx lh li nh lk ll lm ni lo lp lq nj ls lt lu im bi translated">要回答分析问题，您需要一个组合了来自不同表的大量数据的复杂查询。一些流行的问题可以被问很多次，多次运行相同的复杂查询是浪费金钱。BigQuery提供了<a class="ae ky" href="https://cloud.google.com/bigquery/docs/materialized-views-intro" rel="noopener ugc nofollow" target="_blank">物化视图</a>,允许您在聚合事实表中汇总数据。它是一个预先计算的视图，定期缓存查询结果以提高性能和效率。</p><p id="a62f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">物化视图<strong class="lb iu">不是从基表中检索数据，而是从基表中只读detla变化来计算最新结果。</strong>而且一般速度更快，扫描数据更少。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/301b5dae2e9e52ad1abc2ba3b7de32a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ybM76yN6bZ8CRBvIAdskoQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">物化视图(由作者创建)</p></figure><p id="25bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，物化视图可用于聚合流数据、预过滤数据或预连接带有小表的数据。根据BigQuery，当基表发生变化时，视图会在后台重新计算，以便可以返回新数据。</p><h2 id="a781" class="mm mn it bd mo mp mq dn mr ms mt dp mu li mv mw mx lm my mz na lq nb nc nd ne bi translated">结论</h2><p id="1e54" class="pw-post-body-paragraph kz la it lb b lc nf ju le lf ng jx lh li nh lk ll lm ni lo lp lq nj ls lt lu im bi translated">和往常一样，我希望这篇文章对你有用，并能给你启发。BigQuery为新用户提供免费积分，这很好，你可能不在乎一开始的费用，这没关系。但是，随着您的技术堆栈和数据不断增长，有一天您会撞墙并注意到您的账单呈指数级增长。如果你知道一些节省成本的小技巧，并且本文中的大部分小技巧都很容易实现，那将会很有帮助，这样你就可以从一开始就避免大额账单。干杯！</p></div></div>    
</body>
</html>