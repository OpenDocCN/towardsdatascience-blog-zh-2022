<html>
<head>
<title>Save Time Writing SQL with UDFs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">节省使用UDF编写SQL的时间</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/save-time-writing-sql-with-udfs-24b002bf0192#2022-10-07">https://towardsdatascience.com/save-time-writing-sql-with-udfs-24b002bf0192#2022-10-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="feb7" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">SQL UDFs介绍及示例</h2></div><p id="25a1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">编写SQL是许多数据科学家和数据分析师角色的重要组成部分，但这通常是花费时间最不愉快的方式。获取运行分析所需的数据可能会变得繁琐而耗时。用户定义函数(UDF)是解决这个问题的好方法，它是查询编写过程的捷径。在本文中，我们将介绍什么是UDF，为什么您可能会使用它们，它们在哪里被支持，以及一些基本的例子。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/14f0744a68b0c2065c5cd8ca814c6f4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EYwcevoACAGnO5hI"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">约翰·施诺布里奇在<a class="ae lu" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="b39b" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">什么是UDF？</h1><p id="a66a" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">UDF是一个用户定义的函数，它在基本层面上非常类似于一个典型的SQL函数，比如RIGHT()，但是它不是由一些标准定义的，任何人都可以定义它们。更专业地说，UDF是一个函数，它接受一组类型化的参数，应用一些逻辑，然后返回一个类型化的值。下面是一个例子。</p><pre class="lf lg lh li gt ms mt mu mv aw mw bi"><span id="bfc4" class="mx lw it mt b gy my mz l na nb">CREATE FUNCTION Sigmoid(@exponent FLOAT(10))<br/>RETURNS FLOAT(10)<br/>AS<br/>   BEGIN<br/>      1.0 / (1.0 + EXP(-@exponent))<br/>      RETURN Data<br/>   END</span></pre><p id="c9a5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">UDF在SQL世界中广泛存在，它能够创建存在于数据库管理系统(如SQL Server、Postgres、BigQuery和Presto)中的UDF。注意一些数据库管理员会禁用这些，所以最好检查一下。</p><h1 id="1614" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">UDF的利与弊</h1><p id="0883" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">使用UDF可能是有益的，但是它们也有缺点。我个人认为，拥有一个好的UDF集合，特别是在小的产品团队中，是非常有用的，但是我将分享其利弊，让您来决定。</p><p id="07b8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">优点</strong>:</p><ul class=""><li id="ffe6" class="nc nd it kk b kl km ko kp kr ne kv nf kz ng ld nh ni nj nk bi translated"><strong class="kk iu">允许您用简单的一行程序替换部分复杂或重复的SQL，使代码更具可读性</strong>。例如，您可能有一个复杂的CASE语句，它占用了查询的许多行。有了UDF，这可以减少到一行。</li><li id="cfb5" class="nc nd it kk b kl nl ko nm kr nn kv no kz np ld nh ni nj nk bi translated"><strong class="kk iu">鼓励集中定义流程</strong>。想要对事物进行分类是很常见的，能够在一个人编写的查询中以及在多人之间保持一致是很有价值的。</li><li id="3c0f" class="nc nd it kk b kl nl ko nm kr nn kv no kz np ld nh ni nj nk bi translated"><strong class="kk iu">由于上述原因，它允许你更快地编码</strong>。能够更快地准备好数据总是会让数据科学家感到高兴。</li></ul><p id="8eec" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">缺点</strong>:</p><ul class=""><li id="1f89" class="nc nd it kk b kl km ko kp kr ne kv nf kz ng ld nh ni nj nk bi translated">虽然它可以使代码更具可读性，但是太多不清楚的UDF实际上会降低代码的可读性。如果函数被命名为类似于“func1”的名称，那么它们实际上在做什么就很不清楚了，这就需要读者查找函数定义，这通常比在代码中通读要花费更长的时间。</li><li id="5832" class="nc nd it kk b kl nl ko nm kr nn kv no kz np ld nh ni nj nk bi translated">你需要记录你在记忆中创建的所有UDFs】，这在你建立了一个像样的剧目之后会变得很困难。最坏的情况是，你开始创建更多的UDF做类似的事情，创建不必要的代码。为了避免这导致问题，建议保留一个包含您创建的UDF的字典，并确保与任何合作者共享它。您还可以确保尽可能创建更多的通用函数，以避免重复工作。</li><li id="d9de" class="nc nd it kk b kl nl ko nm kr nn kv no kz np ld nh ni nj nk bi translated"><strong class="kk iu">UDF可能运行效率低下，尤其是在大块数据上</strong>。对于各种SQL函数，它们必须逐行计算，导致运行时间很长。这可以通过一些技术得到缓解，比如针对<a class="ae lu" href="https://www.mssqltips.com/sqlservertip/5864/four-ways-to-improve-scalar-function-performance-in-sql-server/" rel="noopener ugc nofollow" target="_blank"> SQL Server </a>的技术。</li></ul><p id="ed58" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如你所见，使用UDF有好的一面，也有不好的一面，当应用UDF时，确保使用常识，可以将这些缺点最小化。</p><h1 id="05b3" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">UDF的例子</h1><p id="86a2" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">下面是一些有用的UDF(小写输入参数)的例子。这些可以大致分为替代重复动作的和编码业务逻辑的。</p><p id="389d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">重复动作</strong>:</p><ul class=""><li id="c5e7" class="nc nd it kk b kl km ko kp kr ne kv nf kz ng ld nh ni nj nk bi translated"><strong class="kk iu">舍入器</strong>:将一个数字舍入到最接近的指定因子，并带有下限和上限。</li></ul><pre class="lf lg lh li gt ms mt mu mv aw mw bi"><span id="8f8a" class="mx lw it mt b gy my mz l na nb">LEAST(GREATEST(ROUND(@number / @factor) * @factor, @lower), @upper)</span></pre><ul class=""><li id="469b" class="nc nd it kk b kl km ko kp kr ne kv nf kz ng ld nh ni nj nk bi translated"><strong class="kk iu">Sigmoid</strong>:Sigmoid函数<a class="ae lu" href="https://www.notion.so/SQL-UDFs-95b6bb9567c04369992ef90391f2acc7" rel="noopener ugc nofollow" target="_blank">的SQL定义</a>。</li></ul><pre class="lf lg lh li gt ms mt mu mv aw mw bi"><span id="26f6" class="mx lw it mt b gy my mz l na nb">1.0 / (1.0 + EXP(-@exponent))</span></pre><ul class=""><li id="2c2c" class="nc nd it kk b kl km ko kp kr ne kv nf kz ng ld nh ni nj nk bi translated"><strong class="kk iu">采样</strong>:给定一些值的数组，采样给定的数量。</li></ul><pre class="lf lg lh li gt ms mt mu mv aw mw bi"><span id="5eff" class="mx lw it mt b gy my mz l na nb">SLICE(SHUFFLE(@input), 1, @value)</span></pre><ul class=""><li id="ac4c" class="nc nd it kk b kl km ko kp kr ne kv nf kz ng ld nh ni nj nk bi translated"><strong class="kk iu">X中的1</strong>:在X语句中将一个数字从十进制转换为1，例如0.01或1%是100分之一。</li></ul><pre class="lf lg lh li gt ms mt mu mv aw mw bi"><span id="f259" class="mx lw it mt b gy my mz l na nb">‘1 in ‘ || CAST(CAST(POWER(10,CEIL(-LOG10(@percent))) AS INT) AS VARCHAR)</span></pre><p id="0d4c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">业务逻辑</strong>:</p><ul class=""><li id="de68" class="nc nd it kk b kl km ko kp kr ne kv nf kz ng ld nh ni nj nk bi translated"><strong class="kk iu">年龄分类</strong>:根据用户的年龄对他们进行分类。</li></ul><pre class="lf lg lh li gt ms mt mu mv aw mw bi"><span id="8d6c" class="mx lw it mt b gy my mz l na nb">CASE WHEN @age &lt; 12 THEN ‘child’ WHEN @age &lt; 20 THEN ‘teenager’ WHEN @age &lt; 50 ‘adult’ ELSE ‘elderly’ END</span></pre><ul class=""><li id="41c4" class="nc nd it kk b kl km ko kp kr ne kv nf kz ng ld nh ni nj nk bi translated"><strong class="kk iu">购买时段</strong>:将用户购买的数量分组到特定的时段中(用于绘图)。</li></ul><pre class="lf lg lh li gt ms mt mu mv aw mw bi"><span id="129a" class="mx lw it mt b gy my mz l na nb">CASE WHEN @purchases = 0 THEN ‘0’ WHEN @purchases = 1 THEN ‘1’ WHEN @purchases &lt; 5 THEN ‘2–4’ WHEN @purchases ≥ 5 THEN ‘5+’</span></pre><ul class=""><li id="3302" class="nc nd it kk b kl km ko kp kr ne kv nf kz ng ld nh ni nj nk bi translated"><strong class="kk iu">邮件域</strong>:从邮件字符串中提取邮件域。</li></ul><pre class="lf lg lh li gt ms mt mu mv aw mw bi"><span id="65a9" class="mx lw it mt b gy my mz l na nb">SPLIT_PART(@email, ‘@’, 2)</span></pre><p id="d515" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这些只是你如何应用UDF的一些例子；你可以用更多的方式来使用它们。唯一真正的限制是创造力！</p><h1 id="cf41" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">结论</h1><p id="1c59" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">正如我们所看到的，UDF有广泛的应用，包括优化重复代码和集中业务逻辑，这有助于您更有效地编写SQL。虽然有缺点，但是可以用一点常识来适当地减轻它们，以确保您获得使用UDF的所有好处。鉴于它们在各种SQL系统中的广泛可用性，没有理由不给它们一个机会！</p></div></div>    
</body>
</html>