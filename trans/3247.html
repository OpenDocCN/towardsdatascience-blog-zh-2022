<html>
<head>
<title>Introduction to the Quantile Regression Model</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">分位数回归模型简介</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/introduction-to-the-quantile-regression-model-648a0532f534#2022-07-19">https://towardsdatascience.com/introduction-to-the-quantile-regression-model-648a0532f534#2022-07-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/012db72fc54f345869726ec9da113209.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6YqkFjbvnKQ8RFX6yuBbEg.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">图片来自<a class="ae jd" href="https://pixabay.com/vectors/pie-chart-diagram-statistics-parts-149727/" rel="noopener ugc nofollow" target="_blank"> Pixabay </a> ( <a class="ae jd" href="https://pixabay.com/service/license/" rel="noopener ugc nofollow" target="_blank"> Pixabay许可</a>)</p></figure><div class=""/><div class=""><h2 id="44d7" class="pw-subtitle-paragraph kd jf jg bd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dk translated">我们将看看如何预测中位数和其他分位数点</h2></div><p id="2a9c" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在回归模型中，人们通常对估计响应变量的条件均值感兴趣。例如，考虑以下汽车价格与气缸数量的关系图:</p><figure class="ls lt lu lv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi lr"><img src="../Images/06e1df4a748542413856da1c9ebf4969.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ocNCleoIJH2-GTAuavrSGg.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">价格与气缸数量。金色圆点代表条件均值:<em class="lw"> E(价格|汽缸数量)</em>(图片由作者提供)(数据集:<a class="ae jd" href="https://archive-beta.ics.uci.edu/ml/datasets/automobile" rel="noopener ugc nofollow" target="_blank"> UCI ML汽车</a>用在<a class="ae jd" href="https://creativecommons.org/licenses/by/4.0/legalcode" rel="noopener ugc nofollow" target="_blank"> CC BY 4.0 </a>)</p></figure><p id="4558" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">金点代表观察到的基于圆柱体数量的平均价格。</p><p id="a406" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果我们想使用回归模型来估计这个条件平均价格，我们可以使用以下线性模型来完成这项工作:</p><figure class="ls lt lu lv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi lx"><img src="../Images/489f4ad968d77629f1b98579a2f573ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mz7A7vnyVOgiawrXO8PubA.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">估计汽车价格的线性模型(图片由作者提供)</p></figure><p id="22b0" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果我们将上述线性模型与数据拟合，并绘制其估计值，我们会得到以下图表:</p><figure class="ls lt lu lv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi lr"><img src="../Images/9d0cda9865877aab638e585914403a03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ToAZpKAqA82zsmUE93HO1Q.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">经过训练的OLS模型的趋势线绘制在原始数据之上。红点是估计的条件平均价格，而金点是观察到的条件平均价格(图片由作者提供)</p></figure><p id="e6cd" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">对于其他类型的数据，可以采用更复杂的模型，如<a class="ae jd" rel="noopener" target="_blank" href="/generalized-poisson-regression-for-real-world-datasets-d1ff32607d79">泊松</a>或<a class="ae jd" rel="noopener" target="_blank" href="/the-stratified-cox-proportional-hazards-regression-model-fa1fa5de2bb1">考克斯比例风险</a>模型。在所有情况下，我们都要求模型估计条件平均值。</p><p id="f2d4" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx jh">但是在一些数据集中，平均值并不是数据的好样本</strong>。</p><p id="8e8f" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">以下是三个数据集示例，对于这些数据集，平均值可能不是合适的估计统计值:</p><ul class=""><li id="8b7d" class="lz ma jg kx b ky kz lb lc le mb li mc lm md lq me mf mg mh bi translated">数据严重向左或向右倾斜。在保险索赔或医疗保健费用数据中经常出现这种情况，其中大多数索赔金额较小，但数据中有一条价值不断增加的索赔长尾。</li><li id="568e" class="lz ma jg kx b ky mi lb mj le mk li ml lm mm lq me mf mg mh bi translated">数据是多模态的，即它有一个以上的高频率出现值。例如，如果数据有两个大致相同的峰(双峰数据集)，均值模型将估计两个峰之间的谷内点，该点不能很好地代表数据。</li><li id="9990" class="lz ma jg kx b ky mi lb mj le mk li ml lm mm lq me mf mg mh bi translated">数据包含有影响的异常值。依赖于最小化残差平方和的普通最小二乘回归模型等回归模型对异常值的存在高度敏感。在这种情况下，除了<em class="ly">而不是</em>使用平均值作为要估计的量之外，最小化残差绝对值的和可能是有益的。</li></ul><p id="a781" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在所有这些情况下，平均值不足以代表数据的性质。估计<strong class="kx jh">条件中位数</strong>可能更好。</p><p id="221a" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在最一般的术语中，我们的“寻找中值”回归模型将由以下等式指定:</p><figure class="ls lt lu lv gt is gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/d43d3e707260489a59aca1733d2d0695.png" data-original-src="https://miro.medium.com/v2/resize:fit:1374/format:webp/1*Iu0l8wSGgPiw8o0nQpJuqw.png"/></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">一个回归模型，为某个值<strong class="bd mo"> X </strong>估计y的条件中位数(图片由作者提供)</p></figure><p id="3b8f" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">上式中，<strong class="kx jh"> <em class="ly"> X </em> </strong>为回归矩阵，<strong class="kx jh"><em class="ly">X</em></strong><em class="ly">_ I</em>为矩阵的第<em class="ly">行</em>行。<strong class="kx jh"><em class="ly">β</em></strong><em class="ly">_ cap</em>是<em class="ly">拟合</em>回归系数和<em class="ly"> f(.)</em>是<strong class="kx jh"><em class="ly"/></strong><em class="ly">_ cap</em><strong class="kx jh"/>和<strong class="kx jh"><em class="ly">x</em></strong><em class="ly">_ I</em>的一些函数，用于估计约束条件下的概率估计值<em class="ly">f(</em><strong class="kx jh"><em class="ly"/></strong><em class="ly">_ cap，</em><strong class="kx jh"><em class="ly">x<em class="ly"/></em></strong></p><p id="bc9f" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">例如，用于估计汽车中间价格的模型，其中<em class="ly">f(</em><strong class="kx jh"><em class="ly">β</em></strong><em class="ly">_ cap、</em><strong class="kx jh"><em class="ly">x</em></strong><em class="ly">_ I)</em>具有<strong class="kx jh">线性形式</strong>将是:</p><figure class="ls lt lu lv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/3f5e23397a2612bfdaa0d1d0997d9879.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hi4z6fWt8W43imdXdYMBNg.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">估算汽车中位价格的模型(图片由作者提供)</p></figure><p id="2a5f" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们甚至可以更进一步。在数据集中，中位数是0.5分位数(或第50百分位)点，这意味着50%的数据点小于中位数的值。类似地，还可以定义其他分位数点。0.1分位数点(第10个百分点)是这样的值，即只有10%的数据集小于该值。类似地，0.25分位数点的值大于数据集的25%，依此类推。</p><p id="488a" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们可能希望建立一个回归模型来估计任何或所有这些分位数点(或相应的百分位值)。</p><p id="3f9a" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这种模型的一般方程如下:</p><figure class="ls lt lu lv gt is gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/ed11880b1fc77bb280c264540f9c5629.png" data-original-src="https://miro.medium.com/v2/resize:fit:1318/format:webp/1*pdnIpdSetH4oIIzvj23kNw.png"/></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">q分位数回归模型的一般方程(图片由作者提供)</p></figure><p id="3e9f" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">上式中，<em class="ly"> Q(。)</em>是q分位数(或第(q*100)个百分点)的估计分位数点。如前所述，<em class="ly">f(</em><strong class="kx jh"><em class="ly">β</em></strong><em class="ly">_ cap，</em><strong class="kx jh"><em class="ly">x</em></strong><em class="ly">_ I)</em>是产生期望的q分位数点的估计值的函数，该函数受到<em class="ly"> y </em>的任何观测值小于或等于估计值<em class="ly">f(</em><strong class="kx jh"><em class="ly">β</em></strong><em class="ly">的概率的约束<em class="ly"> q </em>范围从0到1，包括0和1。</em></p><p id="5db1" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">例如，用于估计汽车的第95百分位价格的模型，其中<em class="ly">f(</em><strong class="kx jh"><em class="ly">β</em></strong><em class="ly">_ cap、</em><strong class="kx jh"><em class="ly">x</em></strong><em class="ly">_ I)</em>具有<strong class="kx jh">线性形式</strong>将是:</p><figure class="ls lt lu lv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mr"><img src="../Images/c4282530ec52851f703865c31c608851.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u1d9cA-_9zDwSpRHyGql8A.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">给定气缸数量，估算第95百分位汽车价格的模型(图片由作者提供)</p></figure><h1 id="8d43" class="ms mt jg bd mu mv mw mx my mz na nb nc km nd kn ne kp nf kq ng ks nh kt ni nj bi translated">分位数回归模型的用途是什么？</h1><p id="2b00" class="pw-post-body-paragraph kv kw jg kx b ky nk kh la lb nl kk ld le nm lg lh li nn lk ll lm no lo lp lq ij bi translated">当数据在数据集的每个分位数中以不同的方式分布时，拟合不同的回归模型以满足每个分位数的独特建模需求，而不是尝试拟合预测条件均值的一刀切模型，可能会更有利。在这种情况下，所有这些分位数模型的系数将互不相同。</p><p id="7b50" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">相反的情况是，数据在每个分位数中分布相同。具体地，估计条件均值的模型的误差项对于每个<strong class="kx jh"><em class="ly">×T54】</em></strong><em class="ly">_ I</em>具有相同的分布。例如，所有<strong class="kx jh"><em class="ly">x</em></strong><em class="ly">_ I</em>的误差呈正态分布，并且所有分布的均值和方差都相同。换句话说，<strong class="kx jh">误差是同分位数</strong> c。可以看出，在这种情况下，当不同的分位数回归模型拟合同分位数数据集时，所有模型的相应系数集将在统计上完全相同，并且<em class="ly">各种分位数模型仅在回归截距的值上彼此不同。事实上，这种行为可以构成异方差测试的基础。</em></p><p id="8b42" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">建立分位数模型的另一个原因是，我们实际上对估计一个特定的分位数感兴趣，比如说，社会经济原因。例如，我们可能想要估计具有相同人口统计学特征的考生的第95百分位SAT分数。</p><p id="d3f5" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在下一节中，我们将浏览一个简短的教程，学习如何使用Python构建分位数模型。</p></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><h1 id="b783" class="ms mt jg bd mu mv nw mx my mz nx nb nc km ny kn ne kp nz kq ng ks oa kt ni nj bi translated">如何使用Python和statsmodels构建分位数回归模型</h1><p id="1eeb" class="pw-post-body-paragraph kv kw jg kx b ky nk kh la lb nl kk ld le nm lg lh li nn lk ll lm no lo lp lq ij bi translated">我们将使用以下车辆数据集来说明构建分位数回归模型的过程，该数据集包含取自1985年版的沃德汽车年鉴的200多辆汽车的规格。每行包含一组26个关于单个车辆的规格:</p><figure class="ls lt lu lv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ob"><img src="../Images/3a267171b220510400c8104ce37d4a7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_wc0IJBq2-DEoeXlOn9hZg.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">汽车数据集(来源:<a class="ae jd" href="https://archive-beta.ics.uci.edu/ml/datasets/automobile" rel="noopener ugc nofollow" target="_blank"><a class="ae jd" href="https://creativecommons.org/licenses/by/4.0/legalcode" rel="noopener ugc nofollow" target="_blank">CC BY 4.0</a>下加州大学欧文分校</a></p></figure><p id="df98" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这些数据的子集可以从这里 下载<a class="ae jd" href="https://gist.github.com/sachinsdate/402daa205e93a389d0f7023439588774" rel="noopener ugc nofollow" target="_blank"> <strong class="kx jh">。</strong></a></p><p id="68c5" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们将数据集加载到熊猫数据框架中，并绘制数据集。</p><pre class="ls lt lu lv gt oc od oe of aw og bi"><span id="777b" class="oh mt jg od b gy oi oj l ok ol"><strong class="od jh">import </strong>pandas <strong class="od jh">as </strong>pd<br/><strong class="od jh">import </strong>statsmodels.api <strong class="od jh">as </strong>sm<br/><strong class="od jh">import </strong>statsmodels.formula.api <strong class="od jh">as </strong>smf<br/><strong class="od jh">from </strong>patsy <strong class="od jh">import </strong>dmatrices<br/><strong class="od jh">import </strong>numpy <strong class="od jh">as </strong>np<br/><strong class="od jh">from </strong>matplotlib <strong class="od jh">import </strong>pyplot <strong class="od jh">as </strong>plt</span><span id="7e11" class="oh mt jg od b gy om oj l ok ol"><strong class="od jh"><em class="ly">#Import the 7-variable subset of the automobiles dataset into a DataFrame</em></strong><em class="ly"><br/></em>df = pd.<strong class="od jh">read_csv</strong>(<strong class="od jh">'automobiles_dataset_subset_uciml.csv'</strong>, <strong class="od jh">header</strong>=0)</span><span id="411b" class="oh mt jg od b gy om oj l ok ol"><strong class="od jh"><em class="ly">#Plot price versus num_of_cylinders<br/></em></strong>fig = plt.<strong class="od jh">figure</strong>()</span><span id="15e7" class="oh mt jg od b gy om oj l ok ol">fig.<strong class="od jh">suptitle</strong>(<strong class="od jh">'Price versus Number of Cylinders'</strong>)</span><span id="9008" class="oh mt jg od b gy om oj l ok ol">plt.<strong class="od jh">xlabel</strong>(<strong class="od jh">'number_of_cylinders'</strong>)<br/>plt.<strong class="od jh">ylabel</strong>(<strong class="od jh">'price'</strong>)</span><span id="56a5" class="oh mt jg od b gy om oj l ok ol">plt.<strong class="od jh">scatter</strong>(<strong class="od jh">x</strong>=df[<strong class="od jh">'num_of_cylinders'</strong>], <strong class="od jh">y</strong>=df[<strong class="od jh">'price'</strong>])</span></pre><p id="7f35" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们也画出条件均值<em class="ly"> E(价格|气缸数量):</em></p><pre class="ls lt lu lv gt oc od oe of aw og bi"><span id="bdac" class="oh mt jg od b gy oi oj l ok ol">num_of_cylinders = np.<strong class="od jh">array</strong>(df.<strong class="od jh">groupby</strong>('num_of_cylinders')['num_of_cylinders'].<strong class="od jh">mean</strong>())</span><span id="1e41" class="oh mt jg od b gy om oj l ok ol">conditional_means = np.<strong class="od jh">array</strong>(df.<strong class="od jh">groupby</strong>('num_of_cylinders')['price'].<strong class="od jh">mean</strong>())<br/><br/>plt.scatter(<strong class="od jh">x</strong>=num_of_cylinders, <strong class="od jh">y</strong>=conditional_means, <strong class="od jh">color</strong>='gold', <strong class="od jh">marker</strong>='o')<br/><br/>plt.<strong class="od jh">show</strong>()</span></pre><p id="bfaf" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们得到了下图。金点代表有条件的意思:</p><figure class="ls lt lu lv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi lr"><img src="../Images/06e1df4a748542413856da1c9ebf4969.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ocNCleoIJH2-GTAuavrSGg.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">价格与气缸数量。金点代表条件均值:<em class="lw"> E(价格|缸数)</em>(图片由作者提供)</p></figure><p id="d409" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">接下来，让我们用<a class="ae jd" href="https://patsy.readthedocs.io/en/latest/quickstart.html" rel="noopener ugc nofollow" target="_blank"> Patsy </a>语法定义回归模型的方程。截距假定为:</p><pre class="ls lt lu lv gt oc od oe of aw og bi"><span id="ad16" class="oh mt jg od b gy oi oj l ok ol">reg_exp = <strong class="od jh">'price ~ num_of_cylinders'</strong></span></pre><p id="792d" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们将使用这个表达式来雕刻出<strong class="kx jh"> <em class="ly"> y </em> </strong>和<strong class="kx jh"> <em class="ly"> X </em> </strong>矩阵:</p><pre class="ls lt lu lv gt oc od oe of aw og bi"><span id="2e05" class="oh mt jg od b gy oi oj l ok ol">y_train, X_train = <strong class="od jh">dmatrices</strong>(reg_exp, df, <strong class="od jh">return_type</strong>='dataframe')</span></pre><p id="ffe0" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们将首先建立并训练一个普通的最小二乘(OLS)回归模型，该模型为给定的<em class="ly">气缸数量</em>值估计条件平均<em class="ly">价格</em>，并在散点图上绘制回归线:</p><pre class="ls lt lu lv gt oc od oe of aw og bi"><span id="c6f8" class="oh mt jg od b gy oi oj l ok ol"><strong class="od jh"><em class="ly">#Build and train an OLS regression model</em></strong><br/>olsr_model = sm.<strong class="od jh">OLS</strong>(<strong class="od jh">endog</strong>=y_train, <strong class="od jh">exog</strong>=X_train)<br/>olsr_model_results = olsr_model.<strong class="od jh">fit</strong>()<br/><strong class="od jh">print</strong>(olsr_model_results.<strong class="od jh">summary</strong>())<br/><br/><strong class="od jh"><em class="ly">#Plot the OLS regression line on the scatter plot of Price versus num_of_cylinders<br/></em></strong>fig = plt.<strong class="od jh">figure</strong>()<br/>fig.<strong class="od jh">suptitle</strong>('Price versus Number of Cylinders')<br/>plt.<strong class="od jh">xlabel</strong>('number_of_cylinders')<br/>plt.<strong class="od jh">ylabel</strong>(<strong class="od jh">'</strong>price<strong class="od jh">'</strong>)<br/>plt.<strong class="od jh">scatter</strong>(<strong class="od jh">x</strong>=df['num_of_cylinders'], <strong class="od jh">y</strong>=df['price'])</span><span id="bf33" class="oh mt jg od b gy om oj l ok ol"><strong class="od jh"><em class="ly">#Get the estimated conditional means from the trained OLS model<br/></em></strong>y_pred_ols = olsr_model_results.<strong class="od jh">predict</strong>(X_train)</span><span id="28c8" class="oh mt jg od b gy om oj l ok ol"><strong class="od jh"><em class="ly">#Plot the estimated conditional means<br/></em></strong>ols, = plt.<strong class="od jh">plot</strong>(X_train['num_of_cylinders'], y_pred_ols,<br/>    <strong class="od jh">color</strong>=<strong class="od jh">'</strong>red<strong class="od jh">'</strong>, <strong class="od jh">marker</strong>=<strong class="od jh">'</strong>o<strong class="od jh">'</strong>, <strong class="od jh">linestyle</strong>=<strong class="od jh">'</strong>solid<strong class="od jh">'</strong>, <strong class="od jh">label</strong>=<strong class="od jh">'</strong>OLS Model<strong class="od jh">'</strong>)</span><span id="4fdf" class="oh mt jg od b gy om oj l ok ol"><strong class="od jh"><em class="ly">#Also plot the observed conditional means i.e. E(price | num_of_cylinders)<br/></em></strong>conditional_mean_pts = plt.<strong class="od jh">scatter</strong>(<strong class="od jh">x</strong>=num_of_cylinders, <strong class="od jh">y</strong>=conditional_means, <strong class="od jh">c</strong>=<strong class="od jh">'</strong>gold<strong class="od jh">'</strong>, <strong class="od jh">marker</strong>=<strong class="od jh">'</strong>o<strong class="od jh">'</strong>, <strong class="od jh">label</strong>='E(price | num_of_cylinders)')<br/><br/>plt.<strong class="od jh">legend</strong>(<strong class="od jh">handles</strong>=[ols, conditional_mean_pts])</span><span id="4c49" class="oh mt jg od b gy om oj l ok ol">plt.<strong class="od jh">show</strong>()</span></pre><p id="e813" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们看到下图:</p><figure class="ls lt lu lv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi lr"><img src="../Images/9d0cda9865877aab638e585914403a03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ToAZpKAqA82zsmUE93HO1Q.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">经过训练的OLS模型的趋势线绘制在原始数据之上。红点是估计的条件平均价格，而金点是观察到的条件平均价格(图片由作者提供)</p></figure><p id="77b9" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在让我们开始处理中位数和其他分位数点。</p><p id="003f" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们将首先训练一个模型，该模型将估计条件中值，即<em class="ly">中值(price|num_of_cylinders) </em>。</p><p id="faaf" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们创建一个分位数回归模型的实例，如下所示:</p><pre class="ls lt lu lv gt oc od oe of aw og bi"><span id="b4ae" class="oh mt jg od b gy oi oj l ok ol">median_model = smf.<strong class="od jh">quantreg</strong>(<strong class="od jh">formula</strong>=reg_exp, <strong class="od jh">data</strong>=df)</span></pre><p id="9394" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">接下来，我们将训练模型。我们将告诉statsmodels我们希望符合条件中位数，即0.5分位数点:</p><pre class="ls lt lu lv gt oc od oe of aw og bi"><span id="1de3" class="oh mt jg od b gy oi oj l ok ol">median_model_results = median_model.<strong class="od jh">fit</strong>(<strong class="od jh">q</strong>=0.5)</span></pre><p id="c981" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，让我们在原始<em class="ly">价格</em>对<em class="ly">气缸数量</em>数据的背景下，绘制该模型的估计条件中值点。为了进行比较，我们还将绘制我们之前构建的OLS模型的估计条件均值，并且我们还将绘制条件均值和条件中值的观察值以进行比较。</p><p id="bd55" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">下面这段Python代码完成了所有这些工作:</p><pre class="ls lt lu lv gt oc od oe of aw og bi"><span id="1218" class="oh mt jg od b gy oi oj l ok ol">fig = plt.figure()</span><span id="ef10" class="oh mt jg od b gy om oj l ok ol">fig.suptitle(<strong class="od jh">'Price versus Number of Cylinders'</strong>)</span><span id="5b07" class="oh mt jg od b gy om oj l ok ol">plt.xlabel(<strong class="od jh">'number_of_cylinders'</strong>)<br/>plt.ylabel(<strong class="od jh">'price'</strong>)</span><span id="bc58" class="oh mt jg od b gy om oj l ok ol"><strong class="od jh"><em class="ly">#Show the scatter plot of price versus num_of_cylinders<br/></em></strong>plt.<strong class="od jh">scatter</strong>(<strong class="od jh">x</strong>=df[<strong class="od jh">'num_of_cylinders'</strong>], <strong class="od jh">y</strong>=df[<strong class="od jh">'price'</strong>], <strong class="od jh">c</strong>=<strong class="od jh">'deepskyblue'</strong>)</span><span id="e696" class="oh mt jg od b gy om oj l ok ol"><strong class="od jh"><em class="ly">#Get the estimated conditional medians from the median model<br/></em></strong>y_pred_median = median_model_results.<strong class="od jh">predict</strong>(X_train)</span><span id="f04a" class="oh mt jg od b gy om oj l ok ol"><strong class="od jh"><em class="ly">#Plot the estimated conditional medians<br/></em></strong>median, = plt.plot(X_train[<strong class="od jh">'num_of_cylinders'</strong>], y_pred_median,<br/>    color=<strong class="od jh">'black'</strong>, marker=<strong class="od jh">'o'</strong>, linestyle=<strong class="od jh">'solid'</strong>,  label=<strong class="od jh">'Median Model'</strong>)</span><span id="06c7" class="oh mt jg od b gy om oj l ok ol"><strong class="od jh"><em class="ly">#For comparison, also plot the estimated conditional means from the OLS model we built earlier<br/></em></strong>ols, = plt.plot(X_train[<strong class="od jh">'num_of_cylinders'</strong>], y_pred_ols,<br/>    color=<strong class="od jh">'red'</strong>, marker=<strong class="od jh">'o'</strong>, linestyle=<strong class="od jh">'solid'</strong>,  label=<strong class="od jh">'OLS Model'</strong>)</span><span id="98d4" class="oh mt jg od b gy om oj l ok ol"><strong class="od jh"><em class="ly">#Calculate the observed conditional medians<br/></em></strong>conditional_medians = np.array(df.<strong class="od jh">groupby</strong>(<strong class="od jh">'num_of_cylinders'</strong>)[<strong class="od jh">'price'</strong>].median())</span><span id="da93" class="oh mt jg od b gy om oj l ok ol"><strong class="od jh"><em class="ly">#Plot the observed conditional medians<br/></em></strong>conditional_median_pts = plt.scatter(x=num_of_cylinders, y=conditional_medians, c=<strong class="od jh">'sienna'</strong>, marker=<strong class="od jh">'^'</strong>, label=<strong class="od jh">'Median(price | num_of_cylinders)'</strong>)</span><span id="aca3" class="oh mt jg od b gy om oj l ok ol"><strong class="od jh"><em class="ly">#For comparison, plot the observed conditional means<br/></em></strong>conditional_mean_pts = plt.scatter(x=num_of_cylinders, y=conditional_means, c=<strong class="od jh">'gold'</strong>, marker=<strong class="od jh">'o'</strong>, label=<strong class="od jh">'E(price | num_of_cylinders)'</strong>)</span><span id="63f6" class="oh mt jg od b gy om oj l ok ol"><strong class="od jh"><em class="ly">#Set up the legend and show the plot<br/></em></strong>plt.legend(handles=[ols, median, conditional_mean_pts, conditional_median_pts])<br/><br/>plt.show()</span></pre><p id="a77f" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们看到下面的情节:</p><figure class="ls lt lu lv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi on"><img src="../Images/5e18614f70f61da7235fff1d89efa7f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7LPwAB0crMI5qXDFmrw4dw.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">来自OLS模型的预测条件均值(红色)和来自分位数模型的条件中位数(黑色)，叠加在原始数据上的观察条件均值(金色圆点)和观察条件中位数(黑色三角形)(图片由作者提供)</p></figure><p id="b264" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们从图中注意到的一点是，条件中位数和条件均值点的观察值几乎相互重叠，这意味着价格数据在均值附近或多或少是平衡的。OLS和中位数回归模型的趋势线证明了这一点，它们彼此非常接近，尤其是朝着数据的中心部分。</p><p id="59e2" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们也为其他几个分位数点绘制回归线，比如，[0.1，0.25，0.5，0.75，0.9]。</p><pre class="ls lt lu lv gt oc od oe of aw og bi"><span id="9a0d" class="oh mt jg od b gy oi oj l ok ol">fig = plt.<strong class="od jh">figure</strong>()</span><span id="bfff" class="oh mt jg od b gy om oj l ok ol">fig.<strong class="od jh">suptitle</strong>('Price versus Number of Cylinders')</span><span id="4250" class="oh mt jg od b gy om oj l ok ol">plt.<strong class="od jh">xlabel</strong>('number_of_cylinders')<br/>plt.<strong class="od jh">ylabel</strong>('price')</span><span id="c950" class="oh mt jg od b gy om oj l ok ol">plt.<strong class="od jh">scatter</strong>(<strong class="od jh">x</strong>=df[<strong class="od jh">'</strong>num_of_cylinders<strong class="od jh">'</strong>], <strong class="od jh">y</strong>=df[<strong class="od jh">'</strong>price<strong class="od jh">'</strong>])</span><span id="0df7" class="oh mt jg od b gy om oj l ok ol">coeff = []<br/>colors = [<strong class="od jh">'orange'</strong>, <strong class="od jh">'lime'</strong>, <strong class="od jh">'yellow'</strong>, <strong class="od jh">'cyan'</strong>, <strong class="od jh">'violet'</strong>]<br/>i=0<br/>handles = []<br/>quantiles = [0.1, 0.25, 0.5, 0.75, 0.9]</span><span id="14f2" class="oh mt jg od b gy om oj l ok ol"><strong class="od jh">for </strong>q <strong class="od jh">in </strong>quantiles:<br/><strong class="od jh">    <em class="ly">#Build the model <br/></em></strong><em class="ly">    </em>quantile_model = smf.<strong class="od jh">quantreg</strong>(<strong class="od jh">formula</strong>=reg_exp, <strong class="od jh">data</strong>=df)</span><span id="4fe2" class="oh mt jg od b gy om oj l ok ol"><strong class="od jh">    <em class="ly">#Fit the model<br/></em></strong><em class="ly">    </em>quantile_model_results = quantile_model.<strong class="od jh">fit</strong>(<strong class="od jh">q</strong>=q)</span><span id="0a28" class="oh mt jg od b gy om oj l ok ol">    <strong class="od jh">print</strong>(quantile_model_results.<strong class="od jh">summary</strong>())</span><span id="4b1c" class="oh mt jg od b gy om oj l ok ol">    coeff.<strong class="od jh">append</strong>(quantile_model_results.<strong class="od jh">params</strong>[<strong class="od jh">'</strong>num_of_cylinders<strong class="od jh">'</strong>])</span><span id="b51d" class="oh mt jg od b gy om oj l ok ol"><strong class="od jh">    <em class="ly">#Get the estimated values from the quantile model <br/></em></strong><em class="ly">    </em>y_pred_quantile = quantile_model_results.<strong class="od jh">predict</strong>(X_train)</span><span id="5e4e" class="oh mt jg od b gy om oj l ok ol"><strong class="od jh">    <em class="ly">#Plot the estimated values<br/></em></strong><em class="ly">    </em>quantile, = plt.<strong class="od jh">plot</strong>(X_train[<strong class="od jh">'</strong>num_of_cylinders<strong class="od jh">'</strong>], y_pred_quantile, <strong class="od jh">color</strong>=colors[i], <strong class="od jh">marker</strong>=<strong class="od jh">'</strong>o<strong class="od jh">'</strong>, <strong class="od jh">linestyle</strong>=<strong class="od jh">'</strong>solid<strong class="od jh">'</strong>,  <strong class="od jh">label</strong>=str(int(q*100))+'th percentile Model')</span><span id="56b3" class="oh mt jg od b gy om oj l ok ol">    i = i+1<br/>    handles.<strong class="od jh">append</strong>(quantile)<br/><br/><strong class="od jh"><em class="ly">#Also plot the estimated values from the OLS model for comparison<br/></em></strong>ols, = plt.plot(X_train[<strong class="od jh">'num_of_cylinders'</strong>], y_pred_ols,<br/>    color=<strong class="od jh">'black'</strong>, marker=<strong class="od jh">'o'</strong>, linestyle=<strong class="od jh">'solid'</strong>, label=<strong class="od jh">'OLS Model'</strong>)<br/><br/>handles.<strong class="od jh">append</strong>(ols)<br/>plt.<strong class="od jh">legend</strong>(<strong class="od jh">handles</strong>=handles)</span><span id="0575" class="oh mt jg od b gy om oj l ok ol">plt.show()</span></pre><p id="301a" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">下面是这个情节的样子:</p><figure class="ls lt lu lv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oo"><img src="../Images/f2d41497c6111af42788eb2baff5af70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZQaOaw5uP8npFJsSAQrWIQ.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">各种分位数模型的预测图叠加在原始数据上(天蓝色)。OLS模型的预测(黑色)供参考(图片由作者提供)</p></figure><p id="5483" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果来自OLS模型的误差是同分布的，换句话说，如果误差是同分布的，所有分位数模型的趋势线将仅在截距上不同，即它们将彼此平行。这显然不是我们在这种情况下看到的，让我们相信OLS模型的误差是异方差的。</p><p id="8fb4" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="ly">气缸数</em>的估计系数相对于分位数的曲线得出以下曲线，该曲线仅加强了上述结论:</p><figure class="ls lt lu lv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi op"><img src="../Images/23465771fdd806248f973366e5cf57ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lt8OikJ7AR4ez7HNoN0zrQ.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">各种分位数模型的估计气缸数系数与分位数的关系图(图片由作者提供)</p></figure><p id="2b35" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们注意到的另一件事是，<em class="ly">气缸数</em>对汽车<em class="ly">价格</em>的<a class="ae jd" rel="noopener" target="_blank" href="/understanding-partial-effects-main-effects-and-interaction-effects-in-a-regression-model-54e8a127c62d">部分效应</a>(即<em class="ly">气缸数</em>的系数)随着分位数的增加而增加，表明较高的分位数价格比较低的分位数价格对气缸数的变化更敏感。例如，与第80百分位价格相比，第90百分位车辆价格随着气缸数量的每一单位变化而变化更多。</p></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><p id="ba51" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">下面是本文中使用的完整源代码:</p><figure class="ls lt lu lv gt is"><div class="bz fp l di"><div class="oq or l"/></div></figure></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><h1 id="9dab" class="ms mt jg bd mu mv nw mx my mz nx nb nc km ny kn ne kp nz kq ng ks oa kt ni nj bi translated">参考文献、引文和版权</h1><h2 id="c964" class="oh mt jg bd mu os ot dn my ou ov dp nc le ow ox ne li oy oz ng lm pa pb ni pc bi translated">数据集</h2><p id="e728" class="pw-post-body-paragraph kv kw jg kx b ky nk kh la lb nl kk ld le nm lg lh li nn lk ll lm no lo lp lq ij bi translated"><strong class="kx jh">汽车数据集</strong>由4.0 来源于<a class="ae jd" href="https://creativecommons.org/licenses/by/4.0/legalcode" rel="noopener ugc nofollow" target="_blank"> CC下的</a><a class="ae jd" href="https://archive-beta.ics.uci.edu/ml/datasets/automobile" rel="noopener ugc nofollow" target="_blank"> UCI ML数据集库</a>。</p><h2 id="34b6" class="oh mt jg bd mu os ot dn my ou ov dp nc le ow ox ne li oy oz ng lm pa pb ni pc bi translated">形象</h2><p id="bc93" class="pw-post-body-paragraph kv kw jg kx b ky nk kh la lb nl kk ld le nm lg lh li nn lk ll lm no lo lp lq ij bi translated">本文中所有图片的版权归<a class="ae jd" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener ugc nofollow" target="_blank"> CC-BY-NC-SA </a>所有，除非图片下面提到了不同的来源和版权。</p></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><p id="fe61" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="ly">如果你喜欢这篇文章，请关注我的</em><a class="ae jd" href="https://timeseriesreasoning.medium.com" rel="noopener"><strong class="kx jh"><em class="ly">Sachin Date</em></strong></a><em class="ly">获取关于回归、时间序列分析和预测主题的提示、操作方法和编程建议。</em></p></div></div>    
</body>
</html>