<html>
<head>
<title>PyTorch Lightning vs DeepSpeed vs FSDP vs FFCV vs …</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">火炬闪电 vs 极速 vs FSDP vs FFCV vs …</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/pytorch-lightning-vs-deepspeed-vs-fsdp-vs-ffcv-vs-e0d6b2a95719#2022-03-17">https://towardsdatascience.com/pytorch-lightning-vs-deepspeed-vs-fsdp-vs-ffcv-vs-e0d6b2a95719#2022-03-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e83f" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">通过混合使用 PyTorch Lightning 的这些技术来组合其优势，从而扩大 PyTorch 模型培训</h2></div><p id="eac6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">PyTorch Lightning 已经成为世界上使用最广泛的深度学习框架之一，它允许用户<strong class="kh ir">专注于研究而不是工程</strong>。Lightning 用户受益于 PyTorch 模型训练的大规模加速，从而节省了大量成本。</p><p id="5549" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">PyTorch Lightning 不仅仅是一个深度学习框架，它还是一个允许最新和最棒的技巧完美结合的平台。</p><blockquote class="lb lc ld"><p id="a008" class="kf kg le kh b ki kj jr kk kl km ju kn lf kp kq kr lg kt ku kv lh kx ky kz la ij bi translated">闪电是一个̶f̶r̶a̶m̶e̶w̶o̶r̶k̶平台</p></blockquote><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi li"><img src="../Images/1387b7a4795a9ceed45b8a4796fb5190.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*Y_7sJZJ1xJ3wlj4WMaBihw.gif"/></div></div><p class="lu lv gj gh gi lw lx bd b be z dk translated">闪电是一个平台(鸣谢:作者自有)</p></figure><p id="65e8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在过去的几年中，有许多库已经开始优化培训管道的每个阶段，当单独使用时，通常会导致 2-10 倍的速度提升。有了 Lightning，这些库可以一起用于<strong class="kh ir">合成 PyTorch 模型的效率</strong>。</p><p id="e005" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本帖中，我们将从概念上理解这些技术，并展示如何在 PyTorch Lightning 中启用它们。</p></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><h1 id="b703" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">标杆 PyTorch 闪电</h1><p id="de43" class="pw-post-body-paragraph kf kg iq kh b ki mx jr kk kl my ju kn ko mz kq kr ks na ku kv kw nb ky kz la ij bi translated">PyTorch Lightning 通过<em class="le">默认、</em>给用户提供了大量有用的东西，比如检查点、Tensorboard 日志、进度条等等……当对 PyTorch 进行基准测试时，这些必须关闭(是的，PyTorch + tensorboard 比没有它的 PyTorch 慢得多)。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi nc"><img src="../Images/8f5a1985b9331d8462281f5ef9a0a911.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hFGilEPi2_g1MmpGNwR4-g.png"/></div></div><p class="lu lv gj gh gi lw lx bd b be z dk translated">要关闭的标志(鸣谢:作者自己的)</p></figure><blockquote class="lb lc ld"><p id="6574" class="kf kg le kh b ki kj jr kk kl km ju kn lf kp kq kr lg kt ku kv lh kx ky kz la ij bi translated">要比较 PyTorch Lightning 和 PyTorch <strong class="kh ir">禁用“附加功能”</strong></p></blockquote><p id="9a19" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请记住 PyTorch Lightning 是由 PyTorch 组织的，因此与 PyTorch 进行比较是没有意义的。每个👏单一的👏将请求拉至 PyTorch Lightning 基准，并与 PyTorch 进行比较，以确保两者在解决方案或速度上没有分歧(<a class="ae nd" href="https://github.com/PyTorchLightning/pytorch-lightning/blob/master/tests/benchmarks/test_basic_parity.py" rel="noopener ugc nofollow" target="_blank">查看代码！</a>)</p><p id="547c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">以下是其中一个基准的示例:</p><figure class="lj lk ll lm gt ln"><div class="bz fp l di"><div class="ne nf l"/></div><p class="lu lv gj gh gi lw lx bd b be z dk translated">PyTorch vs 闪电基准代码(鸣谢:作者自有)</p></figure></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><h1 id="0a85" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">深度速度</h1><p id="fbad" class="pw-post-body-paragraph kf kg iq kh b ki mx jr kk kl my ju kn ko mz kq kr ks na ku kv kw nb ky kz la ij bi translated"><a class="ae nd" href="https://github.com/microsoft/DeepSpeed" rel="noopener ugc nofollow" target="_blank"> DeepSpeed </a>是微软创造的一种大规模训练大规模十亿参数模型的技术。如果你有 800 个 GPU，你也可以得到<a class="ae nd" href="https://www.microsoft.com/en-us/research/blog/deepspeed-extreme-scale-model-training-for-everyone/" rel="noopener ugc nofollow" target="_blank">万亿个参数模型</a>😉。</p><p id="20ee" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">DeepSpeed 如何实现规模的关键是通过引入<strong class="kh ir">零冗余优化器(</strong> <a class="ae nd" href="https://www.deepspeed.ai/tutorials/zero/" rel="noopener ugc nofollow" target="_blank"> <strong class="kh ir">零</strong> </a> <strong class="kh ir">)。零有三个阶段:</strong></p><ol class=""><li id="a57f" class="ng nh iq kh b ki kj kl km ko ni ks nj kw nk la nl nm nn no bi translated">优化器状态跨进程进行分区。</li><li id="a8f8" class="ng nh iq kh b ki np kl nq ko nr ks ns kw nt la nl nm nn no bi translated">渐变是跨进程划分的。</li><li id="d6eb" class="ng nh iq kh b ki np kl nq ko nr ks ns kw nt la nl nm nn no bi translated">模型参数跨流程进行划分。</li></ol><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi li"><img src="../Images/4332e19ad9ca0b7d2523ca1c7aafc87e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*G2vHuJJFtVC5C2Jv_fxIVw.gif"/></div></div><p class="lu lv gj gh gi lw lx bd b be z dk translated">DeepSpeed 解释(鸣谢:作者自己)</p></figure><p id="9fea" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要在闪电中启用 DeepSpeed，只需将<code class="fe nu nv nw nx b">strategy='deepspeed'</code>传递给你的闪电训练器(<a class="ae nd" href="https://pytorch-lightning.readthedocs.io/en/1.2.0/advanced/multi_gpu.html?highlight=deepspeed#deepspeed" rel="noopener ugc nofollow" target="_blank"> docs </a>)。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi ny"><img src="../Images/2fcb7c200719815b1090fc3f30b76e75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zERoNNqkkmCCjLySLdDiiw.png"/></div></div><p class="lu lv gj gh gi lw lx bd b be z dk translated">在 Lightning 中启用 DeepSpeed(鸣谢:作者所有)</p></figure></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><h1 id="7048" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">FSDP</h1><p id="afbd" class="pw-post-body-paragraph kf kg iq kh b ki mx jr kk kl my ju kn ko mz kq kr ks na ku kv kw nb ky kz la ij bi translated">完全分片数据并行(<a class="ae nd" href="https://fairscale.readthedocs.io/en/stable/api/nn/fsdp.html" rel="noopener ugc nofollow" target="_blank"> FSDP </a>)是 Meta 的分片版本，灵感来自 DeepSpeed(阶段 3)，针对 PyTorch 兼容性进行了优化(<a class="ae nd" href="https://pytorch.medium.com/training-a-1-trillion-parameter-model-with-pytorch-fully-sharded-data-parallel-on-aws-3ac13aa96cff" rel="noopener">阅读他们最新的 1 万亿参数尝试</a>)。</p><p id="518f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">FSDP 是由脸书(现在的 Meta)的 FairScale 团队开发的，重点是优化 PyTorch 兼容性。尝试两种方法，看看你是否能注意到不同之处！</p><p id="1fb0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要在 PyTorch Lightning ( <a class="ae nd" href="https://pytorch-lightning.readthedocs.io/en/stable/advanced/advanced_gpu.html" rel="noopener ugc nofollow" target="_blank"> docs </a>)中使用 FSDP，请使用:</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi nz"><img src="../Images/4fb054db1eac7e94e2b1a2ea6fd721d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UjiBT7tXtGFCGL-X3GZKKA.png"/></div></div><p class="lu lv gj gh gi lw lx bd b be z dk translated">《闪电》中的 FSDP(鸣谢:作者自己)</p></figure></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><h1 id="ef2c" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">FFCV</h1><p id="1c79" class="pw-post-body-paragraph kf kg iq kh b ki mx jr kk kl my ju kn ko mz kq kr ks na ku kv kw nb ky kz la ij bi translated">DeepSpeed 和 FSDP 优化了负责跨机器分发模型的管道部分。</p><p id="45e7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当您有一个图像数据集时，FFCV 通过利用数据集中的共享结构来优化管道中的数据处理部分。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi oa"><img src="../Images/ab6c94d3ae1d557351d30cb2980c48f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_gfsC8AkaQCV6lD3Oh8huw.png"/></div></div><p class="lu lv gj gh gi lw lx bd b be z dk translated">FFCV 优化了更广泛的管道的一部分(鸣谢:作者自己)</p></figure><p id="28fd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae nd" href="https://github.com/libffcv/ffcv" rel="noopener ugc nofollow" target="_blank"> FFCV </a>当然是对极速和 FSDP 的补充，因此也可以在 PyTorch Lightning 中使用。</p><p id="6e4e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="le">注意:FFCV 团队报告的基准测试并不完全公平，因为他们没有禁用 PyTorch Lightning 中的 tensorboard、logging 等功能，也没有启用 Deepspeed 或 FSDP 来合成使用 FFCV 的效果。</em></p><p id="12d6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">FFCV 集成目前正在进行中，将在未来几周内在 PyTorch Lightning 中提供。</p><div class="ob oc gp gr od oe"><a href="https://github.com/PyTorchLightning/pytorch-lightning/issues/11538" rel="noopener  ugc nofollow" target="_blank"><div class="of ab fo"><div class="og ab oh cl cj oi"><h2 class="bd ir gy z fp oj fr fs ok fu fw ip bi translated">使用 PL 问题# 11538 PyTorchLightning/pytorch-lightning 启用 ffcv</h2><div class="ol l"><h3 class="bd b gy z fp oj fr fs ok fu fw dk translated">一个团队引入了 ffcv，它在数据加载器级别进行优化。只要它能代替…</h3></div><div class="om l"><p class="bd b dl z fp oj fr fs ok fu fw dk translated">github.com</p></div></div><div class="on l"><div class="oo l op oq or on os ls oe"/></div></div></a></div></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><h1 id="4722" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">设计者</h1><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi ot"><img src="../Images/ff3f528e5d439bdef9823d8a6a0d97e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kk8XrTf2W5vZNjQogr3wQw.png"/></div></div><p class="lu lv gj gh gi lw lx bd b be z dk translated">Composer 优化了培训管道的一部分(鸣谢:作者自己的)</p></figure><p id="52ea" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Composer 是另一个处理培训管道不同部分的库。Composer 添加了某些技术，如 BlurPooling、ChannelsLast、CutMix 和 LabelSmoothing。</p><figure class="lj lk ll lm gt ln"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="6c80" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这些技术可以在优化开始之前添加到模型中。这意味着，要将 composer 与 PyTorch Lightning 一起使用，您只需在开始训练循环之前对模型手动运行优化即可。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi li"><img src="../Images/34f8a4407a91dc72e71cb6b35c7e84cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*FLzH-ys1L4js-HZWGISjqg.gif"/></div></div><p class="lu lv gj gh gi lw lx bd b be z dk translated">马赛克优化适用于兼容 PyTorch 闪电(信用:作者自己的)</p></figure><p id="da92" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Lightning 团队正在研究将 mosaic 与 PyTorch Lightning 整合的最佳方式。</p><div class="ob oc gp gr od oe"><a href="https://github.com/PyTorchLightning/pytorch-lightning/issues/12360" rel="noopener  ugc nofollow" target="_blank"><div class="of ab fo"><div class="og ab oh cl cj oi"><h2 class="bd ir gy z fp oj fr fs ok fu fw ip bi translated">支持马赛克优化作为插件问题# 12360 PyTorchLightning/pytorch-lightning</h2><div class="ol l"><h3 class="bd b gy z fp oj fr fs ok fu fw dk translated">这个库马赛克有优化模型以加快训练的巧妙技巧。每个应用程序都是作为单个…</h3></div><div class="om l"><p class="bd b dl z fp oj fr fs ok fu fw dk translated">github.com</p></div></div><div class="on l"><div class="ou l op oq or on os ls oe"/></div></div></a></div></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><h1 id="1e05" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">结束语</h1><p id="0e20" class="pw-post-body-paragraph kf kg iq kh b ki mx jr kk kl my ju kn ko mz kq kr ks na ku kv kw nb ky kz la ij bi translated">PyTorch Lightning 不仅仅是一个深度学习框架，它还是一个平台！</p><p id="1b7a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">PyTorch Lightning 允许您集成最新的技术，这样它们可以很好地协同工作，并保持您的代码高效有序，而不是试图重新发明轮子。</p><p id="88bf" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">新推出的解决管道不同部分的优化将在几周内集成。如果您正在创建一个新的社区，请联系 lightning 团队，以便 lightning 团队可以与您合作，使您的集成成为社区的一个平稳体验！</p></div></div>    
</body>
</html>