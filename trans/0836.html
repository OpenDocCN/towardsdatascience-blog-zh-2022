<html>
<head>
<title>Monitoring to protect data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">监控以保护数据</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/monitoring-to-protect-data-890b21a186c1#2022-03-07">https://towardsdatascience.com/monitoring-to-protect-data-890b21a186c1#2022-03-07</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="8720" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">您如何监控您部署的模型发生了什么？</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/f9ae58ff70e73cf6d4b3da052cb84e11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xn_yYOBvs1VLTqAE"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">罗伯特·拉尔森在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="feb8" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">每当有人访问一个站点或进行 API 调用时，都会在操作系统的某个日志文件中记录一个条目。如果没有，真的应该有一个！阅读和处理这些日志文件对于理解好的和坏的参与者在做什么以及谁在做什么是至关重要的。当然，python 对于这种活动来说非常方便，但是处理这些日志文件的选择就像咖啡的味道一样多。你的日志策略是什么？</p><p id="844d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我在<a class="ae kz" href="https://medium.com/@cognitivedave" rel="noopener">的任务是向求职者揭露 NLP 程序</a>，安全是我的首要任务。如果你是第一次收听，那么需要注意的是<a class="ae kz" href="https://medium.com/towards-data-science/from-nlp-prototype-to-production-c2b555488dc5" rel="noopener">我已经使用 FastAPI 和 vue.js </a>构建了一个应用程序，并且<a class="ae kz" href="https://www.justresumes.net/" rel="noopener ugc nofollow" target="_blank">将它托管在 AWS </a>上。应用程序基础结构已经就绪，我已经对安全性进行了分类；我相信是合理的！前一段时间我已经制定出了 NLP 战略。今天我在看日志文件，一些请求来自坏人，所以我开始分析自从几周前网站上线以来的流量。我是这样做的！</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h2 id="093b" class="md me iu bd mf mg mh dn mi mj mk dp ml lj mm mn mo ln mp mq mr lr ms mt mu mv bi translated">在虚拟服务器上</h2><p id="2ea4" class="pw-post-body-paragraph la lb iu lc b ld mw jv lf lg mx jy li lj my ll lm ln mz lp lq lr na lt lu lv in bi translated">我只运行一个小的免费层服务器，所以我不想做任何花哨的东西，而是让它服务于页面和响应 API 调用。为了简化，我在服务器上安装了<a class="ae kz" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html" rel="noopener ugc nofollow" target="_blank"> AWS 命令行工具</a>。使用命令行需要凭证，并且您必须用一个一次性命令<a class="ae kz" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html" rel="noopener ugc nofollow" target="_blank">配置那些</a>。</p><pre class="kk kl km kn gu nb nc nd ne aw nf bi"><span id="9dca" class="md me iu nc b gz ng nh l ni nj">sudo apt install awscli<br/>aws configure</span></pre><p id="d508" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">使用 IAM，我在 AWS 控制台上创建了一个拥有完全 S3 读写权限的新用户。配置命令要求:-</p><ul class=""><li id="bc68" class="nk nl iu lc b ld le lg lh lj nm ln nn lr no lv np nq nr ns bi translated">访问密钥 ID；当您创建一个新用户时，您会得到这个。</li><li id="a20c" class="nk nl iu lc b ld nt lg nu lj nv ln nw lr nx lv np nq nr ns bi translated">秘密访问密钥；创建该用户时会得到这个。</li><li id="0547" class="nk nl iu lc b ld nt lg nu lj nv ln nw lr nx lv np nq nr ns bi translated">默认的地区名称，在我的例子中是 EU-西-1；</li><li id="9cf6" class="nk nl iu lc b ld nt lg nu lj nv ln nw lr nx lv np nq nr ns bi translated">默认输出格式，我保留为 JSON。</li></ul><p id="88f9" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">接下来，我建立了一个名为“justresumes”的全新 S3 桶，这是我的网站的名字。最后，我发出了一个命令。</p><pre class="kk kl km kn gu nb nc nd ne aw nf bi"><span id="9b55" class="md me iu nc b gz ng nh l ni nj">cd /var/log<br/>aws s3 cp . s3://justresumes/ --recursive --include "*log"</span></pre><p id="8411" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">使用 AWS 命令行，使用递归将/var/log 中的所有文件复制到新的 S3 存储桶中，并且只包括文件名中包含“log”的文件。接下来可以看到终端的截图。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ny"><img src="../Images/e1401a2b2bd7999a4980baf9cc909381.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hB5GuNL4gtiYKWrZdVgMIQ.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">AWS 虚拟服务器终端的屏幕截图—将日志文件复制到 S3 存储桶。作者图片</p></figure><p id="a2ba" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这样，任何闻起来像日志文件的东西现在都在 S3 桶上，准备进行分析。</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h2 id="5cf5" class="md me iu bd mf mg mh dn mi mj mk dp ml lj mm mn mo ln mp mq mr lr ms mt mu mv bi translated">将日志提取到本地机器</h2><p id="a935" class="pw-post-body-paragraph la lb iu lc b ld mw jv lf lg mx jy li lj my ll lm ln mz lp lq lr na lt lu lv in bi translated">我知道你会说使用本地机器？但是我们正在调查那些坏人在做什么！因此，我再次创建了一个新的 IAM 用户，并检索了凭证以允许与 S3 存储桶进行编程连接。下面是我用来将特定文件从 S3 下载到本地的代码。</p><pre class="kk kl km kn gu nb nc nd ne aw nf bi"><span id="52fa" class="md me iu nc b gz ng nh l ni nj">import os<br/>import boto3</span><span id="84cf" class="md me iu nc b gz nz nh l ni nj">session = boto3.Session(<br/>    aws_access_key_id=s3_creds['id'],<br/>    aws_secret_access_key=s3_creds['secret'])</span><span id="a721" class="md me iu nc b gz nz nh l ni nj">s3 = session.resource('s3')</span><span id="d02b" class="md me iu nc b gz nz nh l ni nj">justresumes = s3.Bucket('justresumes')<br/>store = '/Users/davidmoore/Documents/projects/semantic/logs/'</span><span id="cd50" class="md me iu nc b gz nz nh l ni nj">for file in justresumes.objects.all():<br/>    path, filename = os.path.split(file.key)<br/>    if ('nginx' in path) and ('access' in filename):<br/>        print(path, filename)<br/>        writer=store+filename<br/>        justresumes.download_file(file.key, writer)</span></pre><p id="decc" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">使用新 IAM 用户的 S3 凭证，我创建了一个 boto3 会话，并将该会话链接到 S3 服务。今天我在找来自</p><pre class="kk kl km kn gu nb nc nd ne aw nf bi"><span id="737f" class="md me iu nc b gz ng nh l ni nj">/var/log/nginx -- specifically access*.*</span></pre><p id="dedd" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">运行该代码片段会交付一组文件。有些用 GZIP 表示压缩文件，但有些是未压缩的。Nginx 旋转日志文件并增加压缩以节省部署的 web 服务器上的存储空间。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj oa"><img src="../Images/910d3764e8ad3cc3bc012bbae2f42330.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fNPIKK1lYkvyOOPsWA0jrg.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">脚本运行后日志文件夹的屏幕截图。图片由作者提供。</p></figure><p id="3656" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在那个阶段，我们有数据文件(15)。</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h2 id="9a15" class="md me iu bd mf mg mh dn mi mj mk dp ml lj mm mn mo ln mp mq mr lr ms mt mu mv bi translated">在本地机器上处理文件</h2><p id="2512" class="pw-post-body-paragraph la lb iu lc b ld mw jv lf lg mx jy li lj my ll lm ln mz lp lq lr na lt lu lv in bi translated">有了从 S3 下载并存储在本地的数据文件，我只需要一点解析和一个熊猫数据框就可以开始研究最近的事件了。</p><p id="42b3" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv">第一步</strong>:获取所有待处理文件的列表</p><pre class="kk kl km kn gu nb nc nd ne aw nf bi"><span id="56aa" class="md me iu nc b gz ng nh l ni nj">store = '/Users/davidmoore/Documents/projects/semantic/logs/'</span><span id="e048" class="md me iu nc b gz nz nh l ni nj">import os<br/>import gzip</span><span id="91ea" class="md me iu nc b gz nz nh l ni nj">logs = os.listdir(store)</span></pre><p id="ad3e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们需要 gzip 来管理那些压缩文件(。gz)。</p><p id="7f86" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv">第二步:</strong>将所有的日志条目读入一个列表</p><pre class="kk kl km kn gu nb nc nd ne aw nf bi"><span id="a509" class="md me iu nc b gz ng nh l ni nj">logLines = []</span><span id="c68a" class="md me iu nc b gz nz nh l ni nj">for log in logs:<br/>    if 'access' in log:<br/>       filetype = log.split('.')<br/>       fullPath=store+log<br/>       if filetype[len(filetype)-1] == 'gz':<br/>           logFile=gzip.open(fullPath, 'rb')<br/>           while True:<br/>               logContent=logFile.readline()<br/>               logLines.append(logContent)<br/>           <br/>               if not logContent:<br/>                   break<br/><br/>       else:<br/>           logFile=open(fullPath, 'rb')<br/>           while True:<br/>               logContent=logFile.readline()<br/>               logLines.append(logContent)<br/>               <br/>               if not logContent:<br/>                   break<br/></span></pre><p id="37c6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">该脚本逐行遍历这 15 个文件，并创建一个 python 列表。如果您使用 Spyder IDE，有一种简单的方法可以使用变量浏览器查看变量的内容。下面是运行脚本后 logLines 变量的屏幕截图。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ob"><img src="../Images/762686e163538441f62c90cb82f78cf3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J25f88H6t9f6LPCHg035mA.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">Spyder IDE 变量资源管理器—作者图片。</p></figure><p id="c781" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">因此，自从服务器启动以来，我们有来自 15 个不同文件的 7790 个单独的 Nginx 条目。如果你以前没有见过 Nginx 标准日志文件，这里有一个截图。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ob"><img src="../Images/fb96bc1a953ece497a278f234605e686.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u3c6j8kDuUAyOgekiPvlnA.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">Nginx 标准日志条目—作者图片。</p></figure><p id="50b2" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">下一步是解析和移动到熊猫！</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="oc od l"/></div></figure><p id="72d0" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们遍历 logLines 对象中的每个条目(7，790 个列表元素)。接下来，我去 Nginx 弄清楚列和解析策略。通过反复试验，分成引号和空格，让我最终到达了我想去的地方。下面是组合日志格式的 nginx.conf 配置。</p><pre class="kk kl km kn gu nb nc nd ne aw nf bi"><span id="41e1" class="md me iu nc b gz ng nh l ni nj"># nginx.conf<br/>http {<br/>  ...<br/>  log_format combined '$remote_addr - $remote_user [$time_local] '<br/>                      '"$request" $status $body_bytes_sent '<br/>                      '"$http_referer" "$http_user_agent"';<br/>  ...<br/>}</span></pre><p id="0d98" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">最终，我得到了一个字典列表，其数据属性如截图所示。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj oe"><img src="../Images/eb67b1c7e709791bae3f3d57f72b568a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sDOXO0up6AZS0B2v5bAJZw.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">解析整组日志记录后的单个记录。</p></figure><p id="c075" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">终于可以开始对数据提问了！</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj of"><img src="../Images/2cab2b91edf605eb5f888778e0d1e2fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QiQb5vamyuDHkOQSGXUblg.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">图片来自 Spyder</p></figure><p id="362d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">有 1002 个唯一的远程 IP 地址</p><p id="547d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">有 9 个 HTTP 状态代码，它们是 502 到 413。200 是 OK 的代码，这是一次成功的互动。4%%都是错误。304 被从 HTTP 重定向到 HTTPS。502 是一个糟糕的网关，当我的应用程序出现配置错误时就会出现这种情况。</p><h2 id="0c84" class="md me iu bd mf mg mh dn mi mj mk dp ml lj mm mn mo ln mp mq mr lr ms mt mu mv bi translated">一些例子</h2><p id="cedb" class="pw-post-body-paragraph la lb iu lc b ld mw jv lf lg mx jy li lj my ll lm ln mz lp lq lr na lt lu lv in bi translated">" GET/robots . txt HTTP/1.1 "<strong class="lc iv">403</strong>118 "-" Mozilla/5.0(兼容；blex bot/1.0；+【http://webmeup-crawler.com/)”——<strong class="lc iv">前住</strong></p><p id="bde6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">" GET/AWS . yml HTTP/1.1 "<strong class="lc iv">404</strong>181 "-"—<strong class="lc iv">未找到</strong></p><p id="8c30" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">所以现在我有一些工作要做，检查所有这些记录，并确定我是否需要更改安全策略。收集和使用个人或敏感的个人数据需要绝对的安全，因此我继续探索向求职者展示安全可靠的 NLP 服务！</p><div class="og oh gq gs oi oj"><a href="https://cognitivedave.medium.com/membership" rel="noopener follow" target="_blank"><div class="ok ab fp"><div class="ol ab om cl cj on"><h2 class="bd iv gz z fq oo fs ft op fv fx it bi translated">通过我的推荐链接-大卫·摩尔加入媒体</h2><div class="oq l"><h3 class="bd b gz z fq oo fs ft op fv fx dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="or l"><p class="bd b dl z fq oo fs ft op fv fx dk translated">cognitivedave.medium.com</p></div></div><div class="os l"><div class="ot l ou ov ow os ox kt oj"/></div></div></a></div></div></div>    
</body>
</html>