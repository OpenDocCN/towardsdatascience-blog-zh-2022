<html>
<head>
<title>Understand BigQuery Schema Auto-detection</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解BigQuery模式自动检测</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/understand-bigquery-schema-auto-detection-9b4cebfe6d03#2022-05-24">https://towardsdatascience.com/understand-bigquery-schema-auto-detection-9b4cebfe6d03#2022-05-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="b846" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">并选择手动定义和控制BigQuery表模式</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/9e9781651ceec8bee1c6d643cb917c76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JxYyz3Z3uf4vWEjU"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">米歇尔·雅库博夫斯基在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="8c4e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当人们需要创建数据库表时，模式自动检测是一个很有吸引力的特性。想想吧！能够自动检测数据模式听起来真的很棒，因为它可以节省传统上用于手动定义数据模式的时间。</p><p id="1c3d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">不足为奇的是，BigQuery为一些数据类型提供了<a class="ae kv" href="https://cloud.google.com/bigquery/docs/schema-detect" rel="noopener ugc nofollow" target="_blank">模式自动检测能力</a>，包括CSV、NEWLINE_DELIMITED_JSON(又名JSONL)和AVRO。</p><p id="5386" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">虽然我不能否认该特性在开发阶段对快速原型开发的有用性，但我认为它应该在自动化生产环境中小心使用，<strong class="ky ir">尤其是当你处理大数据的时候</strong>。原因如下:</p><blockquote class="ls lt lu"><p id="2ecc" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">B <!-- --> igQuery根据数据样本推断表的模式，而不是查看整个数据，至少对于大数据是这样。</p></blockquote><p id="1df1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我用两个简单的例子来说明我的意思。</p><p id="f33c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">示例1:加载一个看起来像整数列的字符串列</strong></p><p id="b08c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">考虑以下数据。它包含10 001个代码，用5个字符表示。除了以字母“a”开头的最后一个代码外，所有代码都由5个数字字符组成。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/4fa5c123c59835bfaaacbf165a07bbcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:632/format:webp/1*L08_4gmSDjdGhlFjvKX9Tw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片，来自代码数据的5行样本</p></figure><p id="450c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要将名为<em class="lv"> test_sample_1.csv </em>的CSV文件中的数据加载到名为<em class="lv"> test_sample_1 </em>的BigQuery表中，我们将使用以下命令:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ma mb l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="d7b6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，我们得到一个令人讨厌的错误，说BigQuery无法解析代码<strong class="ky ir"> a2153 </strong>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mc"><img src="../Images/d85f8a9f1bfb3d919d95b061e2567ee7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5xoR8DtzkT6H4Z8jjvoKoA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="9fde" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">实际上基于一个数据样本，BigQuery推断列<em class="lv">代码</em>是一个整数<em class="lv"> </em>。然后，它试图将值<strong class="ky ir"> a2153 </strong>转换成整数，这显然是不可行的。</p><p id="70ff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是我们在公司尝试利用BigQuery模式自动检测实现自动化时遇到的第一个问题。但更糟糕的还在后面。</p><p id="3226" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">示例2:加载带有可选字段的JSON记录</strong></p><p id="7ec9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这次我们来试试JSONL格式的数据。该数据包含由代码识别的10 0001所房屋的地址。除了主地址(列地址1)之外，房屋还可能有辅助地址(列地址2)。在我们的样本数据中，只有一个房子恰好有一个二级地址，那就是house <strong class="ky ir"> 34512 </strong>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi md"><img src="../Images/71ee2496507e589809c7bc990b0d31c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0v6x065KJ8V5BQegej6K6Q.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片，地址数据中的5行样本</p></figure><p id="a76e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们运行类似于上一个命令的命令，将数据加载到BigQuery表中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ma mb l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="9ffa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这里，我们还会返回一个错误，指示BigQuery自动检测到的模式中没有<strong class="ky ir">address . address 2</strong>列。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi me"><img src="../Images/72fe8e97ed499a451e54bbb10ebcf306.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*02_soU6rgJ9PHdSFEhvD0g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="f8ae" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">同样，自动检测是基于不包含房屋<strong class="ky ir"> 34512 </strong>行的行样本。</p><h2 id="287e" class="mf mg iq bd mh mi mj dn mk ml mm dp mn lf mo mp mq lj mr ms mt ln mu mv mw mx bi translated">解决方案:手动定义和控制您的BigQuery表模式</h2><p id="9487" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">通过定义一个模式并将该模式提供给bq load命令，我们可以非常容易地解决上述两个问题。</p><p id="7c28" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于代码数据，我们会</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ma mb l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="ff39" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于地址数据，我们将首先定义一个模式文件。然后，我们将运行load命令。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ma mb l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ma mb l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="7def" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里的关键是将<strong class="ky ir"> address.address2列声明为可空的</strong>。</p><h2 id="df07" class="mf mg iq bd mh mi mj dn mk ml mm dp mn lf mo mp mq lj mr ms mt ln mu mv mw mx bi translated">结束注释</h2><p id="7ca3" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">如果您不知道BigQuery中的模式自动检测是如何工作的，那么它可能会让您非常头疼。长话短说，BigQuery对您的数据(至少是大数据)进行采样，并基于该样本计算模式。通常情况下，样本模式与数据的实际模式不匹配。因此，我建议根据数据知识手动定义数据模式。<br/>请在这里找到文章<a class="ae kv" href="https://gitlab.com/marcdjoh/understand-bigquery-schema-autodetection" rel="noopener ugc nofollow" target="_blank">中使用的样本数据和代码片段。</a></p><p id="15e9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">直到下一次写作，拜拜。</p></div></div>    
</body>
</html>