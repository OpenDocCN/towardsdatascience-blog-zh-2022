<html>
<head>
<title>Waterfall charts with Excel, Matplotlib and Plotly</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带有Excel、Matplotlib和Plotly的瀑布图</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/waterfall-charts-with-excel-matplotlib-and-plotly-5b3fb42cbf46#2022-05-17">https://towardsdatascience.com/waterfall-charts-with-excel-matplotlib-and-plotly-5b3fb42cbf46#2022-05-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="64d8" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在Excel和Python中创建瀑布图</h2></div><p id="1971" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">瀑布图是一种数据可视化形式，它将从初始阶段到最终阶段的各种中间步骤的逐步贡献可视化。初始阶段和最终阶段由瀑布图中的<strong class="kk iu">全栏</strong>表示。这些列是满的，因为它们在水平轴上从零开始。</p><p id="5afc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">另一方面，中间值是初始阶段和最终阶段之间的一系列正的或负的步骤。这些中间值在瀑布图中显示为<strong class="kk iu">浮动列</strong>。这些列位于隐藏基数的顶部，隐藏基数是初始值和先前正或负增量步骤的净和的总和。因此，瀑布图根据其外观也被称为<strong class="kk iu">飞砖</strong>图或<strong class="kk iu">桥</strong>图。</p><p id="0a19" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">瀑布图有着广泛的应用，但它们在金融领域尤其流行。例如，瀑布图用于直观地说明一家公司在某一年年初的收入如何按月<strong class="kk iu">(基于时间)</strong>变化，以达到年底的累计收入。同样，它也可用于说明年初的总收入贡献如何增加或减少公司投资组合中的每个产品<strong class="kk iu">(基于类别)</strong>以达到日历年末的净收入。</p><p id="5918" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用不同的工具有不同的方法来构建瀑布图。在这篇文章中，我将分享一些使用Excel和Python中的matplotlib和Plotly包构建瀑布图的技巧。让我们开始吧。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/e1b4908ada205b643a4de85ba8e048d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N2J-XYunJQXXQNjL4jlo-A.jpeg"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">图片由<a class="ae lu" href="https://unsplash.com/@robertlukeman" rel="noopener ugc nofollow" target="_blank">罗伯特·卢克曼</a>在<a class="ae lu" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="e2c4" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">虚拟示例</h1><p id="dca4" class="pw-post-body-paragraph ki kj it kk b kl mu ju kn ko mv jx kq kr mw kt ku kv mx kx ky kz my lb lc ld im bi translated">作为一个假设的案例，我将使用瀑布图来说明在六个月的时间里，一座建筑中不同的节电措施的逐步效果。本例中使用的数据纯粹是虚拟值，仅用于说明目的。</p><p id="ed4e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">考虑到我的大楼截至目前每月用电量为150千瓦时。我决定在夏天在我的大楼里安装一定数量的新风扇和冰箱，因此每月的耗电量将分别增加10和15个单位。由于我的用电量达到了每月175台，我起草了一些措施来减少每月的用电量。作为短期措施，我计划采取一些行为上的改变。比如:不用电器时拔掉插头，满负荷运转洗衣机，修理故障水电泄漏。我粗略估计，这些措施将有助于在短期内每月减少15、15和5个单位的电力。结果，三个月后我的月用电量将达到140单位。</p><p id="c055" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">三个月后，我打算安装一些新设备或更换现有设备。如:安装智能恒温器，用LED灯取代现有的灯泡，用笔记本电脑取代大楼里的台式电脑。据估计，这些措施将帮助我的建筑分别减少25、10和10个单位的电力消耗。因此，我的大楼每月的用电量将从现在的150单位增加到六个月后的90单位。</p><h1 id="6a1e" class="mc md it bd me mf mz mh mi mj na ml mm jz nb ka mo kc nc kd mq kf nd kg ms mt bi translated">用Excel制作瀑布图</h1><p id="f369" class="pw-post-body-paragraph ki kj it kk b kl mu ju kn ko mv jx kq kr mw kt ku kv mx kx ky kz my lb lc ld im bi translated">上述假设的例子可以用如下所示的Excel表格来表示:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ne"><img src="../Images/3eea463b6d5656b96b508201d1e47a3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kea1avMcKofRpj5IiBwVDQ.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">代表我所在建筑的电流和节能措施的Excel表格。图片作者。</p></figure><p id="0cd3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">蓝色单元格分别代表我所在的大楼截至目前、三个月后和六个月后的每月用电量。绿色单元格表示逐步增加，红色单元格表示有助于逐步减少我所在建筑每月耗电量的措施。该表中的第一列是基础列。蓝色单元格的基础值为零。在增量的情况下，基本值加上绿色单元格中的值。在下降的情况下，从基础值中减去红细胞的值。</p><p id="bd62" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Microsoft Office的最新版本有一个在“插入”选项卡中创建瀑布图的默认选项。然而，为了通过选择上面的表格在Excel中绘制瀑布图，我首先插入了堆积柱形图。基本列中的非零值仍然可见。因此，为了使它们不可见，我为这些列选择了不填充选项。生成的瀑布图如下所示。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nf"><img src="../Images/24c605c13fa81c0914c9b7e73b51fb20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lfWnpiLQSXS2jgqlzD_qlw.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">使用Excel创建的瀑布图。图片作者。</p></figure><p id="2fee" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我手动排列了不同列的颜色，蓝色条代表基本值，绿色条代表逐步增加，红色条代表逐步减少耗电量的措施。结果图如下所示。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ng"><img src="../Images/ce17fc4834c365e3d2271ff51edc5ec1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jxFnoQkzvgfE2F4OdkTbDg.png"/></div></div></figure><h1 id="fb3a" class="mc md it bd me mf mz mh mi mj na ml mm jz nb ka mo kc nc kd mq kf nd kg ms mt bi translated">带有熊猫和matplotlib的瀑布图</h1><p id="b1d0" class="pw-post-body-paragraph ki kj it kk b kl mu ju kn ko mv jx kq kr mw kt ku kv mx kx ky kz my lb lc ld im bi translated">上面在Excel中创建的图可以很方便地使用Python重新创建。我使用了pandas和matplotlib包。我读取同一个Excel表，用0填充NaN值，得到下面的数据帧<code class="fe nh ni nj nk b">df</code>:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nl"><img src="../Images/518633808baa6fcc8a7a03b3eca31b50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x3USSFqFAMwDBQJGECQIpw.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">熊猫数据框代表我的建筑的电流和节能措施。图片作者。</p></figure><p id="4455" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面给出了用于重新创建第一个图的代码。数据框从<code class="fe nh ni nj nk b">Current level</code>列向前绘制，以<code class="fe nh ni nj nk b">df</code>的<code class="fe nh ni nj nk b">Base</code>列为底部。</p><pre class="lf lg lh li gt nm nk nn no aw np bi"><span id="594c" class="nq md it nk b gy nr ns l nt nu">df.loc[:,”Current level”:].plot(kind = “bar”, <br/>                                bottom = df[“Base”],<br/>                                width = 35)<br/>plt.xticks([])<br/>plt.title(“My electricity saving plan”)<br/>plt.ylabel(“kWh consumption”)<br/>plt.tight_layout()<br/>plt.show()</span></pre><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nv"><img src="../Images/57653e93a9f1b3a09630b70e33c7425f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*80pzPuVTU0Bop7d1SIl7_A.jpeg"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">第一个使用pandas和matplotlib创建的瀑布图。图片作者。</p></figure><p id="63be" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在上面的图中，每个具有独特颜色的条形代表电流或节能的不同步骤。在下一个图中，我想分别用蓝色、绿色和红色突出显示具有初始值/中间值/最终值、步进增量和减量的列。因此，我为每个条形定义了一个颜色列表。</p><p id="e23c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我重新构建了熊猫数据框架，如下图所示，以<code class="fe nh ni nj nk b">df</code>的<code class="fe nh ni nj nk b">Base</code>列为底部绘制一个柱状图。我还手动选择了补丁和标签来定义每种颜色。</p><pre class="lf lg lh li gt nm nk nn no aw np bi"><span id="2753" class="nq md it nk b gy nr ns l nt nu">plt.figure(figsize = (6, 6))</span><span id="156f" class="nq md it nk b gy nw ns l nt nu">colors = [“royalblue”,”green”,”green”,”red”,”red”,”red”,<br/>          “royalblue”, “red”, “red”, “red”, “royalblue”]</span><span id="e7b4" class="nq md it nk b gy nw ns l nt nu">fig = df.T[1:].max(axis = 1).plot(kind = “bar”,<br/>                                  bottom = df[“Base”],<br/>                                  width = 0.8,<br/>                                  color = colors)</span><span id="cff9" class="nq md it nk b gy nw ns l nt nu">selected_patches = fig.patches[0], fig.patches[2], fig.patches[4]</span><span id="6bec" class="nq md it nk b gy nw ns l nt nu">plt.legend(selected_patches,<br/>           [“Base value”, “Rise”, “Fall”],<br/>           loc = “upper right”)</span><span id="44aa" class="nq md it nk b gy nw ns l nt nu">plt.title(“My electricity saving plan”)<br/>plt.ylabel(“kWh consumption”)<br/>plt.tight_layout()</span></pre><p id="bd75" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我得到了一个稍微好一点的结构图，如下所示:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nv"><img src="../Images/70e108fd62acc29f836802288f9a5f25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DnclQhTAfmpWhlEY-_WJaQ.jpeg"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">使用pandas和matplotlib创建的第二个瀑布图，具有结构化的颜色组合。图片作者。</p></figure><h1 id="c8ed" class="mc md it bd me mf mz mh mi mj na ml mm jz nb ka mo kc nc kd mq kf nd kg ms mt bi translated">Plotly瀑布图</h1><p id="377d" class="pw-post-body-paragraph ki kj it kk b kl mu ju kn ko mv jx kq kr mw kt ku kv mx kx ky kz my lb lc ld im bi translated">要使用Plotly绘制瀑布图，pandas数据帧结构需要有所不同，如下所示。在<strong class="kk iu"> kWh </strong>栏中显示了每项措施的用电量或逐步上升或下降。<strong class="kk iu">测量</strong>栏指示<strong class="kk iu">值</strong>是绝对值、总和还是相对值。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/ea23dda3fc9db7facef45e9213a70229.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W6I1xrOMZajPrfX7etv-rA.png"/></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">熊猫数据框用不同的方法表示电流。图片作者。</p></figure><p id="40ee" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Plotly有一个独特的<a class="ae lu" href="https://plotly.com/python/waterfall-charts/#horizontal-waterfall-chart" rel="noopener ugc nofollow" target="_blank">模块</a>，简单用于创建瀑布图，作为<a class="ae lu" href="https://plotly.com/python/financial-charts/" rel="noopener ugc nofollow" target="_blank">财务图</a>的一种形式。瀑布图作为跟踪添加到graph对象中。瀑布图是通过将<code class="fe nh ni nj nk b">df</code>的<strong class="kk iu">值</strong>列指定为<code class="fe nh ni nj nk b">x</code>、<strong class="kk iu">千瓦时</strong>列指定为<code class="fe nh ni nj nk b">y</code>、<strong class="kk iu">度量</strong>列中的值列表指定为<code class="fe nh ni nj nk b">measure</code>来构建的。<strong class="kk iu">千瓦时</strong>流量也作为文本添加，出现在瀑布图的列外。使用Plotly生成瀑布图的代码如下:</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="e73d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我得到了下面的瀑布图:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi oa"><img src="../Images/1c34987af6ee3cae2ca4917c300e65f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vBN3JhWmWH6bE1RVq9_NUQ.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">使用Plotly创建的瀑布图。图片作者。</p></figure><p id="289d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Plotly允许用不同的选项进一步定制瀑布图。我将x轴上的标签分为初始值、短期测量值、中间值、长期测量值和最终值。此外，我编辑了总计、增加和减少条的颜色和边缘颜色。这反映在《法典》的以下要旨中:</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="e96d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这将返回一个定制的瀑布图，如下所示:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ob"><img src="../Images/54dbac8f4ee351d9e3c0dc98e13bbd87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ak9wIIGkGdLV0nCcEDwMMA.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">用Plotly构建定制瀑布图。图片作者。</p></figure><h1 id="9566" class="mc md it bd me mf mz mh mi mj na ml mm jz nb ka mo kc nc kd mq kf nd kg ms mt bi translated">结论</h1><p id="bf64" class="pw-post-body-paragraph ki kj it kk b kl mu ju kn ko mv jx kq kr mw kt ku kv mx kx ky kz my lb lc ld im bi translated">当从初始阶段遍历到最终结果时，瀑布图对于展示基于<strong class="kk iu">时间的</strong>或基于<strong class="kk iu">类别的</strong>值的逐步递增或递减效果非常有用。根据其外观，瀑布图也被称为<strong class="kk iu">飞砖</strong> <strong class="kk iu">图</strong>或<strong class="kk iu">桥图</strong>。虽然瀑布图有不同的领域应用，但它们在金融领域特别受欢迎，以反映时间或产品的现金流贡献。</p><p id="9b23" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这篇文章中，我提供了一个构建瀑布图的例子，来看看在六个月的时间里，不同的节电措施对建筑的影响。本文中使用的值是虚拟值。我提供了一些使用Python中的Excel、Matplotlib和Plotly包构建瀑布图的技术。还可以使用各种其他工具或技术来构建瀑布图。根据我的经验，我更喜欢使用Plotly构建瀑布图。瀑布图可以通过定义<code class="fe nh ni nj nk b">x</code>、<code class="fe nh ni nj nk b">y</code>、<code class="fe nh ni nj nk b">measure</code>在Plotly中创建为一个对象。此外，<code class="fe nh ni nj nk b">connector</code>、<code class="fe nh ni nj nk b">text</code>、<code class="fe nh ni nj nk b">textposition</code>、<code class="fe nh ni nj nk b">orientation</code>、<code class="fe nh ni nj nk b">increasing</code>、<code class="fe nh ni nj nk b">decreasing</code>、<code class="fe nh ni nj nk b">totals</code>等参数允许根据需要和愿望定制瀑布图。</p><p id="a541" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这篇文章的数据和笔记本可以在这个<a class="ae lu" href="https://github.com/hbshrestha/Data_Analytics" rel="noopener ugc nofollow" target="_blank"> GitHub资源库</a>中找到。感谢您的阅读！</p></div></div>    
</body>
</html>