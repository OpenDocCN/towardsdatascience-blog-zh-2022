<html>
<head>
<title>A Complete SHAP Tutorial: How to Explain Any Black-box ML Model in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">完整的SHAP教程:如何用Python解释任何黑盒ML模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/a-complete-shap-tutorial-how-to-explain-any-black-box-ml-model-in-python-7538d11fae94#2022-10-11">https://towardsdatascience.com/a-complete-shap-tutorial-how-to-explain-any-black-box-ml-model-in-python-7538d11fae94#2022-10-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5866" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">向非技术人员解释任何黑盒模型</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/055074b3a3f62fc9a58cdad042e6d4b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2O663JaebKRvxfkj0nwvBg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">亚历山大·格雷摄影</p></figure><h1 id="4ade" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">动机</h1><p id="3253" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">今天，你不能只是走到你的老板面前说，“这是我最好的模型。投入生产吧，开心点！”。不，现在不是那样了。公司和企业对采用人工智能解决方案非常挑剔，因为它们具有“黑箱”性质。他们<strong class="lt iu">要求</strong>模型的可解释性。</p><p id="2e60" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果ML专家正在开发工具来理解和解释他们创造的<em class="ms">模型，那么非技术人员的担心和怀疑是完全有道理的。几年前引入的工具之一是SHAP。它可以分解任何机器学习模型和神经网络的机制，使它们可以被任何人理解。</em></p><p id="2b6f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">今天，我们将学习SHAP是如何工作的，以及如何在实践中使用它来完成经典的ML任务。</p><div class="mt mu gp gr mv mw"><a href="https://ibexorigin.medium.com/membership" rel="noopener follow" target="_blank"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd iu gy z fp nb fr fs nc fu fw is bi translated">通过我的推荐链接加入Medium-BEXGBoost</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">获得独家访问我的所有⚡premium⚡内容和所有媒体没有限制。支持我的工作，给我买一个…</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">ibexorigin.medium.com</p></div></div><div class="nf l"><div class="ng l nh ni nj nf nk ks mw"/></div></div></a></div></div><div class="ab cl nl nm hx nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="im in io ip iq"><p id="5228" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">获得由强大的AI-Alpha信号选择和总结的最佳和最新的ML和AI论文:</p><div class="mt mu gp gr mv mw"><a href="https://alphasignal.ai/?referrer=Bex" rel="noopener  ugc nofollow" target="_blank"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd iu gy z fp nb fr fs nc fu fw is bi translated">阿尔法信号|机器学习的极品。艾总结的。</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">留在循环中，不用花无数时间浏览下一个突破；我们的算法识别…</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">alphasignal.ai</p></div></div><div class="nf l"><div class="ns l nh ni nj nf nk ks mw"/></div></div></a></div></div><div class="ab cl nl nm hx nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="im in io ip iq"><h1 id="5078" class="kz la it bd lb lc nt le lf lg nu li lj jz nv ka ll kc nw kd ln kf nx kg lp lq bi translated">什么是SHAP和沙普利值？</h1><p id="926b" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">SHAP(SHapley Additive exPlanations)是一个Python包，基于2016年NIPS关于SHAP值的论文。本文的前提和Shapley值来源于博弈论的方法。</p><p id="b30b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">游戏中经常提出的一个问题是，在一群拥有不同技能的玩家中，我们如何分配奖金，以便每个人都能根据他们的技能得到公平的份额？根据玩家的数量，他们加入游戏的时间，以及他们对结果的不同贡献，这种类型的计算会变得非常复杂。</p><p id="094b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">但是博弈论和机器学习有什么关系呢？那么，我们可以重新定义上面的问题，这样它就变成“给定一个预测，我们如何最准确地测量每个特征的贡献？”是的，这就像询问模型的特性重要性，但是Shapley值给出的答案要复杂得多。</p><p id="4b56" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">具体来说，Shapley价值观可以帮助您:</p><ol class=""><li id="92f5" class="ny nz it lt b lu mn lx mo ma oa me ob mi oc mm od oe of og bi translated"><em class="ms">全局模型可解释性</em> —假设你为一家银行工作，为贷款申请建立一个分类模型。你的经理希望你解释什么(以及如何)不同的因素影响你的模型的决策。使用SHAP值，您可以给出一个具体的答案，详细说明哪些功能会导致更多的贷款，哪些功能会导致更多的拒绝。你让你的经理很高兴，因为现在，他可以为未来的银行客户起草基本准则，以增加他们获得贷款的机会。更多的贷款意味着更多的钱，更快乐的经理意味着你更高的薪水。</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl oh"><img src="../Images/a556703cb18740d421598390c0cad41d.png" data-original-src="https://miro.medium.com/v2/format:webp/1*tLpb2EdoT_-ONIA9o1U7-g.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><ol class=""><li id="fdb3" class="ny nz it lt b lu mn lx mo ma oa me ob mi oc mm od oe of og bi translated"><em class="ms">本地可解释性</em> —您的模型拒绝了几天前提交给银行的一份申请。客户声称他遵循了所有的指导方针，并且肯定能从您的银行获得贷款。现在，你有法律义务解释为什么你的模型拒绝了那个特定的候选人。使用Shapley值，可以独立分析每个案例，而不用担心它与数据中其他样本的联系。换句话说，你有本地可解释性。您提取投诉客户的Shapley值，并向他们展示应用程序的哪些部分导致了拒绝。你用这样的情节证明他们错了:</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl oh"><img src="../Images/2d2fc8244bbf47ffe695c66f328813e5.png" data-original-src="https://miro.medium.com/v2/format:webp/1*HTUJCmyAfYfv7iv6-soGGg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="2e18" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">那么，如何计算强大的Shapley值呢？这就是我们开始使用SHAP软件包的地方。</p></div><div class="ab cl nl nm hx nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="im in io ip iq"><h1 id="650d" class="kz la it bd lb lc nt le lf lg nu li lj jz nv ka ll kc nw kd ln kf nx kg lp lq bi translated">如何用SHAP计算沙普利值？</h1><p id="fd5f" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">计算Shapley值的精确数学细节值得单独写一篇文章。因此，现在，我将站在巨人的肩膀上，向你推荐他们的帖子。它们保证巩固你对这些概念的理解(<a class="ae ky" rel="noopener" target="_blank" href="/shap-explained-the-way-i-wish-someone-explained-it-to-me-ab81cc69ef30"> 1 </a>、<a class="ae ky" rel="noopener" target="_blank" href="/explain-your-model-with-the-shap-values-bc36aac4de3d">2</a>——作者<a class="oi oj ep" href="https://medium.com/u/84a02493194a?source=post_page-----7538d11fae94--------------------------------" rel="noopener" target="_blank">苦仁陈</a>)。</p><p id="e538" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">然而，在实践中，你很少会提到Shapley值背后的数学。原因是所有神奇的细节都很好地包装在SHAP内部。让我们看看第一个例子。</p><p id="6d73" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">使用Seaborn中内置的钻石数据集，我们将使用几种物理测量来预测钻石价格。我预先处理了数据集，并将其分为训练集和验证集。以下是训练集:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/c581b02d2ef9b6d737b4109ea9b6a897.png" data-original-src="https://miro.medium.com/v2/resize:fit:1344/format:webp/1*rooZonmNxn71WTKvT1YFEw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><pre class="kj kk kl km gt ol om on oo aw op bi"><span id="c276" class="oq la it om b gy or os l ot ou">&gt;&gt;&gt; X_train.shape, X_valid.shape</span><span id="aebc" class="oq la it om b gy ov os l ot ou">((45849, 9), (8091, 9))</span></pre><p id="c12d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">切割、颜色和清晰度是分类特征。它们按顺序编码，因为它们的顺序对上下文和最终的模型决策有意义。</p><p id="d24d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">作为基线，我们拟合了XGBRegressor模型，并使用均方根误差评估了性能:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="845a" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在，让我们最后看一眼幕后，并计算训练集的Shapley值。</p><p id="f2af" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们首先为我们的模型创建一个解释器对象:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="12bb" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><code class="fe oy oz pa om b">TreeExplainer</code>是SHAP的一个特殊类，优化后可用于Sklearn、XGBoost、LightGBM、CatBoost等中任何基于树的模型。您可以将<code class="fe oy oz pa om b">KernelExplainer</code>用于任何其他类型的模型，尽管它比树解释器慢。</p><p id="75c9" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这个树解释器有很多方法，其中一个是<code class="fe oy oz pa om b">shap_values</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="33e8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">正如我说过的，计算Shapley值是一个复杂的过程，这就是为什么在CPU上仅45k次观测就花费了大约22分钟。对于具有数百个要素和数百万个样本的大型现代数据集，计算可能需要数天时间。因此，我们转向GPU来计算SHAP值。</p><p id="74ab" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">到目前为止，GPU支持在SHAP还不稳定，但是我们有一个解决办法。核心XGBoost模型的<code class="fe oy oz pa om b">predict</code>方法有<code class="fe oy oz pa om b">pred_contribs</code>参数，当设置为True时，计算GPU上的SHAP值:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><blockquote class="pb pc pd"><p id="8c83" class="lr ls ms lt b lu mn ju lw lx mo jx lz pe mp mc md pf mq mg mh pg mr mk ml mm im bi translated">注意，LightGBM在其<code class="fe oy oz pa om b"><em class="it">predict</em></code>方法中也有对SHAP值的GPU支持。在CatBoost中，通过在<code class="fe oy oz pa om b"><em class="it">type</em></code>设置为<code class="fe oy oz pa om b"><em class="it">ShapValues</em></code>的模型上调用<code class="fe oy oz pa om b"><em class="it">get_feature_importances</em></code>方法来实现。</p></blockquote><p id="dff8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在提取XGBoost的核心助推器模型后，计算45k个样本的Shapley值只需要大约一秒钟:</p><pre class="kj kk kl km gt ol om on oo aw op bi"><span id="aed9" class="oq la it om b gy or os l ot ou">&gt;&gt;&gt; shap_values_xgb.shape</span><span id="f58d" class="oq la it om b gy ov os l ot ou">(45849, 10)</span></pre><p id="79a1" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">但是等等——来自树解释器的Shap值有九列；这个有10个！不用担心；我们现在可以放心地忽略最后一列，因为它只包含XGBoost默认添加的偏差项:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl oh"><img src="../Images/5681f0e6cc5c0abaaf3671983416dfc6.png" data-original-src="https://miro.medium.com/v2/format:webp/1*9nmBu14UlBHepiTnwiSuOA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="0759" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们得到了Shapley值。现在怎么办？现在，我们开始策划。</p></div><div class="ab cl nl nm hx nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="im in io ip iq"><h1 id="7479" class="kz la it bd lb lc nt le lf lg nu li lj jz nv ka ll kc nw kd ln kf nx kg lp lq bi translated">SHAP的全球特征重要性</h1><p id="f355" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">让我们看看在决定价格时，钻石的哪些物理尺寸最重要:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl oh"><img src="../Images/3afb1543ce5686cfc8b82d03d9c49f51.png" data-original-src="https://miro.medium.com/v2/format:webp/1*XItJSbS7nQUkitBTEn1d_Q.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="28d1" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">克拉是钻石价格的主要驱动因素。阅读下面的轴标题，我们看到重要性只是一个特征的平均绝对Shapley值。我们可以查看以下内容:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="4367" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">但是这与从XGBoost中得到的特性重要性图没有太大的不同:</p><pre class="kj kk kl km gt ol om on oo aw op bi"><span id="6eb3" class="oq la it om b gy or os l ot ou">&gt;&gt;&gt; xgb.plot_importance(booster_xgb);</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl oh"><img src="../Images/53ed74512582f517b9ee8a6bef853a36.png" data-original-src="https://miro.medium.com/v2/format:webp/1*JNwZgaZtHvaPA9Z5Q5UU6g.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="a39d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这就是我们错的地方。您不能相信XGBoost中的特性重要性，因为它们在不同的计算中是不一致的。观察要素重要性如何随计算类型而变化:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl oh"><img src="../Images/eddc6cfe1479bfecbc6719af8db58e74.png" data-original-src="https://miro.medium.com/v2/format:webp/1*qK3u-U6bQOVIN0P0cc-uhQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="a2db" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">相比之下，从Shapley值获得的特征重要性是一致的和可信的。</p><p id="79dc" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们不会就此止步。在上面的图中，我们只看了重要性的绝对值。我们不知道哪个特性会对模型产生积极或消极的影响。让我们以SHAP为例:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl oh"><img src="../Images/fd49cf34774d5a647609f39c0ba4a950.png" data-original-src="https://miro.medium.com/v2/format:webp/1*tyXF5VnOwIDQwMhE1Y4j_w.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="f7d7" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">下面是如何解读上述情节:</p><ol class=""><li id="cacf" class="ny nz it lt b lu mn lx mo ma oa me ob mi oc mm od oe of og bi translated">左侧纵轴表示功能名称，根据重要性从上到下排序。</li><li id="e2a6" class="ny nz it lt b lu ph lx pi ma pj me pk mi pl mm od oe of og bi translated">横轴表示预测的SHAP值的大小。</li><li id="8f62" class="ny nz it lt b lu ph lx pi ma pj me pk mi pl mm od oe of og bi translated">垂直右轴表示要素在数据集中出现时的实际大小，并对点进行着色。</li></ol><p id="16bc" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们看到，随着克拉的增加，它对模型的影响越来越积极。对于<code class="fe oy oz pa om b">y</code>特性也是如此。<code class="fe oy oz pa om b">x</code>和<code class="fe oy oz pa om b">z</code>的特征有点复杂，中心周围有一簇混合的点。</p><div class="mt mu gp gr mv mw"><a href="https://ibexorigin.medium.com/membership" rel="noopener follow" target="_blank"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd iu gy z fp nb fr fs nc fu fw is bi translated">通过我的推荐链接加入Medium-bex boost</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">获得独家访问我的所有⚡premium⚡内容和所有媒体没有限制。你可以给我买一个coffee☕，用你的…</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">ibexorigin.medium.com</p></div></div><div class="nf l"><div class="pm l nh ni nj nf nk ks mw"/></div></div></a></div></div><div class="ab cl nl nm hx nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="im in io ip iq"><h1 id="f6bf" class="kz la it bd lb lc nt le lf lg nu li lj jz nv ka ll kc nw kd ln kf nx kg lp lq bi translated">用依赖图探索每个特性</h1><p id="ed64" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">通过依赖图，我们可以更深入地了解每个特性对整个数据集的影响。我们来看一个例子，稍后再解释:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl oh"><img src="../Images/8706aeecb40cb4a35f56b75dfa829050.png" data-original-src="https://miro.medium.com/v2/format:webp/1*_7IFx3oHMDvb1Xd_IBLbSA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="9e6e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">该图与我们之前在摘要图中看到的一致。随着克拉的增加，其SHAP值增加。通过将<code class="fe oy oz pa om b">interaction_index</code>参数更改为<code class="fe oy oz pa om b">auto</code>，我们可以用与克拉交互作用最强的特征为点着色:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl oh"><img src="../Images/e6547bd20874c0207a926ad872d0bf55.png" data-original-src="https://miro.medium.com/v2/format:webp/1*tXX4Wjs5IRZ_a7HE8iMFKw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="ef99" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">似乎克拉与钻石净度的相互作用比其他特征更强。</p><p id="0ada" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在，让我们为分类特征创建一个相关性图:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl oh"><img src="../Images/431a66896783d3b0257c0eb337a834a5.png" data-original-src="https://miro.medium.com/v2/format:webp/1*WM1AFwjTcIUCIGInDvWSYg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="624d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这一情节也与摘要情节密切相关。最新的颜色类别在与carat互动时会对价格产生负面影响。</p><p id="4d94" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我将让您探索以下其他特性的依赖关系图:</p><div class="kj kk kl km gt ab cb"><figure class="pn kn po pp pq pr ps paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/d84a557c55bc21810919c3542cfe2cdb.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*D5bClhlRvUfPTT-D41jBEw.png"/></div></figure><figure class="pn kn po pp pq pr ps paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/654c58433d78a443a38f1e38fa3e8959.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*2z6GYbYhCAZujHw3_0GFcQ.png"/></div></figure><figure class="pn kn po pp pq pr ps paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/bfe51c3928a12bbfcb6f8568aa17e0d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*rjecV-75_5YftqCKeyNEZA.png"/></div></figure></div><div class="ab cb"><figure class="pn kn po pp pq pr ps paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/e53ce434898f032a75be7faba4c690ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*pM59RXcHnHY5x-OOgYfgSw.png"/></div></figure><figure class="pn kn po pp pq pr ps paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/850a27725253a7b7e5ab2f2b37e83e34.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*5F59k8ujenHhYqWLCGhGjg.png"/></div></figure><figure class="pn kn po pp pq pr ps paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/5ab2ae445134c833924102e46648b02d.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*EMZLpKV1pPaXcNP5W--acg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk pt di pu pv translated">作者提供的图片</p></figure></div></div><div class="ab cl nl nm hx nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="im in io ip iq"><h1 id="e9d2" class="kz la it bd lb lc nt le lf lg nu li lj jz nv ka ll kc nw kd ln kf nx kg lp lq bi translated">具有Shapley值的特征交互</h1><p id="b4b2" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">SHAP值和沙普利值最奇妙的属性之一是它们能够准确地找到特征之间的关系。在上一节中，当SHAP在依赖图中发现最强健的交互特征时，我们已经尝到了这种滋味。</p><p id="8685" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们可以更进一步，找到按交互强度排序的所有特征交互。为此，我们需要一套不同的价值观——SHAP互动价值观。</p><p id="79a2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">可以使用树解释器对象的<code class="fe oy oz pa om b">shap_interaction_values</code>来计算它们，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="bb21" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">但是这比常规的SHAP值更耗时。因此，我们将使用XGBoost再次转向GPU:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="4517" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">通过设置<code class="fe oy oz pa om b">pred_interactions</code>为真，我们只需要15秒就可以得到SHAP交互值。这是一个3D数组，最后一列轴是偏差项:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="c605" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在我们有了互动。我们该怎么办？坦率地说，即使SHAP的文档也没有为交互勾勒出一个合理的用例，但是我们从其他人那里得到了帮助。具体来说，我们将使用我从<a class="ae ky" href="https://www.kaggle.com/tunguz" rel="noopener ugc nofollow" target="_blank"> 4x Kaggle特级大师Bojan Tunguz </a>那里学到的一个函数，在我们的数据集中找到最重要的特征交互，并绘制它们:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="0ee4" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在，<code class="fe oy oz pa om b">top_10_inter_feats</code>包含所有可能的特征对之间的10个最强的相互作用:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="804e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们可以创建另一个函数，根据它们的相互作用强度绘制这些对:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl oh"><img src="../Images/f3396fa7f808ea9e7e1a68a7c5d3739f.png" data-original-src="https://miro.medium.com/v2/format:webp/1*ajbq3cHxNnQno_vxMGQNmg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="d9fc" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">正如我们所见，<code class="fe oy oz pa om b">y</code>和<code class="fe oy oz pa om b">carat</code>之间的相互作用比其他人强得多。即使这个图对我们来说没有任何意义，领域专家也有可能破译这种关系，并使用它来更好地诊断模型。</p><p id="83d6" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">例如，如果您的模型试图对分子对不同化学刺激的反应进行分类，这样的图会很有帮助，因为它可能会显示分子的哪些化学属性与刺激相互作用。这将告诉运行实验的领域专家很多东西，因为他们知道什么类型的化学物质相互作用，以及该模型是否可以捕捉它们的行为。</p></div><div class="ab cl nl nm hx nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="im in io ip iq"><h1 id="6f7a" class="kz la it bd lb lc nt le lf lg nu li lj jz nv ka ll kc nw kd ln kf nx kg lp lq bi translated">局部可解释性</h1><p id="d0c5" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">最后，我们到达局部可解释性部分。它是关于解释为什么模型对一个样本做出了一个特定的决定。</p><p id="1033" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">让我们随机选择一颗钻石及其预测价格来解释:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="60a0" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">好的，看起来我们将会看到训练数据中的第6559个菱形。让我们开始:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="c882" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们首先使用explainer对象重新计算SHAP值。这不同于<code class="fe oy oz pa om b">shap_values</code>函数，因为这一次，Shapley值返回了我们局部可解释性所需的更多属性:</p><pre class="kj kk kl km gt ol om on oo aw op bi"><span id="b283" class="oq la it om b gy or os l ot ou">&gt;&gt;&gt; type(shap_explainer_values)</span><span id="8611" class="oq la it om b gy ov os l ot ou">shap._explanation.Explanation</span></pre><p id="d8c8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在，让我们解释一下我们用瀑布图挑选的随机钻石:</p><pre class="kj kk kl km gt ol om on oo aw op bi"><span id="f7c1" class="oq la it om b gy or os l ot ou">&gt;&gt;&gt; shap.waterfall_plot(shap_explainer_values[6559])</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl oh"><img src="../Images/2d2fc8244bbf47ffe695c66f328813e5.png" data-original-src="https://miro.medium.com/v2/format:webp/1*HTUJCmyAfYfv7iv6-soGGg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="0520" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><code class="fe oy oz pa om b">E[f(x)] = 3287.856</code>是列车组钻石价格的平均预测，例如<code class="fe oy oz pa om b">preds.mean()</code>。<code class="fe oy oz pa om b">f(x) = 3214.05</code>是钻石的预测价格。</p><p id="09b2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">中间的细线表示平均预测值。纵轴显示第6559颗钻石的特征值。条形表示每个要素属性如何使价格偏离平均预测值。红色条代表积极的转变；蓝条代表负向移动。</p><p id="7d2b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">为了完整起见，让我们看另一个钻石:</p><pre class="kj kk kl km gt ol om on oo aw op bi"><span id="c7c8" class="oq la it om b gy or os l ot ou">&gt;&gt;&gt; shap.waterfall_plot(shap_explainer_values[4652])</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl oh"><img src="../Images/e3c7a7ed082b411b7915300c1dd403a5.png" data-original-src="https://miro.medium.com/v2/format:webp/1*rtjY9CWIe99m7S9vBDNI6g.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="bd46" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这颗钻石比上一颗便宜很多，主要是因为它的克拉低很多，从上面可以看出来。</p><p id="988b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">还有一个情节可以解释局部的可解释性。SHAP称之为武力阴谋，它看起来是这样的:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pw"><img src="../Images/9ac5c7cfcb8818561d64d6e0f96c6ea3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qHd-NnuvxvIz9Yi_RQockA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="7b25" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这只是一个有序的，有组织的瀑布图。所有正负棒线都被分组到预测价格的两侧。同样，基值显示的是平均价格，条形显示的是每个要素属性移动该值的程度。</p><pre class="kj kk kl km gt ol om on oo aw op bi"><span id="9104" class="oq la it om b gy or os l ot ou">&gt;&gt;&gt; shap.force_plot(shap_explainer_values[6559])</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi px"><img src="../Images/2a5b0a554afe2ceb7c9fdba26b18ede0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CbRCDltZqbY35gbn-7QweQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure></div><div class="ab cl nl nm hx nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="im in io ip iq"><h1 id="70af" class="kz la it bd lb lc nt le lf lg nu li lj jz nv ka ll kc nw kd ln kf nx kg lp lq bi translated">摘要</h1><p id="3dc6" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">现在，你可以走到你的老板面前说:“这是我最好的模型，这是为什么它是最好的以及它是如何工作的解释！”希望你得到的回应会积极得多。感谢您的阅读！</p><div class="mt mu gp gr mv mw"><a href="https://ibexorigin.medium.com/membership" rel="noopener follow" target="_blank"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd iu gy z fp nb fr fs nc fu fw is bi translated">通过我的推荐链接加入Medium-bex boost</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">获得独家访问我的所有⚡premium⚡内容和所有媒体没有限制。你可以给我买一个coffee☕，用你的…</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">ibexorigin.medium.com</p></div></div><div class="nf l"><div class="pm l nh ni nj nf nk ks mw"/></div></div></a></div><div class="mt mu gp gr mv mw"><a href="https://ibexorigin.medium.com/subscribe" rel="noopener follow" target="_blank"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd iu gy z fp nb fr fs nc fu fw is bi translated">每当BEXBoost发布时收到电子邮件。</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">每当BEXBoost发布时收到电子邮件。通过注册，您将创建一个中型帐户，如果您还没有…</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">ibexorigin.medium.com</p></div></div><div class="nf l"><div class="py l nh ni nj nf nk ks mw"/></div></div></a></div><h1 id="69b6" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">您可能也会对…感兴趣</h1><div class="mt mu gp gr mv mw"><a rel="noopener follow" target="_blank" href="/3-step-feature-selection-guide-in-sklearn-to-superchage-your-models-e994aa50c6d2"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd iu gy z fp nb fr fs nc fu fw is bi translated">Sklearn中的3步功能选择指南，让您的模型焕然一新</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">为任何受监督的问题开发一个健壮的特征选择工作流</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">towardsdatascience.com</p></div></div><div class="nf l"><div class="pz l nh ni nj nf nk ks mw"/></div></div></a></div><div class="mt mu gp gr mv mw"><a rel="noopener follow" target="_blank" href="/how-to-use-umap-for-much-faster-and-effective-outlier-detection-e4608f336915"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd iu gy z fp nb fr fs nc fu fw is bi translated">如何使用UMAP进行更快更有效的异常检测</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">让我们抓住那些高维离群值</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">towardsdatascience.com</p></div></div><div class="nf l"><div class="qa l nh ni nj nf nk ks mw"/></div></div></a></div><div class="mt mu gp gr mv mw"><a rel="noopener follow" target="_blank" href="/comprehensive-guide-to-deploying-any-ml-model-as-apis-with-python-and-aws-lambda-b441d257f1ec"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd iu gy z fp nb fr fs nc fu fw is bi translated">使用Python和AWS Lambda将任何ML模型部署为API的综合指南</h2><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">towardsdatascience.com</p></div></div><div class="nf l"><div class="qb l nh ni nj nf nk ks mw"/></div></div></a></div><div class="mt mu gp gr mv mw"><a rel="noopener follow" target="_blank" href="/25-advanced-pandas-functions-people-are-using-without-telling-you-b65fa442f0f4"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd iu gy z fp nb fr fs nc fu fw is bi translated">人们在不告诉你的情况下使用的25种先进的熊猫功能</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">ExcelWriter，因式分解，分解，挤压，T，遮罩，idxmax，剪辑，…</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">towardsdatascience.com</p></div></div><div class="nf l"><div class="qc l nh ni nj nf nk ks mw"/></div></div></a></div></div></div>    
</body>
</html>