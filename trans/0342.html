<html>
<head>
<title>How to use Azure SQL Access Token Authentication from Azure DevOps Pipelines</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何从Azure DevOps管道使用Azure SQL访问令牌身份验证</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-use-azure-sql-access-token-authentication-from-azure-devops-pipelines-344fa7dafa49#2022-02-14">https://towardsdatascience.com/how-to-use-azure-sql-access-token-authentication-from-azure-devops-pipelines-344fa7dafa49#2022-02-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="c230" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用Python和Azure PowerShell</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/afc768540178e1cca6321308fabe8fcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K1c28P98EY1Ar2wdKh_AZw.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">戴维·霍伊泽在<a class="ae kv" href="https://unsplash.com/s/photos/rotterdam?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="32ef" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您需要从DevOps部署管道访问Azure SQL数据库，以便在数据库上执行一些自定义脚本。如果你需要使用用户名和密码认证之外的东西，并希望利用Azure Active Directory，使用访问令牌可能是你的解决方案。</p><p id="b40d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这篇文章中，我将提供一个如何使用Azure Active Directory访问令牌向Azure SQL进行身份验证的示例。Azure DevOps服务连接用于获取访问令牌。要做到这一点，一个先决条件是拥有一个作为用户添加到数据库的服务连接。建立服务连接的推荐方式是使用Azure Active Directory服务主体，也称为应用程序注册。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="1cad" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">！！从安全角度来看，不建议使用带有用户名和密码</strong>的SQL认证。在Azure SQL的当前版本中，甚至可以完全关闭SQL身份验证，而只使用Active Directory身份验证。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="1b5b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">先决条件</strong></p><ol class=""><li id="f14b" class="lz ma iq ky b kz la lc ld lf mb lj mc ln md lr me mf mg mh bi translated">带有服务连接的Azure DevOps项目</li><li id="aa09" class="lz ma iq ky b kz mi lc mj lf mk lj ml ln mm lr me mf mg mh bi translated">一个SQL数据库，其中一个数据库用户代表服务连接</li></ol><p id="a620" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">使用Azure PowerShell获取访问令牌</strong></p><p id="930f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在下面的示例中，我们使用Azure管道的Azure PowerShell任务来利用服务连接凭据获取访问令牌。使用SQLServer PowerShell模块，我们可以使用“Invoke-Sqlcmd”来执行查询。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="fa82" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">通过Python使用访问令牌</strong></p><p id="268c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在下一个示例中，我们安装pyodbc模块，并针对我们的数据库执行一个定制的python脚本。确保编写一些逻辑来将参数传递和捕捉到python脚本中。我添加了一个示例python函数，并设置了连接字符串。我花了很长时间才让它工作起来。问题出在连接字符串上，在<a class="ae kv" href="https://docs.microsoft.com/en-us/sql/connect/odbc/using-azure-active-directory?view=azuresqldb-current#authenticating-with-an-access-token" rel="noopener ugc nofollow" target="_blank">文档</a>中有提到，但是我却漏掉了这句话:“<em class="mp">连接字符串不能包含</em> <code class="fe mq mr ms mt b"><em class="mp">UID</em></code> <em class="mp">、</em> <code class="fe mq mr ms mt b"><em class="mp">PWD</em></code> <em class="mp">、</em> <code class="fe mq mr ms mt b"><em class="mp">Authentication</em></code> <em class="mp">，或者</em> <code class="fe mq mr ms mt b"><em class="mp">Trusted_Connection</em></code> <em class="mp">关键字</em>”</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mn mo l"/></div></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="98d2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了能够使用访问令牌，需要一个函数来“扩展”访问令牌。更多信息参见<a class="ae kv" href="https://docs.microsoft.com/en-us/python/api/adal/adal.authentication_context.AuthenticationContext?view=azure-python#methods" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><p id="9d82" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，您可以根据用户被添加到的数据库角色对数据库进行各种操作了！删除表时一定要小心:)</p><p id="80e4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">参考文献</strong>:</p><p id="b1d0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://docs.microsoft.com/en-us/sql/connect/odbc/using-azure-active-directory?view=azuresqldb-current#authenticating-with-an-access-token" rel="noopener ugc nofollow" target="_blank">微软文档——Azure SQL使用访问令牌进行认证</a></p><p id="be3e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://docs.microsoft.com/en-us/sql/connect/odbc/using-azure-active-directory?view=azuresqldb-current" rel="noopener ugc nofollow" target="_blank">微软文档—使用Azure活动目录的Azure SQL</a></p><p id="17d5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://docs.microsoft.com/en-us/azure/azure-sql/database/authentication-aad-configure?tabs=azure-powershell" rel="noopener ugc nofollow" target="_blank">微软文档—使用Azure SQL配置和管理Azure AD身份验证</a></p><p id="22b9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="http://us/python/api/adal/adal.authentication_context.AuthenticationContext?view=azure-python#methods" rel="noopener ugc nofollow" target="_blank">微软文档—使用Python进行认证</a></p></div></div>    
</body>
</html>