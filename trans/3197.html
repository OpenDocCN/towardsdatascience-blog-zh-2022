<html>
<head>
<title>Continuous Deployment of ML Models to the Edge</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将ML模型持续部署到边缘</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/continuous-deployment-of-ml-models-to-the-edge-909a01d6352#2022-07-13">https://towardsdatascience.com/continuous-deployment-of-ml-models-to-the-edge-909a01d6352#2022-07-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="f7f4" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">真实的例子:工地安全监控</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/4c29325bb77a73d51fe92a2f392dcf78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*g9Nv2jKO5uDF9VpY.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="43a3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">与在云中远程运行推理相比，在靠近数据生成位置的边缘设备中运行机器学习(ML)推理具有几个重要优势。这些优势包括实时处理、更低的成本、无需连接即可工作的能力以及更高的隐私性。然而，今天，在分布式边缘设备中实现用于边缘推断和模型连续部署的端到端ML系统可能很麻烦，并且比集中式环境困难得多。</p><p id="2183" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">与任何现实生活中的生产ML系统一样，最终目标是一个重复迭代和部署模型的连续循环。</p><p id="5c64" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这篇博客文章描述并展示了一个真实的例子，说明我们如何使用<a class="ae lr" href="https://valohai.com/" rel="noopener ugc nofollow" target="_blank"> Valohai MLOps平台</a>、<a class="ae lr" href="https://jfrog.com/artifactory/" rel="noopener ugc nofollow" target="_blank"> JFrog Artifactory </a>仓库管理器和<a class="ae lr" href="https://jfrog.com/connect-overview/" rel="noopener ugc nofollow" target="_blank"> JFrog Connect </a>物联网边缘设备管理平台创建一个完整的ML系统，并不断改进自己。</p><h1 id="08dd" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">真实用例:建筑工地安全应用</h1><p id="3688" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">对于我们的用例示例，我们选择了一个突出边缘推理优势的实际应用:工地安全监控。</p><p id="e425" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">大多数法规要求建筑工地上的每个人都使用必要的安全设备，如安全帽。这对工地管理者来说很重要，因为不遵守安全规定可能会导致更多的伤害、更高的保险费率，甚至是处罚和罚款。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mp"><img src="../Images/2089e200785006af2e74c97b0027f681.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fWoEt62TlDyGX9CB.jpg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="4aec" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了监控这些网站，我们基于运行对象检测ML模型的Raspberry Pi 4设备设置了智能摄像机，该模型可以识别被捕获的人是否戴着安全帽。</p><p id="96f6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在这样的用例中，边缘推理的好处是显而易见的。建筑工地经常有不可靠的连接，检测必须接近实时。在现场的智能摄像机上运行该模型，而不是在云中运行，确保正常运行时间，最大限度地减少连接问题或要求，同时解决可能的隐私和合规性问题。</p><p id="b48e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">下面描述了我们如何实现该解决方案的细节。</p><h1 id="e4ad" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">解决方案概述:持续ML培训渠道</h1><p id="8aa8" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">我们针对边缘设备的持续培训管道设置包括两个主要部分:</p><ol class=""><li id="be00" class="mq mr iq kx b ky kz lb lc le ms li mt lm mu lq mv mw mx my bi translated">负责培训和再培训模型的Valohai MLOps平台，以及</li><li id="b238" class="mq mr iq kx b ky mz lb na le nb li nc lm nd lq mv mw mx my bi translated">JFrog Artifactory和JFrog Connect负责将模型部署到建筑工地的智能摄像机上。</li></ol><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ne"><img src="../Images/fbde033f667463e4be0b5252bdee9088.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-V04hHhqGbnuuGxp.jpg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">培训和部署渠道(图片由作者提供)</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/0a54a35a1b18d495b108b73342afa2ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9P3a-d8OcuZr3SBrpZeb_w.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">解决方案组件(图片由作者提供)</p></figure><h1 id="c54b" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">培训和部署模型</h1><p id="0a23" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">在Valohai MLOps平台中，我们定义了一个典型的深度培训管道，分为三个步骤:</p><p id="d8cb" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">预处理和训练步骤是你从深度学习机器视觉管道中所期望的。我们主要是在预处理中调整图像大小，训练步骤使用强大的GPU云实例重新训练一个YOLOv5s模型。</p><p id="ee5b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">代码片段:valohai.yaml </strong></p><p id="da68" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">更有趣的步骤是部署步骤，我们将Valohai平台与<a class="ae lr" href="https://jfrog.com/" rel="noopener ugc nofollow" target="_blank"> JFrog DevOps平台</a>集成在一起。<a class="ae lr" href="https://docs.valohai.com/topic-guides/core-concepts/configuration-file/" rel="noopener ugc nofollow" target="_blank"> valohai.yaml </a>是一个配置文件，它定义了各个步骤以及连接这些步骤的管道。下面是我们在YAML定义的示例<code class="fe ng nh ni nj b">deployment-jfrog</code>步骤。</p><pre class="kg kh ki kj gt nk nj nl nm aw nn bi"><span id="63fa" class="no lt iq nj b gy np nq l nr ns">- step:<br/>    name: deployment-jfrog<br/>    image: python:3.9<br/>    command:<br/>    - cp /valohai/inputs/model/weights.pt /valohai/repository/w.pt  <br/>    - zip -r /tmp/model.zip /valohai/repository/model<br/>    - curl &gt;<br/>       -H "X-JFrog-Art-Api:$JFROG_API_KEY" &gt;<br/>       -T /tmp/model.zip "$JFROG_REPOSITORY/model.zip"<br/>    - python jfrog-connect.py &gt;<br/>       --flow_id=f-c4e4-0733 &gt;<br/>       --app_name=default_app &gt;<br/>       --project=valohaitest &gt;<br/>       --group=Production<br/>    inputs:<br/>    - name: model<br/>      default: datum://017f799a-dc58-ea83-bd7f-c977798f3b26<br/>      optional: <strong class="nj ir">false</strong><br/>    environment-variables:<br/>    - name: JFROG_REPOSITORY<br/>      optional: <strong class="nj ir">true</strong><br/>    - name: JFROG_API_KEY<br/>      optional: <strong class="nj ir">true</strong></span></pre><p id="f359" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们看看部署步骤是如何工作的。</p><p id="a87d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">首先，部署步骤构建一个包含模型+权重的zip存档，然后将其上传到JFrog Artifactory。Valohai将前一训练步骤的权重作为输入文件提供给该步骤，并将所需的<code class="fe ng nh ni nj b">JFROG_API_KEY</code>和<code class="fe ng nh ni nj b">JFROG_REPOSITORY</code>秘密作为环境变量提供给该步骤。</p><p id="d824" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">下一步是启动一个更新流程，通过调用<a class="ae lr" href="https://docs.connect.jfrog.io/rest-api/overview" rel="noopener ugc nofollow" target="_blank"> JFrog Connect API </a>在智能摄像机群中发布新模型。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/bd6cfd7e784fae837826d54c1cc0f621.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1i2NlPxPQ60hrk7E.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">瓦罗海的训练管道(图片由作者提供)</p></figure><p id="97b4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们已经建立了一个Valohai管道，该管道将模型上传到JFrog Artifactory，并在<a class="ae lr" href="https://jfrog.com/connect-overview/" rel="noopener ugc nofollow" target="_blank"> JFrog Connect </a>服务中触发模型的部署，该服务在整个智能相机车队中交付新模型。</p><p id="b650" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">模型部署过程被表示为一个JFrog Connect更新流。更新流是需要在边缘设备中发生的一系列动作。使用<a class="ae lr" href="https://jfrog.com/connect-overview/" rel="noopener ugc nofollow" target="_blank"> JFrog Connect </a>的拖放接口，我们创建了一个更新流程，其中包括更新智能摄像机中的模型所需的步骤。这些步骤是:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/b668128c8991c347c711c87813e3b7a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3AOsW4V0W5lvOvIB.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">用Jfrog创建更新流(图片由作者提供)</p></figure><ol class=""><li id="48fb" class="mq mr iq kx b ky kz lb lc le ms li mt lm mu lq mv mw mx my bi translated">从JFrog Artifactory下载模型，</li><li id="123f" class="mq mr iq kx b ky mz lb na le nb li nc lm nd lq mv mw mx my bi translated">运行脚本来安装模型，以及</li><li id="dd3f" class="mq mr iq kx b ky mz lb na le nb li nc lm nd lq mv mw mx my bi translated">重启设备。</li></ol><p id="71ac" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果其中一个步骤失败，<a class="ae lr" href="https://jfrog.com/connect-overview/" rel="noopener ugc nofollow" target="_blank"> JFrog Connect </a>会将设备回滚到之前的状态，因此设备总是以已知状态结束。进一步了解<a class="ae lr" href="https://jfrog.com/connect/embedded-linux-ota-software-updates/" rel="noopener ugc nofollow" target="_blank"> JFrog连接更新流程</a>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/f3a97801b8675008ca6abf2a8ebe315c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*r3AzrZ5WdAcuyFVq.jpg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Ddata收集管道(图片由作者提供)</p></figure><h1 id="fcd3" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">持续培训</h1><p id="7a34" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">一旦模型部署到整个边缘设备群，我们的工作就没有完成。摄像机全天候收集潜在的训练数据，并遇到有趣的边缘情况。</p><p id="9602" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在这个阶段，我们需要创建一个管道，每周从智能相机群中收集标记的图像，并将它们上传到S3桶中进行手动重新标记，并最终用于重新训练模型。</p><p id="f423" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">计划管道的工作方式:</p><ol class=""><li id="5115" class="mq mr iq kx b ky kz lb lc le ms li mt lm mu lq mv mw mx my bi translated">使用对S3存储桶具有只写访问权限的AWS STS创建临时凭据</li><li id="f07a" class="mq mr iq kx b ky mz lb na le nb li nc lm nd lq mv mw mx my bi translated">使用内置的临时密钥升级JFrog Artifactory中的上传脚本</li><li id="95c7" class="mq mr iq kx b ky mz lb na le nb li nc lm nd lq mv mw mx my bi translated">触发JFrog连接更新流以在设备群中运行上传脚本</li><li id="3bd0" class="mq mr iq kx b ky mz lb na le nb li nc lm nd lq mv mw mx my bi translated">每个设备上传一批新的图像到S3桶</li></ol><p id="cf6b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">设备群上传的新训练数据由人类使用Sama或Labelbox等平台手动标记，一旦数据被标记，这些平台使用我们的上传S3桶作为其源，另一个S3桶作为目标。</p><p id="a8e3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">注意:庞大的车队会产生太多数据，无法进行手动标记，设备本身可能会很快耗尽空间。幸运的是，像YOLOv5这样的机器视觉模型通常有一个置信度和预测标签。我们使用置信度阈值过滤设备上存储的训练数据，该阈值优先考虑边缘情况。</p><h1 id="a3c0" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结论</h1><p id="2343" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">总之，我们展示了如何创建一个连续的循环，在生产中跨一系列边缘设备重复迭代和部署ML模型。Valohai MLOps平台与<a class="ae lr" href="https://jfrog.com/" rel="noopener ugc nofollow" target="_blank"> JFrog DevOps平台</a>的Artifactory和Connect相结合，使我们能够实现这一目标，并创建一个不断自我改进的ML系统。</p></div><div class="ab cl nw nx hu ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="ij ik il im in"><p id="4114" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="od">原载于2022年7月13日</em><a class="ae lr" href="https://jfrog.com/blog/continuous-training-and-deployment-for-machine-learning-ml-at-the-edge/" rel="noopener ugc nofollow" target="_blank"><em class="od">【https://jfrog.com】</em></a><em class="od">。</em></p></div></div>    
</body>
</html>