<html>
<head>
<title>How to develop a CD pipeline for Airflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何开发气流CD管道</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-develop-a-cd-pipeline-for-airflow-9a99047907ee#2022-08-10">https://towardsdatascience.com/how-to-develop-a-cd-pipeline-for-airflow-9a99047907ee#2022-08-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="ee49" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">利用GitHub actions和天文学家将代码更新快速推送到生产环境中</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/28fa70f26e49ec044dbcdccc6c36b7f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qRt_K17aDbiJHRCP"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@mbenna?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">迈克·本纳</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="d990" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Apache Airflow是一个流行的数据编排工具，用于管理工作流和任务。然而，我不断遇到的一个大问题是如何部署生产就绪的气流实例。托管气流的选项包括虚拟机上的自我管理、部署到基于云的平台天文学家、利用AWS MWAA等等。</p><p id="109a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这些选项中，我发现天文学家在易用性和每月成本方面是最有价值的，尽管在本文中我不会深入到特定平台的比较中。</p><p id="0017" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">天文学家是软件/基础设施即服务平台，使数据团队能够更专注于他们的工作流和管道，而不是基础设施和扩展。在本文中，我打算演示如何在不到10分钟的时间内，从本地气流环境中自动完成到天文学家的连续部署(CD)管道。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h2 id="46c3" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">要求</h2><ol class=""><li id="a986" class="ms mt iq ky b kz mu lc mv lf mw lj mx ln my lr mz na nb nc bi translated"><a class="ae kv" href="https://github.com/astronomer/astro-cli" rel="noopener ugc nofollow" target="_blank">天文气候</a> ( <a class="ae kv" href="https://docs.astronomer.io/astro" rel="noopener ugc nofollow" target="_blank">文件</a>)</li><li id="4594" class="ms mt iq ky b kz nd lc ne lf nf lj ng ln nh lr mz na nb nc bi translated"><a class="ae kv" href="https://www.astronomer.io/get-started/" rel="noopener ugc nofollow" target="_blank">天文学家账户</a></li><li id="7937" class="ms mt iq ky b kz nd lc ne lf nf lj ng ln nh lr mz na nb nc bi translated">码头工人</li><li id="9a14" class="ms mt iq ky b kz nd lc ne lf nf lj ng ln nh lr mz na nb nc bi translated">通过astro运行的局部气流</li><li id="84de" class="ms mt iq ky b kz nd lc ne lf nf lj ng ln nh lr mz na nb nc bi translated">本地气流实例的GitHub帐户和存储库</li><li id="1375" class="ms mt iq ky b kz nd lc ne lf nf lj ng ln nh lr mz na nb nc bi translated">GitHub操作</li></ol><p id="38f4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">第一步是用astro CLI初始化本地气流实例。用<code class="fe ni nj nk nl b">astro dev init</code>初始化你的气流项目。然后，用<code class="fe ni nj nk nl b">astro dev start</code>测试您的本地环境。</p><p id="669d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在您的项目目录(<code class="fe ni nj nk nl b">git init</code>)中初始化一个新的Git存储库，并推送到GitHub。</p><h2 id="c2c5" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">天文学家</h2><p id="4eeb" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">在您的天文学家帐户中，确保当前部署处于活动状态。在活动部署中创建新的服务帐户。服务帐户将是您的Github repo和您部署的Airflow实例之间的纽带。<em class="np">确保在创建服务帐户时复制API密钥，这是您唯一的机会。</em></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nq"><img src="../Images/992bbc618ddcdd4b7b26851834445c67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nbxLMUYEQPUBzRiewg8SeA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">天文学家仪表板和服务帐户作者的照片</p></figure><p id="ec7a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用astro CLI，通过<code class="fe ni nj nk nl b">astro login</code>或<code class="fe ni nj nk nl b">astro auth login</code>登录您的天文学家账户。这将提示您输入电子邮件和密码，或者oauth凭证。然后运行<code class="fe ni nj nk nl b">astro cluster list</code>来获得你的基本域名(后面会提到)。比如<code class="fe ni nj nk nl b">gcp0001.us-east4.astronomer.io</code>。</p><p id="699f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要验证服务帐户的创建，请在终端中运行以下命令:</p><pre class="kg kh ki kj gt nr nl ns bn nt nu bi"><span id="244a" class="nv ma iq nl b be nw nx l ny nz">export BASE_DOMAIN=gcp0001.us-east4.astronomer.io<br/>export API_SECRET_KEY=&lt;your_secret_key_for_service_account&gt;<br/>docker login registry.{BASE_DOMAIN} -u _ -p ${API_SECRET_KEY}</span></pre><p id="b0a8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您能够通过这些命令进行身份验证，那么一切都将步入正轨。</p><h2 id="ac2e" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">开源代码库</h2><p id="28ad" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">创建一个新的GitHub secret来保存天文学家服务帐户API密钥。创建一个名为<code class="fe ni nj nk nl b">ASTRONOMER_SERVICE_ACCOUNT_KEY</code>的新存储库秘密，并粘贴API键值。天文学家的GitHub actions工作流在将代码推向生产时会引用这个秘密。</p><p id="c2b9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，在存储库中创建新的工作流操作。通过GitHub动作选择<code class="fe ni nj nk nl b">Docker image</code>。此工作流构建Docker映像以部署或推送至存储库。使用这个预配置的<code class="fe ni nj nk nl b">main.yml</code>文件(如下)来构建您的dockerized airflow实例。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="3100" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">确保添加<code class="fe ni nj nk nl b">{ your_release_name }</code>而不是<code class="fe ni nj nk nl b">primitive-asteroid-5670</code>。这可以在你的天文学家部署设置中找到。</p><p id="a30c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">还要注意，在第13行，您需要用Dockerfile位置的目录建立<code class="fe ni nj nk nl b">workdir</code>。当工作流在GitHub actions上运行时，它会将您的存储库编译到一个虚拟环境中，并且需要引用Dockerfile。在我的repo中，Dockerfile位于airflow子目录中。</p><h2 id="0747" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">测试</h2><p id="1934" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">我们现在准备测试！在GitHub上打开一个PR，将变更合并到<code class="fe ni nj nk nl b">dev</code>或<code class="fe ni nj nk nl b">main</code>中。将代码合并到所需的分支中，工作流就开始了。完成后，您可以查看您的天文学家仪表板，将会看到当前标签的格式:<code class="fe ni nj nk nl b">cd-commit hash</code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/0b2b3809f6bab68b624429edabb05cc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U-MIsyPaoMIY0ueJJtyVTg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者照片。天文学家中的部署标签示例。</p></figure></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="e735" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，您的气流存储库已启用持续交付/部署管道！如需更多信息/调试帮助，请查看这些<a class="ae kv" href="https://docs.astronomer.io/software/ci-cd" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><p id="11ed" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">概括地说，在本文中，我们通过GitHub actions将在天文学家上部署本地天文/气流环境的任务自动化，并开始为CI/CD管道奠定基础。</p><p id="a825" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">CI/CD使团队能够采用更“敏捷”的开发框架。我最喜欢的CI/CD渠道目标包括:</p><ol class=""><li id="d763" class="ms mt iq ky b kz la lc ld lf od lj oe ln of lr mz na nb nc bi translated">效率—减少建立开发环境所花费的时间</li><li id="3882" class="ms mt iq ky b kz nd lc ne lf nf lj ng ln nh lr mz na nb nc bi translated">自动发布—避免堵塞和人为错误</li><li id="abfe" class="ms mt iq ky b kz nd lc ne lf nf lj ng ln nh lr mz na nb nc bi translated">快速部署代码—消除瓶颈，让代码更快投入生产</li><li id="3ab9" class="ms mt iq ky b kz nd lc ne lf nf lj ng ln nh lr mz na nb nc bi translated">拥抱迭代——通过频繁的变更而不是单一的提交和发布来缩短反馈周期</li></ol><p id="a747" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">查看这篇<a class="ae kv" href="https://www.devbridge.com/white-papers/cicd-pipeline-continuous-delivery-deployment/benefits/" rel="noopener ugc nofollow" target="_blank">帖子</a>，了解更多与敏捷和CI/CD相关的目标。</p><p id="f435" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们实现了一个简单的CD管道(只有一个生产环境)，但我们也可以利用在天文学家上的多个部署来快速扩展并包括开发和QA环境。这将为您的气流环境提供更强大的开发和发布流程。</p></div></div>    
</body>
</html>