<html>
<head>
<title>Retrieval Transformer Enhanced Reinforcement Learning</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">检索变压器增强强化学习</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/retrieval-transformer-enhanced-reinforcement-learning-24509e97c4c6#2022-11-19">https://towardsdatascience.com/retrieval-transformer-enhanced-reinforcement-learning-24509e97c4c6#2022-11-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e6d9" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">将检索变形金刚与我们的游戏 AI Chappie 相结合</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/8abb688ad21149d705499b8a2b196adf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pHBr4oHZJB-a4FEA-bzLOw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">检索章节图|按作者分类的图片</p></figure><p id="6705" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">大家好，如果你一直关注我以前的博客帖子，你就会知道我最近的<a class="ae lr" href="https://en.wikipedia.org/wiki/Reinforcement_learning" rel="noopener ugc nofollow" target="_blank">强化学习</a> (RL)代理(<a class="ae lr" href="https://medium.com/@bellerb/playing-chess-with-offline-reinforcement-learning-411edc5efd5f" rel="noopener">用离线强化学习下棋</a>，<a class="ae lr" rel="noopener" target="_blank" href="/playing-chess-with-a-generalized-ai-b83d64ac71fe">用广义 AI 下棋</a>)中一直在利用<a class="ae lr" href="https://arxiv.org/abs/1706.03762" rel="noopener ugc nofollow" target="_blank">变形金刚</a>。最近，一种被称为检索变压器的新型变压器因其高效而越来越受欢迎。此外，像<a class="ae lr" href="https://openai.com/" rel="noopener ugc nofollow" target="_blank"> OpenAI </a>的<a class="ae lr" href="https://arxiv.org/abs/2112.09332" rel="noopener ugc nofollow" target="_blank"> WebGPT </a>和<a class="ae lr" href="https://deepmind.com/" rel="noopener ugc nofollow" target="_blank"> DeepMind </a>的<a class="ae lr" href="https://arxiv.org/abs/2112.04426" rel="noopener ugc nofollow" target="_blank"> RETRO Transformer </a>这样的模型已经证明，这些较小的模型可以与大型模型如<a class="ae lr" href="https://arxiv.org/abs/2005.14165" rel="noopener ugc nofollow" target="_blank"> GPT-3 </a>相媲美。由于这些有希望的结果，我们将跟上最近的趋势，并尝试将这种类型的模型整合到我们的 RL 代理中，这似乎是合乎逻辑的。</p><h1 id="d841" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">检索变压器</h1><p id="7747" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">在我们的 RL 代理中加入检索转换器之前，让我们先看看什么是检索转换器，以及为什么它如此有效。下面是从 DeepMind 的一篇博客文章中引用的一段话，其中他们描述了复古变形金刚所用方法背后的推理。</p><blockquote class="mp mq mr"><p id="011b" class="kv kw ms kx b ky kz jr la lb lc ju ld mt lf lg lh mu lj lk ll mv ln lo lp lq ij bi translated">“受大脑在学习时如何依赖专用记忆机制的启发，RETRO 有效地查询文本段落以改善其预测。”[10]</p></blockquote><p id="afcc" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这句话暗示了我们的大脑在根据过去的经验做决定时是如何利用记忆作为框架的。例如，当你把某物抛向空中时，你期望它落地，因为你的大脑记得这个规则；</p><blockquote class="mp mq mr"><p id="20dc" class="kv kw ms kx b ky kz jr la lb lc ju ld mt lf lg lh mu lj lk ll mv ln lo lp lq ij bi translated">“上升的必然下降。”艾萨克·牛顿[12]</p></blockquote><p id="25f6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">DeepMind 通过利用外部数据库中存储的彼此非常相似的示例，重新创建了这种内存框架思想。为了确定与输入数据最相似的数据，逆向变换器确定 l-1 个输入数据块嵌入的 k-最近邻(KNN)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/48017e9adad38465cba2bdd13023325a.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/1*-dc5doiT8QNXmRa4DwvDfw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">k 近邻方程|作者图片</p></figure><p id="c320" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">邻居和输入数据使用单独的自关注编码器块进行编码，并通过分块的交叉关注解码器块进行组合，从而为其提供类似于标准变换器的编码器-解码器架构。</p><p id="dbf6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">分块交叉注意是交叉注意的一种形式，其中我们将查询(Q)、键(K)和值(V)分成更小的块，然后对这些块中的每一个执行交叉注意。在组块交叉注意中，我们不在每个输入组块和它的相邻组块之间执行交叉注意。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/15ac3dbe18fd571486cbf60d2f40179f.png" data-original-src="https://miro.medium.com/v2/resize:fit:874/format:webp/1*x-P-AU1OlVK7yFO_QkWnuA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">不正确的分块交叉注意层匹配图|作者图片</p></figure><p id="b0ac" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">相反，我们将输入数据移动 m-1，并创建 l-1 个新的输入块。这些新创建的输入块包含来自前面的原始输入块的最后一个标记和它的原始输入块的后面的 m-1 个标记。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi my"><img src="../Images/0d10b52578f9d1f5701537333c0a5a8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:834/format:webp/1*PW1kX80dwX6mjbZZq4_QGQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">分块交叉注意力层匹配图|作者图片</p></figure><p id="cd06" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然后，我们将最初丢弃的 m-1 个标记添加到交叉注意输出中。通过预先考虑 m-1 个标记，我们保留了更多来自原始输入数据的信息，这一点至关重要，因为我们希望模型的预测受输入数据的影响大于 KNN。</p><p id="6421" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后，我们在最后一个块中的剩余标记和最后一个邻居之间执行交叉关注。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/e7d9b6a82699232ea5661b1a8f31d9a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:882/format:webp/1*K4R-WrXNBLqag7aAd-sNGw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">分块交叉注意力图|图片来自<a class="ae lr" href="https://arxiv.org/pdf/2112.04426.pdf" rel="noopener ugc nofollow" target="_blank">https://arxiv.org/pdf/2112.04426.pdf</a></p></figure><p id="8ea2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">分块交叉注意的结果通过前馈层传递。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi na"><img src="../Images/5dfea47ea6971cc9b178d3705e8061e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/format:webp/1*xnc1dy25dKtryFDGTpjpyg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">复古图|图片由 https://arxiv.org/pdf/2112.04426.pdf<a class="ae lr" href="https://arxiv.org/pdf/2112.04426.pdf" rel="noopener ugc nofollow" target="_blank">制作</a></p></figure><h1 id="3e12" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">建造我们的回收变压器</h1><p id="4a45" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">现在我们更好地理解了检索转换器，我们可以在我们的模型中有效地利用它的组件。</p><p id="b819" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">首先，我们将建立组块交叉注意模型。由于我们已经在<a class="ae lr" rel="noopener" target="_blank" href="/playing-chess-with-a-generalized-ai-b83d64ac71fe">之前的博客文章</a>中创建了一个注意力模型，我们可以在这里重复使用。这里我们需要做的主要事情是创建一个分块机制来传递我们的邻居并输入到我们的注意力模型中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="9871" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在我们已经建立了组块交叉注意模型，我们将创建我们的 KNN 函数。这个函数从潜在的相当大的样本空间中确定邻居，使得循环非常耗时(O(n))。为了优化这个函数，我们将对它进行矢量化，以消除遍历每个数据点的需要。首先，我们将把我们的数据框架转换成一个张量，这将允许使用矩阵计算。矩阵计算显示，与熊猫应用函数相比，性能有所提升。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/328b8c03b9c44603fe21355cf5269d87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1188/format:webp/1*6LlSHmWZ_k-QzWJGK-WIaA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">k 近邻函数比较|作者图片</p></figure><p id="1a9d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">下面是我们的 KNN 函数的矩阵计算版本的代码。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="9f6d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">新创建的 KNN 函数和分块的交叉注意层让这个模型看起来有所不同。下面是我们新模型架构的示意图。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ne"><img src="../Images/1e1f9f2573e22fcf07e91bbfa04508e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GHNGkbWpwPPt7bKxUB8tsw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">新模型架构图|作者图片</p></figure><p id="19af" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">看上面的图表，你会注意到我们在主干层之后添加了新的分块交叉注意层。这种放置是有意的，因为我们的 KNN 函数在单个矩阵上执行查找。将我们的分块交叉注意层放在主干层之后的另一个好处是主干层编码中表示的数据量。这些编码在我们的模型中是数据最丰富的，允许找到的邻居为最终层提供更好的框架。</p><p id="bac7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后一步，我们需要为外部嵌入数据库构建管道。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/14590e6bd9fc0357b9212500dd858cc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1228/format:webp/1*6GvNjsjCcW2AcGDd74GZbA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">嵌入式数据库管道图|作者图片</p></figure><p id="bfa6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">管道是离线运行的，因为我们只需要在模型主干更新时重新计算嵌入。下面是这条管道的代码。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nb nc l"/></div></figure><h2 id="a36d" class="ng lt iq bd lu nh ni dn ly nj nk dp mc le nl nm me li nn no mg lm np nq mi nr bi translated">谢谢</h2><p id="6d4a" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">现在你知道了，我们已经成功地升级了我们的国际象棋人工智能，以利用检索变压器的组件。你可以在我的 GitHub 上查看完整版本的代码。</p><p id="ad4f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">感谢阅读。如果你喜欢这样，可以考虑订阅我的账户，以便在我最近发帖时得到通知。</p><h1 id="31d3" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">参考</h1><ul class=""><li id="f266" class="ns nt iq kx b ky mk lb ml le nu li nv lm nw lq nx ny nz oa bi translated">【https://arxiv.org/abs/1706.03762】T2[1]</li><li id="0f8c" class="ns nt iq kx b ky ob lb oc le od li oe lm of lq nx ny nz oa bi translated">【https://en.wikipedia.org/wiki/Reinforcement_learning】T4【2】</li><li id="4bc1" class="ns nt iq kx b ky ob lb oc le od li oe lm of lq nx ny nz oa bi translated"><a class="ae lr" rel="noopener" target="_blank" href="/playing-chess-with-a-generalized-ai-b83d64ac71fe">https://towards data science . com/playing-chess-with-a-generalized-ai-b 83d 64 AC 71 Fe</a>[3]</li><li id="416c" class="ns nt iq kx b ky ob lb oc le od li oe lm of lq nx ny nz oa bi translated"><a class="ae lr" rel="noopener" target="_blank" href="/building-a-chess-engine-part2-db4784e843d5">https://towards data science . com/building-a-chess-engine-part 2-db 4784 e 843d 5</a>【4】</li><li id="fc60" class="ns nt iq kx b ky ob lb oc le od li oe lm of lq nx ny nz oa bi translated"><a class="ae lr" href="https://openai.com/" rel="noopener ugc nofollow" target="_blank">https://openai.com/</a>【5】</li><li id="7e3e" class="ns nt iq kx b ky ob lb oc le od li oe lm of lq nx ny nz oa bi translated"><a class="ae lr" href="https://arxiv.org/abs/2112.09332" rel="noopener ugc nofollow" target="_blank">https://arxiv.org/abs/2112.09332</a>【6】</li><li id="20ef" class="ns nt iq kx b ky ob lb oc le od li oe lm of lq nx ny nz oa bi translated"><a class="ae lr" href="https://deepmind.com/" rel="noopener ugc nofollow" target="_blank">https://deepmind.com/</a>【7】</li><li id="6b4d" class="ns nt iq kx b ky ob lb oc le od li oe lm of lq nx ny nz oa bi translated"><a class="ae lr" href="https://arxiv.org/abs/2112.04426" rel="noopener ugc nofollow" target="_blank">https://arxiv.org/abs/2112.04426</a>【8】</li><li id="a2d4" class="ns nt iq kx b ky ob lb oc le od li oe lm of lq nx ny nz oa bi translated"><a class="ae lr" href="https://arxiv.org/abs/2005.14165" rel="noopener ugc nofollow" target="_blank">https://arxiv.org/abs/2005.14165</a>【9】</li><li id="bf1f" class="ns nt iq kx b ky ob lb oc le od li oe lm of lq nx ny nz oa bi translated">https://deep mind . com/blog/article/language-modeling-in-scale</li><li id="3e2c" class="ns nt iq kx b ky ob lb oc le od li oe lm of lq nx ny nz oa bi translated"><a class="ae lr" href="https://bokcenter.harvard.edu/how-memory-works" rel="noopener ugc nofollow" target="_blank">https://bokcenter.harvard.edu/how-memory-works</a>【11】</li><li id="3f03" class="ns nt iq kx b ky ob lb oc le od li oe lm of lq nx ny nz oa bi translated"><a class="ae lr" href="https://www.goodreads.com/quotes/433926-what-goes-up-must-come-down" rel="noopener ugc nofollow" target="_blank">https://www . goodreads . com/quotes/433926-what-go-up-must-down</a></li><li id="3c68" class="ns nt iq kx b ky ob lb oc le od li oe lm of lq nx ny nz oa bi translated"><a class="ae lr" href="https://www.frieze.com/article/perception-vision#:~:text=In%20fact%2C%20it%20is%20now,brain%3B%20it%20comes%20from%20it.&amp;text=In%20many%20ways%2C%20this%20makes%20sense." rel="noopener ugc nofollow" target="_blank">https://www . frieze . com/article/perception-vision #:~:text = In % 20 fact % 2C % 20it % 20is % 20 now，brain % 3B % 20it % 20 comes % 20 from % 20it。text = In % 20 many % 20 ways % 2C % 20 this % 20 makes % 20 sense。</a>【13】</li></ul></div></div>    
</body>
</html>