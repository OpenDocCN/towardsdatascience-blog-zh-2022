<html>
<head>
<title>Probabilistic CUSUM for change point detection</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于变化点检测的概率累积和</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/probabilistic-cusum-for-change-point-detection-121f793ab3a1#2022-08-04">https://towardsdatascience.com/probabilistic-cusum-for-change-point-detection-121f793ab3a1#2022-08-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="42db" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">CUSUM可以说是物联网或金融应用中最简单的变点检测算法。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/7d76637cdb5102f98e6cbcd433216ea2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9GzS_dW6HcDfzpW3cDpQOw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">克里斯·劳顿在<a class="ae ky" href="https://unsplash.com/s/photos/changes?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="6a7a" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">介绍</h1><p id="132b" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">根据著名的<a class="ae ky" href="https://en.wikipedia.org/wiki/Occam%27s_razor" rel="noopener ugc nofollow" target="_blank">奥卡姆剃刀</a>原理，较简单的模型比复杂的模型更可能接近真理。对于变化点检测问题，如在物联网或金融应用中，可以说最简单的是<strong class="lt iu">Cu</strong>mulative<strong class="lt iu">Sum</strong>(Cu Sum)算法。</p><p id="afd6" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">尽管它很简单，但它仍然是一个强大的工具。事实上，CUSUM只需要对潜在的时间序列做一些松散的假设。如果这些假设得到满足，就有可能证明大量有用的统计特性。</p></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="a4bc" class="kz la it bd lb lc mz le lf lg na li lj jz nb ka ll kc nc kd ln kf nd kg lp lq bi translated">快速浏览CUSUM</h1><p id="b024" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">总之，CUSUM检测在两个变点之间静止的时间序列的平均值的变化。考虑以下时间序列:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ne"><img src="../Images/10327ef7f5162f5420698b5abc42af45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tlf7mJ1w1psqjYx3iG585A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nf">具有变化点(绿色直线)的分段平稳时间序列(蓝色)示例</em>。CUSUM可以处理这样的数据。(图片由作者提供)</p></figure><p id="40ff" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这个例子在每对变化点之间是固定的，因此是我们的CUSUM算法的完美用例。对于像下一个这样的非平稳时间序列的变点检测，CUSUM可能无法按预期工作:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/a63550da752d397639bdca3f50df574f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xl5XKKVTkhQzEu29QIFUuA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">两个变化点之间具有非平稳性的时间序列示例。CUSUM无法正常处理这样的数据。(图片由作者提供)</p></figure><p id="f91d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">虽然CUSUM可能仍然能够检测到从稳定段到非稳定段的偏移，但不能保证它能可靠地做到这一点。</p><p id="0ac9" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">总的来说，CUSUM背后的思想可以大致概括如下:</p><p id="15f2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu">如果时间序列具有恒定的零均值，其实现的累积和收敛于零均值正态分布(给定一些相对宽松的技术假设)。因此，如果累积和偏离零均值正态分布，潜在的时间序列可能会出现转折点。</strong></p><p id="cb8b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们可以从众多<a class="ae ky" href="https://en.wikipedia.org/wiki/Central_limit_theorem" rel="noopener ugc nofollow" target="_blank">中心极限定理</a> (CLTs)中的一个推导出这一点。虽然每个CLT都有一些额外的要求(例如，<a class="ae ky" href="https://en.wikipedia.org/wiki/Central_limit_theorem#:~:text=set.%5B5%5D-,Lyapunov,-CLT%5Bedit" rel="noopener ugc nofollow" target="_blank">李亚普诺夫CLT </a>的独立抽签和有限方差)，但您的特定时间序列很可能满足其中一个要求。</p><p id="e601" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在实践中，我们将估计当前状态的平均值，将其从时间序列中减去，并计算累积和。这就只剩下一个问题，那就是当一个改变点发生时，该如何设置规则。</p><p id="5b65" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">wikipedia 中的标准CUSUM算法建议对时间序列的z标准化实现求和。每当该总和超过预定义的阈值时，就会出现变化点。因此，整个过程是一个“在线”算法，即我们可以在实时数据流上使用它。</p></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="65ff" class="kz la it bd lb lc mz le lf lg na li lj jz nb ka ll kc nc kd ln kf nd kg lp lq bi translated">标准累积和算法的一些问题</h1><p id="29e6" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">您可能已经问过自己应该如何在CUSUM中设置变化点阈值。毕竟门槛设置太松会导致改点未被发现。另一方面，狭窄的阈值容易导致频繁的错误警报。</p><p id="4a08" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">遗憾的是，要找到解决这个问题的明确说明并不容易。虽然经验法则或对某些设置进行试验偶尔会奏效，但这显然不是一个可靠的解决方案。此外，当我们想要对大量数据流应用CUSUM时，这是不可行的。</p><p id="3726" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">另一个问题是给定子序列的异常程度。即使没有变化点发生，发现时间序列何时出现意外行为仍然是有意义的。</p><p id="27c8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">幸运的是，我们可以通过稍微修改原始的CUSUM算法来应对这两个挑战。</p></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="47e9" class="kz la it bd lb lc mz le lf lg na li lj jz nb ka ll kc nc kd ln kf nd kg lp lq bi translated">累积和的概率版本</h1><p id="9c5f" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在这一点上，我们将最终需要一些方程。首先，我们定义时间序列的任意子序列的标准化观测值:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/2786bb1ecd54586fc17f2905fefccef6.png" data-original-src="https://miro.medium.com/v2/resize:fit:296/format:webp/0*DTgWf-fxRCOhqEyc.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)</p></figure><p id="8597" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">帽子符号强调，我们只能使用序列的均值和标准差的估计值。我们可以计算这些值，例如，通过使用我们估计的第一个<code class="fe ni nj nk nl b">N</code>实现。</p><p id="cb08" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果我们假设某些CLT的条件适用于我们的序列，则下列条件在极限情况下大致成立:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/6c7c4043978bd4ded44fef6b5e773a37.png" data-original-src="https://miro.medium.com/v2/resize:fit:548/format:webp/0*ERLt6VmNfQcERkNO.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)</p></figure><p id="2b94" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">通过将累计总和除以时间范围的平方根，我们得到一个(<strong class="lt iu">理论</strong>)标准正态分布。因此，只要我们的CLT假设有效，以下适用于已实现时间序列的标准化累积和:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/8a7db31ad966eacec85007e18ba4c5d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1246/format:webp/0*LzzzGcfyFJOwtSBH.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)</p></figure><p id="f1af" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">得到的值可以解释为理论累积和与我们观察到的值一样小的概率。这实际上相当于经典假设检验中对一个<a class="ae ky" href="https://en.wikipedia.org/wiki/P-value" rel="noopener ugc nofollow" target="_blank"> <strong class="lt iu"> p值</strong>的定义。</a></p><p id="ebd7" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">但是请注意，上述数量目前仅在一个方向上起作用，即如果标准化总和为负。为了使这成为一个双边统计，我们可以要求标准化和的概率至少和我们的实现值一样远离均值。由于我们的和是一个标量值，我们可以简单地将从零开始的'<em class="no">距离</em>'定义为绝对值，并简化为:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi np"><img src="../Images/87e29fadbee554cbdc530ce2c5e4821d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1156/format:webp/0*F19qy4Regdwi-rN5.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)</p></figure><p id="a929" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们现在可以使用这个概率代替原始的标准化累积和来检测变化点。与最初的总和相反，这一措施有一个明确的，概率性的解释。对于每一个新的数据点，我们可以直接获得相应观察值的极端程度。</p><p id="6d55" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">一旦超过“不太可能”的某个阈值，我们将相应的时间戳标记为变化点，并重新开始算法。</p><p id="d0f9" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">大致而言，算法如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/7ac50c7bd88039a87131ebd713c26ae1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1052/format:webp/0*BgQCKmRolU8ExM40.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)</p></figure><p id="0fa9" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在Python中，可能的实现如下所示。我使用PyTorch来考虑未来可能的扩展，包括自动签名功能:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="2975" class="kz la it bd lb lc mz le lf lg na li lj jz nb ka ll kc nc kd ln kf nd kg lp lq bi translated">实践中的概率累积和</h1><p id="5f5d" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">让我们用两个例子来试试上面的算法。首先，我们使用简介中的模拟恒定均值数据集:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/6638604123a45e0af9ac278bb342093a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wumjoWb2mIxfe3hh8BCkFQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nf">模拟数据的概率累积和——红色阴影标记了上述定义的极端概率。(图片由作者提供)</em></p></figure><p id="6b94" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们修改后的CUSUM版本能够检测所有的变化点，尽管在检测上有一些延迟。然而，所有的变化点都落在我们的概率度量已经检测到异常行为的区域。因此，通过一些微调，甚至可以更早地发现关键的变化点。</p><p id="d17f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">对于我们的第二个例子，让我们使用来自Kaggle 的<a class="ae ky" href="https://www.kaggle.com/datasets/yuriykatser/skoltech-anomaly-benchmark-skab?resource=download" rel="noopener ugc nofollow" target="_blank"> Skoltech异常基准数据集的摘录。我选择时间序列时考虑了CUSUM背后的假设(特别是常数均值假设)。因此，结果不应作为可靠的基准，而应作为说明性的例子:</a></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/e0dbca67eb0e4a777e21e81eb6029861.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YK8O4c6k9isZvWqJpQTG9Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nf">现实世界数据集上的概率累积和。(图片由作者提供)</em></p></figure><p id="bb6c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">虽然我们的CUSUM变量在线性趋势模式上有一些问题，但总体结果看起来是合理的。这也证明了这种算法的局限性，一旦常数均值假设被违反。然而，尽管简单，CUSUM似乎是一个有用的选择。</p></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="ac2b" class="kz la it bd lb lc mz le lf lg na li lj jz nb ka ll kc nc kd ln kf nd kg lp lq bi translated">结论</h1><p id="acc0" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">虽然CUSUM是一个非常简单的算法，但只要满足底层假设，它就可以非常强大。通过一个简单的概率修改，我们可以很容易地改进标准版本的CUSUM，使其更具表现力和直观性。</p><p id="b1c4" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">然而对于更复杂的问题，更复杂的算法可能是必要的。一个特别有用的算法是<a class="ae ky" href="https://gregorygundersen.com/blog/2019/08/13/bocd/" rel="noopener ugc nofollow" target="_blank">贝叶斯在线变点检测</a>,我希望能在未来涵盖它。</p></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><p id="847d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><em class="no">原载于2022年8月4日</em><a class="ae ky" href="https://www.sarem-seitz.com/probabilistic-cusum-for-change-point-detection/" rel="noopener ugc nofollow" target="_blank"><em class="no">【https://www.sarem-seitz.com】</em></a><em class="no">。</em></p></div></div>    
</body>
</html>