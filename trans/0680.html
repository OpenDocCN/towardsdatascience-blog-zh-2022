<html>
<head>
<title>Explore and Visualize Geospatial Data using Leafmap Python Package</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Leafmap Python包浏览和可视化地理空间数据</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/explore-and-visualize-geospatial-data-using-leafmap-python-package-5bb8aafba83a#2022-02-28">https://towardsdatascience.com/explore-and-visualize-geospatial-data-using-leafmap-python-package-5bb8aafba83a#2022-02-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9380" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">只需几行Python代码即可创建交互式地图</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a216a88e19c0fbe95846874c8f0b9197.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OQpnY7oquz8SY9ip"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@thebeardbe?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">菲利普·邦肯斯</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="b21f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">直到最近，用Python创建交互式地理空间数据可视化还不是一件容易的事情。一个挑战是将大型面图层加载到地图的速度。另一个挑战是用户使用地图前端和后端之间的双向通信直接与地图交互。</p><p id="af18" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Python <strong class="lb iu"> <em class="lv"> leafmap </em> </strong>包是一个相对较新的包，它面向动态显示地理空间数据，最重要的是，它提供了方便的功能，使用户能够从地图中提取数据或将数据加载到地图中。</p><p id="b4c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最近，<em class="lv"> Google Colab </em>开始支持<em class="lv"> ipyleaflet，</em>使得在<em class="lv"> Google Colab </em>中使用<strong class="lb iu"> <em class="lv"> leafmap </em> </strong>包成为可能。这真的很令人兴奋，因为现在交互式地图可以很容易地与那些没有在计算机上安装Jupyter笔记本或JupyterLab的人共享。</p><p id="5342" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> <em class="lv">叶图</em> </strong>提供了这么多很棒的功能，其中之一就是<strong class="lb iu">绘图工具。</strong>我们将展示绘图工具不仅可用于在地图上绘制形状并将绘制的特征保存到文件中(例如<code class="fe lw lx ly lz b">GeoJSON</code>、<code class="fe lw lx ly lz b">Shapefile</code>和<code class="fe lw lx ly lz b">GeoPackage</code>)，还可用作查询工具。</p><p id="37a7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本帖中，我们将演示如何使用<strong class="lb iu"> <em class="lv"> leafmap </em> </strong>包创建交互式地图，以及如何使用<strong class="lb iu">绘图工具</strong>通过直接从交互式地图中选择位置(如起点和终点)来方便地<strong class="lb iu">查询地理空间数据</strong>。</p><ol class=""><li id="11f8" class="ma mb it lb b lc ld lf lg li mc lm md lq me lu mf mg mh mi bi translated">介绍leafmap Python包</li></ol><p id="9e95" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">2.使用leafmap包创建交互式地图</p><p id="f2d4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">3.使用绘图工具从地图中查询地理空间数据</p><p id="28f3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">4.基于查询结果创建choropleth图和地块</p><p id="981a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">注:这篇文章的代码和数据可以在</em><a class="ae ky" href="https://github.com/shi093/Leafmap-FAF" rel="noopener ugc nofollow" target="_blank"><em class="lv">this GitHub repo</em></a><em class="lv">找到。</em></p><h1 id="1254" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">1.介绍leafmap Python包</h1><blockquote class="nb nc nd"><p id="8d77" class="kz la lv lb b lc ld ju le lf lg jx lh ne lj lk ll nf ln lo lp ng lr ls lt lu im bi translated"><strong class="lb iu"> Leafmap </strong>是一个开源的Python包，用于在Jupyter环境中使用最少的代码进行交互式制图和地理空间分析。它建立在其他几个开源包的基础上，如<a class="ae ky" href="https://github.com/python-visualization/folium" rel="noopener ugc nofollow" target="_blank">flour</a>和<a class="ae ky" href="https://github.com/jupyter-widgets/ipyleaflet" rel="noopener ugc nofollow" target="_blank"> ipyleaflet </a>(用于创建交互式地图)<a class="ae ky" href="https://github.com/jblindsay/whitebox-tools" rel="noopener ugc nofollow" target="_blank"> WhiteboxTools </a>和<a class="ae ky" href="https://github.com/giswqs/whiteboxgui" rel="noopener ugc nofollow" target="_blank"> whiteboxgui </a>(用于分析地理空间数据)，以及<a class="ae ky" href="https://github.com/jupyter-widgets/ipywidgets" rel="noopener ugc nofollow" target="_blank"> ipywidgets </a>(用于设计交互式图形用户界面【gui】)。</p><p id="f52d" class="kz la lv lb b lc ld ju le lf lg jx lh ne lj lk ll nf ln lo lp ng lr ls lt lu im bi translated"><strong class="lb iu"> Leafmap </strong>是一个非常强大的地理空间数据科学工具，具有许多用于加载、分析和可视化地理空间数据集的方便功能，这使得它特别适合编程技能有限的新手用户。(<a class="ae ky" href="https://leafmap.org/" rel="noopener ugc nofollow" target="_blank">参考</a>)。</p></blockquote><h1 id="e515" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">2.使用leafmap包创建交互式地图</h1><h2 id="bad6" class="nh mk it bd ml ni nj dn mp nk nl dp mt li nm nn mv lm no np mx lq nq nr mz ns bi translated">安装和加载软件包</h2><p id="43cd" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">在我们开始之前，我们需要确保<strong class="lb iu"> <em class="lv">叶图</em> </strong>和<strong class="lb iu"> <em class="lv">地理盘和</em> </strong>包安装正确。leafmap包有一些可选的依赖项，在某些计算机上安装这些依赖项会很困难。"在安装过程中遵循这些说明。</p><p id="9df7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要在Google Colab中运行这段代码，以下命令(<a class="ae ky" href="https://github.com/shakasom/GDS" rel="noopener ugc nofollow" target="_blank"> REF </a>)应该可以在Google Colab中安装<strong class="lb iu"> <em class="lv"> Leafmap </em> </strong>和<strong class="lb iu"> <em class="lv"> Geopandas </em> </strong>包。如果我们简单地使用<code class="fe lw lx ly lz b">!pip install geopandas</code>命令在Google Colab中安装<strong class="lb iu"> <em class="lv"> Geopandas </em> </strong>包，那么<code class="fe lw lx ly lz b">Geopandas</code> <code class="fe lw lx ly lz b">GeoDataFrame</code>的空间连接功能可能无法正常工作。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://github.com/shakasom/GDS" rel="noopener ugc nofollow" target="_blank">参考</a></p></figure><p id="84b3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们导入本演示所需的库:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="1de9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lw lx ly lz b">geopandas</code>是<code class="fe lw lx ly lz b">pandas</code>的扩展，支持使用地理空间数据，特别是使用<em class="lv">矢量层</em>。<code class="fe lw lx ly lz b">geopandas</code>是建立在其他几个Python库之上的，比如<code class="fe lw lx ly lz b">numpy</code>、<code class="fe lw lx ly lz b">pandas</code>和<code class="fe lw lx ly lz b">shapely</code> ( <a class="ae ky" href="https://geobgu.xyz/py/geopandas1.html" rel="noopener ugc nofollow" target="_blank"> REF </a>)。</p><p id="8ddb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lw lx ly lz b">shapely</code>是<a class="ae ky" href="https://trac.osgeo.org/geos" rel="noopener ugc nofollow" target="_blank">几何引擎开源(GEOS) </a>软件(如QGIS)和许多编程语言的Python接口。<code class="fe lw lx ly lz b">shapely</code>仅处理单个几何图形(<a class="ae ky" href="https://geobgu.xyz/py/shapely.html" rel="noopener ugc nofollow" target="_blank">参考</a>)。在本演示中，它用于根据坐标创建几何图形。</p><h2 id="bf70" class="nh mk it bd ml ni nj dn mp nk nl dp mt li nm nn mv lm no np mx lq nq nr mz ns bi translated">输入数据</h2><p id="fb43" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">我们选择使用<a class="ae ky" href="https://ops.fhwa.dot.gov/freight/freight_analysis/faf/" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">运费分析框架</strong> </a> (FAF)数据进行本次论证。FAF是一个公共数据源，提供各州和主要大都市地区之间所有运输方式的货运流量估计。</p><p id="afcb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您使用<strong class="lb iu"> R </strong>并希望在<strong class="lb iu"> R and R闪亮中探索这些数据，</strong>请参考<a class="ae ky" rel="noopener" target="_blank" href="/create-interactive-map-applications-in-r-and-r-shiny-for-exploring-geospatial-data-96b0f9692f0f?sk=481138ff99507245f15683bd58b73def">本文</a>了解更多信息。</p><div class="oa ob gp gr oc od"><a rel="noopener follow" target="_blank" href="/create-interactive-map-applications-in-r-and-r-shiny-for-exploring-geospatial-data-96b0f9692f0f"><div class="oe ab fo"><div class="of ab og cl cj oh"><h2 class="bd iu gy z fp oi fr fs oj fu fw is bi translated">在R and R创建交互式地图应用程序，探索地理空间数据</h2><div class="ok l"><h3 class="bd b gy z fp oi fr fs oj fu fw dk translated">使用地图进行输入选择的Web应用程序</h3></div><div class="ol l"><p class="bd b dl z fp oi fr fs oj fu fw dk translated">towardsdatascience.com</p></div></div><div class="om l"><div class="on l oo op oq om or ks od"/></div></div></a></div><p id="5cea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们使用一个<code class="fe lw lx ly lz b">pandas</code> <code class="fe lw lx ly lz b">DataFrame</code>将CSV数据文件存储到<code class="fe lw lx ly lz b">df_data</code>中。并用一个<code class="fe lw lx ly lz b">geopandas</code> <code class="fe lw lx ly lz b">GeoDataFrame</code>将多多边形区域文件存入<code class="fe lw lx ly lz b">faf_zone</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="027e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lw lx ly lz b">od_mode_vol_45.csv</code> <em class="lv"> </em>包含每个始发地-目的地区域对按运输方式(如卡车、铁路、水路、航空等)以重量(吨)和价值(美元)表示的货运数据。</p><p id="e742" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lw lx ly lz b">faf_zone</code>中的每一行用区域ID、区域名称和几何图形定义了一个多多边形特征(即区域)。</p><p id="19fd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">文件<code class="fe lw lx ly lz b">od_mode_vol_45.csv</code>中的起点ID和终点ID对应于<code class="fe lw lx ly lz b">faf4_zone2.json</code>中的区域ID。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi os"><img src="../Images/401d0d7aee9ddd7a0e5e4533282a91b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Oc8GxaMqfXY09_q4aVeksQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">数据样本来自faf4.zone2.json(图片由作者提供)</p></figure><h2 id="ee0e" class="nh mk it bd ml ni nj dn mp nk nl dp mt li nm nn mv lm no np mx lq nq nr mz ns bi translated">启用绘图工具创建交互式地图</h2><p id="4c53" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">首先使用<code class="fe lw lx ly lz b">map_select=leafmap.Map()</code>创建一个地图对象，并指定各种参数来初始化地图，例如<code class="fe lw lx ly lz b">center</code>、<code class="fe lw lx ly lz b">zoom</code>、<code class="fe lw lx ly lz b">height</code>和<code class="fe lw lx ly lz b">width</code>。</p><p id="708f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lw lx ly lz b">OpenStreetMap</code>是<code class="fe lw lx ly lz b">leafmap</code>中的默认底图，可使用<code class="fe lw lx ly lz b">clear_layers()</code>移除，并可使用<code class="fe lw lx ly lz b">add_basemap()</code>加载替代底图。</p><p id="d091" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lw lx ly lz b">leafmap</code>可以带各种类型的矢量数据集，包括<code class="fe lw lx ly lz b">shapefiles</code>、<code class="fe lw lx ly lz b">GeoJSON</code>、<code class="fe lw lx ly lz b">CSV</code>带坐标等格式。直接从本地计算机通过<code class="fe lw lx ly lz b">leafmap</code>图形用户界面(GUI)向地图添加数据也是可能的。</p><p id="2286" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lw lx ly lz b">leafmap</code>功能<code class="fe lw lx ly lz b">add_gdf()</code>用于加载FAF区域多边形图层。交互式地图通过左侧显示的绘图工具进行渲染。<code class="fe lw lx ly lz b">draw_control</code>的可见性默认设置为<code class="fe lw lx ly lz b">True</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="c4f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们使用绘图工具在地图上放置几个标记、矩形(或多边形)来指示始发地和目的地所在的位置。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl ot"><img src="../Images/9745e33c57664853fb4a9de6076f6153.png" data-original-src="https://miro.medium.com/v2/1*qbm2iKsdgnHWCJcKOlsYMg.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用绘图工具确定始发地和目的地区域(由作者制作动画)</p></figure><h1 id="81ef" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">3.使用绘图工具从地图中查询地理空间数据</h1><h2 id="8fdc" class="nh mk it bd ml ni nj dn mp nk nl dp mt li nm nn mv lm no np mx lq nq nr mz ns bi translated">使用交互式地图作为区域选择工具</h2><p id="4f3c" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">我们将使用所选的始发地/目的地区域来过滤货运数据<code class="fe lw lx ly lz b">df_data</code>，并获得一个子集作为查询结果。</p><p id="b874" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们假设第一个标记代表起点，第二个标记代表终点。与第一个矩形重叠的区域在原始区域集中，与第二个矩形重叠的区域在目标区域集中。</p><p id="4453" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">地图上绘制的标记和形状可以保存到文件中以备将来使用。<code class="fe lw lx ly lz b">leafmap</code>让矢量数据保存成各种地理空间数据格式变得超级简单，包括如下所示的<code class="fe lw lx ly lz b">geojson</code>:</p><pre class="kj kk kl km gt ou lz ov ow aw ox bi"><span id="df2b" class="nh mk it lz b gy oy oz l pa pb">map_select<strong class="lz iu">.</strong>save_draw_features("selected_location.geojson")</span></pre><p id="dd5b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以通过点击回收站并选择<code class="fe lw lx ly lz b">Clear All</code>来清除这些标记和形状。</p><p id="8ecd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要查看使用绘图工具创建的特征，使用<code class="fe lw lx ly lz b">map_select.draw_features</code>。如果我们在地图上放置两个标记，后面跟着两个矩形，我们将得到以下按创建顺序排列的<code class="fe lw lx ly lz b">list</code>个几何图形:</p><pre class="kj kk kl km gt ou lz ov ow aw ox bi"><span id="c9f7" class="nh mk it lz b gy oy oz l pa pb">[{'geometry': {'coordinates': [-105.732422, 34.234512], 'type': 'Point'},<br/>  'properties': {},<br/>  'type': 'Feature'},<br/> {'geometry': {'coordinates': [-77.519531, 40.380028], 'type': 'Point'},<br/>  'properties': {},<br/>  'type': 'Feature'},<br/> {'geometry': {'coordinates': [[[-105.820313, 41.574361],<br/>     [-105.820313, 46.012224],<br/>     [-102.128906, 46.012224],<br/>     [-102.128906, 41.574361],<br/>     [-105.820313, 41.574361]]],<br/>   'type': 'Polygon'},<br/>  'properties': {},<br/>  'type': 'Feature'},<br/> {'geometry': {'coordinates': [[[-80.566403, 34.861895],<br/>     [-80.566403, 37.46323],<br/>     [-78.164061, 37.46323],<br/>     [-78.164061, 34.861895],<br/>     [-80.566403, 34.861895]]],<br/>   'type': 'Polygon'},<br/>  'properties': {},<br/>  'type': 'Feature'}]</span></pre><p id="5aef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">这里的目的是获取包含起点/终点标记或与矩形(或多边形)重叠的FAF区域的信息(如ID和名称)。</strong></p><p id="9e96" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要用Python来做这件事，我们需要在原点/目的地点(或多边形)和FAF区域之间执行一个<strong class="lb iu">空间连接</strong>。但是首先我们需要将<code class="fe lw lx ly lz b">geojson</code>坐标从<code class="fe lw lx ly lz b">draw_features</code>转换成<code class="fe lw lx ly lz b">shapely</code>点或多边形。</p><h2 id="2119" class="nh mk it bd ml ni nj dn mp nk nl dp mt li nm nn mv lm no np mx lq nq nr mz ns bi translated">将坐标转换为几何形状，并执行空间连接以找到匹配的FAF区域</h2><p id="ab9d" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">我们记得，原点由我们放在地图上的第一个标记表示，因此它由<code class="fe lw lx ly lz b">map_select.draw_features[0]</code>指定。类似地，目的地点由<code class="fe lw lx ly lz b">map_select.draw_features[1]</code>指定。</p><p id="7099" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先我们从<code class="fe lw lx ly lz b">map_select.draw_features[0]</code>的坐标制作一个<code class="fe lw lx ly lz b">shapely</code>点几何体(<code class="fe lw lx ly lz b">df_origin</code>)。为了执行一个<strong class="lb iu">空间连接</strong>，我们需要为原点创建一个<code class="fe lw lx ly lz b">GeoDataFrame</code>。我们通过使用<code class="fe lw lx ly lz b">gpd.GeoDataFrame()</code>函数将<code class="fe lw lx ly lz b">df_origin</code>转换为<code class="fe lw lx ly lz b">points_origin</code>来实现这一点。</p><p id="2771" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lw lx ly lz b">gpd.GeoDataFrame()</code>功能的第二个参数是<code class="fe lw lx ly lz b">crs</code>，它指定了坐标参考系统(CRS)。在这种情况下，我们将<code class="fe lw lx ly lz b">crs</code>设置为与<code class="fe lw lx ly lz b">faf_zone</code> <code class="fe lw lx ly lz b">crs</code>相同，即带有EPSG代码<code class="fe lw lx ly lz b">4326</code>的WGS84地理CRS。</p><p id="e578" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们准备好使用<code class="fe lw lx ly lz b">gpd.sjoin()</code>函数基于两个图层的空间关系执行它们之间的空间连接。多边形层<code class="fe lw lx ly lz b">faf_zone</code>的属性与点层<code class="fe lw lx ly lz b">points_origin</code>的属性相结合，其中多边形层<code class="fe lw lx ly lz b">contains</code>为点。</p><p id="059c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有三种可能的连接类型可应用于由<code class="fe lw lx ly lz b">op</code>-参数指定的空间连接，即<code class="fe lw lx ly lz b">intersects</code>、<code class="fe lw lx ly lz b">within</code>和<code class="fe lw lx ly lz b">contains</code>。(<a class="ae ky" href="https://automating-gis-processes.github.io/CSC18/lessons/L4/spatial-join.html" rel="noopener ugc nofollow" target="_blank">参考</a>)</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="7837" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们在<code class="fe lw lx ly lz b">zone_origin</code>T5得到六列，分别是来自匹配多边形层<code class="fe lw lx ly lz b">faf_zone</code>的<code class="fe lw lx ly lz b">index_left</code>、<code class="fe lw lx ly lz b">id</code>和<code class="fe lw lx ly lz b">name</code>以及来自原点层<code class="fe lw lx ly lz b">points_origin</code>的<code class="fe lw lx ly lz b">lon</code>、<code class="fe lw lx ly lz b">lat</code>和<code class="fe lw lx ly lz b">coords</code>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pc"><img src="../Images/2da5e1168c759de92ba93718e873fe16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ogS3oCXb15sCupvX42rMzg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">源自原点标记的原点区域信息(图片由作者提供)</p></figure><p id="ef49" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">厉害！<strong class="lb iu">我们刚刚匹配了</strong> <code class="fe lw lx ly lz b"><strong class="lb iu">points_origin</strong></code> <strong class="lb iu">和</strong> <code class="fe lw lx ly lz b"><strong class="lb iu">faf_zone</strong></code> <strong class="lb iu">，得到了原产地信息</strong> <code class="fe lw lx ly lz b"><strong class="lb iu">zone_origin</strong></code> <strong class="lb iu">。</strong></p><p id="3e11" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">类似地，我们可以匹配两个点，即具有FAF区域层的始发地-目的地对。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="cbe8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lw lx ly lz b">zone_od</code> <code class="fe lw lx ly lz b">GeoDataFrame</code>有两行。第一行包含原始区域的信息，第二行包含目标区域的信息:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pd"><img src="../Images/c65c80e00b1a1d91f6188c64cdfd5960.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QD7z7Z7TsiUQJtJ6D6MQOw.png"/></div></div></figure><p id="425d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还可以通过在两个多边形层之间执行<strong class="lb iu">空间连接来获得起点/终点区域集的id和名称。</strong></p><p id="1d65" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用绘图工具创建的两个矩形被指定为<code class="fe lw lx ly lz b">map_select.draw_features[2]</code>和<code class="fe lw lx ly lz b">map_select.draw_features[3]</code>。</p><p id="0daf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lw lx ly lz b">shapely</code> <code class="fe lw lx ly lz b">Polygon()</code>功能用于将坐标的<code class="fe lw lx ly lz b">list</code>转换成多边形(<code class="fe lw lx ly lz b">poly</code>)，然后再转换成<code class="fe lw lx ly lz b">GeoDataFrame</code> <code class="fe lw lx ly lz b">origin_poly</code>。使用<code class="fe lw lx ly lz b">inner</code>方法在空间上连接<code class="fe lw lx ly lz b">origin_poly</code>(或<code class="fe lw lx ly lz b">dest_poly </code>)和<code class="fe lw lx ly lz b">faf_zone</code>两个多边形层，以识别重叠区域。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><h1 id="5991" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">4.基于查询结果创建choropleth图和地块</h1><p id="b46d" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">在获得与始发地和目的地相关联的区域信息(即id和名称)后，我们的下一步是过滤货运数据<code class="fe lw lx ly lz b">df_data</code>以得出从始发地到目的地或始发地和目的地对之间的货运流量(以吨为单位),然后创建一个choropleth图来显示货运流量分布。</p><p id="bfd5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以<em class="lv">“新墨西哥的剩余部分”</em>作为始发地查询或过滤<code class="fe lw lx ly lz b">df_data</code>，以导出包含目的地<em class="lv">“id”</em>和在<em class="lv">“新墨西哥的剩余部分”</em>和相应目的地之间移动的<em class="lv">“吨”</em>的数量的<code class="fe lw lx ly lz b">df_dest</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="d8dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了根据<code class="fe lw lx ly lz b">df_dest[‘tons']</code>值指示地图中特征(即区域多边形)的颜色，我们需要使用基于<code class="fe lw lx ly lz b">id</code>字段的<code class="fe lw lx ly lz b">faf_zone.merge()</code>函数将<code class="fe lw lx ly lz b">df_dest</code>与<code class="fe lw lx ly lz b">faf_zone</code> <code class="fe lw lx ly lz b">GeoDataFrame</code>连接起来。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pe"><img src="../Images/534025879f14403733f907a24b5b9077.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KpbS8uaOU353H_tyyORTqQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="8fb5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们准备好基于<code class="fe lw lx ly lz b">gdf_report[‘tons’]</code>的值创建choropleth图。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="e481" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lw lx ly lz b">colormap</code>是使用<code class="fe lw lx ly lz b">branca.colormap</code>库中的<code class="fe lw lx ly lz b">LinearColormap()</code>函数创建的。它根据来自<code class="fe lw lx ly lz b">"tons”</code>列的值指定一系列均匀分布和线性插值的颜色。</p><p id="e8c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果<code class="fe lw lx ly lz b">"tons”</code>列的值是倾斜的，您可以设置<code class="fe lw lx ly lz b">index</code>来创建不对称的<em class="lv">色标，</em>这非常有助于使choropleth图更有意义和信息量更大。</p><p id="172a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">可使用<code class="fe lw lx ly lz b">leafmap</code>功能<code class="fe lw lx ly lz b">add_colorbar()</code>将色标添加到地图中。</p><p id="bc1a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">要使用</strong> <code class="fe lw lx ly lz b"><strong class="lb iu">leaflet</strong></code> <strong class="lb iu">成功渲染一张choropleth贴图，将</strong> <code class="fe lw lx ly lz b"><strong class="lb iu">add_gdf()</strong></code> <strong class="lb iu">函数中的</strong> <code class="fe lw lx ly lz b"><strong class="lb iu">style_callback</strong></code> <strong class="lb iu">参数设置为</strong> <code class="fe lw lx ly lz b"><strong class="lb iu">style_callback=fill_color</strong></code> <strong class="lb iu">是很重要的。</strong> <code class="fe lw lx ly lz b"><strong class="lb iu">fill_color</strong></code> <strong class="lb iu">是根据</strong> <code class="fe lw lx ly lz b"><strong class="lb iu">colormap</strong></code> <strong class="lb iu">设置</strong> <code class="fe lw lx ly lz b"><strong class="lb iu">selected_gdf</strong></code> <strong class="lb iu">中各特征颜色的功能。</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pf"><img src="../Images/5a8d2c001e2f72eeb61f5c009ef553e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RtEwWFWexdZsEHRJmuxi2w.png"/></div></div></figure><p id="4a73" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还可以使用<code class="fe lw lx ly lz b">origin_poly_zones</code>和<code class="fe lw lx ly lz b">dest_poly_zones</code>查询<code class="fe lw lx ly lz b">df_data</code>来选择一个行子集，其中<code class="fe lw lx ly lz b">dms_orig</code>值等于<code class="fe lw lx ly lz b">origin_poly_zones.id</code>中的一个区域，而<code class="fe lw lx ly lz b">dms_dest</code>值等于<code class="fe lw lx ly lz b">dest_poly_zones.id</code>中的一个区域。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="1ae2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们根据在始发地和目的地区域集合之间移动的吨数，使用<code class="fe lw lx ly lz b">plotly</code>库绘制结果。将<code class="fe lw lx ly lz b">x</code>设置为<code class="fe lw lx ly lz b">df_od.transport_mode</code>，将<code class="fe lw lx ly lz b">y</code>设置为<code class="fe lw lx ly lz b">df_od.tons</code>。条形图显示了按运输方式从始发地运输到目的地运输的总吨数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pg"><img src="../Images/cf9977da2b0fadaa5b1fb12b4b61493c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FwTyG63BPwJ46fth_R8XYA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">按模式设置的始发地/目的地区域之间的吨数(图片由作者提供)</p></figure></div><div class="ab cl ph pi hx pj" role="separator"><span class="pk bw bk pl pm pn"/><span class="pk bw bk pl pm pn"/><span class="pk bw bk pl pm"/></div><div class="im in io ip iq"><p id="ee3f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望你喜欢阅读这篇文章。随意留下评论和掌声😊<em class="lv">。</em></p><div class="oa ob gp gr oc od"><a href="https://huajing-shi.medium.com/membership" rel="noopener follow" target="_blank"><div class="oe ab fo"><div class="of ab og cl cj oh"><h2 class="bd iu gy z fp oi fr fs oj fu fw is bi translated">用我的推荐链接-华景石加入媒体</h2><div class="ok l"><h3 class="bd b gy z fp oi fr fs oj fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="ol l"><p class="bd b dl z fp oi fr fs oj fu fw dk translated">huajing-shi.medium.com</p></div></div><div class="om l"><div class="po l oo op oq om or ks od"/></div></div></a></div><p id="28d3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Python代码和输入数据可从<a class="ae ky" href="https://github.com/shi093/Leafmap-FAF" rel="noopener ugc nofollow" target="_blank"> my GitHub repo </a>获得。</p></div><div class="ab cl ph pi hx pj" role="separator"><span class="pk bw bk pl pm pn"/><span class="pk bw bk pl pm pn"/><span class="pk bw bk pl pm"/></div><div class="im in io ip iq"><h2 id="3465" class="nh mk it bd ml ni nj dn mp nk nl dp mt li nm nn mv lm no np mx lq nq nr mz ns bi translated">参考</h2><p id="e594" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">吴(2021)。Leafmap:一个Python包，用于在Jupyter环境中使用最少的代码进行交互式制图和地理空间分析。<em class="lv">开源软件杂志</em>，6期(63)，3414页。<a class="ae ky" href="https://doi.org/10.21105/joss.03414" rel="noopener ugc nofollow" target="_blank">https://doi.org/10.21105/joss.03414</a></p><p id="deb7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://geobgu.xyz/py/shapely.html" rel="noopener ugc nofollow" target="_blank">用Python进行空间数据编程</a></p><p id="f75f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://automating-gis-processes.github.io/CSC18/lessons/L4/spatial-join.html" rel="noopener ugc nofollow" target="_blank">Python GIS内部-空间连接</a></p><p id="fdab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://www.matecdev.com/posts/point-in-polygon.html" rel="noopener ugc nofollow" target="_blank">如何用Python运行快速多边形内点测试</a></p><p id="8e54" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://gis.stackexchange.com/questions/395315/shapely-coordinate-sequence-to-geodataframe" rel="noopener ugc nofollow" target="_blank">几何坐标序列到地理数据框架</a></p><p id="2ae0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://stackoverflow.com/questions/68820085/how-to-convert-geojson-to-shapely-polygon" rel="noopener ugc nofollow" target="_blank">如何将geojson转换为shapely多边形</a></p><p id="eefc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://github.com/shakasom/GDS" rel="noopener ugc nofollow" target="_blank">Python地理数据科学教程</a></p></div></div>    
</body>
</html>