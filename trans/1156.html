<html>
<head>
<title>How to Restore Data Accidentally Deleted from Google BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何恢复 Google BigQuery 意外删除的数据</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-restore-data-accidentally-deleted-from-google-bigquery-1ec2a621149f#2022-03-24">https://towardsdatascience.com/how-to-restore-data-accidentally-deleted-from-google-bigquery-1ec2a621149f#2022-03-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="66b0" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">详细说明，以帮助您恢复意外删除的数据，而不是提前获得任何白发</h2></div><p id="f31a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你有没有在 Google BigQuery 中不小心删除了一个重要的表、视图或者整个数据集？如果有，您知道您不能继续使用包含已删除数据的表和查询。</p><p id="dde9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lb" href="https://www.owox.com" rel="noopener ugc nofollow" target="_blank">OWOX 团队</a>已经创建了一个详细的分步说明来恢复被删除的数据，以及一些步骤来防止将来出现类似的问题。</p><p id="13a3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果已删除的表自删除以来未超过七天，并且您知道其名称和从中删除该表的数据集的名称，则可以恢复该表。</p><p id="851b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要恢复表，请在 Google BigQuery 界面中打开云 Shell 命令行:</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lc"><img src="../Images/6e83e05ca42eb3c76872ce3e9bf50f6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9k4tTjVjMKQP957L.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">作者图片</p></figure><p id="27a0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">输入以下命令:</p><pre class="ld le lf lg gt ls lt lu lv aw lw bi"><span id="d105" class="lx ly iq lt b gy lz ma l mb mc">bq cp mydataset.mytable@-3600000 mydataset.newtable</span></pre><p id="7dc9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">带有表名和数据集名的相同命令示例:</p><pre class="ld le lf lg gt ls lt lu lv aw lw bi"><span id="21ad" class="lx ly iq lt b gy lz ma l mb mc">bq cp OWOXBI_Reports.123_Transactions_withModels@-13600000 OWOXBI_Reports_Restore.123_Transactions_withModels</span></pre><p id="361a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">其中:</p><ul class=""><li id="c11d" class="md me iq kh b ki kj kl km ko mf ks mg kw mh la mi mj mk ml bi translated">owo xbi _ reports . 123 _ Transactions _ with models-是已删除的数据集和表。</li><li id="31d5" class="md me iq kh b ki mm kl mn ko mo ks mp kw mq la mi mj mk ml bi translated">owo xbi _ Reports _ restore . 123 _ Transactions _ with models-数据集以及要在其中还原数据的表的名称。</li><li id="93a7" class="md me iq kh b ki mm kl mn ko mo ks mp kw mq la mi mj mk ml bi translated">@-13600000 —过去的一段距离(13，600，000 毫秒前)，此时您要查找的表仍然存在。例如，如果一个表在 30 分钟前被删除，那么设置时间间隔@ -3600000 就足够了，这是一个小时前(60 秒×60 分钟× 1000)。</li></ul><p id="1ab0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">输入请求后，需要授权。单击授权按钮:</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lc"><img src="../Images/2bfa15b1fe9c3bcb4437a82dbe7d6005.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kBVo1GEmNU2Lh6_11U58aw.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">作者图片</p></figure><p id="6811" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该命令成功运行后，该表将被恢复:</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lc"><img src="../Images/bf368d93633c10ca1f2ecbc4cdacb888.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1uRjZzZ23iFZlFvgyPVayQ.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">作者图片</p></figure><p id="d3e8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您将看到类似以下内容的文本:</p><pre class="ld le lf lg gt ls lt lu lv aw lw bi"><span id="1da9" class="lx ly iq lt b gy lz ma l mb mc">Waiting on bqjob_r4ca30008c2e3147d_0000017af0d58e5e_1 ... (0s) Current status: DONE Table 'summer-drive-112011:OWOXBI_Reports_Restore.test_table@-600000' successfully copied to 'summer-drive-112011:OWOXBI_Reports_Restore.test_table'</span></pre><h1 id="cf0d" class="mr ly iq bd ms mt mu mv mw mx my mz na jw nb jx nc jz nd ka ne kc nf kd ng nh bi translated">如何恢复已删除的视图</h1><p id="8ea9" class="pw-post-body-paragraph kf kg iq kh b ki ni jr kk kl nj ju kn ko nk kq kr ks nl ku kv kw nm ky kz la ij bi translated">您不能以上述方式恢复远程视图。那种方法只适用于表。</p><p id="a89a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Google 支持建议使用日志浏览器来恢复已删除的视图。</p><p id="5206" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要查找更新远程视图的查询，请在<a class="ae lb" href="https://console.cloud.google.com/logs/query" rel="noopener ugc nofollow" target="_blank">谷歌云平台日志</a>中运行以下查询:</p><pre class="ld le lf lg gt ls lt lu lv aw lw bi"><span id="e9be" class="lx ly iq lt b gy lz ma l mb mc">resource.type="bigquery_resource" protoPayload.methodName="tableservice.update" protoPayload.serviceData.tableUpdateRequest.resource.tableName.tableId="custom_events_attribution_VIEW"</span></pre><p id="779c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">其中:</p><ul class=""><li id="5a2a" class="md me iq kh b ki kj kl km ko mf ks mg kw mh la mi mj mk ml bi translated">tableservice.update —是在日志中显示视图更新的命令</li><li id="9dc2" class="md me iq kh b ki mm kl mn ko mo ks mp kw mq la mi mj mk ml bi translated">custom _ events _ attribution _ VIEW 视图的名称</li></ul><p id="c8e9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在选择时间范围设置中，设置可对视图进行更改的时间段(例如，一年):</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/96a313bf114f037c180e3f041fba2a46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1384/format:webp/1*GBKSYzb-pBr4-Pkx4vMf8A.png"/></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">作者图片</p></figure><p id="ddc5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">执行该命令时，将显示更新了您正在查找的视图的所有查询。选择最后一个时间戳查询:</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lc"><img src="../Images/e9acf174aa60240f12bfb08daa36110b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mch3TLAZOY7DHX2Xvq8wCg.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">作者图片</p></figure><p id="92f5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从日志中复制查询并重新创建视图。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lc"><img src="../Images/e1a6735eedbcbaecc88cb7f133f9dd30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PPdcddamUdKIquzmx1cEvQ.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">作者图片</p></figure><p id="a1c2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，您可以找到创建您正在寻找的视图的查询(在此之前，我们搜索更新视图的查询)。为此，请使用以下命令:</p><pre class="ld le lf lg gt ls lt lu lv aw lw bi"><span id="58bf" class="lx ly iq lt b gy lz ma l mb mc">resource.type="bigquery_resource" protoPayload.methodName="tableservice.insert" protoPayload.serviceData.tableInsertRequest.resource.tableName.tableId="query_name_VIEW"</span></pre><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lc"><img src="../Images/fa74e4b0162cd4db052f18d1f91d9b33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w-jWwI8-rofhUoAnaw9COA.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">作者图片</p></figure><p id="143b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们建议您设置尽可能长的时间来搜索日志中所需的条目。</p><p id="83ea" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果视图是在开始记录日志之前创建的，则无法恢复。在这种情况下，我们上面描述的 tableservice.update 命令会有所帮助。</p><h1 id="b30f" class="mr ly iq bd ms mt mu mv mw mx my mz na jw nb jx nc jz nd ka ne kc nf kd ng nh bi translated">如何恢复已删除的数据集</h1><p id="3aac" class="pw-post-body-paragraph kf kg iq kh b ki ni jr kk kl nj ju kn ko nk kq kr ks nl ku kv kw nm ky kz la ij bi translated">如果您删除数据集，您将无法恢复它。您必须创建一个同名的新数据集，还原已删除数据集中的表和视图，并将它们移动到新的数据集中。</p><p id="1008" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在删除数据集后的前 24 小时内，不能创建同名的新数据集，但仍可以找到属于已删除数据集的表和视图的名称。但是，表和视图本身将不再可见。</p><p id="4598" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过在 BigQuery 中搜索，可以按名称从已删除的数据集中查找视图:</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi no"><img src="../Images/43b4bde5d630430f2efa48c30a9dd589.png" data-original-src="https://miro.medium.com/v2/resize:fit:1184/format:webp/1*iT43DnDc9thxZN6Gzcvgtg.png"/></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">作者图片</p></figure><p id="1baa" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">无法通过搜索找到表的列表，因为表的名称中没有公共组件。</p><p id="3245" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">若要从已删除的数据集中查找表名，请使用以下 SQL 查询。在查询中，指定可以修改表的时间段(creation_time BETWEEN)。因此，该查询将返回在哪个时间段内对其进行了更改的表。这些将是已删除数据集中的表。</p><pre class="ld le lf lg gt ls lt lu lv aw lw bi"><span id="a674" class="lx ly iq lt b gy lz ma l mb mc">SELECT <br/>  * <br/>FROM ( <br/>  SELECT <br/>    query, <br/>    user_email,         CONCAT(destination_table.project_id,".",destination_table.dataset_id,".",destination_table.table_id) AS destination_table, <br/>COUNT(job_id) AS job_ids, <br/>MAX(creation_time) AS lastUpdateDate <br/>FROM <br/>  region-us.INFORMATION_SCHEMA.JOBS_BY_PROJECT <br/>WHERE <br/>  creation_time BETWEEN TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 180 DAY) <br/>  AND TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 0 DAY) <br/>  AND state = 'DONE' <br/>AND CONCAT(destination_table.project_id,".",destination_table.dataset_id,".",destination_table.table_id) LIKE "%OWOXBI_Reports.%" <br/>GROUP BY <br/>  1, <br/>  2, <br/>  3 <br/>ORDER BY <br/>  5 DESC)</span></pre><p id="ec77" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">作为请求的结果，您将收到以下信息:</p><ul class=""><li id="84c4" class="md me iq kh b ki kj kl km ko mf ks mg kw mh la mi mj mk ml bi translated">查询-对 destination_table 进行更改的查询的文本</li><li id="00b3" class="md me iq kh b ki mm kl mn ko mo ks mp kw mq la mi mj mk ml bi translated">用户电子邮件—启动目标表更新请求的用户</li><li id="1a69" class="md me iq kh b ki mm kl mn ko mo ks mp kw mq la mi mj mk ml bi translated">destination _ table 已更新的表</li><li id="7680" class="md me iq kh b ki mm kl mn ko mo ks mp kw mq la mi mj mk ml bi translated">job_ids —在指定的时间间隔内开始查询的次数(创建时间介于…)</li><li id="ea77" class="md me iq kh b ki mm kl mn ko mo ks mp kw mq la mi mj mk ml bi translated">last updatedate-查询的上次启动时间(MAX(creation _ time)AS last updatedate)</li></ul><p id="8a6a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">删除数据集 24 小时后，您可以创建一个同名的新数据集，并开始恢复表和视图。</p><h1 id="793d" class="mr ly iq bd ms mt mu mv mw mx my mz na jw nb jx nc jz nd ka ne kc nf kd ng nh bi translated">如何防止将来出现类似问题</h1><ol class=""><li id="0b23" class="md me iq kh b ki ni kl nj ko np ks nq kw nr la ns mj mk ml bi translated">当您开始使用项目时，在 Google BigQuery 项目中打开日志收集。</li><li id="81d4" class="md me iq kh b ki mm kl mn ko mo ks mp kw mq la ns mj mk ml bi translated">不要将表命名为数据集，也不要将其视为数据集。</li><li id="16e6" class="md me iq kh b ki mm kl mn ko mo ks mp kw mq la ns mj mk ml bi translated">仔细检查您想要从 Google BigQuery 中删除的任何表的名称。</li><li id="d7c8" class="md me iq kh b ki mm kl mn ko mo ks mp kw mq la ns mj mk ml bi translated">通过查询删除表，而不是通过用户界面。</li><li id="4ae0" class="md me iq kh b ki mm kl mn ko mo ks mp kw mq la ns mj mk ml bi translated">将实体类型添加到数据集、表和视图名称中。例如:</li></ol><ul class=""><li id="c29e" class="md me iq kh b ki kj kl km ko mf ks mg kw mh la mi mj mk ml bi translated">OWOXBI _ 报表 _ 数据集</li><li id="b9f7" class="md me iq kh b ki mm kl mn ko mo ks mp kw mq la mi mj mk ml bi translated">OWOXBI_report_table</li><li id="3178" class="md me iq kh b ki mm kl mn ko mo ks mp kw mq la mi mj mk ml bi translated">OWOXBI_report_view</li></ul><p id="231f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以使用查询<a class="ae lb" href="https://cloud.google.com/bigquery/docs/managing-tables#deleting_a_table" rel="noopener ugc nofollow" target="_blank">删除表</a>:</p><pre class="ld le lf lg gt ls lt lu lv aw lw bi"><span id="d088" class="lx ly iq lt b gy lz ma l mb mc">DROP TABLE `summer-drive-112011.OWOXBI_Reports_Restore.test_table`</span></pre><p id="2185" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您还可以使用查询<a class="ae lb" href="https://cloud.google.com/bigquery/docs/managing-views#sql" rel="noopener ugc nofollow" target="_blank">删除视图</a>:</p><pre class="ld le lf lg gt ls lt lu lv aw lw bi"><span id="1e28" class="lx ly iq lt b gy lz ma l mb mc">DROP VIEW `summer-drive-112011.OWOXBI_Reports_Restore.test_VIEW`</span></pre><h1 id="638d" class="mr ly iq bd ms mt mu mv mw mx my mz na jw nb jx nc jz nd ka ne kc nf kd ng nh bi translated">如果问题再次发生，如何缩小问题的规模</h1><ul class=""><li id="91a7" class="md me iq kh b ki ni kl nj ko np ks nq kw nr la mi mj mk ml bi translated">不要更改计划和 Google Apps 脚本中的查询；第二天，恢复所有视图和表，之后 Schedule 和 Google Apps 脚本将正常工作。</li><li id="55bd" class="md me iq kh b ki mm kl mn ko mo ks mp kw mq la mi mj mk ml bi translated">如果视图或表参与了属性模型的设置，您需要在将数据恢复到其先前位置后重新开始属性计算。</li></ul><h2 id="425a" class="lx ly iq bd ms nt nu dn mw nv nw dp na ko nx ny nc ks nz oa ne kw ob oc ng od bi translated">关于该主题的有用链接:</h2><p id="b5b4" class="pw-post-body-paragraph kf kg iq kh b ki ni jr kk kl nj ju kn ko nk kq kr ks nl ku kv kw nm ky kz la ij bi translated"><a class="ae lb" href="https://cloud.google.com/bigquery/docs/managing-tables#undeletetable" rel="noopener ugc nofollow" target="_blank">恢复删除的表格</a></p><p id="91e3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lb" href="https://cloud.google.com/bigquery/docs/managing-tables#deleting_a_table" rel="noopener ugc nofollow" target="_blank">删除表格</a></p><p id="7a0e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lb" href="https://cloud.google.com/bigquery/docs/managing-views#sql" rel="noopener ugc nofollow" target="_blank">管理观点</a></p><p id="76e1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lb" href="https://medium.com/@dhafnar/how-to-instantly-recover-a-table-in-google-bigquery-544a9b7e7a8d" rel="noopener">如何在 Google BigQuery 中即时恢复一个表</a></p></div></div>    
</body>
</html>