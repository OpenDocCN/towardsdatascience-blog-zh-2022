<html>
<head>
<title>How to use variables in BigQuery using SQL — Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用SQL在BigQuery中使用变量—第1部分</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-use-variables-in-bigquery-using-sql-part-1-a10aa99d8802#2022-07-20">https://towardsdatascience.com/how-to-use-variables-in-bigquery-using-sql-part-1-a10aa99d8802#2022-07-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="2cfc" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">通过WITH子句使用参数和变量向灵活性和可重用性迈进了一步</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/fcb6003f5676e0d28d1e9e240fcba971.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hHmarqF9gQ2vCdWav9IxZQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">黑屏由<a class="ae kv" href="https://unsplash.com/@davidschultz?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">大卫·舒尔茨</a>在<a class="ae kv" href="https://unsplash.com/photos/SrewPUfo2c0" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><h2 id="9ffc" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">什么是变量，为什么它们有用？</h2><p id="ff5a" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated"><strong class="lu ir">变量</strong>也被称为<strong class="lu ir"> <em class="ml">参数</em> </strong> <em class="ml">。</em>它们<em class="ml"> </em>可以在SQL中用于设置或声明值。</p><blockquote class="mm"><p id="68f0" class="mn mo iq bd mp mq mr ms mt mu mv mk dk translated">变量存储您提供给它们的一个或多个值，然后可以在查询中的任何地方使用。</p></blockquote><p id="257c" class="pw-post-body-paragraph ls lt iq lu b lv mw jr lx ly mx ju ma lf my mc md lj mz mf mg ln na mi mj mk ij bi translated">通常在代码开始时设置，它们在以下情况下很有用:</p><ul class=""><li id="d429" class="nb nc iq lu b lv nd ly ne lf nf lj ng ln nh mk ni nj nk nl bi translated"><strong class="lu ir">您不希望在几个地方更改相同的值，因为您的查询有多行代码</strong></li><li id="b789" class="nb nc iq lu b lv nm ly nn lf no lj np ln nq mk ni nj nk nl bi translated"><strong class="lu ir">您希望在不影响代码逻辑的情况下轻松更改该值</strong></li><li id="9300" class="nb nc iq lu b lv nm ly nn lf no lj np ln nq mk ni nj nk nl bi translated"><strong class="lu ir">您希望减少查询的长度和复杂性</strong></li></ul><p id="9036" class="pw-post-body-paragraph ls lt iq lu b lv nd jr lx ly ne ju ma lf nr mc md lj ns mf mg ln nt mi mj mk ij bi translated">变量可以通过命令行或使用BigQuery API在Python等其他语言中使用。但是在本文中，我们将关注如何在SQL查询中使用它。</p><p id="39e0" class="pw-post-body-paragraph ls lt iq lu b lv nd jr lx ly ne ju ma lf nr mc md lj ns mf mg ln nt mi mj mk ij bi translated">在BigQuery中，我们有两种使用变量的方法:</p><ul class=""><li id="7172" class="nb nc iq lu b lv nd ly ne lf nf lj ng ln nh mk ni nj nk nl bi translated">使用带有子句的<strong class="lu ir"/></li><li id="73ec" class="nb nc iq lu b lv nm ly nn lf no lj np ln nq mk ni nj nk nl bi translated">使用BigQuery <strong class="lu ir">程序语言</strong></li></ul><p id="9122" class="pw-post-body-paragraph ls lt iq lu b lv nd jr lx ly ne ju ma lf nr mc md lj ns mf mg ln nt mi mj mk ij bi translated">在这篇名为“第一部分”的文章中，我们将只讨论WITH子句。</p><p id="0330" class="pw-post-body-paragraph ls lt iq lu b lv nd jr lx ly ne ju ma lf nr mc md lj ns mf mg ln nt mi mj mk ij bi translated">如果想了解更多关于过程语言(类似于脚本语言)的知识，可以参考BigQuery文档。</p><div class="nu nv gp gr nw nx"><a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/procedural-language" rel="noopener  ugc nofollow" target="_blank"><div class="ny ab fo"><div class="nz ab oa cl cj ob"><h2 class="bd ir gy z fp oc fr fs od fu fw ip bi translated">过程语言| BigQuery |谷歌云</h2><div class="oe l"><h3 class="bd b gy z fp oc fr fs od fu fw dk translated">Google标准SQL过程语言允许您在一个查询中执行多个语句作为多语句…</h3></div><div class="of l"><p class="bd b dl z fp oc fr fs od fu fw dk translated">cloud.google.com</p></div></div><div class="og l"><div class="oh l oi oj ok og ol kp nx"/></div></div></a></div><p id="fdcb" class="pw-post-body-paragraph ls lt iq lu b lv nd jr lx ly ne ju ma lf nr mc md lj ns mf mg ln nt mi mj mk ij bi translated">作为一个相关主题(但不完全与本文相关)，您可能也对使用存储过程感兴趣，它也可以利用过程语言。</p><div class="nu nv gp gr nw nx"><a href="https://cloud.google.com/bigquery/docs/procedures" rel="noopener  ugc nofollow" target="_blank"><div class="ny ab fo"><div class="nz ab oa cl cj ob"><h2 class="bd ir gy z fp oc fr fs od fu fw ip bi translated">使用存储过程| BigQuery | Google Cloud</h2><div class="oe l"><h3 class="bd b gy z fp oc fr fs od fu fw dk translated">存储过程是可以从其他查询或其他存储过程中调用的语句的集合。一个…</h3></div><div class="of l"><p class="bd b dl z fp oc fr fs od fu fw dk translated">cloud.google.com</p></div></div><div class="og l"><div class="om l oi oj ok og ol kp nx"/></div></div></a></div></div><div class="ab cl on oo hu op" role="separator"><span class="oq bw bk or os ot"/><span class="oq bw bk or os ot"/><span class="oq bw bk or os"/></div><div class="ij ik il im in"><h1 id="0ec1" class="ou kx iq bd ky ov ow ox lb oy oz pa le jw pb jx li jz pc ka lm kc pd kd lq pe bi translated">使用WITH子句的变量</h1><p id="0820" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated">我们从一个基本数据表开始，它包括日期、国家、产品名称和与每个订单相关的收入。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pf"><img src="../Images/369c201f754effedb904dff6509d7fbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xTJNGaanye6S8shZfJZ0Sw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">我们的基本数据表。(图片由<a class="ae kv" href="https://romaingranger.medium.com/" rel="noopener">作者</a>提供)</p></figure><h2 id="3d65" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">试验单个值(手动)</h2><p id="41d1" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated">在第一个例子中，我们希望获得所有收入大于等于250美元的产品。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="pg ph l"/></div></figure><p id="a75b" class="pw-post-body-paragraph ls lt iq lu b lv nd jr lx ly ne ju ma lf nr mc md lj ns mf mg ln nt mi mj mk ij bi translated">在“主查询”部分，我们使用逗号作为<strong class="lu ir">，在<code class="fe pi pj pk pl b">FROM</code>子句中调用我们的表(<em class="ml">基表</em>和<em class="ml">变量</em>)之后，能够使用我们的过滤子句<strong class="lu ir">中的值，而无需任何连接</strong>。</strong></p><p id="0df7" class="pw-post-body-paragraph ls lt iq lu b lv nd jr lx ly ne ju ma lf nr mc md lj ns mf mg ln nt mi mj mk ij bi translated">但是，我明白你的意思，你是对的:我们本可以避免使用<code class="fe pi pj pk pl b">WITH</code>子句，而只使用<code class="fe pi pj pk pl b">WHERE</code>子句中的值。</p><p id="4870" class="pw-post-body-paragraph ls lt iq lu b lv nd jr lx ly ne ju ma lf nr mc md lj ns mf mg ln nt mi mj mk ij bi translated">但是，如您所见，这是将该值放在查询顶部的方便位置。让我们看一个稍微复杂一点的例子，有不止一个变量，查询两个表而不是一个。</p><h2 id="7577" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">尝试多个值(手动)</h2><p id="2a41" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated">我们现在有了多个变量，我们把它们写在一个数组中(我们直接<code class="fe pi pj pk pl b">UNNEST</code>来获得所有的值作为单独的行)。我们还有两个表，<code class="fe pi pj pk pl b">base_table</code>和<code class="fe pi pj pk pl b">base_table_2</code>，它们重用同一个过滤变量。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="pg ph l"/></div></figure><p id="abed" class="pw-post-body-paragraph ls lt iq lu b lv nd jr lx ly ne ju ma lf nr mc md lj ns mf mg ln nt mi mj mk ij bi translated">在这种情况下，在保存变量的<code class="fe pi pj pk pl b">WITH</code>子句中添加、更改或删除值会更快。</p><p id="6f93" class="pw-post-body-paragraph ls lt iq lu b lv nd jr lx ly ne ju ma lf nr mc md lj ns mf mg ln nt mi mj mk ij bi translated">另一个技巧是，如果您想要组合多个值，可以使用一个组合了<code class="fe pi pj pk pl b">ARRAY</code>和<code class="fe pi pj pk pl b">STRUCT</code>类型的格式。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="pg ph l"/></div></figure><p id="af67" class="pw-post-body-paragraph ls lt iq lu b lv nd jr lx ly ne ju ma lf nr mc md lj ns mf mg ln nt mi mj mk ij bi translated">保存我们的变量的子句现在有两个字段<strong class="lu ir">与<strong class="lu ir">价格</strong>和<strong class="lu ir">产品名称</strong> t相关。它可以在过滤器中使用，与我们前面的示例相同。</strong></p><p id="70ab" class="pw-post-body-paragraph ls lt iq lu b lv nd jr lx ly ne ju ma lf nr mc md lj ns mf mg ln nt mi mj mk ij bi translated">既然我们已经看到了如何使用手动值，<strong class="lu ir">让我们看看如何使它们动态，</strong>基于从另一个表中计算出的值，或者基于在接收新数据时会改变的数据。</p><h2 id="6050" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">尝试单一值(动态)</h2><p id="094d" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated">从我们的基表开始，我们希望找到每件产品的收入<strong class="lu ir">是平均产品收入</strong>的三倍的所有行。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="pg ph l"/></div></figure><p id="b52a" class="pw-post-body-paragraph ls lt iq lu b lv nd jr lx ly ne ju ma lf nr mc md lj ns mf mg ln nt mi mj mk ij bi translated">我们的<code class="fe pi pj pk pl b">WITH</code>子句将返回<strong class="lu ir"> 144.2 </strong>，这是使用我们的基表上的平均产品收入乘以3动态计算的。请注意，您可以使用<strong class="lu ir">任何您想要的数据集</strong>，并且当使用新数据执行该查询时，该值可能会改变。</p><h2 id="4750" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">尝试列表(手动)</h2><p id="36cc" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated">本着同样的精神，你也可以使用项目清单。假设我们希望<strong class="lu ir">在我们的基表中过滤特定的项目名称</strong>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="pg ph l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">用数组创建的手动列表</p></figure><p id="f042" class="pw-post-body-paragraph ls lt iq lu b lv nd jr lx ly ne ju ma lf nr mc md lj ns mf mg ln nt mi mj mk ij bi translated">您也可以在<code class="fe pi pj pk pl b">WITH</code>子句中使用<code class="fe pi pj pk pl b">UNION ALL</code>编写相同的查询。但是我发现数组写起来更快。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="pg ph l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">使用UNION ALL创建的手动列表</p></figure><h2 id="c9e4" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">尝试列表(动态)</h2><p id="2e3f" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated">我们希望所有包含“谷歌”一词的产品。我们可以在变量语句中使用<code class="fe pi pj pk pl b">LIKE</code>语法获得所有这些值。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="pg ph l"/></div></figure><h2 id="1cdf" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">试验日期(手动)</h2><p id="3efb" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated">对于日期，手动添加需要将数据类型转换为<code class="fe pi pj pk pl b">DATE</code>类型(或者在查询中使用的<code class="fe pi pj pk pl b">TIMESTAMP</code>或<code class="fe pi pj pk pl b">DATETIME</code>)。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="pg ph l"/></div></figure><h2 id="69c3" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">试验日期(动态)</h2><p id="90ec" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated">我们希望使用另一个数据集的数据(在我们的例子中是<code class="fe pi pj pk pl b">base_table_2</code>)来获得一个动态范围，以便在我们的主SQL语句中进行过滤。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="pg ph l"/></div></figure></div><div class="ab cl on oo hu op" role="separator"><span class="oq bw bk or os ot"/><span class="oq bw bk or os ot"/><span class="oq bw bk or os"/></div><div class="ij ik il im in"><h2 id="9c2e" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">几句结束语</h2><p id="8186" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated">本文通过几个例子演示了在<code class="fe pi pj pk pl b">WITH</code>子句中使用变量的技巧。我们将在“第2部分”中讨论BigQuery <strong class="lu ir">过程语言</strong>(也称为脚本语法)。</p><p id="ccff" class="pw-post-body-paragraph ls lt iq lu b lv nd jr lx ly ne ju ma lf nr mc md lj ns mf mg ln nt mi mj mk ij bi translated">正如我们所见，<code class="fe pi pj pk pl b">WITH</code>子句可能非常有用，但它并不总是理想的:它增加了更多的代码行，您可能需要修改数据类型(就像手动日期示例中一样)，BigQuery为声明和设置变量提供了更简单的语法(使用<code class="fe pi pj pk pl b">DECLARE</code>和<code class="fe pi pj pk pl b">SET</code>子句)。</p><p id="80f9" class="pw-post-body-paragraph ls lt iq lu b lv nd jr lx ly ne ju ma lf nr mc md lj ns mf mg ln nt mi mj mk ij bi translated">我希望这将有所帮助，并让我知道你是否想看到更多的例子！</p></div></div>    
</body>
</html>