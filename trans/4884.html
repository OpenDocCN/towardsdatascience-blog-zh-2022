<html>
<head>
<title>3 Tips to Create More Robust Pipelines with Pandas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">与熊猫建立更稳固管道的3个技巧</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/3-tips-to-create-more-robust-pipelines-with-pandas-c404c52ad216#2022-10-31">https://towardsdatascience.com/3-tips-to-create-more-robust-pipelines-with-pandas-c404c52ad216#2022-10-31</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2e99" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">高效有序的工作流程之路。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a17602410d857916e1ddae7cfbee1964.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hdaTI0MCL5WWP1G5.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在<a class="ae ky" href="https://unsplash.com/s/photos/clean?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae ky" href="https://unsplash.com/@candid?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">偷拍</a>的照片</p></figure><p id="e577" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Pandas是一个数据分析和操作库，所以它可以让你从杂乱的原始数据到丰富的见解。不过在这个过程中，你可能会做一系列的数据清理、处理、分析操作。</p><p id="797a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您有一组连续的步骤来预处理原始数据时，pipe函数有助于设计一个有组织的、健壮的工作流。</p><p id="12b9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我将分享在设计更好的管道时很重要的3个技巧。</p><p id="10c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在开始学习这些技巧之前，让我们先简单介绍一下什么是管道并创建一个管道。管道是指使用管道功能连接的一系列操作。管道中使用的函数需要将一个数据帧作为输入，并返回一个数据帧。</p><p id="a446" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我有一个包含一些模拟数据的数据帧:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="218e" class="ma mb it lw b gy mc md l me mf">import numpy as np<br/>import pandas as pd</span><span id="0da8" class="ma mb it lw b gy mg md l me mf">df = pd.read_csv("sample_dataset.csv")</span><span id="7383" class="ma mb it lw b gy mg md l me mf">df.head()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mh"><img src="../Images/792585d559c3927cda5facb80326f279.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5Ofb8CV_37JkMvkU0MhBhg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">df(作者图片)</p></figure><p id="a91d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下是需要在该数据帧上完成的操作列表:</p><ul class=""><li id="1ce9" class="mi mj it lb b lc ld lf lg li mk lm ml lq mm lu mn mo mp mq bi translated">日期列的数据类型是string，需要将其转换为适当的数据类型。</li><li id="a04a" class="mi mj it lb b lc mr lf ms li mt lm mu lq mv lu mn mo mp mq bi translated">价格列中有缺失值，需要用以前的价格填充。</li><li id="4611" class="mi mj it lb b lc mr lf ms li mt lm mu lq mv lu mn mo mp mq bi translated">销售数量列中有一些异常值，需要删除。</li></ul><p id="f7cf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的管道包含3个步骤。我们首先为上面的任务定义函数。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="325f" class="ma mb it lw b gy mc md l me mf">def handle_dtypes(df):<br/>    df["date"] = df["date"].astype("datetime64[ns]")<br/>    return df</span><span id="d16f" class="ma mb it lw b gy mg md l me mf">def fill_missing_prices(df):<br/>    df["price"].fillna(method="ffill", inplace=True)<br/>    return df</span><span id="1d1c" class="ma mb it lw b gy mg md l me mf">def remove_outliers(df):<br/>    return df[df["sales_qty"] &lt;= 2000].reset_index(drop=True)</span></pre><p id="7410" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里是管道:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="ea03" class="ma mb it lw b gy mc md l me mf">df_processed = (df.<br/>                 pipe(handle_dtypes).<br/>                 pipe(fill_missing_prices).<br/>                 pipe(remove_outliers))</span></pre><p id="a902" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过分别应用这些功能，可以完成相同的操作。但是，管道功能提供了一种结构化和有组织的方式，可以将多个功能合并到一个操作中。</p><p id="df52" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">根据原始数据和任务，预处理可能包括更多步骤。我们可以使用管道功能根据需要添加任意多的步骤。随着步骤数量的增加，与单独执行函数相比，管道函数的语法变得更加清晰。</p><p id="f711" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在有了一个功能管道，所以我们可以从吸头开始。</p></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><h2 id="8f78" class="ma mb it bd nd ne nf dn ng nh ni dp nj li nk nl nm lm nn no np lq nq nr ns nt bi translated">1.独占启动管道</h2><p id="d306" class="pw-post-body-paragraph kz la it lb b lc nu ju le lf nv jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">在下面的管道中，我们将修改后的DataFrame赋给另一个名为“df_processed”的变量。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="f3b4" class="ma mb it lw b gy mc md l me mf">df_processed = (df.<br/>                 pipe(handle_dtypes).<br/>                 pipe(fill_missing_prices).<br/>                 pipe(remove_outliers))</span></pre><p id="c750" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以假设原始数据帧df保持不变。然而，事实并非如此。即使我们将流水线的输出赋给另一个变量，原始的数据帧也会被更新。</p><p id="f0cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这不是一个好的做法，因为我们通常希望保持原始数据对我们可用。解决方案是用一个独占的启动步骤来启动流水线，它只是复制原始的数据帧。</p><p id="6ddb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个步骤可以使用下面的函数来完成。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="0439" class="ma mb it lw b gy mc md l me mf">def start_pipeline(df):<br/>    return df.copy()</span></pre><p id="9067" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们也相应地更新管道。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="35b1" class="ma mb it lw b gy mc md l me mf">df_processed = (df.<br/>                 pipe(start_pipeline).<br/>                 pipe(handle_dtypes).<br/>                 pipe(fill_missing_prices).<br/>                 pipe(remove_outliers))</span></pre><p id="5332" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，无论我们在管道中做什么，原始数据帧都保持不变。</p></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><h2 id="ed0a" class="ma mb it bd nd ne nf dn ng nh ni dp nj li nk nl nm lm nn no np lq nq nr ns nt bi translated">2.添加参数</h2><p id="2ea3" class="pw-post-body-paragraph kz la it lb b lc nu ju le lf nv jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">参数为函数增加了更多的功能和灵活性。我们可能在管道中有带参数的函数。</p><p id="9866" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">酷的是这些参数可以在管道内部访问。我们可以用它们作为管道函数的参数。</p><p id="4a12" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了演示这种情况，让我们通过将检测异常值的阈值作为一个参数，使删除异常值函数更灵活一些。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="8c83" class="ma mb it lw b gy mc md l me mf">def remove_outliers(df, threshold=2000):<br/>    return df[df["sales_qty"] &lt;= threshold].reset_index(drop=True)</span></pre><p id="d8d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">默认值是2000，因此如果我们在管道中不使用该参数，异常值阈值将是2000。</p><p id="aea3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以如下控制流水线中的阈值:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="9bbc" class="ma mb it lw b gy mc md l me mf">df_processed = (df.<br/>                 pipe(start_pipeline).<br/>                 pipe(handle_dtypes).<br/>                 pipe(fill_missing_prices).<br/>                 pipe(remove_outliers, threshold=1500))</span></pre></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><h2 id="92bb" class="ma mb it bd nd ne nf dn ng nh ni dp nj li nk nl nm lm nn no np lq nq nr ns nt bi translated">3.记录</h2><p id="8b06" class="pw-post-body-paragraph kz la it lb b lc nu ju le lf nv jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">我们有一个由4个步骤组成的管道。根据原始数据和手头的任务，我们可能需要创建包含多个步骤的管道。</p><p id="efe6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这样的工作流中，跟踪每一步发生的事情是很重要的，这样在出现问题时就更容易调试。</p><p id="de15" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以通过在每一步之后记录一些信息来实现这一点。在我们的管道中，数据帧的大小告诉我们是否发生了意想不到的事情。</p><p id="cffb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们在管道中应用每一步后打印数据帧的大小。由于这些步骤是函数，我们可以使用Python装饰器来完成这项任务。</p><p id="fe34" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一个<a class="ae ky" href="https://medium.com/p/ac33d6f736cb" rel="noopener">装饰器</a>是一个接受另一个函数并扩展其行为的函数。不修改基本函数。装饰者包装它并添加额外的功能。</p><p id="bad7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是我们将在管道中的函数上使用的装饰器。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="1c39" class="ma mb it lw b gy mc md l me mf">from functools import wraps</span><span id="81b2" class="ma mb it lw b gy mg md l me mf">def logging(func):<br/>    <a class="ae ky" href="http://twitter.com/wraps" rel="noopener ugc nofollow" target="_blank">@</a>wraps(func)<br/>    def wrapper(*args, **kwargs):<br/>        result = func(*args, **kwargs)<br/>        print(f"The size after {func.__name__} is {result.shape}.")<br/>        return result<br/>    return wrapper</span></pre><p id="955c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将如下“装饰”管道中使用的函数:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="a4da" class="ma mb it lw b gy mc md l me mf"><a class="ae ky" href="http://twitter.com/logging" rel="noopener ugc nofollow" target="_blank">@logging</a><br/>def start_pipeline(df):<br/>    return df.copy()</span><span id="9612" class="ma mb it lw b gy mg md l me mf"><a class="ae ky" href="http://twitter.com/logging" rel="noopener ugc nofollow" target="_blank">@logging</a><br/>def handle_dtypes(df):<br/>    df["date"] = df["date"].astype("datetime64[ns]")<br/>    return df</span><span id="68f4" class="ma mb it lw b gy mg md l me mf"><a class="ae ky" href="http://twitter.com/logging" rel="noopener ugc nofollow" target="_blank">@logging</a><br/>def fill_missing_prices(df):<br/>    df["price"].fillna(method="ffill", inplace=True)<br/>    return df</span><span id="4160" class="ma mb it lw b gy mg md l me mf"><a class="ae ky" href="http://twitter.com/logging" rel="noopener ugc nofollow" target="_blank">@logging</a><br/>def remove_outliers(df, threshold=2000):<br/>    return df[df["sales_qty"] &lt;= threshold].reset_index(drop=True)</span></pre><p id="cbde" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们重新运行管道。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="60e8" class="ma mb it lw b gy mc md l me mf">df_processed = (df.<br/>                 pipe(start_pipeline).<br/>                 pipe(handle_dtypes).<br/>                 pipe(fill_missing_prices).<br/>                 pipe(remove_outliers, threshold=1500))</span><span id="d5de" class="ma mb it lw b gy mg md l me mf"><strong class="lw iu"># output</strong><br/>The size after start_pipeline is (1000, 3).<br/>The size after handle_dtypes is (1000, 3).<br/>The size after fill_missing_prices is (1000, 3).<br/>The size after remove_outliers is (997, 3).</span></pre><p id="2e45" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在有了一个输出，它告诉我们管道中的流程。您可以定制日志记录功能，并添加一些其他功能，如测量函数执行所需的时间。</p></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><p id="ee91" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nz">你可以成为</em> <a class="ae ky" href="https://sonery.medium.com/membership" rel="noopener"> <em class="nz">媒介会员</em> </a> <em class="nz">解锁我的全部写作权限，外加其余媒介。如果你已经是了，别忘了订阅<em class="nz"/><em class="nz">如果你想在我发表新文章时收到电子邮件。</em></em></p></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><h2 id="cd1a" class="ma mb it bd nd ne nf dn ng nh ni dp nj li nk nl nm lm nn no np lq nq nr ns nt bi translated">结论</h2><p id="ae24" class="pw-post-body-paragraph kz la it lb b lc nu ju le lf nv jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">管道非常适合组织数据清理和处理工作流。我们在本文中所做的例子似乎很容易通过分别应用函数来处理。然而，考虑到我们有超过10个步骤应用于原始数据。与使用管道相比，用单独的函数处理它们调试起来有点麻烦和乏味。</p></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><p id="9b79" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢您的阅读。如果您有任何反馈，请告诉我。</p></div></div>    
</body>
</html>