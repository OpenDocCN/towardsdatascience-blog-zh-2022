<html>
<head>
<title>Apache Airflow for Data Science — How to Download Files from Amazon S3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Apache Airflow for Data Science —如何从亚马逊 S3 下载文件</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/apache-airflow-for-data-science-how-to-download-files-from-amazon-s3-4b7662ac6cdc#2022-03-28">https://towardsdatascience.com/apache-airflow-for-data-science-how-to-download-files-from-amazon-s3-4b7662ac6cdc#2022-03-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="fec1" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated"><strong class="ak">用几行 Python 代码从亚马逊 S3 (AWS)下载任何文件</strong></h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/688bfa330a779b32be1c888650bb07cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*um02xmZj__WlcdzA"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@imgix?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> imgix </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="9b81" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，你知道如何用 Apache Airflow 将本地文件上传到亚马逊 S3。但是你怎么能反过来呢？有没有从亚马逊 S3 下载文件的简单方法？当然有，今天你会了解到一切。读完之后，你会知道如何通过 Apache Airflow 从 S3 下载任何文件，以及如何控制其路径和名称。</p><p id="f917" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">推荐阅读<a class="ae ky" rel="noopener" target="_blank" href="/apache-airflow-for-data-science-how-to-upload-files-to-amazon-s3-5bdf6fcb1cea">上一篇文章</a>，因为我们不会再重复 S3 桶和配置设置。确保您已经创建了一个 bucket，并且至少上传了一个文件。a</p><p id="edf3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不想看书？请观看我的视频:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="a87b" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">配置 S3 铲斗和气流连接</h1><p id="9abb" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">正如在简介部分提到的，您应该配置一个 S3 存储桶，并至少向其中上传一个文件。这是我的<code class="fe nb nc nd ne b">bds-airflow-bucket</code>和一个<code class="fe nb nc nd ne b">posts.json</code>文件:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/7c56c347b430fde12b16e5c792fae12a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7aUfpkKRa_HjKeTFCuLH9g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 1 —存储了单个对象的亚马逊 S3 桶(图片由作者提供)</p></figure><p id="5c67" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，在 Airflow 服务器主页上，您应该配置了一个 S3 连接。你可以在<em class="ng">管理</em> — <em class="ng">人脉</em>下找到。请确保按如下方式进行配置:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/e17db8b89bef672605017559562731be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kS0HE-T-yC3wca6b_duydw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 2——气流亚马逊 S3 连接(图片由作者提供)</p></figure><p id="2299" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是我们从 S3 桶中下载文件所需的全部内容，接下来让我们开始吧。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="3ed4" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">写气流 DAG</h1><p id="f241" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">在<code class="fe nb nc nd ne b">~/airflow/dags</code>文件夹中新建一个 Python 文件。我已经把我的命名为<code class="fe nb nc nd ne b">s3_download.py</code>。我们将从库导入和 DAG 样板代码开始。像以前一样，您将需要<code class="fe nb nc nd ne b">S3Hook</code>类来与 S3 桶通信:</p><pre class="kj kk kl km gt nh ne ni nj aw nk bi"><span id="0e67" class="nl mf it ne b gy nm nn l no np">import os<br/>from datetime import datetime<br/>from airflow.models import DAG<br/>from airflow.operators.python import PythonOperator<br/>from airflow.providers.amazon.aws.hooks.s3 import S3Hook<br/><br/><br/>with DAG(<br/>    dag_id='s3_download',<br/>    schedule_interval='@daily',<br/>    start_date=datetime(2022, 3, 1),<br/>    catchup=False<br/>) as dag:<br/>    pass</span></pre><p id="a0a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下载文件归结为声明一个基于<code class="fe nb nc nd ne b">PythonOperator</code>的任务。它将调用接受三个参数的<code class="fe nb nc nd ne b">download_from_s3()</code>函数:</p><ul class=""><li id="df73" class="nq nr it lb b lc ld lf lg li ns lm nt lq nu lu nv nw nx ny bi translated"><code class="fe nb nc nd ne b">key</code> -字符串，S3 上文件的名称/路径。例如，<code class="fe nb nc nd ne b">posts.json</code>将从 bucket 的根抓取文件。也可以指定路径，比如<code class="fe nb nc nd ne b">/data/posts/posts.json</code>。确保与您的案例相符。</li><li id="7c1e" class="nq nr it lb b lc nz lf oa li ob lm oc lq od lu nv nw nx ny bi translated"><code class="fe nb nc nd ne b">bucket_name</code> -字符串，您要从其下载文件的桶的名称。</li><li id="8409" class="nq nr it lb b lc nz lf oa li ob lm oc lq od lu nv nw nx ny bi translated"><code class="fe nb nc nd ne b">local_path</code> - string，文件将要保存到的目录。请注意，这是一个目录路径，而不是文件路径。</li></ul><p id="5c75" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">同一个函数首先创建一个<code class="fe nb nc nd ne b">S3Hook</code>类的实例，并使用之前建立的连接。然后，它调用钩子实例的<code class="fe nb nc nd ne b">download_file()</code>方法来下载文件。</p><p id="7fde" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该函数返回一个字符串，它是从 S3 下载的文件的绝对路径。请务必归还，因为您以后会需要它:</p><pre class="kj kk kl km gt nh ne ni nj aw nk bi"><span id="6480" class="nl mf it ne b gy nm nn l no np">import os<br/>...<br/><br/><br/>def download_from_s3(key: str, bucket_name: str, local_path: str) -&gt; str:<br/>    hook = S3Hook('s3_conn')<br/>    file_name = hook.download_file(key=key, bucket_name=bucket_name, local_path=local_path)<br/>    return file_name<br/>    <br/>    <br/> with DAG(...) as dag:<br/>    # Download a file<br/>    task_download_from_s3 = PythonOperator(<br/>        task_id='download_from_s3',<br/>        python_callable=download_from_s3,<br/>        op_kwargs={<br/>            'key': 'posts.json',<br/>            'bucket_name': 'bds-airflow-bucket',<br/>            'local_path': '/Users/dradecic/airflow/data/'<br/>        }<br/>    )</span></pre><p id="34b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">问题是这样的— <code class="fe nb nc nd ne b">S3Hook</code>下载一个文件到<code class="fe nb nc nd ne b">local_path</code>文件夹，并给它一个没有任何扩展名的任意名称。我们不希望这样，所以我们将声明另一个重命名文件的任务。</p><p id="9639" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它从<a class="ae ky" href="https://betterdatascience.com/apache-airflow-xcoms/" rel="noopener ugc nofollow" target="_blank"> Airflow XComs </a>中获取绝对路径，删除文件名，并附加<code class="fe nb nc nd ne b">new_name</code>:</p><pre class="kj kk kl km gt nh ne ni nj aw nk bi"><span id="ec0e" class="nl mf it ne b gy nm nn l no np">import os<br/>...<br/><br/><br/>def download_from_s3(key: str, bucket_name: str, local_path: str) -&gt; str:<br/>    ...<br/>    <br/>    <br/>def rename_file(ti, new_name: str) -&gt; None:<br/>    downloaded_file_name = ti.xcom_pull(task_ids=['download_from_s3'])<br/>    downloaded_file_path = '/'.join(downloaded_file_name[0].split('/')[:-1])<br/>    os.rename(src=downloaded_file_name[0], dst=f"{downloaded_file_path}/{new_name}")<br/>    <br/>    <br/> with DAG(...) as dag:<br/>    # Download a file<br/>    task_download_from_s3 = PythonOperator(...)<br/>    <br/>    # Rename the file<br/>    task_rename_file = PythonOperator(<br/>        task_id='rename_file',<br/>        python_callable=rename_file,<br/>        op_kwargs={<br/>            'new_name': 's3_downloaded_posts.json'<br/>        }<br/>    )<br/><br/>    task_download_from_s3 &gt;&gt; task_rename_file</span></pre><p id="9d72" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们现在测试他们两个。</p><p id="0f4a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们必须从 S3 下载文件:</p><pre class="kj kk kl km gt nh ne ni nj aw nk bi"><span id="d7bc" class="nl mf it ne b gy nm nn l no np">airflow tasks test s3_download download_from_s3 2022-3-1</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/e6bd93be672c6c9d7e9f84416914563b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3TGDyuwt5q-P1eqF-w7L4Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 3 —测试 download_from_s3 任务(图片由作者提供)</p></figure><p id="5813" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如你所见，Airflow 将文件从 S3 保存到了<code class="fe nb nc nd ne b">/Users/dradecic/airflow/data/airflow_tmp_0xrx7pyi</code>，这是一个完全随机的文件名。</p><p id="cffc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第二个任务是在这里将其重命名为<code class="fe nb nc nd ne b">s3_downloaded_posts.json</code>:</p><pre class="kj kk kl km gt nh ne ni nj aw nk bi"><span id="4efe" class="nl mf it ne b gy nm nn l no np">airflow tasks test s3_download rename_file 2022-3-1</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/bcac1e20a34b79d5f52902571674006c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZcrJ6U0pCLx_bA6KTXYJdg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 4 —测试 rename_file 任务(作者图片)</p></figure><p id="c8f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">任务成功完成，这意味着我们应该在<code class="fe nb nc nd ne b">data</code>文件夹中看到该文件:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/21ee32d57b1c86f3551c0c56c7cc0ff3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3_sPVfsQY6y-uixaIa09TQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片 5 —下载文件的内容(图片由作者提供)</p></figure><p id="e791" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成了。我们已经对整个 DAG 进行了编码和测试。在结束这篇文章之前，让我们做一个简短的回顾。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="1020" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">结论</h1><p id="acf7" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">用 Airflow 从亚马逊 S3 下载文件就像上传文件一样简单。这都归结为一个函数调用——不是<code class="fe nb nc nd ne b">load_file()</code>就是<code class="fe nb nc nd ne b">download_file()</code>。你现在知道如何做到这两点，以及如何处理可能出现的潜在问题。</p><p id="f888" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请继续关注 Apache Airflow 系列的后续文章。</p><h2 id="a06e" class="nl mf it bd mg og oh dn mk oi oj dp mo li ok ol mq lm om on ms lq oo op mu oq bi translated">推荐阅读</h2><ul class=""><li id="fb45" class="nq nr it lb b lc mw lf mx li or lm os lq ot lu nv nw nx ny bi translated"><a class="ae ky" href="https://betterdatascience.com/best-data-science-prerequisite-books/" rel="noopener ugc nofollow" target="_blank">学习数据科学先决条件(数学、统计和编程)的 5 本最佳书籍</a></li><li id="5f41" class="nq nr it lb b lc nz lf oa li ob lm oc lq od lu nv nw nx ny bi translated"><a class="ae ky" href="https://betterdatascience.com/top-books-to-learn-data-science/" rel="noopener ugc nofollow" target="_blank">2022 年学习数据科学的前 5 本书</a></li><li id="4c6c" class="nq nr it lb b lc nz lf oa li ob lm oc lq od lu nv nw nx ny bi translated"><a class="ae ky" href="https://betterdatascience.com/apache-airflow-install/" rel="noopener ugc nofollow" target="_blank">如何在本地安装 Apache air flow</a></li></ul><h2 id="e816" class="nl mf it bd mg og oh dn mk oi oj dp mo li ok ol mq lm om on ms lq oo op mu oq bi translated">保持联系</h2><ul class=""><li id="9931" class="nq nr it lb b lc mw lf mx li or lm os lq ot lu nv nw nx ny bi translated">雇用我作为一名技术作家</li><li id="1fa4" class="nq nr it lb b lc nz lf oa li ob lm oc lq od lu nv nw nx ny bi translated">订阅<a class="ae ky" href="https://www.youtube.com/c/BetterDataScience" rel="noopener ugc nofollow" target="_blank"> YouTube </a></li><li id="d0c3" class="nq nr it lb b lc nz lf oa li ob lm oc lq od lu nv nw nx ny bi translated">在<a class="ae ky" href="https://www.linkedin.com/in/darioradecic/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上连接</li></ul></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><p id="0a1b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="ng">喜欢这篇文章吗？成为</em> <a class="ae ky" href="https://medium.com/@radecicdario/membership" rel="noopener"> <em class="ng">中等会员</em> </a> <em class="ng">继续无限制学习。如果你使用下面的链接，我会收到你的一部分会员费，不需要你额外付费。</em></p><div class="ou ov gp gr ow ox"><a href="https://medium.com/@radecicdario/membership" rel="noopener follow" target="_blank"><div class="oy ab fo"><div class="oz ab pa cl cj pb"><h2 class="bd iu gy z fp pc fr fs pd fu fw is bi translated">通过我的推荐链接加入 Medium-Dario rade ci</h2><div class="pe l"><h3 class="bd b gy z fp pc fr fs pd fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="pf l"><p class="bd b dl z fp pc fr fs pd fu fw dk translated">medium.com</p></div></div><div class="pg l"><div class="ph l pi pj pk pg pl ks ox"/></div></div></a></div></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><p id="23e6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="ng">原载于 2022 年 3 月 28 日 https://betterdatascience.com</em><a class="ae ky" href="https://betterdatascience.com/apache-airflow-amazon-s3-download/" rel="noopener ugc nofollow" target="_blank"><em class="ng"/></a><em class="ng">。</em></p></div></div>    
</body>
</html>