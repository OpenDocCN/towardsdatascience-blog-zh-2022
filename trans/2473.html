<html>
<head>
<title>How to Forecast Time Series With Multiple Seasonalities</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何预测具有多重季节性的时间序列</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-forecast-time-series-with-multiple-seasonalities-23c77152347e#2022-05-30">https://towardsdatascience.com/how-to-forecast-time-series-with-multiple-seasonalities-23c77152347e#2022-05-30</a></blockquote><div><div class="fc ij ik il im in"/><div class="io ip iq ir is"><div class=""/><div class=""><h2 id="fbb9" class="pw-subtitle-paragraph js iu iv bd b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj dk translated">在Python中使用BATS和TBATS模型的实践示例</h2></div><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi kk"><img src="../Images/c421c97059cdc77ca9c33afb427a2b87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HqXGxvuE-x0ELV8o"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">阿里·科卡布在<a class="ae la" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="29ee" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">在处理时间序列时，我们经常会遇到季节性。<strong class="ld iw">季节性</strong>在我们的系列中被定义为周期性变化。在我们的系列中，这是一个在固定周期内发生的循环。例如，让我们看看下面显示的流行的航空公司数据集。</p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi lx"><img src="../Images/6c61f15714af361a0d8b73f6d5d3e00b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8X81fVPQmu2quEeqNH9rgw.png"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">一家航空公司从1949年1月到1960年12月的每月乘客总数。我们注意到这个系列有一个明显的季节性模式，更多的人在六月、七月和八月旅行(图片由作者提供)</p></figure><p id="8e53" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">在这里，我们可以清楚地看到一个季节性周期，因为每年的7月份左右，航空旅客人数达到高峰，然后再次下降。</p><p id="0da3" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">为了预测这个系列，我们可以简单地使用一个<a class="ae la" rel="noopener" target="_blank" href="/time-series-forecasting-with-sarima-in-python-cda5b793977b"> SARIMA模型</a>，因为只有一个长达一年的季节周期。</p><p id="690b" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">现在，当我们处理高频数据时，事情变得复杂了。例如，每小时的时间序列可以表现出每日、每周、每月和每年的季节性，这意味着我们现在有多个季节周期。看看下面94号州际公路每小时的交通量。</p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi ly"><img src="../Images/1e183228458009fb2de936702c6e81ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GEZihkNDxAUBDK5cbBFK3A.png"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">明尼苏达州明尼阿波利斯94号州际公路西行每小时交通量。在这里，我们既可以看到每日的季节性(白天行驶的汽车比晚上多)，也可以看到每周的季节性(周一至周五行驶的汽车比周末多)。作者图片</p></figure><p id="0147" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">看上面的数据，我们可以看到我们有两个季节周期！首先，我们有一个每日季节性，因为我们看到更多的汽车在白天行驶，而不是在晚上。第二，我们有一个周季节性，因为交通流量在工作日高于周末。</p><p id="d443" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">在这种情况下，不能使用SARIMA模型，因为我们只能指定一个季节周期，而我们的数据中肯定有两个季节周期:每日季节性和每周季节性。</p><p id="aa33" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">因此，我们将注意力转向<strong class="ld iw">球棒</strong>和<strong class="ld iw">球棒</strong>型号。使用这些模型，我们可以拟合和预测具有多个季节周期的时间序列。</p><p id="329c" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">在本文中，我们首先探索bat和TBATS背后的理论，然后应用它们来预测未来七天的每小时交通量。我们开始吧！</p><blockquote class="lz"><p id="ecc8" class="ma mb iv bd mc md me mf mg mh mi lw dk translated">通过Python 中的<a class="ae la" href="https://www.datasciencewithmarco.com/offers/tdU2mtVK" rel="noopener ugc nofollow" target="_blank">应用时间序列分析，学习最新的时间序列分析技术。课程涵盖统计和深度学习模型，你将使用Python和TensorFlow！</a></p></blockquote><h1 id="8161" class="mj mk iv bd ml mm mn mo mp mq mr ms mt kb mu kc mv ke mw kf mx kh my ki mz na bi translated">蝙蝠和蝙蝠背后的直觉</h1><p id="3267" class="pw-post-body-paragraph lb lc iv ld b le nb jw lg lh nc jz lj lk nd lm ln lo ne lq lr ls nf lu lv lw io bi translated">在我们深入项目之前，让我们先了解一下蝙蝠和TBATS是如何在幕后工作的。</p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/8953f1d7dc51dedc1773616874c17912.png" data-original-src="https://miro.medium.com/v2/resize:fit:1186/format:webp/1*sxmFanWbH0_ChRF8GkE4ng.jpeg"/></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">我保证这个理论没那么糟糕(图片由作者提供)</p></figure><h2 id="76b9" class="nh mk iv bd ml ni nj dn mp nk nl dp mt lk nm nn mv lo no np mx ls nq nr mz ns bi translated">蝙蝠</h2><p id="5bd8" class="pw-post-body-paragraph lb lc iv ld b le nb jw lg lh nc jz lj lk nd lm ln lo ne lq lr ls nf lu lv lw io bi translated">首字母缩写BATS指的是该方法:具有<strong class="ld iw"> B </strong> ox-Cox变换、<strong class="ld iw"> A </strong> RMA误差、<strong class="ld iw"> T </strong> rend、<strong class="ld iw"> S </strong>季节分量的指数平滑状态空间模型。这里有很多需要剖析的地方，所以我们一步一步来。</p><ul class=""><li id="dace" class="nt nu iv ld b le lf lh li lk nv lo nw ls nx lw ny nz oa ob bi translated">指数平滑法是一种预测方法。这些预测方法背后的一般思想是，未来值是过去值的加权平均值，随着我们回到过去，权重呈指数衰减。预测方法包括简单指数平滑法、双指数平滑法或霍尔特法(用于有趋势的时间序列)，以及三指数平滑法或霍尔特-温特法(用于有趋势和季节性的时间序列)。</li><li id="bf3f" class="nt nu iv ld b le oc lh od lk oe lo of ls og lw ny nz oa ob bi translated">状态空间建模是一个框架，在这个框架中，时间序列被视为一组受一组未观察到的因素影响的观察数据。然后，状态空间模型表示这两个集合之间的关系。同样，这必须被视为一个框架，因为ARMA模型可以表示为一个状态空间模型。</li><li id="4299" class="nt nu iv ld b le oc lh od lk oe lo of ls og lw ny nz oa ob bi translated">Box-Cox变换是一种幂变换，它通过稳定一段时间内的方差和均值来帮助使序列平稳。</li><li id="f7c8" class="nt nu iv ld b le oc lh od lk oe lo of ls og lw ny nz oa ob bi translated">ARMA误差是我们对时间序列的残差应用ARMA模型以发现任何无法解释的关系的过程。通常，模型的残差应该是完全随机的，除非模型没有捕捉到某些信息。这里，我们使用ARMA模型来捕捉残差中的任何剩余信息。</li><li id="8281" class="nt nu iv ld b le oc lh od lk oe lo of ls og lw ny nz oa ob bi translated">趋势是时间序列的一个组成部分，它解释了序列平均值的长期变化。当我们有一个积极的趋势，那么我们的系列是随着时间的推移而增加。如果趋势为负，则该系列会随着时间的推移而减少。</li><li id="8e01" class="nt nu iv ld b le oc lh od lk oe lo of ls og lw ny nz oa ob bi translated">季节因素解释了序列中的周期性变化。</li></ul><p id="f25d" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">总之，BATS是指数平滑方法的扩展，它结合了Box-Cox变换来处理非线性数据，并使用ARMA模型来捕捉残差中的自相关。</p><p id="2dc6" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">使用BATS的优势在于它可以处理非线性数据，解决残差中的自相关问题，因为它使用了ARMA模型，并且它可以考虑多个季节周期。</p><p id="7757" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">但是，季节周期必须是整数，否则不能应用bat。例如，假设您有带有年度季节性的周数据，那么您的周期是365.25/7，大约是52.2。那样的话，蝙蝠就被排除了。</p><p id="ae1f" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">此外，如果季节周期非常长，BATS可能需要很长时间来拟合，这意味着如果您有每月的小时数据(周期将是730)，则不适合。</p><p id="6700" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">因此，开发了TBATS模型来解决这种情况。</p><h2 id="035b" class="nh mk iv bd ml ni nj dn mp nk nl dp mt lk nm nn mv lo no np mx ls nq nr mz ns bi translated">TBATS</h2><p id="b230" class="pw-post-body-paragraph lb lc iv ld b le nb jw lg lh nc jz lj lk nd lm ln lo ne lq lr ls nf lu lv lw io bi translated">缩写TBATS代表<strong class="ld iw"> T </strong> rigonometric季节性，<strong class="ld iw"> B </strong> ox-Cox变换，<strong class="ld iw"> A </strong> RMA误差，<strong class="ld iw"> T </strong>趋势，以及<strong class="ld iw"> S </strong>季节性成分。</p><p id="9dba" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">它使用与BATS模型相同的组件，但是它将每个季节周期表示为基于傅立叶级数的三角表示。这使得模型能够适应大的季节周期和非整数的季节周期。</p><p id="fb71" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">因此，在处理高频数据时，它是一个更好的选择，并且通常比bat更适合。</p><p id="5696" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">在这里，我故意避开数学，以避免任何混淆。关于蝙蝠和TBATS的详细数学解释，我建议你阅读<a class="ae la" href="https://www.researchgate.net/profile/Naragain-Phumchusri/publication/337650959_Hotel_daily_demand_forecasting_for_high-frequency_and_complex_seasonality_data_a_case_study_in_Thailand/links/614c708e3c6cb310698802f4/Hotel-daily-demand-forecasting-for-high-frequency-and-complex-seasonality-data-a-case-study-in-Thailand.pdf" rel="noopener ugc nofollow" target="_blank">这篇论文</a>。</p><p id="a042" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">现在我们对这两个模型的工作原理有了一个直觉，让我们应用它们来预测未来七天的每小时交通量。</p><h1 id="5eda" class="mj mk iv bd ml mm mn mo mp mq mr ms mt kb oh kc mv ke oi kf mx kh oj ki mz na bi translated">在Python中应用bat和TBATS</h1><p id="d84c" class="pw-post-body-paragraph lb lc iv ld b le nb jw lg lh nc jz lj lk nd lm ln lo ne lq lr ls nf lu lv lw io bi translated">让我们看看这两个模型在预测每小时交通量时的作用。你可以参考<a class="ae la" href="https://github.com/marcopeix/time-series-analysis" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上的完整源代码。</p><h2 id="a981" class="nh mk iv bd ml ni nj dn mp nk nl dp mt lk nm nn mv lo no np mx ls nq nr mz ns bi translated">探测</h2><p id="4033" class="pw-post-body-paragraph lb lc iv ld b le nb jw lg lh nc jz lj lk nd lm ln lo ne lq lr ls nf lu lv lw io bi translated">首先，我们导入这个项目所需的库。</p><pre class="kl km kn ko gt ok ol om on aw oo bi"><span id="4225" class="nh mk iv ol b gy op oq l or os">import pandas as pd<br/>import numpy as np<br/>import matplotlib.pyplot as plt</span></pre><p id="450c" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">然后，我们读取包含数据的CSV文件。注意，你也可以从<a class="ae la" href="https://github.com/marcopeix/time-series-analysis" rel="noopener ugc nofollow" target="_blank"> GitHub </a>下载。</p><pre class="kl km kn ko gt ok ol om on aw oo bi"><span id="1421" class="nh mk iv ol b gy op oq l or os">data = pd.read_csv(‘daily_traffic.csv’)<br/>data = data.dropna()</span></pre><p id="e30b" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">太好了！完成后，我们现在可以可视化我们的数据。</p><pre class="kl km kn ko gt ok ol om on aw oo bi"><span id="7454" class="nh mk iv ol b gy op oq l or os">fig, ax = plt.subplots(figsize=(14, 8))</span><span id="dfa2" class="nh mk iv ol b gy ot oq l or os">ax.plot(data['traffic_volume'])<br/>ax.set_xlabel('Time')<br/>ax.set_ylabel('Traffic volume')</span><span id="781f" class="nh mk iv ol b gy ot oq l or os">fig.autofmt_xdate()<br/>plt.tight_layout()</span><span id="b956" class="nh mk iv ol b gy ot oq l or os">plt.show()</span></pre><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi ly"><img src="../Images/2a396c9da8a0e31998d3f363f6d502e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QFki--TAeOT_YRovzHSlGQ.png"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">明尼苏达州明尼阿波利斯市94号州际公路每小时的交通量(图片由作者提供)</p></figure><p id="3dc4" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">从上图中，我们可以清楚地看到我们有两个季节周期。让我们放大并标记一周中的每一天，以标识这两个时间段。</p><pre class="kl km kn ko gt ok ol om on aw oo bi"><span id="a5f2" class="nh mk iv ol b gy op oq l or os">fig, ax = plt.subplots(figsize=(14, 8))</span><span id="80a1" class="nh mk iv ol b gy ot oq l or os">ax.plot(data['traffic_volume'])<br/>ax.set_xlabel('Time')<br/>ax.set_ylabel('Traffic volume')</span><span id="92ee" class="nh mk iv ol b gy ot oq l or os">plt.xticks(np.arange(7, 400, 24), ['Friday', 'Saturday', 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'])<br/>plt.xlim(0, 400)</span><span id="585f" class="nh mk iv ol b gy ot oq l or os">fig.autofmt_xdate()<br/>plt.tight_layout()</span><span id="3641" class="nh mk iv ol b gy ot oq l or os">plt.show()</span></pre><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi ly"><img src="../Images/1e183228458009fb2de936702c6e81ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GEZihkNDxAUBDK5cbBFK3A.png"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">明尼苏达州明尼阿波利斯94号州际公路西行每小时交通量。在这里，我们既可以看到每日的季节性(白天行驶的汽车比晚上多)，也可以看到每周的季节性(周一至周五行驶的汽车比周末多)。作者图片</p></figure><p id="c4e6" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">当然，我们从本文开始就认识到了这个情节，并注意到周末的交通量确实比平日低。此外，我们看到了每日的季节性，白天的交通比晚上更繁忙。</p><p id="b960" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">因此，我们有两个时段:日时段的长度为24小时，周时段的长度为168小时。让我们在继续建模时记住这一点。</p><h2 id="d66c" class="nh mk iv bd ml ni nj dn mp nk nl dp mt lk nm nn mv lo no np mx ls nq nr mz ns bi translated">建模</h2><p id="1bfa" class="pw-post-body-paragraph lb lc iv ld b le nb jw lg lh nc jz lj lk nd lm ln lo ne lq lr ls nf lu lv lw io bi translated">我们现在准备开始建模我们的数据。这里我们用的是<a class="ae la" href="https://www.sktime.org/en/stable/" rel="noopener ugc nofollow" target="_blank"> <em class="ou"> sktime </em> </a>包。我刚刚发现了这个框架，它为时间序列带来了许多统计和机器学习方法。它还使用了与<em class="ou"> scikit-learn </em>相似的语法约定，使其易于使用。</p><p id="c25a" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">第一步是定义我们的目标和预测范围。这里，目标是交通量本身。对于预测范围，我们希望预测一周的数据。因为我们有每小时的数据，所以我们必须预测未来的168个时间步(7 * 24)。</p><pre class="kl km kn ko gt ok ol om on aw oo bi"><span id="ce98" class="nh mk iv ol b gy op oq l or os">y = data['traffic_volume']</span><span id="54e8" class="nh mk iv ol b gy ot oq l or os">fh = np.arange(1, 168)</span></pre><p id="260b" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">然后，我们将数据分成训练集和测试集。我们将保留上周的数据作为测试集，以便评估我们的预测。</p><p id="d6eb" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">这里，我们使用来自<em class="ou"> sktime </em>的<em class="ou">temporal _ train _ test _ split</em>函数。</p><pre class="kl km kn ko gt ok ol om on aw oo bi"><span id="fa99" class="nh mk iv ol b gy op oq l or os">from sktime.forecasting.model_selection import temporal_train_test_split</span><span id="0b5a" class="nh mk iv ol b gy ot oq l or os">y_train, y_test = temporal_train_test_split(y, test_size=168)</span></pre><p id="0139" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">可选地，我们可以可视化我们的测试集。</p><pre class="kl km kn ko gt ok ol om on aw oo bi"><span id="da50" class="nh mk iv ol b gy op oq l or os">fig, ax = plt.subplots(figsize=(14, 8))</span><span id="2313" class="nh mk iv ol b gy ot oq l or os">ax.plot(y_train, ls='-', label='Train')<br/>ax.plot(y_test, ls='--', label='Test')<br/>ax.set_xlabel('time')<br/>ax.set_ylabel('Daily traffic volu,e')<br/>ax.legend(loc='best')</span><span id="db3f" class="nh mk iv ol b gy ot oq l or os">fig.autofmt_xdate()<br/>plt.tight_layout()</span><span id="a1d4" class="nh mk iv ol b gy ot oq l or os">plt.show()</span></pre><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi ly"><img src="../Images/79829a750fbd0898633760a25e0f95e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cFwpz0kw2-qJnYsixa04XA.png"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">可视化训练集和测试集。测试只是最后一周的数据，如橙色虚线所示。剩下的用于拟合模型(图片由作者提供)。</p></figure><p id="e84c" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated"><strong class="ld iw">基线模型</strong></p><p id="434d" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">在我们实现更复杂的bat和TBATS模型之前，拥有一个基线模型总是一个好主意。这样，我们可以确定我们更复杂的预测方法实际上是否有效。</p><p id="613a" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">在这里，我能想到的最简单的基线就是简单地将训练集中上周的数据重复到未来。</p><pre class="kl km kn ko gt ok ol om on aw oo bi"><span id="b3b3" class="nh mk iv ol b gy op oq l or os">y_pred_baseline = y_train[-168:].values</span></pre><p id="5a94" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated"><strong class="ld iw">使用球棒</strong></p><p id="aedc" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">现在我们有了一个基线，让我们继续实现BATS模型。</p><p id="fd73" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">我们首先从<em class="ou"> sktime </em>导入BATS模型。然后，我们指定模型的参数进行训练。在这里，我们希望使用Box-Cox变换来处理非线性数据。然后，由于我们的数据集没有明显的趋势，我们从模型中删除这些组件。最后，我们指定季节周期，即24(表示每日季节性)和168(表示每周季节性)。</p><p id="b2b1" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">一旦指定了模型，我们只需将其放在训练集上，并在预测范围内生成预测。</p><p id="2310" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">上面概述的所有步骤都转化为下面的代码。</p><pre class="kl km kn ko gt ok ol om on aw oo bi"><span id="165e" class="nh mk iv ol b gy op oq l or os">from sktime.forecasting.bats import BATS</span><span id="ad85" class="nh mk iv ol b gy ot oq l or os">forecaster = BATS(use_box_cox=True,<br/>                  use_trend=False,<br/>                  use_damped_trend=False,<br/>                  sp=[24, 168])<br/>forecaster.fit(y_train)</span><span id="52c7" class="nh mk iv ol b gy ot oq l or os">y_pred_BATS = forecaster.predict(fh)</span></pre><p id="46d8" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated"><strong class="ld iw">应用TBATS </strong></p><p id="1c88" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">使用TBATS进行预测就像使用蝙蝠一样，只是现在，嗯…我们使用TBATS！</p><pre class="kl km kn ko gt ok ol om on aw oo bi"><span id="7195" class="nh mk iv ol b gy op oq l or os">from sktime.forecasting.tbats import TBATS</span><span id="be95" class="nh mk iv ol b gy ot oq l or os">forecaster = TBATS(use_box_cox=True,<br/>                   use_trend=False,<br/>                   use_damped_trend=False,<br/>                   sp=[24, 168])<br/>forecaster.fit(y_train)</span><span id="5558" class="nh mk iv ol b gy ot oq l or os">y_pred_TBATS = forecaster.predict(fh)</span></pre><h2 id="11c5" class="nh mk iv bd ml ni nj dn mp nk nl dp mt lk nm nn mv lo no np mx ls nq nr mz ns bi translated">评估绩效</h2><p id="a48b" class="pw-post-body-paragraph lb lc iv ld b le nb jw lg lh nc jz lj lk nd lm ln lo ne lq lr ls nf lu lv lw io bi translated">在这一点上，我们有来自基线模型、蝙蝠和TBATS的预测。然后我们准备好可视化预测，看看哪个模型表现最好。</p><p id="03ff" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">可视化的预测给出了下面的图。</p><pre class="kl km kn ko gt ok ol om on aw oo bi"><span id="b670" class="nh mk iv ol b gy op oq l or os">fig, ax = plt.subplots(figsize=(14, 8))</span><span id="fd27" class="nh mk iv ol b gy ot oq l or os">ax.plot(y_train, ls='-', label='Train')<br/>ax.plot(y_test, ls='-', label='Test')<br/>ax.plot(y_test.index, y_pred_baseline, ls=':', label='Baseline')<br/>ax.plot(y_pred_BATS, ls='--', label='BATS')<br/>ax.plot(y_pred_TBATS, ls='-.', label='TBATS')<br/>ax.set_xlabel('time')<br/>ax.set_ylabel('Daily traffic volume')<br/>ax.legend(loc='best')</span><span id="967e" class="nh mk iv ol b gy ot oq l or os">fig.autofmt_xdate()<br/>plt.tight_layout()</span><span id="ffe7" class="nh mk iv ol b gy ot oq l or os">plt.show()</span></pre><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi ly"><img src="../Images/8b1af5d672cfefbac059b93eba5e1599.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DXiuKJtjsWyCAURmRAegiQ.png"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">预测未来168小时的交通量。我们可以看到，所有模型似乎都产生了类似的预测，因为这些线相互重叠。看剧情很难知道哪种模式表现最好。(图片由作者提供)</p></figure><p id="0f8e" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">看上面的图，似乎我们所有的模型都产生了非常相似的预测，因为线是重叠的。仅仅通过查看图很难确定哪个模型表现最好。</p><p id="9d36" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">我们可以有选择地放大测试集，以便更好地可视化预测。</p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi ly"><img src="../Images/ee27f9a0af5bb70dccb184174f263e57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DugWww4Gftz6Prs-Zvcb4Q.png"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">放大测试集。在这里，蝙蝠似乎在模拟两个季节方面做得很好，而t BATS有时会过冲或欠冲。请注意，基线也很好地遵循了实际值。(图片由作者提供)</p></figure><p id="b2c9" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">看上面的图，我们首先注意到两个模型确实模拟了双重季节性，这本身就很好！此外，蝙蝠似乎在预测未来方面做得更好，因为t BATS有时似乎过冲或欠冲。还要注意基线模型紧密地跟随实际值的曲线。</p><p id="97f2" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">我们现在计算一个误差度量来确定最佳模型并比较它们的性能。在这种情况下，为了便于解释，我们使用平均绝对百分比误差(MAPE)。回想一下，MAPE越接近0，性能越好。</p><p id="b135" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">MAPE还没有在<em class="ou"> scikit-learn </em>中实现，所以我们自己定义函数。</p><pre class="kl km kn ko gt ok ol om on aw oo bi"><span id="b8f0" class="nh mk iv ol b gy op oq l or os">def mape(y_true, y_pred):<br/>    return round(np.mean(np.abs((y_true - y_pred) / y_true)) * 100,2)</span></pre><p id="288c" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">然后，我们简单地计算每个模型的性能，并在条形图中显示出来。</p><pre class="kl km kn ko gt ok ol om on aw oo bi"><span id="fd35" class="nh mk iv ol b gy op oq l or os">mape_baseline = mape(y_test, y_pred_baseline)<br/>mape_BATS = mape(y_test, y_pred_BATS)<br/>mape_TBATS = mape(y_test, y_pred_TBATS)</span><span id="5f2c" class="nh mk iv ol b gy ot oq l or os">print(f'MAPE from baseline: {mape_baseline}')<br/>print(f'MAPE from BATS: {mape_BATS}')<br/>print(f'MAPE from TBATS: {mape_TBATS}')</span><span id="d143" class="nh mk iv ol b gy ot oq l or os">fig, ax = plt.subplots()</span><span id="2c6f" class="nh mk iv ol b gy ot oq l or os">x = ['Baseline', 'BATS', 'TBATS']<br/>y = [mape_baseline, mape_BATS, mape_TBATS]</span><span id="06cf" class="nh mk iv ol b gy ot oq l or os">ax.bar(x, y, width=0.4)<br/>ax.set_xlabel('Models')<br/>ax.set_ylabel('MAPE (%)')<br/>ax.set_ylim(0, 35)</span><span id="e254" class="nh mk iv ol b gy ot oq l or os">for index, value in enumerate(y):<br/>    plt.text(x=index, y=value + 1, s=str(round(value,2)), ha='center')</span><span id="4070" class="nh mk iv ol b gy ot oq l or os">plt.tight_layout()</span></pre><figure class="kl km kn ko gt kp gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/541057ce1fb056ccaf9fb1da4b7f2a56.png" data-original-src="https://miro.medium.com/v2/resize:fit:848/format:webp/1*2h9y9Dc1H9QQa5F5f82K4Q.png"/></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">所有模特中的MAPE。这里，基线模型实现了最佳性能，因为它具有最低的MAPE。(图片由作者提供)</p></figure><p id="53fb" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">从上图中，我们可以看到蝙蝠比蝙蝠表现得更好，正如我们从图中观察到的那样，这是意料之中的。但是，我们看到基线模型是性能最好的模型，实现了11.97%的MAPE。</p><p id="2d51" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">这有点虎头蛇尾，但让我们了解一下为什么会发生这种情况。</p><p id="c9fa" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">有可能我们的数据集太小了。可能我们用于测试的样本最终会支持基线模型。验证的一个方法是预测多个168小时范围，看看基线模型是否仍然优于其他模型。</p><p id="c35f" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">还有，可能是我们对模型的参数要求太严格了。在这里，我们强迫两个模型都使用Box-Cox变换，并删除趋势成分。然而，我们可以不指定这些参数，并且模型将尝试每个参数的两种可能性，并且选择具有最低<a class="ae la" rel="noopener" target="_blank" href="/advanced-time-series-analysis-with-arma-and-arima-a7d9b589ed6d"> AIC (Akaike的信息标准)</a>的一个。虽然这使得训练过程更长，但也可能导致蝙蝠和TBATS更好的表现。</p><p id="45d3" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">然而，关键的一点是，建立基线模型对于任何预测项目都是非常重要的。</p><h1 id="235a" class="mj mk iv bd ml mm mn mo mp mq mr ms mt kb oh kc mv ke oi kf mx kh oj ki mz na bi translated">结论</h1><p id="a3e5" class="pw-post-body-paragraph lb lc iv ld b le nb jw lg lh nc jz lj lk nd lm ln lo ne lq lr ls nf lu lv lw io bi translated">在本文中，我们学习了BATS和t BATS模型，以及如何使用它们来预测具有多个季节周期的时间序列，在这种情况下，不能使用SARIMA模型。</p><p id="90ff" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">我们应用这两个模型来预测每小时的交通量，但结果表明我们的基线仍然是表现最好的模型。</p><p id="89b8" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">然而，我们看到蝙蝠和t BATS确实可以模拟具有复杂季节性的时间序列。</p><h2 id="a771" class="nh mk iv bd ml ni nj dn mp nk nl dp mt lk nm nn mv lo no np mx ls nq nr mz ns bi translated">潜在的改进</h2><ul class=""><li id="5e47" class="nt nu iv ld b le nb lh nc lk ow lo ox ls oy lw ny nz oa ob bi translated">预测多个168小时范围，看看基线是否确实是性能最好的模型。你可以使用<a class="ae la" href="https://archive.ics.uci.edu/ml/datasets/Metro+Interstate+Traffic+Volume" rel="noopener ugc nofollow" target="_blank">原始数据集</a>，它包含的数据比我们处理的要多得多。</li><li id="1b42" class="nt nu iv ld b le oc lh od lk oe lo of ls og lw ny nz oa ob bi translated">不指定参数<em class="ou"> use_box_cox </em>、<em class="ou"> use_trend </em>和<em class="ou"> use_damped_trend </em>，让模型根据AIC做出最佳选择。</li></ul><h2 id="494f" class="nh mk iv bd ml ni nj dn mp nk nl dp mt lk nm nn mv lo no np mx ls nq nr mz ns bi translated">关键要点</h2><ul class=""><li id="31e2" class="nt nu iv ld b le nb lh nc lk ow lo ox ls oy lw ny nz oa ob bi translated">在预测时，总是建立一个基线模型</li><li id="f0cd" class="nt nu iv ld b le oc lh od lk oe lo of ls og lw ny nz oa ob bi translated">bat和TBATS可用于建模具有复杂季节性的时间序列</li><li id="daea" class="nt nu iv ld b le oc lh od lk oe lo of ls og lw ny nz oa ob bi translated">BATS在周期较短且为整数时工作良好</li><li id="30ab" class="nt nu iv ld b le oc lh od lk oe lo of ls og lw ny nz oa ob bi translated">TBATS的训练速度比bat快，并且可以处理非整数的季节周期</li></ul><p id="335f" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">感谢阅读，我希望学到一些有用的东西！如果你想了解更多关于Python中使用统计和深度学习模型进行时间序列预测的知识，可以查看我的<a class="ae la" href="https://www.datasciencewithmarco.com/offers/tdU2mtVK" rel="noopener ugc nofollow" target="_blank">时间序列课程</a>！</p><p id="c4ef" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">干杯！🍺</p></div></div>    
</body>
</html>