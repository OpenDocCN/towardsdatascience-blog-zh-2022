<html>
<head>
<title>Remote Functions in BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">BigQuery 中的远程函数</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/remote-functions-in-bigquery-af9921498438#2022-02-27">https://towardsdatascience.com/remote-functions-in-bigquery-af9921498438#2022-02-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="5bab" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">它是如何工作的，你能用它做什么</h2></div><p id="055f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">BigQuery 提供了调用用户定义函数(UDF)的能力，但是这些 UDF 必须在<a class="ae lb" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/user-defined-functions" rel="noopener ugc nofollow" target="_blank"> SQL </a>或<a class="ae lb" href="https://cloud.google.com/bigquery/user-defined-functions" rel="noopener ugc nofollow" target="_blank"> JavaScript </a>中。这些函数完全在 BigQuery 中运行，因此提供了很好的可伸缩性和性能(SQL 比 JavaScript 更好)。但是在很多情况下，您需要在 BigQuery 之外运行代码，并且希望运行用其他语言编写的代码。对于这两种情况，现在可以使用<a class="ae lb" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/remote-functions" rel="noopener ugc nofollow" target="_blank">遥控功能</a>。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lc"><img src="../Images/ca2115012af6c51a8f2a97a611ace398.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KL0lqeDIA2wuoHyKbjlP6A.jpeg"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">由<a class="ae lb" href="https://unsplash.com/@kellysikkema?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">凯利·西克玛</a>在<a class="ae lb" href="https://unsplash.com/s/photos/remote?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="a6c7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我将向您展示远程函数是如何工作的，然后讨论一些用例。</p><h2 id="ba4d" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">1.远程功能如何工作</h2><p id="0fa8" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">远程功能通过与 Google Cloud Functions (GCFs)的集成来工作，GCFs 是 Google Cloud 上的无服务器功能即服务。</p><ul class=""><li id="99d7" class="mq mr iq kh b ki kj kl km ko ms ks mt kw mu la mv mw mx my bi translated">用 Node.js，Python，Go，Java，.net、Ruby 或 PHP</li><li id="4c47" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la mv mw mx my bi translated">将其包装在 SQL UDF 中—这是现有的新功能</li><li id="a0e9" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la mv mw mx my bi translated">照常使用 SQL UDF</li></ul><p id="4e3e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们看一个例子。</p><h2 id="c100" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">1.1 [Admin]创建 BigQuery 和云函数之间的连接</h2><p id="ccc5" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">嗯，你在权限方面有一点设置。这是您的管理员可能需要做的事情。</p><ul class=""><li id="8e65" class="mq mr iq kh b ki kj kl km ko ms ks mt kw mu la mv mw mx my bi translated">从<a class="ae lb" href="https://console.developers.google.com/apis/api/bigqueryconnection.googleapis.com/" rel="noopener ugc nofollow" target="_blank"> GCP web 控制台</a>，启用 BigQuery 连接 API</li><li id="8a4d" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la mv mw mx my bi translated">在安装了 gcloud SDK 的 Cloud Shell 或其他环境中，执行以下操作:</li></ul><pre class="ld le lf lg gt ne nf ng nh aw ni bi"><span id="5052" class="ls lt iq nf b gy nj nk l nl nm">gcloud components update<br/>bq mk --connection --display_name='my_gcf_conn' \<br/>      --connection_type=CLOUD_RESOURCE \<br/>      --project_id=$(gcloud config get-value project) \<br/>      --location=US  <strong class="nf ir">gcf-conn</strong><br/>bq show --location=US --connection gcf-conn</span></pre><p id="66d1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后一行将向您展示 BigQuery 用来调用云函数的服务帐户。记住这一点，因为我们必须让云功能允许这个服务帐户。</p><h2 id="f8c0" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">1.2 创建云功能</h2><p id="4ffd" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">为了测试这个功能，我们需要创建一个云函数，让我们开始吧。访问<a class="ae lb" href="https://console.cloud.google.com/functions" rel="noopener ugc nofollow" target="_blank"> GCP 控制台</a>并创建新的云功能:</p><ul class=""><li id="27fc" class="mq mr iq kh b ki kj kl km ko ms ks mt kw mu la mv mw mx my bi translated">调用函数 add_fake_user</li><li id="f308" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la mv mw mx my bi translated">接受所有其他默认值</li><li id="f246" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la mv mw mx my bi translated">将语言更改为 Python 3.9</li><li id="a92d" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la mv mw mx my bi translated">将入口点更改为 add_fake_user</li><li id="f3ea" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la mv mw mx my bi translated">将以下代码复制粘贴到编辑器中:</li></ul><pre class="ld le lf lg gt ne nf ng nh aw ni bi"><span id="a212" class="ls lt iq nf b gy nj nk l nl nm">import json</span><span id="017a" class="ls lt iq nf b gy nn nk l nl nm">def add_fake_user(request):<br/>      request_json = request.get_json(silent=True)<br/>      replies = []<br/>      calls = request_json['calls']<br/>      for call in calls:<br/>        userno = call[0]<br/>        corp = call[1]<br/>        replies.append({<br/>          'username': f'user_{userno}',<br/>          'email': f'user_{userno}@{corp}.com'<br/>        })<br/>      return json.dumps({<br/>        # each reply is a STRING (JSON not currently supported)<br/>        'replies': [json.dumps(reply) for reply in replies]<br/>      })</span></pre><p id="2275" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">上面的代码从输入请求中提取了两列(call[0]和 call[1])。第一个被视为 userno，第二个被视为用户所属的公司。基于这些，代码“查找”用户的身份。我在这里实际上并没有攻击外部系统，只是假装而已——但关键的想法是，谷歌云函数中的代码几乎可以是任何东西。</p><p id="be61" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请注意上面代码的两点:</p><ul class=""><li id="6394" class="mq mr iq kh b ki kj kl km ko ms ks mt kw mu la mv mw mx my bi translated">云函数不只是从 BigQuery 获得一行。它接收一堆行。这就是为什么我要迭代</li></ul><pre class="ld le lf lg gt ne nf ng nh aw ni bi"><span id="3168" class="ls lt iq nf b gy nj nk l nl nm">for call in calls</span></pre><ul class=""><li id="601d" class="mq mr iq kh b ki kj kl km ko ms ks mt kw mu la mv mw mx my bi translated">我想将一堆不同的字段返回给 BigQuery，所以我应用了一个技巧，将我想返回的所有数据值转换成一个 JSON 字符串:</li></ul><pre class="ld le lf lg gt ne nf ng nh aw ni bi"><span id="1748" class="ls lt iq nf b gy nj nk l nl nm">replies = []<br/>...<br/>replies.append({<br/>          'username': f'user_{userno}',<br/>          'email': f'user_{userno}@{corp}.com'<br/>        })<br/>...<br/>return json.dumps({<br/>        # each reply is a STRING (JSON not currently supported)<br/>        'replies': [json.dumps(reply) for reply in replies]<br/>      })</span></pre><h2 id="af39" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">1.3 试用云功能</h2><p id="c6c5" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">试试云功能。</p><ul class=""><li id="184f" class="mq mr iq kh b ki kj kl km ko ms ks mt kw mu la mv mw mx my bi translated">切换到云功能的测试选项卡</li><li id="43ea" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la mv mw mx my bi translated">将以下内容复制粘贴到编辑器选项卡中:</li></ul><pre class="ld le lf lg gt ne nf ng nh aw ni bi"><span id="8be0" class="ls lt iq nf b gy nj nk l nl nm">{<br/>        "calls": [<br/>            [4557, "acme"],<br/>            [8756, "hilltop"]<br/>        ]<br/>}</span></pre><p id="70a9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是 BigQuery 将发送的 JSON 的格式。本质上是一个行数组。示例输入中的每一行都包含两个字段:一个整数和一个字符串。云函数会把这两个字段拉出来做它的事。</p><ul class=""><li id="1bce" class="mq mr iq kh b ki kj kl km ko ms ks mt kw mu la mv mw mx my bi translated">您应该会看到回复 JSON:</li></ul><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi no"><img src="../Images/270bdb1d0dac8d095140864b790ebe53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2zGV8jz9lukvwaapmprHEw.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">作者 GCP 控制台截图</p></figure><h2 id="f7cb" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">1.4 允许 BigQuery 调用这个云函数</h2><p id="0274" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">您必须显式地允许 BigQuery 调用这个特定的云函数。因此，切换到 Permissions 选项卡，添加 BigQuery 服务帐户(参见步骤 1.1)作为云函数调用程序。</p><h2 id="7601" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">1.5 将云函数包装在 SQL UDF 中</h2><p id="531f" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">在 BigQuery 中，创建一个数据集来保存 SQL UDF:</p><pre class="ld le lf lg gt ne nf ng nh aw ni bi"><span id="d061" class="ls lt iq nf b gy nj nk l nl nm">bq show blogs || bq mk -d blogs</span></pre><p id="f1d3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">编写一个 SQL UDF，它将利用到 BigQuery 的连接并调用云函数:</p><pre class="ld le lf lg gt ne nf ng nh aw ni bi"><span id="6fc8" class="ls lt iq nf b gy nj nk l nl nm">CREATE OR REPLACE FUNCTION <strong class="nf ir">blogs.add_fake_user</strong>(user_id int64, corp_id STRING) RETURNS STRING<br/>REMOTE WITH CONNECTION `PROJECTID.us.gcf-conn`<br/>    OPTIONS (<br/>        -- change this to reflect the Trigger URL of your cloud function (look for the TRIGGER tab)<br/>        endpoint = '<a class="ae lb" href="https://us-central1-vivid-tuner-338922.cloudfunctions.net/add_fake_user'" rel="noopener ugc nofollow" target="_blank">https://REGION-</a>PROJECTID<a class="ae lb" href="https://us-central1-vivid-tuner-338922.cloudfunctions.net/add_fake_user'" rel="noopener ugc nofollow" target="_blank">.cloudfunctions.net/add_fake_user'</a><br/>    )</span></pre><p id="14be" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意上面有两个地方要改。您可以从 GCP 控制台的主页面板中找到项目 ID。您可以在云函数的触发器选项卡中找到触发器 URL:</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi np"><img src="../Images/22c6210755f7269eb8c2dff6ad22d47c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1148/format:webp/1*KdRJctzVS39x8FBWggE3nA.png"/></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">作者 GCP 控制台截图</p></figure><h2 id="554f" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">1.6 照常使用 SQL UDF</h2><p id="d314" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">例如，您可以查询:</p><pre class="ld le lf lg gt ne nf ng nh aw ni bi"><span id="63e5" class="ls lt iq nf b gy nj nk l nl nm">    SELECT<br/>      start_station_id, end_station_id, <br/>      <strong class="nf ir">blogs.add_fake_user(trip_id, bikeid)</strong><br/>    FROM `bigquery-public-data.austin_bikeshare.bikeshare_trips`<br/>    LIMIT 10</span></pre><p id="33f9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">返回的是一个 JSON 字符串，因此您可以使用 JSON 函数解析它:</p><pre class="ld le lf lg gt ne nf ng nh aw ni bi"><span id="3193" class="ls lt iq nf b gy nj nk l nl nm">WITH data AS (<br/>          SELECT<br/>            trip_id, bikeid, <br/>            start_station_id, end_station_id, <br/>            blogs.add_fake_user(trip_id, bikeid) AS reply<br/>          FROM `bigquery-public-data.austin_bikeshare.bikeshare_trips`<br/>          LIMIT 10<br/>    )<br/>    <br/>    SELECT <br/>      * EXCEPT(reply),<br/>      <strong class="nf ir">JSON_QUERY(reply, '$.email')</strong> AS user_id<br/>    FROM data</span></pre><p id="e952" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">或者，您可以使用 JSON 类型(它目前在预览版中):</p><pre class="ld le lf lg gt ne nf ng nh aw ni bi"><span id="a2fb" class="ls lt iq nf b gy nj nk l nl nm">WITH data AS (<br/>          SELECT<br/>            trip_id, bikeid, <br/>            start_station_id, end_station_id, <br/>            <strong class="nf ir">SAFE.PARSE_JSON</strong>(blogs.add_fake_user(trip_id, bikeid)) AS reply<br/>          FROM `bigquery-public-data.austin_bikeshare.bikeshare_trips`<br/>          LIMIT 10<br/>    )<br/>    <br/>    SELECT <br/>      * EXCEPT(reply),<br/>      <strong class="nf ir">reply.email</strong><br/>    FROM data</span></pre><h2 id="cbf6" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">2 个使用案例</h2><p id="ad62" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">在需要在 BigQuery 之外运行代码的情况下，以及希望运行用其他语言编写的代码的情况下，远程函数非常有用。但是，您不希望过度使用远程函数，因为与原生 SQL UDFs 相比，它们在性能和成本方面存在劣势。远程函数的性能通常不如原生 BigQuery SQL，因为它需要额外调用 BigQuery 插槽和自动扩展虚拟机的云函数。此外，在成本方面，您将为 BigQuery 和云功能付费。</p><p id="7f6c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">以下是一些潜在的使用案例。</p><h2 id="adf4" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">2.1 浓缩</h2><p id="40d0" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">一个关键的用例是用外部服务创建的数据丰富 BigQuery，并写出一个新表。</p><p id="128d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">假设你有一个部署到顶点 AI 端点的机器学习模型。远程函数使您能够调用 BigQuery 数据上的模型，并创建一个包含丰富数据的新表。这也适用于预先构建的谷歌模型，如谷歌翻译和顶点实体提取。</p><p id="74c0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">非 ML 丰富用例包括地理编码和实体解析。</p><p id="985d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="nq">注意，如果你的 ML 模型在 TensorFlow 中，我推荐你</em> <a class="ae lb" href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-create-tensorflow" rel="noopener ugc nofollow" target="_blank"> <em class="nq">直接加载为 BigQuery ML </em> </a> <em class="nq">模型。这种方法比远程函数更有效。</em></p><h2 id="8d95" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">2.2 实时查找</h2><p id="c292" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">作为 SQL 工作流的一部分，您可以使用远程函数来查找实时信息(例如股票价格、汇率)。</p><p id="135f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，您可以让仪表板或交易应用程序简单地调用一个 SQL 查询来过滤一组证券，然后查找符合选择标准的股票的实时价格信息:</p><pre class="ld le lf lg gt ne nf ng nh aw ni bi"><span id="dfd5" class="ls lt iq nf b gy nj nk l nl nm">WITH stocks AS (<br/>   SELECT<br/>      symbol<br/>   WHERE<br/>      ...<br/>)<br/>SELECT symbol, <strong class="nf ir">realtime_price</strong>(symbol) AS price<br/>FROM stocks</span></pre><p id="2f76" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">其中 realtime_price()是一个远程函数。</p><h2 id="e344" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">2.3 用动态 ELT 代替计划 ETL</h2><p id="ccec" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">2.2 中的股票价格场景通常的做法是编写一个 ETL 管道，定期为所有证券创建一个当前价格表。这对于交易量少的证券来说可能是一种浪费，并会带来不必要的延迟。针对此类证券，将 ETL 管道更改为 ELT 管道可以显著降低存储和计算成本。</p><p id="19e0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一般来说，远程函数方法允许您在业务中用 ELT 管道替换许多预定的 ETL 管道，ELT 管道可以在需要时动态地查找信息。</p><h2 id="9f88" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">2.4 高性能计算</h2><p id="6b80" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">不是所有的事情都可以用 SQL 完成。以交易为例，复杂的投资组合策略可能最好用统计友好的编程语言(比如 Python)来完成，并且可能需要在加速器(比如 GPU)上执行。</p><p id="dc5a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">SQL 查询可以将这样的高性能计算提供给远程函数。</p><h2 id="7045" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">2.5 Java 中的业务逻辑</h2><p id="3f61" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">2.4 中的高性能计算是需要用高性能语言实现的业务逻辑的一个例子。您可能希望用 Java 之类的语言实现业务逻辑的另一个常见原因是，业务逻辑可以在多个地方重用，包括 web 和后端应用程序。</p><p id="a9b5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">远程函数允许您将 Java 中的业务逻辑作为 SQL 工作流的一部分来应用。</p><h2 id="53af" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">2.6 与其他系统的集成</h2><p id="d787" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">我在本文第一部分中的例子是查找用户凭证。通常，当您需要将 BigQuery 与外部系统(如令牌代理等)集成时，远程函数会有所帮助。</p><p id="260f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="nq">注意，在像 Cloud SQL 和 Spanner 这样的事务性数据库的特定情况下，您可以使用 EXTERNAL_QUERY 并完全保留在 SQL 中。但是对于其他类型的外部系统，远程功能将被证明是有用的。</em></p><h2 id="312a" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">2.7 混合云工作流</h2><p id="3048" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">因为云功能可以调用任何代码，甚至在 GCP 之外，这也可以是实现混合云工作流的一种方式。确保您调用的服务能够处理并发性！</p><h2 id="fd2a" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">2.8 遗留代码</h2><p id="4391" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">如果您有您的用例所必需的专有或遗留代码，远程函数允许您从 SQL 调用它。一种常见的情况是支持强制特定(非标准)加密或令牌化的合规性要求。</p><h2 id="14b3" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">2.9 迁移</h2><p id="895c" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">当从遗留数据仓库迁移时，您可能会使用 SQL 和 JavaScript 之外的语言来定义用户函数。远程功能允许您将这些 UDF 迁移到云中。</p><p id="85d0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这些情况下，云函数可能比 SQL 更有效，无论如何你都需要外部计算，或者简化是值得的。</p><p id="327b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">尽情享受吧！</p><p id="ac8d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="nq">感谢克里斯·克罗斯比和沈超的有益讨论</em></p><h2 id="96ce" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">后续步骤:</h2><ol class=""><li id="da9f" class="mq mr iq kh b ki ml kl mm ko nr ks ns kw nt la nu mw mx my bi translated">为了方便起见，<a class="ae lb" href="https://github.com/GoogleCloudPlatform/bigquery-oreilly-book/tree/master/blogs/remote_func" rel="noopener ugc nofollow" target="_blank">本文中的步骤也列在了与 O'Reilly 的书<a class="ae lb" href="https://www.amazon.com/Google-BigQuery-Definitive-Warehousing-Analytics/dp/1492044466" rel="noopener ugc nofollow" target="_blank"> BigQuery:权威指南</a>相对应的 GitHub </a>库中。试试吧！</li><li id="122e" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la nu mw mx my bi translated">阅读<a class="ae lb" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/remote-functions" rel="noopener ugc nofollow" target="_blank">远程功能</a>的文档页面。</li><li id="ee51" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la nu mw mx my bi translated">阅读云函数文档，了解<a class="ae lb" href="https://cloud.google.com/functions/docs/bestpractices/tips#performance" rel="noopener ugc nofollow" target="_blank">性能</a>技巧。</li></ol></div></div>    
</body>
</html>