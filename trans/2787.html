<html>
<head>
<title>Creating Choropleth Maps with Python’s Folium Library</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python的叶库创建Choropleth地图</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/creating-choropleth-maps-with-pythons-folium-library-cfacfb40f56a#2022-06-16">https://towardsdatascience.com/creating-choropleth-maps-with-pythons-folium-library-cfacfb40f56a#2022-06-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="377b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何用Python制作不同数据结构的choropleths</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/c708887816d34c99038bd19c54efe71d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RYXajNfZq48PLHGBo3xUTQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">【2019年4月纽约市可出租公寓一览表(<a class="ae kw" href="https://github.com/amitrani6/nyc_asking_rent_regression" rel="noopener ugc nofollow" target="_blank"><em class="kv">GitHub</em></a><em class="kv">)</em></p></figure><p id="d9bb" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi lt translated"><span class="l lu lv lw bm lx ly lz ma mb di"> C </span> horopleth地图用于显示地理区域的数据变化(<a class="ae kw" href="https://populationeducation.org/what-is-a-choropleth-map-and-why-are-they-useful/" rel="noopener ugc nofollow" target="_blank"> <em class="mc">人口教育</em> </a>)。我使用choropleths显示了纽约市不同邮政编码的可用出租公寓数量，并显示了给定时期每个邮政编码的抵押贷款交易数量。Python的<a class="ae kw" href="https://python-visualization.github.io/folium/" rel="noopener ugc nofollow" target="_blank">叶子库</a>使用户能够构建多种定制地图，包括choropleths，你可以将它们作为<code class="fe md me mf mg b">.html</code>文件与不知道如何编码的外部用户共享。</p><h1 id="66a8" class="mh mi iq bd mj mk ml mm mn mo mp mq mr jw ms jx mt jz mu ka mv kc mw kd mx my bi translated">加载和查看地理数据</h1><p id="6c91" class="pw-post-body-paragraph kx ky iq kz b la mz jr lc ld na ju lf lg nb li lj lk nc lm ln lo nd lq lr ls ij bi translated">美国政府网站通常有创建地图所需的地理数据文件。纽约市的OpenData <a class="ae kw" href="https://www1.nyc.gov/site/planning/data-maps/open-data.page" rel="noopener ugc nofollow" target="_blank">网站</a>和美国人口普查局的<a class="ae kw" href="https://www.census.gov/geographies/mapping-files/time-series/geo/carto-boundary-file.html" rel="noopener ugc nofollow" target="_blank">网站</a>有多种数据类型的地理边界文件。Python允许你加载多种文件类型，包括geo JSON<em class="mc">(</em><code class="fe md me mf mg b"><em class="mc">.geojson</em></code><em class="mc">)</em>文件和shape file<em class="mc">(</em><code class="fe md me mf mg b"><em class="mc">.shp</em></code><em class="mc">)</em>。这些文件包含给定位置的空间边界。</p><p id="db7b" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">关于<code class="fe md me mf mg b">folium.Choropleth()</code>方法的folio文档说明，<code class="fe md me mf mg b">geo_data</code>参数接受GeoJSON几何作为字符串来创建映射，“URL、文件路径或数据<em class="mc"> (json、dict、geopandas等)</em>到您的GeoJSON <br/>几何“<em class="mc">(</em><a class="ae kw" href="https://python-visualization.github.io/folium/modules.html#module-folium.features" rel="noopener ugc nofollow" target="_blank"><em class="mc">)folio文档</em> </a> <em class="mc"> ) </em>。无论我们如何加载文件，我们都必须用这种方法转换几何数据才能正常工作。该方法的<code class="fe md me mf mg b">key_on</code>参数将每个特定位置<em class="mc"> (GeoJSON数据)</em>的数据与该位置<em class="mc">(即人口)</em>的数据绑定。</p><h2 id="5d1c" class="ne mi iq bd mj nf ng dn mn nh ni dp mr lg nj nk mt lk nl nm mv lo nn no mx np bi translated">杰奥森</h2><p id="1109" class="pw-post-body-paragraph kx ky iq kz b la mz jr lc ld na ju lf lg nb li lj lk nc lm ln lo nd lq lr ls ij bi translated">GeoJSON文件存储几何形状，在这种情况下是位置的边界及其相关属性。例如，加载带有纽约市邮政编码边界的GeoJSON文件的代码如下:</p><pre class="kg kh ki kj gt nq mg nr ns aw nt bi"><span id="4c97" class="ne mi iq mg b gy nu nv l nw nx"># Code to open a .geojson file and store its contents in a variable</span><span id="46bb" class="ne mi iq mg b gy ny nv l nw nx"><strong class="mg ir">with</strong> open ('nyczipcodetabulationareas.geojson', 'r') <strong class="mg ir">as</strong> jsonFile:<br/>    nycmapdata <strong class="mg ir">=</strong> json<strong class="mg ir">.</strong>load(jsonFile)</span></pre><p id="d330" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">变量<code class="fe md me mf mg b">nycmapdata</code>包含一个至少有两个键的字典，其中一个键叫做<code class="fe md me mf mg b">features</code>，这个键包含一个字典列表，每个字典代表一个位置。第一个位置的主要GeoJSON结构摘录如下:</p><pre class="kg kh ki kj gt nq mg nr ns aw nt bi"><span id="5d33" class="ne mi iq mg b gy nu nv l nw nx">{'type': 'FeatureCollection',<br/> 'features': [{'type': 'Feature',<br/>   'properties': {'OBJECTID': 1,<br/>    'postalCode': '11372',<br/>    'PO_NAME': 'Jackson Heights',<br/>    'STATE': 'NY',<br/>    'borough': 'Queens',<br/>    'ST_FIPS': '36',<br/>    'CTY_FIPS': '081',<br/>    'BLDGpostal': 0,<br/>    '@id': 'http://nyc.pediacities.com/Resource/PostalCode/11372',<br/>    'longitude': -73.883573184,<br/>    'latitude': 40.751662187},<br/>   'geometry': {'type': 'Polygon',<br/>    'coordinates': [[[-73.86942457284177, 40.74915687096788],<br/>      [-73.89143129977276, 40.74684466041932],<br/>      [-73.89507143240859, 40.746465470812154],<br/>      [-73.8961873786782, 40.74850942518088],<br/>      [-73.8958395418514, 40.74854687570604],<br/>      [-73.89525242774397, 40.748306609450246],<br/>      [-73.89654041085562, 40.75054199814359],<br/>      [-73.89579868613829, 40.75061972133262],<br/>      [-73.89652230661434, 40.75438879610903],<br/>      [-73.88164812188481, 40.75595161704187],<br/>      [-73.87221855882478, 40.75694324806748],<br/>      [-73.87167992356792, 40.75398717439604],<br/>      [-73.8720704651389, 40.753862007052064],<br/>      [-73.86942457284177, 40.74915687096788]]]}}, ... ]}</span></pre><p id="0a4b" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated"><code class="fe md me mf mg b">folium.Choropleth()</code>方法的<code class="fe md me mf mg b">key_on</code>参数要求用户以字符串形式引用GeoJSON文件中位置字典的唯一索引键:</p><blockquote class="nz oa ob"><p id="bd85" class="kx ky mc kz b la lb jr lc ld le ju lf oc lh li lj od ll lm ln oe lp lq lr ls ij bi translated"><strong class="kz ir"> key_on </strong> ( <em class="iq">字符串，默认无</em>)—geo _ data geo JSON文件中的变量，数据绑定到该变量。必须以“feature”开头，并且采用JavaScript异议表示法。例如:“feature.id”或“feature.properties.statename”。</p></blockquote><p id="40c7" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在上面的例子中，索引键是邮政编码，与每个位置相关的数据也必须有一个邮政编码索引键或列。上例中的<code class="fe md me mf mg b">key_on</code>参数是以下字符串:</p><p id="a561" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated"><code class="fe md me mf mg b">‘feature.properties.postalCode’</code></p><p id="53d7" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated"><em class="mc">注意:字符串的第一部分必须始终是单数单词</em> <code class="fe md me mf mg b"><em class="mc">feature</em></code> <em class="mc">，它不像父字典那样包含每个单独位置字典的列表。</em></p><p id="a9d0" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated"><code class="fe md me mf mg b">key_on</code>参数是访问每个特定位置的<code class="fe md me mf mg b">properties</code>键。<code class="fe md me mf mg b">properties</code>键本身包含一个有11个键的字典，在这种情况下,<code class="fe md me mf mg b">postalCode</code>键是索引值，它将几何形状链接到我们想要绘制的任何值。</p><h2 id="813a" class="ne mi iq bd mj nf ng dn mn nh ni dp mr lg nj nk mt lk nl nm mv lo nn no mx np bi translated"><strong class="ak">地质公园</strong></h2><p id="b3b9" class="pw-post-body-paragraph kx ky iq kz b la mz jr lc ld na ju lf lg nb li lj lk nc lm ln lo nd lq lr ls ij bi translated">另一种加载地理数据的方法是使用Python的GeoPandas库<em class="mc"> ( </em> <a class="ae kw" href="https://geopandas.org/en/stable/" rel="noopener ugc nofollow" target="_blank"> <em class="mc">链接</em> </a> <em class="mc"> ) </em>。这个库在加载Shapefile时很有用，shape file在美国人口普查网站<em class="mc"> ( </em> <a class="ae kw" href="https://www.census.gov/geographies/mapping-files/time-series/geo/carto-boundary-file.html" rel="noopener ugc nofollow" target="_blank"> <em class="mc">制图边界文件— Shapefile </em> </a> <em class="mc"> ) </em>上提供。GeoPandas的工作方式类似于Pandas，只是它可以存储和执行几何数据的功能。例如，用美国所有州的边界加载shapefile的代码如下:</p><pre class="kg kh ki kj gt nq mg nr ns aw nt bi"><span id="c38a" class="ne mi iq mg b gy nu nv l nw nx"># Using GeoPandas</span><span id="6cb6" class="ne mi iq mg b gy ny nv l nw nx">import geopandas as gpd<br/>usmap_gdf = gpd.read_file('cb_2018_us_state_500k/cb_2018_us_state_500k.shp')</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi of"><img src="../Images/bcb66d99fdc297292585c7248830a700.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V8D9YRWjVpA81RNI-KgELQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><em class="kv">us map _ GDF数据帧的头部</em></p></figure><p id="b6d0" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">如果您调用Jupyter笔记本中第一行的<em class="mc"> (Mississippi) </em>几何列，您将看到以下内容:</p><p id="050b" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated"><code class="fe md me mf mg b">usmap_gdf[“geometry”].iloc[0]</code></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi og"><img src="../Images/335e44201be38f04fde98713f7f9c99c.png" data-original-src="https://miro.medium.com/v2/resize:fit:206/format:webp/1*rvtxrE5VagIcZ-0DZIxhGw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">当调用特定的几何值时，您会看到一个几何图像，而不是表示形状边界的字符串，上面是第一行(密西西比)的几何值</p></figure><p id="0bfe" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">与GeoJSON字典的内容不同，没有用于访问内部字典的<code class="fe md me mf mg b">features</code>键，也没有<code class="fe md me mf mg b">properties</code>列。<code class="fe md me mf mg b">folium.Choropleth()</code>方法的<code class="fe md me mf mg b">key_on</code>参数仍然要求字符串的第一部分为<code class="fe md me mf mg b">feature</code>，但是该方法将引用GeoPandas数据帧中的列，而不是引用GeoJSON的位置字典。在这种情况下，<code class="fe md me mf mg b">key_on</code>参数将等于<code class="fe md me mf mg b">“feature.properties.GEOID”</code>，其中<code class="fe md me mf mg b">GEOID</code>是包含将我们的数据绑定到地理边界的唯一州代码的列。<code class="fe md me mf mg b">GEOID</code>列有前导零，加州<code class="fe md me mf mg b">GEOID</code>是<code class="fe md me mf mg b">06</code>。您也可以使用<code class="fe md me mf mg b">STATEFP</code>列作为索引，确保使用的列、格式和数据类型都是一致的。</p><h1 id="ee0c" class="mh mi iq bd mj mk ml mm mn mo mp mq mr jw ms jx mt jz mu ka mv kc mw kd mx my bi translated">查看Choropleth的群体数据</h1><p id="f69a" class="pw-post-body-paragraph kx ky iq kz b la mz jr lc ld na ju lf lg nb li lj lk nc lm ln lo nd lq lr ls ij bi translated">地理数据和要绘制的相关数据可以作为两个单独的变量存储，也可以一起存储。重要的是跟踪列的数据类型，并确保索引(<code class="fe md me mf mg b"><em class="mc">key_on</em></code>)列对于地理数据和位置的关联数据是相同的。</p><p id="19ab" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我访问了美国人口普查API的美国社区调查<em class="mc"> ( </em> <a class="ae kw" href="https://www.census.gov/programs-surveys/acs" rel="noopener ugc nofollow" target="_blank"> <em class="mc">链接</em> </a> <em class="mc"> ) </em>和人口估计与预测<em class="mc"> ( </em> <a class="ae kw" href="https://www.census.gov/data/developers/data-sets/popest-popproj.html" rel="noopener ugc nofollow" target="_blank"> <em class="mc">链接</em> </a> <em class="mc"> ) </em>表格，得到2019年到2021年的人口和人口统计数据。数据帧的标题如下:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oh"><img src="../Images/f934601c1d4f14e86acf81528ef6b32c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JC4zFNVvQdGubZhMACDsVw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">美国人口普查数据框架的头</p></figure><p id="9b9d" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我将数据保存为一个<code class="fe md me mf mg b">.csv</code>文件，在某些情况下，这将改变列的数据类型；例如，字符串可以变成数值。调用<code class="fe md me mf mg b">.info() </code>时的数据类型如下:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oi"><img src="../Images/2272cc849dee4752ae0ec6bfd1b16265.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lv8mfQlxynmz14BdsaISFw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">将数据框保存和加载为CSV文件之前和之后的人口普查数据的数据类型</p></figure><p id="6c8a" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">另一个需要注意的重要事情是，在加载数据帧后，<code class="fe md me mf mg b">state</code>列中的所有前导零都不会出现。这必须得到纠正；id必须匹配并且是相同的数据类型<em class="mc">(即它不能在一个数据框中是整数而在另一个数据框中是字符串)</em>。</p><h1 id="63f1" class="mh mi iq bd mj mk ml mm mn mo mp mq mr jw ms jx mt jz mu ka mv kc mw kd mx my bi translated">基本的Choropleth映射有五种不同的方式</h1><p id="c4cc" class="pw-post-body-paragraph kx ky iq kz b la mz jr lc ld na ju lf lg nb li lj lk nc lm ln lo nd lq lr ls ij bi translated">如上所述，follow允许您使用地理数据类型创建地图，包括GeoJSON和GeoPandas。这些数据类型需要被格式化，以便与least库一起使用，为什么会出现某些错误并不总是直观的(对我来说是<em class="mc">，至少是</em>)。以下示例描述了如何准备地理数据<em class="mc">(在本例中为美国州界)</em>和相关的绘图数据<em class="mc">(各州的人口)</em>以用于<code class="fe md me mf mg b">folium.Choropleth()</code>方法。</p><h2 id="3526" class="ne mi iq bd mj nf ng dn mn nh ni dp mr lg nj nk mt lk nl nm mv lo nn no mx np bi translated">方法1:使用Pandas和GeoJSON，不指定ID列</h2><p id="83d9" class="pw-post-body-paragraph kx ky iq kz b la mz jr lc ld na ju lf lg nb li lj lk nc lm ln lo nd lq lr ls ij bi translated">这种方法非常类似于文档中的choropleth地图的例子。该方法使用包含州边界数据的GeoJSON文件和Pandas数据帧来创建地图。</p><p id="eea1" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">当我开始使用GeoPandas文件时，我需要使用GeoPandas的<code class="fe md me mf mg b">to_json()</code> <a class="ae kw" href="https://geopandas.org/en/stable/docs/reference/api/geopandas.GeoDataFrame.to_json.html" rel="noopener ugc nofollow" target="_blank">方法</a>将其转换为GeoJSON文件。提醒一下<em class="mc"> usmap_gdf </em> GeoPandas数据帧看起来像:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi of"><img src="../Images/bcb66d99fdc297292585c7248830a700.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V8D9YRWjVpA81RNI-KgELQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><em class="kv">us map _ GDF数据帧的头</em></p></figure><p id="47b0" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">然后我应用<code class="fe md me mf mg b">.to_json()</code>方法，并指定我们从数据帧中删除<code class="fe md me mf mg b">id</code>，如果它存在的话:</p><p id="95ff" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated"><code class="fe md me mf mg b">usmap_json_no_id = usmap_gdf.to_json(drop_id=True)</code></p><p id="0079" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated"><em class="mc">注意:</em> <code class="fe md me mf mg b"><em class="mc">usmap_json_no_id</em></code> <em class="mc">是本场景</em>中存放json字符串的变量</p><p id="55ca" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">这个方法返回一个字符串，我对它进行了格式化，以便于阅读，并显示在下面的第一组坐标上:</p><pre class="kg kh ki kj gt nq mg nr ns aw nt bi"><span id="2bf7" class="ne mi iq mg b gy nu nv l nw nx">'{"type": "FeatureCollection",<br/>  "features": [{"type": "Feature",<br/>  "properties": {"AFFGEOID": "0400000US28", <br/>                 "ALAND": 121533519481,<br/>                 "AWATER": 3926919758,<br/>                 "GEOID": 28,<br/>                 "LSAD": "00",<br/>                 "NAME": "Mississippi",<br/>                 "STATEFP": "28",<br/>                 "STATENS": "01779790",<br/>                 "STUSPS": "MS"},<br/>  "geometry": {"type": "MultiPolygon",<br/>               "coordinates": [[[[-88.502966, 30.215235]'</span></pre><p id="4815" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated"><em class="mc">注意:“属性”字典没有名为“id”的键</em></p><p id="52b8" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">现在，我们准备将新创建的JSON变量与上一节中获得的美国人口普查数据框架连接起来，其标题如下:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oh"><img src="../Images/f934601c1d4f14e86acf81528ef6b32c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JC4zFNVvQdGubZhMACDsVw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">美国人口普查数据框架的头部，下面称为<strong class="bd oj"> all_states_census_df </strong></p></figure><p id="cc1a" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">使用folium的<code class="fe md me mf mg b">Choropleth()</code>方法，我们创建地图对象:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">创建一个<code class="fe md me mf mg b">Choropleth with a GeoJSON variable which does not specify an id</code>的代码</p></figure><p id="398c" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated"><code class="fe md me mf mg b">geo_data</code>参数被设置为新创建的<code class="fe md me mf mg b"><em class="mc">usmap_json_no_id</em></code>变量，而<code class="fe md me mf mg b">data</code>参数被设置为<strong class="kz ir"> all_states_census_df </strong>数据帧。由于在创建GeoJSON变量时未指定id，<code class="fe md me mf mg b">key_on</code>参数必须引用地理数据中的特定关键字，并且其工作方式类似于字典(<em class="mc"> GEOID是“属性”关键字</em>的值)。在这种情况下，<code class="fe md me mf mg b">GEOID</code>键保存州代码，该代码将州几何边界数据连接到<strong class="kz ir"> all_states_census_df </strong>数据帧中相应的美国人口普查数据。下面是choropleth:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi om"><img src="../Images/9bcf00ec6f73c635c382d0bc077902db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y00ST6O1Zb8jbBgd5zFF5Q.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由上述方法得到的choropleth</p></figure><h2 id="7a8c" class="ne mi iq bd mj nf ng dn mn nh ni dp mr lg nj nk mt lk nl nm mv lo nn no mx np bi translated">方法2:使用Pandas和GeoJSON，并指定ID列</h2><p id="d0fb" class="pw-post-body-paragraph kx ky iq kz b la mz jr lc ld na ju lf lg nb li lj lk nc lm ln lo nd lq lr ls ij bi translated">除了在调用<code class="fe md me mf mg b">.to_json()</code>方法之前使用一个索引之外，这个过程与上面的几乎完全相同。</p><p id="b48a" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在上面的例子中，<code class="fe md me mf mg b">usmap_gdf</code>数据帧没有索引，为了纠正这个问题，我将把索引设置为<code class="fe md me mf mg b">GEOID</code>列，然后立即调用<code class="fe md me mf mg b">.to_json()</code>方法:</p><p id="98a4" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated"><code class="fe md me mf mg b">usmap_json_with_id = usmap_gdf.set_index(keys = “GEOID”).to_json()</code></p><p id="b853" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">直到第一个州的数据的第一对坐标，结果字符串如下:</p><pre class="kg kh ki kj gt nq mg nr ns aw nt bi"><span id="c952" class="ne mi iq mg b gy nu nv l nw nx">'{"type": "FeatureCollection",<br/>  "features": [{"id": "28",<br/>                "type": "Feature",<br/>                "properties": {"AFFGEOID": "0400000US28",<br/>                               "ALAND": 121533519481, <br/>                               "AWATER": 3926919758,<br/>                               "LSAD": "00",<br/>                               "NAME": "Mississippi",<br/>                               "STATEFP": "28",<br/>                               "STATENS": "01779790",<br/>                               "STUSPS": "MS"},<br/>                "geometry": {"type": "MultiPolygon",<br/>                             "coordinates": [[[[-88.502966, 30.215235],'</span></pre><p id="18a4" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">“properties”字典不再有<code class="fe md me mf mg b">GEOID</code>键，因为它现在作为一个名为<code class="fe md me mf mg b">id</code>的新键存储在外层字典中。您还应该注意到，<code class="fe md me mf mg b">id</code>值现在是一个字符串，而不是一个整数。如前所述，您必须确保连接数据的数据类型是一致的。如果涉及前导零和尾随零，这会变得很乏味。为了解决这个问题，我从<code class="fe md me mf mg b">all_states_census_df</code>中的<code class="fe md me mf mg b">state</code>列创建了一个名为<code class="fe md me mf mg b">state_str</code>的新列:</p><p id="c851" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated"><code class="fe md me mf mg b">all_states_census_df[“state_str”]=all_states_census_df[“state”].astype(“str”)</code></p><p id="1716" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">现在我们可以创建choropleth:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">创建c的代码<code class="fe md me mf mg b">horopleth with a GeoJSON variable which specifies an id</code></p></figure><p id="b823" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">该代码与之前使用的代码的区别在于<code class="fe md me mf mg b">key_on</code>参数引用的是<code class="fe md me mf mg b">id</code>而不是<code class="fe md me mf mg b">properties.GEOID</code>。生成的地图与方法1完全相同:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi om"><img src="../Images/9bcf00ec6f73c635c382d0bc077902db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y00ST6O1Zb8jbBgd5zFF5Q.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由上述方法得到的Choropleth</p></figure><h2 id="6c72" class="ne mi iq bd mj nf ng dn mn nh ni dp mr lg nj nk mt lk nl nm mv lo nn no mx np bi translated">方法3:使用熊猫和GeoPandas的Python要素集合</h2><p id="47eb" class="pw-post-body-paragraph kx ky iq kz b la mz jr lc ld na ju lf lg nb li lj lk nc lm ln lo nd lq lr ls ij bi translated">该方法从具有<code class="fe md me mf mg b">__geo_interface__</code> <a class="ae kw" href="https://geopandas.org/en/stable/docs/reference/api/geopandas.GeoDataFrame.__geo_interface__.html" rel="noopener ugc nofollow" target="_blank">属性</a>的原始GeoPandas数据帧创建GeoJSON like对象(<em class="mc"> python要素集合</em>)。</p><p id="d881" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我将<code class="fe md me mf mg b">usmap_gdf</code>data frame(<em class="mc">US geographic data</em>)的索引设置为<code class="fe md me mf mg b">STATEFP</code>列，该列以字符串形式存储州id，并以零开头:</p><p id="9b67" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated"><code class="fe md me mf mg b">usmap_gdf.set_index(“STATEFP”, inplace = True)</code></p><p id="f978" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">然后，我通过添加一个前导零，在<code class="fe md me mf mg b">all_states_census_df</code>数据框(<em class="mc">美国人口普查数据</em>)中创建了一个匹配列:</p><p id="5bc1" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated"><code class="fe md me mf mg b">all_states_census_df[“state_str”] = all_states_census_df[“state”].astype(“str”).apply(lambda x: x.zfill(2))</code></p><p id="241d" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">最后，我使用<code class="fe md me mf mg b">us_data_gdf</code> GeoPandas dataframe的<code class="fe md me mf mg b">__geo_interface__</code> <a class="ae kw" href="https://geopandas.org/en/stable/docs/reference/api/geopandas.GeoDataFrame.__geo_interface__.html" rel="noopener ugc nofollow" target="_blank">属性</a>来获取几何状态边界的python特性集合，存储为一个字典，类似于前两种方法:</p><p id="5dae" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated"><code class="fe md me mf mg b">us_geo_json = gpd.GeoSeries(data = usmap_gdf[“geometry”]).__geo_interface__</code></p><p id="1a31" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">下面是<code class="fe md me mf mg b">us_geo_json</code>变量的摘录:</p><pre class="kg kh ki kj gt nq mg nr ns aw nt bi"><span id="c98c" class="ne mi iq mg b gy nu nv l nw nx">{'type': 'FeatureCollection',<br/> 'features': [{'id': '28',<br/>   'type': 'Feature',<br/>   'properties': {},<br/>   'geometry': {'type': 'MultiPolygon',<br/>    'coordinates': [(((-88.502966, 30.215235), ...))]</span></pre><p id="538e" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">最后，我们创建了choropleth:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">创建一个c <code class="fe md me mf mg b">horopleth with a GeoPanda's <strong class="ak">__geo_interface__</strong></code>属性的代码</p></figure><p id="0989" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">这张地图看起来和上面的一样，所以我把它排除了。</p><h2 id="599c" class="ne mi iq bd mj nf ng dn mn nh ni dp mr lg nj nk mt lk nl nm mv lo nn no mx np bi translated">方法4:使用Geopandas的几何类型列</h2><p id="be09" class="pw-post-body-paragraph kx ky iq kz b la mz jr lc ld na ju lf lg nb li lj lk nc lm ln lo nd lq lr ls ij bi translated">在这里，我们坚持GeoPandas。我创建了一个名为<code class="fe md me mf mg b">us_data_gdf</code>的GeoPandas数据框架，它将几何数据和普查数据组合在一个变量中:</p><pre class="kg kh ki kj gt nq mg nr ns aw nt bi"><span id="1d7a" class="ne mi iq mg b gy nu nv l nw nx">us_data_gdf = pd.merge(left = usmap_gdf,<br/>                       right = all_states_census_df,<br/>                       how = "left", <br/>                       left_on = ["GEOID", "NAME"],<br/>                       right_on = ["state", "NAME"]<br/>                       )</span></pre><p id="0059" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated"><em class="mc">注:</em><strong class="kz ir"><em class="mc">all _ States _ Census _ df</em></strong><em class="mc">是美国人口普查数据的熊猫数据帧，</em><strong class="kz ir"><em class="mc">US map _ GDF</em></strong><em class="mc">是存储州几何边界数据的GeoPandas数据帧。</em></p><p id="2ac9" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">使用GeoPandas数据帧创建choropleth的代码如下:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">使用GeoPandas数据帧创建choropleth的代码</p></figure><p id="544e" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在上面的例子中，<code class="fe md me mf mg b">geo_data</code>参数和<code class="fe md me mf mg b">data</code>参数都引用相同的GeoPandas数据帧，因为信息存储在一个地方。因为我没有设置索引，所以<code class="fe md me mf mg b">key_on</code>参数等于<code class="fe md me mf mg b">“feature.properties.GEOID”</code>。即使使用GeoPandas，folium也需要使用<code class="fe md me mf mg b">key_on</code>参数，就像引用一个类似字典的对象一样。</p><p id="8552" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">和以前一样，这张地图看起来和上面的一样，所以我把它排除了。</p><h2 id="9c9c" class="ne mi iq bd mj nf ng dn mn nh ni dp mr lg nj nk mt lk nl nm mv lo nn no mx np bi translated">方法5:使用Geopandas几何类型和Branca</h2><p id="265d" class="pw-post-body-paragraph kx ky iq kz b la mz jr lc ld na ju lf lg nb li lj lk nc lm ln lo nd lq lr ls ij bi translated">在这里，我们使用Branca <a class="ae kw" href="https://github.com/python-visualization/branca" rel="noopener ugc nofollow" target="_blank">库</a>和leav的<a class="ae kw" href="https://python-visualization.github.io/folium/quickstart.html#Styling-function" rel="noopener ugc nofollow" target="_blank">示例</a>创建了一个更加时尚的地图。除了安装之外，Branca的第一步是创建一个<code class="fe md me mf mg b">ColorMap</code>对象:</p><pre class="kg kh ki kj gt nq mg nr ns aw nt bi"><span id="cc5b" class="ne mi iq mg b gy nu nv l nw nx">colormap = branca.colormap.LinearColormap(<br/>    vmin=us_data_gdf["Total_Pop_2021"].quantile(0.0),<br/>    vmax=us_data_gdf["Total_Pop_2021"].quantile(1),<br/>    colors=["red", "orange", "lightblue", "green", "darkgreen"],<br/>    caption="Total Population By State",<br/>)</span></pre><p id="5b0a" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在上面的代码中，我们访问了<code class="fe md me mf mg b">branca.colormap.LinearColormap</code> <a class="ae kw" href="https://github.com/python-visualization/branca/blob/52b10bd969ac25d0b70640b2eee2ea1d8e8690b3/branca/colormap.py#L161" rel="noopener ugc nofollow" target="_blank">类</a>。在这里，我们可以设置我们使用的颜色以及色阶的值。对于这个choropleth，我希望颜色与美国人口普查数据中最低和最高的人口值成比例。为了设置这些值，我使用了上述的<code class="fe md me mf mg b">vmin</code>和<code class="fe md me mf mg b">vmax</code>参数。如果我忽略了这一点，那么色标中将考虑没有值的区域，没有这些设置参数的结果如下:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi om"><img src="../Images/ce7a3d9b86e896fe92b5401c4f1109b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nfzy1xw6Rynh29pdfGb_4Q.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">没有设置<code class="fe md me mf mg b"><strong class="bd oj">vmin</strong></code>和<code class="fe md me mf mg b"><strong class="bd oj"><em class="kv">vmax</em></strong></code>参数的Branca choropleth</p></figure><p id="93a3" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">一旦创建了<code class="fe md me mf mg b">ColorMap</code>对象，我们就可以创建一个choropleth ( <em class="mc">完整代码在</em>下面):</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">使用GeoPandas数据框架和Branca库创建choropleth</p></figure><p id="8bf5" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我修改了leav网站上的例子，使用了<code class="fe md me mf mg b">us_data_gdf</code> GeoPandas数据框架。该示例允许我们排除地理数据中不具有相关人口普查数据的部分(<em class="mc">显示为透明的</em>)(<em class="mc">如果一个州的人口为空，那么除非被排除</em>，否则choropleth上的颜色将为黑色。生成的choropleth如下:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi om"><img src="../Images/017a6eda82a87534b8b5b219cac88ba5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5Et8vOgjg_88MT0JcdaX7A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">用麦麸和地瓜做成的鸡蛋饼</p></figure><p id="1084" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">布兰卡是可定制的，但如何使用它的解释是少之又少。其存储库的自述文件指出:</p><blockquote class="nz oa ob"><p id="aab3" class="kx ky mc kz b la lb jr lc ld le ju lf oc lh li lj od ll lm ln oe lp lq lr ls ij bi translated">没有文档，但是你可以浏览范例库。</p></blockquote><p id="6084" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">你必须练习使用它来制作你想要的那种地图。</p><h1 id="2008" class="mh mi iq bd mj mk ml mm mn mo mp mq mr jw ms jx mt jz mu ka mv kc mw kd mx my bi translated">摘要</h1><p id="fe2d" class="pw-post-body-paragraph kx ky iq kz b la mz jr lc ld na ju lf lg nb li lj lk nc lm ln lo nd lq lr ls ij bi translated">对那些有或没有编码知识的人来说，叶子可以用来制作信息丰富的地图，如choropleths。政府网站通常拥有为您的数据创建位置边界所需的地理数据，这些数据也可以从政府网站获得。理解你的数据类型和文件类型是很重要的，因为这会导致不必要的麻烦。这些地图是高度可定制的，例如你可以添加工具提示来注释你的地图。充分利用这个图书馆的潜力需要实践。</p><p id="df84" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated"><em class="mc">我的这篇文章可以在</em> <a class="ae kw" href="https://github.com/amitrani6/maps" rel="noopener ugc nofollow" target="_blank"> <em class="mc">这里找到</em> </a> <em class="mc">。快乐编码。</em></p></div></div>    
</body>
</html>