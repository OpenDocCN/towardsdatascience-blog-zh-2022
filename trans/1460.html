<html>
<head>
<title>Elasticsearch Beats Workshop #3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Elasticsearch Beats研讨会#3</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/elasticsearch-beats-workshop-3-c47054367a80#2022-04-10">https://towardsdatascience.com/elasticsearch-beats-workshop-3-c47054367a80#2022-04-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e92a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">适用于您的Metricset的更复杂的配置</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/e482b8b63746365bc674124d062d5aaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cnV_17BTjitQQrIA"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">约书亚·索蒂诺在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="a1d2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">欢迎来到Beats工作坊的第三部分。这里可以找到第一家作坊<a class="ae kv" rel="noopener" target="_blank" href="/elasticsearch-beats-workshop-1-c73189069793">。像往常一样，为了使每篇文章尽可能简洁，我将代码简化为片段。如果你想看完整的代码，请查阅我的</a><a class="ae kv" href="https://github.com/PascalThalmann/ElasticBeatWorkshop/tree/master/3_create_a_module_2" rel="noopener ugc nofollow" target="_blank"> GitHub页面。如果谷歌把你带到这里，你可能还会检查</a><a class="ae kv" href="https://medium.com/@pascalth/list/elasticsearch-beats-workshop-fbe5332d03e1" rel="noopener">系列</a>的其他部分。</p><p id="db0e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个工作坊是在上一个工作坊的基础上建立的，你可以在这里找到<a class="ae kv" rel="noopener" target="_blank" href="/elasticsearch-beats-workshop-2-ea07d7bb4b00">。</a>所有的准备工作、开发环境的创建以及定制metricbeat框架的创建都在这里。如果您想加快进程并跳过阅读那篇文章，按照文章中描述的那样设置开发环境，克隆存储workshop 2 的<a class="ae kv" href="https://github.com/PascalThalmann/ElasticBeatWorkshop/tree/master/2_create_a_module_1" rel="noopener ugc nofollow" target="_blank">文件的GitHub repo，您就拥有了这个workshop所需的一切。</a></p><p id="40c0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">今天，我们创建了一个更加复杂的metricset，其配置为您提供了更多选项，并为您的托运人增加了更多智能。在本模块结束时，您将能够创建各种指标，只需了解一点Go知识。你会惊讶于创建一个专业的Metricbeat模块是多么容易。</p><p id="18dd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是:研讨会的一部分还包括部署您的Metricbeat模块。在<a class="ae kv" rel="noopener" target="_blank" href="/elasticsearch-beats-workshop-2-ea07d7bb4b00">第二次研讨会</a>中，我们完全忽略了一件事，那就是你新创作的节拍的包装。剧透警告:Docker会参与！</p><p id="3afe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是游戏计划:</p><ul class=""><li id="be03" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">定义用例</li><li id="1954" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">定义数据结构</li><li id="ad49" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">定义模块和度量集的配置</li><li id="7f9c" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">编码矩阵集</li><li id="a35d" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">编译和配置Metricbeat</li><li id="7271" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">测试矩阵集</li><li id="04be" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">创建Dockerfile文件</li><li id="c67e" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">建立形象</li><li id="542c" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">运行容器并检查输出</li></ul><p id="6ed1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如你所见，有很多工作要做——请给自己拿杯茶，系好安全带准备上路。说够了:让我们直接开始吧！</p><h1 id="f794" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">定义用例</h1><p id="6e7c" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">在最后一部分中，我们只对监控文件列表感兴趣。我们没有为警报定义任何阈值——我们只将文件名和上次修改时间之间的差异发送到Elasticsearch集群。</p><h1 id="a21c" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">我们需要的输入</h1><p id="5da6" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">这一次，我们为每个文件添加了四个选项。我们甚至为默认值定义了选项。这使用户能够保持YAML配置文件尽可能的精简。让我们确定所需的选项:</p><ul class=""><li id="ab12" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">文件名(必填)</li><li id="a064" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">以秒为单位的最大增量(可选)</li><li id="f85a" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">警报的开始时间(可选)</li><li id="e3c8" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">警报的结束时间(可选)</li><li id="b381" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">一周中应发出警报的日期(可选)</li><li id="384c" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">除文件名外，以上所有选项的默认值</li></ul><p id="e960" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">配置文件的结构如下:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/1f17db206469e0663e85d6974bbb4e7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:482/format:webp/0*FClCg1ll2zsWVWyK.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片—图表1:输入字段</p></figure><h1 id="98dc" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">我们所做的处理</h1><p id="f397" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">使用来自YML配置文件的输入(我们设置的选项),我们的处理将如下所示:</p><ol class=""><li id="4260" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr ne ly lz ma bi translated">读取每个文件名(字段文件名)</li><li id="b69c" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr ne ly lz ma bi translated">读取每个定义的选项(最大增量、开始时间、周天数)</li><li id="5b5c" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr ne ly lz ma bi translated">我们做了一些检查:</li></ol><ul class=""><li id="1969" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">我们检查文件名是否存在。如果没有，我们将向群集发送一条警告消息，其中包含文件名和特定消息。</li><li id="b5b2" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">如果设置了可选字段，我们会检查每个可选字段。如果不是:我们使用特定字段的默认值</li><li id="657f" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">我们检查实际工作日和实际时间。我们将它与工作日以及定义实际一天的监控时间窗口的开始和结束时间进行比较。如果我们在时间窗口中，并且实际工作日是要监控的一天:我们的字段“active”被设置为true。否则，我们的字段“活动”将被设置为假。</li><li id="352d" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">我们读取文件统计信息，并用文件最后一次修改的时间戳计算实际时间的增量。我们将它存储在字段“delta”中。</li><li id="f965" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">最后，我们将delta与max_delta进行比较，如果delta超过max_delta中定义的值，则将alter设置为true</li></ul><h1 id="39c5" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">我们发送的输出</h1><p id="452f" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">如果文件名存在，我建议将所有输入值和处理步骤中计算出的值一起发送给Elasticsearch。这使得调试更加容易。如果没有，我们只需要一个特定的错误消息，我们可以在ELassticsearch中监控它，以查找不再存在的文件(因此要么不再需要监控，要么存在更深层次的问题)。我们将发回的数据结构如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/d45c6a7566b4899cc84ef249c13de026.png" data-original-src="https://miro.medium.com/v2/resize:fit:882/format:webp/0*zjYJJJt2Sx8vFP1G.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者提供的图片—图表2:输出字段</p></figure><h1 id="697d" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">可能与输出有关的事情</h1><p id="01a1" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">监控框架可以是:在Elasticsearch集群中有一个观察者，它向您最喜欢的工具(电子邮件、Slack、Nagios等)发出警报。)在警报为真且监视器激活的情况下。</p><h1 id="7cef" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">定义模块和度量集的配置</h1><p id="f67e" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">因为我们已经在上一个研讨会中创建了数据结构，所以我们只需要更改配置文件的一个子集。在这里，您可以看到文件夹结构的概述，我们将更改的文件标记为蓝色:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/3efc36a002983e513be2d8437c4b2a73.png" data-original-src="https://miro.medium.com/v2/resize:fit:762/format:webp/0*3ZVahKPwRLAzF6G0.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片—图表3:文件夹结构</p></figure><p id="d829" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">与第二次研讨会一样，路径</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="5804" class="nm mh iq ni b gy nn no l np nq">~/go/src/github.com/elastic/beats/metricbeat/module/my_module</span></pre><p id="b598" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">将从这一点简称为“我的_模块”。</p><h1 id="db36" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">my_module/_meta/config.yml</h1><p id="be43" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">首先，我们定义模板，该模板将用于生成文件my_module.yml，该文件将在metricbeat安装期间在/etc/metricbeat/modules.d中创建。my_module/_meta中config.yml的缩写版本需要这样放置:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="2e7b" class="nm mh iq ni b gy nn no l np nq">- module: my_module<br/>  metricsets: ["file_mon"]<br/>...<br/>  default_max_delta: 600<br/>  default_start_time: [8,0]<br/>  default_end_time: [22, 0]<br/>  default_week_days: [0, 1, 2, 3, 4, 5, 6]<br/>  files:<br/>  - file_name: "/var/log/syslog"<br/>    max_delta: 1200<br/>    start_time: [7, 0]<br/>    end_time: [22, 0]<br/>    week_days: [1, 2, 3, 4, 5]</span></pre><h1 id="9a86" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">my _ module/file _ mon/_ meta/fields . yml</h1><p id="98e7" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">我们现在设置config.yml中定义的结构的字段定义。这需要正确的数据类型，因为metricbeat需要它来在Elasticsearch的索引中创建正确的映射:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="b5b0" class="nm mh iq ni b gy nn no l np nq">- name: file_mon<br/>  type: group<br/>  release: beta<br/>  fields:<br/>    - name: default_max_delta<br/>      type: object<br/>      object_type: long<br/>    - name: default_start_time<br/>      type: object<br/>    - name: default_end_time<br/>      type: object<br/>    - name: default_monitoring_week_days<br/>      type: object<br/>    - name: files<br/>      type: object<br/>      fields:<br/>        - name: file_name <br/>          type: keyword<br/>        - name: max_delta<br/>          type: object<br/>          object_type: long<br/>        - name: monitorin_start_time<br/>          type: object<br/>        - name: monitoring_end_time<br/>          type: object<br/>        - name: monitoring_week_days<br/>          type: object</span></pre><p id="1b08" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这里设置正确的结构和核心数据类型至关重要。如果您不确定您需要哪种核心数据类型，请查看<a class="ae kv" href="https://www.elastic.co/guide/en/elasticsearch/reference/master/mapping-types.html#_core_datatypes" rel="noopener ugc nofollow" target="_blank">官方文档</a>中的数据类型。</p><h1 id="3728" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">编码矩阵集</h1><p id="5614" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">这就是配置文件。我们现在可以在我们的度量集中实现规范。</p><h1 id="d3c3" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">为指标集定义所需的数据结构</h1><p id="c2b1" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">我们现在定义对象矩阵集的结构。虽然Go不是面向对象的语言，但结构可以被看作是对象的属性集合。每个属性必须由一个数据类型定义，如果数据被添加到该结构，字段的数据类型必须与您添加到该字段的数据相匹配。因此，当我们处理一个结构时，我们处理的数据必须被分配给正确的字段并具有正确的数据类型。因为我们的缺省值都是整数列表，所以我们在MetricSet结构中定义它们，如下所示:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="f1bf" class="nm mh iq ni b gy nn no l np nq">type MetricSet struct {<br/> mb.BaseMetricSet<br/> DefaultMaxDelta  int          `config:"default_max_delta"`<br/> DefaultStartTime []int        `config:"default_start_time"`<br/> DefaultEndTime   []int        `config:"default_end_time"`<br/> DefaultWeekDays  []int        `config:"default_week_days"`<br/> FileConfig       []FileConfig `config:"files"`<br/>}</span></pre><p id="b5ee" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">标签config:“XXX”将用于匹配我们在配置中定义的字段。功能“New”将读取配置，并在标签的帮助下进行匹配。</p><p id="a146" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如您所见，在该结构的最底部，有一个数据类型为FileConfig的list FileConfig。这只不过是我们需要定义的另一个具有数据类型的结构。结构FileConfig将保存我们为每个文件名定义的特定值:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="269c" class="nm mh iq ni b gy nn no l np nq">type FileConfig struct {<br/> FileName  string `config:"file_name"`<br/> MaxDelta  int    `config:"max_delta"`<br/> StartTime []int  `config:"start_time"`<br/> EndTime   []int  `config:"end_time"`<br/> WeekDays  []int  `config:"week_days"`<br/>}</span></pre><p id="52e5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们深入研究“新”方法之前，我们先用一个函数来返回MetricSet和FileConfig结构:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="c53b" class="nm mh iq ni b gy nn no l np nq">func returnConfig() MetricSet {<br/> return MetricSet{}<br/>}</span></pre><h1 id="b925" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">创建度量集实例</h1><p id="83ad" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">New-method将调用函数returnConfig()并接收my_module.yml中的值:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="93ce" class="nm mh iq ni b gy nn no l np nq">func New(base mb.BaseMetricSet) (mb.MetricSet, error) {<br/>  ...<br/>  config := returnConfig()<br/>  ...<br/>  return &amp;MetricSet{<br/>    BaseMetricSet:    base,<br/>    FileConfig:       config.FileConfig,<br/>    DefaultMaxDelta:  config.DefaultMaxDelta,<br/>    DefaultStartTime: config.DefaultStartTime,<br/>    DefaultEndTime:   config.DefaultEndTime,<br/>    DefaultWeekDays:  config.DefaultWeekDays,<br/>  }, nil<br/>}</span></pre><p id="f5cd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们现在正在填充我们定义的结构矩阵集。如果在配置中发现了什么，New()将解包数据并用它填充我们的MetricSet结构。</p><h1 id="f7d0" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">获取数据并发送给Elasticsearch</h1><p id="4293" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">我们的fetch方法读取存储在MetricSet中的数据，并将其保存在变量FileConfig中。它保存了我们之前定义为struct MetricSet的特定文件配置。我们用引用m.FileConfig来调用它。</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="a672" class="nm mh iq ni b gy nn no l np nq">func (m *MetricSet) Fetch(report mb.ReporterV2) error {<br/>      FileConfig := m.FileConfig</span></pre><p id="bb39" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，让我们来读一下实际的时间、年份和月份。这是以后需要的:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="76ec" class="nm mh iq ni b gy nn no l np nq">act_time := time.Now()<br/>year := act_time.Year()<br/>month := act_time.Month()</span></pre><p id="4683" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在让我们遍历文件config，看看循环中的前几行:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="f5cc" class="nm mh iq ni b gy nn no l np nq">for _, file_config := range FileConfig {<br/>   f, err := os.Open(file_config.FileName)</span></pre><p id="e1f9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">调用标准Go库的一个好处是，它们中的许多会返回一个错误对象。在我们的例子中，确保我们打开的文件是存在的是非常重要的。否则，您将得到一个非常糟糕的异常，如下所示:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="ca18" class="nm mh iq ni b gy nn no l np nq">log.origin":{<br/>     "file.name":"runtime/panic.go",<br/>     "file.line":221 },<br/>"message":<br/>     "recovered from panic while fetching <br/>     'my_module/file_mon' for host 'localhost'. <br/>     Recovering, but please report this.",<br/>"error":{<br/>     "message":"runtime error: invalid memory <br/>     address or nil pointer dereference" }</span></pre><p id="2aa8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，我们评估err对象，如果它不为零，让metricbeat向Elasticsearch发送一个报告——正如我们在图2中定义的那样:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="caff" class="nm mh iq ni b gy nn no l np nq">if err != nil {<br/>   report.Event(mb.Event{<br/>       MetricSetFields: common.MapStr{<br/>           "error":     "file not existing",<br/>           "file_name": file_config.FileName,<br/>           "warning":   true,<br/>           },<br/>       })<br/>       continue<br/> }</span></pre><p id="fa67" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们现在读取下一个块中的统计数据，并计算增量:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="e8ba" class="nm mh iq ni b gy nn no l np nq">out, _ := f.Stat()<br/>mod_time := out.ModTime()<br/>difference := act_time.Sub(mod_time).Seconds()<br/>delta := int(math.Round(difference))</span></pre><p id="9588" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从那时起。Sub()。Seconds()方法以float形式返回秒数，我们对其进行舍入并将其转换为int。</p><p id="b8e7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们现在为变量alert和active设置默认值——没什么特别的或值得解释的:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="3d2a" class="nm mh iq ni b gy nn no l np nq">alert := false<br/>active := false</span></pre><p id="08a2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来的几行得到实际的工作日。我们首先测试file_config。工作日切片有实际数据。如果没有，我们采用默认配置。此外，我们测试实际的工作日是否在file_config中。工作日切片:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="4416" class="nm mh iq ni b gy nn no l np nq">if len(file_config.WeekDays) == 0 {<br/>    file_config.WeekDays = m.DefaultWeekDays<br/>}<br/>for _, x := range file_config.WeekDays {<br/>    if act_weekday == x {<br/>        active = true<br/>    }<br/>}</span></pre><p id="bb53" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们现在测试所有其他的file_config值。如果它们是空的，我们设置默认值。默认值必须由引用“m”调用，因为我们没有将它们赋给变量:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="bc68" class="nm mh iq ni b gy nn no l np nq">if file_config.MaxDelta == 0 {<br/>   file_config.MaxDelta = m.DefaultMaxDelta<br/>}<br/>if len(file_config.StartTime) == 0 {<br/>   file_config.StartTime = m.DefaultStartTime<br/>}<br/>if len(file_config.EndTime) == 0 {<br/>   file_config.EndTime = m.DefaultEndTime<br/>}</span></pre><p id="c812" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们现在检查我们现在是否在监视器应该被激活的时间窗口中。如果是，我们检查增量是否超过阈值，如果是，则发出警报:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="d24a" class="nm mh iq ni b gy nn no l np nq">window_start := time.Date(year, month, file_config.StartTime[0],           <br/>                file_config.StartTime[1], 0, 0, 0, time.UTC)</span><span id="efd4" class="nm mh iq ni b gy nr no l np nq">window_end := time.Date(year, month, file_config.EndTime[0],<br/>              file_config.EndTime[1], 0, 0, 0, time.UTC)</span><span id="2dd1" class="nm mh iq ni b gy nr no l np nq">if window_start.Before(act_time) &amp;&amp; window_end.After(act_time) &amp;&amp; active {<br/>   if file_config.MaxDelta &lt; delta {<br/>      alert = true<br/>      }<br/>   } else {<br/>      active = false<br/>}</span></pre><p id="9ebf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后但同样重要的是，我们正在发送数据，如图2所示:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="1ff1" class="nm mh iq ni b gy nn no l np nq">report.Event(mb.Event{<br/>   MetricSetFields: common.MapStr{<br/>      "delta":      delta,<br/>      "max_delta":  file_config.MaxDelta,<br/>      "file_name":  file_config.FileName,<br/>      "alert":      alert,<br/>      "active":     active,<br/>      "start_time": file_config.StartTime,<br/>      "end_time":   file_config.EndTime,<br/>      "week_days":  file_config.WeekDays,</span><span id="4c2c" class="nm mh iq ni b gy nr no l np nq">"default_max_delta":  m.DefaultMaxDelta,<br/>      "default_start_time": m.DefaultStartTime,<br/>      "default_end_time":   m.DefaultEndTime,<br/>      "default_week_days":  m.DefaultWeekDays,<br/>   },<br/>})</span></pre><p id="18d8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">就是这样。是时候测试我们的矩阵集了。</p><h1 id="1a89" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">编译和配置Metricbeat</h1><p id="41b5" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">如果您正确设置了您的开发环境，您应该能够切换到metricbeat的根文件夹，并使用mage编译新的模块和metricset:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="e74c" class="nm mh iq ni b gy nn no l np nq">cd ~/go/src/github.com/elastic/beats/metricbeat<br/>mage update<br/>mage build</span></pre><p id="954a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们用新编译的Metricbeat二进制文件测试我们的模块之前，您需要设置metricbeat.yml配置文件以连接到Elasticsearch集群。因为您可能从GitHub克隆了最新的metricbeat版本，所以您需要向我们的metricbeat.yml添加以下选项:</p><p id="3aa3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">output . elastic search . allow _ older _ versions:true</p><p id="987a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您只想查看新模块中的条目，您还需要禁用系统模块—默认情况下它是启用的:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="1cb9" class="nm mh iq ni b gy nn no l np nq">./metricbeat modules disable system<br/>./metricbeat modules enable my_module</span></pre><h1 id="691f" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">测试矩阵集</h1><p id="2f9f" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">您可以使用详细日志记录来启动Mericbeat:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="0af4" class="nm mh iq ni b gy nn no l np nq">./metricbeat -e -d "*"</span></pre><p id="f431" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您在metricbeat索引中看到数据，请检查您的群集。现在，默认的my_module.yml文件应该是这样的:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/81617dc2eac987388796da6cc0548d42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1132/format:webp/1*gOLXVDqy_tK-WUt9ykGohw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="5cb9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">警报和活动可以是真或假。如果运行Metricbeat，您应该会看到一个具有上述结构并包含上述数据的文档。当我们稍后在Docker容器中运行相同的配置时，这看起来会有所不同。</p><h1 id="b397" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">构建和部署</h1><p id="fd64" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">如果您还没有找到，请转到metricbeat根文件夹，创建一个归档文件，将我们需要的所有内容打包到my_module.tar.gz中，并将所有内容复制到新创建的文件夹~/workspace中:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="9a9c" class="nm mh iq ni b gy nn no l np nq">cd ~/go/src/github.com/elastic/beats/metricbeat/<br/>./metricbeat modules enable my_module<br/>tar zcvf my_module.tar.gz \<br/>   module/my_module \<br/>   fields.yml \<br/>   metricbeat.reference.yml \<br/>   metricbeat.yml \<br/>   modules.d/my_module.yml \<br/>   metricbeat<br/>mkdir ~/workspace<br/>cp my_module.tar.gz ~/workspace<br/>cd ~/workspace</span></pre><p id="85f5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有了那个包裹，你现在就没事了。你可以用sftp或者Ansible之类的工具把它复制到你想要的每一台机器上。或者你可以用它创建一个rpm。或者创建一个Docker映像并将其上传到您选择的Docker注册表。我们采用后者，让我们解压缩tar.gz-archive:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="84ab" class="nm mh iq ni b gy nn no l np nq">tar zxvf my_module.tar.gz</span></pre><h1 id="a23a" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">创建Dockerfile文件</h1><p id="8673" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">我们创建的映像将包含我们编译的二进制metricbeat、metricbeat.yml配置文件，以自动连接到我们的Elasticsearch集群，并且该过程使用用户metricbeat运行:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="a07b" class="nm mh iq ni b gy nn no l np nq">FROM ubuntu:18.04</span><span id="1f3c" class="nm mh iq ni b gy nr no l np nq">RUN useradd -rm -d /metricbeat -s /bin/bash -g root -G sudo -u 1000 metricbeat \<br/>    &amp;&amp; mkdir /metricbeat/modules.d \<br/>    &amp;&amp; chown metricbeat:root /metricbeat/modules.d \<br/>    &amp;&amp; apt update \<br/>    &amp;&amp; apt -y upgrade</span><span id="857c" class="nm mh iq ni b gy nr no l np nq">USER metricbeat<br/>WORKDIR /metricbeat</span><span id="a461" class="nm mh iq ni b gy nr no l np nq">COPY metricbeat /metricbeat</span><span id="63e1" class="nm mh iq ni b gy nr no l np nq">EXPOSE 9200</span><span id="3a9c" class="nm mh iq ni b gy nr no l np nq">CMD cd /metricbeat &amp;&amp; ./metricbeat -e -d "*"</span></pre><h1 id="cbcd" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">建立形象</h1><p id="b2b2" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">我们现在使用Dockerfile文件构建映像，并将其标记为my _ module版:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="9575" class="nm mh iq ni b gy nn no l np nq">docker build -f Dockerfile . -t my_module:1.0</span></pre><h1 id="67e0" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">将图像上传到您的注册表</h1><p id="56d6" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">这里是一个新版本1.1的整个过程。不要混淆，我使用Nexus 3作为Docker图像的本地注册表，但它与Harbor的过程相同:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="16b2" class="nm mh iq ni b gy nn no l np nq">docker login -u xxx -p yyy srvnexus:8082<br/>docker build -f Dockerfile . -t my_module:1.1<br/>docker image tag my_module:1.1 srvnexus:8082/repository/dh/my_module:1.1<br/>docker image push srvnexus:8082/repository/dh/my_module:1.1</span></pre><p id="442b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，您可以在每台运行docker的服务器上获取您定制的Metricbeat:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="752a" class="nm mh iq ni b gy nn no l np nq">docker pull srvnexus:8082/repository/dh/my_module:1.1</span></pre><h1 id="1abe" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">创建Docker图像的tar.gz档案</h1><p id="9413" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">可以使用“docker图像保存”将docker图像保存为tar.gz-archive:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="1d40" class="nm mh iq ni b gy nn no l np nq">docker image save -o my_module.tar.gz [image id]</span></pre><h1 id="93e7" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">运行并测试Docker映像</h1><p id="6edc" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">运行容器的时间到了。因为我们不想构建新的映像，所以每次我们更改my_module.yml或metricbeat.yml文件时，我们都直接从本地文件系统挂载它。您可以通过Puppet、Ansible或任何其他部署工具分发这些配置文件:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="0f92" class="nm mh iq ni b gy nn no l np nq">METRICPATH=$HOME/workspace/metricbeat.yml<br/>MODULEPATH=$HOME/workspace/modules.d</span><span id="57fd" class="nm mh iq ni b gy nr no l np nq">docker run \<br/>--mount type=bind,source=$MODULEPATH,target=/metricbeat/modules.d \<br/>--mount type=bind,source=$METRICPATH,target=/metricbeat/metricbeat.yml \<br/>-it [image id]</span></pre><p id="1876" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">检查在Kibana中创建的文档，您会感到惊讶:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/a3a57943ce7ceca0dae4731a05fdd088.png" data-original-src="https://miro.medium.com/v2/resize:fit:1182/format:webp/0*xrBI0V3qEgsV1gZ9.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="dd61" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">是的，文件/var/log/syslog不存在。就像大多数码头集装箱一样。好了，让我们更改我们的文件~/modules.d/my_module.yml并添加/var/log/lastlog作为第二个要监视的文件:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="5402" class="nm mh iq ni b gy nn no l np nq">- file_name: "/var/log/lastlog"<br/>    max_delta: 10<br/>    start_time: [2, 0]<br/>    end_time: [22, 0]<br/>    week_days: [0, 1, 2, 3, 4, 5]</span></pre><p id="7d8a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">再次启动容器:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="9f30" class="nm mh iq ni b gy nn no l np nq">docker container start $(docker container ls -lq)</span></pre><p id="79b3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您应该会看到lastlog的统计数据:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/3de47fe968f4cce06322f7799a9306b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1208/format:webp/0*YdVR5J4JrqES5aFs.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><h1 id="1f9e" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">从docker.com下载图片</h1><p id="fe95" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">最后一个命令:如果你想下载Docker镜像并随便玩玩，可以在<a class="ae kv" href="https://hub.docker.com/layers/workshop/cdax75/workshop/my_module/images/sha256-4c1fbcc33ccccd4ed179438a11fc56ce155f5cdc8a8c118f88ce80d87452d497?context=repo" rel="noopener ugc nofollow" target="_blank">docker.com</a>上找到。</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="51ae" class="nm mh iq ni b gy nn no l np nq">docker pull cdax75/workshop:my_module</span></pre><p id="37e7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">按照我们在“运行并测试Docker映像”中所做的那样运行容器。</p><h1 id="936b" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">结论</h1><p id="ace8" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">如果你成功了:祝贺你！现在，您应该能够创建Metricbeat模块和metricset，并将其部署为docker映像。这是一个比第一个例子更聪明的例子。如果您使用file_mon.go中的结构作为蓝本，您应该能够创建更复杂的metricsets。</p><p id="c23b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您有任何问题，请在<a class="ae kv" href="https://www.linkedin.com/in/pascal-thalmann/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上留言、联系或关注我。</p><p id="ae3a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">玩得开心！</p></div><div class="ab cl nv nw hu nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="ij ik il im in"><p id="f6fa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="oc">最初发布于</em><a class="ae kv" href="https://cdax.ch/2022/04/09/elasticsearch-beats-workshop-3-a-more-sophisticated-configuration-for-your-metricset/" rel="noopener ugc nofollow" target="_blank"><em class="oc">https://cdax . ch</em></a><em class="oc">。</em></p></div></div>    
</body>
</html>