<html>
<head>
<title>Explaining SQL Queries for Better Performance</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">解释SQL查询以获得更好的性能</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/explaining-sql-queries-for-better-performance-6be64905eaad#2022-06-08">https://towardsdatascience.com/explaining-sql-queries-for-better-performance-6be64905eaad#2022-06-08</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><figure class="it iu gq gs iv iw gi gj paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="gi gj is"><img src="../Images/4bf06e97c1218862d551cb7af773690f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3FG55c0bsnuTmfmYPCb-wg.jpeg"/></div></div><p class="jd je gk gi gj jf jg bd b be z dk translated">照片由<a class="ae jh" href="https://unsplash.com/@hcmorr?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">汉娜·莫瑞斯</a>在<a class="ae jh" href="https://unsplash.com/s/photos/plan?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h2 id="f608" class="ji jj jk bd b dl jl jm jn jo jp jq dk jr translated" aria-label="kicker paragraph">数据工程</h2><div class=""/><div class=""><h2 id="faa7" class="pw-subtitle-paragraph kq jt jk bd b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh dk translated">窥视数据库查询执行引擎</h2></div><h1 id="295a" class="li lj jk bd lk ll lm ln lo lp lq lr ls kz lt la lu lc lv ld lw lf lx lg ly lz bi translated">背景</h1><p id="d456" class="pw-post-body-paragraph ma mb jk mc b md me ku mf mg mh kx mi mj mk ml mm mn mo mp mq mr ms mt mu mv in bi translated">数据分析师和数据工程师面临的最常见的问题之一是非性能查询，通常称为慢速查询。这些查询很慢，通常不是因为缺少处理查询的资源，而是因为您编写的低效查询使用了过多的资源。</p><p id="a29f" class="pw-post-body-paragraph ma mb jk mc b md mw ku mf mg mx kx mi mj my ml mm mn mz mp mq mr na mt mu mv in bi translated">大多数数据分析师和一些数据工程师不太了解数据库内部。那么，如何修复和优化缓慢的查询呢？事实证明，修复缓慢的查询并不需要成为数据库专家。大多数数据库系统通过展示数据库如何执行查询，为您提供了一种窥视数据库内部工作的方法。这些是查询计划。</p><p id="bc5b" class="pw-post-body-paragraph ma mb jk mc b md mw ku mf mg mx kx mi mj my ml mm mn mz mp mq mr na mt mu mv in bi translated">查询优化器创建查询计划。优化器会提出替代计划来执行您的查询，以充分利用您的资源。我将在另一篇文章中详细讨论不同类型的优化器。无论数据库使用哪种类型的优化器，它都将遵循大多数数据库预订的执行顺序，如下所示:</p><figure class="nb nc nd ne gu iw"><div class="bz fq l di"><div class="nf ng l"/></div></figure><p id="8e74" class="pw-post-body-paragraph ma mb jk mc b md mw ku mf mg mx kx mi mj my ml mm mn mz mp mq mr na mt mu mv in bi translated">优化器将查看预定义的规则、表和列使用统计信息，并找出更好地运行查询的方法。例如，一些高级优化器(在Spark 3.0中)也可以在运行时改变查询计划。这种自适应的查询执行方式在分布式系统中最有用，在这种系统中，查询执行可能会受到不同节点在其他时间完成工作的影响。</p><h1 id="7651" class="li lj jk bd lk ll lm ln lo lp lq lr ls kz lt la lu lc lv ld lw lf lx lg ly lz bi translated">查询计划的输出</h1><p id="0253" class="pw-post-body-paragraph ma mb jk mc b md me ku mf mg mh kx mi mj mk ml mm mn mo mp mq mr ms mt mu mv in bi translated">大多数数据库通过让您使用一个简单的名为<code class="fe nh ni nj nk b">EXPLAIN</code>的SQL关键字来公开这个计划。如果您执行一个<code class="fe nh ni nj nk b">EXPLAIN &lt;SQL query&gt;</code>语句，您的数据库将开发一个计划并在您的GUI或控制台上打印出来。每个数据库都有不同的内部术语来表示查询执行过程中的不同步骤。对于每个步骤，查询计划通常包括以下内容:</p><ul class=""><li id="e59e" class="nl nm jk mc b md mw mg mx mj nn mn no mr np mv nq nr ns nt bi translated"><strong class="mc ju">估计总成本</strong> —检索所有可用记录的成本</li><li id="c994" class="nl nm jk mc b md nu mg nv mj nw mn nx mr ny mv nq nr ns nt bi translated"><strong class="mc ju">估计扫描的行数</strong> —在此步骤中扫描/检查的行数(这是索引、分区等。进来)</li><li id="114b" class="nl nm jk mc b md nu mg nv mj nw mn nx mr ny mv nq nr ns nt bi translated"><strong class="mc ju">估计检索的行数</strong> —输出中的行数(步骤的，不是整个查询的)</li><li id="f4ea" class="nl nm jk mc b md nu mg nv mj nw mn nx mr ny mv nq nr ns nt bi translated"><strong class="mc ju">估计的平均行宽</strong> —输出中的平均行宽(同样，仅用于此步骤)</li></ul><p id="1ddb" class="pw-post-body-paragraph ma mb jk mc b md mw ku mf mg mx kx mi mj my ml mm mn mz mp mq mr na mt mu mv in bi translated">请记住，<em class="nz">成本</em>是一个任意的数字。一些数据库将其映射到获取的数据库页面数量；其他人做事情的方式不同。查看计划的想法是将它作为一个整体来看——用<em class="nz">总成本</em>、提取的<em class="nz">行数</em>、扫描的<em class="nz">行数</em>等等。</p><h1 id="b427" class="li lj jk bd lk ll lm ln lo lp lq lr ls kz lt la lu lc lv ld lw lf lx lg ly lz bi translated">修复非性能查询</h1><p id="ee95" class="pw-post-body-paragraph ma mb jk mc b md me ku mf mg mh kx mi mj mk ml mm mn mo mp mq mr ms mt mu mv in bi translated">查看查询执行计划，您可以快速确定您的查询是否正在执行下列操作之一(此列表并不完整):</p><ul class=""><li id="369d" class="nl nm jk mc b md mw mg mx mj nn mn no mr np mv nq nr ns nt bi translated"><strong class="mc ju">在错误的条件下连接表</strong> —当不需要交叉连接或不等式连接时，您有交叉连接或不等式连接吗？数据库优化器只能分析它在SQL查询中看到的内容；它显然不能理解意图。因此，当您使用交叉连接时，数据库会指出您是否打算使用交叉连接。</li><li id="f6bc" class="nl nm jk mc b md nu mg nv mj nw mn nx mr ny mv nq nr ns nt bi translated"><strong class="mc ju">缺少或未使用的索引</strong> —一些数据库在计划中为您提供高级信息，其中计划明确声明您没有使用索引。相比之下，您必须使用扫描的行数和检索的数据来推断其他人的相同信息。</li><li id="3f7a" class="nl nm jk mc b md nu mg nv mj nw mn nx mr ny mv nq nr ns nt bi translated"><strong class="mc ju">备用索引</strong> —一些数据库也为您提供了可以使用的备用索引。尽管如此，还是很少。大多数情况下，查询优化器可以在选择索引时做出正确的决策，但是对于优化器来说，肯定会有一些盲点，在那里它不能做出最佳决策。</li><li id="d9f9" class="nl nm jk mc b md nu mg nv mj nw mn nx mr ny mv nq nr ns nt bi translated"><strong class="mc ju">未使用的分区</strong> —就像优化器识别未使用的索引一样，它也可以指示您是否没有使用您创建的分区。不使用分区的代价可能更高，因为数据库必须到每个分区去搜索您想要的数据，这些数据可能位于一个或几个分区中。</li><li id="1980" class="nl nm jk mc b md nu mg nv mj nw mn nx mr ny mv nq nr ns nt bi translated"><strong class="mc ju">特定优化</strong> —所有数据库都有不同的内部结构。它们以不同的方式读取、优化和执行查询。可能会对查询应用一些特定于数据库的优化，使其运行得更快。一些像MySQL这样的数据库给你一个选项，让你使用<code class="fe nh ni nj nk b">EXTENDED</code>关键字来查看这些优化。这些信息肯定会对更高级的用户有所帮助。</li></ul><p id="88db" class="pw-post-body-paragraph ma mb jk mc b md mw ku mf mg mx kx mi mj my ml mm mn mz mp mq mr na mt mu mv in bi translated">一旦发现问题，就可以采取必要的措施来解决问题。</p><h1 id="2c4d" class="li lj jk bd lk ll lm ln lo lp lq lr ls kz lt la lu lc lv ld lw lf lx lg ly lz bi translated">查询计划的风格</h1><p id="2356" class="pw-post-body-paragraph ma mb jk mc b md me ku mf mg mh kx mi mj mk ml mm mn mo mp mq mr ms mt mu mv in bi translated">大多数数据库都提供了查看查询执行细节的方法(估计的，如果不是实际的话)，但是所有数据库的细节都不同。因此，期权也是如此。有些数据库允许您查看估计的执行计划，而其他数据库也允许您查看实际的执行计划。怎么会？通过执行查询并记录优化器的决策。</p><p id="f19a" class="pw-post-body-paragraph ma mb jk mc b md mw ku mf mg mx kx mi mj my ml mm mn mz mp mq mr na mt mu mv in bi translated">这些计划也有不同的详细程度和不同的格式。详细程度通常由<code class="fe nh ni nj nk b">EXTENDED</code>关键字或<code class="fe nh ni nj nk b">VERBOSE</code>关键字表示。以下是不同数据库及其<code class="fe nh ni nj nk b">EXPLAIN</code>使用规范的一些示例:</p><figure class="nb nc nd ne gu iw"><div class="bz fq l di"><div class="nf ng l"/></div></figure><h1 id="c915" class="li lj jk bd lk ll lm ln lo lp lq lr ls kz lt la lu lc lv ld lw lf lx lg ly lz bi translated">结论</h1><p id="a1db" class="pw-post-body-paragraph ma mb jk mc b md me ku mf mg mh kx mi mj mk ml mm mn mo mp mq mr ms mt mu mv in bi translated">查询执行计划对于理解查询的工作方式和修复查询的性能问题至关重要。<code class="fe nh ni nj nk b">EXPLAIN</code>通过向你展示执行计划来帮助你实现这两个目标。如何最好地利用这些计划取决于您——您是希望无格式地阅读它们，还是希望将它们可视化，还是希望将它们存储为JSON文档以供以后分析。看看这会把你带到哪里。如果你是数据分析师或数据工程师，你肯定有一些<code class="fe nh ni nj nk b">EXPLAINing</code>要做。</p><p id="9fb2" class="pw-post-body-paragraph ma mb jk mc b md mw ku mf mg mx kx mi mj my ml mm mn mz mp mq mr na mt mu mv in bi translated">如果你觉得我的文章有用，请订阅并查看我的文章🌲<a class="ae jh" href="linktree.com/kovid" rel="noopener ugc nofollow" target="_blank"> <strong class="mc ju"> Linktree </strong> </a>。你也可以考虑用我的推荐链接购买一个中级会员来支持我。</p><div class="it iu gq gs iv oa"><a href="https://kovidrathee.medium.com/membership" rel="noopener follow" target="_blank"><div class="ob ab fp"><div class="oc ab od cl cj oe"><h2 class="bd ju gz z fq of fs ft og fv fx jt bi translated">通过我的推荐链接加入Medium—Kovid rat hee</h2><div class="oh l"><h3 class="bd b gz z fq of fs ft og fv fx dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="oi l"><p class="bd b dl z fq of fs ft og fv fx dk translated">kovidrathee.medium.com\</p></div></div><div class="oj l"><div class="ok l ol om on oj oo jb oa"/></div></div></a></div></div></div>    
</body>
</html>