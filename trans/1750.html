<html>
<head>
<title>SageMaker Batch Transform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SageMaker批量转换</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/sagemaker-batch-transform-d94dbaf889f6#2022-04-25">https://towardsdatascience.com/sagemaker-batch-transform-d94dbaf889f6#2022-04-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="670c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用Sklearn示例生成大型离线预测</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/1b12119e9257e363617f8200efee461d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YuRjXbHZMwpFE54V"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自<a class="ae ky" href="https://unsplash.com/@farber" rel="noopener ugc nofollow" target="_blank">黄邦贤·法伯</a>拍摄的<a class="ae ky" href="https://unsplash.com/photos/6jpdeeA2GBU" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><p id="ad96" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我的上一篇文章中，我谈到了最新的<a class="ae ky" href="https://aws.plainenglish.io/what-sagemaker-inference-option-should-you-use-2e88c8fc70bf" rel="noopener ugc nofollow" target="_blank"> SageMaker推理选项</a>中的<a class="ae ky" rel="noopener" target="_blank" href="/sagemaker-serverless-inference-is-now-generally-available-e42550a146fe">无服务器推理</a>。一个更老但同样重要的选择是<a class="ae ky" href="https://docs.aws.amazon.com/sagemaker/latest/dg/batch-transform.html" rel="noopener ugc nofollow" target="_blank"> SageMaker批量转换</a>。有时候，对于我们的机器学习模型，我们不一定需要一个持久的端点。我们只有一个<strong class="lb iu">大型数据集</strong>，我们希望为该数据返回<strong class="lb iu">推断</strong>。对于没有任何延迟需求的工作负载来说，这是一个很好的选择</p><p id="2372" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用SageMaker批处理转换，我们将探索如何使用<strong class="lb iu"> Sklearn回归模型</strong>并在<strong class="lb iu">样本数据集</strong>上获得<strong class="lb iu">推论</strong>。本例中的数据集不一定很大，但实际上您可以对数千个数据点使用批量转换。一些非常流行的用例包括在您需要实时推理之前对数据集进行预处理，或者为计算机视觉工作负载处理图像数据。</p><p id="28e5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">注意:</strong>对于AWS的新用户，如果你想跟进，请确保在下面的<a class="ae ky" href="https://aws.amazon.com/console/" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">链接</strong> </a>中进行登记。批量转换作业的部署过程中会产生成本。本文还将假设您对SageMaker和AWS有一定的了解。</p><h2 id="a1ea" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">目录</h2><ol class=""><li id="c081" class="mo mp it lb b lc mq lf mr li ms lm mt lq mu lu mv mw mx my bi translated">资料组</li><li id="832e" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated">设置</li><li id="b170" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated">批量转换示例</li><li id="78e4" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated">其他资源和结论</li></ol><h2 id="d458" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">资料组</h2><p id="187e" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">对于我们的示例，我们将使用Kaggle的<a class="ae ky" href="https://www.kaggle.com/datasets/harinir/petrol-consumption" rel="noopener ugc nofollow" target="_blank">汽油消耗回归数据集</a>。原始数据源在这里被许可<a class="ae ky" href="https://creativecommons.org/publicdomain/zero/1.0/" rel="noopener ugc nofollow" target="_blank">。</a></p><h2 id="7cb1" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">设置</h2><p id="c9b3" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">对于我们的示例，我们将使用Kaggle的<a class="ae ky" href="https://www.kaggle.com/datasets/harinir/petrol-consumption" rel="noopener ugc nofollow" target="_blank">汽油消耗回归数据集</a>。在我们得出结论之前，我们将使用SageMaker训练一个<a class="ae ky" href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestRegressor.html" rel="noopener ugc nofollow" target="_blank"> Sklearn随机森林模型</a>。在脚本中，我们还将拥有定制的推理处理程序，以便能够处理我们为推理而输入的csv数据集。在本例中，我们不会深入介绍整个培训设置，但是您可以在这里阅读端对端指南。</p><p id="cd72" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于这个例子，我们将在<a class="ae ky" href="https://docs.aws.amazon.com/sagemaker/latest/dg/studio.html" rel="noopener ugc nofollow" target="_blank"> SageMaker Studio </a>中使用数据科学内核和ml.c5.large实例。如果您已经设置了<a class="ae ky" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-files.html" rel="noopener ugc nofollow" target="_blank"> AWS凭证</a>，您也可以使用<a class="ae ky" href="https://docs.aws.amazon.com/sagemaker/latest/dg/nbi.html" rel="noopener ugc nofollow" target="_blank"> Classic Notebook实例</a>或您的本地环境。首先，我们将读取数据集，看看我们正在处理什么。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nh ni l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">读取数据集</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nj"><img src="../Images/83ab3c6c801ae25761d5e3b1b15c3aad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Um8GrgAfQsdkdgj5fIhbPg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">数据集头(作者截图)</p></figure><p id="c5b1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将把这个数据集分成两部分，一部分用于训练，一部分用于批量推断的测试集。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nh ni l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">分割数据集</p></figure><p id="8f27" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们可以像往常一样将这些数据推送到S3，在那里SageMaker将获取训练数据，并随后将模型工件和推理输出一起转储。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nh ni l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">上传数据到S3</p></figure><p id="fe9b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您将在笔记本中找到的另一组代码是，您可以先<strong class="lb iu">本地测试批量推理</strong>而无需SageMaker。获取您想要使用的模型，并在train.csv文件中对其进行本地训练。之后，获取模型工件(Sklearn的joblib文件)并使用test.csv文件执行推理。如果您可以在本地执行批量推理，那么您就知道如何在您的训练脚本中调整您的<a class="ae ky" href="https://aws.plainenglish.io/adding-custom-inference-scripts-to-amazon-sagemaker-2208c3332510" rel="noopener ugc nofollow" target="_blank">推理处理函数</a>。这是在开始<strong class="lb iu"> SageMaker </strong>培训或推断之前和<strong class="lb iu">调试</strong> <strong class="lb iu">的一个很好的方式。</strong></p><p id="3451" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们可以创建我们的<a class="ae ky" href="https://sagemaker.readthedocs.io/en/stable/frameworks/sklearn/sagemaker.sklearn.html" rel="noopener ugc nofollow" target="_blank"> Sklearn估算器</a>，它自动为Sklearn提取亚马逊支持的<a class="ae ky" href="https://aws.plainenglish.io/how-to-retrieve-amazon-sagemaker-deep-learning-images-ff4a5866299e" rel="noopener ugc nofollow" target="_blank">图像</a>。在这里，我们可以用我们的模型和推理处理器来填充我们的训练脚本。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nh ni l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Sklearn估计量</p></figure><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nh ni l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">培训脚本</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/97ca4a8fb0376b384578c07972b7b0f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mrlih76fWaREQ4qp1ECoCQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">训练成功(作者截图)</p></figure><p id="31dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在下一节中，我们将看看处理输入的推理函数。</p><h2 id="5766" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">批量转换示例</h2><p id="42dc" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">在培训脚本中，您会注意到<strong class="lb iu"> input_fn </strong>已经配置为处理<strong class="lb iu"> CSV输入</strong>。对于您自己创建的示例，这是需要针对您的<strong class="lb iu">模型</strong>所期望的<strong class="lb iu">输入进行调整的函数。在这种情况下，我们将输入一个CSV，因此我们为此配置输入处理程序。</strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nh ni l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">输入函数</p></figure><p id="9148" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">训练完成后，我们现在可以进入批量推断部分。使用<strong class="lb iu">批处理推理</strong>我们不像其他三个SageMaker推理选项那样使用端点。这里我们实例化一个<a class="ae ky" href="https://sagemaker.readthedocs.io/en/stable/api/inference/transformer.html" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu"> Transformer </strong> </a>对象，它将使用您提供的参数启动一个批处理转换作业。类似于实时推理，我们可以抓住经过训练的估计器，并根据它创建一个转换器。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nh ni l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">变压器</p></figure><p id="43d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尽管我们在本文中没有涉及到，但是您可以调整来优化批处理推断的两个旋钮是:<strong class="lb iu">max _ concurrent _ transforms</strong>和<strong class="lb iu"> max_payload </strong>。使用max payload，您可以控制<strong class="lb iu">输入有效负载大小</strong>，使用concurrent transformations，您可以控制发送到转换作业中每个实例的并行请求数量<strong class="lb iu">。默认情况下，它们被设置为下面截图中显示的值。</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/55736c2b06f549fe994d6d16c75d86ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jL9eO3566ywue96QcKBLYQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">批处理作业成功(作者截图)</p></figure><p id="1f04" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在可以执行我们的转换作业，您也可以通过SageMaker控制台对此进行监控。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nh ni l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">转换作业</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/1bf409cfd66962cf32fc80d49c590e1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CuKJt7DPDMHVrkC_kFDqzg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">控制台(作者截图)</p></figure><p id="6506" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">工作完成后，<strong class="lb iu">结果</strong>将被转储到<strong class="lb iu"> S3位置</strong>。我们可以使用SageMaker的<a class="ae ky" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sagemaker.html" rel="noopener ugc nofollow" target="_blank"> Boto3客户端</a>来获取S3 URI，并解析结果文件来显示我们的输出。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nh ni l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">解析转换结果(作者截图)</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/63c0a9addb4d845ff65388c1ebcb41cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:412/format:webp/1*yqpfBgHIOAHZ6ql-25I-AQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">转换结果(作者截图)</p></figure><h2 id="eba0" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">其他资源和结论</h2><div class="no np gp gr nq nr"><a href="https://github.com/RamVegiraju/SageMaker-Deployment/tree/master/BatchTransform/BYOM-Sklearn" rel="noopener  ugc nofollow" target="_blank"><div class="ns ab fo"><div class="nt ab nu cl cj nv"><h2 class="bd iu gy z fp nw fr fs nx fu fw is bi translated">sage maker-Deployment/batch transform/BYOM-sk learn at master RamVegiraju/sage maker-Deployment</h2><div class="ny l"><h3 class="bd b gy z fp nw fr fs nx fu fw dk translated">SageMaker推理选项和其他功能的例子汇编。…</h3></div><div class="nz l"><p class="bd b dl z fp nw fr fs nx fu fw dk translated">github.com</p></div></div><div class="oa l"><div class="ob l oc od oe oa of ks nr"/></div></div></a></div><p id="7912" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">关于示例的整个<strong class="lb iu">代码</strong>，请访问上方的链接<strong class="lb iu">。批处理推理有大量的用例，我希望这篇文章可以作为一个很好的入门和参考，让您用自己的模型和工作负载来尝试这个推理选项。在下面的<a class="ae ky" href="https://github.com/huggingface/notebooks/blob/main/sagemaker/12_batch_transform_inference/sagemaker-notebook.ipynb" rel="noopener ugc nofollow" target="_blank">链接</a>查看另一个很酷的批量推理例子。如果你更喜欢视频教程，下面的<a class="ae ky" href="https://www.coursera.org/lecture/ml-models-human-in-the-loop-pipelines/amazon-sagemaker-batch-transform-batch-inference-svDGb" rel="noopener ugc nofollow" target="_blank">课程</a>中有一个很棒的批量转换部分。</strong></p><p id="5114" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一如既往，我希望这是一篇关于SageMaker推论的好文章，欢迎在评论中留下任何反馈或问题。如果你对更多AWS/SageMaker相关内容感兴趣，请查看我为你编辑的这个<a class="ae ky" href="https://ram-vegiraju.medium.com/list/aws-42b81fcfe143" rel="noopener">列表</a>。</p></div><div class="ab cl og oh hx oi" role="separator"><span class="oj bw bk ok ol om"/><span class="oj bw bk ok ol om"/><span class="oj bw bk ok ol"/></div><div class="im in io ip iq"><p id="01ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="on">如果你喜欢这篇文章，请在</em><a class="ae ky" href="https://www.linkedin.com/in/ram-vegiraju-81272b162/" rel="noopener ugc nofollow" target="_blank"><em class="on">LinkedIn</em></a><em class="on">上与我联系，并订阅我的媒体</em> <a class="ae ky" href="https://ram-vegiraju.medium.com/subscribe" rel="noopener"> <em class="on">简讯</em> </a> <em class="on">。如果你是新手，使用我的</em> <a class="ae ky" href="https://ram-vegiraju.medium.com/membership" rel="noopener"> <em class="on">会员推荐</em> </a> <em class="on">报名。</em></p></div></div>    
</body>
</html>