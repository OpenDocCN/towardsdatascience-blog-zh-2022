<html>
<head>
<title>How To Fix Task received SIGTERM signal In Airflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何确定气流中接收到的信号</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/sigterm-signal-fix-airflow-486ab704b126#2022-06-10">https://towardsdatascience.com/sigterm-signal-fix-airflow-486ab704b126#2022-06-10</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="00db" class="pw-subtitle-paragraph jv it iu bd b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dk translated">修复阿帕奇气流任务中的信号术语</h2></div><figure class="ko kp kq kr gu ks gi gj paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gi gj kn"><img src="../Images/e120c443af565e47a7446172d31bd99e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CrN7qF8TzsIstMx579eIbg.jpeg"/></div></div><p class="kz la gk gi gj lb lc bd b be z dk translated">杰里米·珀金斯在<a class="ae ld" href="https://unsplash.com/s/photos/error?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h2 id="bb8d" class="le lf iu bd lg lh li dn lj lk ll dp lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">介绍</h2><p id="26a7" class="pw-post-body-paragraph ma mb iu mc b md me jz mf mg mh kc mi ln mj mk ml lr mm mn mo lv mp mq mr ms in bi translated">虽然我最近一直在致力于将Dag从气流1 ( <code class="fe jr js jt ju b">v1.10.15</code>)迁移到气流2 ( <code class="fe jr js jt ju b">v2.2.5</code>)，但我花了很多时间试图找出我在一些Dag中遇到的一个错误，这个错误根本不能提供信息。</p><pre class="ko kp kq kr gu mt ju mu mv aw mw bi"><span id="8de3" class="le lf iu ju b gz mx my l mz na">WARNING airflow.exceptions.AirflowException: Task received SIGTERM signal<br/>INFO - Marking task as FAILED.</span></pre><p id="937c" class="pw-post-body-paragraph ma mb iu mc b md nb jz mf mg nc kc mi ln nd mk ml lr ne mn mo lv nf mq mr ms in bi translated">尽管我花了一些时间尝试我在网上找到的可能的解决方案，但似乎没有一个对我有效。</p><p id="8723" class="pw-post-body-paragraph ma mb iu mc b md nb jz mf mg nc kc mi ln nd mk ml lr ne mn mo lv nf mq mr ms in bi translated">在今天的文章中，我将介绍一些针对发送到任务的<code class="fe jr js jt ju b">SIGTERM signal</code>的潜在解决方案，它会导致气流Dag失败。根据您的配置和具体使用情况，可能会有不同的解决方案适合您，因此请确保仔细阅读并尝试每个建议的解决方案。</p></div><div class="ab cl ng nh hy ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="in io ip iq ir"><h2 id="2148" class="le lf iu bd lg lh li dn lj lk ll dp lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">DAG运行超时</h2><p id="6f7c" class="pw-post-body-paragraph ma mb iu mc b md me jz mf mg mh kc mi ln mj mk ml lr mm mn mo lv mp mq mr ms in bi translated">您的任务接收到一个<code class="fe jr js jt ju b">SIGTERM</code>信号的原因之一是由于一个短的<code class="fe jr js jt ju b">dagrun_timeout</code>值。DAG类接受此参数，该参数用于指定DagRun在超时/失败之前应该运行多长时间，以便可以创建新的DAG run。请注意，<strong class="mc iv">超时仅针对计划的</strong> DagRuns。</p><p id="bd69" class="pw-post-body-paragraph ma mb iu mc b md nb jz mf mg nc kc mi ln nd mk ml lr ne mn mo lv nf mq mr ms in bi translated">对于包含许多长时间运行任务的DAG，有可能超过<code class="fe jr js jt ju b">dagrun_timeout</code>，因此活动运行的任务将接收到一个<code class="fe jr js jt ju b">SIGTERM</code>信号，以便DAG可以失败，并执行新的DagRun。</p><p id="c2d0" class="pw-post-body-paragraph ma mb iu mc b md nb jz mf mg nc kc mi ln nd mk ml lr ne mn mo lv nf mq mr ms in bi translated">您可以在Airflow UI上检查DagRun的持续时间，如果您观察到该持续时间大于创建DAG实例时指定的<code class="fe jr js jt ju b">dagrun_timeout</code>值，那么您可以根据您的特定用例将其增加到一个合理的时间量。</p><p id="b362" class="pw-post-body-paragraph ma mb iu mc b md nb jz mf mg nc kc mi ln nd mk ml lr ne mn mo lv nf mq mr ms in bi translated">请注意，此配置适用于DAG，因此您需要提供一个值，以便有足够的时间来运行DAG中包含的所有任务。</p><pre class="ko kp kq kr gu mt ju mu mv aw mw bi"><span id="7e89" class="le lf iu ju b gz mx my l mz na">from datetime import datetime, timedelta</span><span id="786d" class="le lf iu ju b gz nn my l mz na">from airflow.models.dag import DAG<br/></span><span id="7161" class="le lf iu ju b gz nn my l mz na">with DAG(<br/>    'my_dag', <br/>    start_date=datetime(2016, 1, 1),<br/>    schedule_interval='<!-- -->0 * * * *<!-- -->',<br/>    dagrun_timeout=timedelta(minutes=60),<br/>) as dag:<br/>    ...</span></pre></div><div class="ab cl ng nh hy ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="in io ip iq ir"><h2 id="4ba0" class="le lf iu bd lg lh li dn lj lk ll dp lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">内存不足</h2><p id="dd31" class="pw-post-body-paragraph ma mb iu mc b md me jz mf mg mh kc mi ln mj mk ml lr mm mn mo lv mp mq mr ms in bi translated">另一种可能是，当前正在运行气流任务的机器内存不足。根据您部署Airflow的方式，您可能需要检查工作线程的内存使用情况，并确保它们有足够的内存。</p><p id="fba1" class="pw-post-body-paragraph ma mb iu mc b md nb jz mf mg nc kc mi ln nd mk ml lr ne mn mo lv nf mq mr ms in bi translated">例如，如果您的部署在云上，您可能必须检查是否有任何Kubernetes pods被驱逐。吊舱通常由于资源匮乏的节点而被驱逐，因此这可能是你的气流任务接收到<code class="fe jr js jt ju b">SIGTERM</code>信号的原因。</p></div><div class="ab cl ng nh hy ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="in io ip iq ir"><h2 id="5521" class="le lf iu bd lg lh li dn lj lk ll dp lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">元数据数据库耗尽了CPU</h2><p id="6905" class="pw-post-body-paragraph ma mb iu mc b md me jz mf mg mh kc mi ln mj mk ml lr mm mn mo lv mp mq mr ms in bi translated">另一个常见的可能导致Airflow任务接收到<code class="fe jr js jt ju b">SIGTERM</code>信号的问题是元数据数据库上的CPU使用率。</p><p id="db8b" class="pw-post-body-paragraph ma mb iu mc b md nb jz mf mg nc kc mi ln nd mk ml lr ne mn mo lv nf mq mr ms in bi translated">默认情况下，Airflow使用SQLite，它仅用于开发目的，但它旨在支持PostgreSQL、MySQL或MSSQL的数据库后端。</p><p id="7979" class="pw-post-body-paragraph ma mb iu mc b md nb jz mf mg nc kc mi ln nd mk ml lr ne mn mo lv nf mq mr ms in bi translated">数据库上的CPU使用率有可能达到100%,这可能是您的气流任务接收到<code class="fe jr js jt ju b">SIGTERM</code>信号的原因。如果是这种情况，那么您应该考虑增加默认设置为5秒的<code class="fe jr js jt ju b">job_heartbeat_sec</code>配置(或<code class="fe jr js jt ju b">AIRFLOW__SCHEDULER__JOB_HEARTBEAT_SEC</code>环境变量)的值。</p><blockquote class="no np nq"><p id="ebec" class="ma mb nr mc b md nb jz mf mg nc kc mi ns nd mk ml nt ne mn mo nu nf mq mr ms in bi translated"><code class="fe jr js jt ju b">job_heartbeat_sec</code></p><p id="d77a" class="ma mb nr mc b md nb jz mf mg nc kc mi ns nd mk ml nt ne mn mo nu nf mq mr ms in bi translated">任务实例监听外部终止信号(当您从CLI或UI清除任务时)，这定义了它们应该监听的频率(以秒为单位)。</p><p id="2c25" class="ma mb nr mc b md nb jz mf mg nc kc mi ns nd mk ml nt ne mn mo nu nf mq mr ms in bi translated">- <a class="ae ld" href="https://airflow.apache.org/docs/apache-airflow/stable/configurations-ref.html#job-heartbeat-sec" rel="noopener ugc nofollow" target="_blank">气流文件</a></p></blockquote><p id="5d6f" class="pw-post-body-paragraph ma mb iu mc b md nb jz mf mg nc kc mi ln nd mk ml lr ne mn mo lv nf mq mr ms in bi translated">在气流配置文件<code class="fe jr js jt ju b">airflow.cfg</code>中，确保在<code class="fe jr js jt ju b">scheduler</code>部分指定该配置，如下图所示。</p><pre class="ko kp kq kr gu mt ju mu mv aw mw bi"><span id="71d5" class="le lf iu ju b gz mx my l mz na">[scheduler]<br/>job_heartbeat_sec = 20</span></pre><p id="7d85" class="pw-post-body-paragraph ma mb iu mc b md nb jz mf mg nc kc mi ln nd mk ml lr ne mn mo lv nf mq mr ms in bi translated">或者，您可以通过相应的环境变量修改此配置的值:</p><pre class="ko kp kq kr gu mt ju mu mv aw mw bi"><span id="6ff7" class="le lf iu ju b gz mx my l mz na">export AIRFLOW__SCHEDULER__JOB_HEARTBEAT_SEC=20</span></pre><p id="77fc" class="pw-post-body-paragraph ma mb iu mc b md nb jz mf mg nc kc mi ln nd mk ml lr ne mn mo lv nf mq mr ms in bi translated">如果数据库级别的CPU消耗是一个问题，那么增加上述配置现在应该可以显著减少CPU的使用。</p></div><div class="ab cl ng nh hy ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="in io ip iq ir"><h2 id="36b1" class="le lf iu bd lg lh li dn lj lk ll dp lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">禁用“迷你计划程序”</h2><p id="ac34" class="pw-post-body-paragraph ma mb iu mc b md me jz mf mg mh kc mi ln mj mk ml lr mm mn mo lv mp mq mr ms in bi translated">默认情况下，任务管理器进程会尝试调度同一气流DAG的更多任务，以提高性能并最终帮助DAG在更短的时间内执行。</p><p id="63e9" class="pw-post-body-paragraph ma mb iu mc b md nb jz mf mg nc kc mi ln nd mk ml lr ne mn mo lv nf mq mr ms in bi translated">该行为通过默认为<code class="fe jr js jt ju b">True</code>的<code class="fe jr js jt ju b">schedule_after_task_execution</code>进行配置。</p><blockquote class="no np nq"><p id="8875" class="ma mb nr mc b md nb jz mf mg nc kc mi ns nd mk ml nt ne mn mo nu nf mq mr ms in bi translated"><code class="fe jr js jt ju b">schedule_after_task_execution</code></p><p id="2752" class="ma mb nr mc b md nb jz mf mg nc kc mi ns nd mk ml nt ne mn mo nu nf mq mr ms in bi translated">任务管理器进程是否应该执行“迷你调度器”来尝试调度同一DAG的更多任务。启用此选项将意味着同一DAG中的任务执行得更快，但在某些情况下可能会耗尽其他DAG。</p><p id="c455" class="ma mb nr mc b md nb jz mf mg nc kc mi ns nd mk ml nt ne mn mo nu nf mq mr ms in bi translated">- <a class="ae ld" href="https://airflow.apache.org/docs/apache-airflow/stable/configurations-ref.html#schedule-after-task-execution" rel="noopener ugc nofollow" target="_blank">气流文件</a></p></blockquote><p id="e0d8" class="pw-post-body-paragraph ma mb iu mc b md nb jz mf mg nc kc mi ln nd mk ml lr ne mn mo lv nf mq mr ms in bi translated">由于气流中的一个<a class="ae ld" href="https://github.com/apache/airflow/pull/16289" rel="noopener ugc nofollow" target="_blank"> bug </a>，任务被<code class="fe jr js jt ju b">LocalTaskJob</code>心跳杀死的几率相当高。因此，一个可能的解决方案是简单地禁用迷你调度程序。</p><p id="ed5d" class="pw-post-body-paragraph ma mb iu mc b md nb jz mf mg nc kc mi ln nd mk ml lr ne mn mo lv nf mq mr ms in bi translated">在您的气流配置文件<code class="fe jr js jt ju b">airflow.cfg</code>中，您需要将<code class="fe jr js jt ju b"><em class="nr">schedule_after_task_execution</em></code> <em class="nr"> </em>设置为False。</p><pre class="ko kp kq kr gu mt ju mu mv aw mw bi"><span id="12b4" class="le lf iu ju b gz mx my l mz na">[scheduler]<br/>schedule_after_task_execution = False</span></pre><p id="f65d" class="pw-post-body-paragraph ma mb iu mc b md nb jz mf mg nc kc mi ln nd mk ml lr ne mn mo lv nf mq mr ms in bi translated">或者，可以通过<code class="fe jr js jt ju b">AIRFLOW__SCHEDULER__SCHEDULE_AFTER_TASK_EXECUTION</code>环境变量覆盖该配置:</p><pre class="ko kp kq kr gu mt ju mu mv aw mw bi"><span id="f1c7" class="le lf iu ju b gz mx my l mz na">export AIRFLOW__SCHEDULER__SCHEDULE_AFTER_TASK_EXECUTION=False</span></pre><p id="9c05" class="pw-post-body-paragraph ma mb iu mc b md nb jz mf mg nc kc mi ln nd mk ml lr ne mn mo lv nf mq mr ms in bi translated">如果这是你的问题所在，那么你可能也想考虑将Airflow升级到一个修复了这个bug的版本。</p></div><div class="ab cl ng nh hy ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="in io ip iq ir"><h2 id="78f3" class="le lf iu bd lg lh li dn lj lk ll dp lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">最后的想法</h2><p id="f311" class="pw-post-body-paragraph ma mb iu mc b md me jz mf mg mh kc mi ln mj mk ml lr mm mn mo lv mp mq mr ms in bi translated">在今天的教程中，我们讨论了<code class="fe jr js jt ju b">SIGTERM</code>信号的含义，该信号有时会发送到气流任务，导致Dag失败。我们讨论了发生这种情况的几个潜在原因，并展示了如何根据您的具体用例来克服这个问题。</p><p id="c958" class="pw-post-body-paragraph ma mb iu mc b md nb jz mf mg nc kc mi ln nd mk ml lr ne mn mo lv nf mq mr ms in bi translated">请注意，您的配置也有可能遇到本教程中讨论的不止一个问题，因此您可能需要应用我们今天讨论的解决方案组合来消除<code class="fe jr js jt ju b">SIGTERM</code>信号。</p></div><div class="ab cl ng nh hy ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="in io ip iq ir"><p id="1b77" class="pw-post-body-paragraph ma mb iu mc b md nb jz mf mg nc kc mi ln nd mk ml lr ne mn mo lv nf mq mr ms in bi translated"><a class="ae ld" href="https://gmyrianthous.medium.com/membership" rel="noopener"> <strong class="mc iv">成为会员</strong> </a> <strong class="mc iv">阅读介质上的每一个故事。你的会员费直接支持我和你看的其他作家。你也可以在媒体上看到所有的故事。</strong></p><div class="nv nw gq gs nx ny"><a href="https://gmyrianthous.medium.com/membership" rel="noopener follow" target="_blank"><div class="nz ab fp"><div class="oa ab ob cl cj oc"><h2 class="bd iv gz z fq od fs ft oe fv fx it bi translated">通过我的推荐链接加入Medium-Giorgos Myrianthous</h2><div class="of l"><h3 class="bd b gz z fq od fs ft oe fv fx dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="og l"><p class="bd b dl z fq od fs ft oe fv fx dk translated">gmyrianthous.medium.com</p></div></div><div class="oh l"><div class="oi l oj ok ol oh om kx ny"/></div></div></a></div></div><div class="ab cl ng nh hy ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="in io ip iq ir"><p id="676e" class="pw-post-body-paragraph ma mb iu mc b md nb jz mf mg nc kc mi ln nd mk ml lr ne mn mo lv nf mq mr ms in bi translated"><strong class="mc iv">相关文章你可能也喜欢</strong></p><div class="nv nw gq gs nx ny"><a rel="noopener follow" target="_blank" href="/run-airflow-docker-1b83a57616fb"><div class="nz ab fp"><div class="oa ab ob cl cj oc"><h2 class="bd iv gz z fq od fs ft oe fv fx it bi translated">如何使用Docker在本地运行气流</h2><div class="of l"><h3 class="bd b gz z fq od fs ft oe fv fx dk translated">在本地机器上使用Docker运行Airflow的分步指南</h3></div><div class="og l"><p class="bd b dl z fq od fs ft oe fv fx dk translated">towardsdatascience.com</p></div></div><div class="oh l"><div class="on l oj ok ol oh om kx ny"/></div></div></a></div></div><div class="ab cl ng nh hy ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="in io ip iq ir"><div class="ko kp kq kr gu ny"><a rel="noopener follow" target="_blank" href="/hashicorp-vault-airflow-cfdddab31ea"><div class="nz ab fp"><div class="oa ab ob cl cj oc"><h2 class="bd iv gz z fq od fs ft oe fv fx it bi translated">如何用气流设置HashiCorp保险库</h2><div class="of l"><h3 class="bd b gz z fq od fs ft oe fv fx dk translated">将HashiCorp Vault与Apache Airflow集成</h3></div><div class="og l"><p class="bd b dl z fq od fs ft oe fv fx dk translated">towardsdatascience.com</p></div></div><div class="oh l"><div class="oo l oj ok ol oh om kx ny"/></div></div></a></div></div><div class="ab cl ng nh hy ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="in io ip iq ir"><div class="ko kp kq kr gu ny"><a rel="noopener follow" target="_blank" href="/connect-airflow-worker-gcp-e79690f3ecea"><div class="nz ab fp"><div class="oa ab ob cl cj oc"><h2 class="bd iv gz z fq od fs ft oe fv fx it bi translated">如何在Cloud Composer上连接到气流工作者</h2><div class="of l"><h3 class="bd b gz z fq od fs ft oe fv fx dk translated">在谷歌云平台上连接气流工作者</h3></div><div class="og l"><p class="bd b dl z fq od fs ft oe fv fx dk translated">towardsdatascience.com</p></div></div><div class="oh l"><div class="op l oj ok ol oh om kx ny"/></div></div></a></div></div></div>    
</body>
</html>