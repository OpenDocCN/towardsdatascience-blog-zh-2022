<html>
<head>
<title>How to Build a Point-in-Time Recovery Solution for Your Azure Data Lake</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何为您的 Azure 数据湖构建时间点恢复解决方案</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-recover-your-azure-data-lake-5b5e53f3736f#2022-03-26">https://towardsdatascience.com/how-to-recover-your-azure-data-lake-5b5e53f3736f#2022-03-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9a45" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">利用快照、软删除和 Azure 功能在 Azure 数据湖存储上构建时间点恢复解决方案。</h2></div><p id="7dda" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="le"> TLTR:在</em> <a class="ae lf" href="https://github.com/rebremer/azure-functions-datalake-recovery-pitr/blob/main/script.ps1" rel="noopener ugc nofollow" target="_blank"> <em class="le">克隆项目并运行脚本 https://github . com/rebremer/azure-functions-data lake-recovery-pitr/blob/main/script . PS1</em></a><em class="le">部署解决方案</em></p><h1 id="bfe6" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">1.介绍</h1><p id="ac52" class="pw-post-body-paragraph ki kj it kk b kl ly ju kn ko lz jx kq kr ma kt ku kv mb kx ky kz mc lb lc ld im bi translated">企业数据湖中的一个普遍担忧是，由于应用程序错误或人为错误，数据会被破坏。在这种情况下，可能需要执行时间点恢复(PiTR)并恢复快照。启用了分层命名空间(HNS)的 Azure 存储尚不支持 PiTR。但是，快照和软删除是可用的，可以用作创建恢复解决方案的构造块。</p><p id="5506" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这篇博客和 git repo <code class="fe md me mf mg b"><a class="ae lf" href="https://github.com/rebremer/azure-functions-datalake-recovery-pitr" rel="noopener ugc nofollow" target="_blank">azure-functions-datalake-recovery-pitr</a></code>中，讨论了如何使用快照、软删除和 Azure 函数来实现 PiTR，参见下面的架构。</p><figure class="mi mj mk ml gt mm gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi mh"><img src="../Images/d27160499fa8ac7ec1777bea8daad670.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lGC5oQhCz1ZJSji39gy6rw.png"/></div></div><p class="mt mu gj gh gi mv mw bd b be z dk translated">1.建筑——作者的图像</p></figure><p id="42b6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这篇博文的剩余部分，我们将更详细地解释数据湖恢复项目。这将按如下方式完成:</p><ul class=""><li id="77ee" class="mx my it kk b kl km ko kp kr mz kv na kz nb ld nc nd ne nf bi translated">在第 2 章中，确保在数据湖中添加/修改文件时创建快照。</li><li id="bcbf" class="mx my it kk b kl ng ko nh kr ni kv nj kz nk ld nc nd ne nf bi translated">在第 3 章中，详细解释了如何使用这些快照来构建数据湖恢复功能，以便在数据损坏时加以利用。此外，解决方案的可扩展性将在第 3.3 章中讨论。</li></ul><p id="e4c6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，要了解更多关于灾难恢复的知识，请参阅我之前的<a class="ae lf" rel="noopener" target="_blank" href="/disaster-recovery-scenarios-for-azure-storage-sql-cosmos-db-synapse-9bf5b561f858">博客</a>。</p><h1 id="7ed8" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">2.基于事件:创建快照</h1><p id="c561" class="pw-post-body-paragraph ki kj it kk b kl ly ju kn ko lz jx kq kr ma kt ku kv mb kx ky kz mc lb lc ld im bi translated">在这一章中，项目开始运行。在这方面，需要做以下工作:</p><ul class=""><li id="edb9" class="mx my it kk b kl km ko kp kr mz kv na kz nb ld nc nd ne nf bi translated">2.1 先决条件</li><li id="21ab" class="mx my it kk b kl ng ko nh kr ni kv nj kz nk ld nc nd ne nf bi translated">2.2 设置 Azure 数据湖</li><li id="a845" class="mx my it kk b kl ng ko nh kr ni kv nj kz nk ld nc nd ne nf bi translated">2.3 设置快照创建</li></ul><p id="37d3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">另请参见下面的概述:</p><figure class="mi mj mk ml gt mm gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi nl"><img src="../Images/457684a211329b871708faba96e74d87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RywLa0oCGN7agUPFUO9DfQ.png"/></div></div><p class="mt mu gj gh gi mv mw bd b be z dk translated">2.架构，基于事件的快照创建—按作者创建图像</p></figure><h2 id="ec0c" class="nm lh it bd li nn no dn lm np nq dp lq kr nr ns ls kv nt nu lu kz nv nw lw nx bi translated">2.1 先决条件</h2><p id="8953" class="pw-post-body-paragraph ki kj it kk b kl ly ju kn ko lz jx kq kr ma kt ku kv mb kx ky kz mc lb lc ld im bi translated">本教程需要以下先决条件:</p><ul class=""><li id="8173" class="mx my it kk b kl km ko kp kr mz kv na kz nb ld nc nd ne nf bi translated"><a class="ae lf" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a></li><li id="cf55" class="mx my it kk b kl ng ko nh kr ni kv nj kz nk ld nc nd ne nf bi translated"><a class="ae lf" href="https://www.python.org/downloads/" rel="noopener ugc nofollow" target="_blank"> Python 3.7+ </a></li><li id="5595" class="mx my it kk b kl ng ko nh kr ni kv nj kz nk ld nc nd ne nf bi translated"><a class="ae lf" href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-run-local" rel="noopener ugc nofollow" target="_blank"> Azure 功能核心工具</a></li></ul><p id="e619" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，将下面的 git repo 克隆到您的本地计算机上。如果你没有安装 git，你可以从网页上下载一个 zip 文件。</p><pre class="mi mj mk ml gt ny mg nz oa aw ob bi"><span id="0eb2" class="nm lh it mg b gy oc od l oe of">git clone <a class="ae lf" href="https://github.com/rebremer/azure-functions-datalake-recovery-pitr" rel="noopener ugc nofollow" target="_blank">https://github.com/rebremer/azure-functions-datalake-recovery-pitr</a></span></pre><h2 id="7043" class="nm lh it bd li nn no dn lm np nq dp lq kr nr ns ls kv nt nu lu kz nv nw lw nx bi translated">2.2 设置 Azure 数据湖</h2><p id="fec6" class="pw-post-body-paragraph ki kj it kk b kl ly ju kn ko lz jx kq kr ma kt ku kv mb kx ky kz mc lb lc ld im bi translated">在这一部分中，使用以下属性创建了一个 Azure 数据湖</p><ul class=""><li id="5c24" class="mx my it kk b kl km ko kp kr mz kv na kz nb ld nc nd ne nf bi translated">支持分层命名空间(HNS)的 Azure 存储帐户提供了真正的文件系统，而不是基于对象的存储</li><li id="b9a1" class="mx my it kk b kl ng ko nh kr ni kv nj kz nk ld nc nd ne nf bi translated">为启用了 HNS 的存储帐户启用快照预览，请参见<a class="ae lf" href="https://learn.microsoft.com/en-us/azure/storage/blobs/snapshots-overview#about-blob-snapshots" rel="noopener ugc nofollow" target="_blank">https://learn . Microsoft . com/en-us/azure/storage/blob/snapshot s-overview # about-blob-snapshot s</a></li><li id="0c2d" class="mx my it kk b kl ng ko nh kr ni kv nj kz nk ld nc nd ne nf bi translated">已禁用访问密钥，仅允许 Azure AD 作为身份外围设备</li><li id="d973" class="mx my it kk b kl ng ko nh kr ni kv nj kz nk ld nc nd ne nf bi translated">启用软删除</li></ul><p id="7bb7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">运行以下脚本:</p><pre class="mi mj mk ml gt ny mg nz oa aw ob bi"><span id="208e" class="nm lh it mg b gy oc od l oe of"># 0. Set variables<br/>#<br/>$SUB='&lt;&lt;your subscription&gt;&gt;'<br/>$RG='&lt;&lt;your resource group&gt;&gt;'<br/>$LOC='&lt;&lt;your location&gt;&gt;'                             <br/>$DLSTOR='&lt;&lt;your data lake account&gt;&gt;'<br/>$FILE_SYSTEM='&lt;&lt;your data lake file system name&gt;&gt;'<br/>$EMAIL='&lt;&lt;your email address&gt;&gt;'              <br/><br/># 1. Create resource group<br/>#<br/>az account set --subscription $SUB                 <br/>az group create -n $RG -l $LOC</span><span id="a175" class="nm lh it mg b gy og od l oe of"># 2. Create data lake account<br/>#<br/>az storage account create -n $DLSTOR -g $RG -l $LOC --sku Standard_LRS --kind StorageV2 --enable-hierarchical-namespace true --allow-shared-key-access false</span><span id="735a" class="nm lh it mg b gy og od l oe of"># 3. Add yourself as user to data lake acount<br/>#<br/>$scope="/subscriptions/$SUB/resourceGroups/$RG/providers/Microsoft.Storage/storageAccounts/$DLSTOR/blobServices/default"<br/>az role assignment create --role "Storage Blob Data Contributor" --assignee $email --scope $scope            </span><span id="98e1" class="nm lh it mg b gy og od l oe of"># 4. Enable soft delete on storage acount<br/>#<br/>az storage account blob-service-properties update -n $DLSTOR -g $RG --enable-delete-retention true --delete-retention-days 7</span><span id="88a5" class="nm lh it mg b gy og od l oe of"># 5. Create File System on date lake account<br/>#<br/>az storage container create --account-name $DLSTOR -n $FILE_SYSTEM --auth-mode login</span></pre><h2 id="adfa" class="nm lh it bd li nn no dn lm np nq dp lq kr nr ns ls kv nt nu lu kz nv nw lw nx bi translated">2.3 设置快照创建</h2><p id="0ae7" class="pw-post-body-paragraph ki kj it kk b kl ly ju kn ko lz jx kq kr ma kt ku kv mb kx ky kz mc lb lc ld im bi translated">在这一部分中，一旦创建或更新了文件，就会创建快照。这是按如下方式完成的:</p><ul class=""><li id="20ac" class="mx my it kk b kl km ko kp kr mz kv na kz nb ld nc nd ne nf bi translated">创建侦听存储帐户的事件网格</li><li id="896a" class="mx my it kk b kl ng ko nh kr ni kv nj kz nk ld nc nd ne nf bi translated">一旦文件被创建/修改，事件网格 Azure Functions 被触发</li><li id="baf9" class="mx my it kk b kl ng ko nh kr ni kv nj kz nk ld nc nd ne nf bi translated">Azure Functions 创建文件快照</li></ul><p id="f4fd" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">另请参见下面的脚本:</p><pre class="mi mj mk ml gt ny mg nz oa aw ob bi"><span id="2cce" class="nm lh it mg b gy oc od l oe of"># 0. Set variables<br/>#<br/>$SUB='&lt;&lt;your subscription&gt;&gt;'<br/>$RG='&lt;&lt;your resource group&gt;&gt;'<br/>$LOC='&lt;&lt;your location&gt;&gt;'<br/>$DLSTOR='&lt;&lt;your data lake account&gt;&gt;'<br/>$FUNSTOR='&lt;&lt;your azure function storage account&gt;&gt;'<br/>$FUNNAME='&lt;&lt;your azure function name&gt;&gt;'<br/>$FUNPN='&lt;&lt;your azure function app plan name&gt;&gt;'</span><span id="4be7" class="nm lh it mg b gy og od l oe of"># 1. Deploy Event Grid triggered Functions<br/>#<br/>az functionapp plan create -g $RG -n $FUNPN --sku B1 --is-linux true<br/>az storage account create -n $FUNSTOR -g $RG -l $LOC --sku Standard_LRS --kind StorageV2<br/>az functionapp create -n $FUNNAME -g $RG -s $FUNSTOR -p $FUNPN --assign-identity --runtime Python<br/>$function_mi=$(az functionapp show -n $FUNNAME -g $RG | ConvertFrom-Json).identity.principalId<br/>az role assignment create --assignee $function_mi --role "Storage Blob Data Contributor" --scope $scope<br/>func azure functionapp publish $FUNNAME                             </span><span id="a3fa" class="nm lh it mg b gy og od l oe of"># 2. Subscribe to event grid<br/>#<br/>$stordlid = "/subscriptions/$SUB/resourceGroups/$RG/providers/Microsoft.Storage/storageaccounts/$DLSTOR"<br/>$endpointid = "/subscriptions/$SUB/resourceGroups/$RG/providers/Microsoft.Web/sites/$FUNNAME/functions/EventGridTriggerCreateSnapshot"<br/>az eventgrid event-subscription create --name storegversion --source-resource-id $stordlid --endpoint-type azurefunction --endpoint $endpointid --included-event-types Microsoft.Storage.BlobCreated</span></pre><p id="354b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果现在文件被上传到存储帐户或被修改，则会自动创建快照，另请参见下图。</p><figure class="mi mj mk ml gt mm gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi oh"><img src="../Images/508c366321978989af69bc213f475aa1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CuXVIkcJkgFQ1a7mzBO5iQ.png"/></div></div><p class="mt mu gj gh gi mv mw bd b be z dk translated">2.3 自动快照创建—按作者创建图像</p></figure><p id="b6d0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在下一章中，我们将讨论 Azure 函数，它可以用来恢复快照。</p><h1 id="2ffa" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">3.发生灾难时:恢复数据湖</h1><p id="8995" class="pw-post-body-paragraph ki kj it kk b kl ly ju kn ko lz jx kq kr ma kt ku kv mb kx ky kz mc lb lc ld im bi translated">在这一章中，数据湖将在灾难发生时恢复。在这方面，需要做以下工作:</p><ul class=""><li id="f4e1" class="mx my it kk b kl km ko kp kr mz kv na kz nb ld nc nd ne nf bi translated">3.1 讨论灾难恢复场景</li><li id="39c0" class="mx my it kk b kl ng ko nh kr ni kv nj kz nk ld nc nd ne nf bi translated">3.2 设置和运行 Azure 持久功能</li><li id="5f90" class="mx my it kk b kl ng ko nh kr ni kv nj kz nk ld nc nd ne nf bi translated">3.3 规模数据湖恢复解决方案</li></ul><p id="8a54" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">另请参见下面的概述:</p><figure class="mi mj mk ml gt mm gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi nl"><img src="../Images/d0775f387fa5031e90d8b826d4da7312.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vxkUANnVewSe3yHg_b1aeQ.png"/></div></div></figure><h2 id="c4ae" class="nm lh it bd li nn no dn lm np nq dp lq kr nr ns ls kv nt nu lu kz nv nw lw nx bi translated">3.1 讨论灾难恢复场景</h2><p id="a5a1" class="pw-post-body-paragraph ki kj it kk b kl ly ju kn ko lz jx kq kr ma kt ku kv mb kx ky kz mc lb lc ld im bi translated">当数据损坏发生时，您希望恢复数据损坏前的状态。让我们把这个时刻命名为 restore_date。那么对于每个单独的文件，下面的场景是真实的</p><ul class=""><li id="3b73" class="mx my it kk b kl km ko kp kr mz kv na kz nb ld nc nd ne nf bi translated">场景 1: file_last_modified &lt; restore_date. In this situation, the file was last modified before corruption occured =&gt;什么都不做</li><li id="0b57" class="mx my it kk b kl ng ko nh kr ni kv nj kz nk ld nc nd ne nf bi translated">场景 2:文件创建时间&gt;恢复日期。在这种情况下，文件仅在发生损坏后创建= &gt;软删除文件</li><li id="a292" class="mx my it kk b kl ng ko nh kr ni kv nj kz nk ld nc nd ne nf bi translated">场景 3:文件创建时间&lt; restore_date &lt; file_last_modified &amp;&amp; snapshot is present before restore_date =&gt;恢复快照</li><li id="83ba" class="mx my it kk b kl ng ko nh kr ni kv nj kz nk ld nc nd ne nf bi translated">场景 4: file_creation_time &lt; restore_date &lt; file_last_modified &amp;&amp; NO_snapshot is present before restore_date =&gt;提出条件，创建需要更多调查的警报下一步做什么</li></ul><p id="023b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请注意，当实现第 2 章中解释的基于事件的快照时，场景 4 永远不会发生；每当创建或修改文件时，都会创建快照。4 个场景的详细逻辑可以在下面的 Python 文件中找到:<code class="fe md me mf mg b"><a class="ae lf" href="https://github.com/rebremer/azure-functions-datalake-recovery-pitr/blob/main/ActivityPointInTimeRecovery/__init__.py#L91" rel="noopener ugc nofollow" target="_blank">ActivityPointInTimeRecovery</a></code></p><h2 id="6d7c" class="nm lh it bd li nn no dn lm np nq dp lq kr nr ns ls kv nt nu lu kz nv nw lw nx bi translated">3.2 安装和 Azure 持久功能</h2><p id="0a92" class="pw-post-body-paragraph ki kj it kk b kl ly ju kn ko lz jx kq kr ma kt ku kv mb kx ky kz mc lb lc ld im bi translated">通常，企业数据湖包含数百个容器、数百个文件夹和子文件夹以及数 TB 的数据。要恢复数据湖，以下是关键:</p><ul class=""><li id="5ce5" class="mx my it kk b kl km ko kp kr mz kv na kz nb ld nc nd ne nf bi translated">恢复数据湖应该是精细的。应该可以恢复单个容器，甚至文件夹，而不是整个存储帐户</li><li id="a8c2" class="mx my it kk b kl ng ko nh kr ni kv nj kz nk ld nc nd ne nf bi translated">修复应在大范围内进行。这应该并行进行，而不是让一个进程一个接一个地恢复文件夹和文件</li></ul><p id="8e84" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae lf" href="https://docs.microsoft.com/en-us/azure/azure-functions/durable/durable-functions-cloud-backup?tabs=python" rel="noopener ugc nofollow" target="_blank"> Azure 持久功能扇入/扇出模式</a>正是这么做的。在这个场景中，多个函数被并发执行，文件夹被递归解析。</p><p id="d8a7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在下面的脚本中，代码被部署到一个 Azure 函数。也可以决定先在本地运行 Azure(见脚本<a class="ae lf" href="https://github.com/rebremer/azure-functions-datalake-recovery-pitr/blob/main/script.ps1#L84" rel="noopener ugc nofollow" target="_blank">此处</a>)。运行以下脚本以部署到 Azure 功能:</p><pre class="mi mj mk ml gt ny mg nz oa aw ob bi"><span id="290c" class="nm lh it mg b gy oc od l oe of"># 0. Set variables<br/>#<br/>$RG='&lt;&lt;your resource group&gt;&gt;'<br/>$DLSTOR='&lt;&lt;your data lake account&gt;&gt;'<br/>$FILE_SYSTEM='&lt;&lt;your data lake file system name&gt;&gt;'<br/>$FUNNAME='&lt;&lt;your azure function name&gt;&gt;'</span><span id="7ab4" class="nm lh it mg b gy og od l oe of"># 1. Deploy Function<br/>#<br/>func azure functionapp publish $FUNNAME</span><span id="2840" class="nm lh it mg b gy og od l oe of"># 2. Get function key<br/>#<br/>$code=$(az functionapp keys list -n $FUNNAME -g $RG | ConvertFrom-Json).functionKeys.default</span><span id="eb84" class="nm lh it mg b gy og od l oe of"># 3. Create sample folders and files in File System<br/>#<br/>Invoke-RestMethod "https://$FUNNAME.azurewebsites.net/api/orchestrators/OrchestratorInitFileSystem?code=$code&amp;storage_account_name=$DLSTOR&amp;file_system=$FILE_SYSTEM&amp;number_of_folders=2"</span><span id="6f79" class="nm lh it mg b gy og od l oe of"># 4. Restore data lake (play around with restore_date in URL to test # four scenarios described in 2.2<br/>#<br/>Invoke-RestMethod "https://$FUNNAME.azurewebsites.net/api/orchestrators/OrchestratorPointInTimeRecovery?code=$code&amp;restore_date=2021-01-20T00:00:00.0000000Z&amp;storage_account_name=$DLSTOR&amp;file_system=$FILE_SYSTEM&amp;number_of_folders=2"</span></pre><p id="70b1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">脚本成功运行后，一个包含 2 个文件夹和 100 个子文件夹的文件系统被设置，每个子文件夹包含 10 个文件，另请参见下面的屏幕截图:</p><figure class="mi mj mk ml gt mm gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi oi"><img src="../Images/5b323ceaa462e01c0f62f2d876cdf1d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*llOmSk-zPzCGzzTum59iGw.png"/></div></div><p class="mt mu gj gh gi mv mw bd b be z dk translated">3.2.1 目录 1，子目录 12，包含 10 个文件</p></figure><p id="095a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用快照，可以选择任何日期来恢复快照。逻辑描述了将恢复哪些快照(如果有)，请参见下面示例文件中可以恢复的可能快照:</p><figure class="mi mj mk ml gt mm gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi oj"><img src="../Images/fe136a14b72cd10a779b8440d86f5bad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rHOOte_CwJjETLvViUaz6g.png"/></div></div><p class="mt mu gj gh gi mv mw bd b be z dk translated">3.2.2 目录、子目录 12、文件测试快照 5.txt、要恢复的可能快照</p></figure><h2 id="529b" class="nm lh it bd li nn no dn lm np nq dp lq kr nr ns ls kv nt nu lu kz nv nw lw nx bi translated">3.3 规模数据湖恢复解决方案</h2><p id="cfcd" class="pw-post-body-paragraph ki kj it kk b kl ly ju kn ko lz jx kq kr ma kt ku kv mb kx ky kz mc lb lc ld im bi translated">选择 Azure 持久功能是因为它的伸缩能力。在上一章中，创建了一个只有两个文件夹的 file_system。通过改变 InitFileSystem 函数中的参数<code class="fe md me mf mg b">&amp;number_of_folders=10000</code>，可以建立一个 10M(10000 * 100 * 10)文件的文件夹结构。但是，在执行此操作之前，该解决方案应进行扩展，因为基本 SKU 仅用于 1 名员工。有两种选择两种规模。</p><ul class=""><li id="e616" class="mx my it kk b kl km ko kp kr mz kv na kz nb ld nc nd ne nf bi translated">纵向扩展:通过纵向扩展，可以使用拥有更多内核/内存的虚拟机。通过使用更多的内核和内存，可以在同一台机器上运行多个恢复线程。最高的 SKU 是<a class="ae lf" href="https://docs.microsoft.com/en-us/azure/app-service/app-service-configure-premium-tier#create-an-app-in-premiumv3-tier" rel="noopener ugc nofollow" target="_blank"> P3V3 </a>，其中使用了 8 个内核(相比之下，3.2 中使用的基本 SKU 只有一个内核)</li><li id="72ad" class="mx my it kk b kl ng ko nh kr ni kv nj kz nk ld nc nd ne nf bi translated">横向扩展:通过横向扩展，多个虚拟机/工作人员用于运行恢复作业。如果使用 2 个内核的 P1V3 SKU，虚拟机的最大数量为 30，另请参见下图</li></ul><figure class="mi mj mk ml gt mm gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi ok"><img src="../Images/8ad85e13ab5f6955d9aa6850ddca4092.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xMEYT43Bqhb-C6ZcDEkeYA.png"/></div></div><p class="mt mu gj gh gi mv mw bd b be z dk translated">3.3 SKU P1 v3 中的横向扩展解决方案最多 30 个实例(工作人员)</p></figure><p id="5a1a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">通过横向扩展，该解决方案可以真正扩展到在几分钟/几小时内恢复 1000 万个文件。最后，请注意，文件大小并不重要，因为在恢复解决方案中使用了快照。通过使用快照，数据不会被拷贝回来，这非常耗时。相反，<strong class="kk iu"> </strong>斑点的<strong class="kk iu"> </strong>状态通过指回在恢复时刻当前的<a class="ae lf" href="https://docs.microsoft.com/en-us/rest/api/storageservices/understanding-block-blobs--append-blobs--and-page-blobs#about-block-blobs" rel="noopener ugc nofollow" target="_blank">块斑点 id</a>来恢复。</p><h1 id="110c" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">4.结论</h1><p id="ef76" class="pw-post-body-paragraph ki kj it kk b kl ly ju kn ko lz jx kq kr ma kt ku kv mb kx ky kz mc lb lc ld im bi translated">企业数据湖中的一个普遍担忧是，由于应用程序错误或人为错误，数据会被破坏。在这种情况下，可能需要执行时间点恢复(PiTR)并恢复快照。启用了分层名称空间(HNS)的 Azure 存储尚不支持 PiTR。</p><p id="455b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这篇博客和 git repo <code class="fe md me mf mg b"><a class="ae lf" href="https://github.com/rebremer/azure-functions-datalake-recovery-pitr" rel="noopener ugc nofollow" target="_blank">azure-functions-datalake-recovery-pitr</a></code>中，讨论了如何使用基于事件的快照创建、软删除和 Azure 持久功能来实现 PiTR 的可伸缩性，另请参见下面的架构。最后，讨论了如何通过使用更高的 SKU 和多个工作人员来纵向和横向扩展解决方案。</p><figure class="mi mj mk ml gt mm gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi ol"><img src="../Images/76d28f1a8d40660cdcb9a6fa3a076bf6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b187r0ZznevsWUZT0XAkXw.png"/></div></div><p class="mt mu gj gh gi mv mw bd b be z dk translated">4.建筑——作者的图像</p></figure></div></div>    
</body>
</html>