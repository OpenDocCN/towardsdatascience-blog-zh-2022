<html>
<head>
<title>Batch Effects- Removing Unwanted Variation From Your Data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">批量效果-从数据中删除不需要的变化</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/batch-effects-c71c886ca9c5#2022-04-05">https://towardsdatascience.com/batch-effects-c71c886ca9c5#2022-04-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3035" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">什么是批量效应，如何处理</h2></div><p id="3a9a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">大规模数据集，尤其是在生物和医学领域，已经变得越来越普遍。从许多不同的机器(通常来自世界各地)获取的成像和基因数据现在被合并到公共可用的数据集，从而允许对统计和机器学习方法进行更高级的研究和应用。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/ea4126f855bfdc102f4de27afdbc2346.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CGeJEEvjm9ju0yxW1RX02Q.jpeg"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated"><a class="ae lu" href="https://unsplash.com/@nci?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">国家癌症研究所</a>在<a class="ae lu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="29cb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">巨大的数据量是巨大的，但我们有时会遇到由不同机器获取这些数据的方式的差异所导致的问题。不幸的是，例如，没有两台磁共振成像机捕捉到相同的图像(即使它们扫描的是完全相同的人)。由于这些机器的复杂性，在对比度、强度、噪音和其他属性上存在细微的差异。同样的原理也适用于遗传学，不同的微阵列测量基因表达并结合数据。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi lv"><img src="../Images/65ecfdb7b1200cd7cacf477fa30835bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I9KmeWbKBT4X5e48Z2VdVg.jpeg"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">照片由<a class="ae lu" href="https://unsplash.com/@nci?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">国立癌症研究所</a>在<a class="ae lu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="c705" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="lw">注意:从现在开始，我将在医学成像领域提及批量效果，因为这是我最关注的领域。</em></p><h2 id="49b5" class="lx ly it bd lz ma mb dn mc md me dp mf kr mg mh mi kv mj mk ml kz mm mn mo mp bi translated">为什么重要？</h2><p id="ad17" class="pw-post-body-paragraph ki kj it kk b kl mq ju kn ko mr jx kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">这些由收购引起的“批量效应”在我们的数据中引入了一种新的变异。我们现在有两个变异来源:生物变异(由我们人群的差异造成)和非生物变异(由扫描仪的差异造成)。在我们的下游任务中(例如预测阿尔茨海默病；检查放射组学特征与癌症的关联等。)，我们很可能只想考虑生物变异。</p><p id="ac8f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里有几个问题。第一个与捷径学习有关。假设我们有一个来自医院A和医院B的胸部CT图像数据集，用于诊断肺癌。医院A位于一个受污染的城市，肺癌发病率往往比城市b高得多。医院A的CT机也往往比医院b产生更亮的图像。现在，当我们在数据集上训练卷积神经网络来预测肺癌时，该模型会学习将更亮的图像与癌症相关联。当然，如果我们在同样的数据集上进行验证，我们可能会有相当不错的预测准确性。但是当我们在别处部署我们的模型时，它可能会严重失败。</p><p id="4e51" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">那么，我们为什么不从许多不同的网站添加更多的数据呢？</p><p id="8898" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">即使我们有更多的数据，整个图像或特征空间的不一致性将迫使我们的预测模型学习更一般、简单的特征，而不是更复杂、非线性、细粒度的特征，这些特征可能难以用不一致的批次来识别[9]。</p><h2 id="41c5" class="lx ly it bd lz ma mb dn mc md me dp mf kr mg mh mi kv mj mk ml kz mm mn mo mp bi translated">和谐</h2><p id="fb74" class="pw-post-body-paragraph ki kj it kk b kl mq ju kn ko mr jx kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">输入“协调”，或将所有不同批次的数据放入同一个空间，消除非生物效应。我们如何进行协调？</p><p id="28bb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">回顾一下，我们必须提到我们正在处理的数据类型。我们可能希望协调的两种数据格式是表格(即行和列)或图像(2D或3D像素/体素)。即使在成像领域，我们也经常使用表格数据，通过处理管道发送原始图像，提取定义明确的可解释特征(如大脑中特定区域的厚度)。我们如何进行协调取决于我们是在查看表格(特征)数据还是图像数据。</p><h2 id="c392" class="lx ly it bd lz ma mb dn mc md me dp mf kr mg mh mi kv mj mk ml kz mm mn mo mp bi translated">表列数据</h2><p id="770a" class="pw-post-body-paragraph ki kj it kk b kl mq ju kn ko mr jx kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">在表格形式的脑成像数据示例中，我们有每个扫描患者的行和从MRI提取的每个特征的列(额叶厚度、海马体积等。).我们也有每个病人扫描位置的标签。</p><p id="63ca" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最受欢迎的表格数据协调方法叫做ComBat [2，3](是“组合批次时对抗批次效应”的缩写)。这是一个线性模型，可调整表格批量数据中的均值漂移和方差缩放。该模型如下所示:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/5b13a82285833c5ceeee51b8961fed28.png" data-original-src="https://miro.medium.com/v2/resize:fit:792/format:webp/1*1xwG6C_ID6aHNmmobZxcZg.png"/></div><p class="lq lr gj gh gi ls lt bd b be z dk translated"><em class="mw"> i为批次标识符(如MRI扫描仪A)，j为主体(如人1)，v为特征(如左侧海马体体积)。yᵢ </em> ⱼ <em class="mw"> ᵥ是批次I中受试者j的测量特征v值。</em> α <em class="mw"> ᵥ是特征截距，x是受试者j的协变量(如年龄、性别)，</em> β <em class="mw"> ᵥ是协变量的系数，</em> γ <em class="mw"> ᵢᵥ是批次相加(均值偏移)项，δᵢᵥ是批次方差缩放项，</em> ε <em class="mw">是随机的正态分布噪声，均值为0，标准差为</em> σ图片作者。</p></figure><p id="8966" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该模型中最重要的特征是扫描仪错误术语<em class="lw"> γᵢᵥ </em>和<em class="lw"> δᵢᵥ </em>，我们希望“移除”这两个术语，以便将我们的数据放入一个公共(无批处理)空间。这里有许多变量(每个特征有一个<em class="lw"> αᵥ </em>，扫描仪和特征的每个组合有一个<em class="lw"> γᵢᵥ </em>，等等)。).幸运的是，我们可以使用一种叫做<a class="ae lu" href="https://en.wikipedia.org/wiki/Empirical_Bayes_method" rel="noopener ugc nofollow" target="_blank">经验贝叶斯</a>的方法来稳健地拟合模型，即使我们没有很多数据。</p><p id="d750" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">关于模型拟合我不会说太多细节，但是一个重要的方面是这是一个<a class="ae lu" href="https://en.wikipedia.org/wiki/Bayesian_hierarchical_modeling" rel="noopener ugc nofollow" target="_blank">层次模型</a>。我们假设，对于给定的扫描仪/批次，所有特征的误差项来自一个共同的分布。</p><p id="cd93" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦我们的模型合适了，我们就可以最终进行调整，将这些特性放到一个公共空间中。协调方程式是:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/4abbc7746126cb2f490bd34998577926.png" data-original-src="https://miro.medium.com/v2/resize:fit:936/format:webp/1*0Xx7KdQmt7zJtKO6095a7Q.png"/></div><p class="lq lr gj gh gi ls lt bd b be z dk translated"><em class="mw">战斗调整功能进入共享空间，移除批量效果。(图片由作者提供)</em></p></figure><p id="0ec0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">注意，我们正在减去附加的批量效应γ <em class="lw"> ᵢᵥ </em>，并通过批量缩放效应<em class="lw"> δᵢᵥ </em>的倒数来缩放线性模型的残差。调整后的特征现在可以用于任何类型的下游分析。</p><p id="ade3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">战斗有许多变化，考虑了额外的因素，如纵向数据的受试者特定截距[1]，非线性协变量效应[5]，扫描仪特定的共同因素[8]。</p><h2 id="4cef" class="lx ly it bd lz ma mb dn mc md me dp mf kr mg mh mi kv mj mk ml kz mm mn mo mp bi translated">成像数据</h2><p id="613d" class="pw-post-body-paragraph ki kj it kk b kl mq ju kn ko mr jx kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">在成像问题中，我们经常希望使用原始图像(而不是提取的表格特征)进行下游分析。图像级协调变得必要。像素或体素级别的战斗是不够的；这将是低效的，并且忽略了卷积神经网络可能发现的空间相关模式。因此，我们需要一种不同的方法来实现图像级的协调。</p><p id="cb60" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">图像批量协调可以被认为是域转移。我们有来自几个域或源的图像，我们希望将其转换到单个目标域(目标扫描仪)。对于这项任务来说，一个有吸引力的深度学习模型是<a class="ae lu" href="https://machinelearningmastery.com/what-is-cyclegan/" rel="noopener ugc nofollow" target="_blank">cycle gan</a>【4】，以及其他各种形式的生成对抗网络(GANs)。在CycleGAN中，有两个生成器网络，F用于将源域转换为目标域(S到T)，G用于将目标域转换为源域(T到S)。两个鉴别者试图学习合成图像是“真”还是“假”，而生成器试图在“最小-最大游戏”中愚弄鉴别者。循环一致性丢失加强了原始图像X和F(G(X))之间的相似性，确保来自图像的个体级信息不会在转换中丢失。在批量效应的情况下，S和T可以代表两个不同的MRI扫描仪或两个具有不同图像采集属性的不同数据集。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi my"><img src="../Images/7a7cedbe3f0902df49202d10ddc6baca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hDfQbkTrGPbduZTJAdjcpQ.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated"><em class="mw">从源(S)到目标(T)方向的CycleGAN架构。来自域S (X_s)的图像通过一个生成器并被翻译到域T，生成器F与鉴别器D_T玩一个对抗性游戏，其中D_T试图猜测X是来自域T(真实的)还是由X_s生成(虚假的)，生成器F试图愚弄鉴别器。所生成的图像X_S- &gt; T通过T - &gt; S生成器G以被转换回域S。循环一致性损失L_cyc比较原始图像X_S和循环图像X_S- &gt; T- &gt; S。</em></p></figure><p id="fc16" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">CycleGAN很有吸引力，因为它不需要“成对图像”，也不需要在短时间内用不同的扫描仪扫描同一对象的图像。在存在许多成对图像的罕见情况下，其他受监督的图像到图像的翻译方法(例如，涉及U-网、变分自动编码器等。)的存在就是为了利用这种“基础事实”的转换[6，7]。</p><p id="e887" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">协调是计算生物医学研究中一个令人兴奋的新领域，以促进大规模分析，并且有大量的方法改进机会。该领域中的几个公开问题是1)协调来自以前未见过的站点的数据(领域概括)，以及2)评估我们的协调模型的性能，而没有地面事实。我期待着尽快分享我在协调方面的一些工作。</p></div><div class="ab cl mz na hx nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="im in io ip iq"><p id="0318" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">参考资料:</p><p id="1ea4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">1.纵向战斗:一种协调纵向多扫描仪成像数据的方法。<em class="lw">神经影像</em>。2020;220(5月):117129。doi:10.1016/j . neuro image . 20001536366</p><p id="fb21" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">2.跨扫描仪和站点皮质厚度测量的协调。<em class="lw">神经影像</em>。2018;167(2017年11月):104–120。doi:10.1016/j . neuro image . 2017 . 11 . 024</p><p id="49d8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">3.使用经验贝叶斯方法调整微阵列表达数据中的批效应。<em class="lw">生物统计学</em>。2007;8(1):118–127.doi:10.1093/生物统计学/kxj037</p><p id="9c34" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">4.Nguyen H，Morris RW，Harris AW，Korgoankar MS，Ramos F .使用生成性对抗网络纠正多位点神经影像数据的差异。2018.<a class="ae lu" href="http://arxiv.org/abs/1803.09375." rel="noopener ugc nofollow" target="_blank">http://arxiv.org/abs/1803.09375.</a></p><p id="3a08" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">5.庞波尼奥R，厄鲁斯G，哈贝斯M，等。大型核磁共振成像数据集的协调，用于分析整个生命周期的脑成像模式。<em class="lw">神经影像</em>。2020;208(2019年7月)。doi:10.1016/j . neuro image . 20001363666</p><p id="8737" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">6.田D，曾Z，孙X，等。基于深度学习的多点神经影像融合框架。<em class="lw"> bioRxiv </em>。2021:2021.12.05.471192.<a class="ae lu" href="https://www.biorxiv.org/content/10.1101/2021.12.05.471192v1%0Ahttps://www.biorxiv.org/content/10.1101/2021.12.05.471192v1.abstract." rel="noopener ugc nofollow" target="_blank">https://www . bior XIV . org/content/10.1101/2021 . 12 . 05 . 471192 v1 % 0ah ttps://www . bior XIV . org/content/10.1101/2021 . 12 . 05 . 471192 v1 .摘要.</a></p><p id="f889" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">7.Torbati ME，Tudorascu DL，Minhas DS，Maillard P，Decarli CS，Jae Hwang S .通过结构保持嵌入学习实现配对神经成像数据的多扫描仪协调。<em class="lw">美国电气与电子工程师协会国际会议计算机会议。2021;2021年十月b:3277–3286。doi:10.1109/iccvw 54120.2021.00367</em></p><p id="0eb8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">8.Wachinger C，Rieckmann A，Pö lsterl S .检测和纠正多位点神经影像数据集中的偏差。<em class="lw">医学图像分析</em>。2021;67:101879.doi:10.1016/j . media . 200015863617</p><p id="52ba" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">9.Wang R，Chaudhari P，Davatzikos C. <em class="lw">与基于流的因果推理的协调</em>。第12903卷LNCS。斯普林格国际出版公司；2021.doi:10.1007/978–3–030–87199–4 _ 17</p></div></div>    
</body>
</html>