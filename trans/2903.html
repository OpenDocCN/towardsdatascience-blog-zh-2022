<html>
<head>
<title>Tabulating Subtotals Dynamically in Python Pandas Pivot Tables</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Python熊猫透视表中动态制表小计</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/tabulating-subtotals-dynamically-in-python-pandas-pivot-tables-6efadbb79be2#2022-06-24">https://towardsdatascience.com/tabulating-subtotals-dynamically-in-python-pandas-pivot-tables-6efadbb79be2#2022-06-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/2dd0018acf29c8e9e95064d8a2922811.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ps6Dvy5AmdKf4A45"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">斯科特·格雷厄姆在Unsplash上的照片</p></figure><div class=""/><div class=""><h2 id="9e75" class="pw-subtitle-paragraph kg ji jj bd b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dk translated">Pandas库的内置pivot函数目前的一个缺点是缺乏为多级数据动态收集小计。我们可以编写自己的函数来添加这个特性，类似于Excel中的函数。</h2></div><p id="5f92" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">数据透视表是汇总另一个数据源的转换或操作的数据工具。它们对于展示大型数据集的关键见解非常有用，几十年来一直是Excel和其他类似电子表格系统的一部分。虽然在Excel和其他工具套件中设置它们相对容易和简单，但将它们添加到Python中的自动化脚本可能会稍微有些微妙，主要是在Excel数据透视表中默认存在的数据集上添加转换和小计时。</p><p id="03cb" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在我们的练习中，我们将首先在Excel中可视化我们的数据以进行基线比较，然后在Python中创建一个能够产生类似结果的函数。</p><p id="9810" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们将使用的数据集是两个不同商店的杂货店库存的虚拟样本。我们有产品、数量和单位成本的细目分类。我在本地将这些数据保存为CSV格式。</p><figure class="lv lw lx ly gt iv gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/ccd2aeb86f05821ff9100f2431f636a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1114/format:webp/1*2BezdXdGCDsl-argV_FHpg.png"/></div></figure><p id="2b60" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们假设一个业务问题:出于保险目的，我们想知道我们拥有的产品按类型、部门和地点的总价值是多少。这里的关键是，除了商店和商店之间的总计之外，我们还有每个级别的小计。</p><p id="27d2" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们的第一步是添加一个列，它是数量和单位价格的乘积，以找到该系列商品的总价值。在这种情况下，我们在费城的苹果总价值是50美元，或100 x 0.50美元。</p><p id="8e5e" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">接下来，我们可以插入数据透视表，方法是选择所有数据，导航到“插入”选项卡，然后选择“数据透视表”和一个目标。</p><p id="fcce" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">通过如下配置数据透视表的行和值，我们可以生成所需的细分。</p><div class="lv lw lx ly gt ab cb"><figure class="lz iv ma mb mc md me paragraph-image"><img src="../Images/9e5bb9b832cc8c0deead9f549bd77f9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:500/format:webp/1*1fXcoFiPZm5aAocx87Ysyg.png"/></figure><figure class="lz iv mf mb mc md me paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><img src="../Images/f3f4f40d28e99d316a2775e14b44af43.png" data-original-src="https://miro.medium.com/v2/resize:fit:404/format:webp/1*xjgXgtbMOYO3yaPoCA0Ung.png"/></div><p class="jc jd gj gh gi je jf bd b be z dk mg di mh mi translated">Excel数据透视表和数据</p></figure></div><p id="6005" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这些数据现在可以通过我们的保险代理、公司领导等进行投保。但是，如果这些数据每周都在变化，我们就会浪费时间每周创建一个新的电子表格，配置一个数据透视表，并通过电子邮件向利益相关者发送附件。这尤其浪费，因为我们每周没有创造新的价值，只是花费时间和精力来维持当前的价值！这可以通过Python自动化来避免。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><p id="c97a" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们选择Python作为数据透视表的自动化工具有几个原因:</p><ul class=""><li id="25fd" class="mq mr jj la b lb lc le lf lh ms ll mt lp mu lt mv mw mx my bi translated">易于使用，Python的Pandas库拥有我们构建数据透视表所需的所有工具</li><li id="a9dd" class="mq mr jj la b lb mz le na lh nb ll nc lp nd lt mv mw mx my bi translated">集成，我们可以使用Pandas从CSV、Excel、SQL甚至web中读取数据</li><li id="fc3c" class="mq mr jj la b lb mz le na lh nb ll nc lp nd lt mv mw mx my bi translated">灵活的输出，我们可以将数据返回到电子表格或上传到web仪表板</li></ul><p id="b4eb" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在创建了一个新的Jupyter笔记本之后，这个示例应用程序唯一需要的库就是pandas。</p><pre class="lv lw lx ly gt ne nf ng nh aw ni bi"><span id="eb12" class="nj nk jj nf b gy nl nm l nn no">import pandas as pd</span></pre><p id="f37d" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们也从上面Excel中使用的同一个CSV中读取数据。</p><pre class="lv lw lx ly gt ne nf ng nh aw ni bi"><span id="582e" class="nj nk jj nf b gy nl nm l nn no">df = pd.read_csv('GroceryData.csv')<br/>df['Price per Unit'] = df['Price per Unit'].replace('\$', '', regex=True)<br/>df['Price per Unit'] = pd.to_numeric(df['Price per Unit'])<br/>df['Value'] = df['Quantity']*df['Price per Unit']<br/>df</span></pre><p id="68d0" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">请注意，因为CSV有一个带美元符号的格式化列，所以我们需要删除该字符以转换为浮点型。我们还将为Value创建一个新列:单位数量和单位价格的乘积。生成的数据框如下。</p><figure class="lv lw lx ly gt iv gh gi paragraph-image"><div class="gh gi np"><img src="../Images/6013f84e05cd86b37629f4170341f383.png" data-original-src="https://miro.medium.com/v2/resize:fit:1104/format:webp/1*ZKvUngPitIC3VbMEWqABZQ.png"/></div></figure><p id="a2de" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">有多种Pandas方法对上述数据进行汇总，其中有两种方法包括<a class="ae jg" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.groupby.html" rel="noopener ugc nofollow" target="_blank"> groupby方法</a>和<a class="ae jg" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.pivot_table.html" rel="noopener ugc nofollow" target="_blank"> pivot_table方法</a>。请注意，Pandas确实有一个pivot方法，但它不同于pivot table，因为它不包含聚合方法参数。</p><p id="77c0" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在我们的练习中，我们将在groupby上使用pivot _ table可以使用groupby开发类似的函数，但pivot_table本身会返回另一个数据框，从而可以轻松导出到Excel或其他电子表格工具。</p><p id="4291" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">方法的实现如下。</p><pre class="lv lw lx ly gt ne nf ng nh aw ni bi"><span id="2fa2" class="nj nk jj nf b gy nl nm l nn no">df.pivot_table(values='Value',index=['Store','Department','Type'],aggfunc='sum')</span></pre><p id="7b82" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们可以看到，输出看起来类似于我们在Excel中没有小计。</p><figure class="lv lw lx ly gt iv gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/aa4928ae73ca0d1a842c4a0cd3632cc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:572/format:webp/1*h-TAfU_t5bTpON47sb4VGw.png"/></div></figure><p id="50f4" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">唯一对我们有帮助的内置参数是“margins ”,但是实现这个参数只会添加一个标题为“All”的最终总计。</p><pre class="lv lw lx ly gt ne nf ng nh aw ni bi"><span id="d71c" class="nj nk jj nf b gy nl nm l nn no">df.pivot_table(values='Value',index=['Store','Department','Type'],aggfunc='sum',margins=True)</span></pre><figure class="lv lw lx ly gt iv gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/bdfd7dd5d877d4e8c520bea7a06dc546.png" data-original-src="https://miro.medium.com/v2/resize:fit:552/format:webp/1*nx9pGDgpmIQvDNU7jkvrqg.png"/></div></figure><p id="f24d" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了添加商店和部门的小计，我们需要构建一个循环，该循环将重复创建pivot_table，每次迭代都添加另一个级别的索引进行制表，然后将所有数据帧连接在一起。理想情况下，这也将动态发生，以适应具有更多级别的索引或其他列的未来数据集。相关函数如下。</p><pre class="lv lw lx ly gt ne nf ng nh aw ni bi"><span id="5dbc" class="nj nk jj nf b gy nl nm l nn no">def pivot_table_w_subtotals(df, values, indices, columns, aggfunc, fill_value):<br/>    '''<br/>    Adds tabulated subtotals to pandas pivot tables with multiple hierarchical indices.<br/>    <br/>    Args:<br/>    - df - dataframe used in pivot table<br/>    - values - values used to aggregrate<br/>    - indices - ordered list of indices to aggregrate by<br/>    - columns - columns to aggregrate by<br/>    - aggfunc - function used to aggregrate (np.max, np.mean, np.sum, etc)<br/>    - fill_value - value used to in place of empty cells<br/>    <br/>    Returns:<br/>    -flat table with data aggregrated and tabulated<br/>    <br/>    '''<br/>    listOfTable = []<br/>    for indexNumber in range(len(indices)):<br/>        n = indexNumber+1<br/>        table = pd.pivot_table(df,values=values,index=indices[:n],columns=columns,aggfunc=aggfunc,fill_value=fill_value).reset_index()<br/>        for column in indices[n:]:<br/>            table[column] = ''<br/>        listOfTable.append(table)<br/>    concatTable = pd.concat(listOfTable).sort_index()<br/>    concatTable = concatTable.set_index(keys=indices)<br/>    return concatTable.sort_index(axis=0,ascending=True)</span></pre><p id="49dc" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">执行这个函数，我们可以看到结果数据帧。</p><pre class="lv lw lx ly gt ne nf ng nh aw ni bi"><span id="0fc5" class="nj nk jj nf b gy nl nm l nn no">pivot_table_w_subtotals(df=df,values='Value',indices=['Store','Department','Type'],columns=[],aggfunc='sum',fill_value='')</span></pre><figure class="lv lw lx ly gt iv gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/69ff0bd2a633321dfd990a8b3403cb99.png" data-original-src="https://miro.medium.com/v2/resize:fit:556/format:webp/1*0CNoSrEKUL9-Xjsiv4jW5w.png"/></div></figure><p id="6e00" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">请注意，现在我们有了按商店和部门分类汇总！我们现在只是缺少总计，但是我们可以通过仅在一次迭代中使用“margins”函数参数来添加总计。</p><pre class="lv lw lx ly gt ne nf ng nh aw ni bi"><span id="4248" class="nj nk jj nf b gy nl nm l nn no">def pivot_table_w_subtotals(df, values, indices, columns, aggfunc, fill_value):<br/>    '''<br/>    Adds tabulated subtotals to pandas pivot tables with multiple hierarchical indices.<br/>    <br/>    Args:<br/>    - df - dataframe used in pivot table<br/>    - values - values used to aggregrate<br/>    - indices - ordered list of indices to aggregrate by<br/>    - columns - columns to aggregrate by<br/>    - aggfunc - function used to aggregrate (np.max, np.mean, np.sum, etc)<br/>    - fill_value - value used to in place of empty cells<br/>    <br/>    Returns:<br/>    -flat table with data aggregrated and tabulated<br/>    <br/>    '''<br/>    listOfTable = []<br/>    for indexNumber in range(len(indices)):<br/>        n = indexNumber+1<br/>        if n == 1:<br/>            table = pd.pivot_table(df,values=values,index=indices[:n],columns=columns,aggfunc=aggfunc,fill_value=fill_value,margins=True)<br/>        else:<br/>            table = pd.pivot_table(df,values=values,index=indices[:n],columns=columns,aggfunc=aggfunc,fill_value=fill_value)<br/>        table = table.reset_index()<br/>        for column in indices[n:]:<br/>            table[column] = ''<br/>        listOfTable.append(table)<br/>    concatTable = pd.concat(listOfTable).sort_index()<br/>    concatTable = concatTable.set_index(keys=indices)<br/>    return concatTable.sort_index(axis=0,ascending=True)</span><span id="6a64" class="nj nk jj nf b gy nt nm l nn no">pivot_table_w_subtotals(df=df,values='Value',indices=['Store','Department','Type'],columns=[],aggfunc='sum',fill_value='')</span></pre><figure class="lv lw lx ly gt iv gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/7820b30ef05c2232b8f0042ae9a5ea75.png" data-original-src="https://miro.medium.com/v2/resize:fit:568/format:webp/1*5yx9iyWCV02zdMVBy3ZfKQ.png"/></div></figure><p id="303a" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">太棒了，现在有了一个完整的数据透视表，类似于从Excel中得到的数据透视表！该表现在可以以多种方式自动导出，例如导出到基于web的仪表板或Excel的XLSX或CSV文件。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><p id="05b6" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">与数据工程师通常遇到的数据集相比，我们在这里共同研究的案例范围相对较小，但是同样的原则应该适用于构建具有多个级别的动态数据透视表。请随意修改并分享您的用例！</p><p id="7b2e" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">请让我知道您的想法，并随时通过LinkedIn 联系我，向我提供反馈，提出问题，或者看看我们如何将这些工具和思维方式引入您的组织！点击这里查看我的其他一些关于数据分析和可视化的文章<a class="ae jg" href="https://medium.com/@willkeefe" rel="noopener">！</a></p></div></div>    
</body>
</html>