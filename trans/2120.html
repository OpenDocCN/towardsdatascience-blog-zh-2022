<html>
<head>
<title>SSL/TLS for your Kubernetes Cluster with Cert-Manager</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带证书管理器的Kubernetes集群的SSL/TLS</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/ssl-tls-for-your-kubernetes-cluster-with-cert-manager-3db24338f17#2022-05-12">https://towardsdatascience.com/ssl-tls-for-your-kubernetes-cluster-with-cert-manager-3db24338f17#2022-05-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="107d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">为浏览您的域的用户设置安全连接</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/7e557ae3d69fe69b4f89f361ed159296.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ond6gL-r8lpeUInh"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">丹尼·米勒在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="cb93" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您阅读了来自<a class="ae ky" rel="noopener" target="_blank" href="/handling-dns-and-ssl-tls-for-your-aws-kubernetes-cluster-f3ecd0991e6a"> <em class="lv">的这篇文章，为您的AWS Kubernetes集群</em> </a>处理DNS和SSL/TLS，那么您已经为集群上的一些服务获得了域路由流量，但是您的用户仍然会在他们的浏览器上看到讨厌的消息，告诉他们这是一个不安全的连接。让我们解决这个问题。</p><p id="9a06" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">需要SSL证书，以便浏览器可以创建与您的服务的安全连接。在Kubernetes中，SSL证书被存储为Kubernetes的秘密。证书通常在一到两年内有效，过期后就会失效，因此会有很大的管理开销和一些停机的可能性。我们需要一个自我管理并自动更新过期证书的设置。</p><p id="df8f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是C <a class="ae ky" href="https://cert-manager.io/docs/" rel="noopener ugc nofollow" target="_blank"> ert经理</a>的用武之地。Cert-manager是我们在您的集群中部署的一种资源，它可以与像<a class="ae ky" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank"> Let's Encrypt </a>(这是免费的)这样的认证机构对话，为您的域生成证书。因此，在我们深入探讨之前，让我们在您的集群中部署cert-manager</p><p id="b00a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我将使用v1.8.0，但是您可以在这里查看最新的cert-manager版本<a class="ae ky" href="https://github.com/cert-manager/cert-manager/releases" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="b99d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们从releases下载cert-manager.yaml文件。</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="96ad" class="mb mc it lx b gy md me l mf mg">curl -LO <a class="ae ky" href="https://github.com/jetstack/cert-manager/releases/download/v1.8.0/cert-manager.yaml" rel="noopener ugc nofollow" target="_blank">https://github.com/jetstack/cert-manager/releases/download/v1.8.0/cert-manager.yaml</a></span></pre><p id="5bc0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，让我们将cert-manager部署到一个名为cert-manager的名称空间。</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="fa99" class="mb mc it lx b gy md me l mf mg">kubectl create namespace cert-manager</span><span id="e67f" class="mb mc it lx b gy mh me l mf mg">kubectl apply --validate=false -f cert-manager.yaml</span></pre><p id="6e4c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了将cert-manager连接到一个认证机构，比如让我们加密另一个Kubernetes对象，需要部署一个名为Issuer的对象。基本上，当我们从cert-manager请求证书时，它会创建一个证书请求对象，要求发行者从证书颁发机构请求一个新的证书。</p><p id="33d6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，在部署我们的发行者之前，我们需要部署一个nginx入口控制器。为什么？因为当cert-manager向像Let's Encrypt这样的发行者请求证书时，Let's Encrypt会发送一个http质询，需要cert-manager完成该质询才能提供证书。因此，要让cert-manager与Let's Encrypt对话，我们需要使用nginx入口控制器将其开放给互联网。</p><p id="3805" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们将入口控制器部署到ingress-nginx名称空间。</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="34c7" class="mb mc it lx b gy md me l mf mg">kubectl create ns ingress-nginx</span><span id="85bb" class="mb mc it lx b gy mh me l mf mg">kubectl -n ingress-nginx apply -f <a class="ae ky" href="https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v0.1.2.0/deploy/static/provider/cloud/deploy.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v0.1.2.0/deploy/static/provider/cloud/deploy.yaml</a></span></pre><p id="704e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们将设置发行者。颁发者指定证书颁发机构的服务器和存储颁发者密钥的Kubernetes密钥参考的名称。在我们的例子中，我们使用<strong class="lb iu"> acme </strong>作为发布者(也就是让我们加密),因此我们还指定了我们希望如何解决solvers下的让我们加密挑战。你可以在这里了解更多关于<a class="ae ky" href="https://cert-manager.io/docs/configuration/acme/" rel="noopener ugc nofollow" target="_blank">的信息。这是发行者模板。</a></p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="0c39" class="mb mc it lx b gy md me l mf mg">apiVersion: cert-manager.io/v1                             <br/>kind: ClusterIssuer                             <br/>metadata:                               <br/>  name: letsencrypt-cluster-issuer                             <br/>spec:                            <br/>  <strong class="lx iu">acme: </strong>                                <br/>    <strong class="lx iu">server: </strong><a class="ae ky" href="https://acme-v02.api.letsencrypt.org/directory" rel="noopener ugc nofollow" target="_blank"><strong class="lx iu">https://acme-v02.api.letsencrypt.org/directory</strong></a><br/>    email: your-email@email.com<br/>    <strong class="lx iu">privateKeySecretRef: </strong>                                                                  <br/>      <strong class="lx iu">name: letsencrypt-cluster-issuer-key</strong><br/>    <strong class="lx iu">solvers:</strong><br/>    - http01:<br/>        ingress:<br/>          class: nginx</span></pre><p id="bc34" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们部署发行者。</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="c8eb" class="mb mc it lx b gy md me l mf mg">kubectl apply -f cert-issuer.yaml</span><span id="e535" class="mb mc it lx b gy mh me l mf mg"># view the <br/>kubectl describe clusterissuer letsencrypt-cluster-issuer</span></pre><p id="cbaf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们已经有了证书管理器和发行者。现在我们可以申请证书了。这是证书对象的模板。</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="d56c" class="mb mc it lx b gy md me l mf mg">apiVersion: cert-manager.io/v1<br/>kind: Certificate<br/>metadata:<br/>  name: example-cert  #name of this object<br/>  namespace: default #same namespace as <br/>spec:<br/>  <strong class="lx iu">dnsNames:<br/>    - example.com</strong><br/>  <strong class="lx iu">secretName: example-tls-cert</strong><br/>  <strong class="lx iu">issuerRef:<br/>    name: letsencrypt-cluster-issuer<br/>    kind: ClusterIssue</strong>r</span></pre><p id="6691" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在模板中，我们指定需要证书的DNS名称、存储证书的Kubernetes secrets中的秘密名称以及对我们之前部署的发行者的引用。还要确保使用相同的名称空间，您将在其中部署将使用该证书的服务。</p><p id="4c8d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们部署它:</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="f25b" class="mb mc it lx b gy md me l mf mg">kubectl apply -f certificate.yaml</span></pre><p id="e020" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦证书被颁发，你应该看到它在Kubernetes的秘密。</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="0554" class="mb mc it lx b gy md me l mf mg">kubectl get secrets</span></pre><h2 id="66a4" class="mb mc it bd mi mj mk dn ml mm mn dp mo li mp mq mr lm ms mt mu lq mv mw mx my bi translated">利用证书</h2><p id="fa3f" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">假设您已经部署了一个应用程序及其服务，您希望通过入口将该应用程序公开到internet，并使用我们上面发布的证书为其设置TLS。以下是您可以使用的模板:</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="a0a6" class="mb mc it lx b gy md me l mf mg">apiVersion: networking.k8s.io/v1<br/>kind: Ingress<br/>metadata:<br/>  name: my-ingress<br/>  annotations:<br/>    <strong class="lx iu">kubernetes.io/ingress.class: nginx</strong><br/>spec:<br/>  <strong class="lx iu">tls:</strong><br/>  <strong class="lx iu">- hosts:<br/>    - example.com</strong><br/>  <strong class="lx iu">secretName: example-tls-cert</strong><br/>  <br/>  rules:<br/>  - <strong class="lx iu">host: example.com</strong><br/>    http:<br/>      paths:<br/>        - path: /<br/>          pathType: Exact<br/>          backend:<br/>            <strong class="lx iu">service:</strong><br/>              <strong class="lx iu">name: backend-service</strong><br/>              port:<br/>                number: 80</span></pre><p id="d9a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在tls部分，我们为这个入口路由指定DNS主机，并为我们之前创建的证书指定秘密名称。我们还传递入口将路由到的服务的名称。然后部署:</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="a75c" class="mb mc it lx b gy md me l mf mg">kubectl apply -f ingress.yaml</span></pre><p id="8d13" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在你知道了。总的来说，我们已经在集群中部署了cert-manager和Issuer资源。然后，我们为cert-manager创建了一个证书对象，通过发行者发出证书请求，并向Kubernetes secrets添加一个新证书。然后我们创建了一个nginx路由来使用证书。</p><p id="e9ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你设法使用前一篇文章<a class="ae ky" rel="noopener" target="_blank" href="/handling-dns-and-ssl-tls-for-your-aws-kubernetes-cluster-f3ecd0991e6a">中描述的外部域名(或其他方式)连接你的域，并使用cert-manager获得TLS证书，那么当你的用户在浏览器中访问你的域时，他们应该会获得安全连接。</a></p></div></div>    
</body>
</html>