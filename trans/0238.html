<html>
<head>
<title>Run Jupyter Notebook as a background service</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将 Jupyter 笔记本作为后台服务运行</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/run-jupyter-notebook-as-a-background-service-on-ubuntu-c5d6298ed1e#2022-02-10">https://towardsdatascience.com/run-jupyter-notebook-as-a-background-service-on-ubuntu-c5d6298ed1e#2022-02-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4bbc" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">再也不会丢失远程笔记本服务器，甚至可以让笔记本服务器在系统重新启动时启动</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/2b7878d008cd92d6f29b15f7ee614747.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*D4l5WK_PLsVsFIqX"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">克里斯托弗·高尔在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="8050" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如何在后台运行 Jupyter 笔记本，而不需要为它们打开一个终端？在本文中，我将向您展示两种方法，一种是使用<code class="fe ls lt lu lv b">nohup</code>的简单的一行程序，另一种是使用守护程序服务的更高级的方法。</p><p id="84d7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本地运行时，避免为您的笔记本电脑打开终端是非常有用的，但在可能暂时断开连接的远程笔记本服务器上更是如此。如果我们可以将笔记本服务器作为一个长期的后台任务作为系统服务来运行，会怎么样？因此我们可以随时连接到它，它甚至可以在任何故障或机器重启时重新启动。</p><p id="7aa0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">本教程假设你在基于 unix 的系统上，我在 ubuntu 上，并且已经测试了 18.04 和 20.04 版本。第二种方式需要 root 权限，第一种方式不需要。</p><h1 id="e0e3" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">简单的一行程序</h1><p id="4e84" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">不要使用任何选项来运行<code class="fe ls lt lu lv b">jupyter-notebook ...</code>,比如指定所使用的端口，而是在您希望笔记本根目录所在的目录中使用以下内容:</p><pre class="kg kh ki kj gt mt lv mu mv aw mw bi"><span id="b8b8" class="mx lx iq lv b gy my mz l na nb">nohup jupyter-notebook --no-browser --port=8888 &amp;</span></pre><p id="5db9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意命令末尾的<code class="fe ls lt lu lv b">&amp;</code>字符，这使得它在后台运行。默认情况下，任何输出都将被写入一个名为<code class="fe ls lt lu lv b">nohup.out</code>的文件中，您可以在那里查看笔记本日志。</p><p id="3495" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">像任何其他进程一样，这个进程也有一个 PID，以后可以用它来停止。(通常<code class="fe ls lt lu lv b">jupyter-notebook stop &lt;port&gt;</code>不会用这种方法。)PID 是在执行上述命令时打印出来的，虽然只是在屏幕上显示，但没有必要记下来，因为以后可以找到它:</p><p id="ba2e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以检查打开了输出文件的进程的 PID:</p><pre class="kg kh ki kj gt mt lv mu mv aw mw bi"><span id="9ee1" class="mx lx iq lv b gy my mz l na nb">$ lsof nohup.out</span><span id="129d" class="mx lx iq lv b gy nc mz l na nb">COMMAND     PID  USER   FD   TYPE DEVICE SIZE/OFF     NODE NAME<br/>jupyter-n 44361   username    1w   REG   0,51      884 19846171 nohup.out</span></pre><p id="021f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">或者使用<code class="fe ls lt lu lv b">ps</code>查找计算机所有运行进程之间的进程:</p><pre class="kg kh ki kj gt mt lv mu mv aw mw bi"><span id="99ec" class="mx lx iq lv b gy my mz l na nb">$ ps au | grep jupyter</span></pre><p id="17dd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，使用</p><pre class="kg kh ki kj gt mt lv mu mv aw mw bi"><span id="686b" class="mx lx iq lv b gy my mz l na nb">$ kill -9 &lt;PID&gt;</span></pre><p id="1914" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">扼杀这一进程。</p><p id="1324" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这相对简单，允许您随时检查该目录中的日志，即使终端会话结束，也能保持笔记本运行。尽管服务器在机器重新启动时也不会重新启动，但是不需要 root 权限。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nd"><img src="../Images/a807a082fc6da4161068355c861402d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vu9SvhLStQ6Ry4q6"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Avi Richards 在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h1 id="766a" class="lw lx iq bd ly lz nl mb mc md nm mf mg jw nn jx mi jz no ka mk kc np kd mm mn bi translated">系统上的守护进程</h1><p id="e9b7" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">如果您有 root 权限，您可以使笔记本服务器作为系统服务运行，甚至在重新启动时启动。这是针对基于 linux 的系统，使用内置的服务管理器。</p><h2 id="8651" class="mx lx iq bd ly nq nr dn mc ns nt dp mg lf nu nv mi lj nw nx mk ln ny nz mm oa bi translated">第 1 步:找到您的<code class="fe ls lt lu lv b">jupyter-notebook</code>可执行文件的路径</h2><p id="38bf" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">您需要在激活正确的 python 环境后才能这样做。</p><pre class="kg kh ki kj gt mt lv mu mv aw mw bi"><span id="4ba7" class="mx lx iq lv b gy my mz l na nb">$ which jupyter-notebook</span><span id="fcc8" class="mx lx iq lv b gy nc mz l na nb">/home/username/.local/share/virtualenvs/notebook/bin/jupyter-notebook</span></pre><h2 id="f086" class="mx lx iq bd ly nq nr dn mc ns nt dp mg lf nu nv mi lj nw nx mk ln ny nz mm oa bi translated">(可选)步骤 1.1:设置笔记本密码和任何其他配置</h2><p id="e8b5" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">如果您依赖于安全的密码集，而不是复制服务器在启动时生成的令牌，您会发现以后使用该服务会更容易。</p><pre class="kg kh ki kj gt mt lv mu mv aw mw bi"><span id="77cf" class="mx lx iq lv b gy my mz l na nb">$ jupyter-notebook password</span><span id="6e67" class="mx lx iq lv b gy nc mz l na nb">[... password prompt, type it in twice] </span><span id="9e29" class="mx lx iq lv b gy nc mz l na nb">[NotebookPasswordApp] Wrote hashed password to /home/username/.jupyter/jupyter_notebook_config.json</span></pre><p id="8364" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您需要输入两次密码，然后密码以种子格式存储在本地 jupyter config 目录中。</p><h2 id="3eaf" class="mx lx iq bd ly nq nr dn mc ns nt dp mg lf nu nv mi lj nw nx mk ln ny nz mm oa bi translated">步骤 2:编写服务设置文件</h2><p id="0975" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">系统服务的设置和属性在类似 INI 的文件中指定。这些存储在<code class="fe ls lt lu lv b">/etc/systemd/system/</code>目录中。</p><p id="9b78" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们来写一个服务文件吧！这是一个相对简单的例子，我们已经为 jupyter 指定了可执行文件和参数，包括启动笔记本目录的目录，该目录与执行服务的目录相同。将用户和组设置更改为您自己的用户，确保它不是 root 用户。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="46b6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意<code class="fe ls lt lu lv b">Restart</code>部分，它定义了如果出现故障，服务应该重启，守护进程等待 60 秒。</p><h2 id="1a3f" class="mx lx iq bd ly nq nr dn mc ns nt dp mg lf nu nv mi lj nw nx mk ln ny nz mm oa bi translated">步骤 3:启用并启动服务</h2><p id="f594" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">我们希望将该服务设置文件放入正确的系统目录中，然后“启用”并“启动”该服务。Enable 表示该服务在计算机重启时启动，否则需要手动启动。</p><pre class="kg kh ki kj gt mt lv mu mv aw mw bi"><span id="b480" class="mx lx iq lv b gy my mz l na nb"># add the service file<br/>$ sudo cp jupyter-notebook.service /etc/systemd/system/</span><span id="9d07" class="mx lx iq lv b gy nc mz l na nb"># let the daemon reload all the service files<br/>$ sudo systemctl daemon-reload</span><span id="4379" class="mx lx iq lv b gy nc mz l na nb"># (optional) "enable" -&gt; started when the computer boots<br/>$ sudo systemctl enable jupyter-notebook.service</span><span id="505b" class="mx lx iq lv b gy nc mz l na nb"># start the service<br/>$ sudo systemctl start jupyter-notebook.service</span></pre><p id="8847" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">完成后，您可以查看服务状态。请注意，显示状态不需要 root 权限。</p><pre class="kg kh ki kj gt mt lv mu mv aw mw bi"><span id="3a9f" class="mx lx iq lv b gy my mz l na nb">$ systemctl status jupyter-notebook</span></pre><p id="a157" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你想停止服务，你可以使用<code class="fe ls lt lu lv b">sudo systemctl stop ...</code>来禁用启动启动使用<code class="fe ls lt lu lv b">sudo systemctl disable ...</code></p><h2 id="2245" class="mx lx iq bd ly nq nr dn mc ns nt dp mg lf nu nv mi lj nw nx mk ln ny nz mm oa bi translated">第四步:享受！</h2><p id="3326" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">现在，您有了一个笔记本守护程序服务，它也可以在重新启动时运行，并且您可以随时访问它。如果服务退出，系统会自动重启，这样你就可以安心工作了。</p><p id="9db8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">例如，如果您在一台远程机器上运行您的笔记本，比如您的家庭/工作计算机或云中，您只需要通过 SSH 连接到它，并让笔记本启动和运行。</p><h1 id="a122" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">结论</h1><p id="ab91" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">我们已经看到了在后台运行 Jupyter 笔记本服务器的两种方法，一种简单的方法适用于非 root 用户，另一种更高级的方法适用于 root 用户。第一个需要一点监控来启动和停止，而后者应该让你在服务器上一劳永逸。</p><p id="c88a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我在不同的计算机上使用这两种方法，这取决于我拥有的用户权限。例如，第一个在科学计算集群上是最好的，而后者对于 AWS EC2 实例来说是惊人的，该实例用于笔记本和数据分析，可以在任何地方进行。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi od"><img src="../Images/45428c3d16e13ef8d2355ea73c6cbfbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uBIeNoHaOMJFI0mp"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com/@gmk?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">乔治·克罗克</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h2 id="b096" class="mx lx iq bd ly nq nr dn mc ns nt dp mg lf nu nv mi lj nw nx mk ln ny nz mm oa bi translated">参考和有用的链接</h2><ul class=""><li id="eada" class="oe of iq ky b kz mo lc mp lf og lj oh ln oi lr oj ok ol om bi translated"><code class="fe ls lt lu lv b">man systemd.service</code>和<code class="fe ls lt lu lv b">man systemd.unit</code>提供了系统服务文件选项的综合文档，<a class="ae kv" href="https://www.shellhacks.com/systemd-service-file-example/" rel="noopener ugc nofollow" target="_blank">本</a>是其摘要</li><li id="0498" class="oe of iq ky b kz on lc oo lf op lj oq ln or lr oj ok ol om bi translated">这个教程很久以前我第一次使用它来建立一个系统服务，后来在多台机器上进行了修改</li></ul></div></div>    
</body>
</html>