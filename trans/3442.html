<html>
<head>
<title>Understanding Synthetic Control Methods</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解综合控制方法</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/understanding-synthetic-control-methods-dd9a291885a1#2022-07-30">https://towardsdatascience.com/understanding-synthetic-control-methods-dd9a291885a1#2022-07-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="24de" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/causal-data-science" rel="noopener" target="_blank">因果数据科学</a></h2><div class=""/><div class=""><h2 id="0a35" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated"><em class="ko">业内最流行的因果推理技术之一的详细指南</em></h2></div><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/9016c15f5a7b1ba2789874a808c42d72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RuOHazi0djqEHdxVMzyU7w.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">封面，作者图片</p></figure><p id="5076" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">现在人们普遍认为，计算治疗(药物、广告、产品等)对感兴趣的结果(疾病、公司收入、客户满意度等)的<strong class="lh ja">因果效应</strong>的黄金标准技术是<strong class="lh ja"> AB测试</strong>，也称为随机实验。我们将一组受试者(患者、用户、顾客……)随机分为治疗组和对照组，并对治疗组进行治疗。这一程序确保了在此之前，两组之间的唯一预期差异是由治疗引起的。</p><p id="1293" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">AB测试的一个关键假设是治疗组和对照组之间没有<strong class="lh ja">污染</strong>。给治疗组的一个病人服用一种药物并不影响对照组病人的健康。举例来说，如果我们试图治愈一种传染性疾病，而这两个群体并没有被隔离，情况可能就不一样了。在这个行业中，经常违反污染假设的是<strong class="lh ja">网络效应</strong>——我使用社交网络的效用随着网络上朋友数量的增加而增加——和<strong class="lh ja">一般均衡效应</strong>——如果我改进一个产品，它可能会减少另一个类似产品的销售。</p><p id="539d" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">由于这个原因，实验通常在足够大的范围内进行，这样就不会有跨群体的污染，如城市、州、甚至国家。然后另一个问题因为规模更大而出现:治疗变得<strong class="lh ja">更贵</strong>。给医院里50%的病人开一种药，比给一个国家50%的城市开一种药要便宜得多。因此，通常只有<strong class="lh ja">几个单位接受治疗</strong>但通常需要更长的时间。</p><p id="a762" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在这种背景下，一种非常强大的方法在大约10年前出现:<strong class="lh ja">合成控制</strong>。综合控制的思想是利用数据的时间变化而不是横截面变化(跨时间而不是跨单元)。这种方法在业内非常流行——例如在像<a class="ae mb" href="https://proceedings.neurips.cc/paper/2021/file/48d23e87eb98cc2227b5a8c33fa00680-Paper.pdf" rel="noopener ugc nofollow" target="_blank">谷歌</a>、<a class="ae mb" href="https://eng.uber.com/causal-inference-at-uber/" rel="noopener ugc nofollow" target="_blank">优步</a>、<a class="ae mb" href="https://research.facebook.com/publications/regression-adjustment-with-synthetic-controls-in-online-experiments/" rel="noopener ugc nofollow" target="_blank">脸书</a>、<a class="ae mb" href="https://github.com/Microsoft/SparseSC" rel="noopener ugc nofollow" target="_blank">微软</a>和<a class="ae mb" href="https://www.amazon.science/publications/a-self-supervised-approach-to-hierarchical-forecasting-with-applications-to-groupwise-synthetic-controls" rel="noopener ugc nofollow" target="_blank">亚马逊</a>这样的公司——因为它很容易解释和处理经常大规模出现的背景。在这篇文章中，我们将通过例子来探索这种技术:我们将调查自动驾驶汽车对于拼车平台的有效性。</p></div><div class="ab cl mc md hu me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="ij ik il im in"><h1 id="ffb3" class="mj mk iq bd ml mm mn mo mp mq mr ms mt kf mu kg mv ki mw kj mx kl my km mz na bi translated">无人驾驶汽车的例子</h1><p id="c558" class="pw-post-body-paragraph lf lg iq lh b li nb ka lk ll nc kd ln lo nd lq lr ls ne lu lv lw nf ly lz ma ij bi translated">假设你是一个<strong class="lh ja">拼车平台</strong>，你想在你的车队中测试自动驾驶汽车的效果。</p><p id="f856" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">可以想象，对于这种类型的特性，运行AB/test有许多限制。首先，把个人乘坐随机化是很复杂的。第二，这是一个非常昂贵的干预。第三，也是统计上最重要的一点，你不能在游乐设备级别进行干预。问题是，从治疗组到控制组存在<strong class="lh ja">溢出</strong>效应:如果自动驾驶汽车确实更高效，这意味着它们可以在相同的时间内服务更多的客户，减少了普通司机(对照组)可以获得的客户。这种溢出污染了实验，并阻止了对结果的因果解释。</p><p id="dd3d" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">出于所有这些原因，我们只选择一个城市。鉴于这篇文章的合成氛围，我们不得不选择… ( <em class="ng">鼓声</em> )…迈阿密！</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl nh"><img src="../Images/10ce74ea8e3ee5e7315ddc3d17e710e5.png" data-original-src="https://miro.medium.com/v2/format:webp/1*s3v8-lxldTn9pU5m7DEbYA.jpeg"/></div><p class="lb lc gj gh gi ld le bd b be z dk translated">迈阿密天际线，图片来自<a class="ae mb" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank">Unsplash.com</a></p></figure><p id="80ea" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我生成了一个模拟数据集，在这个数据集里，我们观察了一组美国城市随时间的变化。收入数据是虚构的，而社会经济变量取自<a class="ae mb" href="https://stats.oecd.org/Index.aspx?DataSetCode=CITIES" rel="noopener ugc nofollow" target="_blank"> OECD 2022大都市地区数据库</a>。我从<code class="fe ni nj nk nl b"><a class="ae mb" href="https://github.com/matteocourthoud/Blog-Posts/blob/main/notebooks/src/dgp.py" rel="noopener ugc nofollow" target="_blank">src.dgp</a></code>导入数据生成过程<code class="fe ni nj nk nl b">dgp_selfdriving()</code>。我还从<code class="fe ni nj nk nl b"><a class="ae mb" href="https://github.com/matteocourthoud/Blog-Posts/blob/main/notebooks/src/utils.py" rel="noopener ugc nofollow" target="_blank">src.utils</a></code>引进了一些绘图函数和库。</p><pre class="kq kr ks kt gt nm nl nn no aw np bi"><span id="aa61" class="nq mk iq nl b gy nr ns l nt nu">from src.utils import *<br/>from src.dgp import dgp_selfdriving<br/><br/>treatment_year = 2013<br/>treated_city = 'Miami'<br/>df = dgp_selfdriving().generate_data(year=treatment_year, city=treated_city)<br/>df.head()</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl nh"><img src="../Images/64e2832f9027db918a5b89401dfefea2.png" data-original-src="https://miro.medium.com/v2/format:webp/1*HO_kMY0Iu9ywoQeROUckHg.png"/></div><p class="lb lc gj gh gi ld le bd b be z dk translated">数据快照，图片由作者提供</p></figure><p id="6b8e" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我们有2002年至2019年期间美国最大的46个城市的信息。面板是<strong class="lh ja">平衡的</strong>，这意味着我们在所有时间段观察所有城市。自动驾驶汽车于2013年推出。</p><p id="4761" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">迈阿密的<strong class="lh ja">处理过的</strong>单元与样本中的其他单元具有可比性吗？让我们使用优步的<code class="fe ni nj nk nl b"><a class="ae mb" href="https://causalml.readthedocs.io/" rel="noopener ugc nofollow" target="_blank">causalml</a></code>包中的<code class="fe ni nj nk nl b">create_table_one</code>函数来生成一个<strong class="lh ja">协变量平衡表</strong>，包含我们在治疗组和对照组中可观察到的特征的平均值。顾名思义，这应该永远是你在因果推断分析中呈现的第一张表。</p><pre class="kq kr ks kt gt nm nl nn no aw np bi"><span id="fd8b" class="nq mk iq nl b gy nr ns l nt nu">from causalml.match import create_table_one<br/><br/>create_table_one(df, 'treated', ['density', 'employment', 'gdp', 'population', 'revenue'])</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl nh"><img src="../Images/425580c94433e1167b06df13ce5778ba.png" data-original-src="https://miro.medium.com/v2/format:webp/1*KjgiCbcgATCDOP1FoQBAEw.png"/></div><p class="lb lc gj gh gi ld le bd b be z dk translated">平衡表，作者图片</p></figure><p id="b2f7" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">不出所料，这两个群体并不均衡:在我们的样本中，迈阿密比美国其他城市人口更密集、更贫穷、更大、就业率更低。</p><p id="e4fd" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我们有兴趣了解<strong class="lh ja">自动驾驶汽车</strong>的推出对<code class="fe ni nj nk nl b">revenue</code>的影响。</p><p id="658d" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">一个最初的想法可能是像我们在A/B测试中那样分析数据，比较对照组和治疗组。在引入自动驾驶汽车后，我们可以将治疗效果估计为治疗组和对照组之间在<code class="fe ni nj nk nl b">revenue</code>中的均值差异。</p><pre class="kq kr ks kt gt nm nl nn no aw np bi"><span id="bcd4" class="nq mk iq nl b gy nr ns l nt nu">smf.ols('revenue ~ treated', data=df[df['post']==True]).fit().summary().tables[1]</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi nv"><img src="../Images/c351ca1bd50e1609e22b7e1b3607753c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ljf6b0NA7SyczUU1WxSnSA.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">回归结果，图片由作者提供</p></figure><p id="cecf" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">自动驾驶汽车的效果看似负面但不显著。</p><p id="78b8" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">这里的主要问题是治疗不是由<strong class="lh ja">随机分配的</strong>。我们有一个单一的治疗单位，迈阿密，它几乎不能与其他城市相比。</p><p id="84b7" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">另一种方法是在迈阿密市内比较治疗前后的收入。</p><pre class="kq kr ks kt gt nm nl nn no aw np bi"><span id="230e" class="nq mk iq nl b gy nr ns l nt nu">smf.ols('revenue ~ post', data=df[df['city']==treated_city]).fit().summary().tables[1]</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi nw"><img src="../Images/025d004c23eb9312aa66a0b8b002f05a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vM1KzTqKV8GuJXS3Epzxww.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">回归结果，图片由作者提供</p></figure><p id="36d9" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">自动驾驶汽车的效果似乎是积极的，具有统计意义。</p><p id="bb6d" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">然而，这一程序的问题在于，2013年后可能会有许多其他事情发生。把所有的差异都归结于自动驾驶汽车是相当牵强的。</p><p id="a363" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">如果我们画出各城市税收的时间趋势，就能更好地理解这种担忧。首先，我们需要将数据转换成宽格式<strong class="lh ja"/>，每个城市一列，每年一行。</p><pre class="kq kr ks kt gt nm nl nn no aw np bi"><span id="b749" class="nq mk iq nl b gy nr ns l nt nu">df = df.pivot(index='year', columns='city', values='revenue').reset_index()</span></pre><p id="23b3" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">现在，让我们画出迈阿密和其他城市的收入随时间变化的曲线图。</p><pre class="kq kr ks kt gt nm nl nn no aw np bi"><span id="49d5" class="nq mk iq nl b gy nr ns l nt nu">cities = [c for c in df.columns if c!='year']<br/>df['Other Cities'] = df[[c for c in cities if c != treated_city]].mean(axis=1)</span></pre><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="196e" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">既然我们正在谈论迈阿密，让我们使用一个适当的调色板。</p><pre class="kq kr ks kt gt nm nl nn no aw np bi"><span id="e677" class="nq mk iq nl b gy nr ns l nt nu">sns.set_palette(sns.color_palette(['#f14db3', '#0dc3e2', '#443a84']))</span><span id="82b0" class="nq mk iq nl b gy nz ns l nt nu">plot_lines(df, treated_city, 'Other Cities', treatment_year)</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl nh"><img src="../Images/f4bf711ec3e80ef0f51f24de83c1ac78.png" data-original-src="https://miro.medium.com/v2/format:webp/1*-sbm9OJJ7RwPHaj7FnbR5w.png"/></div></figure><p id="cec0" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">正如我们所见，在迈阿密治疗后，收入似乎在增加。但这是一个非常不稳定的时间序列。该国其他地区的收入也在增加。从这个情节来看，很难将这种变化归因于自动驾驶汽车。</p><p id="96d0" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我们能做得更好吗？</p></div><div class="ab cl mc md hu me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="ij ik il im in"><h1 id="d29c" class="mj mk iq bd ml mm mn mo mp mq mr ms mt kf mu kg mv ki mw kj mx kl my km mz na bi translated">综合控制</h1><p id="cf5c" class="pw-post-body-paragraph lf lg iq lh b li nb ka lk ll nc kd ln lo nd lq lr ls ne lu lv lw nf ly lz ma ij bi translated">答案是肯定的！当我们有<strong class="lh ja">少至一个处理单元</strong>和<strong class="lh ja">多个控制单元</strong>时，综合控制允许我们进行因果推断，并且我们随着时间观察它们<strong class="lh ja">。这个想法很简单:将未处理的单元组合起来，使它们尽可能地模拟未处理单元的行为。然后用这个“合成单元”作为对照。该方法首先由<a class="ae mb" href="https://www.jstor.org/stable/3132164" rel="noopener ugc nofollow" target="_blank"> Abadie和Gardeazabal (2003) </a>提出，并被称为<a class="ae mb" href="https://www.aeaweb.org/articles?id=10.1257/jep.31.2.3" rel="noopener ugc nofollow" target="_blank">“过去几年政策评估文献中最重要的创新”</a>。此外，由于其简单性和可解释性，它在行业中被广泛使用。</strong></p><h2 id="4c41" class="nq mk iq bd ml oa ob dn mp oc od dp mt lo oe of mv ls og oh mx lw oi oj mz iw bi translated">环境</h2><p id="0090" class="pw-post-body-paragraph lf lg iq lh b li nb ka lk ll nc kd ln lo nd lq lr ls ne lu lv lw nf ly lz ma ij bi translated">我们假设，对于一组i.i.d .受试者<em class="ng"> i = 1，…，n </em>随着时间的推移<em class="ng"> t=1，…，T </em>，我们观察到一组变量<em class="ng"> (Xᵢₜ,Dᵢ,Yᵢₜ) </em>，包括</p><ul class=""><li id="e547" class="ok ol iq lh b li lj ll lm lo om ls on lw oo ma op oq or os bi translated">一项治疗任务<em class="ng"> Dᵢ∈{0,1} </em> ( <code class="fe ni nj nk nl b">treated</code>)</li><li id="6171" class="ok ol iq lh b li ot ll ou lo ov ls ow lw ox ma op oq or os bi translated">一个回应<em class="ng"> Yᵢₜ∈ℝ </em> ( <code class="fe ni nj nk nl b">revenue</code>)</li><li id="9fd2" class="ok ol iq lh b li ot ll ou lo ov ls ow lw ox ma op oq or os bi translated">一个特征向量<em class="ng"> Xᵢₜ∈ℝⁿ </em> ( <code class="fe ni nj nk nl b">population</code>、<code class="fe ni nj nk nl b">density</code>、<code class="fe ni nj nk nl b">employment</code>和<code class="fe ni nj nk nl b">GDP</code>)</li></ul><p id="6b83" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">此外，在时间<em class="ng">*</em>(在我们的例子中是2013年)处理一个单元(在我们的例子中是迈阿密)。我们区分治疗前的时间段和治疗后的时间段。</p><p id="dbf8" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">至关重要的是，治疗<em class="ng"> D </em>不是随机分配的，因此治疗组和对照组之间的平均值差异不是平均治疗效果的无偏估计值。</p><h2 id="a674" class="nq mk iq bd ml oa ob dn mp oc od dp mt lo oe of mv ls og oh mx lw oi oj mz iw bi translated">问题是</h2><p id="d47b" class="pw-post-body-paragraph lf lg iq lh b li nb ka lk ll nc kd ln lo nd lq lr ls ne lu lv lw nf ly lz ma ij bi translated">问题是，像往常一样，我们没有观察到治疗单位的反事实结果，即我们不知道如果他们没有接受治疗会发生什么。这就是所谓的<strong class="lh ja">因果推论的基本问题</strong>。</p><p id="1e02" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">最简单的方法就是比较治疗前后的时间。这被称为<strong class="lh ja">事件研究</strong>方法。</p><p id="4773" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">然而，我们可以做得比这更好。事实上，即使治疗不是随机分配的，我们仍然可以进入一些没有接受治疗的单位。</p><p id="d7f1" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">对于结果变量，我们观察以下值</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi oy"><img src="../Images/10f949e6526cd63016da1ad46875e597.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LYAFZEfaMqIrRFqD1-0lZg.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">结果变量，按作者分类的图像</p></figure><p id="ece0" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">其中<em class="ng"> Y </em> ⁽ᵈ⁾ₐ,ₜ是在时间<em class="ng"> t </em>的结果，给定治疗分配<em class="ng"> a </em>和治疗状态<em class="ng"> d </em>。我们基本上有一个<strong class="lh ja">缺失数据问题</strong>，因为我们没有观察到<em class="ng"> Y </em> ⁽⁰⁾ₜ,ₚₒₛₜ:在未经处理(<em class="ng"> a=t </em>)的情况下会发生什么。</p><h2 id="bfc1" class="nq mk iq bd ml oa ob dn mp oc od dp mt lo oe of mv ls og oh mx lw oi oj mz iw bi translated">解决方案</h2><p id="cbe4" class="pw-post-body-paragraph lf lg iq lh b li nb ka lk ll nc kd ln lo nd lq lr ls ne lu lv lw nf ly lz ma ij bi translated">根据<a class="ae mb" href="https://arxiv.org/pdf/1610.07748.pdf" rel="noopener ugc nofollow" target="_blank"> Doudchenko和Inbens (2018) </a>，我们可以将治疗单位的反事实结果估计值公式化为对照单位观察结果的线性组合。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi oz"><img src="../Images/239733cf7ffb5303af058c7d002ceed9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7vBoUjTVq4Lap6VJKBgYnQ.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">合成控制结果，图像由作者提供</p></figure><p id="bd8e" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在哪里</p><ul class=""><li id="d4a2" class="ok ol iq lh b li lj ll lm lo om ls on lw oo ma op oq or os bi translated">常数<em class="ng"> α </em>允许两组之间有不同的平均值</li><li id="2769" class="ok ol iq lh b li ot ll ou lo ov ls ow lw ox ma op oq or os bi translated">重量<em class="ng"> βᵢ </em>允许在控制单元<em class="ng"> i </em>之间变化(否则，这将是差异中的差异)</li></ul><p id="b6f2" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我们应该如何<strong class="lh ja">选择使用哪些砝码</strong>？我们希望在治疗前，我们的合成对照尽可能接近结果。第一种方法是将权重定义为</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi pa"><img src="../Images/4368683495078e162241776387933ecd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*znKE4y57bXEJoVWL_YaaKA.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">合成控制权重，图片由作者提供</p></figure><p id="28db" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">也就是说，权重使得在处理之前，控制单元<em class="ng"> Xc </em>和被处理单元<em class="ng"> Xₜ </em>的可观察特征之间的距离最小化。</p><p id="1691" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">您可能会注意到与<strong class="lh ja">线性回归</strong>非常相似。事实上，我们正在做非常相似的事情。</p><p id="df18" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在线性回归中，我们通常有<strong class="lh ja">多个单元</strong>(观察值)<strong class="lh ja">几个外生特征，</strong>和<strong class="lh ja">一个内生特征</strong>，我们尝试将每个单元的内生特征表达为内生特征的线性组合。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl nh"><img src="../Images/03acc311fcea6bcf3d9c73596c5bcfa4.png" data-original-src="https://miro.medium.com/v2/format:webp/1*fT09_ghbq7tSkcc-tvu8tA.png"/></div><p class="lb lc gj gh gi ld le bd b be z dk translated">线性回归，作者图片</p></figure><p id="6d93" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">对于综合控制，我们改为使用<strong class="lh ja">多个时间段</strong>(特征)、几个<strong class="lh ja">控制单元</strong>和单个<strong class="lh ja">处理单元</strong>，并且我们尝试将处理单元表示为每个时间段的控制单元的线性组合。</p><p id="30ba" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">为了执行相同的操作，我们本质上需要<strong class="lh ja">转置数据</strong>。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl nh"><img src="../Images/1a02972db958c996e97b9bbd4ec3bf17.png" data-original-src="https://miro.medium.com/v2/format:webp/1*5KfBD5TgWCI06N9pEns1JQ.png"/></div><p class="lb lc gj gh gi ld le bd b be z dk translated">由作者转置数据、图像</p></figure><p id="9173" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">交换后，我们计算<strong class="lh ja">综合控制</strong>权重，就像我们计算回归系数一样。但是，现在一个观测值是一个时间段，一个要素是一个单元。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl nh"><img src="../Images/de9f0a63583ad322ec1439eccf477251.png" data-original-src="https://miro.medium.com/v2/format:webp/1*cs2pK_bcx3QRFLBkRg0zuw.png"/></div><p class="lb lc gj gh gi ld le bd b be z dk translated">合成控制回归，图片由作者提供</p></figure><p id="638c" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">请注意，这种交换是<strong class="lh ja">而不是无辜的</strong>。在线性回归中，我们假设外源特征和内源特征之间的关系在单位中是相同的<strong class="lh ja">，而在合成控制中，我们假设处理单位和控制单位之间的关系在时间</strong>上是相同的<strong class="lh ja">。</strong></p><h2 id="f0b5" class="nq mk iq bd ml oa ob dn mp oc od dp mt lo oe of mv ls og oh mx lw oi oj mz iw bi translated">回到自动驾驶汽车</h2><p id="d221" class="pw-post-body-paragraph lf lg iq lh b li nb ka lk ll nc kd ln lo nd lq lr ls ne lu lv lw nf ly lz ma ij bi translated">现在让我们回到数据上来！首先，我们编写一个<code class="fe ni nj nk nl b">synth_predict</code>函数，该函数将一个模型作为输入，该模型在对照城市进行了训练，并试图在无人驾驶汽车引入之前预测被处理城市迈阿密的结果。</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="9f91" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">让我们通过线性回归估计模型。</p><pre class="kq kr ks kt gt nm nl nn no aw np bi"><span id="8587" class="nq mk iq nl b gy nr ns l nt nu">from sklearn.linear_model import LinearRegression<br/><br/>coef = synth_predict(df, LinearRegression(), treated_city, treatment_year).coef_</span></pre><p id="8a8b" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在迈阿密，我们<strong class="lh ja">与</strong>预无人驾驶汽车<code class="fe ni nj nk nl b">revenue</code>的匹配程度如何？自动驾驶汽车的隐含<strong class="lh ja">效果</strong>是什么？</p><p id="4d0b" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">通过将迈阿密的实际收入与预测收入进行对比，我们可以直观地回答这两个问题。</p><pre class="kq kr ks kt gt nm nl nn no aw np bi"><span id="f85b" class="nq mk iq nl b gy nr ns l nt nu">plot_lines(df, treated_city, f'Synthetic {treated_city}', treatment_year)</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl nh"><img src="../Images/4f88652229fd77440049b58558e327ce.png" data-original-src="https://miro.medium.com/v2/format:webp/1*npytc3rUMpbKCGrM5D7bGw.png"/></div><p class="lb lc gj gh gi ld le bd b be z dk translated">观察和合成的迈阿密收入，作者图片</p></figure><p id="b54f" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">看起来自动驾驶汽车对迈阿密的<code class="fe ni nj nk nl b">revenue</code>产生了明显的<strong class="lh ja">积极影响</strong>:预测趋势低于实际数据，并在自动驾驶汽车推出后立即偏离。</p><p id="e5c9" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">另一方面，我们显然是<strong class="lh ja">过拟合</strong>:预处理预测<code class="fe ni nj nk nl b">revenue</code>线与实际数据完美重叠。鉴于迈阿密<code class="fe ni nj nk nl b">revenue</code>的高度可变性，至少可以说这是可疑的。</p><p id="faf6" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">另一个问题与<strong class="lh ja">砝码</strong>有关。让我们画出它们。</p><pre class="kq kr ks kt gt nm nl nn no aw np bi"><span id="c77c" class="nq mk iq nl b gy nr ns l nt nu">df_states = pd.DataFrame({'city': [c for c in cities if c!=treated_city], 'ols_coef': coef})<br/>plt.figure(figsize=(10, 9))<br/>sns.barplot(data=df_states, x='ols_coef', y='city');</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl nh"><img src="../Images/ea78f33974e5e33d58d614c1709f26bc.png" data-original-src="https://miro.medium.com/v2/format:webp/1*gXRsGsv90N6J7rrF0re5LQ.png"/></div><p class="lb lc gj gh gi ld le bd b be z dk translated">合成控制权重，图片由作者提供</p></figure><p id="4daf" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我们有很多<strong class="lh ja">负权重</strong>，从因果推理的角度来看没有太大意义。我可以理解迈阿密可以表示为0.2圣路易斯，0.15俄克拉荷马，0.15哈特福德的组合。但是迈阿密是-0.15密尔沃基是什么意思？</p><p id="29c0" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">因为我们想把我们的合成对照解释为未处理状态的加权平均值，所有的权重应该是正的，并且它们的总和应该是1。</p><p id="2fb3" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">为了解决这两个问题(权重和过度拟合)，我们需要对权重施加一些<strong class="lh ja">限制。</strong></p><h2 id="752c" class="nq mk iq bd ml oa ob dn mp oc od dp mt lo oe of mv ls og oh mx lw oi oj mz iw bi translated">限制重量</h2><p id="704a" class="pw-post-body-paragraph lf lg iq lh b li nb ka lk ll nc kd ln lo nd lq lr ls ne lu lv lw nf ly lz ma ij bi translated">为了解决超重和负权重的问题，<a class="ae mb" href="https://www.tandfonline.com/doi/abs/10.1198/jasa.2009.ap08746" rel="noopener ugc nofollow" target="_blank"> Abadie、Diamond和Hainmueller (2010) </a>提出了以下权重:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi pb"><img src="../Images/d1191e83539e0b0b3cac2c3b04ef7d64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UFb6MqAgEeKl88GQoa9-JQ.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">权重的约束定义，按作者排列的图像</p></figure><p id="7c0f" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">该公式暗示了一组权重<em class="ng"> β </em>,使得</p><ul class=""><li id="81d7" class="ok ol iq lh b li lj ll lm lo om ls on lw oo ma op oq or os bi translated">对照组<em class="ng"> Xc </em>的加权可观察特征与治疗前治疗组<em class="ng"> Xₜ </em>的可观察特征相匹配</li><li id="6cf8" class="ok ol iq lh b li ot ll ou lo ov ls ow lw ox ma op oq or os bi translated">它们总计为1</li><li id="ce3c" class="ok ol iq lh b li ot ll ou lo ov ls ow lw ox ma op oq or os bi translated">并且不是负面的。</li></ul><p id="72c4" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">通过这种方法，我们得到一个<strong class="lh ja">可解释的反事实</strong>作为未处理单位的加权平均值。</p><p id="6887" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">现在让我们写出我们自己的目标函数。我创建了一个新的类<code class="fe ni nj nk nl b">SyntheticControl()</code>，它有一个<code class="fe ni nj nk nl b">loss</code>函数，如上所述，一个方法来<code class="fe ni nj nk nl b">fit</code>它和<code class="fe ni nj nk nl b">predict</code>被处理单元的值。</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="8e27" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我们现在可以像以前一样重复同样的程序，但是使用<code class="fe ni nj nk nl b">SyntheticControl</code>方法代替简单的、不受约束的<code class="fe ni nj nk nl b">LinearRegression</code>。</p><pre class="kq kr ks kt gt nm nl nn no aw np bi"><span id="5437" class="nq mk iq nl b gy nr ns l nt nu">df_states['coef_synth'] = synth_predict(df, SyntheticControl(), treated_city, treatment_year).coef_<br/>plot_lines(df, treated_city, f'Synthetic {treated_city}', treatment_year)</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl nh"><img src="../Images/6ae4810bf5041704c8e8072e2703b973.png" data-original-src="https://miro.medium.com/v2/format:webp/1*H3ULFk8gkOOIFKlRdOHefg.png"/></div><p class="lb lc gj gh gi ld le bd b be z dk translated">观察和合成的迈阿密收入，作者图片</p></figure><p id="c370" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">正如我们所看到的，现在我们不再过度适应了。实际和预测的<code class="fe ni nj nk nl b">revenue</code>预处理接近但不相同。原因是非负约束将大多数系数约束为零(正如<a class="ae mb" href="https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.Lasso.html" rel="noopener ugc nofollow" target="_blank">拉索</a>所做的)。</p><p id="c42c" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">看起来效果又是负面的。然而，让我们画出两条线之间的<strong class="lh ja">差</strong>来更好地形象化大小。</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nx ny l"/></div></figure><pre class="kq kr ks kt gt nm nl nn no aw np bi"><span id="b67b" class="nq mk iq nl b gy nr ns l nt nu">plot_difference(df, treated_city, treatment_year)</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl nh"><img src="../Images/a89caf1407a6bfc992a6be8d677d98ea.png" data-original-src="https://miro.medium.com/v2/format:webp/1*46bWU2Y-ILxfFZD5pXZiWA.png"/></div><p class="lb lc gj gh gi ld le bd b be z dk translated">观察到的迈阿密和合成的迈阿密之间的差异，图片由作者提供</p></figure><p id="246d" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">这种差异显然是正的，并且随着时间的推移略有增加。</p><p id="7fbb" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我们还可以可视化<strong class="lh ja">权重</strong>来解释估计的反事实(如果没有自动驾驶汽车，迈阿密会发生什么)。</p><pre class="kq kr ks kt gt nm nl nn no aw np bi"><span id="b7a1" class="nq mk iq nl b gy nr ns l nt nu">plt.figure(figsize=(10, 9))<br/>sns.barplot(data=df_states, x='coef_synth', y='city');</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl nh"><img src="../Images/5b5891735c0db87d8fef08e15e8a35bc.png" data-original-src="https://miro.medium.com/v2/format:webp/1*wNc3NRJoG1Qn7vM5hW7oLA.png"/></div><p class="lb lc gj gh gi ld le bd b be z dk translated">受约束的权重，按作者排序的图像</p></figure><p id="96ce" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">正如我们所看到的，现在我们将迈阿密的<code class="fe ni nj nk nl b">revenue</code>表示为几个城市的线性组合:坦帕、圣路易斯，以及在较低程度上的拉斯维加斯。这使得整个程序非常<strong class="lh ja">透明</strong>。</p></div><div class="ab cl mc md hu me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="ij ik il im in"><h1 id="430a" class="mj mk iq bd ml mm mn mo mp mq mr ms mt kf mu kg mv ki mw kj mx kl my km mz na bi translated">推理</h1><p id="e37e" class="pw-post-body-paragraph lf lg iq lh b li nb ka lk ll nc kd ln lo nd lq lr ls ne lu lv lw nf ly lz ma ij bi translated">那么<strong class="lh ja">推论</strong>呢？估计值是否明显不同于零？或者，更实际地说，“在没有政策效应的零假设下，这个估计值有多不寻常？”。</p><p id="90d8" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">为了回答这个问题，我们将进行一个<a class="ae mb" href="https://en.wikipedia.org/wiki/Permutation_test" rel="noopener ugc nofollow" target="_blank"> <strong class="lh ja">随机/排列测试</strong> </a>。<strong class="lh ja">想法</strong>是，如果政策没有效果，我们在迈阿密观察到的效果不应该与我们在任何其他城市观察到的效果有明显不同。</p><p id="6fd5" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">因此，我们将对所有其他城市重复上述过程，并将它们与迈阿密的估计值进行比较。</p><pre class="kq kr ks kt gt nm nl nn no aw np bi"><span id="fbbe" class="nq mk iq nl b gy nr ns l nt nu">fig, ax = plt.subplots()<br/>for city in cities:<br/>    synth_predict(df, SyntheticControl(), city, treatment_year)<br/>    plot_difference(df, city, treatment_year, vline=False, alpha=0.2, color='C1', lw=3)<br/>plot_difference(df, treated_city, treatment_year)</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl nh"><img src="../Images/20071529a152609293656590f547156b.png" data-original-src="https://miro.medium.com/v2/format:webp/1*OAUjT0c7M--ZeEo62g28YQ.png"/></div><p class="lb lc gj gh gi ld le bd b be z dk translated">合成效果的分布，按作者分类的图像</p></figure><p id="96e1" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">从图表中，我们注意到两件事。首先，对迈阿密的影响非常极端，因此不太可能是由随机噪音造成的。</p><p id="eb21" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">第二，我们还注意到，有几个城市我们不能很好地拟合前期趋势。特别是，有一条线明显低于所有其他线。这是意料之中的，因为对于每个城市，我们都将反事实趋势构建为所有其他城市的凸组合。就<code class="fe ni nj nk nl b">revenue</code>而言非常极端的城市对于构建其他城市的反事实非常有用，但是<strong class="lh ja">很难为它们构建反事实</strong>。</p><p id="03a5" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">为了不影响分析，让我们排除那些我们不能建立“足够好”的反事实的州，就治疗前MSE而言。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi nv"><img src="../Images/724d2288c828e78a53b6a3fd6e90d31c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_e7V7l6HEVF5J9iFyoaNTw.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">预处理预测均方误差，图片由作者提供</p></figure><p id="9a48" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">根据经验，<a class="ae mb" href="https://www.tandfonline.com/doi/abs/10.1198/jasa.2009.ap08746" rel="noopener ugc nofollow" target="_blank"> Abadie、Diamond和Hainmueller (2010) </a>建议排除预测均方误差大于处理单元均方误差两倍的单元。</p><pre class="kq kr ks kt gt nm nl nn no aw np bi"><span id="bce8" class="nq mk iq nl b gy nr ns l nt nu"># Reference mse<br/>mse_treated = synth_predict(df, SyntheticControl(), treated_city, treatment_year).mse<br/><br/># Other mse<br/>fig, ax = plt.subplots()<br/>for city in cities:<br/>    mse = synth_predict(df, SyntheticControl(), city, treatment_year).mse<br/>    if mse &lt; 2 * mse_treated:<br/>        plot_difference(df, city, treatment_year, vline=False, alpha=0.2, color='C1', lw=3)<br/>plot_difference(df, treated_city, treatment_year)</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl nh"><img src="../Images/50a92eb2b990ab401b6618ae74ab1091.png" data-original-src="https://miro.medium.com/v2/format:webp/1*Sr5FAQR8sv-Qm4FIQZ-5yg.png"/></div><p class="lb lc gj gh gi ld le bd b be z dk translated">没有不可预测单元的合成效果的分布，由作者提供的图像</p></figure><p id="53a5" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在排除了极端的观察之后，看起来对迈阿密的影响很不寻常。</p><p id="c90a" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">Abadie、Diamond和Hainmueller (2010) 建议进行随机化检验的一个<strong class="lh ja">统计量</strong>是治疗前MSE和治疗后MSE之间的比率。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi pc"><img src="../Images/9d2afe8f02514fdaa7fa7be06180e1b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J1FbF1kjM9yiOu4z0NxsvA.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">前后均方预测误差比，图片由作者提供</p></figure><p id="2a7d" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我们可以将p值计算为具有较高比率的观察值的数量。</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nx ny l"/></div></figure><pre class="kq kr ks kt gt nm nl nn no aw np bi"><span id="e74f" class="nq mk iq nl b gy nr ns l nt nu">p-value: 0.04348</span></pre><p id="2125" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">似乎只有4.3%的城市的MSE比率大于迈阿密，这意味着p值为0.043。我们可以用直方图形象化排列下统计量的分布。</p><pre class="kq kr ks kt gt nm nl nn no aw np bi"><span id="5ac8" class="nq mk iq nl b gy nr ns l nt nu">fig, ax = plt.subplots()<br/>_, bins, _ = plt.hist(lambdas.values(), bins=20, color="C1");<br/>plt.hist([lambdas[treated_city]], bins=bins)<br/>plt.title('Ratio of $MSE_{post}$ and $MSE_{pre}$ across cities');<br/>ax.add_artist(AnnotationBbox(OffsetImage(plt.imread('fig/miami.png'), zoom=0.25), (2.7, 1.7), frameon=False));</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl nh"><img src="../Images/937993e300cd3b583e79821affd91c4c.png" data-original-src="https://miro.medium.com/v2/format:webp/1*2-ZxFkA6DsU89L1YzoElHQ.png"/></div><p class="lb lc gj gh gi ld le bd b be z dk translated">城市中前后MSE比率的分布，按作者分类的图像。</p></figure><p id="024b" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">事实上，迈阿密的统计数据非常极端，表明观察到的效应不太可能是由噪音引起的。</p></div><div class="ab cl mc md hu me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="ij ik il im in"><h1 id="ef36" class="mj mk iq bd ml mm mn mo mp mq mr ms mt kf mu kg mv ki mw kj mx kl my km mz na bi translated">结论</h1><p id="c3b4" class="pw-post-body-paragraph lf lg iq lh b li nb ka lk ll nc kd ln lo nd lq lr ls ne lu lv lw nf ly lz ma ij bi translated">在这篇文章中，我们探索了一种非常流行的因果推断方法，当我们有<strong class="lh ja">几个处理单元</strong>，但有许多时间段时。当必须在<strong class="lh ja">总水平</strong>分配治疗并且随机化可能不可行时，这种设置经常出现在行业设置中。综合控制的核心思想是<strong class="lh ja">将控制单元</strong>组合成一个综合控制单元，作为反事实来估计治疗的因果效应。</p><p id="ef58" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">合成控制的一个主要优点是，只要我们使用正的权重，这些权重被限制为总和为1，方法就可以避免外推:我们永远不会脱离数据的支持。此外，合成对照研究可以<strong class="lh ja">【预注册】</strong>:您可以在研究前指定权重，以避免<a class="ae mb" href="https://en.wikipedia.org/wiki/Data_dredging" rel="noopener ugc nofollow" target="_blank"> p-hacking </a>和cherry-picking。这种方法在业内如此流行的另一个原因是，权重使得反事实分析<strong class="lh ja">显而易见</strong>:人们可以查看权重并理解我们正在进行的比较。</p><p id="02cd" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">这种方法相对年轻，每年都有许多<strong class="lh ja">扩展</strong>出现。其中值得注意的有<a class="ae mb" href="https://www.cambridge.org/core/journals/political-analysis/article/generalized-synthetic-control-method-causal-inference-with-interactive-fixed-effects-models/B63A8BD7C239DD4141C67DA10CD0E4F3" rel="noopener ugc nofollow" target="_blank">徐(2017) </a>的广义综合控制、<a class="ae mb" href="https://arxiv.org/pdf/1610.07748.pdf" rel="noopener ugc nofollow" target="_blank">杜先科和伊本斯(2017) </a>的综合差分、以及<a class="ae mb" href="https://www.tandfonline.com/doi/full/10.1080/01621459.2021.1971535" rel="noopener ugc nofollow" target="_blank">阿巴第·埃勒小时(2020) </a>的惩罚综合控制、以及<a class="ae mb" href="https://www.tandfonline.com/doi/abs/10.1080/01621459.2021.1891924" rel="noopener ugc nofollow" target="_blank">阿西等人(2021) </a>的矩阵补全方法。最后但同样重要的是，如果你想让它的发明者来解释这个方法，在Youtube上有一个免费的由Alberto Abadie在NBER夏季学院做的精彩演讲。</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="pd ny l"/></div></figure></div><div class="ab cl mc md hu me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="ij ik il im in"><h2 id="9c05" class="nq mk iq bd ml oa ob dn mp oc od dp mt lo oe of mv ls og oh mx lw oi oj mz iw bi translated">参考</h2><p id="4ac4" class="pw-post-body-paragraph lf lg iq lh b li nb ka lk ll nc kd ln lo nd lq lr ls ne lu lv lw nf ly lz ma ij bi translated">[1] A. Abadie，J. Gardeazabal，<a class="ae mb" href="https://www.jstor.org/stable/3132164" rel="noopener ugc nofollow" target="_blank">冲突的经济成本:巴斯克地区的案例研究</a> (2003)，<em class="ng">《美国经济评论》</em>。</p><p id="52ca" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">[2] A. Abadie，A. Diamond，J. Hainmueller，<a class="ae mb" href="https://www.tandfonline.com/doi/abs/10.1198/jasa.2009.ap08746" rel="noopener ugc nofollow" target="_blank">比较案例研究的综合控制方法:估计加州烟草控制计划的效果</a> (2010)，<em class="ng">美国统计协会杂志</em>。</p><p id="9ff8" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">[3] A. Abadie，<a class="ae mb" href="https://www.aeaweb.org/articles?id=10.1257/jel.20191450" rel="noopener ugc nofollow" target="_blank">《使用综合控制:可行性、数据要求和方法学方面》</a> (2021)，<em class="ng">《经济展望杂志》</em>。</p><p id="1927" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">[4] N. Doudchenko，G. Imbens，<a class="ae mb" href="https://arxiv.org/pdf/1610.07748.pdf" rel="noopener ugc nofollow" target="_blank">平衡、回归、差异中的差异和综合控制方法:一个综合</a> (2017)，<em class="ng">工作论文</em>。</p><p id="7a84" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">[5] Y. Xu，<a class="ae mb" href="https://www.cambridge.org/core/journals/political-analysis/article/generalized-synthetic-control-method-causal-inference-with-interactive-fixed-effects-models/B63A8BD7C239DD4141C67DA10CD0E4F3" rel="noopener ugc nofollow" target="_blank">广义综合控制方法:具有交互固定效应模型的因果推断</a> (2018)，<em class="ng">政治分析</em>。</p><p id="d9c4" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">[6] A. Abadie，J. L'Hour，<a class="ae mb" href="https://www.tandfonline.com/doi/full/10.1080/01621459.2021.1971535" rel="noopener ugc nofollow" target="_blank">一种用于分类数据的惩罚合成控制估计量</a> (2020)，<em class="ng">美国统计协会杂志</em>。</p><p id="8e4f" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">[7] S. Athey，M. Bayati，N. Doudchenko，G. Imbens，K. Khosravi，<a class="ae mb" href="https://www.tandfonline.com/doi/abs/10.1080/01621459.2021.1891924" rel="noopener ugc nofollow" target="_blank">因果面板数据模型的矩阵补全方法</a> (2021)，<em class="ng">美国统计协会杂志</em>。</p><h2 id="1385" class="nq mk iq bd ml oa ob dn mp oc od dp mt lo oe of mv ls og oh mx lw oi oj mz iw bi translated">相关文章</h2><ul class=""><li id="28ea" class="ok ol iq lh b li nb ll nc lo pe ls pf lw pg ma op oq or os bi translated"><a class="ae mb" rel="noopener" target="_blank" href="/b63dc69e3d8c">Dag和控制变量</a></li><li id="4ef7" class="ok ol iq lh b li ot ll ou lo ov ls ow lw ox ma op oq or os bi translated">匹配、加权还是回归？</li><li id="598c" class="ok ol iq lh b li ot ll ou lo ov ls ow lw ox ma op oq or os bi translated"><a class="ae mb" rel="noopener" target="_blank" href="/8a9c1e340832">了解元学习者</a></li></ul><h2 id="2959" class="nq mk iq bd ml oa ob dn mp oc od dp mt lo oe of mv ls og oh mx lw oi oj mz iw bi translated">数据</h2><ul class=""><li id="f923" class="ok ol iq lh b li nb ll nc lo pe ls pf lw pg ma op oq or os bi translated">经合组织(2022)，<a class="ae mb" href="https://stats.oecd.org/Index.aspx?DataSetCode=CITIES" rel="noopener ugc nofollow" target="_blank"> <em class="ng">大都市地区数据库</em> </a>，最后一次访问日期:2012年7月30日</li></ul><h2 id="791f" class="nq mk iq bd ml oa ob dn mp oc od dp mt lo oe of mv ls og oh mx lw oi oj mz iw bi translated">密码</h2><p id="54f0" class="pw-post-body-paragraph lf lg iq lh b li nb ka lk ll nc kd ln lo nd lq lr ls ne lu lv lw nf ly lz ma ij bi translated">你可以在这里找到Jupyter的原始笔记本:</p><div class="ph pi gp gr pj pk"><a href="https://github.com/matteocourthoud/Blog-Posts/blob/main/notebooks/synth.ipynb" rel="noopener  ugc nofollow" target="_blank"><div class="pl ab fo"><div class="pm ab pn cl cj po"><h2 class="bd ja gy z fp pp fr fs pq fu fw iz bi translated">在main matter courthoud/Blog-Posts/synth . ipynb</h2><div class="pr l"><h3 class="bd b gy z fp pp fr fs pq fu fw dk translated">我的中型博客文章的代码和笔记本。为matteocourthoud/Blog-Posts的发展作出贡献</h3></div><div class="ps l"><p class="bd b dl z fp pp fr fs pq fu fw dk translated">github.com</p></div></div><div class="pt l"><div class="pu l pv pw px pt py kz pk"/></div></div></a></div></div><div class="ab cl mc md hu me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="ij ik il im in"><h2 id="a7af" class="nq mk iq bd ml oa ob dn mp oc od dp mt lo oe of mv ls og oh mx lw oi oj mz iw bi translated">感谢您的阅读！</h2><p id="216c" class="pw-post-body-paragraph lf lg iq lh b li nb ka lk ll nc kd ln lo nd lq lr ls ne lu lv lw nf ly lz ma ij bi translated">我真的很感激！🤗<em class="ng">如果你喜欢这个帖子并想看更多，可以考虑</em> <a class="ae mb" href="https://medium.com/@matteo.courthoud" rel="noopener"> <strong class="lh ja"> <em class="ng">关注我</em> </strong> </a> <em class="ng">。我每周发布一次与因果推断和数据分析相关的主题。我尽量让我的帖子简单而精确，总是提供代码、例子和模拟。</em></p><p id="7c92" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><em class="ng">还有，一个小小的</em> <strong class="lh ja"> <em class="ng">免责声明</em> </strong> <em class="ng">:我写作是为了学习所以错误是家常便饭，尽管我尽了最大努力。当你发现他们的时候，请告诉我。也很欣赏新话题的建议！</em></p></div></div>    
</body>
</html>