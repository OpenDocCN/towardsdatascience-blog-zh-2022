<html>
<head>
<title>How to Chain Functions in Pyspark with Pipe</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用管道链接Pyspark中的函数</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-chain-functions-in-pyspark-with-pandas-pipe-1915ed7ebc34#2022-04-13">https://towardsdatascience.com/how-to-chain-functions-in-pyspark-with-pandas-pipe-1915ed7ebc34#2022-04-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="bcb3" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用熊猫管法的pyspark等效链多函数</h2></div><h1 id="d63f" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">动机</h1><p id="77b0" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">如果你是一个Pandas用户，你可能遇到过Pandas DataFrame <code class="fe lw lx ly lz b">.pipe()</code>方法，它允许用户对数据帧或系列应用可链接的函数。如果你对熊猫<code class="fe lw lx ly lz b">.pipe()</code>不熟悉，这里有一个快速的例子和开始使用它的动机。</p><figure class="mb mc md me gt mf gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi ma"><img src="../Images/595c99e566328b8377612cc718e98197.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aD7hHumUjlOkhcDI"/></div></div><p class="mm mn gj gh gi mo mp bd b be z dk translated">照片由<a class="ae mq" href="https://unsplash.com/@dilolwa?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Helio Dilolwa </a>在<a class="ae mq" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="b4af" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated"><strong class="lc iu">什么是熊猫</strong> <code class="fe lw lx ly lz b"><strong class="lc iu">.pipe()</strong></code> <strong class="lc iu">？</strong></p><p id="2cfb" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated"><strong class="lc iu">参数</strong></p><ul class=""><li id="4205" class="mw mx it lc b ld mr lg ms lj my ln mz lr na lv nb nc nd ne bi translated"><code class="fe lw lx ly lz b">func</code>:应用于系列/数据框的功能</li><li id="fe88" class="mw mx it lc b ld nf lg ng lj nh ln ni lr nj lv nb nc nd ne bi translated"><code class="fe lw lx ly lz b">args</code>:位置参数传递给<code class="fe lw lx ly lz b">func</code></li><li id="4caf" class="mw mx it lc b ld nf lg ng lj nh ln ni lr nj lv nb nc nd ne bi translated"><code class="fe lw lx ly lz b">kwargs</code>:传递给<code class="fe lw lx ly lz b">func</code>的关键字参数</li></ul><p id="06e1" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated"><strong class="lc iu">退货</strong></p><ul class=""><li id="2ca5" class="mw mx it lc b ld mr lg ms lj my ln mz lr na lv nb nc nd ne bi translated"><code class="fe lw lx ly lz b">object</code>:返回类型<code class="fe lw lx ly lz b">func</code></li></ul><p id="2e17" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated">在本例中，我们有3个函数对数据帧进行操作，<code class="fe lw lx ly lz b">f1</code>、<code class="fe lw lx ly lz b">f2</code>和<code class="fe lw lx ly lz b">f3</code>，每个函数都需要一个数据帧和参数作为输入，并返回转换后的数据帧。</p><pre class="mb mc md me gt nk lz nl nm aw nn bi"><span id="9e37" class="no kj it lz b gy np nq l nr ns">def f1(df, arg1):<br/>	# do something	return # a dataframe</span><span id="5051" class="no kj it lz b gy nt nq l nr ns">def f2(df, arg2):<br/>	# do something	return # a dataframe</span><span id="af34" class="no kj it lz b gy nt nq l nr ns">def f3(df, arg3):<br/>	# do something	return # a dataframe</span><span id="decd" class="no kj it lz b gy nt nq l nr ns">df = pd.DataFrame(..) # some dataframe</span></pre><p id="fd7b" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated">如果不使用<code class="fe lw lx ly lz b">.pipe()</code>，我们将以嵌套的方式应用函数，如果有多个函数，这可能看起来很难理解。</p><pre class="mb mc md me gt nk lz nl nm aw nn bi"><span id="3dc0" class="no kj it lz b gy np nq l nr ns">f1(f2(f3(df, arg3 = arg3), arg2 = arg2), arg1 = arg1)</span></pre><p id="a30e" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated">为了遵循函数执行的顺序，必须从“由内向外”阅读。首先执行最内部的功能<code class="fe lw lx ly lz b">f3</code>，然后执行<code class="fe lw lx ly lz b">f2</code>，最后执行<code class="fe lw lx ly lz b">f1</code>。</p><p id="34b1" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated"><code class="fe lw lx ly lz b">.pipe()</code>避免嵌套，允许使用点符号(<code class="fe lw lx ly lz b">.</code>)链接函数，使其更具可读性。<code class="fe lw lx ly lz b">.pipe()</code>还允许传递位置参数和关键字参数，并假设函数的第一个参数指向输入数据帧/序列。</p><pre class="mb mc md me gt nk lz nl nm aw nn bi"><span id="eb73" class="no kj it lz b gy np nq l nr ns">df.pipe(f3, arg3 = arg3).pipe(f2, arg2 = arg2).pipe(f1, arg1 = arg1)</span></pre><p id="afea" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated">遵循与<code class="fe lw lx ly lz b">.pipe()</code>链接在一起的功能的执行顺序更直观；我们只是从左向右读。</p><p id="0ba6" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated">Pyspark是大数据处理中熊猫的流行替代品。在本文中，我们将研究如何使用以下方法链接pyspark函数:</p><ol class=""><li id="0c41" class="mw mx it lc b ld mr lg ms lj my ln mz lr na lv nu nc nd ne bi translated">派斯帕克的<code class="fe lw lx ly lz b">.transform()</code>方法</li><li id="a05f" class="mw mx it lc b ld nf lg ng lj nh ln ni lr nj lv nu nc nd ne bi translated">创建一个Pyspark，相当于熊猫的<code class="fe lw lx ly lz b">.pipe()</code>方法</li></ol><h1 id="3d95" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">数据</h1><p id="30b9" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">这是我们将在示例中使用的合成数据。</p><pre class="mb mc md me gt nk lz nl nm aw nn bi"><span id="ef82" class="no kj it lz b gy np nq l nr ns">df = spark.createDataFrame([('John', 30, 180, 90, 'm'), ('Karen', 27, 173, 60, 'f')], ['name', 'age', 'height', 'weight', 'gender'])<br/>df.show()</span><span id="8bec" class="no kj it lz b gy nt nq l nr ns">+-----+---+------+------+------+<br/>| name|age|height|weight|gender|<br/>+-----+---+------+------+------+<br/>| John| 30|   180|    90|     m|<br/>|Karen| 27|   173|    60|     f|<br/>+-----+---+------+------+------+</span></pre><p id="4ece" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated">该数据集包含两个人John和Karen的年龄、身高、体重和性别信息。任务是:</p><ol class=""><li id="4170" class="mw mx it lc b ld mr lg ms lj my ln mz lr na lv nu nc nd ne bi translated">找到他们的身体质量指数(身体质量指数)</li><li id="280a" class="mw mx it lc b ld nf lg ng lj nh ln ni lr nj lv nu nc nd ne bi translated">将<code class="fe lw lx ly lz b">gender</code>列中的小写字符串转换为大写</li></ol><p id="55c7" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated">我们创建以下函数来计算身体质量指数，它是以千克为单位的重量除以以米为单位的高度的平方。</p><pre class="mb mc md me gt nk lz nl nm aw nn bi"><span id="3dec" class="no kj it lz b gy np nq l nr ns">def calculate_bmi(df):<br/>  <br/>  df = df.withColumn('bmi', f.round(f.col('weight')/(f.col('height')/100)**2,2))<br/>  <br/>  return df</span></pre><h1 id="6b8d" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">改变</h1><p id="b572" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated"><code class="fe lw lx ly lz b">pyspark.sql.DataFrame.transform</code>是链接自定义转换的简明语法。</p><p id="d93a" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated"><strong class="lc iu">参数</strong></p><ul class=""><li id="4b7e" class="mw mx it lc b ld mr lg ms lj my ln mz lr na lv nb nc nd ne bi translated"><code class="fe lw lx ly lz b">func</code>:获取并返回数据帧的函数</li></ul><p id="2731" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated">以下是如何在数据帧上应用<code class="fe lw lx ly lz b">calculate_bmi</code>功能。</p><pre class="mb mc md me gt nk lz nl nm aw nn bi"><span id="673e" class="no kj it lz b gy np nq l nr ns">df.transform(calculate_bmi).show()</span><span id="e172" class="no kj it lz b gy nt nq l nr ns">+-----+---+------+------+-----+<br/>| name|age|height|weight|  bmi|<br/>+-----+---+------+------+-----+<br/>| John| 30|   180|    90|27.78|<br/>|Karen| 27|   173|    60|20.05|<br/>+-----+---+------+------+-----+</span></pre><p id="3054" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated">我们可以将多个转换和其他DataFrame方法链接在一起。在下面的例子中，我们计算了身体质量指数并将<code class="fe lw lx ly lz b">gender</code>列大写。</p><pre class="mb mc md me gt nk lz nl nm aw nn bi"><span id="bbd5" class="no kj it lz b gy np nq l nr ns">(df<br/> .transform(calculate_bmi)<br/> .withColumn('gender', f.upper('gender'))<br/> .show())</span><span id="bacf" class="no kj it lz b gy nt nq l nr ns">+-----+---+------+------+------+-----+<br/>| name|age|height|weight|gender|  bmi|<br/>+-----+---+------+------+------+-----+<br/>| John| 30|   180|    90|     M|27.78|<br/>|Karen| 27|   173|    60|     F|20.05|<br/>+-----+---+------+------+------+-----+</span></pre><p id="bda1" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated">与Pandas的<code class="fe lw lx ly lz b">.pipe()</code>不同，Pyspark的<code class="fe lw lx ly lz b">.transform()</code>不向输入函数(<code class="fe lw lx ly lz b">func</code>)传递参数。克服这一限制的一种方法是使用python的部分函数。</p><p id="51c0" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated">让我们扩展一下身体质量指数的例子。我们发现体重和身高机器没有很好地校准，因此我们必须对测量的身高和体重进行补偿，以获得正确的身体质量指数。下面是实现这一点的函数。</p><pre class="mb mc md me gt nk lz nl nm aw nn bi"><span id="4049" class="no kj it lz b gy np nq l nr ns">def offset(df, height_offset, weight_offset):<br/>  <br/>  df = (df<br/>        .withColumn('height', f.col('height') + height_offset)<br/>        .withColumn('weight', f.col('weight') + weight_offset)<br/>       )<br/>  <br/>  return df</span></pre><p id="a5b8" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated">为了使用<code class="fe lw lx ly lz b">.transform()</code>在数据帧上应用偏移函数，我们使用python的<code class="fe lw lx ly lz b">functools.partial</code>方法来创建分部函数，该函数允许我们将参数传递给<code class="fe lw lx ly lz b">offset</code>函数。</p><pre class="mb mc md me gt nk lz nl nm aw nn bi"><span id="0e53" class="no kj it lz b gy np nq l nr ns">from functools import partial</span><span id="099c" class="no kj it lz b gy nt nq l nr ns">(df<br/> .transform(partial(offset, height_offset = 2, weight_offset = -0.5))<br/> .transform(calculate_bmi)<br/> .withColumn('gender', f.upper('gender'))<br/> .show())</span><span id="d337" class="no kj it lz b gy nt nq l nr ns">+-----+---+------+------+------+-----+<br/>| name|age|height|weight|gender|  bmi|<br/>+-----+---+------+------+------+-----+<br/>| John| 30|   182|  89.5|     M|27.02|<br/>|Karen| 27|   175|  59.5|     F|19.43|<br/>+-----+---+------+------+------+-----+</span></pre><p id="84f5" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated">或者，我们可以创建一个相当于Pandas <code class="fe lw lx ly lz b">.pipe()</code>的pyspark，它接受位置和关键字参数。</p><h1 id="e2c2" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">自定义Pyspark管道方法</h1><p id="d162" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">我们创建了一个<code class="fe lw lx ly lz b">.pipe()</code>函数，并执行了一个monkey补丁，将它作为<code class="fe lw lx ly lz b">pyspark.sql.DataFrame</code>类的一个方法包含进来。</p><pre class="mb mc md me gt nk lz nl nm aw nn bi"><span id="53d3" class="no kj it lz b gy np nq l nr ns">from pyspark.sql import DataFrame</span><span id="b133" class="no kj it lz b gy nt nq l nr ns">def pipe(self, func, *args, **kwargs):<br/>    return func(self, *args, **kwargs)</span><span id="ac84" class="no kj it lz b gy nt nq l nr ns">DataFrame.pipe = pipe</span></pre><p id="a032" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated"><strong class="lc iu">参数</strong></p><ul class=""><li id="3e0b" class="mw mx it lc b ld mr lg ms lj my ln mz lr na lv nb nc nd ne bi translated"><code class="fe lw lx ly lz b">func</code>:数据框上应用的输入功能</li><li id="e008" class="mw mx it lc b ld nf lg ng lj nh ln ni lr nj lv nb nc nd ne bi translated"><code class="fe lw lx ly lz b">args</code>:位置参数</li><li id="cf1f" class="mw mx it lc b ld nf lg ng lj nh ln ni lr nj lv nb nc nd ne bi translated"><code class="fe lw lx ly lz b">kwargs</code>:关键字参数</li></ul><p id="e309" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated">让我们来看一些例子。</p><p id="9752" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated"><strong class="lc iu">无参数函数</strong></p><p id="653a" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated">与<code class="fe lw lx ly lz b">.transform()</code>类似，<code class="fe lw lx ly lz b">.pipe()</code>可以接受没有任何参数的输入函数。</p><pre class="mb mc md me gt nk lz nl nm aw nn bi"><span id="2d25" class="no kj it lz b gy np nq l nr ns">df.pipe(calculate_bmi).show()</span><span id="c488" class="no kj it lz b gy nt nq l nr ns">+-----+---+------+------+------+-----+<br/>| name|age|height|weight|gender|  bmi|<br/>+-----+---+------+------+------+-----+<br/>| John| 30|   180|    90|     m|27.78|<br/>|Karen| 27|   173|    60|     f|20.05|<br/>+-----+---+------+------+------+-----+</span></pre><p id="9366" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated"><strong class="lc iu">λ函数</strong></p><p id="1c64" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated"><code class="fe lw lx ly lz b">.pipe()</code>也可以接受lambda函数。</p><pre class="mb mc md me gt nk lz nl nm aw nn bi"><span id="ea5d" class="no kj it lz b gy np nq l nr ns">df.pipe(lambda df: df.withColumn('bmi', f.round(f.col('weight')/(f.col('height')/100)**2,2))).show()</span><span id="87fc" class="no kj it lz b gy nt nq l nr ns">+-----+---+------+------+------+-----+<br/>| name|age|height|weight|gender|  bmi|<br/>+-----+---+------+------+------+-----+<br/>| John| 30|   180|    90|     m|27.78|<br/>|Karen| 27|   173|    60|     f|20.05|<br/>+-----+---+------+------+------+-----+</span></pre><p id="a28b" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated"><strong class="lc iu">带关键字参数的函数</strong></p><p id="2ca1" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated">由<code class="fe lw lx ly lz b">.pipe()</code>接收的关键字参数将被传递给<code class="fe lw lx ly lz b">offset</code>函数。我们还可以将多个<code class="fe lw lx ly lz b">.pipe()</code>功能链接在一起。</p><pre class="mb mc md me gt nk lz nl nm aw nn bi"><span id="5d92" class="no kj it lz b gy np nq l nr ns">(df<br/> .pipe(offset, height_offset = 2, weight_offset = -0.5)<br/> .pipe(calculate_bmi)<br/> .withColumn('gender', f.upper('gender'))<br/> .show())</span><span id="7355" class="no kj it lz b gy nt nq l nr ns">+-----+---+------+------+------+-----+<br/>| name|age|height|weight|gender|  bmi|<br/>+-----+---+------+------+------+-----+<br/>| John| 30|   182|  89.5|     M|27.02|<br/>|Karen| 27|   175|  59.5|     F|19.43|<br/>+-----+---+------+------+------+-----+</span></pre><p id="e2be" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated"><strong class="lc iu">带有位置参数的函数</strong></p><p id="8510" class="pw-post-body-paragraph la lb it lc b ld mr ju lf lg ms jx li lj mt ll lm ln mu lp lq lr mv lt lu lv im bi translated"><code class="fe lw lx ly lz b">.pipe()</code>也适用于位置参数。</p><pre class="mb mc md me gt nk lz nl nm aw nn bi"><span id="ff32" class="no kj it lz b gy np nq l nr ns">(df<br/> .pipe(offset, 2, -0.5)<br/> .pipe(calculate_bmi)<br/> .withColumn('gender', f.upper('gender'))<br/> .show())</span><span id="5468" class="no kj it lz b gy nt nq l nr ns">+-----+---+------+------+------+-----+<br/>| name|age|height|weight|gender|  bmi|<br/>+-----+---+------+------+------+-----+<br/>| John| 30|   182|  89.5|     m|27.02|<br/>|Karen| 27|   175|  59.5|     f|19.43|<br/>+-----+---+------+------+------+-----+</span></pre><h1 id="7977" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">摘要</h1><p id="26df" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在本文中，我们给出了链接函数的动机。在Pyspark中将定制函数链接在一起的本地方法是使用<code class="fe lw lx ly lz b">pyspark.sql.DataFrame.transform</code>方法。这种方法的缺点是不允许向输入函数传递参数。为了克服这个限制，我们演示了如何将<code class="fe lw lx ly lz b">.transform()</code>与<code class="fe lw lx ly lz b">functools.partial</code>结合使用，或者在Pyspark中创建一个自定义的<code class="fe lw lx ly lz b">.pipe()</code>方法。</p></div></div>    
</body>
</html>