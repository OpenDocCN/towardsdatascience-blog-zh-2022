<html>
<head>
<title>Pre-calculated aggregations for Power BI — Why should you avoid them</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Power BI的预计算聚合—为什么要避免它们</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/pre-calculated-aggregations-for-power-bi-why-should-you-avoid-them-371abdec5bb4#2022-04-19">https://towardsdatascience.com/pre-calculated-aggregations-for-power-bi-why-should-you-avoid-them-371abdec5bb4#2022-04-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2e36" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">我的一个客户总是希望在他的Excel文件中预先计算聚合，然后在Power BI中使用。以下是我们应该避免这样做的原因。</h2></div><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/f7cf088bc361e812c9d6dff76743e802.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*82WB5c1l2jVIqd51"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">由<a class="ae kz" href="https://unsplash.com/@kaleidico?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">万花筒</a>在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="b44b" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">介绍</h1><p id="d3f3" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">不久前，我开始为一个新客户工作。</p><p id="c0ae" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我的任务之一是向他们咨询如何使用Power BI和解决挑战。</p><p id="5b1f" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">他们大部分时间从应用程序或其他数据库导出Excel和CSV数据。我的客户决定获取聚合数据，以避免大型数据集并简化他的DAX计算。</p><p id="3165" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">事实证明，这个决定并不那么好。</p><h1 id="6ae2" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">什么是预聚合</h1><p id="5fbc" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">我的客户开始从他的源系统提取数据到Excel文件中。</p><p id="6fad" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">接下来，他开始使用Excel宏将数据预聚合为YTD和YE值。或者，他从一开始就以汇总的方式导出数据。</p><p id="f01f" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">之后，他将汇总的数据导入Power BI，并开始设计报告。</p><p id="229a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">但是，我不得不说，他的大多数数据都是快照数据，他只需选择一个快照就可以看到所需的结果。</p><p id="fa02" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">另一种预汇总数据的方法是消除数据中的细节。</p><p id="99d6" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">例如，查看Contoso数据集的以下数据模型:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi mt"><img src="../Images/ca50d39ee4b92106b88fa3e63f96cdfc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_6L92FXKkewse8n5R4GbDQ.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图Contoso数据集的互联网销售部分(图片由作者提供)</p></figure><p id="db72" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">现在，假设我对每个客户的销售细节不感兴趣，而只对每个地理区域感兴趣。</p><p id="49d4" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我可以从客户表中删除客户属性，只保留地理信息，如国家、地区、城市、邮政编码等。</p><p id="296a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">通过删除客户属性，我可以将在线销售表中的数据聚合到邮政编码级别，并减少数据量。</p><p id="a7e3" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">结果，我丢失了所有客户的详细信息。</p><h1 id="9132" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">预聚集的缺点</h1><p id="5df5" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">在大多数情况下，我的客户的方法满足了他的要求。</p><p id="bead" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">但是，一旦他想做一些时间智能或其他复杂的计算，他就必须在Excel文件中添加越来越多的复杂性来满足需求。</p><p id="734d" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">当您预汇总数据时，您必须考虑所有需要的维度。维度越多，可以聚合的数据就越少。</p><p id="5613" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">此外，当您必须添加一个维度或增加粒度(添加更多细节)时，您必须重新开始并重新计算所有的聚合。</p><h1 id="8cb9" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">预聚合的优势</h1><p id="3cf7" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">预聚合数据的主要好处是减少数据量。我在上面的例子中通过消除客户的详细属性展示了这种效果。</p><p id="805a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">但这仅在原始数据包含数千万或数亿行时才有意义。</p><p id="f4db" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">预聚合几千行数据是没有意义的，因为power BI认为即使是几十万行也是小数据。</p><p id="378a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我会考虑Power BI中的聚合表特性，而不是手动预聚合我的数据。</p><p id="72d5" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在我看来，手动预聚合数据并没有真正的好处。</p><h1 id="6551" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">DAX指标的复杂性</h1><p id="2ff1" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">我的客户抱怨在处理原始数据而不是预汇总数据时测量的复杂性。</p><p id="30b1" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">然后，发生了一件事。</p><p id="b308" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我们开始处理一个新的报告，它有许多表格，但是仍然有少量的数据(几千行)。</p><p id="fd77" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">他开始在Excel中创建预先聚合和预先计算的表格，以保持DAX指标的简单性。</p><p id="e69c" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">他创建了具有月度年末(YE)和年初至今(YTD)值的列，并要求我开发需求所要求的所有DAX度量。</p><p id="9e36" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">因此，我不能用一个简单的SUM()函数来创建度量。我必须开发股票度量来获得数据的最近一年或年初至今的值。</p><p id="6e3b" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">您可以阅读以下文章，了解使用股票(半累加性)度量时会发生什么:</p><div class="mu mv gp gr mw mx"><a rel="noopener follow" target="_blank" href="/refinement-of-semi-additive-measures-in-dax-4e148fa83f56"><div class="my ab fo"><div class="mz ab na cl cj nb"><h2 class="bd iu gy z fp nc fr fs nd fu fw is bi translated">DAX中半可加测度的精化</h2><div class="ne l"><h3 class="bd b gy z fp nc fr fs nd fu fw dk translated">在之前的故事中，我解释了一些关于半加性测度的细节。这里有更多关于这个话题的提示</h3></div><div class="nf l"><p class="bd b dl z fp nc fr fs nd fu fw dk translated">towardsdatascience.com</p></div></div><div class="ng l"><div class="nh l ni nj nk ng nl kt mx"/></div></div></a></div><p id="2599" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">现在，查看以下度量，从预聚合数据中获取最新的YTD行:</p><pre class="kk kl km kn gt nm nn no np aw nq bi"><span id="75d1" class="nr lb it nn b gy ns nt l nu nv">Value =<br/> VAR LastDateOfData = LASTNONBLANK (SUM(YTD_ValueColumn)<br/> ,’SourceTable’[DateColumn]</span><span id="69f5" class="nr lb it nn b gy nw nt l nu nv">)</span><span id="0bb0" class="nr lb it nn b gy nw nt l nu nv">RETURN<br/> CALCULATE (SUM(YTD_ValueColumn)<br/> ,LastDateOfData<br/> )</span></pre><p id="1ccd" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">然后，看看这个衡量标准，如果我有访问原始数据的权限，我会使用它:</p><pre class="kk kl km kn gt nm nn no np aw nq bi"><span id="2f94" class="nr lb it nn b gy ns nt l nu nv">Value = TOTALYTD(SUM(ValueColumn)<br/> ,’Date’[Date])</span></pre><p id="bff1" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">如您所见，从原始数据计算YTD比从数据中检索最后一个预聚合值要容易得多。</p><p id="9f56" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我说服了我的客户不要预先汇总数据，用这个论点来处理原始数据。</p><h1 id="b7b6" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">日期的问题</h1><p id="714c" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">使用预聚合数据时还有另一个问题。</p><p id="3858" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在我的例子中，我的客户通过按天消除粒度来计算聚合。</p><p id="47a5" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">他总是将数据汇总到月或年级别。</p><p id="75eb" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">平心而论，他的一些数据是预测数据，不是日常才有的。</p><p id="e6d9" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我们必须使用时间智能和与时间相关的报告，并且我们必须确保所有行都指向每月相同的日期。例如，我们将所有数据设置为每月的第一天。</p><p id="0e48" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">幸运的是，当您转换一个月以来的列时，Power BI会自动完成这项工作。</p><p id="5a57" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">例如:</p><p id="3984" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">数据看起来是这样的:2022–04</p><p id="1a66" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">当您将这样的列转换为日期数据类型时，结果是:2022–04–01</p><p id="4dad" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">听起来很容易。</p><p id="a3ef" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">但是，当我的客户准备一些数据指向这个月的最后一天时，事情变得复杂了。</p><p id="59fd" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我不得不返回到Power Query，将这些列上的日期更改为所有表的同一天。</p><p id="3d8e" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">同样，当我们使用原始数据时，这种复杂性是不必要的。</p><h1 id="2633" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">结论</h1><p id="09d3" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">如果您很难将原始数据存储在Power BI或其他具有内存数据存储的报告工具中，那么预聚合数据可能是一个好主意。</p><p id="48f9" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在这种情况下，预聚合数据可能是提高报表性能或能够将数据存储在数据模型中的有效方法。</p><p id="289e" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在任何情况下，我都强烈建议考虑日期因素，将数据保存在一天的级别上，或者在每个月的同一天汇总所有数据。</p><p id="09dd" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">这种方法将允许您编写更简单的时间智能度量。</p><p id="c3f2" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">如果你对数据量没有问题，我建议避免预先汇总你的数据。</p><p id="47ed" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在处理原始数据时，您将获得更直接、更简单的测量方法。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nx"><img src="../Images/dbeff75c231f123c2c5c221c219021cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BQnziTQcNvVJqJMc"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">埃利斯·陈嘉炜在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="fe0b" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">参考</h1><p id="ec06" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">我使用Contoso样本数据集，就像我以前的文章一样。你可以从微软<a class="ae kz" href="https://www.microsoft.com/en-us/download/details.aspx?id=18279" rel="noopener ugc nofollow" target="_blank">这里</a>免费下载ContosoRetailDW数据集。</p><p id="1908" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">Contoso数据可以在MIT许可下自由使用，如这里的<a class="ae kz" href="https://github.com/microsoft/Power-BI-Embedded-Contoso-Sales-Demo" rel="noopener ugc nofollow" target="_blank">所述</a>。</p><div class="mu mv gp gr mw mx"><a href="https://medium.com/@salvatorecagliari/membership" rel="noopener follow" target="_blank"><div class="my ab fo"><div class="mz ab na cl cj nb"><h2 class="bd iu gy z fp nc fr fs nd fu fw is bi translated">通过我的推荐链接加入Medium-Salvatore Cagliari</h2><div class="ne l"><h3 class="bd b gy z fp nc fr fs nd fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="nf l"><p class="bd b dl z fp nc fr fs nd fu fw dk translated">medium.com</p></div></div><div class="ng l"><div class="ny l ni nj nk ng nl kt mx"/></div></div></a></div></div></div>    
</body>
</html>