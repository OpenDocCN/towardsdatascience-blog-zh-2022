<html>
<head>
<title>Elasticsearch Beats Workshop #1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Elasticsearch Beats 研讨会#1</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/elasticsearch-beats-workshop-1-c73189069793#2022-03-06">https://towardsdatascience.com/elasticsearch-beats-workshop-1-c73189069793#2022-03-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="8a0a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">安全 Metricbeat</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/30b816e7ea67daf0a6605e9e32b29a6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nk7kTm8zVhmVs3JO"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">托姆·米尔科维奇在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="7688" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">欢迎来到 Beats 工作坊的第一部分。像往常一样，为了使每篇文章尽可能紧凑，我将把查询简化为片段。如果你想看到完整的代码，配置，或查询，请咨询我的<a class="ae kv" href="https://github.com/PascalThalmann/ElasticBeatWorkshop/tree/master/1_secured_metricbeat" rel="noopener ugc nofollow" target="_blank"> GitHub 页面。如果谷歌把你带到这里，你可能想检查一下</a><a class="ae kv" href="https://medium.com/@pascalth/list/elasticsearch-beats-workshop-fbe5332d03e1" rel="noopener">系列</a>的其他部分。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="0c73" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">今天，我们将为 Metricbeat 配置安全通信。使用 Elasticsearch Stack 8，默认情况下启用 SSL 通信。官方的<a class="ae kv" href="https://www.elastic.co/guide/en/beats/metricbeat/current/index.html" rel="noopener ugc nofollow" target="_blank">文档</a>可能会让人不知所措，你可能很难找到具体的参数。除了 SSL 之外，我们还将了解需要为 Metricbeat 授予的特定权限。最后但同样重要的是，应该如何安全地调用这个用户的凭证。一如既往:让我们直接开始吧！</p><h1 id="137d" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">本次研讨会的系统拓扑</h1><p id="4600" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">Elasticsearch 和 Kibana 的 YAML 文件全文在我的 GitHub 页面上。设置非常简单:Elasticsearch 节点作为 srvelk8 暴露给网络。本次研讨会的 Elasticsearch 版本为 8.0.1。Elasticsearch、Kibana 和 Metricbeat 都运行在同一个 VM 上。下面是我的/etc/hosts 的样子:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="b3c9" class="nb ma iq mx b gy nc nd l ne nf">192.168.1.68   srvelk8      srvelk8.local.ch</span></pre><h1 id="5c23" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">根 CA 指纹</h1><p id="c73e" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">为了安全通信，您需要根证书或根 CA 十六进制编码指纹。我将向您展示这两个选项，现在，我们来看看如何获取指纹。你的 kibana.yml 里可能有指纹:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="7e5c" class="nb ma iq mx b gy nc nd l ne nf">grep fingerprint /etc/kibana/kibana.yml</span><span id="6021" class="nb ma iq mx b gy ng nd l ne nf">ca_trusted_fingerprint: a2929842b8920e5c0ebd91ea157c159f16b62df7e3b6998de93ad56ff2693b59}]</span></pre><p id="c2fa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您可以访问 http_ca.crt，也可以使用 OpenSSL 提取指纹:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="81d6" class="nb ma iq mx b gy nc nd l ne nf">openssl x509 -fingerprint -sha256 \ <br/>  -in /etc/elasticsearch/certs/http_ca.crt| \<br/>  grep Fingerprint|cut -d  '=' -f2| tr -d ':'|tr A-Z a-z<br/>  <br/>a2929842b8920e5c0ebd91ea157c159f16b62df7e3b6998de93ad56ff2693b59</span></pre><h1 id="1503" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">装置</h1><p id="8921" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">安装 Metricbeat 与:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="7977" class="nb ma iq mx b gy nc nd l ne nf">curl -L -O <a class="ae kv" href="https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-8.0.1-amd64.deb" rel="noopener ugc nofollow" target="_blank">https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-8.0.1-amd64.deb</a><br/>sudo dpkg -i metricbeat-8.0.1-amd64.deb<br/>apt-mark hold metricbeat</span></pre><p id="d80f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果想在 Ubuntu 使用 APT，请看一下<a class="ae kv" href="https://www.elastic.co/guide/en/beats/metricbeat/8.0/setup-repositories.html" rel="noopener ugc nofollow" target="_blank">官方文档</a>。</p><h1 id="5128" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">创建必要的角色和用户</h1><p id="0e75" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">首先，我们需要一个角色在 Kibana/Elasticsearch 中设置 Metricbeat。初始设置后，您将删除该角色，因为它不再是必需的。现在创建角色“metricbeat_setup_role ”,并授予这些权限:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nh"><img src="../Images/be0c244c00273f2f8cc5b90ec0991959.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*FtBX66UbdqTACZ8J.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="f21a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在为 Metricbeat 创建用户。我现在使用 metricbeat_internal:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/eee0b1efc58b76d712142a1100ae4029.png" data-original-src="https://miro.medium.com/v2/resize:fit:1344/format:webp/0*RL_LBaeT7SdXT2LY.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><h1 id="a3a7" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">创建密钥库</h1><p id="8203" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">因为您不想将用户名/密码存储在 yml 文件中，所以我们需要一个密钥库来加密凭证并将它们存储在一个安全的地方:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="e67a" class="nb ma iq mx b gy nc nd l ne nf">metricbeat keystore create<br/>metricbeat keystore add MB_USER<br/>metricbeat keystore add MB_PW</span></pre><p id="5099" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们现在可以在 YAML 文件中将用户名和密码定义为“${MB_USER}”和“${MB_PW}”。keystone 本身存储在与“path.data”中定义的文件夹相同的文件夹中，在 Ubuntu 中默认为/var/lib/metricbeat。使用运行 metricbeat 的同一用户运行 keystone 命令。</p><p id="c6ca" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">重要事项:定义至少包含一个字母的密码。否则，密码将被存储为一个 int，而不是一个字符串，这将导致以后的问题。</p><h1 id="3bd7" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">配置</h1><p id="852c" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">您现在可以启用您需要的所有模块。因为我使用 Metricbeat 进行堆栈监控，所以我启用了 Elasticsearch、Kibana 和 beat 模块:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="a2ad" class="nb ma iq mx b gy nc nd l ne nf">metricbeat modules enable elasticsearch-xpack<br/>metricbeat modules enable kibana-xpack<br/>metricbeat modules enable beat-xpack</span></pre><h1 id="aa89" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">metricbeat.yml</h1><p id="4b63" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">例如，Kibana 设置的部分:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="06c4" class="nb ma iq mx b gy nc nd l ne nf">setup.kibana:<br/>  host: "<a class="ae kv" href="http://srvelk8.local.ch:5601" rel="noopener ugc nofollow" target="_blank">http://srvelk8.local.ch:5601</a>"<br/>  username: "${MB_USER}"<br/>  password: "${MB_PW}"<br/>  ssl:<br/>    #certificate_authorities: /etc/elasticsearch/certs/http_ca.crt<br/>    enabled: true<br/>    ca_trusted_fingerprint: "a2929842b8920e5c0ebd91ea157c159f16b62df7e3b6998de93ad56ff2693b59"</span></pre><p id="e7b8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如您所见，我禁用了 certificate_authorities。因为我使用指纹，所以不需要 certificate _ authorities。我们还避免将用户名和密码定义为明文。</p><h1 id="6d94" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">模块配置</h1><p id="2da6" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">模块也是如此。以下是 elasticsearch-xpack.yml 的一个例子:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="1e6e" class="nb ma iq mx b gy nc nd l ne nf">- module: elasticsearch<br/>  xpack.enabled: true<br/>  period: 10s<br/>  hosts: ["<a class="ae kv" href="https://192.168.1.68:9200" rel="noopener ugc nofollow" target="_blank">https://192.168.1.68:9200</a>"]<br/>  protocol: "https"<br/>  username: "${MB_USER}"<br/>  password: "${MB_PW}"<br/>  #api_key: "TxDLW38BJmYfkUzINFEF:0foLANnlS-qMNgx_jEXhGw"<br/>  ssl:<br/>    #certificate_authorities: /etc/elasticsearch/certs/http_ca.crt<br/>    enabled: true<br/>    ca_trusted_fingerprint: "a2929842b8920e5c0ebd91ea157c159f16b62df7e3b6998de93ad56ff2693b59"</span></pre><p id="5fbf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由于每个模块与其他模块略有不同，请查看 GitHub 页面上的示例。</p><h1 id="5b97" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">设置 Metricbeat</h1><p id="1cb0" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">现在运行“metricbeat setup -e”。过一会儿，您应该会看到这些消息:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="e8b9" class="nb ma iq mx b gy nc nd l ne nf">metricbeat setup -e</span><span id="9958" class="nb ma iq mx b gy ng nd l ne nf">Index setup finished.<br/>Loading dashboards (Kibana must be running and reachable)<br/>Loaded dashboards</span></pre><h1 id="5236" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">创建监控角色</h1><p id="07bb" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">现在为 Metricbeat 创建监视角色。添加角色“metricbeat_monitoring”后，您可以删除角色“metricbeat_setup_role”:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/827fbe7bb507efb3abe6e9bcaef82ddb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1F5J3nlngd8hLduu.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="cd13" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">用此角色更新用户。</p><h1 id="02d9" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">启用并运行 metricbeat</h1><p id="743c" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">好了，就这样。您现在可以运行 Metricbeat:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="5c3c" class="nb ma iq mx b gy nc nd l ne nf">systemctl enable metricbeat<br/>systemctl start metricbeat</span></pre><h1 id="3ee3" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">结论</h1><p id="fd5e" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">如果你成功了:祝贺你！现在，您应该能够通过安全通信运行 Metricbeat 了。如果您遗漏了某个特定的配置，那么<a class="ae kv" href="https://www.elastic.co/guide/en/beats/metricbeat/8.0/metricbeat-reference-yml.html" rel="noopener ugc nofollow" target="_blank"> metricbeat reference </a>有更多的示例，请查看。</p><p id="4a55" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您有任何问题，请在<a class="ae kv" href="https://www.linkedin.com/in/pascal-thalmann/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上留言、联系或关注我</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="9007" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="nk">原发布于</em><a class="ae kv" href="https://cdax.ch/2022/03/05/elasticsearch-beat-workshop-1-secured-metricbeat/" rel="noopener ugc nofollow" target="_blank"><em class="nk">https://cdax . ch</em></a><em class="nk">。</em></p></div></div>    
</body>
</html>