<html>
<head>
<title>How to Create a dbt Package</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何创建dbt包</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-create-a-dbt-package-ca795d1dbe12#2022-11-04">https://towardsdatascience.com/how-to-create-a-dbt-package-ca795d1dbe12#2022-11-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/9adc633430a26bd80b13777ec28a7943.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bhw5IjQzSpIJqeFn"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://unsplash.com/@benchaccounting?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">钳工</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><p id="c5fd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我过去常常复制和粘贴几乎相同的SQL查询，认为这是使用SQL的唯一方法。</p><p id="775c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">幸运的是，我接受了一个分析工程师的新职位，并发现了<strong class="ki iu"> dbt </strong>，这是一个用动态查询和模型依赖来构建数据模型的神奇工具。</p><div class="le lf gp gr lg lh"><a rel="noopener follow" target="_blank" href="/what-is-dbt-a0d91109f7d0"><div class="li ab fo"><div class="lj ab lk cl cj ll"><h2 class="bd iu gy z fp lm fr fs ln fu fw is bi translated">dbt是什么？</h2><div class="lo l"><h3 class="bd b gy z fp lm fr fs ln fu fw dk translated">您的分析工程指南和创建它的工具</h3></div><div class="lp l"><p class="bd b dl z fp lm fr fs ln fu fw dk translated">towardsdatascience.com</p></div></div><div class="lq l"><div class="lr l ls lt lu lq lv jz lh"/></div></div></a></div><p id="b1f9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有了dbt，我们可以使用宏，而不用两次重写相同的SQL。我很快意识到，即使我们试图在项目中使用可重用的代码，我们也经常在不同的项目中使用相同的代码。</p><p id="099e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了避免跨项目的代码冗余，我创建了我的第一个dbt包。这个包现在由共享一些模型和宏的几个项目导入。</p><p id="b311" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">以下是如何快速创建第一个dbt包并跨项目重用代码的方法！</p><h1 id="6506" class="lw lx it bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">创建项目</h1><p id="891d" class="pw-post-body-paragraph kg kh it ki b kj mu kl km kn mv kp kq kr mw kt ku kv mx kx ky kz my lb lc ld im bi translated">dbt包只不过是一个常规的dbt项目。让我们通过调用<strong class="ki iu"> dbt init </strong>来创建一个包。选择您想要的名称和配置，这并不重要，因为我们不会单独使用这个项目。</p><p id="b6f6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将把这个项目称为<strong class="ki iu">包</strong>，而这个包被导入的项目称为<strong class="ki iu">主项目</strong>。</p><h1 id="e2e0" class="lw lx it bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">导入模型</h1><p id="98eb" class="pw-post-body-paragraph kg kh it ki b kj mu kl km kn mv kp kq kr mw kt ku kv mx kx ky kz my lb lc ld im bi translated">现在，在<strong class="ki iu"> models/example </strong>文件夹中，让我们使用以下查询创建一个名为<strong class="ki iu"> hello_world.sql，</strong>的文件:</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="3624" class="ni lx it ne b gy nj nk l nl nm">{{</span><span id="62b6" class="ni lx it ne b gy nn nk l nl nm">config(<br/>materialized = 'table'<br/>)</span><span id="35a7" class="ni lx it ne b gy nn nk l nl nm">}}</span><span id="37e5" class="ni lx it ne b gy nn nk l nl nm">SELECT "Hello World!" AS field</span></pre><p id="fe74" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">并将绝对路径复制到dbt项目。</p><p id="486f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">打开您的主项目，并编辑<strong class="ki iu"> packages.yml </strong>以添加以下行:</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="3bdd" class="ni lx it ne b gy nj nk l nl nm">- local: &lt;absolute_path&gt;</span></pre><p id="55ad" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后在您的终端中，运行:</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="507f" class="ni lx it ne b gy nj nk l nl nm">dbt deps<br/>dbt run -m example</span></pre><p id="c26b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">检查您的配置文件中指定的数据集。您现在应该会看到一个新的表格hello_world，如下所示:</p><figure class="mz na nb nc gt ju gh gi paragraph-image"><div class="gh gi no"><img src="../Images/010302ad81b18b8b93a106e5f50485e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:676/format:webp/1*YgzMOaKH5gYnh8glqEwXUA.png"/></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">作者截图</p></figure><h1 id="0272" class="lw lx it bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">定制您的模型</h1><h2 id="1cad" class="ni lx it bd ly np nq dn mc nr ns dp mg kr nt nu mk kv nv nw mo kz nx ny ms nz bi translated">项目变量</h2><p id="8ffb" class="pw-post-body-paragraph kg kh it ki b kj mu kl km kn mv kp kq kr mw kt ku kv mx kx ky kz my lb lc ld im bi translated">这很好，但是您可能不希望在所有项目中使用完全相同的查询。好消息是，你可以使用项目变量来定制你的模型。</p><p id="0bdd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们编辑我们的查询:</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="1ffc" class="ni lx it ne b gy nj nk l nl nm">{{</span><span id="8dbc" class="ni lx it ne b gy nn nk l nl nm">config(</span><span id="5626" class="ni lx it ne b gy nn nk l nl nm">materialized = 'table'</span><span id="3d24" class="ni lx it ne b gy nn nk l nl nm">)</span><span id="a1fe" class="ni lx it ne b gy nn nk l nl nm">}}</span><span id="e350" class="ni lx it ne b gy nn nk l nl nm">SELECT "Hello {{ var('first_name') }}!" AS field</span></pre><p id="5c58" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我们主项目的<strong class="ki iu"> dbt_project.yml </strong>文件中，我们可以像这样添加一个项目变量:</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="a596" class="ni lx it ne b gy nj nk l nl nm">vars:</span><span id="7145" class="ni lx it ne b gy nn nk l nl nm"> first_name: Marie</span></pre><figure class="mz na nb nc gt ju gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/d96dd11de68eb6ac1111545f71850477.png" data-original-src="https://miro.medium.com/v2/resize:fit:666/format:webp/1*DcAzxlziJgyuTvI_QYuwGw.png"/></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">作者截图</p></figure><p id="d832" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后一旦你运行<strong class="ki iu"> dbt run -m example，</strong>你的查询将使用为该变量定义的值运行！</p><h2 id="932a" class="ni lx it bd ly np nq dn mc nr ns dp mg kr nt nu mk kv nv nw mo kz nx ny ms nz bi translated"><strong class="ak">源文件</strong></h2><p id="5ef3" class="pw-post-body-paragraph kg kh it ki b kj mu kl km kn mv kp kq kr mw kt ku kv mx kx ky kz my lb lc ld im bi translated">这只是一个没有FROM子句的简单查询；在实际项目中，您还会希望使用<a class="ae kf" href="https://docs.getdbt.com/docs/build/sources" rel="noopener ugc nofollow" target="_blank">源文件</a>来查询不同的表。</p><p id="56e2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们创建一个使用源表的模型<strong class="ki iu"> hello_world_2 </strong>。</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="9c04" class="ni lx it ne b gy nj nk l nl nm">{{</span><span id="e71f" class="ni lx it ne b gy nn nk l nl nm">config(</span><span id="2dac" class="ni lx it ne b gy nn nk l nl nm">materialized = 'table'</span><span id="65b2" class="ni lx it ne b gy nn nk l nl nm">)</span><span id="85f6" class="ni lx it ne b gy nn nk l nl nm">}}</span><span id="b497" class="ni lx it ne b gy nn nk l nl nm">SELECT *, 2 AS version</span><span id="a41d" class="ni lx it ne b gy nn nk l nl nm">FROM {{ source("hello_source", "hello_world")}}</span></pre><p id="6740" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里，我们告诉dbt在source <strong class="ki iu"> hello_source </strong>中查找表<strong class="ki iu"> hello_world </strong>。</p><p id="927f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但是我们必须在项目中配置源代码。让我们在项目的sources文件夹中创建一个名为<strong class="ki iu"> hello.yml </strong>的配置文件。</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="b277" class="ni lx it ne b gy nj nk l nl nm">version: 2</span><span id="ea12" class="ni lx it ne b gy nn nk l nl nm">sources:</span><span id="eed5" class="ni lx it ne b gy nn nk l nl nm"> - name: hello_source</span><span id="3b25" class="ni lx it ne b gy nn nk l nl nm">project: "&lt;your_project&gt;"</span><span id="4c5b" class="ni lx it ne b gy nn nk l nl nm">  dataset: "&lt;your_dataset&gt;"</span><span id="6104" class="ni lx it ne b gy nn nk l nl nm">  tables:</span><span id="bb14" class="ni lx it ne b gy nn nk l nl nm">   - name: hello_world</span></pre><p id="0cc8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，当我们运行我们的模型时，我们看到的是:</p><figure class="mz na nb nc gt ju gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/ec1b34cb00056d7babf3d4b65103ca21.png" data-original-src="https://miro.medium.com/v2/resize:fit:906/format:webp/1*8XtihXfCkAzyYB5ynpwkxA.png"/></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">作者截图</p></figure><h2 id="445b" class="ni lx it bd ly np nq dn mc nr ns dp mg kr nt nu mk kv nv nw mo kz nx ny ms nz bi translated">导入宏</h2><p id="e86b" class="pw-post-body-paragraph kg kh it ki b kj mu kl km kn mv kp kq kr mw kt ku kv mx kx ky kz my lb lc ld im bi translated">导入模型有一些主要的缺点:</p><ul class=""><li id="3c00" class="oc od it ki b kj kk kn ko kr oe kv of kz og ld oh oi oj ok bi translated">如果我们需要模型中的变量，我们必须在项目文件中定义它们，这个文件很快就会被重载</li><li id="b615" class="oc od it ki b kj ol kn om kr on kv oo kz op ld oh oi oj ok bi translated">项目变量的类型不被保留，所以列表被转换成字符串</li><li id="2f8e" class="oc od it ki b kj ol kn om kr on kv oo kz op ld oh oi oj ok bi translated">从包中选择包括哪些型号并不容易</li></ul><p id="f89a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">宏解决了这些问题，尽管还需要做更多的配置。</p><p id="515d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我们包的<strong class="ki iu"> macros </strong>文件夹中，让我们创建一个名为<strong class="ki iu"> hello_everyone.sql </strong>的文件。</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="9015" class="ni lx it ne b gy nj nk l nl nm">{% macro hello_everyone(names) -%}</span><span id="40e8" class="ni lx it ne b gy nn nk l nl nm">{{</span><span id="5cb6" class="ni lx it ne b gy nn nk l nl nm">config(</span><span id="7bf7" class="ni lx it ne b gy nn nk l nl nm">materialized = 'table'</span><span id="ca0e" class="ni lx it ne b gy nn nk l nl nm">)</span><span id="9686" class="ni lx it ne b gy nn nk l nl nm">}}</span><span id="1064" class="ni lx it ne b gy nn nk l nl nm">SELECT</span><span id="88df" class="ni lx it ne b gy nn nk l nl nm">{% for name in names -%}</span><span id="8099" class="ni lx it ne b gy nn nk l nl nm">"Hello {{name}}" AS greeting_{{name}},</span><span id="2caf" class="ni lx it ne b gy nn nk l nl nm">{%- endfor %}</span><span id="d3b6" class="ni lx it ne b gy nn nk l nl nm">{%- endmacro %}</span></pre><p id="51e8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，让我们告诉主项目通过编辑项目文件来查找该宏:</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="2934" class="ni lx it ne b gy nj nk l nl nm">macro-paths: ["macros", "dbt_packages/&lt;package_name&gt;/macros"]</span></pre><p id="de7a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，让我们在<strong class="ki iu">模型/示例</strong>中创建一个模型文件来调用我们的宏:</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="0ac4" class="ni lx it ne b gy nj nk l nl nm">{% set names = ["nina", "chloe", "marie"] %}</span><span id="33dd" class="ni lx it ne b gy nn nk l nl nm">{{ hello_everyone(names) }}</span></pre><figure class="mz na nb nc gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oq"><img src="../Images/48ba37b80d4183e285739583699384d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pTNpD3Im1gPKPhDq61kmvQ.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">作者截图</p></figure><h2 id="4473" class="ni lx it bd ly np nq dn mc nr ns dp mg kr nt nu mk kv nv nw mo kz nx ny ms nz bi translated">发布您的包</h2><p id="75a2" class="pw-post-body-paragraph kg kh it ki b kj mu kl km kn mv kp kq kr mw kt ku kv mx kx ky kz my lb lc ld im bi translated">要发布您的包，您只需将它推送到git存储库，然后您将能够使用以下语法导入它:</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="1746" class="ni lx it ne b gy nj nk l nl nm">packages:<br/>  - git: "https://github.com/&lt;git_url&gt;" <br/>    revision: &lt;version_tag&gt;</span></pre></div><div class="ab cl or os hx ot" role="separator"><span class="ou bw bk ov ow ox"/><span class="ou bw bk ov ow ox"/><span class="ou bw bk ov ow"/></div><div class="im in io ip iq"><p id="e341" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">感谢您的阅读，希望这篇教程对您有所帮助！您可以在<a class="ae kf" href="https://docs.getdbt.com/docs/build/packages" rel="noopener ugc nofollow" target="_blank"> dbt文档</a>中找到关于该主题的更多信息。</p><p id="31bd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您喜欢这篇文章，请关注我，了解更多关于SQL、dbt和分析的内容！</p></div></div>    
</body>
</html>