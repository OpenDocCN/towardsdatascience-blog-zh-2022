<html>
<head>
<title>Apache Airflow for Data Science — How to Write Your First DAG in 10 Minutes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Apache Airflow for Data Science —如何在10分钟内编写您的第一篇DAG</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/apache-airflow-for-data-science-how-to-write-your-first-dag-in-10-minutes-9d6e884def72#2022-02-23">https://towardsdatascience.com/apache-airflow-for-data-science-how-to-write-your-first-dag-in-10-minutes-9d6e884def72#2022-02-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="722f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过编写完整的DAG，学习如何在Apache Airflow中使用Bash和Python操作符</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/99b78c660b9865256c85e5da55569cfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qDaVF3lABseLzzbP"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@rabihshasha?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Rabih Shasha </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="8318" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<a class="ae ky" href="https://betterdatascience.com/apache-airflow-write-your-first-dag/" rel="noopener ugc nofollow" target="_blank">上一篇文章</a>中，您已经看到了如何在新的Python虚拟环境中本地安装Apache Airflow，以及如何进行初始设置。今天，您将在Airflow中编写您的第一个数据管道(DAG ),这不会花费您超过10分钟的时间。</p><p id="b9c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">数据管道将从终端获取当前日期时间，对其进行处理，并将其保存到CSV文件中。非常简单，但是您将了解Airflow的Bash和Python操作符是如何工作的，以及如何使用Xcoms在任务之间进行通信，以及如何调度您的数据管道。让我们直入主题吧！</p><p id="b2f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不想看书？请观看我的视频:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="367f" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">你今天要做什么</h1><p id="422d" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">如标题所示，您将编写实现以下数据管道的第一个DAG:</p><ol class=""><li id="c82b" class="nb nc it lb b lc ld lf lg li nd lm ne lq nf lu ng nh ni nj bi translated">从终端获取当前日期时间信息</li><li id="cca3" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu ng nh ni nj bi translated">处理返回的日期时间字符串</li><li id="7c03" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu ng nh ni nj bi translated">将日期时间信息保存到CSV文件中</li></ol><p id="2e11" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以通过终端运行以下命令来获取当前的日期时间信息:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="b6c0" class="nu mf it nq b gy nv nw l nx ny">date</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/f62b667aa18d6d552c6b45c50b8b6285.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*POdditYLCCgzRvTxW_8Rfw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图1 —如何通过终端获取当前日期时间信息(图片由作者提供)</p></figure><p id="64af" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将从在<code class="fe oa ob oc nq b">~/airflow/dags</code>中创建一个新文件开始。在启动之前创建<code class="fe oa ob oc nq b">dags</code>文件夹，并在任何代码编辑器中打开它。我用的是PyCharm，但是你可以随意用别的。在<code class="fe oa ob oc nq b">dags</code>文件夹中创建一个名为<code class="fe oa ob oc nq b">first_dag.py</code>的新Python文件。</p><p id="d379" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你已经准备好开始了——让我们从样板文件开始。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="a98c" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">写下你的第一个气流DAG——样板文件</h1><p id="3bc3" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">将下面的代码复制到<code class="fe oa ob oc nq b">first_dag.py</code>:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="b787" class="nu mf it nq b gy nv nw l nx ny">import os<br/>import pandas as pd<br/>from datetime import datetime<br/>from airflow.models import DAG<br/>from airflow.operators.bash import BashOperator<br/>from airflow.operators.python import PythonOperator<br/>from airflow.models import Variable<br/><br/><br/>with DAG(<br/>    dag_id='first_airflow_dag',<br/>    schedule_interval='* * * * *',<br/>    start_date=datetime(year=2022, month=2, day=1),<br/>    catchup=False<br/>) as dag:<br/>    pass</span></pre><p id="bc5e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们做了很多导入，这些是我们将在整个文件中使用的模块和操作符。</p><p id="d15a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每个气流DAG都是用Python的上下文管理器语法(<code class="fe oa ob oc nq b">with</code>)定义的。以下是每个参数的描述:</p><ul class=""><li id="609f" class="nb nc it lb b lc ld lf lg li nd lm ne lq nf lu od nh ni nj bi translated"><code class="fe oa ob oc nq b">dag_id</code> -代表Airflow web应用程序中DAG的唯一ID。</li><li id="8edb" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu od nh ni nj bi translated"><code class="fe oa ob oc nq b">schedule_interval</code> -指定DAG运行的时间间隔。可以通过字符串<code class="fe oa ob oc nq b">@once</code>、<code class="fe oa ob oc nq b">@hourly</code>、<code class="fe oa ob oc nq b">@daily</code>、<code class="fe oa ob oc nq b">@weekly</code>、<code class="fe oa ob oc nq b">@monthly</code>、<code class="fe oa ob oc nq b">@yearly</code>，或者类似cron的表情。例如，<code class="fe oa ob oc nq b">* * * * *</code>表示DAG将每分钟运行一次。<a class="ae ky" href="https://airflow.apache.org/docs/apache-airflow/1.10.1/scheduler.html" rel="noopener ugc nofollow" target="_blank">了解更多</a>。</li><li id="1d14" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu od nh ni nj bi translated"><code class="fe oa ob oc nq b">start_date</code> -你的DAG第一次运行的日期，我已经在过去设置过了。</li><li id="f231" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu od nh ni nj bi translated"><code class="fe oa ob oc nq b">catchup</code> -布尔，气流是否应该在从<code class="fe oa ob oc nq b">start_date</code>到现在的每个预定间隔内<em class="oe">赶上</em>。</li></ul><p id="a058" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这样一来，我们就可以开始编写我们的第一个任务了。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="af4f" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">气流任务#1 —获取当前日期时间</h1><p id="ed18" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">我们将使用Airflow的<code class="fe oa ob oc nq b">BashOperator</code>来执行一个shell命令。Airflow中的每个任务都需要一个ID，该ID在DAG级别上必须是唯一的。<code class="fe oa ob oc nq b">bash_command</code>参数允许您指定将要执行的shell命令:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="2553" class="nu mf it nq b gy nv nw l nx ny">import os<br/>import pandas as pd<br/>from datetime import datetime<br/>from airflow.models import DAG<br/>from airflow.operators.bash import BashOperator<br/>from airflow.operators.python import PythonOperator<br/>from airflow.models import Variable<br/><br/><br/>with DAG(<br/>    dag_id='first_airflow_dag',<br/>    schedule_interval='* * * * *',<br/>    start_date=datetime(year=2022, month=2, day=1),<br/>    catchup=False<br/>) as dag:<br/>    <br/>    # 1. Get current datetime<br/>    task_get_datetime = BashOperator(<br/>        task_id='get_datetime',<br/>        bash_command='date'<br/>    )</span></pre><p id="57f7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">返回值保存在内部，您可以通过Airflow的xcoms检索它，但这是我们稍后将探讨的内容。现在，我们可以测试我们的第一个任务是否通过终端工作。这是您可以使用的命令模板:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="01d3" class="nu mf it nq b gy nv nw l nx ny">airflow tasks test &lt;dag_name&gt; &lt;task_name&gt; &lt;date_in_the_past&gt;</span></pre><p id="17b8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的DAG被命名为<code class="fe oa ob oc nq b">first_airflow_dag</code>，我们正在运行一个ID为<code class="fe oa ob oc nq b">get_datetime</code>的任务，因此该命令可以归结为:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="3424" class="nu mf it nq b gy nv nw l nx ny">airflow tasks test first_airflow_dag get_datetime 2022-2-1</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/189e2ee0bf4728acc6723b13eab0a7ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xKgmymKl7P1XvRsfQz2XsA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图2-测试第一个气流任务(图片由作者提供)</p></figure><p id="2d1b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">可以看到<code class="fe oa ob oc nq b">Fri Feb 11 18:35:15 CET 2022</code>返回，任务已经成功完成。这就是我们开始处理datetime所需的全部内容，所以接下来让我们开始吧。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="2e63" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">气流任务#2 —处理当前日期时间</h1><p id="2ee7" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">对于我们的第二个任务，我们将使用一个调用<code class="fe oa ob oc nq b">process_datetime()</code>函数的<code class="fe oa ob oc nq b">PythonOperator</code>。<code class="fe oa ob oc nq b">ti</code>参数允许我们访问<code class="fe oa ob oc nq b">xcom_pull()</code>方法，该方法从前面的任务中检索返回值，由<code class="fe oa ob oc nq b">task_ids</code>参数指定。</p><p id="eee4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不要太担心<code class="fe oa ob oc nq b">xcoms</code>，因为我们将在接下来的文章中详细介绍它们。</p><p id="16a4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将把日期时间转换成一个字符串，然后在空白处把它分成一个列表。目标是从中提取年、月、日、时间和星期几信息。参考<em class="oe">图2 </em>查看单个日期时间字符串的样子:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="ce73" class="nu mf it nq b gy nv nw l nx ny">import os<br/>import pandas as pd<br/>from datetime import datetime<br/>from airflow.models import DAG<br/>from airflow.operators.bash import BashOperator<br/>from airflow.operators.python import PythonOperator<br/>from airflow.models import Variable<br/><br/><br/>def process_datetime(ti):<br/>    dt = ti.xcom_pull(task_ids=['get_datetime'])<br/>    if not dt:<br/>        raise Exception('No datetime value.')<br/><br/>    dt = str(dt[0]).split()<br/>    return {<br/>        'year': int(dt[-1]),<br/>        'month': dt[1],<br/>        'day': int(dt[2]),<br/>        'time': dt[3],<br/>        'day_of_week': dt[0]<br/>    }<br/><br/><br/>with DAG(<br/>    dag_id='first_airflow_dag',<br/>    schedule_interval='* * * * *',<br/>    start_date=datetime(year=2022, month=2, day=1),<br/>    catchup=False<br/>) as dag:<br/>    <br/>    # 1. Get current datetime<br/>    task_get_datetime = BashOperator(<br/>        task_id='get_datetime',<br/>        bash_command='date'<br/>    )<br/>    <br/>    # 2. Process current datetime<br/>    task_process_datetime = PythonOperator(<br/>        task_id='process_datetime',<br/>        python_callable=process_datetime<br/>    )</span></pre><p id="63c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们来测试一下:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="25cd" class="nu mf it nq b gy nv nw l nx ny">airflow tasks test first_airflow_dag process_datetime 2022-2-1</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/290f5b1220981c91db2a6cc50b546ea4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FPjXtinaMu0nCzvQxNOfwA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图3-测试第二个气流任务(图片由作者提供)</p></figure><p id="1185" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将暂时离开代码。打开Airflow主页—<code class="fe oa ob oc nq b">http://localhost:8080/home</code>—查看您的DAG是否出现在列表中:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/45b179cca2e9b33bbd60e3fc9ae10a1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35XrD3eHI42vu6KlFMk6MA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图4——Airflow web应用程序主页(图片由作者提供)</p></figure><p id="bc7d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">点击它并转到<em class="oe">图表视图</em> —您将看到我们的两个任务列表:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/6610d1d49462839f2d68d56f0366b64d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BvzMRHe60q7iSPyyHOEOHw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图5-气流DAG图视图(图片由作者提供)</p></figure><p id="9f75" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些任务列在这里，但没有任何联系。稍后您将看到连接和依赖是如何工作的，但是首先，让我们为第三个任务编写代码。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="83ed" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">气流任务#3 —保存已处理的日期时间</h1><p id="0df5" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">在气流主页上，进入<em class="oe">管理</em> — <em class="oe">变量</em>。您应该会看到如下所示的空白列表:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/45b9c83a2af8be105ed3e47e65c40333.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UUjdfrcgUvquyZx2KbCgVg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图6 —气流变量列表(图片由作者提供)</p></figure><p id="4410" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">单击加号添加一个新变量。我们将其声明为保存一个路径，该路径指向保存CSV文件的位置。我将我的名字命名为<code class="fe oa ob oc nq b">first_dag_csv_path</code>，并输入<code class="fe oa ob oc nq b">/Users/dradecic/Desktop/datetimes.csv</code>作为值:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/bf0fd32385fc2a6be0455863e74e1985.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wnSv_Y0wI7MaAXtMvjJlbg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图7-创建新的气流变量(图片由作者提供)</p></figure><p id="8a6f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当然，您应该在您的机器上指定路径，但这是不言而喻的。完成后点击<em class="oe">保存</em>按钮。您将看到我们的变量被添加到列表中:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/1545f74e38dc8a61c46e4d6268bda394.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vuqi5zXiAYOIoxIEePzl6Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图8-创建新的气流变量(2)(图片由作者提供)</p></figure><p id="a2f5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">开始编码。第三个任务将运行一个名为<code class="fe oa ob oc nq b">save_datetime()</code>的Python函数。它使用xcoms从前面的任务中提取已处理的datetime，然后基于它创建一个Pandas数据帧。</p><p id="80c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后我们可以使用来自Airflow的<code class="fe oa ob oc nq b">Variable</code>类来获取CSV文件的路径。如果该文件存在，我们将把参数<code class="fe oa ob oc nq b">df_header</code>和<code class="fe oa ob oc nq b">df_mode</code>分别设置为<code class="fe oa ob oc nq b">False</code>和<code class="fe oa ob oc nq b">'a'</code>。简单地说，该文件已经存在，所以我们想在其中添加新行，而不是每次都添加标题行。</p><p id="0c99" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果该文件不存在，我们将使用写模式创建它，并且我们还将包括文件头:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="60d2" class="nu mf it nq b gy nv nw l nx ny">import os<br/>import pandas as pd<br/>from datetime import datetime<br/>from airflow.models import DAG<br/>from airflow.operators.bash import BashOperator<br/>from airflow.operators.python import PythonOperator<br/>from airflow.models import Variable<br/><br/><br/>def process_datetime(ti):<br/>    dt = ti.xcom_pull(task_ids=['get_datetime'])<br/>    if not dt:<br/>        raise Exception('No datetime value.')<br/><br/>    dt = str(dt[0]).split()<br/>    return {<br/>        'year': int(dt[-1]),<br/>        'month': dt[1],<br/>        'day': int(dt[2]),<br/>        'time': dt[3],<br/>        'day_of_week': dt[0]<br/>    }<br/><br/><br/>def save_datetime(ti):<br/>    dt_processed = ti.xcom_pull(task_ids=['process_datetime'])<br/>    if not dt_processed:<br/>        raise Exception('No processed datetime value.')<br/><br/>    df = pd.DataFrame(dt_processed)<br/><br/>    csv_path = Variable.get('first_dag_csv_path')<br/>    if os.path.exists(csv_path):<br/>        df_header = False<br/>        df_mode = 'a'<br/>    else:<br/>        df_header = True<br/>        df_mode = 'w'<br/><br/>    df.to_csv(csv_path, index=False, mode=df_mode, header=df_header)<br/><br/><br/>with DAG(<br/>    dag_id='first_airflow_dag',<br/>    schedule_interval='* * * * *',<br/>    start_date=datetime(year=2022, month=2, day=1),<br/>    catchup=False<br/>) as dag:<br/><br/>    # 1. Get current datetime<br/>    task_get_datetime = BashOperator(<br/>        task_id='get_datetime',<br/>        bash_command='date'<br/>    )<br/><br/>    # 2. Process current datetime<br/>    task_process_datetime = PythonOperator(<br/>        task_id='process_datetime',<br/>        python_callable=process_datetime<br/>    )<br/><br/>    # 3. Save processed datetime<br/>    task_save_datetime = PythonOperator(<br/>        task_id='save_datetime',<br/>        python_callable=save_datetime<br/>    )</span></pre><p id="f3a0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们来测试一下:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="3b40" class="nu mf it nq b gy nv nw l nx ny">airflow tasks test first_airflow_dag save_datetime 2022-2-1</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/e12ceb26d2454d7cd971f694cfdf59af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qNOn_KAZdFF76ggki0rorg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图9-测试第三气流任务(图片由作者提供)</p></figure><p id="007f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">任务运行成功，并且根据变量值在桌面上创建了CSV文件:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/67a5920fbf2a4354c0a3217f021750ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gidn4x3FQGY12skxcIwiRQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图10 —以CSV格式保存的日期时间信息(图片由作者提供)</p></figure><p id="9193" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们已经单独实现了所有的小部分，现在是时候连接它们并运行DAG了。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="6df1" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">如何连接气流DAG</h1><p id="f631" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">现在，DAG的<em class="oe">图形视图</em>如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/ea3582672c7d96a53ceedafffbc4a978.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7lg-U8CU4RSp2YVYaJIO9g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图11-图表视图中的气流DAG任务列表(作者提供的图片)</p></figure><p id="8072" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们有所有的任务，但是它们没有联系。气流不知道应该先跑哪一个。比如说。在当前状态下运行DAG可能会在<code class="fe oa ob oc nq b">get_datetime</code>之前调用<code class="fe oa ob oc nq b">process_datetime</code>任务，这没有意义。</p><p id="564f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以使用<code class="fe oa ob oc nq b">set_downstream()</code>方法或使用位移运算符(<code class="fe oa ob oc nq b">&gt;&gt;</code>)来连接任务。我们今天将使用后者:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="0430" class="nu mf it nq b gy nv nw l nx ny">    ...<br/>    # 3. Save processed datetime<br/>    task_save_datetime = PythonOperator(<br/>        task_id='save_datetime',<br/>        python_callable=save_datetime<br/>    )<br/><br/>    task_get_datetime &gt;&gt; task_process_datetime &gt;&gt; task_save_datetime</span></pre><p id="f31f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">刷新Airflow主页，您应该会看到您的任务已连接:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/ba8ecfb9e3a58805a695ea6e60b53e29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PdwCsJ2yTekdW8aG7SyS4g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图12-气流DAG中的连接任务(图片由作者提供)</p></figure><p id="17ee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，Airflow知道任务应该以什么顺序运行。我还通过点击DAG名称前面的<em class="oe">暂停/取消暂停</em>开关打开了DAG。我们现在拥有运行DAG所需的一切。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="440e" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">如何运行气流DAG</h1><p id="718c" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">您的DAG将按计划每分钟自动运行。您也可以通过点击<em class="oe">开始</em>按钮(在<em class="oe">下一次运行</em>文本下方的按钮)手动触发:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/9bd32d72e1e68588f1bfc7db0e1a80e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4j7T1g6zaHuvAL1_69E5xA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图13 —气流DAG执行(图片由作者提供)</p></figure><p id="6603" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果一切都是绿色的，那么每个任务已经完成，没有错误。通过检查树视图上方的图例，您可以看到颜色编码是如何工作的。一段时间后，我们将看到越来越多的运行成功完成，因为它每分钟运行一次:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/f34a7245009cc93abc58a14ce2f16f07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vZ9gVOAu_GPysr6uHLo9jA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图14 —气流DAG执行(2)(图片由作者提供)</p></figure><p id="6c02" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我这边，生成的CSV文件如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/ece1aa691bc7d03af4e296bdd96c64a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CH1IdcANanMB8U75Izua1w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片15—datetime . CSV文件(图片由作者提供)</p></figure><p id="5a71" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">日期之间有一些差距，但只是因为我不得不离开家不久，所以我的笔记本电脑被关闭。只要气流在运行，您应该每分钟都会看到一个新条目。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="d973" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">总结和后续步骤</h1><p id="6d2e" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">这是你的第一个带有气流的数据管道——非常基本，但是要记住这些概念。您已经学习了如何运行shell命令和Python函数，以及如何单独测试每个任务。我知道一下子要处理的事情很多。我建议浏览几次这个管道，然后从头开始实现类似的东西。</p><p id="de23" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，您可以编写一个数据管道来读取CSV文件，以任何方式对其进行处理，并将结果存储在另一个文件中。尝试不同的时间间隔来保持事情的趣味性。</p><p id="a176" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下次再见，届时您将学习如何在Airflow中使用数据库。敬请期待！</p><h2 id="fa43" class="nu mf it bd mg ok ol dn mk om on dp mo li oo op mq lm oq or ms lq os ot mu ou bi translated">推荐阅读</h2><ul class=""><li id="34a1" class="nb nc it lb b lc mw lf mx li ov lm ow lq ox lu od nh ni nj bi translated"><a class="ae ky" href="https://betterdatascience.com/best-data-science-prerequisite-books/" rel="noopener ugc nofollow" target="_blank">学习数据科学先决条件(数学、统计和编程)的5本最佳书籍</a></li><li id="e293" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu od nh ni nj bi translated"><a class="ae ky" href="https://betterdatascience.com/top-books-to-learn-data-science/" rel="noopener ugc nofollow" target="_blank">2022年学习数据科学的前5本书</a></li><li id="215c" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu od nh ni nj bi translated"><a class="ae ky" href="https://betterdatascience.com/python-structural-pattern-matching/" rel="noopener ugc nofollow" target="_blank">Python 3.10中的结构模式匹配(Switch语句)</a></li></ul><h2 id="b98b" class="nu mf it bd mg ok ol dn mk om on dp mo li oo op mq lm oq or ms lq os ot mu ou bi translated">保持联系</h2><ul class=""><li id="5323" class="nb nc it lb b lc mw lf mx li ov lm ow lq ox lu od nh ni nj bi translated">雇用我作为一名<a class="ae ky" href="https://betterdatascience.com/contact/" rel="noopener ugc nofollow" target="_blank">技术作家</a></li><li id="ade1" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu od nh ni nj bi translated">订阅<a class="ae ky" href="https://www.youtube.com/c/BetterDataScience" rel="noopener ugc nofollow" target="_blank"> YouTube </a></li><li id="1e07" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu od nh ni nj bi translated">在<a class="ae ky" href="https://www.linkedin.com/in/darioradecic/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上连接</li></ul></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><p id="4554" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="oe">喜欢这篇文章吗？成为</em> <a class="ae ky" href="https://medium.com/@radecicdario/membership" rel="noopener"> <em class="oe">中等会员</em> </a> <em class="oe">继续无限制学习。如果你使用下面的链接，我会收到你的一部分会员费，不需要你额外付费。</em></p><div class="oy oz gp gr pa pb"><a href="https://medium.com/@radecicdario/membership" rel="noopener follow" target="_blank"><div class="pc ab fo"><div class="pd ab pe cl cj pf"><h2 class="bd iu gy z fp pg fr fs ph fu fw is bi translated">通过我的推荐链接加入Medium-Dario rade ci</h2><div class="pi l"><h3 class="bd b gy z fp pg fr fs ph fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="pj l"><p class="bd b dl z fp pg fr fs ph fu fw dk translated">medium.com</p></div></div><div class="pk l"><div class="pl l pm pn po pk pp ks pb"/></div></div></a></div></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><p id="9352" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="oe">原载于2022年2月23日</em><a class="ae ky" href="https://betterdatascience.com/apache-airflow-write-your-first-dag/" rel="noopener ugc nofollow" target="_blank"><em class="oe">https://betterdatascience.com</em></a>T22。</p></div></div>    
</body>
</html>