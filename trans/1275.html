<html>
<head>
<title>Time Series DIY: Seasonal Decomposition</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">时间序列 DIY:季节分解</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/time-series-diy-seasonal-decomposition-f0b469afed44#2022-03-31">https://towardsdatascience.com/time-series-diy-seasonal-decomposition-f0b469afed44#2022-03-31</a></blockquote><div><div class="fc ij ik il im in"/><div class="io ip iq ir is"><figure class="iu iv gp gr iw ix gh gi paragraph-image"><div role="button" tabindex="0" class="iy iz di ja bf jb"><div class="gh gi it"><img src="../Images/dd3cc31142d5419ca5c6f2e60f143533.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mvi5b_QxS_IbaRSCkQM2_w.jpeg"/></div></div><p class="je jf gj gh gi jg jh bd b be z dk translated">克里斯·劳顿在<a class="ae ji" href="https://unsplash.com/s/photos/seasons?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><div class=""/><div class=""><h2 id="0333" class="pw-subtitle-paragraph ki jk jl bd b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dk translated">了解在<code class="fe la lb lc ld b">statsmodel’</code> s <code class="fe la lb lc ld b">seasonal_decompose</code>的引擎盖下发生了什么</h2></div><p id="fb18" class="pw-post-body-paragraph le lf jl lg b lh li km lj lk ll kp lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">如果你处理过时间序列，你可能已经使用过<code class="fe la lb lc ld b">statsmodel</code>中的<code class="fe la lb lc ld b">seasonal_decompose</code>(或者 R 的等价物)。长话短说，它将时间序列分成三个部分:趋势、季节性和残差。运行该命令后，您会看到类似下图的内容。</p><figure class="mb mc md me gt ix gh gi paragraph-image"><div role="button" tabindex="0" class="iy iz di ja bf jb"><div class="gh gi ma"><img src="../Images/e08db0070841bf466c228aa58d66f64b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mK7ONLLJjNcU1X3zwtdD6A.png"/></div></div><p class="je jf gj gh gi jg jh bd b be z dk translated">作者图片</p></figure><p id="177c" class="pw-post-body-paragraph le lf jl lg b lh li km lj lk ll kp lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">组件的解释也非常直观:</p><ul class=""><li id="cf74" class="mf mg jl lg b lh li lk ll ln mh lr mi lv mj lz mk ml mm mn bi translated">趋势——一个系列在很长一段时间内的总体方向</li><li id="9775" class="mf mg jl lg b lh mo lk mp ln mq lr mr lv ms lz mk ml mm mn bi translated">季节性——由于各种季节性因素，定期观察到的独特的重复模式。可以是每月、每周等。</li><li id="d696" class="mf mg jl lg b lh mo lk mp ln mq lr mr lv ms lz mk ml mm mn bi translated">残差——去除之前的成分后，由时间序列波动组成的不规则成分</li></ul><p id="11c4" class="pw-post-body-paragraph le lf jl lg b lh li km lj lk ll kp lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">这应该足够了。我也不会详细讨论季节分解的目标(理解数据、预测、异常值检测)。相反，我想探索一个不太受欢迎的角度——当你调用<code class="fe la lb lc ld b">seasonal_decompose </code>函数时会发生什么。在这篇动手文章中，我们将回答这个问题:<em class="mt">这些组件是如何估算的？如果你好奇，请继续阅读！</em></p><h1 id="6c00" class="mu mv jl bd mw mx my mz na nb nc nd ne kr nf ks ng ku nh kv ni kx nj ky nk nl bi translated">理论</h1><p id="9b45" class="pw-post-body-paragraph le lf jl lg b lh nm km lj lk nn kp lm ln no lp lq lr np lt lu lv nq lx ly lz io bi translated">让我们假设我们处理的是加性模型，即由一个线性趋势和具有相同频率(宽度)和振幅(高度)的季节性周期组成。对于乘法模型，你只需要用乘法代替加法，用除法代替减法。</p><h2 id="6593" class="nr mv jl bd mw ns nt dn na nu nv dp ne ln nw nx ng lr ny nz ni lv oa ob nk oc bi translated">趋势分量</h2><p id="f85a" class="pw-post-body-paragraph le lf jl lg b lh nm km lj lk nn kp lm ln no lp lq lr np lt lu lv nq lx ly lz io bi translated">使用时间序列的居中移动平均值计算趋势。使用对应于时间序列频率的窗口长度来计算移动平均值。例如，我们将对月度数据使用长度为 12 的窗口。</p><p id="3562" class="pw-post-body-paragraph le lf jl lg b lh li km lj lk ll kp lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">使用这种移动平均线来平滑序列也有一些缺点。首先，我们正在“丢失”系列的第一个和最后几个观察值。第二，移动平均线会使数列变得过于平滑，这使得它对趋势的突然变化或跳跃反应迟钝。</p><h2 id="c02a" class="nr mv jl bd mw ns nt dn na nu nv dp ne ln nw nx ng lr ny nz ni lv oa ob nk oc bi translated">季节性成分</h2><p id="ab62" class="pw-post-body-paragraph le lf jl lg b lh nm km lj lk nn kp lm ln no lp lq lr np lt lu lv nq lx ly lz io bi translated">为了计算季节性成分，我们首先需要对时间序列进行去趋势分析。我们通过从原始时间序列中减去趋势分量来实现(记住，我们除以乘法变量)。</p><p id="1dc7" class="pw-post-body-paragraph le lf jl lg b lh li km lj lk ll kp lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">完成后，我们计算每个季节周期的去趋势序列的平均值。对于月份，我们将计算每个月的平均去趋势值。</p><p id="5ccd" class="pw-post-body-paragraph le lf jl lg b lh li km lj lk ll kp lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">季节性成分是简单地从整个序列的长度重复的季节性平均值构建的，这也是反对使用简单季节性分解的理由之一-季节性成分不允许随着时间的推移而变化，这对于较长的时间序列来说可能是一个非常严格且通常不切实际的假设。</p><p id="5a70" class="pw-post-body-paragraph le lf jl lg b lh li km lj lk ll kp lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">另一方面，在加法分解中，去趋势序列以零为中心，因为加零不会改变趋势。相同的逻辑应用于乘法方法，不同之处在于它以 1 为中心。这是因为趋势乘以 1 也不会对其产生影响。</p><h2 id="54c4" class="nr mv jl bd mw ns nt dn na nu nv dp ne ln nw nx ng lr ny nz ni lv oa ob nk oc bi translated">残差</h2><p id="fe90" class="pw-post-body-paragraph le lf jl lg b lh nm km lj lk nn kp lm ln no lp lq lr np lt lu lv nq lx ly lz io bi translated">最后一个部分就是从原始时间序列中去除(减去或除以)趋势和季节成分后剩下的部分。</p><p id="3aa1" class="pw-post-body-paragraph le lf jl lg b lh li km lj lk ll kp lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">理论到此为止，让我们编码吧！</p><h1 id="e717" class="mu mv jl bd mw mx my mz na nb nc nd ne kr nf ks ng ku nh kv ni kx nj ky nk nl bi translated">循序渐进的教程</h1><h2 id="73d4" class="nr mv jl bd mw ns nt dn na nu nv dp ne ln nw nx ng lr ny nz ni lv oa ob nk oc bi translated">设置</h2><p id="8904" class="pw-post-body-paragraph le lf jl lg b lh nm km lj lk nn kp lm ln no lp lq lr np lt lu lv nq lx ly lz io bi translated">和往常一样，我们从导入库开始。</p><figure class="mb mc md me gt ix"><div class="bz fp l di"><div class="od oe l"/></div></figure><h2 id="a3d3" class="nr mv jl bd mw ns nt dn na nu nv dp ne ln nw nx ng lr ny nz ni lv oa ob nk oc bi translated">数据</h2><p id="0a80" class="pw-post-body-paragraph le lf jl lg b lh nm km lj lk nn kp lm ln no lp lq lr np lt lu lv nq lx ly lz io bi translated">我们将使用可能是时间序列分析中最流行的数据集——澳大利亚航空乘客时间序列。我们从一个 CSV 文件中加载它(此处<a class="ae ji" href="https://raw.githubusercontent.com/jbrownlee/Datasets/master/airline-passengers.csv" rel="noopener ugc nofollow" target="_blank">可用</a>，但是您也可以从其他来源获取它，例如，从<code class="fe la lb lc ld b">seaborn</code>库(<a class="ae ji" href="https://github.com/mwaskom/seaborn-data/blob/master/flights.csv" rel="noopener ugc nofollow" target="_blank">此处</a>)。</p><figure class="mb mc md me gt ix"><div class="bz fp l di"><div class="od oe l"/></div></figure><figure class="mb mc md me gt ix gh gi paragraph-image"><div role="button" tabindex="0" class="iy iz di ja bf jb"><div class="gh gi of"><img src="../Images/62376c7b92b70de999be4e090f43cbce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qO4WaDYxqSMphxingtZxoQ.png"/></div></div><p class="je jf gj gh gi jg jh bd b be z dk translated">作者图片</p></figure><p id="26be" class="pw-post-body-paragraph le lf jl lg b lh li km lj lk ll kp lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">仅仅通过目测图表，乘法分解似乎是一个更好的选择(特别是当看到季节成分随着时间的推移而增加时)。但是我们将保持我们在介绍中的假设，并进行加法分解。我们把乘法作为一个可选的练习。</p><h2 id="308c" class="nr mv jl bd mw ns nt dn na nu nv dp ne ln nw nx ng lr ny nz ni lv oa ob nk oc bi translated">来自 statsmodels 的基准</h2><p id="ae4e" class="pw-post-body-paragraph le lf jl lg b lh nm km lj lk nn kp lm ln no lp lq lr np lt lu lv nq lx ly lz io bi translated">在我们自己分解时间序列之前，可以用<code class="fe la lb lc ld b">statsmodels</code>得到基准。</p><figure class="mb mc md me gt ix"><div class="bz fp l di"><div class="od oe l"/></div></figure><figure class="mb mc md me gt ix gh gi paragraph-image"><div role="button" tabindex="0" class="iy iz di ja bf jb"><div class="gh gi og"><img src="../Images/a919fceac21c3555d2895b8706d52e86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FW8egSxr3xiKyYP_CMLX3g.png"/></div></div><p class="je jf gj gh gi jg jh bd b be z dk translated">作者图片</p></figure><p id="2884" class="pw-post-body-paragraph le lf jl lg b lh li km lj lk ll kp lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">在图中，我们可以看到另一个提示，即加性模型在这里不是正确的选择-随着时间的推移，残差中有明显的模式。在拟合较好的情况下，我们希望残差表现随机，没有任何模式。</p><p id="d132" class="pw-post-body-paragraph le lf jl lg b lh li km lj lk ll kp lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">作为参考，我们可以很容易地从<code class="fe la lb lc ld b">DecomposeResult</code>对象中提取组件。它们存放在<code class="fe la lb lc ld b">trend</code>、<code class="fe la lb lc ld b">seasonal</code>和<code class="fe la lb lc ld b">resid</code>下。</p><h2 id="6f61" class="nr mv jl bd mw ns nt dn na nu nv dp ne ln nw nx ng lr ny nz ni lv oa ob nk oc bi translated">人工分解</h2><p id="734d" class="pw-post-body-paragraph le lf jl lg b lh nm km lj lk nn kp lm ln no lp lq lr np lt lu lv nq lx ly lz io bi translated">对于手工分解，我们将使用一个<code class="fe la lb lc ld b">pandas</code>数据框架来存储原始序列、提取的组件和所有中间结果。</p><p id="16f8" class="pw-post-body-paragraph le lf jl lg b lh li km lj lk ll kp lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">我们已经在上面的理论部分写出了作战计划，所以让我们在一个代码片段中执行所有步骤(你可以在 GitHub 上按照笔记本中的一个单元一个单元的流程)。</p><figure class="mb mc md me gt ix"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="c7fd" class="pw-post-body-paragraph le lf jl lg b lh li km lj lk ll kp lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">运行该代码片段会生成下表:</p><figure class="mb mc md me gt ix gh gi paragraph-image"><div role="button" tabindex="0" class="iy iz di ja bf jb"><div class="gh gi oh"><img src="../Images/917fdb2b5e1d1cbc5ec03548052806a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sK2sS2luQjlnBL-Wvk6edA.png"/></div></div><p class="je jf gj gh gi jg jh bd b be z dk translated">作者图片</p></figure><p id="7a1f" class="pw-post-body-paragraph le lf jl lg b lh li km lj lk ll kp lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">关于计算，有几件事值得一提:</p><ul class=""><li id="a889" class="mf mg jl lg b lh li lk ll ln mh lr mi lv mj lz mk ml mm mn bi translated">我们使用了长度为 13 的滚动窗口(12 个月+ 1 使其成为居中平均值的奇数)。</li><li id="765a" class="mf mg jl lg b lh mo lk mp ln mq lr mr lv ms lz mk ml mm mn bi translated">我们使用了一种叫做<code class="fe la lb lc ld b">transform</code>的非常简便的方法来计算每组的平均值。我们使用它来避免创建一个单独的带有聚合值的数据帧，然后将它连接回原始的 DF。你可以在这里阅读更多关于它的内容(以及其他一些有用的<code class="fe la lb lc ld b">pandas</code>功能】<a class="ae ji" rel="noopener" target="_blank" href="/9-useful-pandas-methods-you-probably-have-not-heard-about-28ff6c0bceee">。</a></li><li id="2335" class="mf mg jl lg b lh mo lk mp ln mq lr mr lv ms lz mk ml mm mn bi translated">我们显示了前 15 行，这样我们就可以看到所有月份(包括那些在去趋势序列中缺少值的月份)的合计季节性成分都计算正确。</li></ul><p id="6f38" class="pw-post-body-paragraph le lf jl lg b lh li km lj lk ll kp lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">最后，我们绘制分解图。</p><figure class="mb mc md me gt ix"><div class="bz fp l di"><div class="od oe l"/></div></figure><figure class="mb mc md me gt ix gh gi paragraph-image"><div role="button" tabindex="0" class="iy iz di ja bf jb"><div class="gh gi oi"><img src="../Images/a3b9ef653fddea2582f92d2cc5527471.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lqFYBkEq1K8x1aFHjqeRTA.png"/></div></div><p class="je jf gj gh gi jg jh bd b be z dk translated">作者图片</p></figure><p id="ad75" class="pw-post-body-paragraph le lf jl lg b lh li km lj lk ll kp lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">结果看起来和我们用<code class="fe la lb lc ld b">statsmodels</code>得到的非常相似。我们没有将残差绘制成点(而不是默认的线)，但是，我们应该仍然能够很容易地看到重叠的模式。</p><h2 id="4eed" class="nr mv jl bd mw ns nt dn na nu nv dp ne ln nw nx ng lr ny nz ni lv oa ob nk oc bi translated">结果比较</h2><p id="184e" class="pw-post-body-paragraph le lf jl lg b lh nm km lj lk nn kp lm ln no lp lq lr np lt lu lv nq lx ly lz io bi translated">为了比较我们是否精确匹配，我们可以查看用<code class="fe la lb lc ld b">seasonal_decompose</code>提取的组件，并将它们与我们手动计算的组件进行比较。剧透:它们非常相似，但又不相同。</p><p id="d7a5" class="pw-post-body-paragraph le lf jl lg b lh li km lj lk ll kp lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">我们选择了另一种方法，即直观地比较两种分解。首先，我们将手动分解的结果存储在<code class="fe la lb lc ld b">DecomposeResult</code>对象中。然后，我们借用了一个很棒的助手函数，将一个分解的结果添加到一个现有的分解图中(函数的<a class="ae ji" href="https://www.statsmodels.org/devel/examples/notebooks/generated/stl_decomposition.html" rel="noopener ugc nofollow" target="_blank">源)。</a></p><figure class="mb mc md me gt ix"><div class="bz fp l di"><div class="od oe l"/></div></figure><figure class="mb mc md me gt ix gh gi paragraph-image"><div role="button" tabindex="0" class="iy iz di ja bf jb"><div class="gh gi oj"><img src="../Images/fe6ffda7d9ff11663b8341e88677b26c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UtvCWim3pDnaAkkW-srTeg.png"/></div></div><p class="je jf gj gh gi jg jh bd b be z dk translated">作者图片</p></figure><p id="66f4" class="pw-post-body-paragraph le lf jl lg b lh li km lj lk ll kp lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">在上图中，我们看到结果非常接近。这些差异可归因于组件的计算方式——一如既往，细节决定成败。在<code class="fe la lb lc ld b">statsmodels</code>中，使用一维卷积滤波器计算用于提取趋势分量的移动平均值(使用<code class="fe la lb lc ld b">convolution_filter</code>函数计算)。如您所见，结果非常相似，但还是有点不同。这然后传播到季节性成分。</p><h1 id="9777" class="mu mv jl bd mw mx my mz na nb nc nd ne kr nf ks ng ku nh kv ni kx nj ky nk nl bi translated">外卖食品</h1><ul class=""><li id="c53d" class="mf mg jl lg b lh nm lk nn ln ok lr ol lv om lz mk ml mm mn bi translated">季节分解的基本方法是将时间序列分成三个部分:趋势、季节和残差，</li><li id="cf31" class="mf mg jl lg b lh mo lk mp ln mq lr mr lv ms lz mk ml mm mn bi translated">趋势分量被计算为原始序列的居中移动平均值，</li><li id="dcc6" class="mf mg jl lg b lh mo lk mp ln mq lr mr lv ms lz mk ml mm mn bi translated">季节性因素是按去趋势数列的每期平均值计算的，</li><li id="0eeb" class="mf mg jl lg b lh mo lk mp ln mq lr mr lv ms lz mk ml mm mn bi translated">残差分量是在从时间序列中去除趋势和季节分量之后获得的。</li></ul><p id="d628" class="pw-post-body-paragraph le lf jl lg b lh li km lj lk ll kp lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">您可以在我的<a class="ae ji" href="https://github.com/erykml/medium_articles/blob/master/Time%20Series/time_series_decomposition_diy.ipynb" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到本文使用的代码。此外，欢迎任何建设性的反馈。你可以在<a class="ae ji" href="https://twitter.com/erykml1?source=post_page---------------------------" rel="noopener ugc nofollow" target="_blank">推特</a>或评论中联系我。</p><p id="eb2f" class="pw-post-body-paragraph le lf jl lg b lh li km lj lk ll kp lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated"><em class="mt">喜欢这篇文章吗？成为一个媒介成员，通过无限制的阅读继续学习。如果你使用</em> <a class="ae ji" href="https://eryk-lewinson.medium.com/membership" rel="noopener"> <em class="mt">这个链接</em> </a> <em class="mt">成为会员，你就支持我，不需要你额外付费。提前感谢，再见！</em></p><p id="592a" class="pw-post-body-paragraph le lf jl lg b lh li km lj lk ll kp lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">您可能还会对以下内容感兴趣:</p><div class="iu iv gp gr iw on"><a rel="noopener follow" target="_blank" href="/pandas-is-not-enough-a-comprehensive-guide-to-alternative-data-wrangling-solutions-a4730ba8d0e4"><div class="oo ab fo"><div class="op ab oq cl cj or"><h2 class="bd jm gy z fp os fr fs ot fu fw jk bi translated">熊猫还不够？替代数据争论解决方案的全面指南</h2><div class="ou l"><h3 class="bd b gy z fp os fr fs ot fu fw dk translated">包括达斯克、摩丁、polars、Vaex、Terality 等 6 人</h3></div><div class="ov l"><p class="bd b dl z fp os fr fs ot fu fw dk translated">towardsdatascience.com</p></div></div><div class="ow l"><div class="ox l oy oz pa ow pb jc on"/></div></div></a></div><div class="iu iv gp gr iw on"><a rel="noopener follow" target="_blank" href="/a-step-by-step-guide-to-calculating-autocorrelation-and-partial-autocorrelation-8c4342b784e8"><div class="oo ab fo"><div class="op ab oq cl cj or"><h2 class="bd jm gy z fp os fr fs ot fu fw jk bi translated">计算自相关和偏自相关的分步指南</h2><div class="ou l"><h3 class="bd b gy z fp os fr fs ot fu fw dk translated">如何在 Python 中从头开始计算 ACF 和 PACF 值</h3></div><div class="ov l"><p class="bd b dl z fp os fr fs ot fu fw dk translated">towardsdatascience.com</p></div></div><div class="ow l"><div class="pc l oy oz pa ow pb jc on"/></div></div></a></div><div class="iu iv gp gr iw on"><a rel="noopener follow" target="_blank" href="/linkedins-response-to-prophet-silverkite-and-greykite-4fd0131f64cb"><div class="oo ab fo"><div class="op ab oq cl cj or"><h2 class="bd jm gy z fp os fr fs ot fu fw jk bi translated">LinkedIn 对 Prophet-silver kite 和 Greykite 的回应</h2><div class="ou l"><h3 class="bd b gy z fp os fr fs ot fu fw dk translated">时间序列预测新算法综述</h3></div><div class="ov l"><p class="bd b dl z fp os fr fs ot fu fw dk translated">towardsdatascience.com</p></div></div><div class="ow l"><div class="pd l oy oz pa ow pb jc on"/></div></div></a></div><h1 id="a65b" class="mu mv jl bd mw mx my mz na nb nc nd ne kr nf ks ng ku nh kv ni kx nj ky nk nl bi translated">参考</h1><ul class=""><li id="22e2" class="mf mg jl lg b lh nm lk nn ln ok lr ol lv om lz mk ml mm mn bi translated">Box，G. E. P .，Jenkins，G. M .和 Reinsel，G. C. (1976) <em class="mt">时间序列分析、预测和控制。</em>第三版。霍尔登日。g 系列。</li></ul></div></div>    
</body>
</html>