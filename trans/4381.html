<html>
<head>
<title>Python Conda Environments for Both arm64 and x86_64 on M1 Apple Silicon</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python Conda环境，适用于M1苹果芯片上的arm64和x86_64</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/python-conda-environments-for-both-arm64-and-x86-64-on-m1-apple-silicon-147b943ffa55#2022-09-28">https://towardsdatascience.com/python-conda-environments-for-both-arm64-and-x86-64-on-m1-apple-silicon-147b943ffa55#2022-09-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="be3a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在M1苹果芯片上的arm64和x86_64 Python依赖项之间无缝切换</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/4ff03e893386d2d2f41b277e8f60ec7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*z8IP4nDNjGy5-3KL"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com/@viazavier?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">劳拉·奥克</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="be8b" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">介绍</h1><p id="e31b" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">新款MacBook Pros中M1苹果芯片的发布可以被认为是芯片技术最大的时代飞跃之一。新的M1芯片具有更高的功率和计算效率，基于arm64架构，不同于前几代的英特尔x86_64芯片。</p><p id="fefe" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">虽然这一变化引发了许多兼容性问题，但M1芯片的单线程和多线程性能明显优于其英特尔前代产品。这使得M1 MacBook Pro成为数据科学相关工作负载的最佳笔记本电脑之一。</p><p id="b7c8" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">像苹果发布的许多新技术一样，行业往往需要一段时间才能赶上。当我们等待开发者发布对我们所依赖的许多依赖项的原生支持时，苹果已经发布了Rosetta来支持仍然基于x86_64架构的软件。尽管如此，对于像我一样的许多Python开发人员来说，仍然经常会遇到与我们的Python环境的兼容性问题。</p><p id="06e2" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">为此，这篇博客详细介绍了我在M1苹果芯片上设置Python环境的配置步骤。在这篇博客的结尾，你将学会如何配置Python来使用基于arm64或x86_64的依赖项。</p><p id="3ded" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">出于演示的目的，我们将为<code class="fe mp mq mr ms b">tensorflow-macos</code>设置我们的Python环境，因为tensorflow-macos只能在arm64 Python环境中执行。然而，这里详述的过程将允许您为arm64和x86_64环境安装Python包。</p><h1 id="4ca0" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">安装依赖项</h1><p id="3e42" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我们需要首先安装两个特定的依赖项。</p><ol class=""><li id="543e" class="mt mu iq lq b lr mk lu ml lx mv mb mw mf mx mj my mz na nb bi translated">Xcode</li><li id="620c" class="mt mu iq lq b lr nc lu nd lx ne mb nf mf ng mj my mz na nb bi translated">小型锻造3</li></ol><h2 id="1791" class="nh kx iq bd ky ni nj dn lc nk nl dp lg lx nm nn li mb no np lk mf nq nr lm ns bi translated">1.安装Xcode:</h2><p id="e9f9" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">若要安装Xcode，请先打开终端会话，方法是前往“应用程序”&gt;“实用工具”&gt;“终端”。然后键入命令:</p><pre class="kg kh ki kj gt nt ms nu nv aw nw bi"><span id="391b" class="nh kx iq ms b gy nx ny l nz oa">xcode-select --install</span></pre><p id="b239" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">请注意Xcode的安装可能需要一段时间。</p><h2 id="647f" class="nh kx iq bd ky ni nj dn lc nk nl dp lg lx nm nn li mb no np lk mf nq nr lm ns bi translated">2.安装小型锻造3</h2><p id="4f78" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">接下来，我们将安装Miniforge3。Miniforge3是社区(conda-forge)驱动的极简主义<code class="fe mp mq mr ms b">conda</code>安装程序。此外，Miniforge3具有对基于arm64的架构的原生支持，这无疑是有利的。</p><p id="fbec" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">要安装Miniforge3，请从以下网址下载shell脚本:</p><p id="0d8a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><strong class="lq ir">确保选择arm64(苹果芯片)架构。</strong></p><div class="ob oc gp gr od oe"><a href="https://github.com/conda-forge/miniforge" rel="noopener  ugc nofollow" target="_blank"><div class="of ab fo"><div class="og ab oh cl cj oi"><h2 class="bd ir gy z fp oj fr fs ok fu fw ip bi translated">GitHub-conda-forge/mini forge:conda-forge发行版。</h2><div class="ol l"><h3 class="bd b gy z fp oj fr fs ok fu fw dk translated">这个库包含了一个针对conda-forge的Conda最小安装程序。迷你锻造允许您安装康达…</h3></div><div class="om l"><p class="bd b dl z fp oj fr fs ok fu fw dk translated">github.com</p></div></div><div class="on l"><div class="oo l op oq or on os kp oe"/></div></div></a></div><p id="81be" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">下载完shell脚本后，您可能需要使用以下命令来启用shell脚本的执行:</p><pre class="kg kh ki kj gt nt ms nu nv aw nw bi"><span id="abb0" class="nh kx iq ms b gy nx ny l nz oa">chmod +x Miniforge3-MacOSX-arm64.sh</span></pre><p id="5f20" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">之后，使用以下命令执行脚本:</p><pre class="kg kh ki kj gt nt ms nu nv aw nw bi"><span id="8ec4" class="nh kx iq ms b gy nx ny l nz oa">sh Miniforge3-MacOSX-arm64.sh</span></pre><p id="064d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">按照提示进行操作，这将在您的机器上安装<code class="fe mp mq mr ms b">conda</code>。我们可以使用以下命令来确认是否安装了<code class="fe mp mq mr ms b">conda</code>:</p><pre class="kg kh ki kj gt nt ms nu nv aw nw bi"><span id="66f9" class="nh kx iq ms b gy nx ny l nz oa">conda --version</span></pre><p id="7e44" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">您应该得到如下所示的输出。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ot"><img src="../Images/efc5714004a3fcfcb2509031a58ba990.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*me96U1UImcQO1hcVRpOY_A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片来自作者</p></figure><h1 id="00b1" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">Conda设置</h1><p id="455e" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">一旦安装了所有的依赖项，我们就可以继续为arm64或x86_64 Python环境配置<code class="fe mp mq mr ms b">conda</code>。</p><p id="e330" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们将从在当前shell中添加一些快捷方式开始，以便于安装不同的<code class="fe mp mq mr ms b">conda</code>环境。下面的代码片段将添加两个快捷函数，这两个函数将创建一个<code class="fe mp mq mr ms b">osx-64</code>或<code class="fe mp mq mr ms b">osx-arm64</code> conda环境，我们可以在其中安装Python包。</p><p id="272a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">为此，将以下代码添加到<code class="fe mp mq mr ms b">~/.zshrc</code>或<code class="fe mp mq mr ms b">~/.bashrc</code>。</p><pre class="kg kh ki kj gt nt ms nu nv aw nw bi"><span id="1042" class="nh kx iq ms b gy nx ny l nz oa"># Create x86 conda environment<br/>create_x86_conda_environment () {</span><span id="547f" class="nh kx iq ms b gy ou ny l nz oa"># example usage: create_x86_conda_environment myenv_x86 python=3.9<br/> CONDA_SUBDIR=osx-64 conda create -n $@<br/> conda activate $1</span><span id="3f24" class="nh kx iq ms b gy ou ny l nz oa">}</span><span id="d301" class="nh kx iq ms b gy ou ny l nz oa"># Create ARM conda environment<br/>create_ARM_conda_environment () {</span><span id="6170" class="nh kx iq ms b gy ou ny l nz oa"># example usage: create_ARM_conda_environment myenv_x86 python=3.9<br/> CONDA_SUBDIR=osx-arm64 conda create -n $@<br/> conda activate $1</span><span id="30a2" class="nh kx iq ms b gy ou ny l nz oa">}</span></pre><h1 id="ca12" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">创造康达环境</h1><p id="a3d7" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">Miniforge3的特性之一是能够为特定的Python环境定义特定于处理器的子目录。例如，通过设置<code class="fe mp mq mr ms b">CONDA_SUBDIR==osx-64</code>，将指示<code class="fe mp mq mr ms b">conda</code>从x86_64 (osx-64)特定子目录安装软件包。</p><p id="f10b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这将使用户能够根据<code class="fe mp mq mr ms b">CONDA_SUBDIR</code>定义的值创建安装arm64或x86_64 (osx-64) Python包的环境。</p><p id="9cd9" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我们使用之前创建的快捷方式安装两个不同的环境，一个基于x86_64 (osx-64)，另一个基于arm64 (osx-arm64)。</p><h2 id="8960" class="nh kx iq bd ky ni nj dn lc nk nl dp lg lx nm nn li mb no np lk mf nq nr lm ns bi translated">x86_64 (osx-64)</h2><p id="aee5" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">创建一个名为env_x86的Python 3.9.13 <code class="fe mp mq mr ms b">osx-64</code> (x86_64)环境:</p><pre class="kg kh ki kj gt nt ms nu nv aw nw bi"><span id="e823" class="nh kx iq ms b gy nx ny l nz oa">create_x86_conda_environment env_x86 python=3.9.13</span></pre><p id="b838" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">或者，如果您选择不使用快捷方式，您可以使用命令获得与上面相同的结果:</p><pre class="kg kh ki kj gt nt ms nu nv aw nw bi"><span id="3a95" class="nh kx iq ms b gy nx ny l nz oa">CONDA_SUBDIR=osx-64 conda create -n env_x86 python=3.9.13<br/>conda activate env_x86</span></pre><h2 id="6f14" class="nh kx iq bd ky ni nj dn lc nk nl dp lg lx nm nn li mb no np lk mf nq nr lm ns bi translated">arm64 (osx-arm64)</h2><p id="476d" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">使用快捷方式创建一个名为tensorflow_ARM的Python 3.9.13 <code class="fe mp mq mr ms b">osx-arm64</code> (arm64)环境:</p><pre class="kg kh ki kj gt nt ms nu nv aw nw bi"><span id="98f8" class="nh kx iq ms b gy nx ny l nz oa">create_ARM_conda_environment tensorflow_ARM python=3.9.13</span></pre><p id="4956" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">或者，如果您选择不使用快捷方式，您可以使用命令获得与上面相同的结果:</p><pre class="kg kh ki kj gt nt ms nu nv aw nw bi"><span id="0c78" class="nh kx iq ms b gy nx ny l nz oa">CONDA_SUBDIR=osx-arm64 conda create -n tensorflow_ARM python=3.9.13<br/>conda activate tensorflow_ARM</span></pre><p id="b21d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">执行上述步骤将安装两个使用x86_64 (osx-64)或arm64 (osx-arm64)的Python环境。通过使用以下命令激活特定环境，可以在这两种环境之间无缝切换:</p><pre class="kg kh ki kj gt nt ms nu nv aw nw bi"><span id="9ddd" class="nh kx iq ms b gy nx ny l nz oa">conda activate &lt;NAME_OF_ENVIRONMENT&gt;</span></pre><h1 id="d069" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">张量流装置</h1><p id="8e8a" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">让我们验证是否安装了arm64环境。为此，我们将安装<code class="fe mp mq mr ms b">tensorflow-macos</code>。如前所述，<code class="fe mp mq mr ms b">tensorflow-macos</code>只能在arm64 Python环境中执行。</p><p id="e3d9" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><strong class="lq ir">注意:</strong> <code class="fe mp mq mr ms b"><strong class="lq ir">tensorflow</strong></code> <strong class="lq ir">在x86_64 Python环境下无法工作</strong></p><ol class=""><li id="1f88" class="mt mu iq lq b lr mk lu ml lx mv mb mw mf mx mj my mz na nb bi translated">使用以下命令激活<code class="fe mp mq mr ms b">tensoflow_ARM</code>环境:</li></ol><pre class="kg kh ki kj gt nt ms nu nv aw nw bi"><span id="91de" class="nh kx iq ms b gy nx ny l nz oa">conda activate tensorflow_ARM</span></pre><p id="9199" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">2.安装arm64特定tensorflow依赖项。</p><p id="3695" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><strong class="lq ir">注:</strong> <code class="fe mp mq mr ms b"><strong class="lq ir">-c</strong></code> <strong class="lq ir"> =频道</strong></p><pre class="kg kh ki kj gt nt ms nu nv aw nw bi"><span id="e417" class="nh kx iq ms b gy nx ny l nz oa">conda install -c apple tensorflow-deps</span></pre><p id="b88e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">3.安装tensorflow库:</p><pre class="kg kh ki kj gt nt ms nu nv aw nw bi"><span id="e3a0" class="nh kx iq ms b gy nx ny l nz oa">pip install tensorflow-macos tensorflow-metal</span></pre><h2 id="1245" class="nh kx iq bd ky ni nj dn lc nk nl dp lg lx nm nn li mb no np lk mf nq nr lm ns bi translated">张量流验证</h2><p id="bd50" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">让我们验证tensorflow安装是否有效。</p><ol class=""><li id="0b01" class="mt mu iq lq b lr mk lu ml lx mv mb mw mf mx mj my mz na nb bi translated">首先激活适当的环境并启动python环境。</li></ol><pre class="kg kh ki kj gt nt ms nu nv aw nw bi"><span id="1e79" class="nh kx iq ms b gy nx ny l nz oa">conda activate tensorflow_ARM &amp;&amp; python</span></pre><p id="8f00" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">2.导入张量流并创建常数:</p><pre class="kg kh ki kj gt nt ms nu nv aw nw bi"><span id="cd51" class="nh kx iq ms b gy nx ny l nz oa">import tensorflow as tf<br/>tf.constant([1,2,3])</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ov"><img src="../Images/91004592d38c89e8dd68e7be41dad2ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*WM0DUTQzbvA6IFKbybbwFA.gif"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="bb27" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">3.让我们也检查一下tensorflow是否在您的机器上使用了GPU加速:</p><pre class="kg kh ki kj gt nt ms nu nv aw nw bi"><span id="770e" class="nh kx iq ms b gy nx ny l nz oa">tf.config.list_physical_devices('GPU')</span></pre><h2 id="edbe" class="nh kx iq bd ky ni nj dn lc nk nl dp lg lx nm nn li mb no np lk mf nq nr lm ns bi translated">解决纷争</h2><p id="bc01" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">安装tensorflow时，您可能会遇到的一个最常见的问题是错误:</p><pre class="kg kh ki kj gt nt ms nu nv aw nw bi"><span id="22d5" class="nh kx iq ms b gy nx ny l nz oa">[1]    21781 illegal hardware instruction  python</span></pre><p id="e613" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这个错误是由于将<code class="fe mp mq mr ms b">tensorflow-macos</code>安装在错误的<code class="fe mp mq mr ms b">conda</code>环境中造成的。确保您已经在arm64 <code class="fe mp mq mr ms b">conda</code>环境中安装了<code class="fe mp mq mr ms b">tensoflow-macos</code>。</p><h1 id="2040" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">结论</h1><p id="4382" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">管理Python依赖关系一直很困难。M1芯片的发布只是增加了一层额外的复杂性。在行业赶上来之前，像这篇博客中详细介绍的方法这样的变通方法就足够了。</p><p id="164d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">希望这篇博客中的详细说明能让你在新的M1 MacBook上更容易地管理Python的依赖性。</p><p id="4a37" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">如果您有任何问题或疑问，请留下您的评论，我将非常乐意帮助您。</p></div></div>    
</body>
</html>