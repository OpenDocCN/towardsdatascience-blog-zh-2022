<html>
<head>
<title>Monitoring Databricks jobs through calls to the REST API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过调用REST API监控数据块作业</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/monitoring-databricks-jobs-through-calls-to-the-rest-api-4c02d7d27278#2022-10-09">https://towardsdatascience.com/monitoring-databricks-jobs-through-calls-to-the-rest-api-4c02d7d27278#2022-10-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="25cf" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">监视在Databricks生产环境中运行的作业不仅需要在出现故障时设置警报，还需要能够轻松提取有关作业运行时间、故障率、最常见故障原因和其他用户定义的KPI的统计信息。</h2></div><p id="8efe" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Databricks workspace通过其UI提供了一种非常简单直观的方式来可视化各个作业的运行历史。例如，矩阵视图允许快速查看最近的故障，并显示不同运行之间的运行时间的粗略比较。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi le"><img src="../Images/e9c9d1349e61a9ef094242e8fecb29bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1332/format:webp/1*xR2yv57K2hNVtk5vIvvadw.png"/></div><p class="lm ln gj gh gi lo lp bd b be z dk translated">作业运行，矩阵视图(图片由作者提供)</p></figure><p id="3657" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">计算失败率的统计数据或者比较不同工作之间的平均运行时间怎么样？这就是事情变得不那么简单的地方。</p><p id="aafd" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">“工作流”面板中的“作业运行”选项卡显示了过去60天内在Databricks工作区中运行的所有作业的列表。但是这个列表不能直接从UI导出，至少在编写本文时是这样。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="gh gi lq"><img src="../Images/b53b6dadae01cee400e3a4d90c3b2724.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oWYXRz_gkxHojGnBcYzOXw.png"/></div></div><p class="lm ln gj gh gi lo lp bd b be z dk translated">“工作流”面板中的“作业运行”选项卡显示了过去60天在您的工作区中运行的作业列表(图片由作者提供)</p></figure><p id="2a49" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">幸运的是，同样的信息(和一些额外的细节)可以通过调用<a class="ae lv" href="https://docs.databricks.com/dev-tools/api/latest/jobs.html" rel="noopener ugc nofollow" target="_blank"> Databricks jobs list API </a>来提取。数据以JSON格式检索，可以很容易地转换成数据帧，从中可以得出统计数据和进行比较。</p><p id="b260" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本文中，我将展示如何从运行在Databricks工作区中的Jupiter笔记本连接到Databricks REST API，提取所需的信息，并执行一些基本的监控和分析。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="5bfa" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">1.生成数据块个人访问令牌</h1><p id="c843" class="pw-post-body-paragraph ki kj it kk b kl mv ju kn ko mw jx kq kr mx kt ku kv my kx ky kz mz lb lc ld im bi translated">要连接到Databricks API，您首先需要进行身份验证，与通过UI连接时要求您进行身份验证的方式相同。在我的例子中，我将使用通过调用<a class="ae lv" href="https://docs.databricks.com/dev-tools/api/latest/tokens.html" rel="noopener ugc nofollow" target="_blank">数据块令牌API </a>生成的<a class="ae lv" href="https://docs.databricks.com/dev-tools/api/latest/authentication.html" rel="noopener ugc nofollow" target="_blank">数据块个人访问令牌</a>进行身份验证，以避免将连接信息存储在我的笔记本中。</p><p id="9386" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，我们需要通过提供请求URL、请求主体及其头来配置对令牌API的调用。在下面的例子中，我使用<a class="ae lv" href="https://docs.databricks.com/security/secrets/index.html" rel="noopener ugc nofollow" target="_blank"> Databricks secrets </a>来提取租户ID，并为Microsoft Azure托管的Databricks工作区构建API URL。资源<em class="na">2ff 814 a 6–3304–4ab 8–85cb-CD 0 e 6 f 879 C1 d</em>代表数据块的<a class="ae lv" href="https://learn.microsoft.com/en-us/azure/databricks/dev-tools/api/latest/aad/service-prin-aad-token#--get-an-azure-ad-access-token-with-the-microsoft-identity-platform-rest-api" rel="noopener ugc nofollow" target="_blank"> Azure编程ID，而应用ID和密码再次从数据块机密中提取。</a></p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="a1f6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用数据块机密来存储这种类型的敏感信息并避免直接在笔记本中输入凭据是一种很好的做法。否则，所有对<em class="na"> dbutils.secrets </em>的调用都可以替换为上面代码中的显式值。</p><p id="825f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">设置完成后，我们可以简单地使用Python的请求库调用令牌API并生成令牌。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nb nc l"/></div></figure><h1 id="fce7" class="md me it bd mf mg nd mi mj mk ne mm mn jz nf ka mp kc ng kd mr kf nh kg mt mu bi translated">2.调用数据块作业API</h1><p id="a8c8" class="pw-post-body-paragraph ki kj it kk b kl mv ju kn ko mw jx kq kr mx kt ku kv my kx ky kz mz lb lc ld im bi translated">现在我们有了个人访问令牌，我们可以配置对<a class="ae lv" href="https://docs.databricks.com/dev-tools/api/latest/jobs.html#operation/JobsList" rel="noopener ugc nofollow" target="_blank"> Databricks jobs API </a>的调用。我们需要提供Databricks实例的URL、目标API(在本例中是jobs/runs/list，用于提取作业运行的列表)和API版本(2.1是当前最新的版本)。我们使用之前生成的令牌作为API调用头中的<a class="ae lv" href="https://www.devopsschool.com/blog/what-is-bearer-token-and-how-it-works/" rel="noopener ugc nofollow" target="_blank">承载令牌</a>。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="939c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">默认情况下，从提供的偏移量开始，返回的响应被限制为最多25次运行。我创建了一个循环，根据返回响应的<em class="na"> has_more </em>属性提取完整列表。</p><h1 id="aba3" class="md me it bd mf mg nd mi mj mk ne mm mn jz nf ka mp kc ng kd mr kf nh kg mt mu bi translated">3.提取和分析数据</h1><p id="8cba" class="pw-post-body-paragraph ki kj it kk b kl mv ju kn ko mw jx kq kr mx kt ku kv my kx ky kz mz lb lc ld im bi translated">API调用将运行的作业列表作为JSON列表返回，我使用Pandas <a class="ae lv" href="https://pandas.pydata.org/docs/reference/api/pandas.json_normalize.html" rel="noopener ugc nofollow" target="_blank"> json_normalize </a>将该列表转换为Pandas数据帧。该操作将数据转换为以下格式:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/1d4895c994216cd1339a6ae3c44acc90.png" data-original-src="https://miro.medium.com/v2/resize:fit:708/format:webp/1*WTGqYAjRyYYU-4f1KGsfQA.png"/></div><p class="lm ln gj gh gi lo lp bd b be z dk translated">通过API调用检索的作业运行信息(图片由作者提供)</p></figure><p id="cae2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要在响应中包含任务和集群细节，您可以在请求参数中将<em class="na"> expand_tasks </em>参数设置为True，如<a class="ae lv" href="https://docs.databricks.com/dev-tools/api/latest/jobs.html#operation/JobsList" rel="noopener ugc nofollow" target="_blank"> API文档</a>中所述。</p><p id="2198" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">从这些信息开始，我们可以执行一些监控和分析。例如，我使用state.result_state信息来计算过去60天中失败运行的百分比:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/7c9fbed4fe9c3d5da1da9c2a214012db.png" data-original-src="https://miro.medium.com/v2/resize:fit:846/format:webp/1*oNocXQhunETinRWwwkK2Jg.png"/></div><p class="lm ln gj gh gi lo lp bd b be z dk translated">(图片由作者提供)</p></figure><p id="fca7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">可以轻松提取许多有用的统计信息，例如所有计划的数据块作业中每天失败的作业数量。通过查看列<em class="na"> state.state_message，我们可以快速了解集群为失败的作业记录的错误消息。</em></p><p id="0b45" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因为我们可以访问每次运行的开始和结束时间，所以我们可以计算作业运行时间，轻松地观察任何趋势，并尽早检测潜在的问题。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/ba7bab7157284195d3dcbd8c0ba57177.png" data-original-src="https://miro.medium.com/v2/resize:fit:914/format:webp/1*vYlxitNIvR_-XovUNNLlYg.png"/></div><p class="lm ln gj gh gi lo lp bd b be z dk translated">作为运行日期函数的作业运行时间(图片由作者提供)</p></figure><p id="05a9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦我们能够以这种易于利用的格式访问这些数据，我们想要计算的监控KPI的类型就可以取决于应用程序的类型。计算这些KPI的代码可以存储在一个笔记本中，该笔记本计划定期运行并发送监控报告。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="92d8" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">结论</h1><p id="ad59" class="pw-post-body-paragraph ki kj it kk b kl mv ju kn ko mw jx kq kr mx kt ku kv my kx ky kz mz lb lc ld im bi translated">这篇文章展示了一些Databricks作业监控的例子，这些例子可以基于通过Databricks REST API提取的信息来实现。此方法可以提供数据块工作空间中所有活动作业的总体视图，其格式可轻松用于执行调查或分析。</p></div></div>    
</body>
</html>