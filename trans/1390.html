<html>
<head>
<title>Data Validation with Great Expectations and Argo Workflows</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">满怀期望的数据验证和Argo工作流</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/data-validation-with-great-expectations-and-argo-workflows-b8e3e2da2fcc#2022-04-06">https://towardsdatascience.com/data-validation-with-great-expectations-and-argo-workflows-b8e3e2da2fcc#2022-04-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="bf81" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">远大前程来自库伯内特土著</h2></div><p id="bf29" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最近在工作中，我们一直在讨论我们梦想中的机器学习管道会是什么样子。作为背景研究，我们遇到了<a class="ae lb" href="https://greatexpectations.io/" rel="noopener ugc nofollow" target="_blank"> Great Expectations </a>包，作为我们管道中的数据验证步骤，它看起来很有希望。在这篇文章中，我将探索使用Great Expectations作为Argo工作流的一部分，在数据预处理期间运行数据验证。</p><p id="8356" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">声明:我不是专家！</strong>对我来说，这是一个学习过程，因此我在这里实施的可能不是最简化的解决方案。Great Expectations可以直接与Prefect和Dagster集成，所以理论上它更容易与这些工具一起使用。我只是喜欢阿尔戈。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lc"><img src="../Images/e81a3cf3339d5f617dcd066217183ca9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*45ZALJsLRofIm1eN"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">由<a class="ae lb" href="https://unsplash.com/@kathymacky?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">凯瑟琳·麦考马克</a>在<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="b315" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 1。设置我们的环境</strong></p><p id="352d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于这个项目，我在一个小型集群上运行所有的东西。我不打算详细介绍每个方面，我假设您已经安装了kubectl和helm 3。</p><p id="3898" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先启动您的minikube集群:</p><pre class="ld le lf lg gt lz ma mb mc aw md bi"><span id="29c5" class="me mf iq ma b gy mg mh l mi mj">minikube start --cpus 4</span></pre><p id="f76a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于其他项目，我使用4个CPU来运行我的程序，但是对于我们的例子来说，这并不是必需的，因此“CPU”参数是可选的。</p><p id="3a22" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来安装Argo工作流:</p><pre class="ld le lf lg gt lz ma mb mc aw md bi"><span id="7570" class="me mf iq ma b gy mg mh l mi mj">kubectl create ns argo<br/>kubectl apply -n argo -f https://raw.githubusercontent.com/argoproj/argo-workflows/master/manifests/quick-start-postgres.yaml</span></pre><p id="d08e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们需要等待一段时间，让一切都启动并运行起来。如果您看到一些“错误”和“CrashBackLoopOff”状态，不要担心，通常它会在5分钟内自动解决。</p><p id="b673" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">每次我安装Argo工作流时，我都喜欢运行一个示例工作流，只是为了确保前面没有错误。让我们通过端口转发访问我们的工作流用户界面。</p><pre class="ld le lf lg gt lz ma mb mc aw md bi"><span id="a32a" class="me mf iq ma b gy mg mh l mi mj">kubectl port-forward svc/argo-server 2746:2746 -n argo</span></pre><p id="ca88" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在进行到<a class="ae lb" href="https://localhost:2746." rel="noopener ugc nofollow" target="_blank"> https://localhost:2746。</a>你会收到Chrome的安全警告(幸好这不是生产系统)。你应该看到的是阿尔戈工作流程开始屏幕。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi mk"><img src="../Images/c3871086ac030b53e603efd5b5bdf97f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_Uv6T5ANflxI-KIfpfvYyA.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">图一。Argo工作流程开始屏幕。随意探索侧面板选项Argo项目真的很酷。图片作者。</p></figure><p id="732b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">单击“提交新工作流”，然后单击“使用完整工作流选项进行编辑”。它会给你一个Hello World的例子，你可以通过点击“+ Create”来运行。如果一切顺利，您应该会看到如下内容:</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi ml"><img src="../Images/5db2660a429c5777a96105443a13407e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CyKUjA8T_p30eqGZ56a7hg.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">图二。一次成功的试运行。如果您在这一点上遇到了问题，请随时留下您的评论。排除故障的最佳方法是查看pod日志。图片作者。</p></figure><p id="cdbd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们仍然需要做一些整理工作来远程访问我们的Argo服务器。奇怪的是，如果我遵循Argo的文档，它不能工作，所以这里有一个修改后的版本，可以让你从Hera提交工作流。</p><pre class="ld le lf lg gt lz ma mb mc aw md bi"><span id="12d2" class="me mf iq ma b gy mg mh l mi mj">kubectl create role hera --verb=list,update,create --resource=workflows.argoproj.io -n argo</span><span id="abd0" class="me mf iq ma b gy mm mh l mi mj">kubectl create sa hera -n argo</span><span id="3a78" class="me mf iq ma b gy mm mh l mi mj">kubectl create rolebinding hera --role=hera --serviceaccount=argo:hera -n argo</span><span id="d819" class="me mf iq ma b gy mm mh l mi mj">SECRET=$(kubectl -n argo get sa hera -o=jsonpath='{.secrets[0].name}')</span><span id="6270" class="me mf iq ma b gy mm mh l mi mj">kubectl -n argo get secret $SECRET -o=jsonpath='{.data.token}' | base64 --decode</span></pre><p id="95b3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在记下这个令牌。这样我们就有了一个Argo工作流的工作装置！下一步是让Minio实例在minikube中运行。这可以很容易地实现使用舵图表。</p><pre class="ld le lf lg gt lz ma mb mc aw md bi"><span id="5aef" class="me mf iq ma b gy mg mh l mi mj">helm repo add bitnami <a class="ae lb" href="https://charts.bitnami.com/bitnami" rel="noopener ugc nofollow" target="_blank">https://charts.bitnami.com/bitnami</a><br/>helm repo update<br/>helm install ge-minio bitnami/minio --namespace argo</span></pre><p id="0ab3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这种情况下，我选择将它安装到argo名称空间中，只是为了让自己的东西更整洁一些。最后一个命令将生成一些关于如何获得您的Minio凭证的输出。运行这些命令并将输出存储在某个地方。现在我们已经准备好创建我们的项目桶了。要检查您是否有正确的凭证，并感受一下Minio，请将它的服务进行端口转发，并导航到localhost:9001。</p><pre class="ld le lf lg gt lz ma mb mc aw md bi"><span id="5959" class="me mf iq ma b gy mg mh l mi mj">kubectl port-forward svc/ge-minio 9001:9001 -n argo</span></pre><p id="d4d0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这里，我创建了一个名为“远大前程”的桶。</p><p id="4678" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，让我们安装一个包来用python创作Argo工作流。</p><pre class="ld le lf lg gt lz ma mb mc aw md bi"><span id="f21c" class="me mf iq ma b gy mg mh l mi mj">pip install hera-workflows</span></pre><p id="473a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们设置好了！</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="4ee4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 2。管道组件</strong></p><p id="8389" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">说完这些，让我们来谈谈我们的示例数据验证管道。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/6f0340b6ed04491acf215870c791a654.png" data-original-src="https://miro.medium.com/v2/resize:fit:878/format:webp/1*i-_lah1QhewGmpKpaTDyVQ.png"/></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">图片作者。</p></figure><ol class=""><li id="9dc8" class="mo mp iq kh b ki kj kl km ko mq ks mr kw ms la mt mu mv mw bi translated"><a class="ae lb" href="https://faker.readthedocs.io/en/master/" rel="noopener ugc nofollow" target="_blank"> Faker </a>:快速生成虚假数据集的python包。</li><li id="29e9" class="mo mp iq kh b ki mx kl my ko mz ks na kw nb la mt mu mv mw bi translated"><a class="ae lb" href="http://greatexpectations.io" rel="noopener ugc nofollow" target="_blank">远大前程</a>:一个用于数据验证的python包。</li><li id="e3db" class="mo mp iq kh b ki mx kl my ko mz ks na kw nb la mt mu mv mw bi translated">Minio :类似亚马逊S3的对象存储。</li></ol><p id="2253" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这些组件中的每一个都有非常棒的文档，并且有一些博客比我能提供的更详细，但是我会涵盖对这个项目很重要的几点。</p><p id="7bb9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过Faker，我们希望生成一个熊猫数据框架的例子，它可以作为数据科学管道的输入数据。我们可以使用faker很简单地做到这一点:</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="1f37" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们有了一个数据集，其中包括带有一堆随机生成的信息的虚拟人，以及用NumPy生成的两个数字特征列。</p><p id="b518" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在是时候以编程方式从这些数据中生成期望了。我个人觉得这有点复杂，但我想我们会成功的！</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="c08b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们用煤气做饭。我们有能力生成假数据，从中创建一个验证套件，并运行该验证套件。添加Minio只是压缩/ge-store目录，并使用python SDK将文件放入我们的bucket中。在<a class="ae lb" href="https://docs.min.io/docs/python-client-quickstart-guide.html" rel="noopener ugc nofollow" target="_blank"> Minio文档</a>中提供了一个很好的概述。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="1dbb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 3。阿尔戈管道</strong></p><p id="1413" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在最后一部分，我们将使用Hera来编写和运行我们的测试管道。为了正确使用Hera，我们需要一个Docker镜像来覆盖我们所有的依赖项。为了运行我们的管道，我制作了一个简单的图像lambertsbennett/argo-ge:v1。它基于Python图像，因此非常大。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="ec13" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在让我们从编写管道1开始，以生成和存储我们的期望。</p><p id="a78f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在许多小错误之后，这里是将我们的远大前程套件作为一个tarball存储在我们的Minio bucket中的代码。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="ea04" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在让我们在第二个管道上工作，生成一些faker数据，从Minio中提取我们的验证套件，然后运行我们的数据验证。我们将重用第一个管道步骤来生成假数据，以及我们对文件io所做的大量工作。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="467f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，如果我们导航到Minio并下载我们的“ge-results.tar.gz ”,深入了解一下，我们可以看到我们数据验证工作的详细结果。在/uncommitted/data _ docs/local _ site下的归档文件中，我们可以看到一个index.html。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi ne"><img src="../Images/0f2b8464551c3e2453d9c95f24a4bae9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jgyBdHp94B72nSr12LP4Vw.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">图4。我们的巨大期望的结果。哦，不，我们失败了！图片作者。</p></figure><p id="c183" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个期望套件中有一些非常严格的规则，所以我们的验证失败了。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="12a3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我希望这是一本有趣的读物。该代码可在Github @<a class="ae lb" href="https://github.com/lambertsbennett/argo-great-expectations" rel="noopener ugc nofollow" target="_blank">https://github.com/lambertsbennett/argo-great-expectations</a>上获得。《远大前程》看似很强大，其实很复杂。幸运的是，他们的文档非常棒。在未来，我将使用基于kubernetes的栈研究更多的MLOP/数据工程/数据科学主题，并希望写更多关于它的文章。感谢您的阅读，如果您有问题或改进的想法，请留下您的评论！</p></div></div>    
</body>
</html>