<html>
<head>
<title>How to Generate Images with Stable Diffusion in Seconds, for Pennies</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在几秒钟内生成稳定扩散的图像</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-generate-images-with-stable-diffusion-for-pennies-and-the-limitations-of-this-approach-d1cd4b4a4166#2022-08-25">https://towardsdatascience.com/how-to-generate-images-with-stable-diffusion-for-pennies-and-the-limitations-of-this-approach-d1cd4b4a4166#2022-08-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="3e95" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">以及局限性(今天！)的这种方法</h2></div><p id="3d77" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一个潜在的文本到图像扩散模型<a class="ae lb" href="https://github.com/CompVis/stable-diffusion#stable-diffusion-v1" rel="noopener ugc nofollow" target="_blank">稳定扩散</a>的作者已经发布了该模型的权重，并且它在标准GPU上运行非常容易和便宜。这篇文章向你展示了如何用很少的钱生成图像(生成30-50张图像大约需要65美分)。</p><h2 id="dcda" class="lc ld iq bd le lf lg dn lh li lj dp lk ko ll lm ln ks lo lp lq kw lr ls lt lu bi translated">启动一个顶点AI笔记本</h2><p id="be93" class="pw-post-body-paragraph kf kg iq kh b ki lv jr kk kl lw ju kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">稳定扩散模型是用Pytorch编写的，如果您有超过10 GB的RAM和相当现代的GPU，它会工作得最好。</p><p id="badd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在Google Cloud上，打开链接【https://console.cloud.google.com/vertex-ai/workbench T2】进入顶点AI工作台</p><figure class="mb mc md me gt mf gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi ma"><img src="../Images/5bb0f33941e41466eb834c27b34a70c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z2eZHqU90mWz3FP02ceYqA.png"/></div></div><p class="mm mn gj gh gi mo mp bd b be z dk translated">在谷歌云中创建PyTorch笔记本</p></figure><p id="6df4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，创建一个新的顶点人工智能Pytorch笔记本电脑与英伟达特斯拉T4。接受默认值。当我做这件事的时候，这个例子的成本是每小时65美分。</p><p id="e382" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请记住，一旦使用完笔记本，请将其停止或删除。区别？如果你停止笔记本，你将被收取磁盘费(一个月几分钱，但它允许你下次更快地启动)。如果你删除了笔记本，你将不得不重新开始。在这两种情况下，您都不必为GPU付费，这是65美分/小时费用的主要部分。</p><p id="b108" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="mq">注意:</em>如果你无法访问谷歌云，找到你可以访问的带GPU的笔记本环境——也许是AWS Sagemaker，或者谷歌Colab Pro。免费的Google Colab不够强大。</p><p id="5e20" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当实例启动时，执行下一步。</p><h2 id="94a1" class="lc ld iq bd le lf lg dn lh li lj dp lk ko ll lm ln ks lo lp lq kw lr ls lt lu bi translated">注册一个拥抱脸账户</h2><p id="8970" class="pw-post-body-paragraph kf kg iq kh b ki lv jr kk kl lw ju kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">重量被释放在拥抱脸枢纽，所以你将需要创建一个帐户，并接受下重量被释放的条款。请通过以下方式完成:</p><ul class=""><li id="5f45" class="mr ms iq kh b ki kj kl km ko mt ks mu kw mv la mw mx my mz bi translated">访问<a class="ae lb" href="https://huggingface.co/" rel="noopener ugc nofollow" target="_blank">https://huggingface.co/</a>并注册一个账户。你需要它来获得重量。</li><li id="054d" class="mr ms iq kh b ki na kl nb ko nc ks nd kw ne la mw mx my mz bi translated">接受<a class="ae lb" href="https://huggingface.co/CompVis/stable-diffusion-v1-4" rel="noopener ugc nofollow" target="_blank">https://huggingface.co/CompVis/stable-diffusion-v1-4</a>的许可条款</li><li id="f368" class="mr ms iq kh b ki na kl nb ko nc ks nd kw ne la mw mx my mz bi translated">转到<a class="ae lb" href="https://huggingface.co/settings/profile" rel="noopener ugc nofollow" target="_blank">https://huggingface.co/settings/profile</a>并创建新的读取访问令牌。</li><li id="afe6" class="mr ms iq kh b ki na kl nb ko nc ks nd kw ne la mw mx my mz bi translated">将令牌复制到剪贴板。</li></ul><h2 id="6773" class="lc ld iq bd le lf lg dn lh li lj dp lk ko ll lm ln ks lo lp lq kw lr ls lt lu bi translated">克隆我的笔记本并创建token.txt</h2><p id="e37e" class="pw-post-body-paragraph kf kg iq kh b ki lv jr kk kl lw ju kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">我很方便地将本文中的代码放在了GitHub上，所以只需克隆我的笔记本:</p><figure class="mb mc md me gt mf gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/12da8406ba51017fa1a46867207fcf6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:974/format:webp/1*zpJJRQNZiU-lWXpw1pshwA.png"/></div></figure><p id="afd0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这个存储库中:</p><pre class="mb mc md me gt ng nh ni nj aw nk bi"><span id="9b40" class="lc ld iq nh b gy nl nm l nn no">https://github.com/lakshmanok/lakblogs</span></pre><p id="6a65" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并打开笔记本<a class="ae lb" href="https://github.com/lakshmanok/lakblogs/blob/main/stablediffusion/stable_diffusion.ipynb" rel="noopener ugc nofollow" target="_blank">stable diffusion/stable _ diffusion . ipynb</a></p><p id="1b6f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">右键单击导航窗格并创建一个新的文本文件。将其命名为token.txt，并将您的访问令牌(来自上一节)粘贴到该文件中。</p><h2 id="e4a6" class="lc ld iq bd le lf lg dn lh li lj dp lk ko ll lm ln ks lo lp lq kw lr ls lt lu bi translated">安装软件包</h2><p id="c178" class="pw-post-body-paragraph kf kg iq kh b ki lv jr kk kl lw ju kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">笔记本的第一个单元只是安装需要的Python包(逐个运行笔记本中的单元):</p><pre class="mb mc md me gt ng nh ni nj aw nk bi"><span id="9b3e" class="lc ld iq nh b gy nl nm l nn no">pip install --upgrade --quiet diffusers transformers scipy</span></pre><p id="3149" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用笔记本上的按钮重新启动IPython内核:</p><figure class="mb mc md me gt mf gh gi paragraph-image"><div class="gh gi np"><img src="../Images/0233b144b9d39bd6daa2bd3f2f740fa5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/1*LgETkzpOKP6b-QnheIIKbA.png"/></div></figure><h2 id="e370" class="lc ld iq bd le lf lg dn lh li lj dp lk ko ll lm ln ks lo lp lq kw lr ls lt lu bi translated">读取访问令牌</h2><p id="2fe4" class="pw-post-body-paragraph kf kg iq kh b ki lv jr kk kl lw ju kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">还记得您粘贴到token.txt中的访问令牌吗？我们来读一下:</p><pre class="mb mc md me gt ng nh ni nj aw nk bi"><span id="7473" class="lc ld iq nh b gy nl nm l nn no"><strong class="nh ir">with</strong> open('token.txt') <strong class="nh ir">as</strong> ifp:<br/>    access_token <strong class="nh ir">=</strong> ifp<strong class="nh ir">.</strong>readline()<br/>    print('Read a token of length {}'<strong class="nh ir">.</strong>format( len(access_token) ))</span></pre><h2 id="617a" class="lc ld iq bd le lf lg dn lh li lj dp lk ko ll lm ln ks lo lp lq kw lr ls lt lu bi translated">加载模型权重</h2><p id="3989" class="pw-post-body-paragraph kf kg iq kh b ki lv jr kk kl lw ju kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">要加载模型权重，请使用名为“扩散器”的拥抱面库:</p><pre class="mb mc md me gt ng nh ni nj aw nk bi"><span id="4770" class="lc ld iq nh b gy nl nm l nn no"><strong class="nh ir">def</strong> load_pipeline(access_token):<br/>    <strong class="nh ir">import</strong> torch<br/>    <strong class="nh ir">from</strong> diffusers <strong class="nh ir">import</strong> StableDiffusionPipeline<br/><br/>    model_id <strong class="nh ir">=</strong> "CompVis/stable-diffusion-v1-4"<br/>    device <strong class="nh ir">=</strong> "cuda"<br/><br/>    pipe <strong class="nh ir">=</strong> StableDiffusionPipeline<strong class="nh ir">.</strong>from_pretrained(model_id, <br/>                       torch_dtype<strong class="nh ir">=</strong>torch<strong class="nh ir">.</strong>float16, <br/>                       revision<strong class="nh ir">=</strong>"fp16", <br/>                       use_auth_token<strong class="nh ir">=</strong>access_token)<br/>    pipe <strong class="nh ir">=</strong> pipe<strong class="nh ir">.</strong>to(device)<br/>    <strong class="nh ir">return</strong> pipe</span></pre><p id="7605" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我在这里使用了一个稍微差一点的模型版本，这样它可以执行得更快。阅读<a class="ae lb" href="https://huggingface.co/CompVis" rel="noopener ugc nofollow" target="_blank"> Huggingface文档</a>了解其他选项。</p><h2 id="0006" class="lc ld iq bd le lf lg dn lh li lj dp lk ko ll lm ln ks lo lp lq kw lr ls lt lu bi translated">为文本提示创建图像</h2><p id="96fa" class="pw-post-body-paragraph kf kg iq kh b ki lv jr kk kl lw ju kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">要为文本提示创建图像，只需调用上面创建的管道，传入文本提示。</p><pre class="mb mc md me gt ng nh ni nj aw nk bi"><span id="cdf5" class="lc ld iq nh b gy nl nm l nn no"><strong class="nh ir">def</strong> generate_image(pipe, prompt):<br/>    <strong class="nh ir">from</strong> torch <strong class="nh ir">import</strong> autocast<br/>    <strong class="nh ir">with</strong> autocast("cuda"):<br/>        image <strong class="nh ir">=</strong> pipe(prompt<strong class="nh ir">.</strong>lower(), guidance_scale<strong class="nh ir">=</strong>7.5)["sample"][0]  <br/><br/>    outfilename <strong class="nh ir">=</strong> prompt<strong class="nh ir">.</strong>replace(' ', '_') <strong class="nh ir">+</strong> '.png'<br/>    image<strong class="nh ir">.</strong>save(outfilename)<br/>    <strong class="nh ir">return</strong> outfilename</span></pre><p id="c266" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这里，我传入提示“光头佬很容易被机器人打动”:</p><pre class="mb mc md me gt ng nh ni nj aw nk bi"><span id="ad4d" class="lc ld iq nh b gy nl nm l nn no">outfilename <strong class="nh ir">=</strong> generate_image(pipeline, prompt<strong class="nh ir">=</strong>"Bald guy being easily impressed by a robot")</span></pre><figure class="mb mc md me gt mf gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/4558e81ef7011f49b50e4058998c7a5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*eRKTKyGFLLH-wZ7UvlahcA.png"/></div><p class="mm mn gj gh gi mo mp bd b be z dk translated">秃子很容易被机器人打动</p></figure><p id="4103" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这花了不到一分钟的时间，对于演示文稿、故事板等来说已经足够好了。不错吧，嗯？</p><h2 id="ed5c" class="lc ld iq bd le lf lg dn lh li lj dp lk ko ll lm ln ks lo lp lq kw lr ls lt lu bi translated">仅限于其训练集</h2><p id="3c68" class="pw-post-body-paragraph kf kg iq kh b ki lv jr kk kl lw ju kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">人工智能模型受限于它们被训练的内容。让我们传递一个文化参考，它不太可能已经看到很多培训数据:</p><pre class="mb mc md me gt ng nh ni nj aw nk bi"><span id="c727" class="lc ld iq nh b gy nl nm l nn no">outfilename <strong class="nh ir">=</strong> generate_image(pipeline, prompt<strong class="nh ir">=</strong>"Robots in the style of Hindu gods creating new images")</span></pre><p id="10fa" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果呢？</p><figure class="mb mc md me gt mf gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/1f38cdbe8abe1b4a34af611f94565d72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*qCcP87afWmczh2o7Zxnrmg.png"/></div><p class="mm mn gj gh gi mo mp bd b be z dk translated">印度教神风格的机器人创造新形象</p></figure><p id="9cea" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">嗯，它选择了甘尼萨的姿势，赋予他机器般的四肢，并使用西藏转经筒作为图像。这里没有魔法——ML模型只是简单地复述他们在训练数据集中看到的一点一滴，这就是正在发生的事情。</p><p id="8764" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我在这里的文化参考是上帝搅动牛奶的海洋，它完全飞过模特的头顶:</p><figure class="mb mc md me gt mf gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi nr"><img src="../Images/39cb603eb2762f8ac2f535e3f22c7c22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iEUbOUFZ8P_0RHfK5HdBWA.png"/></div></div><p class="mm mn gj gh gi mo mp bd b be z dk translated">谷歌图片搜索了解所有关于搅拌牛奶海洋的印度创世神话</p></figure><p id="1e90" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们看看是否可以通过传递允许Google图片搜索检索所有这些图片的特定术语来明确地帮助模型唤起它的记忆:</p><pre class="mb mc md me gt ng nh ni nj aw nk bi"><span id="d844" class="lc ld iq nh b gy nl nm l nn no">outfilename = generate_image(pipeline, prompt="Robots churning the ocean of milk to create the world")</span></pre><figure class="mb mc md me gt mf gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/dad6f4481fb5553c053fdcff0f66d540.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*TZPOG2R8ScHk-VnKQH3AZA.png"/></div><p class="mm mn gj gh gi mo mp bd b be z dk translated">这看起来像是机器人搅拌牛奶的海洋吗？</p></figure><p id="1097" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">那也没用。印度教创世神话一定不是用于训练模型的数据集的一部分。</p><h2 id="6906" class="lc ld iq bd le lf lg dn lh li lj dp lk ko ll lm ln ks lo lp lq kw lr ls lt lu bi translated">其他限制</h2><p id="5685" class="pw-post-body-paragraph kf kg iq kh b ki lv jr kk kl lw ju kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">所以文化参考是过时的。还有什么？该模型不会生成真实的人脸或文字符号——我会让您尝试这些。</p><p id="1eda" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，这些仅仅是今天的限制。造成这些限制的原因是模型训练数据集的大小。很难约束一个在非常大的数据集上训练的模型不回想起不可避免会在那里发现的有毒内容。这就是为什么公开发布的模型可能是在一个较小的语料库上训练的。</p><p id="4d67" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">尽管如此，不要忽视我们在稳定扩散方面取得的进展——图像生成过去需要很大的马力。但是我们现在可以在普通的GPU和15 GB的内存上实现。这本质上是云函数的领域——你可以很容易地想象将我上面的代码放入云函数，这样它就成为一个图像生成API，并在你的应用中使用它。</p><h2 id="6dd7" class="lc ld iq bd le lf lg dn lh li lj dp lk ko ll lm ln ks lo lp lq kw lr ls lt lu bi translated">结论</h2><p id="b057" class="pw-post-body-paragraph kf kg iq kh b ki lv jr kk kl lw ju kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">最后，下面是模型生成的一些图片以及生成它的提示:</p><figure class="mb mc md me gt mf gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/49e63b52c6de2a9c4e41ce0280caa318.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*fpA9epKoe6vea6tR4pI86w.png"/></div><p class="mm mn gj gh gi mo mp bd b be z dk translated">火星漫游者玩游戏</p></figure><figure class="mb mc md me gt mf gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/3e257e11430068df3977cf474414d73d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*w-P7ORYxpbEF0sxXheycZw.png"/></div><p class="mm mn gj gh gi mo mp bd b be z dk translated">斯蒂芬·库里踢足球</p></figure><p id="2419" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你能够在几秒钟内生成与文本提示相对应的图像，这有多酷？</p><p id="6653" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我的笔记本在GitHub上的位置是<a class="ae lb" href="https://github.com/lakshmanok/lakblogs/blob/main/stablediffusion/stable_diffusion.ipynb" rel="noopener ugc nofollow" target="_blank">https://GitHub . com/lakshmanok/lak blogs/blob/main/stable diffusion/stable _ diffusion . ipynb</a></p><p id="d401" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">尽情享受吧！</p></div></div>    
</body>
</html>