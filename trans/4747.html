<html>
<head>
<title>Spark Streaming Made Easy with JupyterLab SQL Magic</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">借助JupyterLab SQL Magic简化Spark流</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/spark-streaming-made-easy-with-jupyterlab-sql-magic-53febf21d9fa#2022-10-21">https://towardsdatascience.com/spark-streaming-made-easy-with-jupyterlab-sql-magic-53febf21d9fa#2022-10-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d5cc" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">jupyterlab-sql-editor是一个jupyterlab扩展，它使执行、显示和管理Spark流查询变得轻而易举</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/827e8ca71b5036c43e296d8801b754db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oSseZD7L5iKpGTuPFKDnkA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">法迪拉·努尔哈基姆在Unsplash上拍摄的照片</p></figure><p id="ac73" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">加拿大网络安全中心(CCCS)的角色之一是计算机应急小组。在这个角色中，CCCS检测异常并尽快发布缓解措施。</p><p id="246a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在响应时间至关重要的环境中，CCCS利用<a class="ae lr" href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html" rel="noopener ugc nofollow" target="_blank"> Spark结构化流</a>和<a class="ae lr" href="https://kafka.apache.org/" rel="noopener ugc nofollow" target="_blank"> Kafka </a>事件流平台。</p><p id="dca6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在本文中，我们将演示我们对JupyterLab扩展的最新添加，<a class="ae lr" href="https://github.com/CybercentreCanada/jupyterlab-sql-editor" rel="noopener ugc nofollow" target="_blank"><em class="ls">JupyterLab-SQL-editor</em></a>，对Spark流的支持。参见我们之前的文章，<a class="ae lr" href="https://medium.com/towards-data-science/jupyterlab-sql-cell-editor-e6ac865b42df" rel="noopener"> <em class="ls">在JupyterLab </em> </a>中编写可组合的Spark SQL analytics，获得完整的特性列表以及如何安装<em class="ls"> jupyterlab-sql-editor。</em></p><h1 id="1dad" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">典型火花流API用法</h1><p id="98cf" class="pw-post-body-paragraph kv kw iq kx b ky ml jr la lb mm ju ld le mn lg lh li mo lk ll lm mp lo lp lq ij bi translated">这里有一个在笔记本中使用Spark流API的典型例子。注意<code class="fe mq mr ms mt b">.format(“memory”)</code>的用法。<code class="fe mq mr ms mt b">console </code>水槽在笔记本环境中不工作，因此我们使用<code class="fe mq mr ms mt b">memory </code>水槽，这是笔记本中一个众所周知的替代品。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mu"><img src="../Images/c0fcaf3848b1a5da3264c07c3661f398.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tw2_p73f9KPyC8KgIEUIcg.png"/></div></div></figure><p id="6aec" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了显示流式查询的结果，我们从流式查询创建的<code class="fe mq mr ms mt b">mem_results </code>表中检索数据。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mv"><img src="../Images/b65a3f8fc3249e4120a482de2d835c83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*69GyZOv-FuB-VWJ2ycPX5g.png"/></div></div></figure><h1 id="e337" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">包装样板代码</h1><p id="2482" class="pw-post-body-paragraph kv kw iq kx b ky ml jr la lb mm ju ld le mn lg lh li mo lk ll lm mp lo lp lq ij bi translated"><em class="ls"> jupyterlab-sql-editor </em>的<code class="fe mq mr ms mt b">display_df </code>函数现在能够检测到所提供的数据帧是一个流数据帧。在这种情况下，它将执行上面的所有锅炉板代码，并显示<code class="fe mq mr ms mt b">mem_results </code>表的当前结果。</p><p id="fadf" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">你所要做的就是创建一个流数据帧，并将其传递给<code class="fe mq mr ms mt b">display_df</code>。<code class="fe mq mr ms mt b">display_df </code>可以以多种格式显示结果，并显示结果的模式(形状)。</p><p id="7a80" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">除了这些特性之外，<code class="fe mq mr ms mt b">display_df </code>函数现在显示了一个与流查询相关的UI。它显示流式查询、指标和停止按钮的状态。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mw"><img src="../Images/55e137a2e71e625a49b6cf86b1663699.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*7-z8Xol92x9CtVYxREHXlQ.gif"/></div></div></figure><h1 id="f7d0" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">使用SQL</h1><p id="585f" class="pw-post-body-paragraph kv kw iq kx b ky ml jr la lb mm ju ld le mn lg lh li mo lk ll lm mp lo lp lq ij bi translated">流式数据帧可以作为临时视图。在本例中，我们创建了一个流数据帧，然后将它命名为视图<code class="fe mq mr ms mt b">uuid_events</code>。</p><p id="0f1d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">使用<code class="fe mq mr ms mt b">show tables</code>我们可以看到这个视图的存在，这意味着我们可以使用<code class="fe mq mr ms mt b">%%sparksql</code>魔法来查询它。事实上，我们还可以调用<code class="fe mq mr ms mt b">%%sparksql --refresh local</code>让<code class="fe mq mr ms mt b">%%sparksql</code>将这个视图信息存储到它的自动完成缓存中。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mx"><img src="../Images/47271f1cd68ed51f0686a55d6751a060.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k_aaezzgzdx4jWSU5OOdAA.png"/></div></div></figure><p id="7f64" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">注册了这个视图并缓存到<code class="fe mq mr ms mt b">%%sparksql</code>中，我们现在可以利用<code class="fe mq mr ms mt b">%%sparksql</code>对常规表的所有支持。这些特性包括输出模式、jinja模板、截断、限制、自动完成、格式化和语法高亮。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi my"><img src="../Images/3e7279b0a0db51ba65495bc1cc7c1b57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*JuJ0nr9eNRhWjApa9UAMaw.gif"/></div></div></figure><p id="d9b5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">记住，我们实际上是在编写一个流SQL查询。因此，任何聚合都需要绑定到一个时间窗口。有关更多详细信息，请参见<a class="ae lr" href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html" rel="noopener ugc nofollow" target="_blank"> Spark结构化流</a>指南。下面是一个流查询的例子，它计算每个字符在5秒钟的窗口中出现的次数。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mz"><img src="../Images/70203f4702ca37764aedceb797e4c27b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CbKPUkpBr-7xehLjEUv8JQ.png"/></div></div></figure><p id="df15" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">以下是现场结果。注意<code class="fe mq mr ms mt b">character </code>和<code class="fe mq mr ms mt b">count </code>与时间窗口<code class="fe mq mr ms mt b">win</code>相关联。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi na"><img src="../Images/1d9d97b87cfadadb0f4b28c427c3ce4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0CvTwY2klypFq5iRVhOf_g.png"/></div></div></figure><h1 id="cbfb" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">结论</h1><p id="e185" class="pw-post-body-paragraph kv kw iq kx b ky ml jr la lb mm ju ld le mn lg lh li mo lk ll lm mp lo lp lq ij bi translated">在本文中，我们展示了如何利用<code class="fe mq mr ms mt b"><strong class="kx ir">%%sparksql</strong></code>在Spark SQL中轻松构建流分析原型。魔术照顾了许多锅炉板代码，让您专注于您的流分析的阐述。您还可以使用由<code class="fe mq mr ms mt b">%%sparksql</code> magic支持的许多输出(文本、网格、html、json)来验证您的结果。欢迎新的功能想法和贡献！这是我们的git repo<a class="ae lr" href="https://github.com/CybercentreCanada/jupyterlab-sql-editor" rel="noopener ugc nofollow" target="_blank">cyber centre Canada/jupyterlab-SQL-editor</a>。</p></div></div>    
</body>
</html>