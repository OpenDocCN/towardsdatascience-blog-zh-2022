<html>
<head>
<title>Planning the Perfect Hike with NetworkX and OpenStreetMap</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用NetworkX和OpenStreetMap规划完美的徒步旅行</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/planning-the-perfect-hike-with-networkx-and-openstreetmap-2fbeaded3cc6#2022-08-31">https://towardsdatascience.com/planning-the-perfect-hike-with-networkx-and-openstreetmap-2fbeaded3cc6#2022-08-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/fb508b223774c58a3b560efcfe8d94eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YP9EYRJYNKFsxBnV8gyLrg.jpeg"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">从美国科罗拉多州斯诺马斯荒野的Trail Rider Pass观看(图片由作者提供)。</p></figure><div class=""/><div class=""><h2 id="48fd" class="pw-subtitle-paragraph kc je jf bd b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dk translated">如何建立一个开源的徒步旅行计划应用程序和路线优化引擎</h2></div><p id="7d45" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">任何一个狂热的徒步旅行者都会告诉你，在旅途中获得良好体验的关键是充分的准备。我应该带雨具吗？我需要在水源之间走多长时间？什么是适合地形和季节的最佳避难所？</p><p id="371f" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">最重要的问题也是最简单的——我要去哪里？</p><p id="b920" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">导游手册提供了关于某个特定公园或地区的主要景点的有用信息，但细节可能会过时或难以适应您的喜好。像<a class="ae lq" href="https://www.alltrails.com/" rel="noopener ugc nofollow" target="_blank"> AllTrails </a>这样的应用通过众包热门路线、照片和评论彻底改变了徒步旅行计划。然而，他们的许多“高级”功能，如打印地图或下载地图供离线使用的能力，需要付费订阅。此外，通过将一个复杂的步道系统提炼为几个策划好的徒步旅行，我经常感觉受到AllTrails搜索结果中列出的选项的限制。</p><p id="0777" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">因此，我开始构建自己的开源徒步规划应用和路线优化引擎，以补充专有网站的功能。在本文中，我将介绍(双关语)系统的独立组件，并展示它们如何在演示中组合在一起。只是想看看代码？点击这里查看仓库<a class="ae lq" href="https://github.com/evandiewald/trail-mapping" rel="noopener ugc nofollow" target="_blank">。</a></p><h2 id="f38d" class="lr ls jf bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">数据源</h2><p id="d452" class="pw-post-body-paragraph ku kv jf kw b kx mk kg kz la ml kj lc ld mm lf lg lh mn lj lk ll mo ln lo lp ij bi translated">说到路线规划的免费数据集，<a class="ae lq" href="https://www.openstreetmap.org/" rel="noopener ugc nofollow" target="_blank"> OpenStreetMap </a>是明确的选择。事实上，即使是<a class="ae lq" href="https://support.alltrails.com/hc/en-us/articles/360019246411-OSM-Derivative-Database-Derivation-Methodology" rel="noopener ugc nofollow" target="_blank"> AllTrails </a>也从OSM的<a class="ae lq" href="https://wiki.openstreetmap.org/wiki/Overpass_API" rel="noopener ugc nofollow" target="_blank">天桥API </a>中改编了他们的全球步道数据库，只过滤可步行的路段。</p><p id="c53f" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">使用地理空间数据的一个难点是，它有很多种文件格式，每种格式都有自己的优点和缺点。在这个项目中，我使用不同的数据结构来存储、可视化和分析踪迹地图。</p><p id="5f0f" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">对于路线规划任务，基于图的表示是有意义的；步道和道路一样，由节点(交叉点)和边(路径段)组成。这使我们能够在路线优化功能中利用像<a class="ae lq" href="https://en.wikipedia.org/wiki/Dijkstra%27s_algorithm" rel="noopener ugc nofollow" target="_blank"> Djikstra算法</a>这样的图形算法。</p><p id="10c9" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我对这个应用程序的特定组件的策略并不新鲜，因为已经有一个广泛的生态系统，其中有专门用于基于图形的路径规划的<a class="ae lq" href="https://shakasom.medium.com/routing-street-networks-find-your-way-with-python-9ba498147342" rel="noopener">教程和库</a>。像<a class="ae lq" href="https://osmnx.readthedocs.io/en/stable/" rel="noopener ugc nofollow" target="_blank"> OSMnx </a>这样的工具提供了一个高级接口，通过地理编码(例如“美国弗吉尼亚州谢南多厄国家公园”)查询OSM数据集，并将响应转换成<a class="ae lq" href="https://networkx.org/" rel="noopener ugc nofollow" target="_blank"> NetworkX </a>图形。下面是我用来下载轨迹数据并将几何信息保存为graph(为了高效计算)和GeoJSON(可视化)格式的<code class="fe mp mq mr ms b">load_map </code>函数。</p><figure class="mt mu mv mw gt is"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="be44" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">然而，规划徒步旅行路线的一个独特方面是，除了纬度和经度之外，<em class="mz">海拔</em>是设计空间的第三个重要维度。像任何好的轨迹地图一样，我们的工具应该敏锐地意识到地形特征。</p><p id="2e7c" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我的自定义高度API使用了奋进号航天飞机在2000年收集的高分辨率雷达数据。对于大约18GB的硬盘空间，<a class="ae lq" href="https://portal.opentopography.org/raster?opentopoID=OTSRTM.042013.4326.1" rel="noopener ugc nofollow" target="_blank"> SRTM GL3 </a>数据集覆盖了近1.2亿平方公里的地球陆地，增量为90m。使用<a class="ae lq" href="https://rasterio.readthedocs.io/en/latest/index.html" rel="noopener ugc nofollow" target="_blank"> rasterio </a>库，我们可以从路径段中提取高程剖面，而无需将整个地图加载到内存中:</p><figure class="mt mu mv mw gt is"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="0e8a" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">不错吧？有趣的是，<a class="ae lq" href="https://developers.google.com/maps/documentation/elevation/usage-and-billing" rel="noopener ugc nofollow" target="_blank">谷歌目前对他们的Elevation API </a>的每1000个请求收取5美元，但多亏了NASA和几行代码，我们可以免费获得同样高质量的结果。</p><h2 id="6ff0" class="lr ls jf bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">应用和用户界面</h2><p id="2b4e" class="pw-post-body-paragraph ku kv jf kw b kx mk kg kz la ml kj lc ld mm lf lg lh mn lj lk ll mo ln lo lp ij bi translated"><a class="ae lq" href="https://dash.plotly.com/introduction" rel="noopener ugc nofollow" target="_blank"> Dash </a>是我用Python构建交互式仪表盘的首选框架。通过将前端抽象为可定制的组件，它允许数据科学家专注于其用例的功能，而不是设计。由于已经有几十个优秀的Dash教程和例子，我将把重点放在我的具体应用程序的布局和逻辑上。</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi na"><img src="../Images/75057dd35bc014520b511c03814be155.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cBnEciXYRN2aYyYHh53r0g.png"/></div></div></figure><p id="18b2" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">如你所料，用户界面聚焦在地图上，它利用了Mapbox的<a class="ae lq" href="https://www.mapbox.com/maps/outdoors" rel="noopener ugc nofollow" target="_blank">地形</a> tileset。下拉菜单允许您从缓存的路径系统中进行选择，或者您可以通过地理编码下载新的路径系统。</p><figure class="mt mu mv mw gt is"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="a4c0" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">一旦选择了一个区域，就可以使用<a class="ae lq" href="https://dash-leaflet.herokuapp.com/" rel="noopener ugc nofollow" target="_blank"> dash-leaflet </a>库来可视化OSM踪迹网络。当您计划的路线在二维地图上具体化时(下一节将详细介绍)，相应的高程剖面将实时绘制。</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nb"><img src="../Images/d05b6b5aeaf3f676055726887b678c0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*elGWKRksKGfw9QC7MEGGuw.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">查看围绕旧Rag山的所有3个维度的循环。在谢南多厄国家公园(图片由作者提供)。</p></figure><h2 id="f30b" class="lr ls jf bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">路线规划引擎</h2><p id="cc18" class="pw-post-body-paragraph ku kv jf kw b kx mk kg kz la ml kj lc ld mm lf lg lh mn lj lk ll mo ln lo lp ij bi translated">我的应用程序允许用户使用两种“模式”中的一种来计划他们的徒步旅行。在“自定义”模式下，你只需点击地图上的十字路口，就能看到你的路线栩栩如生，一次一段。在幕后，我们尝试使用最短路径算法智能地连接各个点。在下面的动画中，我们看到一条用户定义的路线在凯霍加国家公园成形。</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nc"><img src="../Images/abaf472460623369abedce6e53cb3d90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*QjsvC7Vhj2dyRjwAIidZYQ.gif"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">点击凯霍加国际公园的一条路线(图片由作者提供)。</p></figure><p id="8f4d" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">自动模式更有趣一点。我的目标是创建一个约束优化函数，它考虑了我在规划循环时要寻找的主要因素:</p><ul class=""><li id="d9c8" class="nd ne jf kw b kx ky la lb ld nf lh ng ll nh lp ni nj nk nl bi translated">仰角增益</li><li id="84b7" class="nd ne jf kw b kx nm la nn ld no lh np ll nq lp ni nj nk nl bi translated">距离</li><li id="239e" class="nd ne jf kw b kx nm la nn ld no lh np ll nq lp ni nj nk nl bi translated">穿越尽可能多的独特路线(例如，在徒步旅行中的多个地点，最大限度地减少原路返回的次数)</li></ul><p id="c83d" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">数学上，最佳回路将满足以下条件:</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/0e78978dba6a0a8ddfa0e44377a44030.png" data-original-src="https://miro.medium.com/v2/resize:fit:790/format:webp/0*rkUNAe2ZjKm0I_CO.png"/></div></figure><p id="5fcd" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">其中<em class="mz"> P </em>是路径，<em class="mz"> d(P) </em>是路径距离，<em class="mz"> D </em>是目标距离，<em class="mz"> r(P) </em>是唯一的遍历节点的分数(例如，一次往返的r值为0.5)，<em class="mz"> e(P) </em>是路径的仰角增益，<em class="mz"> E </em>是目标仰角增益。</p><p id="5035" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">遍历循环图来寻找可用的循环也是一项重要的任务。最后，我选择了一种结合了<a class="ae lq" href="https://networkx.org/documentation/stable/reference/algorithms/generated/networkx.algorithms.shortest_paths.generic.shortest_path.html#networkx.algorithms.shortest_paths.generic.shortest_path" rel="noopener ugc nofollow" target="_blank">最短路径</a>和<a class="ae lq" href="https://networkx.org/documentation/stable/reference/algorithms/generated/networkx.algorithms.cycles.simple_cycles.html#networkx.algorithms.cycles.simple_cycles" rel="noopener ugc nofollow" target="_blank">简单循环</a>的方法，这些路径不包含任何重复节点。</p><figure class="mt mu mv mw gt is"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="dc69" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">点击轨迹交叉点附近的地图定义了<code class="fe mp mq mr ms b">find_best_loop</code>功能的根节点，即循环的终点。这使得用户能够自动生成在关键位置开始和结束的徒步旅行，比如停车场或小路。下面，该算法建议在谢南多厄国家公园的旧拉格山进行一次严格的跋涉，以满足所提供的约束。</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nc"><img src="../Images/7bb9bc15d9cee46acdccaa4bfe3089cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*kL9RxLFlusWpZEasTe8Vwg.gif"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">使用路线优化引擎和用户定义的约束来自动生成完美的循环(图片由作者提供)。</p></figure><p id="907c" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">关于计算累积仰角增益的一个有趣的旁白——令人惊讶的是，没有明确的数学定义。你可以想象，如果你包括每一段正斜率，即使相对平坦，但崎岖不平的道路可能会导致显着的海拔变化。关键是通过添加一个<a class="ae lq" href="https://github.com/evandiewald/trail-mapping/blob/c0255e3c7766e211b099a399735dcc812af72702/mapping_utils.py#L101" rel="noopener ugc nofollow" target="_blank">滚动阈值</a>(一个用户定义的超参数)来平滑曲线，如这篇<a class="ae lq" href="https://www.gpsvisualizer.com/tutorials/elevation_gain.html" rel="noopener ugc nofollow" target="_blank">文章</a>中所述。</p><h2 id="3f4c" class="lr ls jf bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">将路径导出到导航工具</h2><p id="d871" class="pw-post-body-paragraph ku kv jf kw b kx mk kg kz la ml kj lc ld mm lf lg lh mn lj lk ll mo ln lo lp ij bi translated">一旦你计划了一次完美的徒步旅行，你会想把它导出为一种定向运动友好的格式。对于硬拷贝版本，可以直接从用户界面打印地图和高程剖面图。</p><p id="57e7" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">然而，用户也可以将他们的路线导出为GPX文件(另一种地理空间格式)，并上传到AllTrails、Gaia、谷歌地图和其他GPS跟踪应用程序。</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nc"><img src="../Images/94b1829db99846260f1021258af2b868.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*Jx9szPJYYO60eLeskWd2vQ.gif"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">将路线导出为GPX文件并上传到AllTrails(图片由作者提供)。</p></figure><p id="43e2" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">现在，你可以通过手机导航你的定制路线，就像任何其他策划的AllTrails远足一样！</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ns"><img src="../Images/222153c2b8e72c3e3c0ffc66858b3096.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a7gOgej7Ih2Y5gJnMaCelQ.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">利用AllTrails的移动应用程序来跟踪我的定制徒步旅行(图片由作者提供)。</p></figure><h2 id="8272" class="lr ls jf bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">包扎</h2><p id="3d5e" class="pw-post-body-paragraph ku kv jf kw b kx mk kg kz la ml kj lc ld mm lf lg lh mn lj lk ll mo ln lo lp ij bi translated">在这个演示中，我们利用来自OSM和NASA的开源地理数据集构建了一个实用的徒步旅行计划应用程序。使用图论、数值分析和领域专业知识的组合，我们提出了一个数学上合理的路线优化引擎，以自动找到满足各个目标的完整回路。</p><p id="0e67" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我期待着不断改进UI和底层算法。如果你想自己运行代码，可以在<a class="ae lq" href="https://github.com/evandiewald/trail-mapping" rel="noopener ugc nofollow" target="_blank"> Github </a>上查看完整的库。</p><h2 id="0833" class="lr ls jf bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">参考</h2><p id="ff83" class="pw-post-body-paragraph ku kv jf kw b kx mk kg kz la ml kj lc ld mm lf lg lh mn lj lk ll mo ln lo lp ij bi translated">王高·a·哈格伯格、丹尼尔·a·舒尔特和彼得·j·斯沃特，<a class="ae lq" href="http://conference.scipy.org/proceedings/SciPy2008/paper_2/" rel="noopener ugc nofollow" target="_blank">“使用NetworkX探索网络结构、动力学和功能”</a>，载于<a class="ae lq" href="http://conference.scipy.org/proceedings/SciPy2008/index.html" rel="noopener ugc nofollow" target="_blank">第七届Python科学大会会议论文集(SciPy2008) </a>，格尔·瓦洛夸、特拉维斯·沃特和贾罗德·米尔曼(编辑)，(美国加利福尼亚州帕萨迪纳)，第11–15页，2008年8月</p><p id="115f" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">地图数据版权归OpenStreetMap贡献者所有，可从<a class="ae lq" href="https://www.openstreetmap.org/" rel="noopener ugc nofollow" target="_blank">https://www.openstreetmap.org</a>获得</p><p id="da4c" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">美国航天局航天飞机雷达地形学任务(SRTM)(2013年)。航天飞机雷达地形学任务(SRTM)全球。由OpenTopography分发。https://doi.org/10.5069/G9445JDF.访问时间:2022–08–30</p></div></div>    
</body>
</html>