<html>
<head>
<title>Deploy Lambdas fast with AWS CodePipeline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS代码管道快速部署Lambdas</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploy-lambdas-fast-with-aws-codepipeline-f90b0bf5ca64#2022-05-19">https://towardsdatascience.com/deploy-lambdas-fast-with-aws-codepipeline-f90b0bf5ca64#2022-05-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="42cb" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用于在AWS上部署代码变更的连续部署管道</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/14e972fec6ee90e00ff6df98792a2f52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*z8hnmTqBnBf0dc7K"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">迈克·本纳在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="4bb1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">建立一个好的软件发布渠道很重要，这有很多原因。如果没有建立管道，程序员通常会花更多的时间测试和部署代码，而不是进行改进。理想情况下，我们希望将代码推送到我们的存储库中，让管道负责打包、测试和发布对我们环境的更改。</p><p id="567c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在AWS上，CodePipeline是一种直接的软件发布服务。使用CodePipeline，您可以定义一组在AWS上运行的阶段，每个阶段都包含按指定顺序运行的操作。如果你曾经使用Jenkins来构建管道，那么这可能听起来很熟悉。</p><p id="7128" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我将为您提供一个使用AWS代码管道部署Lambda的设置。我们将使用CloudFormation和CodeBuild等其他AWS服务的组合，因此如果您对AWS完全陌生，您会希望用其他资源来补充这篇文章，以使事情真正有意义。</p><p id="3b8c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下是我们将涉及的所有内容:</p><ul class=""><li id="a35d" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">将Github存储库连接到AWS</li><li id="7fd1" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">创建服务角色</li><li id="08a0" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">使用AWS Cloudformation部署管道</li><li id="00b4" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">为代码构建准备buildspec文件</li><li id="7548" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">为你的Lambda准备一个云模板</li><li id="6d41" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">使用代码管道部署Lambda</li></ul><p id="2b38" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们开始吧。我假设您已经建立了一个git存储库，其中包含您的Lambda代码。</p><h1 id="09c4" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">将存储库连接到AWS</h1><p id="7b7c" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">如果您正在使用Github，您必须在AWS和您的存储库之间创建一个连接，以便每当有新的代码更改时，您的管道可以得到通知。为此，请转到AWS控制台上的AWS Codepipeline，单击“设置”下的“连接”并创建一个连接。这将打开一个向导，您将选择Github作为您的提供商，给你的连接一个名称，然后它将要求您通过一个Github弹出窗口授权您的连接。完成后，您将在connections下看到一个新的连接，它有自己的ARN，我们稍后将在管道中使用。</p><h1 id="7e94" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">创建服务角色</h1><p id="1e1a" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">为此，我们将使用AWS CodePipeline、CodeBuild和CloudFormation。我们需要创建一个服务角色，为每个服务授予代表您访问其他服务的权限。例如，服务角色将授予CodeBuild将您的代码上传到S3的权限。让我们使用aws cli为每个角色创建服务角色。</p><p id="c484" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将下列信任策略保存在3个单独的文件夹中。每个服务的json文件。对于每个文件，使用“cloudformation.amazonaws.com”、“codepipeline.amazonaws.com”、“codebuild.amazonaws.com”更改突出显示的服务块</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="42bc" class="nl mk it nh b gy nm nn l no np">{<br/>  "Version": "2012-10-17",<br/>  "Statement": [<br/>    {<br/>      "Effect": "Allow",<br/>      "Principal": {<br/>        "Service": <strong class="nh iu">[SERVICE]</strong><br/>      },<br/>      "Action": "sts:AssumeRole"<br/>    }<br/>  ]<br/>}</span></pre><p id="4077" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于每个服务，创建一个服务角色并记下ARN。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="d271" class="nl mk it nh b gy nm nn l no np">aws iam create-role --role-name role-example --assume-role-policy-document file://[your-file-for-each-trust-policy].json</span></pre><p id="1720" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在您已经创建了三个角色，每个角色都可以控制您为其赋予信任策略的服务，但是它们没有访问其他服务的权限。让我们通过将内联策略附加到角色来授予这些权限。下面是一个简单的内联策略，它将为您的服务提供对任何服务的任何操作的权限。这不是一个好的做法，所以您需要在以后缩小范围，只对它需要的资源执行操作。</p><p id="2185" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将这个内联策略存储在一个. json文件中。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="7bd7" class="nl mk it nh b gy nm nn l no np">{<br/>  "Version": "2012-10-17",<br/>  "Statement": [<br/>    {<br/>      "Action": "*",<br/>      "Effect": "Allow",<br/>      "Resource": "*"<br/>    }<br/>  ]<br/>}</span></pre><p id="5b72" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将该政策应用于您的每个角色，如下所示:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="5a47" class="nl mk it nh b gy nm nn l no np">aws iam put-role-policy --role-name role-example --policy-name policy-example --policy-document file://[your-policy-file].json</span></pre><h1 id="c33d" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">部署具有云结构的管道</h1><p id="a061" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated"><a class="ae ky" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/Welcome.html" rel="noopener ugc nofollow" target="_blank"> AWS CloudFormation </a>帮助我们设置和管理我们帐户中的资源。yaml文件，这样我们就不必手动提供每个资源。下面我粘贴了将部署管道和构建项目的模板。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="d3ba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">cloudformation模板有几个主要组件。这里有两个——参数和资源。参数是资源的输入。资源是我们想要部署的AWS服务的定义。该模板部署两种资源:CodeBuild和CodePipeline。</p><p id="a94d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们来分解一下我们的渠道阶段:</p><ul class=""><li id="3b3e" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">源代码阶段:连接到您的代码库并获取代码更改</li><li id="839f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">构建阶段:使用Codebuild项目为Lambda安装python依赖项，并为Lambda资源打包Cloudformation脚本</li><li id="a26d" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">开发阶段:部署前一阶段打包的Cloudformation脚本</li></ul><p id="6607" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦我们通过CloudFormation部署了模板，它将自动提供和管理构建项目和管道。如果您在控制台上进入CloudFormation并找到一个包含您的资源的新堆栈，您将能够看到资源已部署。</p><p id="62e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在部署模板之前，创建一个S3存储桶，并将模板文件上传到存储桶中的某个位置。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="cb25" class="nl mk it nh b gy nm nn l no np">aws s3api create-bucket --bucket bucket-example</span></pre><p id="32f8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，我们需要一个. json文件来存储模板中的参数值。复制这个。json文件，并用您之前创建的参数值替换这些参数值。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="1dc1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后部署模板:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="553a" class="nl mk it nh b gy nm nn l no np">aws cloudformation create-stack --stack-name stack-example --template-url [your-s3-template-location] --parameters file://[your-param-file.json]</span></pre><p id="1230" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您应该会在CloudFormation中看到一个用于管道和构建项目的新堆栈。如果导航到CodePipeline，您还会看到一个名为“lambda-pipeline”的管道。管道将显示上面讨论的阶段。现在，每当您的存储库中有代码变更时，它将自动通过管道运行。管道将在部署阶段失败，因为我们的构建项目找不到buildspec文件。</p><h1 id="b66e" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">为代码构建准备buildspec文件</h1><p id="10e1" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">一个<a class="ae ky" href="https://docs.aws.amazon.com/codebuild/latest/userguide/build-spec-ref.html" rel="noopener ugc nofollow" target="_blank"> buildspec文件</a>包含一组在软件发布期间测试和打包代码时应该运行的命令。一个例子是为你的Lambda安装依赖项。这些命令被分成几个阶段，如pre_build、build、post_build和outputs。查看链接的参考页面，了解所有阶段的更多信息。</p><p id="87e3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">管道的工作是将工件从前一个阶段移动到下一个阶段。在我们的例子中，管道将它在源代码阶段获取的代码库移动到构建阶段的代码构建项目中。工件由管道模板中的输入工件和输出工件指定。构建项目的输入工件将是我们的源代码。默认情况下，它位于构建容器的$CODEBUILD_SRC_DIR目录中。</p><p id="942b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们构建项目的目的是从requirements.txt文件安装Lambda的所有依赖项(我假设是python Lambda)，准备另一个描述Lambda的cloudformation模板，并将该模板作为输出工件返回到构建项目。下面是buildspec的样子。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="de14" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">cfn.yaml文件是Lambda的cloudformation模板。让我们也创造它。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="f0e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个模板中，我们有两个资源，一个Lambda角色和一个Lambda函数。Lambda函数包含代码和处理程序属性，指向Lambda文件和处理程序函数的目录。buildspec文件中的cloudformation package命令将打包来自这个源代码(包括已安装的依赖项)的代码，将包上传到命令中指定的S3位置，并将模板中的代码位置替换为S3的位置。然后，它将返回一个新的模板文件，其名称在$TEMPLATE_FILE_NAME环境变量中指定。这是我们将指定为部署阶段的输出工件的文件，用于使用Cloudformation进行部署。</p><p id="67d4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">buildspec文件中的输出还指定了一个config.json文件。该文件将包含cloudformation模板中任何参数的值。作为示例，我们添加了一个名为S3ArtifactStore的参数，因此config.json会:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="113f" class="nl mk it nh b gy nm nn l no np">{<br/> "Parameters": {<br/>  "S3ArtifactStore": "your-s3-bucket-name"<br/> }<br/>}                                                           </span></pre><p id="809b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在您已经创建了这些文件，推动更改以查看您的管道启动。一旦管道成功运行，您将在CloudFormation中看到一个名为“lambda-stack”的lambda新堆栈，并在AWS Lambdas中看到一个新的Lambda。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/ed7188c9a4a3aa52a237044714057159.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NnwAT6R80JSfqRLqfw1jUw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">AWS代码管道</p></figure><p id="934c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您已经使用自动化发布过程成功地部署了Lambda。您所做的任何进一步的代码更改都将直接更新AWS上的Lambda，因此您不必浪费任何时间来手动部署您的更改。</p><p id="8f5a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">仅仅遵循这个指南应该可以帮助你成功地建立一个管道，但是如果你是这些服务的新手，那么你会发现我的解释在很多阶段都是欠缺的。最好的理解方法是查看每个阶段的AWS指南。与此同时，我可能会写更多的指南来更深入地研究所使用的一些服务，并将它们链接到这里。</p></div></div>    
</body>
</html>