<html>
<head>
<title>3 Time-Saving BigQuery Features</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">3个省时的BigQuery特性</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/3-time-saving-bigquery-features-6433ba794e27#2022-09-20">https://towardsdatascience.com/3-time-saving-bigquery-features-6433ba794e27#2022-09-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3f51" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">编写更高效的查询并加快分析速度</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/6b31e8df70d8e3ee1c1adb69563c5076.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YxBRUnHoGIwt6jAHc4-lqw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@tvick?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">泰勒维克</a>在<a class="ae ky" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><h1 id="ed5e" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">介绍</h1><p id="bd65" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">BigQuery是最流行的基于云的数据仓库平台之一。虽然它的主要功能是存储、管理和分析数据，但它的真正威力在于一组奇妙的内置功能，这些功能可用于从数据工程到数据科学的整个数据领域。</p><p id="565d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在过去几年的数据分析师工作中，我发现了一组有价值的特性和函数，它们帮助我编写了更高效的查询并增强了我的即席分析。</p><p id="e254" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这里有三个必须知道的BigQuery特性和函数，它们将为您的数据之旅节省一些宝贵的时间。</p><h1 id="e85d" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">时间旅行</h1><p id="f447" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">"我希望我能回到过去。"谁没想过至少一次？BigQuery在某种程度上让这成为可能。</p><p id="44f4" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">为了演示到目前为止似乎不可能的事情，让我们以BigQuery中的<code class="fe ms mt mu mv b">sales</code>表为例，该表每天更新前一天的数据，并直接输入到您的<strong class="lt iu">销售仪表板中。</strong></p><p id="de1f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">今天是2022年9月1日，你正在查看你的<strong class="lt iu">销售仪表板</strong>，你注意到与昨天相比，两天前的8月30日销售量下降了。您的第一反应是使用以下查询在BigQuery中查看当天的原始数据:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi my"><img src="../Images/3eb8918c01bb9e6fc393cfea886c68a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iGsJQsBMwyTlzomMYDQueg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">查询结果(作者图片)</p></figure><p id="93b4" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">您的查询结果仅确认您在<strong class="lt iu">销售仪表板</strong>上看到的内容。但是当你昨天看着同一个仪表板时，你确信你的销售量更高。</p><p id="d9ae" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">使用BigQuery中的<code class="fe ms mt mu mv b">FOR SYSTEM_TIME AS OF</code>子句，可以在特定时间点查询您的<code class="fe ms mt mu mv b">sales</code>表，并确认您最初的假设。该功能的工作原理如下:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/685c65147d1acb60dda40d97211ae924.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jZlsQX9I_lmpUDwFS2aa6g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">BigQuery时间旅行图解(图片由作者提供)</p></figure><p id="e255" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">例如，以下查询将返回24小时前<code class="fe ms mt mu mv b">sales</code>表的历史版本:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi na"><img src="../Images/6b4bf0d326469981b536b069902a2e90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YqLRm4lJW2NxweIVfckwOA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">查询结果(作者图片)</p></figure><p id="fd03" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">通过时光倒流，你已经确认了你的销售数字从一天到另一天发生了变化。你的商品<strong class="lt iu"> <em class="nb"> A_0044 </em> </strong>的销售额从387降到了0。看起来问题来自数据接收。你现在可以开始在那个方向缩小范围了。</p><p id="64de" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">当您需要检查旧版本的表或监控可能的数据摄取问题时，使用BigQuery进行时间旅行会很方便，如上例所示。</p><h1 id="5934" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">临时表</h1><p id="fbec" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">BigQuery中另一个强大的概念是临时表。BigQuery中的所有查询结果都自动存储在临时表中，供以后的分析使用。这对于在运行即席分析时使您的代码更加整洁非常有帮助。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/72527f89c37ab04fabdc8105a44a7c01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gV4D8deJWWCaXvC4Y7wEBw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图解的BigQuery临时表(图片由作者提供)</p></figure><p id="a238" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">为了说明这个概念，让我们使用下面的查询示例，从您的<code class="fe ms mt mu mv b">sales</code>和<code class="fe ms mt mu mv b">users</code>表中返回每天的<strong class="lt iu"> total_sales </strong>和<strong class="lt iu"> total_unique_users </strong>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi my"><img src="../Images/f175b541a3b88b6630196b052f527314.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JWitTAfcPTzqRTrtSW-oDQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">查询结果(作者图片)</p></figure><p id="3afe" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这个查询工作得很好，但是为了更容易阅读，您可以将<code class="fe ms mt mu mv b">sales</code>和<code class="fe ms mt mu mv b">users</code>cte(公共表表达式)的结果保存在BigQuery的临时表中。</p><p id="46fd" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">为此，在两个大查询选项卡中分别运行<code class="fe ms mt mu mv b">sales</code>和<code class="fe ms mt mu mv b">users</code>查询(cte)<strong class="lt iu"/>，并遵循以下步骤:</p><p id="f3ea" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在BigQuery <strong class="lt iu">查询结果</strong>窗口中，选择:</p><ol class=""><li id="4199" class="nc nd it lt b lu mn lx mo ma ne me nf mi ng mm nh ni nj nk bi translated"><strong class="lt iu">工作信息</strong></li><li id="d281" class="nc nd it lt b lu nl lx nm ma nn me no mi np mm nh ni nj nk bi translated"><strong class="lt iu">目的地表</strong></li><li id="ec32" class="nc nd it lt b lu nl lx nm ma nn me no mi np mm nh ni nj nk bi translated"><strong class="lt iu">临时表</strong></li></ol><p id="8caf" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这将打开一个新的BigQuery窗口，查询结果存储在一个名为randomly的临时表中。对于这个例子，让我们假设这两个临时表被命名为<code class="fe ms mt mu mv b">temporary_sales</code>和<code class="fe ms mt mu mv b">temporary_users</code>。</p><p id="bc44" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">然后，您可以在查询中使用这些新创建的临时表:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi my"><img src="../Images/f175b541a3b88b6630196b052f527314.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JWitTAfcPTzqRTrtSW-oDQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">查询结果(作者图片)</p></figure><p id="ddfb" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这个最终查询将返回与原始查询相同的结果，除了它已经从30行减少到只有8行，使得它更容易阅读和操作。</p><p id="2652" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">当在即席分析中运行多个查询(有时是大量查询)时，这个BigQuery特性特别有用。</p><h1 id="25ae" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">过滤窗口函数</h1><p id="b38a" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">窗口函数(也称为分析函数)用于计算一组特定行的值，为每一行返回一个结果。</p><p id="c885" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">当您需要计算移动平均值、累积和，甚至对数据进行排序时，这些函数特别有用。</p><p id="c547" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">为了展示它们的威力，让我们使用<code class="fe ms mt mu mv b">ROW_NUMBER</code> BigQuery函数对<code class="fe ms mt mu mv b">sales</code>表中的每一行进行排序，按国家进行分区，并按销售额降序排列:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi na"><img src="../Images/bb19e0d1f1b7c452927a208fcbaf0b80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8CxT5leqlbilmXaP75UFAA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">查询结果(作者图片)</p></figure><p id="7166" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">然而，大多数时候，您需要过滤查询结果。在这种情况下，我们希望只保留每个国家销售额最高的行— <code class="fe ms mt mu mv b">WHERE rank = 1</code>。</p><p id="1aef" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">您的第一个猜测可能是在<code class="fe ms mt mu mv b">WHERE</code>子句中添加上述条件——您可能是对的。然而，您将在查询结果中得到以下错误消息。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/b712b43ecbb0b1c1401b78264d512345.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kGpdryqMu7ogjq11kaK4Pw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">BigQuery错误消息(图片由作者提供)</p></figure><p id="7d39" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这是不言自明的；在<code class="fe ms mt mu mv b">WHERE</code>子句中不允许使用窗口函数。</p><p id="1a39" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">要解决这个问题，第一个解决方案是在CTE中添加原始查询，并在下面的最终查询中过滤出结果，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi na"><img src="../Images/dae78a046c959ac915136194457fb902.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o7JuAraCOpYIYD6m3Tgx7w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">查询结果(作者图片)</p></figure><p id="a247" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">那很完美，对吧？然而，BigQuery提供了一个更加优雅的解决方案来过滤窗口函数的结果，它不会让您的代码负担过重。通过使用<code class="fe ms mt mu mv b">QUALIFY</code>子句，您可以去掉CTE，最终得到完全相同的结果。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi na"><img src="../Images/dae78a046c959ac915136194457fb902.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o7JuAraCOpYIYD6m3Tgx7w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">查询结果(作者图片)</p></figure><p id="cbb6" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">很棒，对吧？您的查询已经从十八行代码减少到只有七行代码。</p><p id="7a19" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">SQL窗口函数非常强大，知道如何操作它们的结果将允许您编写更干净、更高效的代码。</p><h1 id="6f50" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">结论</h1><p id="63e5" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">这些只是我经常使用的三个最有用的BigQuery特性。利用它们，您不仅可以编写更高效的查询，还可以在进行下一次分析时节省宝贵的时间。</p><p id="7dd2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在轮到你了。<strong class="lt iu">您最常用的BigQuery特性是什么？</strong>不要犹豫，分享你的。</p></div><div class="ab cl nr ns hx nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="im in io ip iq"><h1 id="af8b" class="kz la it bd lb lc ny le lf lg nz li lj jz oa ka ll kc ob kd ln kf oc kg lp lq bi translated">参考</h1><p id="a657" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">[1] BigQuery，<a class="ae ky" href="https://cloud.google.com/bigquery/docs/time-travel" rel="noopener ugc nofollow" target="_blank">使用时间旅行访问历史数据</a> (2022)，谷歌云</p><p id="fb2a" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">[2] BigQuery，<a class="ae ky" href="https://cloud.google.com/bigquery/docs/writing-results" rel="noopener ugc nofollow" target="_blank">编写查询结果</a> (2022)，谷歌云</p><p id="c046" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">[3] BigQuery，<a class="ae ky" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/query-syntax#qualify_clause" rel="noopener ugc nofollow" target="_blank">查询语法— QUALIFY子句</a> (2022)，谷歌云</p></div></div>    
</body>
</html>