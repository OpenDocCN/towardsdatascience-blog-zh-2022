<html>
<head>
<title>Predicting Heart Disease with PySpark</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用PySpark预测心脏病</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/predicting-heart-disease-with-pyspark-5a871286946e#2022-02-15">https://towardsdatascience.com/predicting-heart-disease-with-pyspark-5a871286946e#2022-02-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="a8b0" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">PySpark二进制分类教程</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/1bd48577bf88197113bb1029fc2b120e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*32hOWOLnfUYtvWchWP8PEA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片来自<a class="ae kv" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae kv" href="https://unsplash.com/@averey" rel="noopener ugc nofollow" target="_blank"> Robina Weermeijer </a></p></figure></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="e34e" class="ld le iq bd lf lg lh li lj lk ll lm ln jw lo jx lp jz lq ka lr kc ls kd lt lu bi translated"><strong class="ak">简介</strong></h1><p id="321e" class="pw-post-body-paragraph lv lw iq lx b ly lz jr ma mb mc ju md me mf mg mh mi mj mk ml mm mn mo mp mq ij bi translated">本指南将从头到尾向您展示如何构建和运行PySpark二元分类模型。</p><p id="992a" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">这里使用的数据集是来自<a class="ae kv" href="https://archive.ics.uci.edu/ml/datasets.php" rel="noopener ugc nofollow" target="_blank"> UCI机器学习库</a>的<a class="ae kv" href="https://archive.ics.uci.edu/ml/datasets/heart+disease" rel="noopener ugc nofollow" target="_blank">心脏病</a>数据集。阿尔，1988)。如果在出版物中使用，关于该数据集的唯一说明/许可信息是引用作者。这是一个二元分类数据集。我们今天将使用PySpark来构建各种分类模型。</p><p id="79c1" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">我最近发布了这个指南，展示如何从本地计算机连接Jupyter笔记本会话到Linux托管的Apache Spark独立集群。</p><p id="3eec" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">今天，我还将向您展示如何在您的本地Mac笔记本电脑上设置并连接到一个独立的集群，供那些无法访问虚拟机的人使用。当然，在Mac上启动本地PySpark会话可能更容易，而不需要设置集群。但是，如果您想将Mac用作主节点并添加工作节点，这将向您展示如何操作。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="1c70" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">设置独立集群</strong></p><ol class=""><li id="8044" class="mw mx iq lx b ly mr mb ms me my mi mz mm na mq nb nc nd ne bi translated">转到Mac终端窗口中的%SPARK_HOME%文件夹，并运行:</li></ol><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="c558" class="nk le iq ng b gy nl nm l nn no">./sbin/start-master.sh</span></pre><p id="2e13" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">2.在另一个终端窗口中，转到%SPARK_HOME%文件夹并运行:</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="cb31" class="nk le iq ng b gy nl nm l nn no">./sbin/start-worker.sh spark://ip:port</span></pre><p id="0d26" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">您可以使用相同的策略将网络上的任何工作节点添加到主节点。</p><p id="58f5" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">注意:启动主节点后，如果在浏览器中转到http://localhost:8080，就可以获得spark://ip:port。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="24ec" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">设置Jupyter笔记本</strong></p><ol class=""><li id="f97c" class="mw mx iq lx b ly mr mb ms me my mi mz mm na mq nb nc nd ne bi translated">在Mac上的另一个终端窗口中运行:</li></ol><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="8e3f" class="nk le iq ng b gy nl nm l nn no">jupyter notebook </span></pre><p id="6f05" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">这将在浏览器中打开一个Jupyter笔记本会话。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="9976" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">将Jupyter笔记本连接到Spark集群。</strong></p><p id="bb82" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">1.在Jupyter笔记本中打开一个新的Python 3内核并运行:</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="012c" class="nk le iq ng b gy nl nm l nn no">import pyspark<br/>import findspark<br/>from pyspark import SparkConf, SparkContext<br/>from pyspark.sql import SQLContext<br/>from pyspark.sql.types import *<br/>from pyspark import SparkConf, SparkContextfindspark.init('/path_to_spark/spark-3.1.2-bin-hadoop3.2') <br/>#The key here is putting the path to the spark download on your Mac<br/>VM.sc=pyspark.SparkContext(master='spark://ip:port',appName='Heart_Disease_Example')<br/>#Use the same 'spark://ip:port' from connecting the worker(s) to the master node. <br/>spark = SQLContext(sc)<br/>spark</span></pre><p id="eb82" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">现在我们连接到我们的火花簇。开始建模吧。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="b9c5" class="ld le iq bd lf lg lh li lj lk ll lm ln jw lo jx lp jz lq ka lr kc ls kd lt lu bi translated">建模</h1><p id="300a" class="pw-post-body-paragraph lv lw iq lx b ly lz jr ma mb mc ju md me mf mg mh mi mj mk ml mm mn mo mp mq ij bi translated"><strong class="lx ir">数据</strong></p><p id="9754" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">我们的数据集是来自UCI机器学习知识库的<a class="ae kv" href="https://archive.ics.uci.edu/ml/datasets/heart+disease" rel="noopener ugc nofollow" target="_blank">心脏病</a>数据集(Dubois 2008)。你可以在这里下载csv文件<a class="ae kv" href="https://github.com/chriskuchar/Heart_Data" rel="noopener ugc nofollow" target="_blank">。</a></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="3b5f" class="nk le iq ng b gy nl nm l nn no">from pyspark.sql import functions as F<br/>from pyspark.ml.feature import OneHotEncoder, StringIndexer, VectorAssembler<br/>from pyspark.ml.feature import CountVectorizer</span><span id="de86" class="nk le iq ng b gy np nm l nn no">from pyspark.ml.tuning import ParamGridBuilder<br/>from pyspark.ml.evaluation import BinaryClassificationEvaluator<br/>import numpy as np<br/>from pyspark.ml.tuning import CrossValidator<br/>import plotly.graph_objects as go</span><span id="709d" class="nk le iq ng b gy np nm l nn no">df=spark.read.csv('heart.csv', inferSchema=True, header=True)<br/>df.count()<br/>len(df.columns)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/dcd21be9153d8db0c0f510a966589e6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1048/format:webp/1*UxCmFwqWfldMlQsppK0iqg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="ed99" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">我们的数据集有303行和14列。是的，这种规模的数据集不需要Spark。这个小数据集只是为了便于运行示例模型。</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="071e" class="nk le iq ng b gy nl nm l nn no">df.dtypes</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/663410f1ab991c9e900a43f0144bd116.png" data-original-src="https://miro.medium.com/v2/resize:fit:1316/format:webp/1*SyX7JzVu-mSfQ3Z-4wMV5A.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="0bc3" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">我们的数据都是整数/双精度，所以我们不需要为任何分类变量编码。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="36cb" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">特征信息:</strong></p><p id="e12f" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir"> 1。年龄:</strong>以年为单位的人的年龄</p><p id="3b72" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir"> 2。性别:</strong>人的性别(1 =男性，0 =女性)</p><p id="9425" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir"> 3。cp: </strong>所经历的胸痛(0 =典型心绞痛，1=非典型心绞痛，2=非心绞痛性疼痛，3 =无症状)</p><p id="1109" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir"> 4。trestbps </strong>:患者的静息血压(入院时为毫米汞柱)</p><p id="de98" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir"> 5。</strong>胆固醇:人的胆固醇测量值，单位为毫克/分升</p><p id="5860" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir"> 6。fbs: </strong>此人的空腹血糖(&gt; 120 mg/dl，1 =真；0 =假)。</p><p id="5fcf" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir"> 7。静息心电图:</strong>静息心电图测量(0 =正常，1 = ST-T波异常，2 =根据Estes标准显示可能或明确的左心室肥大)</p><p id="6989" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir"> 8。thalach: </strong>人达到的最大心率</p><p id="b411" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir"> 9。exang: </strong>运动诱发心绞痛(1 =是；0 =否)</p><p id="dec0" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">10。oldpeak: 运动相对于休息诱发的ST段压低</p><p id="ecd5" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">11。斜率:运动ST段峰值的斜率(0 =上升，1 =平缓，2 =下降)</p><p id="e867" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">12。ca: 主要血管的数量(0-4)</p><p id="1379" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">13。地中海贫血:一种叫做地中海贫血的血液疾病(3 =正常；6 =修复缺陷；7 =可逆转的缺陷)</p><p id="5ae6" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">14。目标:心脏病(0 =否，1 =是)</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="085b" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">检查缺失值:</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="9de3" class="nk le iq ng b gy nl nm l nn no">from pyspark.sql.functions import col,sum<br/>df.select(*(sum(col(c).isNull().cast("int")).alias(c) for c in df.columns)).show()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/0658c0dd502f1f0c23e7fc3a7c1e15d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gOSsmTcw9tKrLWowkWEpAQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="fec6" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">太好了。没有缺失值，因此我们不需要执行任何插补方法。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="4fbb" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">数据集概要</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="8fb9" class="nk le iq ng b gy nl nm l nn no">df.describe().toPandas().transpose()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/620ed411b2672d766e0f531028f68f21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ShGiSxM1lbFzTk4RN7B0rg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="b536" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">目标变量饼图:</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="8ef9" class="nk le iq ng b gy nl nm l nn no">df2=df.toPandas()<br/>df22=df2.groupby('target').count().reset_index()[['target','age']].rename(columns={'age':'counts'})<br/>colors = ['gold', 'mediumturquoise', 'darkorange', 'lightgreen']</span><span id="7b47" class="nk le iq ng b gy np nm l nn no">fig = go.Figure(data=[go.Pie(labels=df22.target,<br/>                             values=df22.counts)])<br/>fig.update_traces(hoverinfo='label+percent', textinfo='value+percent', textfont_size=20, textfont_color='black',<br/>                  marker=dict(colors=colors, line=dict(color='#000000', width=2)))<br/># fig.show()<br/>fig.update_layout(title='Heart Disease vs. Absence of Heart Disease', title_x=0.5)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/c216e37c1b66293aa497b0882906d0f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eGqoELI1w8yB-3-I6Tswcw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="06de" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">特征变量直方图:</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="65ef" class="nk le iq ng b gy nl nm l nn no">from plotly.subplots import make_subplots</span><span id="c868" class="nk le iq ng b gy np nm l nn no">fig = make_subplots(rows=4, cols=4, start_cell="top-left",<br/>                   subplot_titles=df2.columns[:-1])</span><span id="0b5a" class="nk le iq ng b gy np nm l nn no">fig.add_trace(go.Histogram(x=df2.age, name='age'),<br/>              row=1, col=1)</span><span id="54cd" class="nk le iq ng b gy np nm l nn no">fig.add_trace(go.Histogram(x=df2.sex, name='sex'),<br/>              row=1, col=2)</span><span id="e5ce" class="nk le iq ng b gy np nm l nn no">fig.add_trace(go.Histogram(x=df2.cp, name='cp'),<br/>              row=1, col=3)</span><span id="de4a" class="nk le iq ng b gy np nm l nn no">fig.add_trace(go.Histogram(x=df2.trestbps, name='trestbps'),<br/>              row=1, col=4)</span><span id="1e90" class="nk le iq ng b gy np nm l nn no">fig.add_trace(go.Histogram(x=df2.chol, name='chol'),<br/>              row=2, col=1)</span><span id="cd9e" class="nk le iq ng b gy np nm l nn no">fig.add_trace(go.Histogram(x=df2.fbs, name='fbs'),<br/>              row=2, col=2)</span><span id="e9b4" class="nk le iq ng b gy np nm l nn no">fig.add_trace(go.Histogram(x=df2.restecg, name='restecg'),<br/>              row=2, col=3)</span><span id="a683" class="nk le iq ng b gy np nm l nn no">fig.add_trace(go.Histogram(x=df2.thalach, name='thalach'),<br/>              row=2, col=4)</span><span id="11e3" class="nk le iq ng b gy np nm l nn no">fig.add_trace(go.Histogram(x=df2.exang, name='exang'),<br/>              row=3, col=1)</span><span id="79e0" class="nk le iq ng b gy np nm l nn no">fig.add_trace(go.Histogram(x=df2.oldpeak, name='oldpeak'),<br/>              row=3, col=2)</span><span id="d9d4" class="nk le iq ng b gy np nm l nn no">fig.add_trace(go.Histogram(x=df2.slope, name='slope'),<br/>              row=3, col=3)</span><span id="25c3" class="nk le iq ng b gy np nm l nn no">fig.add_trace(go.Histogram(x=df2.thalach, name='ca'),<br/>              row=3, col=4)</span><span id="789b" class="nk le iq ng b gy np nm l nn no">fig.add_trace(go.Histogram(x=df2.thal, name='thal'),<br/>              row=4, col=1)</span><span id="2552" class="nk le iq ng b gy np nm l nn no">fig.update_layout(title='Histograms of Variables', title_x=0.5)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/6d95c139666e409211b8494e448c1bac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3Qjtf6K1mRjWM1Qam91oJQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="a663" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">Oldpeak明显右倾。为了解决这个问题，我可以做一个log(x+1)转换。由于我更倾向于使用基于树的模型来解决这个问题，所以我不太关心将数据转换成正态分布。这是因为它不是一个假设，例如，随机森林或梯度推进。但是对于像逻辑回归这样的东西，让数据正态分布是一个假设。不管怎样，让我们继续改造它吧。</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="7e9d" class="nk le iq ng b gy nl nm l nn no">df3=df.withColumn('oldpeaklog', F.log(df['oldpeak']+1))<br/>df33=df3.toPandas()</span><span id="ac18" class="nk le iq ng b gy np nm l nn no">fig = make_subplots(rows=1, cols=2, start_cell="top-left",<br/>                   subplot_titles=['oldpeak','oldpeaklog'])</span><span id="4113" class="nk le iq ng b gy np nm l nn no">fig.add_trace(go.Histogram(x=df33.oldpeak, name='oldpeak'),<br/>              row=1, col=1)</span><span id="e249" class="nk le iq ng b gy np nm l nn no">fig.add_trace(go.Histogram(x=df33.oldpeaklog, name='oldpeaklog'),<br/>              row=1, col=2)</span><span id="2a7a" class="nk le iq ng b gy np nm l nn no">fig.update_layout(title='Transforming oldpeak', title_x=0.5</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nw"><img src="../Images/dbc4787e659c5441c671e7cf964c529d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f_KTZNHtLzLwZlqjmKXacQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="d116" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">经过转换后，它看起来更正态分布。</p><p id="0001" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">关联矩阵热图:</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="1b12" class="nk le iq ng b gy nl nm l nn no">corr = df33.corr()<br/>fig = go.Figure(data=go.Heatmap(z=corr.values,<br/> x=corr.index.values,<br/> y=corr.columns.values,<br/> text=np.round(corr.values,2),<br/> texttemplate=”%{text}”))</span><span id="68dc" class="nk le iq ng b gy np nm l nn no">fig.update_layout(title=dict(text=’Correlation Matrix Heatmap’,font=dict(size=20), x=0.5))</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nx"><img src="../Images/395825b1c99c8c8f7e14d04f06a5fc36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pEY7EQJCOwfY0zxfblSHFQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="9d71" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">斜率和oldpeaklog之间的最高相关性为-.59，或者斜率和oldpeak之间的最高相关性为-.58。其他都低于0.5或高于0.5，即更接近于0。因此，我决定保留模型中的所有变量。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="76c4" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">初始化阶段</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="a1fa" class="nk le iq ng b gy nl nm l nn no">#Initialize stages<br/>stages = []</span><span id="268a" class="nk le iq ng b gy np nm l nn no">#Target column<br/>label_stringIdx = StringIndexer(inputCol = 'target', outputCol = 'label')<br/>stages += [label_stringIdx]</span><span id="3dbb" class="nk le iq ng b gy np nm l nn no">#Numeric Columns<br/>numericCols = ['age',<br/> 'sex',<br/> 'cp',<br/> 'trestbps',<br/> 'chol',<br/> 'fbs',<br/> 'restecg',<br/> 'thalach',<br/> 'exang',<br/> 'slope',<br/> 'ca',<br/> 'thal',<br/> 'oldpeaklog'] </span><span id="dd7d" class="nk le iq ng b gy np nm l nn no">#Create a vector assembler<br/>assemblerInputs = numericCols <br/>assembler = VectorAssembler(inputCols=assemblerInputs, outputCol="features").setHandleInvalid('keep')<br/>stages += [assembler]</span></pre></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="7dbe" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">架设管道</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="bcd6" class="nk le iq ng b gy nl nm l nn no">from pyspark.ml import Pipeline<br/>pipeline = Pipeline(stages = stages)<br/>pipelineModel = pipeline.fit(df3)<br/>df3 = pipelineModel.transform(df3)<br/>selectedCols = ['label', 'features'] + <br/>['age',<br/> 'sex',<br/> 'cp',<br/> 'trestbps',<br/> 'chol',<br/> 'fbs',<br/> 'restecg',<br/> 'thalach',<br/> 'exang',<br/> 'slope',<br/> 'ca',<br/> 'thal',<br/> 'oldpeaklog','target']</span><span id="21ba" class="nk le iq ng b gy np nm l nn no">df3 = df3.select(selectedCols)<br/>df3.printSchema()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ny"><img src="../Images/565e21e094625a6c89586402da77e22b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uLp5b50yuEtQUCjgdTeL3A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="cb19" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">分为训练和测试</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="c940" class="nk le iq ng b gy nl nm l nn no">train, test = df3.randomSplit([0.7, 0.3], seed = 2018)<br/>train.groupby('target').count().show()<br/>test.groupby('target').count().show()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nz"><img src="../Images/86de71ec7b9bab599c2ca753969da546.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VB4xqTtUsPKfPHYlU6nTmw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="9899" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">对于培训和测试来说，这些课程看起来相对平衡。所以，我们不需要做任何的阶级平衡。让我们做一些模型。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="6491" class="ld le iq bd lf lg lh li lj lk ll lm ln jw lo jx lp jz lq ka lr kc ls kd lt lu bi translated"><strong class="ak">型号</strong></h1><h2 id="f4c2" class="nk le iq bd lf oa ob dn lj oc od dp ln me oe of lp mi og oh lr mm oi oj lt ok bi translated"><strong class="ak">随机森林</strong></h2><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="085a" class="nk le iq ng b gy nl nm l nn no">from pyspark.ml.classification import RandomForestClassifier</span><span id="a40d" class="nk le iq ng b gy np nm l nn no">rf = RandomForestClassifier(featuresCol = 'features', labelCol = 'label', seed=101)<br/>rfModel = rf.fit(train)<br/>predictions_rf=rfModel.transform(test)</span></pre><p id="cc1c" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">模型的整体精度</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="370f" class="nk le iq ng b gy nl nm l nn no">from pyspark.ml.evaluation import MulticlassClassificationEvaluator</span><span id="180d" class="nk le iq ng b gy np nm l nn no">evaluator_rf = MulticlassClassificationEvaluator(predictionCol=”prediction”)<br/>evaluator_rf.evaluate(predictions_rf)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ol"><img src="../Images/e512b56d6e6bd7842e0c0c77fd960606.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_8zxQbZArTIxB8otSHtUlQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="9aed" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">混淆矩阵</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="cd0a" class="nk le iq ng b gy nl nm l nn no">predictions_rf.crosstab('label','prediction').show()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi om"><img src="../Images/71e3a7dfd6435397f86b03df4b5c35d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1156/format:webp/1*4b4by_cuJpU7B4nXII4AyQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="0c12" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir"> ROC &amp;精度召回曲线</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="2740" class="nk le iq ng b gy nl nm l nn no">from handyspark import *</span><span id="1f8c" class="nk le iq ng b gy np nm l nn no"># Creates instance of extended version of BinaryClassificationMetrics<br/># using a DataFrame and its probability and label columns, as the output<br/># from the classifier<br/>bcm = BinaryClassificationMetrics(predictions_rf, scoreCol='probability', labelCol='label')</span><span id="b54b" class="nk le iq ng b gy np nm l nn no"># Get metrics from evaluator<br/>print("Area under ROC Curve: {:.4f}".format(bcm.areaUnderROC))<br/>print("Area under PR Curve: {:.4f}".format(bcm.areaUnderPR))</span><span id="ef74" class="nk le iq ng b gy np nm l nn no"># Plot both ROC and PR curves<br/>fig, axs = plt.subplots(1, 2, figsize=(12, 4))<br/>bcm.plot_roc_curve(ax=axs[0])<br/>bcm.plot_pr_curve(ax=axs[1])</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi on"><img src="../Images/643eb9861c6ec9db495238e2892784b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1148/format:webp/1*jHtMJsRr19iYrmZGy_KlGQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oo"><img src="../Images/55fd0e367c648ac94902a4a044b681bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C2hVx7I7j3ZVEcaKORsHeA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="695e" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">测试各种阈值</strong></p><p id="f873" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">这是一个基于任何输入的阈值得到混淆矩阵的函数。</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="fa34" class="nk le iq ng b gy nl nm l nn no">split1_udf = F.udf(lambda value: value[0].item(), FloatType())<br/>split2_udf = F.udf(lambda value: value[1].item(), FloatType())</span><span id="27da" class="nk le iq ng b gy np nm l nn no">def test_threshold(model, prob):<br/>    output2 = model.select('rawPrediction','target','probability',split1_udf('probability').alias('class_0'), split2_udf('probability').alias('class_1'))<br/>    from pyspark.sql.functions import col, when<br/>    output2=output2.withColumn('prediction', when(col('class_0')&gt; prob, 1).otherwise(0))<br/>    output2.crosstab('prediction','target').show()</span></pre><p id="ce05" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">使用这个定制的test_threshold函数，您可以查看混淆矩阵，这取决于您是否想要更高的精度或更高的召回率等。</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="4e05" class="nk le iq ng b gy nl nm l nn no">test_threshold(predictions_rf,.6)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi op"><img src="../Images/b8bc8420d42e3ee9b4460332a851cfa3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1136/format:webp/1*3FgyjA1oj8PTu9XqtHDTMA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="5277" class="nk le iq ng b gy nl nm l nn no">test_threshold(predictions_rf,.7)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/1b7e48f92cbd25958baa6ff33db65904.png" data-original-src="https://miro.medium.com/v2/resize:fit:1092/format:webp/1*W2E5Wvi8LWDA3B0zgfIUUQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="2958" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">特征重要性</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="691a" class="nk le iq ng b gy nl nm l nn no">feat_imps=rfModel.featureImportances<br/>x_values = list(range(len(feat_imps)))<br/>plt.bar(x_values, feat_imps, orientation = 'vertical')<br/>plt.xticks(x_values, ['age','sex','cp','trestbps','chol','fbs','restecg','thalach','exang','slope','ca','thal','oldpeaklog'], rotation=40)<br/>plt.ylabel('Importance')<br/>plt.xlabel('Feature')<br/>plt.title('Feature Importances')</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi or"><img src="../Images/fad27a5c390f92fd49a0eca0cdd0fe61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5rTCvK5KPHwk_GNkOHlTdA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="4091" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">使用这个，我们可以看到对预测最重要的变量依次是cp、thalach、ca和oldpeaklog。</p><p id="bfc9" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">调谐超参数</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="52e7" class="nk le iq ng b gy nl nm l nn no">paramGrid_rf = ParamGridBuilder() \<br/>    .addGrid(rf.numTrees, [int(x) for x in np.arange(200,221,10)]) \<br/>    .addGrid(rf.maxDepth, [int(x) for x in np.arange(10,11,10)]) \<br/>    .addGrid(rf.featureSubsetStrategy, [x for x in ["sqrt", "log2", "onethird"]]) \<br/>    .addGrid(rf.impurity, [x for x in ['gini','entropy']]) \<br/>    .addGrid(rf.maxBins, [int(x) for x in np.arange(22, 42, 10)]) \<br/>    .build()<br/>evaluator = BinaryClassificationEvaluator()</span><span id="6141" class="nk le iq ng b gy np nm l nn no">rf_crossval = CrossValidator(estimator=rf,<br/>                          estimatorParamMaps=paramGrid_rf,<br/>                          evaluator=evaluator,<br/>                          numFolds=3)<br/>rf_cvModel = rf_crossval.fit(train)<br/>predictions_rf_cv = rf_cvModel.transform(test)</span></pre><p id="ad33" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">最佳CV模型的总体精度</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="2cd4" class="nk le iq ng b gy nl nm l nn no">evaluator_rf_cv = MulticlassClassificationEvaluator(predictionCol="prediction")<br/>evaluator_rf_cv.evaluate(predictions_rf_cv)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi os"><img src="../Images/0c22d38e1af87859ac3f25eb1cd9497c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*umje49eRKDKu6frrBrju6g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="7b0a" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">变好了！准确率从79.6%提高到82.8%。现在，什么特征是最重要的，最佳模型使用了什么超参数？</p><p id="e2bc" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">最佳模型的特征重要性</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="6f40" class="nk le iq ng b gy nl nm l nn no">import matplotlib.pyplot as plt<br/>feat_imps=rf_cvModel.bestModel.featureImportances<br/>x_values = list(range(len(feat_imps)))<br/>plt.bar(x_values, feat_imps, orientation = 'vertical')<br/>plt.xticks(x_values, ['age','sex','cp','trestbps','chol','fbs','restecg','thalach','exang','slope','ca','thal','oldpeaklog'], rotation=40)<br/>plt.ylabel('Importance')<br/>plt.xlabel('Feature')<br/>plt.title('Feature Importances')</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ot"><img src="../Images/0343445cd8ab4f43db19f47d13d837a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r_UQS3AebQVD56QWnXeKug.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="6e1d" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">获取最佳随机森林CV模型的超参数值</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="6ae9" class="nk le iq ng b gy nl nm l nn no">print('Num Trees: ' + str(rf_cvModel.bestModel.getNumTrees))<br/>print('Max Depth: ' + str(rf_cvModel.bestModel.getMaxDepth()))<br/>print('Feature Subset Strategy: ' + str(rf_cvModel.bestModel.getFeatureSubsetStrategy()))<br/>print('Impurity: ' + str(rf_cvModel.bestModel.getImpurity()))<br/>print('Max Bins: ' + str(rf_cvModel.bestModel.getMaxBins()))</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/0ddacb5acd316aaab99421a721b70ea2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1396/format:webp/1*MkAPHnT6ITgSN0QewHpEIg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><h2 id="3575" class="nk le iq bd lf oa ob dn lj oc od dp ln me oe of lp mi og oh lr mm oi oj lt ok bi translated"><strong class="ak">逻辑回归</strong></h2><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="0f33" class="nk le iq ng b gy nl nm l nn no">from pyspark.ml.classification import LogisticRegression</span><span id="ea32" class="nk le iq ng b gy np nm l nn no">lr = LogisticRegression(maxIter=20, regParam=0.3, elasticNetParam=0,featuresCol = 'features', labelCol = 'label')<br/>lrModel = lr.fit(train)<br/>predictions_lr = lrModel.transform(test)</span></pre><p id="0477" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">模型的整体精度</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="fa0c" class="nk le iq ng b gy nl nm l nn no">evaluator_lr = MulticlassClassificationEvaluator(predictionCol="prediction")<br/>evaluator_lr.evaluate(predictions_lr)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ov"><img src="../Images/e1321e910ff5d212b13877e23165f559.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y3UfHsrDcSPUO8Wsc5R0ow.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="140d" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">打印逻辑回归的系数和截距</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="7e7a" class="nk le iq ng b gy nl nm l nn no"># Print the coefficients and intercept for logistic regression<br/>print("Coefficients: " + str(lrModel.coefficients))<br/>print("Intercept: " + str(lrModel.intercept))</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ow"><img src="../Images/ac8a8872e9c0e07e5c17565ec02a17e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_YdPmJeBxME5ooZza4Ys7Q.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="54df" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">混淆矩阵</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="08df" class="nk le iq ng b gy nl nm l nn no">predictions_lr.crosstab('label','prediction').show()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ox"><img src="../Images/e19ae0e49c5573ca9f493eb99b1d55cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1096/format:webp/1*_7wP-P_yb4ORLHyJGszPLg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="c8c6" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir"> ROC &amp; PR曲线</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="fc3f" class="nk le iq ng b gy nl nm l nn no"># Creates instance of extended version of BinaryClassificationMetrics<br/># using a DataFrame and its probability and label columns, as the output<br/># from the classifier<br/>bcm = BinaryClassificationMetrics(predictions_lr, scoreCol='probability', labelCol='label')</span><span id="1da4" class="nk le iq ng b gy np nm l nn no"># Get metrics from evaluator<br/>print("Area under ROC Curve: {:.4f}".format(bcm.areaUnderROC))<br/>print("Area under PR Curve: {:.4f}".format(bcm.areaUnderPR))</span><span id="efc8" class="nk le iq ng b gy np nm l nn no"># Plot both ROC and PR curves<br/>fig, axs = plt.subplots(1, 2, figsize=(12, 4))<br/>bcm.plot_roc_curve(ax=axs[0])<br/>bcm.plot_pr_curve(ax=axs[1])</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/565768571ac6bb4479c02a8c7ab0e520.png" data-original-src="https://miro.medium.com/v2/resize:fit:1128/format:webp/1*DK_CqDgcr_UK_MLVZxLhEw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oz"><img src="../Images/2a6ed464c930a31740512a6320b23602.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XjTk89NYDqmtFC-k7tH7Gw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="a8df" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">调整超参数</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="edfe" class="nk le iq ng b gy nl nm l nn no">paramGrid_lr = ParamGridBuilder() \<br/>    .addGrid(lr.maxIter, [int(x) for x in np.arange(10,30,10)]) \<br/>    .addGrid(lr.regParam, [int(x) for x in np.arange(.1,.5,.1)]) \<br/>    .addGrid(lr.elasticNetParam, [int(x) for x in np.arange(0,.2,.1)]) \<br/>    .build()<br/>evaluator = BinaryClassificationEvaluator()<br/>lr_crossval = CrossValidator(estimator=lr,<br/>                          estimatorParamMaps=paramGrid_lr,<br/>                          evaluator=evaluator,<br/>                          numFolds=3)<br/>lr_cvModel = lr_crossval.fit(train)<br/>predictions_lr_cv = lr_cvModel.transform(test)</span></pre><p id="fea1" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">最佳CV模型的总体精度</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="f167" class="nk le iq ng b gy nl nm l nn no">evaluator_lr_cv = MulticlassClassificationEvaluator(predictionCol="prediction")<br/>evaluator_lr_cv.evaluate(predictions_lr_cv)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pa"><img src="../Images/f1474667adfb8ff318de1df251c07bd2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2zMe4njmFHxQr5-07_bpKA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="8af8" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">看起来精度变好了！从78.2%上升到81.8%。</p><h2 id="a1de" class="nk le iq bd lf oa ob dn lj oc od dp ln me oe of lp mi og oh lr mm oi oj lt ok bi translated"><strong class="ak">逻辑回归V.2 </strong></h2><p id="4459" class="pw-post-body-paragraph lv lw iq lx b ly lz jr ma mb mc ju md me mf mg mh mi mj mk ml mm mn mo mp mq ij bi translated">我在上面的逻辑回归文档中找不到关于如何获得系数和P值的任何地方。因此，我在pyspark.ml.regression包中找到了这个独立的逻辑回归模型。我这样做是因为在我看来，没有p值的系数是没有用的。</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="2ffd" class="nk le iq ng b gy nl nm l nn no">from pyspark.ml.regression import GeneralizedLinearRegression<br/>glr = GeneralizedLinearRegression(family="binomial", link="logit", maxIter=10, <br/>regParam=0.0)<br/>model = glr.fit(train)<br/>summary = model.summary<br/>print('Variables:' + str(train.columns[2:-1]))<br/>print("Coefficient Standard Errors: " + str(summary.coefficientStandardErrors))<br/>print("T Values: " + str(summary.tValues))<br/>print("P Values: " + str(summary.pValues))</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pb"><img src="../Images/3784367c2da0fa24843e7084c7171a64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OtBZycY-4-4R5yeuYGyFzQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="2d37" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">使用这些<a class="ae kv" href="https://spark.apache.org/docs/2.2.0/api/python/pyspark.ml.html#pyspark.ml.regression.GeneralizedLinearRegression" rel="noopener ugc nofollow" target="_blank">源文档</a>你可以获得超参数名称，并重复上述步骤进行网格搜索和准确性。对于这个例子，我不会重复这些步骤，我会留给你。</p><p id="f2f7" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">朴素贝叶斯</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="650c" class="nk le iq ng b gy nl nm l nn no">from pyspark.ml.classification import NaiveBayes<br/>nb = NaiveBayes(featuresCol = 'features', labelCol = 'label')<br/>nb_model = nb.fit(train)<br/>predictions_nb=nb_model.transform(test)</span></pre><p id="8484" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">模型的整体精度</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="e975" class="nk le iq ng b gy nl nm l nn no">evaluator_nb = MulticlassClassificationEvaluator(predictionCol="prediction")<br/>evaluator_nb.evaluate(predictions_nb)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pc"><img src="../Images/46753af9680d7b2b9decfc29c8b1e2fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U8aKpj3QGdB5E02stCDEVg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="5560" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">混淆矩阵</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="6434" class="nk le iq ng b gy nl nm l nn no">predictions_nb.crosstab('label','prediction').show()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pd"><img src="../Images/fdb0b5e668b06039682dee57c104a744.png" data-original-src="https://miro.medium.com/v2/resize:fit:1108/format:webp/1*v2URQPJ9yn3YoI8BrT4YIQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="eff2" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir"> ROC和PR曲线</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="bd94" class="nk le iq ng b gy nl nm l nn no">from handyspark import *<br/>from matplotlib import pyplot as plt<br/>%matplotlib inline<br/># Creates instance of extended version of BinaryClassificationMetrics<br/># using a DataFrame and its probability and label columns, as the output<br/># from the classifier<br/>bcm = BinaryClassificationMetrics(predictions_nb, scoreCol='probability', labelCol='label')</span><span id="86fe" class="nk le iq ng b gy np nm l nn no"># Get metrics from evaluator<br/>print("Area under ROC Curve: {:.4f}".format(bcm.areaUnderROC))<br/>print("Area under PR Curve: {:.4f}".format(bcm.areaUnderPR))</span><span id="9d99" class="nk le iq ng b gy np nm l nn no"># Plot both ROC and PR curves<br/>fig, axs = plt.subplots(1, 2, figsize=(12, 4))<br/>bcm.plot_roc_curve(ax=axs[0])<br/>bcm.plot_pr_curve(ax=axs[1])</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi on"><img src="../Images/e8980382149f4032acad4d6d0fb542b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1148/format:webp/1*WUHfhBxdWeEFqHr_9wvU5Q.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pe"><img src="../Images/9506298112347ba6e2ce1dc7b5176e68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fhNbLFck0Hq8swAbgvYs8Q.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="7e5a" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">调谐超参数</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="38f1" class="nk le iq ng b gy nl nm l nn no">paramGrid_nb = ParamGridBuilder() \<br/>    .addGrid(nb.smoothing, [int(x) for x in np.arange(1,10,1)]) \<br/>    .build()<br/>evaluator = BinaryClassificationEvaluator()<br/>nb_crossval = CrossValidator(estimator=nb,<br/>                          estimatorParamMaps=paramGrid_nb,<br/>                          evaluator=evaluator,<br/>                          numFolds=3)<br/>nb_cvModel = nb_crossval.fit(train)<br/>predictions_nb_cv = nb_cvModel.transform(test)</span></pre><p id="c1c6" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">评估最佳简历模型</strong></p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="2c74" class="nk le iq ng b gy nl nm l nn no">evaluator_nb_cv = MulticlassClassificationEvaluator(predictionCol="prediction")<br/>evaluator_nb_cv.evaluate(predictions_nb_cv)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pf"><img src="../Images/f09d29eb136a1ad4dd22f7741ea74e34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5nB1ZNitoNfmBi6ORTVNCQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><h2 id="7f1c" class="nk le iq bd lf oa ob dn lj oc od dp ln me oe of lp mi og oh lr mm oi oj lt ok bi translated"><strong class="ak">结论</strong></h2><p id="f858" class="pw-post-body-paragraph lv lw iq lx b ly lz jr ma mb mc ju md me mf mg mh mi mj mk ml mm mn mo mp mq ij bi translated">看起来随机森林在这里表现最好，网格搜索后的准确率为82.8%。逻辑回归以81.8%排在第二位，朴素贝叶斯以69.8%排在最后。</p><p id="1293" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">让我们解释一下随机森林最重要的变量，因为它有最好的预测精度。查看<strong class="lx ir"> cp、thalach和ca </strong>:</p><p id="be25" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir"> cp: </strong>所经历的胸痛(值1:典型心绞痛，值2:非典型心绞痛，值3:非心绞痛性疼痛，值4:无症状)</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="6044" class="nk le iq ng b gy nl nm l nn no">df3.groupby('target','cp').count().show()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pg"><img src="../Images/108d18f30ebef95ef5a3350c6136d331.png" data-original-src="https://miro.medium.com/v2/resize:fit:780/format:webp/1*GT8nnZyaKsQsxh9CS5rCzg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="8032" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">Random Forests表示，大多数被归类为患有心脏病的人患有CP = 1/非典型心绞痛和CP = 2/非心绞痛，而大多数未被归类为患有心脏病的人患有CP = 0/典型心绞痛。</p><p id="9ddf" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir"> thalach: </strong>该人达到的最大心率</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="751f" class="nk le iq ng b gy nl nm l nn no">df34=df33.loc[df33['target']==0,'thalach']<br/>df35=df33.loc[df33['target']==1,'thalach']</span><span id="0d00" class="nk le iq ng b gy np nm l nn no">fig = go.Figure()<br/>fig.add_trace(go.Histogram(x=df34, name='target:0'))<br/>fig.add_trace(go.Histogram(x=df35,name='target:1'))</span><span id="b716" class="nk le iq ng b gy np nm l nn no"># Overlay both histograms<br/>fig.update_layout(barmode='overlay')<br/># Reduce opacity to see both histograms<br/>fig.update_traces(opacity=.9)<br/>fig.update_xaxes(title='Thalach Level')<br/>fig.update_yaxes(dtick=5, range=[0,30], title='Count')<br/>fig.update_layout(title='Comparing Thalach Levels', title_x=0.5)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ph"><img src="../Images/87e104c82bc3963fb9f2c0a0abc9c0b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mqsrKja8HRHGIv-U-9fMjQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="b4b1" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">根据该图，较高的Thalach或最大心率水平对于患有心脏病的分类是重要的，而较低的水平被分类为没有心脏病。</p><p id="cc26" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir"> ca: </strong>主要血管的数量(0-4)</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="1fa5" class="nk le iq ng b gy nl nm l nn no">df3.groupby('target','ca').count().show()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pi"><img src="../Images/f3fe6ce5883db313a0fee019fe73ec79.png" data-original-src="https://miro.medium.com/v2/resize:fit:728/format:webp/1*GQSexE2n9sEBc41wS5m6VQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="7e82" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">Random Forests表示，大多数被归类为患有心脏病的人有0条主要血管，而大多数被归类为没有心脏病的人有更多的主要血管，即&gt; 0条。</p><p id="3baa" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">这些变量的分布似乎有直观的意义。另外，我们能够从我们的模型中推断出这一点！</p><p id="bf57" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">我希望这个PySpark模型的例子对您的工作有所帮助。谢谢你的阅读。请随意留下任何评论。</p><p id="048a" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated"><strong class="lx ir">参考文献:</strong></p><p id="0316" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">克里斯托弗·迪布瓦和史密斯(2008年)。UCI网络数据仓库[http://Network Data . ics . UCI . edu]。加州欧文:加州大学信息与计算机科学学院。</p><p id="440e" class="pw-post-body-paragraph lv lw iq lx b ly mr jr ma mb ms ju md me mt mg mh mi mu mk ml mm mv mo mp mq ij bi translated">雅诺西，安朵斯，斯坦布伦，威廉，普菲斯特勒，马蒂亚斯，德特拉诺，罗伯特和医学博士，医学博士..(1988).心脏病。UCI机器学习知识库。</p></div></div>    
</body>
</html>