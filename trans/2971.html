<html>
<head>
<title>Understanding CUPED</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">理解CUPED</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/understanding-cuped-a822523641af#2022-06-29">https://towardsdatascience.com/understanding-cuped-a822523641af#2022-06-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="48f0" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/causal-data-science" rel="noopener" target="_blank">因果数据科学</a></h2><div class=""/><div class=""><h2 id="d7ab" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated"><em class="ko">A/B测试最先进方差缩减技术的深度指南</em></h2></div><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/be6fb41d9daf478fa3ee10be4db537ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yrXImqFDp6EdrNe8cWqujQ.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">作者图片</p></figure><p id="80f0" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在博士期间，我花了很多时间学习和应用因果推断方法到实验和观察数据中。然而，当我第一次听说<strong class="lh ja"> CUPED </strong>(使用实验前数据的受控实验)时，我完全不知所措，这是一种增加A/B测试中随机控制试验功效的技术。</p><p id="6917" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">真正让我惊讶的是该算法在业界的普及程度。CUPED最早由微软研究人员<a class="ae mb" href="https://dl.acm.org/doi/abs/10.1145/2433396.2433413" rel="noopener ugc nofollow" target="_blank">邓、徐、科哈维、沃克(2013) </a>提出，并已在公司<a class="ae mb" href="https://www.kdd.org/kdd2016/papers/files/adp0945-xieA.pdf" rel="noopener ugc nofollow" target="_blank">、</a>、<a class="ae mb" href="https://booking.ai/995d186fff1d" rel="noopener ugc nofollow" target="_blank">预订</a>、<a class="ae mb" href="https://research.facebook.com/blog/2020/10/increasing-the-sensitivity-of-a-b-tests-by-utilizing-the-variance-estimates-of-experimental-units/" rel="noopener ugc nofollow" target="_blank"> Meta </a>、<a class="ae mb" href="https://eng.uber.com/causal-inference-at-uber/" rel="noopener ugc nofollow" target="_blank">、</a>、<a class="ae mb" href="https://arxiv.org/abs/2112.13299" rel="noopener ugc nofollow" target="_blank"> Airbnb </a>、<a class="ae mb" href="https://arxiv.org/abs/2110.13406" rel="noopener ugc nofollow" target="_blank"> Linkedin、</a><a class="ae mb" href="https://www.tripadvisor.com/engineering/reducing-a-b-test-measurement-variance-by-30/" rel="noopener ugc nofollow" target="_blank">、</a>、<a class="ae mb" href="https://doordash.engineering/2020/10/07/improving-experiment-capacity-by-4x/" rel="noopener ugc nofollow" target="_blank"> DoorDash </a>当深入挖掘时，我注意到与我熟悉的一些因果推断方法有相似之处，例如<a class="ae mb" href="https://diff.healthpolicydatascience.org/" rel="noopener ugc nofollow" target="_blank">差异中的差异</a>或控制变量回归。我很好奇，决定深入挖掘。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi mc"><img src="../Images/d9e19ed29b7c977c81b0ab91d8b3e924.png" data-original-src="https://miro.medium.com/v2/resize:fit:978/format:webp/1*G1WMZnCfHXx08btNixz7QA.png"/></div><p class="lb lc gj gh gi ld le bd b be z dk translated">你在骗谁？作者图片</p></figure><p id="51f5" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><strong class="lh ja">TLDR；</strong> CUPED本质上是一个<a class="ae mb" href="https://www.google.com/url?q=https%3A%2F%2Fwww.dropbox.com%2Fs%2Fq8033tqrmsi7cge%2FResOut.pdfhttps%3A%2F%2Fwww.dropbox.com%2Fs%2Fm6jt5dsqm5xvyml%2FisoLATE_022018.pdf%3Fraw%3D1&amp;sa=D&amp;sntz=1&amp;usg=AOvVaw2Rek6lp6L41rw6Osbs4sAS" rel="noopener ugc nofollow" target="_blank">剩余结果回归</a>。除了特殊情况外，它通常既不等同于差异中的差异，也不等同于带控制变量的回归。</p></div><div class="ab cl md me hu mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ij ik il im in"><h1 id="b77d" class="mk ml iq bd mm mn mo mp mq mr ms mt mu kf mv kg mw ki mx kj my kl mz km na nb bi translated">例子</h1><p id="41fa" class="pw-post-body-paragraph lf lg iq lh b li nc ka lk ll nd kd ln lo ne lq lr ls nf lu lv lw ng ly lz ma ij bi translated">假设我们是一家正在测试广告活动的公司，我们有兴趣了解它是否会增加收入。我们将一组用户随机分为治疗组和对照组，并向治疗组展示广告活动。与标准的A/B测试设置不同，假设我们在测试前也观察用户。</p><p id="4a25" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我们现在可以使用来自<code class="fe nh ni nj nk b"><a class="ae mb" href="https://github.com/matteocourthoud/Blog-Posts/blob/main/notebooks/src/dgp.py" rel="noopener ugc nofollow" target="_blank">src.dgp</a></code>的数据生成过程<code class="fe nh ni nj nk b">dgp_cuped()</code>来生成模拟数据。我还从<code class="fe nh ni nj nk b"><a class="ae mb" href="https://github.com/matteocourthoud/Blog-Posts/blob/main/notebooks/src/utils.py" rel="noopener ugc nofollow" target="_blank">src.utils</a></code>引进了一些绘图函数和库。</p><pre class="kq kr ks kt gt nl nk nm nn aw no bi"><span id="df87" class="np ml iq nk b gy nq nr l ns nt">from src.utils import *<br/>from src.dgp import dgp_cuped</span><span id="5093" class="np ml iq nk b gy nu nr l ns nt">df = dgp_cuped().generate_data()<br/>df.head()</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl nv"><img src="../Images/ae42f5b93d64e5c3206f07816516bfaf.png" data-original-src="https://miro.medium.com/v2/format:webp/1*_oigD-qVrGsnSGrSmQTHWA.png"/></div><p class="lb lc gj gh gi ld le bd b be z dk translated">数据快照，图片由作者提供</p></figure><p id="26cd" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我们有关于1000名个人的信息，这些人由<code class="fe nh ni nj nk b">i</code>索引，我们观察他们分别在治疗前后、<code class="fe nh ni nj nk b">revenue0</code>和<code class="fe nh ni nj nk b">revenue1</code>产生的收入，以及他们是否暴露于<code class="fe nh ni nj nk b">ad_campaign</code>。</p><h2 id="cd8d" class="np ml iq bd mm nw nx dn mq ny nz dp mu lo oa ob mw ls oc od my lw oe of na iw bi translated">手段的差异</h2><p id="99d7" class="pw-post-body-paragraph lf lg iq lh b li nc ka lk ll nd kd ln lo ne lq lr ls nf lu lv lw ng ly lz ma ij bi translated">在随机化实验或A/B测试中，<strong class="lh ja">随机化</strong>允许我们使用简单的均值差异来估计平均治疗效果。我们可以比较对照组和治疗组的平均治疗后结果<em class="og"> Y₁ </em> ( <code class="fe nh ni nj nk b">revenue1</code>),随机化保证了这种差异是由于预期中的单独治疗造成的。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi oh"><img src="../Images/a52458b0d1a81a815570a1af2e400dbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*03Jv1IzBI_HIL4KVeT_Xrg.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">简单差异估计，作者图片</p></figure><p id="8d40" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">其中横条表示个体的平均值，下标<em class="og"> d </em>表示治疗状态。在我们的案例中，我们计算了治疗组广告活动后的平均收入，减去对照组广告活动后的平均收入。</p><pre class="kq kr ks kt gt nl nk nm nn aw no bi"><span id="a789" class="np ml iq nk b gy nq nr l ns nt">np.mean(df.loc[df.ad_campaign==True, 'revenue1']) - np.mean(df.loc[df.ad_campaign==False, 'revenue1'])</span><span id="c7d1" class="np ml iq nk b gy nu nr l ns nt">1.7914301325347406</span></pre><p id="49f0" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">估计处理效果为1.79，非常接近于2的<strong class="lh ja">真值</strong>。我们可以通过对<code class="fe nh ni nj nk b">ad_campaign</code>的治疗指标<em class="og"> D </em>回归治疗后结果<code class="fe nh ni nj nk b">revenue1</code>来获得相同的估计值。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi oi"><img src="../Images/c38d57e360cb14185640508b8ceecb77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tdz_Ny2fCp9jwjCpyaUc1Q.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">回归方程，作者图片</p></figure><p id="e10e" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">其中<em class="og"> β </em>为感兴趣系数。</p><pre class="kq kr ks kt gt nl nk nm nn aw no bi"><span id="b6ce" class="np ml iq nk b gy nq nr l ns nt">smf.ols('revenue1 ~ ad_campaign', data=df).fit().summary().tables[1]</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi oj"><img src="../Images/99b6e9bcc233df8f63e1716d54117d52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8BqDsrUZgsmz-IPWKvUxfQ.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">回归结果，图片由作者提供</p></figure><p id="5dde" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">这个估计器是<strong class="lh ja">无偏的</strong>，这意味着平均来说它给出了正确的估计。然而，它仍然可以改进:我们可以<strong class="lh ja">减少它的方差</strong>。减少估计量的方差是非常重要的，因为它允许我们</p><ul class=""><li id="6f97" class="ok ol iq lh b li lj ll lm lo om ls on lw oo ma op oq or os bi translated"><strong class="lh ja">检测较小的影响</strong></li><li id="31c3" class="ok ol iq lh b li ot ll ou lo ov ls ow lw ox ma op oq or os bi translated">检测到相同的效果，但样本量<strong class="lh ja">更小</strong></li></ul><p id="94ec" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">一般来说，方差较小的估计量允许我们以更高的<a class="ae mb" href="https://en.wikipedia.org/wiki/Power_of_a_test" rel="noopener ugc nofollow" target="_blank"> <strong class="lh ja">功效</strong> </a>进行测试，即检测较小影响的能力。</p><p id="e7fe" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我们能提高AB测试的能力吗？是的，使用CUPED(以及其他方法)。</p></div><div class="ab cl md me hu mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ij ik il im in"><h1 id="79b4" class="mk ml iq bd mm mn mo mp mq mr ms mt mu kf mv kg mw ki mx kj my kl mz km na nb bi translated">CUPED</h1><p id="3fc0" class="pw-post-body-paragraph lf lg iq lh b li nc ka lk ll nd kd ln lo ne lq lr ls nf lu lv lw ng ly lz ma ij bi translated">CUPED的<strong class="lh ja">想法</strong>如下。假设您正在运行一个AB测试，并且<em class="og"> Y </em>是感兴趣的结果(在我们的示例中为<code class="fe nh ni nj nk b">revenue</code>),二元变量<em class="og"> D </em>表示单个个体是否被治疗过(在我们的示例中为<code class="fe nh ni nj nk b">ad_campaign</code>)。</p><p id="6485" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">假设你有另一个随机变量<em class="og"> X </em>，它<strong class="lh ja">不受治疗的影响</strong>，并且已知期望<em class="og">𝔼[x】</em>。然后定义</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi oy"><img src="../Images/d46fe4f7452ca086788537d3da11ac0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U3262rAfrTjo3HIxhgmg3Q.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">转换的结果，作者的图像</p></figure><p id="1b27" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">其中<em class="og"> θ </em>是一个标量。对于<em class="og">𝔼[y】</em>而言，该估计量是<strong class="lh ja">无偏</strong>估计量，因为在预期中最后两项会抵消。然而，<em class="og"> Ŷ₁ᶜᵘᵖᵉᵈ </em>的方差为</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi oz"><img src="../Images/c7c6bfcb97b56eb5b78eb78010a6e63e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gqw3lvRLtStJ1JIfRCNA9Q.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">转换结果方差，按作者分类的图像</p></figure><p id="f0f2" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">注意，<em class="og"> Ŷ₁ᶜᵘᵖᵉᵈ </em>的方差被最小化为</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi pa"><img src="../Images/066055842f6a5f50848480e28c884d2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1QOQHr-_NDdBzWY_i3QBRQ.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">最佳theta，作者图片</p></figure><p id="913e" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">哪一个是关于<em class="og"> X </em>的<em class="og"> Y </em>的线性回归的<strong class="lh ja"> OLS </strong>估计量。将<em class="og"> θ </em> *代入<em class="og"> Ŷ₁ᶜᵘᵖᵉᵈ </em>的方差公式，我们得到</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi pa"><img src="../Images/11bb69f91fb4ab573e6f45fbf765967a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s98jRoBnU8XaZHK8Wtnj-Q.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">转换结果方差，按作者分类的图像</p></figure><p id="f97e" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">其中<em class="og"> ρ </em>是<em class="og"> Y </em>和<em class="og"> X </em>之间的<strong class="lh ja">相关性</strong>。因此<em class="og"> Y </em>和<em class="og"> X </em>的相关度越高，CUPED的方差减少量就越高。</p><p id="b7d3" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">然后我们可以<strong class="lh ja">将平均治疗效果</strong>估计为对照组和治疗组之间转化结果的平均差异。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi pb"><img src="../Images/cb2723f10c0b2b11552a27812d6a9e8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*axlt53ZxtPQ5FnVDF7UYXw.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">CUPED估算师，图片由作者提供</p></figure><p id="d990" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">注意<em class="og">𝔼[x】</em>在取差时抵消。因此，计算就足够了</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi oh"><img src="../Images/2c1f1c1f447ef5a8cfe78b25c1f8be24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RweJjBw6taYHokQctOZ2FQ.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">转换结果的等效公式，作者的图像</p></figure><p id="ea51" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">这不是<em class="og">【𝔼[y】</em>的无偏估计量，但仍能提供平均治疗效果的无偏估计量。</p><h2 id="3df0" class="np ml iq bd mm nw nx dn mq ny nz dp mu lo oa ob mw ls oc od my lw oe of na iw bi translated">最佳X</h2><p id="7eae" class="pw-post-body-paragraph lf lg iq lh b li nc ka lk ll nd kd ln lo ne lq lr ls nf lu lv lw ng ly lz ma ij bi translated">控制变量<em class="og"> X </em>的<strong class="lh ja">最优选择</strong>是什么？</p><p id="217f" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我们知道<em class="og"> X </em>应该有以下<strong class="lh ja">属性</strong>:</p><ul class=""><li id="9f54" class="ok ol iq lh b li lj ll lm lo om ls on lw oo ma op oq or os bi translated">不受治疗的影响</li><li id="c4aa" class="ok ol iq lh b li ot ll ou lo ov ls ow lw ox ma op oq or os bi translated">尽可能与Y₁ 相关联</li></ul><p id="d09c" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">论文作者建议使用<strong class="lh ja">预处理结果</strong> <em class="og"> Y₀ </em>，因为它在实践中给出了最大的方差减少。</p><p id="fcb6" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">为了<strong class="lh ja">总结</strong>，我们可以计算平均处理效果的最高估计值如下:</p><ol class=""><li id="080f" class="ok ol iq lh b li lj ll lm lo om ls on lw oo ma pc oq or os bi translated">在<em class="og"> Y₀ </em>上回归<em class="og"> Y₁ </em>并估计<em class="og"> θ̂ </em></li><li id="6545" class="ok ol iq lh b li ot ll ou lo ov ls ow lw ox ma pc oq or os bi translated">计算<em class="og">ŷ₁ᶜᵘᵖᵉᵈ</em>t26】=y̅₁θ̂y̅₀</li><li id="d459" class="ok ol iq lh b li ot ll ou lo ov ls ow lw ox ma pc oq or os bi translated">计算治疗组和对照组的<em class="og"> Ŷ₁ᶜᵘᵖᵉᵈ </em>的差值</li></ol><p id="1c37" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">等效地，我们可以在个体水平上计算<em class="og"> Ŷ₁ᶜᵘᵖᵉᵈ </em>，然后将其回归到治疗虚拟变量<em class="og"> D </em>上。</p><h2 id="313b" class="np ml iq bd mm nw nx dn mq ny nz dp mu lo oa ob mw ls oc od my lw oe of na iw bi translated">回到数据</h2><p id="a3eb" class="pw-post-body-paragraph lf lg iq lh b li nc ka lk ll nd kd ln lo ne lq lr ls nf lu lv lw ng ly lz ma ij bi translated">让我们一步一步地计算治疗效果的最大估计值。首先我们来估算一下<em class="og"> θ </em>。</p><pre class="kq kr ks kt gt nl nk nm nn aw no bi"><span id="ff82" class="np ml iq nk b gy nq nr l ns nt">theta = smf.ols('revenue1 ~ revenue0', data=df).fit().params[1]</span></pre><p id="5026" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">现在我们可以计算变换后的结果<em class="og"> Ŷ₁ᶜᵘᵖᵉᵈ </em>。</p><pre class="kq kr ks kt gt nl nk nm nn aw no bi"><span id="fdb1" class="np ml iq nk b gy nq nr l ns nt">df['revenue1_cuped'] = df['revenue1'] - theta * (df['revenue0'] - np.mean(df['revenue0']))</span></pre><p id="0b5f" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">最后，我们用转换后的结果<em class="og"> Ŷ₁ᶜᵘᵖᵉᵈ </em>来估计作为均值差异的治疗效果。</p><pre class="kq kr ks kt gt nl nk nm nn aw no bi"><span id="1d28" class="np ml iq nk b gy nq nr l ns nt">smf.ols('revenue1_cuped ~ ad_campaign', data=df).fit().summary().tables[1]</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi pd"><img src="../Images/0a8f52f556ab32e0a40e47fd0c830ac6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dGNChNw-Wus588mUz7glgA.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">回归结果，图片由作者提供</p></figure><p id="8f9f" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">标准误差小33%(0.2 vs 0.3)！</p><h2 id="7c6e" class="np ml iq bd mm nw nx dn mq ny nz dp mu lo oa ob mw ls oc od my lw oe of na iw bi translated">等效公式</h2><p id="2517" class="pw-post-body-paragraph lf lg iq lh b li nc ka lk ll nd kd ln lo ne lq lr ls nf lu lv lw ng ly lz ma ij bi translated">获得CUPED估计值的另一种代数上等价的方法如下</p><ol class=""><li id="2f50" class="ok ol iq lh b li lj ll lm lo om ls on lw oo ma pc oq or os bi translated">在<em class="og"> Y₀ </em>上回归<em class="og"> Y₁ </em>并计算残差<em class="og"> Ỹ₁ </em></li><li id="f63a" class="ok ol iq lh b li ot ll ou lo ov ls ow lw ox ma pc oq or os bi translated">计算<em class="og">ŷ₁ᶜᵘᵖᵉᵈ</em>T50】=ỹ₁+y̅₁</li><li id="de4e" class="ok ol iq lh b li ot ll ou lo ov ls ow lw ox ma pc oq or os bi translated">计算治疗组和对照组的<em class="og"> Ŷ₁ᶜᵘᵖᵉᵈ </em>的差值</li></ol><p id="d780" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">步骤(3)与之前相同，但(1)和(2)不同。这个过程被称为<strong class="lh ja">部分删除</strong>，代数等价由<a class="ae mb" rel="noopener" target="_blank" href="/59f801eb3299">弗里希-沃-洛厄尔定理</a>保证。</p><p id="61b8" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">让我们检查一下我们是否确实得到了同样的结果。</p><pre class="kq kr ks kt gt nl nk nm nn aw no bi"><span id="2d15" class="np ml iq nk b gy nq nr l ns nt">df['revenue1_tilde'] = smf.ols('revenue1 ~ revenue0', data=df).fit().resid + np.mean(df['revenue1'])</span><span id="cf61" class="np ml iq nk b gy nu nr l ns nt">smf.ols('revenue1_tilde ~ ad_campaign', data=df).fit().summary().tables[1]</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi pd"><img src="../Images/0a8f52f556ab32e0a40e47fd0c830ac6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dGNChNw-Wus588mUz7glgA.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">回归结果，图片由作者提供</p></figure><p id="0cdc" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">是啊！回归表完全相同。</p></div><div class="ab cl md me hu mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ij ik il im in"><h1 id="cc33" class="mk ml iq bd mm mn mo mp mq mr ms mt mu kf mv kg mw ki mx kj my kl mz km na nb bi translated">CUPED与其他</h1><p id="a24a" class="pw-post-body-paragraph lf lg iq lh b li nc ka lk ll nd kd ln lo ne lq lr ls nf lu lv lw ng ly lz ma ij bi translated">CUPED似乎是一个非常强大的程序，但它至少提醒了其他一些方法。</p><ol class=""><li id="3fb7" class="ok ol iq lh b li lj ll lm lo om ls on lw oo ma pc oq or os bi translated"><strong class="lh ja">自回归</strong>或带控制变量的回归</li><li id="0f81" class="ok ol iq lh b li ot ll ou lo ov ls ow lw ox ma pc oq or os bi translated"><a class="ae mb" href="https://diff.healthpolicydatascience.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="lh ja">差异中的差异</strong> </a></li></ol><p id="ff2a" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">这些方法是相同的还是有区别的？让我们检查一下。</p><h2 id="e518" class="np ml iq bd mm nw nx dn mq ny nz dp mu lo oa ob mw ls oc od my lw oe of na iw bi translated">自回归</h2><p id="b26b" class="pw-post-body-paragraph lf lg iq lh b li nc ka lk ll nd kd ln lo ne lq lr ls nf lu lv lw ng ly lz ma ij bi translated">当我第一次看到CUPED时，我想到的第一个问题是“<em class="og">CUPED仅仅是一个额外控制变量的简单差异吗？</em>”。或者等价地，CUPED是否等价于通过最小二乘法估计下面的回归(其中<em class="og"> γ </em>是感兴趣的参数)？</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi pe"><img src="../Images/93957d6af96cc77209177ebe143183a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nmPR_SXx0KZxib20vlo2pw.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">估计方程，作者图片</p></figure><p id="b6f2" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">让我们看一看。</p><pre class="kq kr ks kt gt nl nk nm nn aw no bi"><span id="e087" class="np ml iq nk b gy nq nr l ns nt">smf.ols('revenue1 ~ revenue0 + ad_campaign', data=df).fit().summary().tables[1]</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi pf"><img src="../Images/af55a0a99b75adffe0fa949b49476f56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OONE-yqbxNWCNQFTLUUySQ.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">回归结果，图片由作者提供</p></figure><p id="fbaf" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">估计的系数与我们用CUPED得到的非常相似，标准误差也非常接近。然而，它们<strong class="lh ja">并不完全相同</strong>。</p><p id="a095" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">如果你熟悉<a class="ae mb" rel="noopener" target="_blank" href="/59f801eb3299">弗里希-沃-洛厄尔定理</a>，你可能会奇怪为什么两个过程<strong class="lh ja">不等价</strong>。原因是在CUPED的情况下，我们只分离出<em class="og"> Y </em>，而当我们分离出<em class="og"> X </em>或者同时分离出<em class="og"> X </em>和<em class="og"> Y </em>时，FWL定理成立。</p><h2 id="0955" class="np ml iq bd mm nw nx dn mq ny nz dp mu lo oa ob mw ls oc od my lw oe of na iw bi translated">差异中的差异</h2><p id="3300" class="pw-post-body-paragraph lf lg iq lh b li nc ka lk ll nd kd ln lo ne lq lr ls nf lu lv lw ng ly lz ma ij bi translated">我想到的第二个问题是“我只是在差异中寻求差异吗？”。<a class="ae mb" href="https://diff.healthpolicydatascience.org/" rel="noopener ugc nofollow" target="_blank">差异中的差异</a>(或diff-in-diffs，或DiD)是一种估计器，它将治疗效果计算为<strong class="lh ja">双重差异</strong>而不是单一差异:前后差异和治疗控制，而不仅仅是治疗控制。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi pe"><img src="../Images/bab72d0d33ddada1d88ebcf85049c8f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EB4srxrmSa-SANtpdsr-Fw.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">差异中的差异估计值，作者图片</p></figure><p id="d09b" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">这种方法最初是由约翰·斯诺(1854年)(不，不是那个<a class="ae mb" href="https://en.wikipedia.org/wiki/John_Snow_(disambiguation)" rel="noopener ugc nofollow" target="_blank">约翰·斯诺</a>)提出来估计伦敦霍乱流行的原因。diff-in-diff的主要优点是，当随机化不完美且治疗组和对照组不可比时，它允许估计平均治疗效果。<strong class="lh ja">关键假设</strong>是治疗组和对照组之间的差异随时间保持不变。通过取两个差值，我们就把它抵消了。</p><p id="c1c3" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">让我们看看diff-in-diffs是如何工作的。计算diff-in-diffs估计量的最常见方法是首先以<strong class="lh ja">长格式</strong>或<strong class="lh ja">面板格式</strong>对数据进行整形(一个观察是在时间段<em class="og"> t </em>的单个<em class="og"> i </em>),然后对后处理假人<em class="og">𝕀(t=1</em>和处理假人<em class="og"> D </em>之间的完全交互的结果<em class="og"> Y </em>进行回归。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi pg"><img src="../Images/9ea57c82f5754861781431ae1d32b5c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dXRPe5ZmISn7GEeLCr7MGA.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">估计方程，作者图片</p></figure><p id="6301" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">平均处理效果的估计量是交互作用系数的系数，<em class="og"> δ </em>。</p><pre class="kq kr ks kt gt nl nk nm nn aw no bi"><span id="e2c7" class="np ml iq nk b gy nq nr l ns nt">df_long = pd.wide_to_long(df, stubnames='revenue', i='i', j='t').reset_index()<br/>df_long.head()</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl nv"><img src="../Images/7b19b7dc941f2287bb4401dc915bbb57.png" data-original-src="https://miro.medium.com/v2/format:webp/1*8LxuXH0956-4r6yWfuyCNA.png"/></div><p class="lb lc gj gh gi ld le bd b be z dk translated">长数据集快照，按作者分类的图像</p></figure><p id="1e13" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">长数据集现在由个体<code class="fe nh ni nj nk b">i</code>和时间<code class="fe nh ni nj nk b">t</code>索引。我们现在准备运行差异中的差异回归。</p><pre class="kq kr ks kt gt nl nk nm nn aw no bi"><span id="0b48" class="np ml iq nk b gy nq nr l ns nt">smf.ols('revenue ~ t * ad_campaign', data=df_long).fit().summary().tables[1]</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ph"><img src="../Images/e6e47f9448fd9044144eea84d1589eea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H5GlKUsjHjunbsQc5YtV4g.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">回归结果，图片由作者提供</p></figure><p id="d93d" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">估计的系数接近真实值2，但是标准误差大于用所有其他方法获得的结果(0.35 &gt;&gt; 0.2)。我们错过了什么？我们没有<strong class="lh ja">聚类标准错误</strong>！</p><p id="64c3" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我不会在这里详细讨论标准错误聚类的含义，但直觉如下。默认情况下，<code class="fe nh ni nj nk b">statsmodels</code>软件包会计算标准误差，假设结果在所有观测中是<strong class="lh ja">独立的</strong>。在我们随着时间的推移观察个人并试图利用这些信息的情况下，这个假设不太可能是真的。聚类考虑了结果变量在聚类内的<strong class="lh ja">相关性</strong>。在我们的例子中，在个体水平上对标准误差进行聚类是有意义的(即使不知道数据生成过程),允许结果随着时间的推移与个体<em class="og"> i </em>相关联。</p><pre class="kq kr ks kt gt nl nk nm nn aw no bi"><span id="0144" class="np ml iq nk b gy nq nr l ns nt">smf.ols('revenue ~ t * ad_campaign', data=df_long)\<br/>    .fit(cov_type='cluster', cov_kwds={'groups': df_long['i']})\<br/>    .summary().tables[1]</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi pi"><img src="../Images/9586cd834379c7d621adaefa3a257559.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LMX3EhxYm606CkKA9U5mOQ.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">回归结果，图片由作者提供</p></figure><p id="9aa5" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在个体水平上对标准误差进行聚类我们获得了与先前估计值相当的标准误差(∼0.2)。</p><p id="978d" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">注意，当我们假设CUPED系数<em class="og"> θ=1 </em>时，diff-in-diffs<strong class="lh ja">等价于CUPED </strong>。</p><pre class="kq kr ks kt gt nl nk nm nn aw no bi"><span id="8ced" class="np ml iq nk b gy nq nr l ns nt">df['revenue1_cuped2'] = df['revenue1'] - 1 * (df['revenue0'] - np.mean(df['revenue0']))<br/>smf.ols('revenue1_cuped2 ~ ad_campaign', data=df).fit().summary().tables[1]</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi pj"><img src="../Images/cd9ef3c70fe18e15ee7b43f6b01b7187.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FKZkmUMg4t3M5drKAXRo9Q.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">回归结果，图片由作者提供</p></figure><p id="b730" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">事实上，我们获得了相同的精确系数和几乎相同的标准误差！</p><h2 id="fd24" class="np ml iq bd mm nw nx dn mq ny nz dp mu lo oa ob mw ls oc od my lw oe of na iw bi translated">比较</h2><p id="c032" class="pw-post-body-paragraph lf lg iq lh b li nc ka lk ll nd kd ln lo ne lq lr ls nf lu lv lw ng ly lz ma ij bi translated">哪种方法比较好？从我们到目前为止所看到的，所有的方法似乎都提供了一个准确的估计，但简单的差异有一个较大的标准偏差。</p><p id="8965" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">现在让我们通过<strong class="lh ja">模拟</strong>来比较一下目前为止我们看到的所有方法。我们模拟数据生成过程<code class="fe nh ni nj nk b">dgp_cuped()</code> 1000次，并保存以下方法的估计系数:</p><ol class=""><li id="6744" class="ok ol iq lh b li lj ll lm lo om ls on lw oo ma pc oq or os bi translated">简单差异</li><li id="5e82" class="ok ol iq lh b li ot ll ou lo ov ls ow lw ox ma pc oq or os bi translated">自回归</li><li id="1850" class="ok ol iq lh b li ot ll ou lo ov ls ow lw ox ma pc oq or os bi translated">差异中的差异</li><li id="bd8f" class="ok ol iq lh b li ot ll ou lo ov ls ow lw ox ma pc oq or os bi translated">CUPED</li></ol><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="pk pl l"/></div></figure><p id="277d" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">让我们画出估计参数的分布图。</p><pre class="kq kr ks kt gt nl nk nm nn aw no bi"><span id="59e4" class="np ml iq nk b gy nq nr l ns nt">sns.kdeplot(data=results, x="Estimate", hue="Estimator");<br/>plt.axvline(x=2, c='k', ls='--');<br/>plt.title('Simulated Distributions');</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl nv"><img src="../Images/c6d6cce5ee4e7c4c0dfca3b47796ad27.png" data-original-src="https://miro.medium.com/v2/format:webp/1*IRQcMdekWPR3nZYWBfsU7Q.png"/></div><p class="lb lc gj gh gi ld le bd b be z dk translated">估计值的模拟分布，按作者分类的图像</p></figure><p id="248a" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我们还可以将每个估计量的模拟平均值和标准偏差制成表格。</p><pre class="kq kr ks kt gt nl nk nm nn aw no bi"><span id="c535" class="np ml iq nk b gy nq nr l ns nt">results.groupby('Estimator').agg(mean=("Estimate", "mean"), std=("Estimate", "std"))</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl nv"><img src="../Images/26f78fa55e47b2c74e6a20492b7af350.png" data-original-src="https://miro.medium.com/v2/format:webp/1*rbFJf3-GPfrbPgyYqBlB3Q.png"/></div><p class="lb lc gj gh gi ld le bd b be z dk translated">汇总表，按作者分类的图像</p></figure><p id="19fa" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">所有的估计值看起来都是无偏的(T21):平均值都接近真实值2。此外，除了单差估计量之外，所有估计量都有非常相似的标准差！</p><h2 id="5582" class="np ml iq bd mm nw nx dn mq ny nz dp mu lo oa ob mw ls oc od my lw oe of na iw bi translated">总是一模一样？</h2><p id="fbed" class="pw-post-body-paragraph lf lg iq lh b li nc ka lk ll nd kd ln lo ne lq lr ls nf lu lv lw ng ly lz ma ij bi translated">估计量总是相同的吗，或者它们之间有一些差异吗？</p><p id="254a" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我们可以检查许多与原始数据生成过程不同的地方。为了简单起见，这里我只考虑一种:<strong class="lh ja">不完全随机化</strong>。我考虑的对数据生成过程的其他调整是:</p><ul class=""><li id="b26c" class="ok ol iq lh b li lj ll lm lo om ls on lw oo ma op oq or os bi translated">预处理缺失值</li><li id="0864" class="ok ol iq lh b li ot ll ou lo ov ls ow lw ox ma op oq or os bi translated">附加协变量/控制变量</li><li id="40ac" class="ok ol iq lh b li ot ll ou lo ov ls ow lw ox ma op oq or os bi translated">多个预处理期</li><li id="1eaf" class="ok ol iq lh b li ot ll ou lo ov ls ow lw ox ma op oq or os bi translated">异质处理效果</li></ul><p id="8ebb" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">以及它们的组合。然而，我发现不完全随机是最能说明问题的例子。</p><p id="e16f" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">假设现在<strong class="lh ja">随机化不是完美的</strong>并且两个组是不相同的。特别是，如果数据生成过程</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi pm"><img src="../Images/8f3441546d6fae474f918c15fb4ce04b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DP4IYo3n44dRQhCR5enOtg.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">数据生成过程，按作者分类的图像</p></figure><p id="5a8b" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">假设<em class="og"> β </em> ≠0。还要注意，我们有<strong class="lh ja">持久的个体水平异质性</strong>，因为不可观察的<em class="og"> uᵢ </em>不随时间变化(不由<em class="og"> t </em>索引)。</p><pre class="kq kr ks kt gt nl nk nm nn aw no bi"><span id="fa22" class="np ml iq nk b gy nq nr l ns nt">results_beta1 = simulate(dgp=dgp_cuped(beta=1))</span></pre><p id="94ae" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">让我们画出估计参数的分布图。</p><pre class="kq kr ks kt gt nl nk nm nn aw no bi"><span id="33e3" class="np ml iq nk b gy nq nr l ns nt">sns.kdeplot(data=results_beta1, x="Estimate", hue="Estimator");<br/>plt.axvline(x=2, c='k', ls='--');<br/>plt.title('Simulated Distributions');</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl nv"><img src="../Images/b05c8f7a34a3000061b5c98eac9cce47.png" data-original-src="https://miro.medium.com/v2/format:webp/1*RiX3G30ZpAB69vHJtAJacQ.png"/></div><p class="lb lc gj gh gi ld le bd b be z dk translated">估计值的模拟分布，按作者分类的图像</p></figure><pre class="kq kr ks kt gt nl nk nm nn aw no bi"><span id="abeb" class="np ml iq nk b gy nq nr l ns nt">results_beta1.groupby('Estimator').agg(mean=("Estimate", "mean"), std=("Estimate", "std"))</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl nv"><img src="../Images/b33bc90606bfc959fbb891395a8581b9.png" data-original-src="https://miro.medium.com/v2/format:webp/1*PJa-Zp_d0xaqYvGmjFZaMg.png"/></div><p class="lb lc gj gh gi ld le bd b be z dk translated">汇总表，按作者分类的图像</p></figure><p id="db19" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在处理分配不完美的情况下，对于真实的处理效果，差异中的差异和自回归都是<strong class="lh ja">无偏的</strong>，然而，差异中的差异是<strong class="lh ja">更有效的</strong>。CUPED和simple difference都是<strong class="lh ja">偏向</strong>的。为什么？</p><p id="8c79" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">Diff-in-diffs明确控制治疗组和对照组之间的<strong class="lh ja">系统差异</strong>，这些差异<strong class="lh ja">随时间</strong>保持不变。这正是这个估算器的用途。自回归对额外的协变量<em class="og"> Y₀ </em>执行某种匹配，有效地控制了这些系统差异，但效率较低(如果你想知道更多，我在这里写了关于控制变量<a class="ae mb" rel="noopener" target="_blank" href="/b63dc69e3d8c">和这里</a>的相关帖子)。CUPED控制了个体水平的持续异质性，但没有控制治疗分配水平。最后，简单的差异估计不控制任何事情。</p></div><div class="ab cl md me hu mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ij ik il im in"><h1 id="238d" class="mk ml iq bd mm mn mo mp mq mr ms mt mu kf mv kg mw ki mx kj my kl mz km na nb bi translated">结论</h1><p id="f5ef" class="pw-post-body-paragraph lf lg iq lh b li nc ka lk ll nd kd ln lo ne lq lr ls nf lu lv lw ng ly lz ma ij bi translated">在这篇文章中，我分析了一个在业界非常流行的AB测试中平均处理效果的估计量:CUPED。关键思想是，通过利用预处理数据，CUPED可以<strong class="lh ja">通过控制随时间持续的个体水平变化来实现更低的方差</strong>。我们还看到，CUPED与自回归和差异中的差异密切相关，但并不等同。当我们进行不完全随机化时，这些方法之间的差异就很明显了。</p><p id="4a29" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">未来研究的一个有趣途径是，当我们拥有大量预处理信息时会发生什么，无论是在时间段还是可观察到的特征方面。来自Meta、【郭】、Coey、Konutgan、李、Schoener、Goldman (2021) 的科学家在最近的一篇论文中分析了这个问题，该论文利用机器学习技术来有效地使用这些额外的信息。这种方法与<a class="ae mb" href="https://academic.oup.com/ectj/article/21/1/C1/5056401" rel="noopener ugc nofollow" target="_blank">双/去偏置机器学习</a>文献密切相关。如果你感兴趣，我写了两篇关于这个主题的文章(<a class="ae mb" rel="noopener" target="_blank" href="/eb767a59975b">第一部分</a>和<a class="ae mb" rel="noopener" target="_blank" href="/bf990720a0b2">第二部分</a>)，以后我可能会写更多。</p><h2 id="8dac" class="np ml iq bd mm nw nx dn mq ny nz dp mu lo oa ob mw ls oc od my lw oe of na iw bi translated">参考</h2><p id="c34b" class="pw-post-body-paragraph lf lg iq lh b li nc ka lk ll nd kd ln lo ne lq lr ls nf lu lv lw ng ly lz ma ij bi translated">[1] A .邓，y .徐，r .科哈维，t .沃克，<a class="ae mb" href="https://dl.acm.org/doi/abs/10.1145/2433396.2433413" rel="noopener ugc nofollow" target="_blank">利用预实验数据提高在线对照实验的灵敏度</a> (2013)，<em class="og"/>。</p><p id="0236" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">[2] H. Xir，J. Aurisset，<a class="ae mb" href="https://dl.acm.org/doi/abs/10.1145/2939672.2939733" rel="noopener ugc nofollow" target="_blank">提高在线对照实验的灵敏度:网飞的案例研究</a> (2013)，<em class="og"> ACM SIGKDD </em>。</p><p id="3cae" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">[3] Y. Guo，D. Coey，M. Konutgan，W. Li，C. Schoener，M. Goldman，<a class="ae mb" href="https://proceedings.neurips.cc/paper/2021/hash/488b084119a1c7a4950f00706ec7ea16-Abstract.html" rel="noopener ugc nofollow" target="_blank">在线实验中方差缩减的机器学习</a> (2021)，<em class="og"> NeurIPS </em>。</p><p id="a388" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">[4] V. Chernozhukov，D. Chetverikov，M. Demirer，E. Duflo，C. Hansen，W. Newey，J. Robins，<a class="ae mb" href="https://academic.oup.com/ectj/article/21/1/C1/5056401" rel="noopener ugc nofollow" target="_blank">用于治疗和结构参数的双/去偏置机器学习</a> (2018)，<em class="og">计量经济学杂志</em>。</p><p id="545b" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">[5]我们应该在多大程度上相信差异中的差异估计值？ (2012年)<em class="og">《经济学季刊》</em>。</p><h2 id="fa5f" class="np ml iq bd mm nw nx dn mq ny nz dp mu lo oa ob mw ls oc od my lw oe of na iw bi translated">相关文章</h2><ul class=""><li id="b8e8" class="ok ol iq lh b li nc ll nd lo pn ls po lw pp ma op oq or os bi translated"><a class="ae mb" rel="noopener" target="_blank" href="/eb767a59975b">双去偏机器学习(第一部分)</a></li><li id="58f4" class="ok ol iq lh b li ot ll ou lo ov ls ow lw ox ma op oq or os bi translated"><a class="ae mb" rel="noopener" target="_blank" href="/bf990720a0b2">双去偏机器学习(第二部分)</a></li><li id="8936" class="ok ol iq lh b li ot ll ou lo ov ls ow lw ox ma op oq or os bi translated"><a class="ae mb" rel="noopener" target="_blank" href="/59f801eb3299">理解弗里希-沃-洛弗尔定理</a></li><li id="dce0" class="ok ol iq lh b li ot ll ou lo ov ls ow lw ox ma op oq or os bi translated"><a class="ae mb" rel="noopener" target="_blank" href="/58b63d25d2ef">了解污染偏差</a></li><li id="6845" class="ok ol iq lh b li ot ll ou lo ov ls ow lw ox ma op oq or os bi translated"><a class="ae mb" rel="noopener" target="_blank" href="/b63dc69e3d8c">Dag和控制变量</a></li></ul><h2 id="bea4" class="np ml iq bd mm nw nx dn mq ny nz dp mu lo oa ob mw ls oc od my lw oe of na iw bi translated">密码</h2><p id="af11" class="pw-post-body-paragraph lf lg iq lh b li nc ka lk ll nd kd ln lo ne lq lr ls nf lu lv lw ng ly lz ma ij bi translated">你可以在这里找到Jupyter的原始笔记本:</p><div class="pq pr gp gr ps pt"><a href="https://github.com/matteocourthoud/Blog-Posts/blob/main/notebooks/cuped.ipynb" rel="noopener  ugc nofollow" target="_blank"><div class="pu ab fo"><div class="pv ab pw cl cj px"><h2 class="bd ja gy z fp py fr fs pz fu fw iz bi translated">在main matter courthoud/Blog-Posts/cuped . ipynb</h2><div class="qa l"><h3 class="bd b gy z fp py fr fs pz fu fw dk translated">我的中型博客文章的代码和笔记本。为matteocourthoud/Blog-Posts的发展作出贡献</h3></div><div class="qb l"><p class="bd b dl z fp py fr fs pz fu fw dk translated">github.com</p></div></div></div></a></div></div><div class="ab cl md me hu mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ij ik il im in"><h2 id="0fdc" class="np ml iq bd mm nw nx dn mq ny nz dp mu lo oa ob mw ls oc od my lw oe of na iw bi translated">感谢您的阅读！</h2><p id="9647" class="pw-post-body-paragraph lf lg iq lh b li nc ka lk ll nd kd ln lo ne lq lr ls nf lu lv lw ng ly lz ma ij bi translated"><em class="og">我真的很感激！</em>🤗<em class="og">如果你喜欢这个帖子并想看更多，可以考虑</em> <a class="ae mb" href="https://medium.com/@matteo.courthoud" rel="noopener"> <strong class="lh ja"> <em class="og">关注我</em> </strong> </a> <em class="og">。我每周发布一次与因果推断和数据分析相关的主题。我尽量让我的帖子简单而精确，总是提供代码、例子和模拟。</em></p><p id="e6be" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><em class="og">还有，一个小小的</em> <strong class="lh ja"> <em class="og">免责声明</em> </strong> <em class="og">:我写作是为了学习所以出错是家常便饭，尽管我尽了最大努力。当你发现他们的时候，请告诉我。也很欣赏新话题的建议！</em></p></div></div>    
</body>
</html>