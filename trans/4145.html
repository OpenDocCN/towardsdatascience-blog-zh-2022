<html>
<head>
<title>Anomaly Detection for Multivariate Time Series with Structural Entropy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于结构熵的多元时间序列异常检测</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/anomaly-detection-for-multivariate-time-series-with-structural-entropy-63f9c34cb67#2022-09-14">https://towardsdatascience.com/anomaly-detection-for-multivariate-time-series-with-structural-entropy-63f9c34cb67#2022-09-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="df62" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何用现实例子发现时间序列相关性异常</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/36e3d1def9b9093d0c4cf8b36a4032a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*3tqvcOv-XkGmmP0P7ulSmQ.jpeg"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">图片由<a class="ae ku" href="https://pixabay.com/users/mediamodifier-1567646/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=3033203" rel="noopener ugc nofollow" target="_blank"> Mediamodifier </a>来自<a class="ae ku" href="https://pixabay.com//?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=3033203" rel="noopener ugc nofollow" target="_blank"> Pixabay </a></p></figure><p id="f643" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">熵可以区分随机性和确定性。在我之前关于用谱熵进行单变量随机时间序列的<a class="ae ku" href="https://medium.com/@ning.jia/anomaly-detection-in-univariate-stochastic-time-series-with-spectral-entropy-834b63ec9343?source=your_stories_page-------------------------------------" rel="noopener">异常检测的文章</a>中，我展示了谱熵的魔力。现在，我们将把话题转到多元时间序列中的异常检测，我们仍然试图在解决方案中使用熵。</p><p id="957d" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">多元时间序列有N个时间序列变量。每个变量不仅依赖于它过去的值，还依赖于其他变量。一个典型的异常是，对于某些数据点，这些变量的相互作用或相关性是不期望的。任何一个变量都不应该有明显的异常。否则，问题就变成了单变量时间序列异常检测。</p><p id="ed7a" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">例如，让我们谈论天气。温度和湿度一般是负相关的。随着温度的升高，湿度会降低。因此，即使温度相当高，只要水分停留在较低的区域，相应地匹配温度，你就会感到热。那是典型的大热天，不是异常。我不知道你住在哪里，但你可能在夏天经历过这样的日子:温度和湿度同时非常高的日子，这使你感到特别不舒服。这就是温度和湿度的时间序列的相关性出错的时候:多元时间序列中的异常。</p><h2 id="b043" class="lr ls it bd lt lu lv dn lw lx ly dp lz le ma mb mc li md me mf lm mg mh mi mj bi translated">关联和结构熵</h2><p id="7026" class="pw-post-body-paragraph kv kw it kx b ky mk ju la lb ml jx ld le mm lg lh li mn lk ll lm mo lo lp lq im bi translated">皮尔逊相关是时间序列相互作用的一种简单测量方法。对于一个有N个变量的多元时间序列，我们会有C(N，2)个相关(从N中选两个)或者一个N*N相关矩阵(上三角和下三角是一样的)。</p><p id="b570" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我们想知道这个矩阵包含了多少信息。常见的方法是应用聚类算法来挖掘矩阵中的<strong class="kx iu">结构信息</strong>。下面是一个对相关矩阵使用层次聚类的示例。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mp"><img src="../Images/1477f521ae75a4c59548431533206ef3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sKptSHfZWJu2n8o1S3J67A.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">图片由<a class="ae ku" href="https://www.kaggle.com/sgalella" rel="noopener ugc nofollow" target="_blank">桑蒂</a>经许可来自<a class="ae ku" href="https://www.kaggle.com/code/sgalella/correlation-heatmaps-with-hierarchical-clustering" rel="noopener ugc nofollow" target="_blank">卡格尔</a></p></figure><p id="c9f2" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">接下来，我们将应用熵的概念。熵可以基于矩阵的结构来定义，特别是满足某个阈值的重要聚类的数量。假设所有变量都高度相关。将只有一个聚类，多元时间序列中包含的相关信息最小。另一种极端情况，N个时间序列全部不相关，会有N个聚类，多元时间序列包含的相关信息最大。研究人员提出了这种熵，并将其命名为<strong class="kx iu">结构熵</strong>。</p><p id="e404" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">使用结构熵，我们可以将一组时间序列转换成熵值的单个时间序列，这捕获了我们感兴趣的相关性的运动。如果我们想监控相关性并捕捉异常，这种转换特别有用。我们将在下面两个真实数据的例子中看到这一点。</p><h2 id="2174" class="lr ls it bd lt lu lv dn lw lx ly dp lz le ma mb mc li md me mf lm mg mh mi mj bi translated">轨迹数据集</h2><p id="29c3" class="pw-post-body-paragraph kv kw it kx b ky mk ju la lb ml jx ld le mm lg lh li mn lk ll lm mo lo lp lq im bi translated">我们有西雅图伯克吉尔曼步道的数据集。它是通过监控步道上的行人和骑车人生成的。描述说，“混凝土中菱形排列的电线探测自行车，安装在木柱上的红外传感器探测行人。计数器还能捕捉自行车和行人的行驶方向”。这个公共数据集可以从<a class="ae ku" href="https://www.kaggle.com/datasets/city-of-seattle/seattle-burke-gilman-trail?datasetId=34281&amp;sortBy=dateRun&amp;tab=profile" rel="noopener ugc nofollow" target="_blank"> Kaggle </a>下载。</p><p id="0f38" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">数据集有四列:Ped South、Ped North、Bike North和Bike South，表示南/北方向的行人/骑车人的人数。在日水平上对2019年进行聚合后，我们有一个包含四个变量的多元时间序列。每个时间序列都有季节性和趋势性。图1显示了四个密度图。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mu"><img src="../Images/d6bb5de18f0b107224e7793c71dd5628.png" data-original-src="https://miro.medium.com/v2/resize:fit:814/format:webp/1*gsoOTOIXwtBlqQEBjZs3fA.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">图1:四列的密度图，图片由作者提供</p></figure><p id="ef55" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">预计两个方向的行人/骑车人数量应该高度相关。例如，如果在一个好天气里，更多的骑车人出现在南行的路上，那么更多的骑车人应该出现在北行的路上。</p><p id="250a" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">图2将数据显示为多元时间序列。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mv"><img src="../Images/eb7a5d27c5e71ff9b553e590e8a70fa8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cl9CYsM4PnqN6IhUfJ_rmw.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">情节2:4列时间序列，作者提供的图像</p></figure><p id="b5ae" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">如果我们仔细观察这个情节，我们可以发现一些有趣的反常现象。在8月的一些日子里，虽然去南方的行人数量增加了，但去北方的行人数量却减少了。八月的骑车人也有类似的异常区域。</p><p id="b6cc" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">为了展示这些异常，我还在右边的第二个y轴上绘制了两个窗口大小为10天的滚动相关性。这两条灰线清楚地显示了相关性在8月份的变化。</p><p id="6dbd" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">现在我们来计算结构熵。这里涉及到两个参数。首先是窗口大小。还是用10天吧。第二个是用于聚类相关矩阵的阈值。因为我们认为两个方向的数字应该是高度相关的，所以我们用0.8。图3显示了最终的结构熵曲线。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mw"><img src="../Images/14740e7aec46bbec1824f77c13a854cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h_8OyqGQfhQanTdd_Xm-gg.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">情节三:结构熵曲线，作者图片</p></figure><p id="1d0d" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我们可以看到8月份的峰值，这意味着相关性的不确定性增加。它能告诉我们除了八月异常以外的更多信息。从3月到8月的大部分时间，该值为0。这意味着四个变量高度相关。在一年的其余时间里，该值为1。这意味着矩阵中有两个集群:Ped南与Ped北，以及Bike南与Bike北。一般来说，两个方向都是相关的，但行人和骑自行车的人没有太多的联系。也许这背后的原因是温度和天气。</p><p id="caae" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">在八月下旬，熵可以上升到2。这意味着四个变量之间没有特定的相关性。2019年8月发生了什么？我们应该把它当作一个真正的异常吗？</p><p id="3f7a" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">说实话，我也不知道原因。我在搜索“西雅图伯克吉尔曼步道2019年8月”后发现了‘新闻’:8月16日至8月18日，步道因树木移除工作而关闭。这一事件可能会导致持续三天以上的混乱。人们可能会在看到工作通知标志后，甚至在工作完成后绕道而行。工作地点、传感器和标志可能会影响人们选择路线的方式。</p><p id="77b0" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">但从数据角度来看，8月份确实看起来不正常。如果我们放大8月的数据，我们会将8月4日、8月13日和8月24日标记为明显异常。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mx"><img src="../Images/4999b92b0324540fb8e9236fd63d1376.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_D2lldXbPiUSzbJD6Q_yQw.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">图4，放大八月份的数据，图片由作者提供</p></figure><p id="fa05" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">从这个例子中，我们可以看出，当多元时间序列的相关性从可预测的确定性变为不可预测的随机性时，结构熵将捕捉到奇数时刻。</p><p id="b9c3" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">接下来是另一种异常方式的例子。</p><h2 id="3797" class="lr ls it bd lt lu lv dn lw lx ly dp lz le ma mb mc li md me mf lm mg mh mi mj bi translated">市场数据集</h2><p id="b9b7" class="pw-post-body-paragraph kv kw it kx b ky mk ju la lb ml jx ld le mm lg lh li mn lk ll lm mo lo lp lq im bi translated">结构熵的思想最早应用于股票市场分析。在这个例子中，异常表现为随机性的确定性或一堆不相关的相关性。</p><p id="53ee" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我从雅虎API下载了大约400只加拿大主要股票的价格历史。然后，我用百分比计算日收益率，得到每只股票的时间序列。图5显示了其中的20个每日回报时间序列。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi my"><img src="../Images/323b0759b28024eb444c08119c2d2830.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ftdqcu6JgsblRplNITzVCA.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">图5，每日股票回报的多元时间序列，图片由作者提供</p></figure><p id="9239" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">然后，我们计算所有序列的结构熵，并获得一个新的熵时间序列，如图表6所示。最显著的异常发生在2020年4月左右，当时市场受到covid 19的严重打击。大约在那个时期，几乎所有的股票都朝着同一个方向运动:走低。熊市没有不确定性，熵一度接近于零。在其他时期，熵值在4和8之间变化。这标志着一个正常的市场:一些股票/板块在上涨，一些在下跌。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mz"><img src="../Images/11e0163677bbfb0b3a63e8fee685402d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-AspyMLnbZUtaUbX-v2oXQ.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">情节6，结构熵，作者图像</p></figure><h2 id="ed4e" class="lr ls it bd lt lu lv dn lw lx ly dp lz le ma mb mc li md me mf lm mg mh mi mj bi translated">结论</h2><p id="f108" class="pw-post-body-paragraph kv kw it kx b ky mk ju la lb ml jx ld le mm lg lh li mn lk ll lm mo lo lp lq im bi translated">如果变量的相关性是我们关心的，结构熵提供了一个强有力的工具来检测多元时间序列数据中的异常。它可以捕捉相关时间序列变得不相关的时刻，反之亦然。很容易理解和计算。我建议数据科学家探索这一工具，用于多元时间序列中的异常检测任务。</p><p id="e272" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">以后我会分享更多时间序列数据的经验教训。</p><p id="ef72" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">感谢阅读。享受你的时间序列数据。</p><h2 id="7755" class="lr ls it bd lt lu lv dn lw lx ly dp lz le ma mb mc li md me mf lm mg mh mi mj bi translated">参考</h2><p id="e815" class="pw-post-body-paragraph kv kw it kx b ky mk ju la lb ml jx ld le mm lg lh li mn lk ll lm mo lo lp lq im bi translated"><a class="ae ku" href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6658667/" rel="noopener ugc nofollow" target="_blank">结构熵:随着时间的推移监测基于相关性的网络，并应用于金融市场</a></p><p id="bddc" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">西雅图伯克吉尔曼踪迹数据(CC0:公共领域)</p><p id="2a64" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">Yahoo Finance API(BSD 3-条款“新”或“修订”许可证)</p></div></div>    
</body>
</html>