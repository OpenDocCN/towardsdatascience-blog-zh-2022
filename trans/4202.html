<html>
<head>
<title>How to Test Pandas ETL Data Pipeline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何测试熊猫ETL数据管道</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-test-pandas-etl-data-pipeline-e49fb5dac4ce#2022-09-19">https://towardsdatascience.com/how-to-test-pandas-etl-data-pipeline-e49fb5dac4ce#2022-09-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="eb61" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated"><em class="ki">满怀期望地测试您的熊猫ETL数据管道</em></h2></div><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/984435a1d7a2e7426034ed5a8cc21730.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jMeWfwsZhRDhecGB"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">照片由<a class="ae kz" href="https://unsplash.com/es/@selimarda?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">seli̇m·阿尔达·埃尔伊尔马兹</a>在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h1 id="570c" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">介绍</h1><p id="7283" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">构建强大的数据管道绝非易事。构建数据管道时出现的常见问题包括“我如何知道我的数据管道是否在做它应该做的事情？”以及“我能信任我的数据管道的输出吗？”。</p><p id="65cf" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">这就是在我们的数据管道的输出上构建和执行测试有所帮助的时候。如果数据管道输出通过了一系列全面的测试，我们就可以相当有把握地认为数据管道正在按照预期的方式工作。一种常见的方法是对输出数据执行断言。然而，创建处理大量场景的断言是一项单调乏味的任务。在本文中，我们将通过一个例子来说明如何利用python的Great Expectations [1]库及其现成的数据断言来执行这样的测试。</p><h1 id="a1e9" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">设置</h1><p id="306b" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">以下设置用于该示例。</p><ol class=""><li id="8b42" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn my mz na nb bi translated">虚拟代码</li><li id="b401" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">python 3.9</li><li id="a9e6" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated"><code class="fe nh ni nj nk b">pip install great_expectations==0.15.22</code></li><li id="379e" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated"><code class="fe nh ni nj nk b">pip install Pandas==1.4.3</code></li><li id="a102" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">数据集:泰坦尼克号[2]</li></ol><h1 id="b6a1" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">例子</h1><p id="65b3" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">在本节中，我们将探索在VSCode中使用Jupyter Notebook创建期望和期望套件的基础。</p><p id="d9a2" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><strong class="lu iu">什么是期望？</strong></p><p id="baf2" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">期望是对数据的断言。本质上，我们是在检查数据是否是我们所期望的。这里有一些期望的例子。</p><pre class="kk kl km kn gt nl nk nm nn aw no bi"><span id="da47" class="np lb it nk b gy nq nr l ns nt">expect_column_values_to_be_not_null</span><span id="3ce8" class="np lb it nk b gy nu nr l ns nt">expect_column_values_to_be_unique</span><span id="7e3e" class="np lb it nk b gy nu nr l ns nt">expect_column_values_to_match_regex</span><span id="eecd" class="np lb it nk b gy nu nr l ns nt">expect_column_median_to_be_between</span><span id="4c2f" class="np lb it nk b gy nu nr l ns nt">expect_table_row_count_to_be_between</span></pre><p id="1266" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">期望的名字很好地描述了期望的作用。伟大的期望伴随着丰富的现成期望<a class="ae kz" href="https://greatexpectations.io/expectations" rel="noopener ugc nofollow" target="_blank"/>。您还可以通过创建<a class="ae kz" href="https://docs.greatexpectations.io/docs/guides/expectations/creating_custom_expectations/overview/" rel="noopener ugc nofollow" target="_blank">自定义期望</a>来扩展Great Expectation的功能。</p><p id="1095" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><strong class="lu iu">什么是期望套件？</strong></p><p id="420b" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">期望套件仅仅是期望的集合。</p><h1 id="c767" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">浏览数据</h1><p id="5550" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated"><code class="fe nh ni nj nk b"><strong class="lu iu">File: explore.ipynb</strong></code></p><p id="9b0a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我们将在下面的例子中使用Titanic[2]数据集。让我们快速浏览一下数据集。我们有两组数据—训练和测试。</p><pre class="kk kl km kn gt nl nk nm nn aw no bi"><span id="266d" class="np lb it nk b gy nq nr l ns nt">#explore.ipynb</span><span id="87e3" class="np lb it nk b gy nu nr l ns nt">import pandas as pd</span><span id="44e3" class="np lb it nk b gy nu nr l ns nt">df_train = pd.read_csv('path/to/data/titanic-train.csv')<br/>df_train.head()</span></pre><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nv"><img src="../Images/9aa19b0c4b8ede7e0c12c80f19733f30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Giliyx3VtzHpfFSO"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">作者图片</p></figure><pre class="kk kl km kn gt nl nk nm nn aw no bi"><span id="5a6d" class="np lb it nk b gy nq nr l ns nt">df_train.info()</span></pre><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/d325a094eaf6b21a47bc68905ab7510f.png" data-original-src="https://miro.medium.com/v2/resize:fit:796/0*LU3LgqzYZEP04k1S"/></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">作者图片</p></figure><pre class="kk kl km kn gt nl nk nm nn aw no bi"><span id="b18d" class="np lb it nk b gy nq nr l ns nt">df_test = pd.read_csv('path/to/data/titanic-test.csv')<br/>df_test.head()</span></pre><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nx"><img src="../Images/e2321030a704d14abdd343c35a94d2e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ghQqbiqtHkfChdk1"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">作者图片</p></figure><p id="2703" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><code class="fe nh ni nj nk b">df_test</code>中的列与<code class="fe nh ni nj nk b">df_train</code>相同，只是少了<code class="fe nh ni nj nk b">Survived</code>列。</p><h1 id="aa3e" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">数据处理</h1><p id="04d3" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated"><code class="fe nh ni nj nk b">File: pipeline.py</code></p><p id="f996" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在本节中，我们执行简单的数据处理步骤。<code class="fe nh ni nj nk b">pipeline.py</code>由两个函数<code class="fe nh ni nj nk b">process_data</code>和<code class="fe nh ni nj nk b">run_pipeline</code>组成。</p><pre class="kk kl km kn gt nl nk nm nn aw no bi"><span id="9f39" class="np lb it nk b gy nq nr l ns nt">#pipeline.py<br/>import pandas as pd</span><span id="3d3c" class="np lb it nk b gy nu nr l ns nt">def process_data(df: pd.DataFrame) -&gt; pd.DataFrame:<br/>    <br/>    df_output = (df<br/>                 .drop(columns = ['Name', 'Ticket'])<br/>                 .rename({i:i.lower() for i in df.columns.to_list()}, axis = 1)<br/>                 .assign(age = lambda x: x.age.fillna(x.age.mean()).astype('int'))<br/>                 )<br/>        <br/>    return df_output</span><span id="a3bb" class="np lb it nk b gy nu nr l ns nt">def run_pipeline(input_path: str, output_path: str, save = True) -&gt; pd.DataFrame:<br/>    <br/>    df = pd.read_csv(input_path)<br/>    df_processed = process_data(df)<br/>    <br/>    if save:<br/>        df_processed.to_csv(output_path, index = False)<br/>    <br/>    return df_processed</span></pre><p id="0cd4" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><code class="fe nh ni nj nk b">process_data</code>执行以下数据处理步骤:</p><ol class=""><li id="2ef8" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn my mz na nb bi translated">删除<code class="fe nh ni nj nk b">Name</code>和<code class="fe nh ni nj nk b">Ticket</code>列</li><li id="f171" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">小写所有列名</li><li id="a150" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">用平均值填充缺失的<code class="fe nh ni nj nk b">Age</code>列</li></ol><p id="c639" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><code class="fe nh ni nj nk b">run_pipeline</code>将数据读入Pandas数据帧，在数据帧上调用<code class="fe nh ni nj nk b">process_data</code>并返回处理后的数据帧。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi ny"><img src="../Images/ca5e060ac0a3198b432fc0e8d5993581.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fPqZiYBy49iqVWIB"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">作者图片</p></figure><h1 id="6422" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">创造期望和套件</h1><p id="ed47" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated"><code class="fe nh ni nj nk b">File: create_expectations.ipynb</code></p><p id="d79e" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在本笔记本中，我们创建了期望和期望套件来验证我们管道的输出。提出一套全面的检查是一个反复的过程。它需要对数据和领域的理解。首先，尝试执行探索性数据分析，并与领域专家交流，以了解数据是如何收集的，数据字段的含义以及如何利用数据管道的输出。</p><p id="9bdc" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">主要目标是:( a)检查数据管道是否正确处理了数据;( b)确定是否存在任何明显的数据质量问题。</p><p id="eed6" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">创建的期望将验证是否:</p><ol class=""><li id="51c6" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn my mz na nb bi translated">存在指定的列</li><li id="4553" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated"><code class="fe nh ni nj nk b">age</code>列中有空值</li><li id="d8f0" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated"><code class="fe nh ni nj nk b">passengerid</code>列中的值不同</li><li id="40cf" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">如果<code class="fe nh ni nj nk b">gender</code>栏中有除“男性”和“女性”以外的其他值</li></ol><p id="284a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><strong class="lu iu">导入库</strong></p><pre class="kk kl km kn gt nl nk nm nn aw no bi"><span id="015d" class="np lb it nk b gy nq nr l ns nt">import great_expectations as ge<br/>import pandas as pd<br/>import json<br/>import pipeline</span></pre><p id="2b9a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><strong class="lu iu">运行管道</strong></p><pre class="kk kl km kn gt nl nk nm nn aw no bi"><span id="f3be" class="np lb it nk b gy nq nr l ns nt">input_path = 'path/to/data/titanic-train.csv'<br/>output_path = 'path/to/data/titanic-train-processed.csv'</span><span id="33c7" class="np lb it nk b gy nu nr l ns nt">df = pipeline.run_pipeline(input_path, output_path)<br/>gdf = ge.from_pandas(df)</span></pre><p id="f9e9" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><code class="fe nh ni nj nk b">df</code>包含已处理的数据帧，并被转换为<code class="fe nh ni nj nk b">great_expectations.dataset.pandas_dataset.PandasDataset</code>，允许将远大前程方法应用于熊猫数据帧。下图显示了数据帧处理后的结果。</p><pre class="kk kl km kn gt nl nk nm nn aw no bi"><span id="2697" class="np lb it nk b gy nq nr l ns nt">gdf.head()</span></pre><p id="acb9" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><strong class="lu iu">创造期望</strong></p><p id="ea45" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">让我们使用<code class="fe nh ni nj nk b">expect_table_columns_to_match_set</code>方法验证表输入表列名是否正确。我们提供预期的列名，并检查数据帧中的列名是否与我们提供的相匹配。</p><pre class="kk kl km kn gt nl nk nm nn aw no bi"><span id="3d1a" class="np lb it nk b gy nq nr l ns nt">expected_columns = \\<br/>    ['passengerid', 'survived', 'pclass', 'sex', 'age', 'sibsp', 'parch', 'fare', 'cabin', 'embarked']<br/>gdf.expect_table_columns_to_match_set(column_set = expected_columns)</span></pre><p id="343f" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">运行上面的代码会返回下面的输出。<code class="fe nh ni nj nk b">"success":true</code>表示测试已通过。</p><pre class="kk kl km kn gt nl nk nm nn aw no bi"><span id="4909" class="np lb it nk b gy nq nr l ns nt"># output<br/>{<br/>  "exception_info": {<br/>    "raised_exception": false,<br/>    "exception_traceback": null,<br/>    "exception_message": null<br/>  },<br/>  "result": {<br/>    "observed_value": [<br/>      "passengerid",<br/>      "survived",<br/>      "pclass",<br/>      "sex",<br/>      "age",<br/>      "sibsp",<br/>      "parch",<br/>      "fare",<br/>      "cabin",<br/>      "embarked"<br/>    ]<br/>  },<br/>  "meta": {},<br/>  "success": true<br/>}</span></pre><p id="1576" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">由于我们已经在数据处理步骤中进行了插补，<code class="fe nh ni nj nk b">age</code>列不应包含任何空值。我们可以使用<code class="fe nh ni nj nk b">expect_column_values_to_not_be_null</code>来验证这一点。</p><pre class="kk kl km kn gt nl nk nm nn aw no bi"><span id="a317" class="np lb it nk b gy nq nr l ns nt">gdf.expect_column_values_to_not_be_null(column = 'age')</span><span id="e008" class="np lb it nk b gy nu nr l ns nt">#output<br/>{<br/>  "exception_info": {<br/>    "raised_exception": false,<br/>    "exception_traceback": null,<br/>    "exception_message": null<br/>  },<br/>  "result": {<br/>    "element_count": 891,<br/>    "unexpected_count": 0,<br/>    "unexpected_percent": 0.0,<br/>    "unexpected_percent_total": 0.0,<br/>    "partial_unexpected_list": []<br/>  },<br/>  "meta": {},<br/>  "success": true<br/>}</span></pre><p id="0af9" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><code class="fe nh ni nj nk b">passengerid</code>列包含每个乘客的唯一标识符。由于数据集中的每一行都代表单个乘客的信息，所以不应该有重复的<code class="fe nh ni nj nk b">passengerid</code>。我们可以用<code class="fe nh ni nj nk b">expect_column_values_to_be_unique</code>方法来验证这一点。</p><pre class="kk kl km kn gt nl nk nm nn aw no bi"><span id="4797" class="np lb it nk b gy nq nr l ns nt">gdf.expect_column_values_to_be_unique(column = 'passengerid')</span><span id="bf66" class="np lb it nk b gy nu nr l ns nt">#output<br/>{<br/>  "exception_info": {<br/>    "raised_exception": false,<br/>    "exception_traceback": null,<br/>    "exception_message": null<br/>  },<br/>  "result": {<br/>    "element_count": 891,<br/>    "missing_count": 0,<br/>    "missing_percent": 0.0,<br/>    "unexpected_count": 0,<br/>    "unexpected_percent": 0.0,<br/>    "unexpected_percent_total": 0.0,<br/>    "unexpected_percent_nonmissing": 0.0,<br/>    "partial_unexpected_list": []<br/>  },<br/>  "meta": {},<br/>  "success": true<br/>}</span></pre><p id="ccbe" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我们可以通过使用<code class="fe nh ni nj nk b">expect_column_values_to_be_in_set</code>方法来验证一个列是否包含正确的值集。在这种情况下，<code class="fe nh ni nj nk b">sex</code>列中的值只能是“男性”或“女性”。</p><pre class="kk kl km kn gt nl nk nm nn aw no bi"><span id="054c" class="np lb it nk b gy nq nr l ns nt">gdf.expect_column_values_to_be_in_set(column = 'sex', value_set=['male', 'female'])</span><span id="2bff" class="np lb it nk b gy nu nr l ns nt">{<br/>  "exception_info": {<br/>    "raised_exception": false,<br/>    "exception_traceback": null,<br/>    "exception_message": null<br/>  },<br/>  "result": {<br/>    "element_count": 891,<br/>    "missing_count": 0,<br/>    "missing_percent": 0.0,<br/>    "unexpected_count": 0,<br/>    "unexpected_percent": 0.0,<br/>    "unexpected_percent_total": 0.0,<br/>    "unexpected_percent_nonmissing": 0.0,<br/>    "partial_unexpected_list": []<br/>  },<br/>  "meta": {},<br/>  "success": true<br/>}</span></pre><p id="839b" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><strong class="lu iu">创建期望套件</strong></p><p id="d762" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我们可以从上面的个人期望中创建一个期望套件。一个期望套件仅仅是一个期望的集合，这些期望被一起用来验证一个数据集。</p><pre class="kk kl km kn gt nl nk nm nn aw no bi"><span id="61c5" class="np lb it nk b gy nq nr l ns nt">expectation_suite = gdf.get_expectation_suite(discard_failed_expectations=False)</span></pre><p id="fc4a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">默认情况下<code class="fe nh ni nj nk b">get_expectation_suite</code>只返回<code class="fe nh ni nj nk b">success: true</code>的期望值。将<code class="fe nh ni nj nk b">discard_failed_expectations</code>设置为<code class="fe nh ni nj nk b">False</code>，以返回所有期望值。期望套件是一个字典，包含我们之前创建的4个期望的配置。</p><pre class="kk kl km kn gt nl nk nm nn aw no bi"><span id="20b5" class="np lb it nk b gy nq nr l ns nt"># expectation_suite</span><span id="bd6c" class="np lb it nk b gy nu nr l ns nt">{<br/>  "ge_cloud_id": null,<br/>  "expectation_suite_name": "default",<br/>  "expectations": [<br/>    {<br/>      "expectation_type": "expect_column_values_to_be_unique",<br/>      "kwargs": {<br/>        "column": "passengerid"<br/>      },<br/>      "meta": {}<br/>    },<br/>    {<br/>      "expectation_type": "expect_column_values_to_be_in_set",<br/>      "kwargs": {<br/>        "column": "sex",<br/>        "value_set": [<br/>          "male",<br/>          "female"<br/>        ]<br/>      },<br/>      "meta": {}<br/>    },<br/>    {<br/>      "expectation_type": "expect_table_columns_to_match_set",<br/>      "kwargs": {<br/>        "column_set": [<br/>          "passengerid",<br/>          "survived",<br/>          "pclass",<br/>          "sex",<br/>          "age",<br/>          "sibsp",<br/>          "parch",<br/>          "fare",<br/>          "cabin",<br/>          "embarked"<br/>        ]<br/>      },<br/>      "meta": {}<br/>    },<br/>    {<br/>      "expectation_type": "expect_column_values_to_not_be_null",<br/>      "kwargs": {<br/>        "column": "age"<br/>      },<br/>      "meta": {}<br/>    }<br/>  ],<br/>  "meta": {<br/>    "great_expectations_version": "0.15.22"<br/>  },<br/>  "data_asset_type": "Dataset"<br/>}</span></pre><p id="2c5e" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">期望套件可以保存为一个JSON文件。</p><pre class="kk kl km kn gt nl nk nm nn aw no bi"><span id="3433" class="np lb it nk b gy nq nr l ns nt">with open( "my_expectation_file.json", "w") as my_file:<br/>    my_file.write(<br/>        json.dumps(expectation_suite.to_json_dict())<br/>    )</span></pre><p id="bb64" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">现在我们已经创建了一个期望套件，让我们来看看如何使用期望套件来测试新的未知数据的数据管道。</p><h1 id="022a" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">验证数据</h1><p id="0b6b" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated"><code class="fe nh ni nj nk b">File: validate_expectations.ipynb</code></p><p id="8c72" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在这本笔记本中，我们展示了如何验证新数据集是否满足预定义的预期。我们将通过数据管道(<code class="fe nh ni nj nk b">pipeline.py</code>)传递新数据，并根据我们之前创建的期望套件来验证数据输出。</p><p id="0759" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><strong class="lu iu">导入库</strong></p><pre class="kk kl km kn gt nl nk nm nn aw no bi"><span id="a845" class="np lb it nk b gy nq nr l ns nt">import great_expectations as ge<br/>import pandas as pd<br/>import json<br/>import pipeline</span></pre><p id="9bb7" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">让我们把新的数据通过和以前一样的数据处理管道。</p><pre class="kk kl km kn gt nl nk nm nn aw no bi"><span id="9661" class="np lb it nk b gy nq nr l ns nt">input_path = 'path/to/data/titanic-test.csv'<br/>output_path = 'path/to/data/titanic-test-processed.csv'</span><span id="ebb9" class="np lb it nk b gy nu nr l ns nt">df = pipeline.run_pipeline(input_path, output_path)<br/>gdf = ge.from_pandas(df)</span></pre><p id="e3ca" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我们创建两个函数来(a)加载期望套件和(b)根据期望套件验证数据。</p><pre class="kk kl km kn gt nl nk nm nn aw no bi"><span id="b6c8" class="np lb it nk b gy nq nr l ns nt">def load_expectation_suite(path: str) -&gt; dict:<br/>    """Load expectation suite stored in JSON format<br/>    and convert into dictionary.</span><span id="2672" class="np lb it nk b gy nu nr l ns nt">    Args:<br/>        path (str): path to expectation suite json file</span><span id="c11d" class="np lb it nk b gy nu nr l ns nt">    Returns:<br/>        dict: expectation suite<br/>    """</span><span id="c2a1" class="np lb it nk b gy nu nr l ns nt">    with open(path, 'r') as f:<br/>        expectation_suite = json.load(f)</span><span id="9e8c" class="np lb it nk b gy nu nr l ns nt">    return expectation_suite</span><span id="d0b6" class="np lb it nk b gy nu nr l ns nt">def great_expectation_validation(df: pd.DataFrame,<br/>                                 expectation_suite_path: str) -&gt; dict:<br/>    """Run validation on DataFrame based on expecation suite</span><span id="8e2d" class="np lb it nk b gy nu nr l ns nt">    Args:<br/>        df (pd.DataFrame): DataFrame to validate<br/>        expectation_suite_path (str): path to expectation suite json file</span><span id="5e9d" class="np lb it nk b gy nu nr l ns nt">    Returns:<br/>        dict: Validation result<br/>    """</span><span id="9718" class="np lb it nk b gy nu nr l ns nt">    expectation_suite = load_expectation_suite(expectation_suite_path)<br/>    gdf = ge.from_pandas(df, expectation_suite=expectation_suite)<br/>    validation_results = gdf.validate(result_format = 'SUMMARY', catch_exceptions = True)</span><span id="b7d3" class="np lb it nk b gy nu nr l ns nt">    return validation_results</span></pre><p id="3f95" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">运行<code class="fe nh ni nj nk b">great_expectation_validation</code>函数获取验证结果。</p><pre class="kk kl km kn gt nl nk nm nn aw no bi"><span id="e54d" class="np lb it nk b gy nq nr l ns nt">validation_result = \\<br/>    great_expectation_validation(df = df_processed, <br/>                                 expectation_suite_path = 'my_expectation_file.json')</span></pre><p id="8c8c" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><code class="fe nh ni nj nk b">validation_result</code>是字典的形式。总体验证结果可在此处找到:</p><pre class="kk kl km kn gt nl nk nm nn aw no bi"><span id="abf3" class="np lb it nk b gy nq nr l ns nt">validation_result['success']</span><span id="fb0c" class="np lb it nk b gy nu nr l ns nt"># output:<br/># False</span></pre><p id="3cab" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><code class="fe nh ni nj nk b">Fasle</code>表示期望套件中至少有一个期望失败。<code class="fe nh ni nj nk b">True</code>表示数据通过了预期套件中的所有测试。</p><p id="da92" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">通过和未通过期望的汇总统计数据可在此处找到:</p><pre class="kk kl km kn gt nl nk nm nn aw no bi"><span id="3f47" class="np lb it nk b gy nq nr l ns nt">validation_result['statistics']</span><span id="5435" class="np lb it nk b gy nu nr l ns nt"># output:<br/># {'evaluated_expectations': 4,<br/># 'successful_expectations': 3,<br/># 'unsuccessful_expectations': 1,<br/># 'success_percent': 75.0}</span></pre><p id="a999" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我们评估了4个期望，其中一个失败了。要查看哪些期望失败:</p><pre class="kk kl km kn gt nl nk nm nn aw no bi"><span id="8e0e" class="np lb it nk b gy nq nr l ns nt">for r in validation_result['results']:<br/>    if not(r['success']):<br/>        print (f"failed: {r['expectation_config']['expectation_type']}")<br/>    else:<br/>        print (f"success: {r['expectation_config']['expectation_type']}")</span><span id="a518" class="np lb it nk b gy nu nr l ns nt"># output:<br/># failed: expect_table_columns_to_match_set<br/># success: expect_column_values_to_be_unique<br/># success: expect_column_values_to_not_be_null<br/># success: expect_column_values_to_be_in_set</span></pre><p id="2737" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">由于<code class="fe nh ni nj nk b">survived</code>列丢失，我们未能通过<code class="fe nh ni nj nk b">expect_table_columns_to_match_set</code>。</p><pre class="kk kl km kn gt nl nk nm nn aw no bi"><span id="2d93" class="np lb it nk b gy nq nr l ns nt">{<br/>  "result": {<br/>    "observed_value": [<br/>      "age",<br/>      "cabin",<br/>      "embarked",<br/>      "fare",<br/>      "parch",<br/>      "passengerid",<br/>      "pclass",<br/>      "sex",<br/>      "sibsp"<br/>    ],<br/>    "details": {<br/>      "mismatched": {<br/>        "missing": [<br/>          **"survived"**<br/>        ]<br/>      }<br/>    }<br/>  },<br/>  "exception_info": {<br/>    "raised_exception": false,<br/>    "exception_message": null,<br/>    "exception_traceback": null<br/>  },<br/>  "meta": {},<br/>  "success": false<br/>}</span></pre><h1 id="9698" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">结论</h1><p id="9138" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">为您的数据管道创建一套全面的测试有助于确保管道按预期工作。在本文中，我们演示了如何在Great Expectations中使用开箱即用的期望来测试您的Pandas ETL数据管道。</p></div><div class="ab cl nz oa hx ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="im in io ip iq"><p id="ae5b" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><a class="ae kz" href="https://medium.com/@edwin.tan/membership" rel="noopener">加入Medium </a>阅读更多这样的故事！</p></div><div class="ab cl nz oa hx ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="im in io ip iq"><h1 id="d9b7" class="la lb it bd lc ld og lf lg lh oh lj lk jz oi ka lm kc oj kd lo kf ok kg lq lr bi translated">参考</h1><p id="9378" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">[1]https://greatexpectations.io/<a class="ae kz" href="https://greatexpectations.io/" rel="noopener ugc nofollow" target="_blank"/></p><p id="0f59" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">[2] <a class="ae kz" href="https://www.openml.org/search?type=data&amp;sort=runs&amp;id=40945&amp;status=active" rel="noopener ugc nofollow" target="_blank">泰坦尼克号数据集</a>。作者:小弗兰克·哈勒尔，托马斯·卡森。许可证:公共</p></div></div>    
</body>
</html>