<html>
<head>
<title>SageMaker Custom Multi-Container Endpoints</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SageMaker定制多容器端点</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/sagemaker-custom-multi-container-endpoints-21123f794c58#2022-04-07">https://towardsdatascience.com/sagemaker-custom-multi-container-endpoints-21123f794c58#2022-04-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="66c5" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">自带带有多容器端点的容器</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/06c808fb84d2c8baa2cf57ad95f3d5eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xyU9mrZ52Y5PZl_U"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自<a class="ae ky" href="https://unsplash.com/photos/qMehmIyaXvY" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>作者<a class="ae ky" href="https://unsplash.com/@live_for_photo" rel="noopener ugc nofollow" target="_blank">滕玉红</a></p></figure><p id="39aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我曾经写过亚马逊SageMaker提供的各种<a class="ae ky" href="https://aws.plainenglish.io/what-sagemaker-inference-option-should-you-use-2e88c8fc70bf" rel="noopener ugc nofollow" target="_blank">推理选项</a>。特别是，<a class="ae ky" href="https://docs.aws.amazon.com/sagemaker/latest/dg/realtime-endpoints.html" rel="noopener ugc nofollow" target="_blank">实时推理</a>有大量的选项，您可以根据自己特定的机器学习用例进行选择。特别是在这篇文章中，我们将看一个带有<a class="ae ky" href="https://docs.aws.amazon.com/sagemaker/latest/dg/multi-container-endpoints.html" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">多容器端点</strong> </a>中一个更高级选项的例子。</p><p id="1925" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">多容器端点的用例是什么？</strong>有时你可能有<strong class="lb iu">个不同的框架</strong>来评估或用于推理。例如，您可能有两个模型，一个在PyTorch中，另一个在TensorFlow中。你不能把它放在<a class="ae ky" href="https://docs.aws.amazon.com/sagemaker/latest/dg/multi-model-endpoints.html" rel="noopener ugc nofollow" target="_blank">多模型端点</a>上，因为有一个公共框架的严格要求。多容器端点允许您使用2-15个不同的容器，您可以在一个端点后托管这些容器。它们也可以在一个叫做<a class="ae ky" href="https://docs.aws.amazon.com/sagemaker/latest/dg/inference-pipelines.html" rel="noopener ugc nofollow" target="_blank">串行推理管道</a>的东西中链接在一起。要完全理解多模型和多容器端点之间的区别，请查看这篇<a class="ae ky" rel="noopener" target="_blank" href="/sagemaker-multi-model-vs-multi-container-endpoints-304f4c151540">文章</a>。</p><p id="adc7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">具体到这个例子，我们将看看如何<a class="ae ky" rel="noopener" target="_blank" href="/bring-your-own-container-with-amazon-sagemaker-37211d8412f4">将自己的定制容器</a>与两个<strong class="lb iu">不同的定制NLP库</strong>在<a class="ae ky" href="https://spacy.io/" rel="noopener ugc nofollow" target="_blank">空间</a>和<a class="ae ky" href="https://textblob.readthedocs.io/en/dev/" rel="noopener ugc nofollow" target="_blank">文本块</a>中带到一个多容器端点。SageMaker的深度学习图像不支持这些框架，所以我们必须为每个框架构建自己的容器，并将其缝合在多容器端点之后。<strong class="lb iu">我们将跳过许多与自带容器相关的步骤，因此我鼓励您查看我在上面</strong>链接的定制容器文章。我们将以此为基础创建多容器端点。</p><p id="9f65" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">注意:</strong>对于刚接触AWS的人来说，如果你想继续学习，请确保在下面的<a class="ae ky" href="https://aws.amazon.com/console/" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">链接</strong> </a>中注册账户。部署过程中会产生成本，尤其是如果您让端点保持运行。本文还将假设您对SageMaker和AWS有一定的了解。</p><h1 id="4e87" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">目录</h1><ol class=""><li id="e141" class="mn mo it lb b lc mp lf mq li mr lm ms lq mt lu mu mv mw mx bi translated">设置</li><li id="2ee2" class="mn mo it lb b lc my lf mz li na lm nb lq nc lu mu mv mw mx bi translated">构建模型和端点配置</li><li id="c583" class="mn mo it lb b lc my lf mz li na lm nb lq nc lu mu mv mw mx bi translated">创建端点和调用</li><li id="af61" class="mn mo it lb b lc my lf mz li na lm nb lq nc lu mu mv mw mx bi translated">其他资源和结论</li></ol><h2 id="2d3a" class="nd lw it bd lx ne nf dn mb ng nh dp mf li ni nj mh lm nk nl mj lq nm nn ml no bi translated">设置</h2><p id="55f7" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">在开始使用多容器端点之前，我们需要在Spacy和Textblob中为我们的两个框架设置单独的容器。为此，我们需要为两者提供一个docker文件。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Textblob Dockerfile</p></figure><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">空间文件</p></figure><p id="0883" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">文件设置仍然与自带容器(BYOC)方法基本相同。主要的变化是我们需要考虑这样一个事实，即在多容器端点中，容器监听在<code class="fe nu nv nw nx b">SAGEMAKER_BIND_TO_PORT</code>环境变量中指定的端口。在单个容器中，这被硬编码为8080，为了反映这一变化，我们更新了容器设置中的nginx.conf和serve文件。您可以为您的多容器设置原样复制这些文件。你需要做的一个关键改变是添加下面的标签(如上所示)以确保你的容器符合这个要求。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">添加到多容器中的docker文件</p></figure><p id="92fd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以在下面的<a class="ae ky" href="https://docs.aws.amazon.com/sagemaker/latest/dg/inference-pipeline-real-time.html" rel="noopener ugc nofollow" target="_blank">文档</a>中了解更多信息。现在，确保编辑predictor.py文件，以反映您的模型所具有的推理逻辑。将您的定制映像推送到ECR后，我们可以设置<a class="ae ky" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sagemaker.html" rel="noopener ugc nofollow" target="_blank"> boto3 SageMaker客户端</a>，并准备创建我们的多容器端点。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">客户端设置</p></figure><p id="0422" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用这些客户端，我们现在已经准备好完成通常的模型、端点配置和端点创建步骤。</p><h2 id="ba68" class="nd lw it bd lx ne nf dn mb ng nh dp mf li ni nj mh lm nk nl mj lq nm nn ml no bi translated">构建模型和端点配置</h2><p id="59af" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">首先，我们为不同的容器指定ECR映像URI，然后指定我们希望在一个<a class="ae ky" href="https://docs.aws.amazon.com/sagemaker/latest/APIReference/API_CreateModel.html#sagemaker-CreateModel-request-InferenceExecutionConfig" rel="noopener ugc nofollow" target="_blank">执行配置</a>对象中直接调用(这是特定于多容器端点的)。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">容器图像URIs</p></figure><p id="2f3d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们指定的ContainerHostname键是我们稍后将用来调用特定容器的名称。使用我们的SageMaker客户端，我们可以创建一个模型，指定我们刚刚定义的两个容器。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">多容器模型设置</p></figure><p id="34d9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过在我们的<a class="ae ky" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sagemaker.html#SageMaker.Client.create_model" rel="noopener ugc nofollow" target="_blank"> create_model </a> API调用中指定containers参数，我们告诉SageMaker我们正在处理一个多容器端点。然后，我们可以将这个模型提供给我们的端点配置。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">端点配置创建</p></figure><p id="f4ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这里，我们指定端点配置细节，例如实例类型，确保选择适合您的模型和容器大小的实例。</p><h2 id="6aa1" class="nd lw it bd lx ne nf dn mb ng nh dp mf li ni nj mh lm nk nl mj lq nm nn ml no bi translated">创建端点和调用</h2><p id="c19c" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">现在，我们可以采用端点配置并创建我们的端点。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">创建端点</p></figure><p id="dff6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在您的端点处于状态之后，您应该能够通过指定TargetContainerHostName来调用这两个容器。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">空间容器</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/fe03ccbd2b563ece3a045be34563d484.png" data-original-src="https://miro.medium.com/v2/resize:fit:908/format:webp/1*HWyqGLRPQndEIzdM6zsMoA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">空间推理(作者截图)</p></figure><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">TextBlob容器</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/535c9d5551110b5c62add184b95a92fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1268/format:webp/1*o6NYTUiY9pdONiF_55He0g.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">TextBlob推断(作者截图)</p></figure><p id="6e56" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">确保删除您的端点和任何您不希望保持挂起状态的资源。</p><h2 id="0457" class="nd lw it bd lx ne nf dn mb ng nh dp mf li ni nj mh lm nk nl mj lq nm nn ml no bi translated">其他资源和结论</h2><div class="oa ob gp gr oc od"><a href="https://github.com/RamVegiraju/SageMaker-Deployment/tree/master/RealTime/Multi-Container/mce-custom" rel="noopener  ugc nofollow" target="_blank"><div class="oe ab fo"><div class="of ab og cl cj oh"><h2 class="bd iu gy z fp oi fr fs oj fu fw is bi translated">SageMaker-部署/实时/多容器/MCE-在主服务器上定制…</h2><div class="ok l"><h3 class="bd b gy z fp oi fr fs oj fu fw dk translated">SageMaker推理选项和其他功能的例子汇编。…</h3></div><div class="ol l"><p class="bd b dl z fp oi fr fs oj fu fw dk translated">github.com</p></div></div><div class="om l"><div class="on l oo op oq om or ks od"/></div></div></a></div><p id="c536" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要访问示例中的<strong class="lb iu">完整代码</strong>，请查看上方的<strong class="lb iu">链接，还有大量其他SageMaker推理示例和资源。如果您已经设置了一个自定义容器，那么将多个引入到多容器端点并不困难，正如您在本例中所看到的。再一次，<strong class="lb iu">确保根据需要调整你的Dockerfile和predictor . py</strong>来反映你的框架。</strong></p><p id="497f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">多容器端点为复杂的机器学习推理系统提供了极大的灵活性。我希望这篇文章是关于多容器端点和SageMaker推理的好入门。</p></div><div class="ab cl os ot hx ou" role="separator"><span class="ov bw bk ow ox oy"/><span class="ov bw bk ow ox oy"/><span class="ov bw bk ow ox"/></div><div class="im in io ip iq"><p id="2c3f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="oz">如果你喜欢这篇文章，请在</em><a class="ae ky" href="https://www.linkedin.com/in/ram-vegiraju-81272b162/" rel="noopener ugc nofollow" target="_blank"><em class="oz">LinkedIn</em></a><em class="oz">上与我联系，并订阅我的媒体</em> <a class="ae ky" href="https://ram-vegiraju.medium.com/subscribe" rel="noopener"> <em class="oz">简讯</em> </a> <em class="oz">。如果你是新来的中号，用我的</em> <a class="ae ky" href="https://ram-vegiraju.medium.com/membership" rel="noopener"> <em class="oz">会员推荐</em> </a> <em class="oz">报名吧。</em></p></div></div>    
</body>
</html>