<html>
<head>
<title>Machine Learning in a Data Warehouse</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">数据仓库中的机器学习</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/machine-learning-in-a-data-warehouse-ab0701bbf631#2022-08-19">https://towardsdatascience.com/machine-learning-in-a-data-warehouse-ab0701bbf631#2022-08-19</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="b8e0" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">使用Snowpark Python开始机器学习</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/4faa4b853cbc5c80f4453e1939004ccc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8UYEfwV2H3cOq4GSirEmbA.jpeg"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated"><a class="ae kz" href="https://unsplash.com/@jasperguy?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">贾斯珀盖伊</a>在<a class="ae kz" href="https://unsplash.com/s/photos/snow?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="651c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果您是一名商业环境中的数据科学家，您将从数据仓库或数据湖中提取大量数据用于机器学习。大多数数据科学项目需要大规模的计算能力和对所需python库的访问，以处理海量数据和训练机器学习模型。</p><p id="480a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">通常，数据被移动到另一个位置，例如云存储桶，在那里它可以被标准数据科学工具包使用。</p><p id="0c12" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这种情况导致了机器学习工作流的碎片化，这是许多云提供商正在寻求解决的问题。我<a class="ae kz" rel="noopener" target="_blank" href="/low-effort-machine-learning-tools-9622d7d57135">之前写过</a>关于<a class="ae kz" href="https://cloud.google.com/bigquery-ml/docs/introduction" rel="noopener ugc nofollow" target="_blank"> BigQueryML </a>，这是一个谷歌云平台(GCP)工具，它允许机器学习模型在GCP的数据仓库平台内纯粹使用SQL来开发和训练。</p><p id="2f53" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><a class="ae kz" href="https://www.snowflake.com" rel="noopener ugc nofollow" target="_blank">雪花</a>，一个基于云的数据和分析平台，最近提供了另一个工具，试图以类似的方式简化数据科学的工作流程。</p><p id="4083" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">Snowpark Python API允许使用数据科学家熟悉的工具在Snowflake中开发、训练和部署机器学习模型。与BigQueryML一样，可以开发模型，而无需数据离开存储位置，然而，使用<a class="ae kz" href="https://docs.snowflake.com/en/developer-guide/snowpark/python/index.html" rel="noopener ugc nofollow" target="_blank"> Snowpark </a>而不是用SQL编写代码，数据科学家现在可以使用Python。</p><p id="7d10" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在这篇文章中，我写了一个使用Snowpark开始机器学习的简要指南。这并不意味着对机器学习本身的详尽指导，所以我将跳过通常工作流程中的一些步骤，如探索性数据分析和特征工程。它旨在给出API的一个应用的基本介绍。</p><p id="0046" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">本教程中的大部分代码都受到了雪花团队提供的示例的极大启发，这些示例可以在本<a class="ae kz" href="https://github.com/Snowflake-Labs/snowpark-python-demos" rel="noopener ugc nofollow" target="_blank"> Github repo </a>中找到。</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h1 id="6f62" class="md me iu bd mf mg mh mi mj mk ml mm mn ka mo kb mp kd mq ke mr kg ms kh mt mu bi translated">首先，一些有用的定义</h1><p id="1cfa" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">雪花与您可能使用过的其他数据仓库工具有一点不同，因此首先理解雪花上下文中的一些常用术语可能会有所帮助。</p><p id="b481" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv">数据库:</strong>一个<strong class="lc iv"> </strong>雪花数据库由优化的数据存储组成。通常，一个数据库包含许多模式，每个模式包含一组表。在本教程中，我们将利用数据库来存储训练数据和预测。</p><p id="3b39" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv">仓库:</strong> Snowflake为大规模查询处理提供独立的计算集群。每个计算集群被称为一个虚拟仓库。这些仓库的规模可以根据您的加工需求而定。我们将使用仓库计算来执行模型训练和推理。</p><p id="c101" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv">Stage:</strong>Stage是一个存储位置，用于存储数据和构件，以便在雪花中使用。在本教程中，我们将使用一个stage来存储我们训练好的模型。</p><p id="a0e0" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv">存储过程:</strong>存储过程是存储在雪花中供以后重用的函数和操作的集合。Snowpark存储过程提供了一种机制，可以通过Snowpark或其他python库(如sci-kit-learn)使用雪花计算来运行Python代码。我们将使用存储过程来执行模型训练。</p><p id="e6c7" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv">用户定义函数(UDF):</strong>UDF是在雪花中运行Python函数的另一种方法。这些过程在许多方面不同于存储过程。这篇<a class="ae kz" href="https://alexandersks.medium.com/difference-between-stored-procedures-and-udfs-snowflake-9e5b93cdb081" rel="noopener">文章</a>详细描述了两者的区别。在本教程中，我们将使用UDF来使用训练好的模型生成推理。</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h1 id="5c0a" class="md me iu bd mf mg mh mi mj mk ml mm mn ka mo kb mp kd mq ke mr kg ms kh mt mu bi translated">建立雪地公园</h1><p id="3ef6" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">如果你还没有雪花的权限，你可以在这里注册免费试用。注册后，您需要配置一个数据库、仓库和模式。雪花有一个很棒的20分钟指南<a class="ae kz" href="https://docs.snowflake.com/en/user-guide/getting-started-tutorial.html" rel="noopener ugc nofollow" target="_blank">在这里</a>。</p><p id="97fc" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">对于本教程的剩余部分，我将假设您已经配置了雪花资源。</p><p id="1960" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">本文的设置部分介绍了Snowpark的本地安装。该设置基于macOS。</p><p id="360f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">Snowpark使用Snowflake中的Anaconda环境来管理Python包。因此，虽然也可以使用virtualenv，但是最好在本地复制这个环境。</p><p id="d9b7" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">要安装Anaconda，请运行以下命令。</p><pre class="kk kl km kn gu na nb nc nd aw ne bi"><span id="b651" class="nf me iu nb b gz ng nh l ni nj">$ brew install --cask anaconda</span></pre><p id="77fc" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">接下来，将以下内容添加到您的。zshrc文件。</p><pre class="kk kl km kn gu na nb nc nd aw ne bi"><span id="7380" class="nf me iu nb b gz ng nh l ni nj">export PATH="/usr/local/anaconda3/bin:$PATH"</span></pre><p id="aa16" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在，您可以通过运行以下命令来创建conda环境。SnowPark目前只支持Python 3.8。</p><pre class="kk kl km kn gu na nb nc nd aw ne bi"><span id="f730" class="nf me iu nb b gz ng nh l ni nj">$ conda create --name py38_env -c https://repo.anaconda.com/pkgs/snowflake python=3.8 numpy pandas sklearn</span></pre><p id="643d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">运行以下程序初始化conda。您只需要运行一次。</p><pre class="kk kl km kn gu na nb nc nd aw ne bi"><span id="8f92" class="nf me iu nb b gz ng nh l ni nj">$ conda init zsh</span></pre><p id="741d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">要激活环境，请运行。</p><pre class="kk kl km kn gu na nb nc nd aw ne bi"><span id="7cc1" class="nf me iu nb b gz ng nh l ni nj">$ conda activate my_env</span></pre><p id="99e6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">进入环境后，安装snowpark和Jupyter笔记本。</p><pre class="kk kl km kn gu na nb nc nd aw ne bi"><span id="6223" class="nf me iu nb b gz ng nh l ni nj">$ conda install snowflake-snowpark-python</span><span id="7dd4" class="nf me iu nb b gz nk nh l ni nj">$ conda install notebook</span></pre><p id="5e7b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">要运行Jupyter笔记本，请键入以下内容。</p><pre class="kk kl km kn gu na nb nc nd aw ne bi"><span id="16f5" class="nf me iu nb b gz ng nh l ni nj">$ jupyter notebook</span></pre><p id="0d9e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">Jupyter笔记本将推出Python 3内核。我的内核如下图所示。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj nl"><img src="../Images/a408a7b22dee57d5153509d8c84e2570.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qCK5iIiCkmGVnupZpe_KSA.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">带雪地公园的Jupyter笔记本。作者图片</p></figure></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h1 id="a520" class="md me iu bd mf mg mh mi mj mk ml mm mn ka mo kb mp kd mq ke mr kg ms kh mt mu bi translated">雪地公园会议</h1><p id="69fe" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">一旦你设置了Snowpark的本地安装，你就可以开始运行代码了。使用Snowpark API执行的所有操作都在雪花仓库计算上运行。</p><p id="97e6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">要开始使用这台计算机，您需要创建一个Snowpark会话，该会话允许您进行身份验证并创建一个与您的数据库和仓库的连接。</p><p id="2199" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">要启动雪花会话，我们键入并执行以下命令:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nm nn l"/></div></figure></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h1 id="f7ab" class="md me iu bd mf mg mh mi mj mk ml mm mn ka mo kb mp kd mq ke mr kg ms kh mt mu bi translated">数据准备</h1><p id="3f41" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">在本教程的剩余部分，我们将使用Snowpark来准备数据集，训练机器学习模型，然后使用该模型来生成预测。</p><p id="4dda" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们将使用来自<a class="ae kz" href="https://www.openml.org/search?type=data&amp;sort=runs&amp;id=31" rel="noopener ugc nofollow" target="_blank">openml.org</a>的‘credit-g’数据集。这包括银行客户的许多特征，带有一个标签，表明他们是好的还是坏的信用风险。可以使用如下所示的<a class="ae kz" href="https://scikit-learn.org/stable/" rel="noopener ugc nofollow" target="_blank"> sklearn </a> API下载数据集。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nm nn l"/></div></figure><p id="bb9a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">接下来，我们希望将数据帧写回Snowflake，以用于训练模型。</p><p id="03f8" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">以下代码将pandas数据帧转换为Snowpark数据帧，然后将其作为一个表写入Snowflake。我们还保留了一个小数据集，用于稍后使用训练好的模型进行测试推断。这也保存为雪花中的一个表。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nm nn l"/></div></figure></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h1 id="115f" class="md me iu bd mf mg mh mi mj mk ml mm mn ka mo kb mp kd mq ke mr kg ms kh mt mu bi translated">训练模型</h1><p id="28c0" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">对于模型定型，我们将创建一个存储过程。在此之前，我们需要将我们打算使用的包添加到会话中，如下所示。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nm nn l"/></div></figure><p id="f09a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们现在可以创建存储过程了。这里的代码将数据分成测试集和训练集，并使用scikit-learn管道来执行预处理和训练。模型被训练，保存到指定阶段，并返回分类报告。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nm nn l"/></div></figure></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h1 id="c4ad" class="md me iu bd mf mg mh mi mj mk ml mm mn ka mo kb mp kd mq ke mr kg ms kh mt mu bi translated">批量预测</h1><p id="b55d" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">既然我们已经训练了模型，我们想要测试在我们先前保留的推理数据集上生成预测。</p><p id="ecac" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在此之前，我们需要将模型位置添加到会话中。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nm nn l"/></div></figure><p id="6879" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">接下来，我们创建一个UDF来使用该模型生成预测。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nm nn l"/></div></figure><p id="95fc" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">以下代码读入我们为推断保留的数据，并使用UDF生成预测。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nm nn l"/></div></figure><p id="59e6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">让我们在雪花中查看结果表。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj no"><img src="../Images/e17a796a681cf95aea0ac1fc07f4749c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CHlM1Jk3qHmHcIv0Grh6-Q.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">预测保存到雪花。作者图片</p></figure></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><p id="2b7c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">机器学习领域仍然非常分散。典型组织中的机器学习工作流由许多不同的工具组成，这些工具在该过程中扮演不同的角色。数据是这种碎片化可能严重影响机器学习模型的质量和成功的领域之一。</p><p id="3f6f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">将数据从一个工具移动到另一个工具的需求可能会导致存储相同数据的多个副本，带来数据质量问题和潜在的安全漏洞。Snowpark和BigQueryML等工具寻求最小化这种数据移动，并从本质上将数据科学引入数据仓库。</p><p id="e22d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">本教程简单介绍了机器学习工作流，包括Snowpark Python API的训练和部署。该工具远不止我在此分享的内容，还有许多实现数据科学工作流的潜在选项。为了获得更全面的指导，我参考了本文开头链接的Snowpark示例。</p><p id="7c32" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">感谢阅读！</p></div></div>    
</body>
</html>