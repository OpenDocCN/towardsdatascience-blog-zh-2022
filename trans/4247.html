<html>
<head>
<title>How to transfer files among prod, local and S3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在生产、本地和S3之间传输文件</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-transfer-files-among-prod-local-and-s3-ce073a7cbe6b#2022-09-20">https://towardsdatascience.com/how-to-transfer-files-among-prod-local-and-s3-ce073a7cbe6b#2022-09-20</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="ca85" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">备份Postgres、复制docker文件和在不同AWS配置文件之间切换的代码片段</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj kg"><img src="../Images/e6fd245d90910b75d94588d30e491dbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*O_eH7GLk0dW6crcG"/></div></div><p class="ks kt gk gi gj ku kv bd b be z dk translated">照片由<a class="ae kw" href="https://unsplash.com/@othentikisra?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">以色列总统府</a>在<a class="ae kw" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="4cba" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">数据科学家很少会收到如下请求:</p><ol class=""><li id="fd63" class="lt lu ir kz b la lb ld le lg lv lk lw lo lx ls ly lz ma mb bi translated">您能从生产机器上备份stage和本地Postgres数据库吗？</li><li id="20b9" class="lt lu ir kz b la mc ld md lg me lk mf lo mg ls ly lz ma mb bi translated">你能从生产机器docker服务器上复制X文件并保存到本地机器上吗？</li><li id="ce4e" class="lt lu ir kz b la mc ld md lg me lk mf lo mg ls ly lz ma mb bi translated">为你的客户上传X文件到AWS s3怎么样？(提示:您可能有多个AWS概要文件)</li></ol><p id="7387" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">如果你经历过类似的情况，但不知道如何处理，我希望我下面的代码片段可以帮助你恢复冷静和内心的平静。</p></div><div class="ab cl mh mi hv mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ik il im in io"><h1 id="02d8" class="mo mp ir bd mq mr ms mt mu mv mw mx my jx mz jy na ka nb kb nc kd nd ke ne nf bi translated">如何:从生产计算机备份stage和本地Postgres数据库</h1><p id="5717" class="pw-post-body-paragraph kx ky ir kz b la ng js lc ld nh jv lf lg ni li lj lk nj lm ln lo nk lq lr ls ik bi translated">在我们公司，我们只能ssh到prod机，而且Postgres数据库非常大。因此，以下是适合我们团队的解决方案:</p><ul class=""><li id="8d00" class="lt lu ir kz b la lb ld le lg lv lk lw lo lx ls nl lz ma mb bi translated"><strong class="kz is">第0步</strong>:在本地机器上安装<code class="fe nm nn no np b">zstd</code>。<code class="fe nm nn no np b">zstd</code>是一种压缩算法，可以帮助减小Postgres <code class="fe nm nn no np b">pg_dump</code>文件的大小。</li></ul><pre class="kh ki kj kk gu nq np nr ns aw nt bi"><span id="c2d8" class="nu mp ir np b gz nv nw l nx ny"># in your terminal<br/>$ brew install zstd</span></pre><ul class=""><li id="4697" class="lt lu ir kz b la lb ld le lg lv lk lw lo lx ls nl lz ma mb bi translated"><strong class="kz is">步骤1 </strong> : ssh到您的生产机器(如果您不确定如何ssh到您的生产机器，请向您的DevOps同事寻求帮助！)</li></ul><pre class="kh ki kj kk gu nq np nr ns aw nt bi"><span id="8ed8" class="nu mp ir np b gz nv nw l nx ny">$ ssh [alias for prod] <br/>$ pg_dump -T [table1] -c | zstd -T32 -19 -c &gt; /tmp/prod.psql.zstd</span></pre><p id="0d9b" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">上面的命令=“对除表1之外的所有表运行pg_dump”。该命令压缩<code class="fe nm nn no np b">pg_dump</code>文件并将其存储在生产机器的临时文件夹中。</p><ul class=""><li id="9834" class="lt lu ir kz b la lb ld le lg lv lk lw lo lx ls nl lz ma mb bi translated"><strong class="kz is">步骤2 </strong>:将zstd输出下载到本地机器</li></ul><p id="cc64" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">打开一个新的终端，并<code class="fe nm nn no np b">cd</code>到你想要保存文件的目录。例如<code class="fe nm nn no np b">Downloads</code>:</p><pre class="kh ki kj kk gu nq np nr ns aw nt bi"><span id="3c96" class="nu mp ir np b gz nv nw l nx ny">$ cd Downloads/<br/>$ scp discovery-prod:/tmp/prod.psql.zstd .</span></pre><p id="fbfa" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">命令以一种超级干净的方式将文件从prod复制到你的本地！就像《哈利·波特》中的<em class="nz">幽灵</em>💎</p><ul class=""><li id="6625" class="lt lu ir kz b la lb ld le lg lv lk lw lo lx ls nl lz ma mb bi translated">第3步:用<code class="fe nm nn no np b">zstd</code>文件<br/>备份您的本地或登台数据库确保在您的登台环境中删除数据库之前先与您的DevOps团队讨论。</li></ul><pre class="kh ki kj kk gu nq np nr ns aw nt bi"><span id="264d" class="nu mp ir np b gz nv nw l nx ny"># I feel pretty free to do so on my local machine</span><span id="95e3" class="nu mp ir np b gz oa nw l nx ny">$ dropdb discovery_db<br/>$ createdb discovery_db<br/>$ cat prod.psql.zstd | zstd -dc | psql discovery_db</span></pre></div><div class="ab cl mh mi hv mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ik il im in io"><h1 id="3738" class="mo mp ir bd mq mr ms mt mu mv mw mx my jx mz jy na ka nb kb nc kd nd ke ne nf bi translated">如何:从生产机器docker服务器复制X文件，并将其保存到本地机器</h1><p id="8457" class="pw-post-body-paragraph kx ky ir kz b la ng js lc ld nh jv lf lg ni li lj lk nj lm ln lo nk lq lr ls ik bi translated">嗯，类似于上面的过程，这里唯一的新东西是从一个特定的docker容器中抓取特定的文件。</p><pre class="kh ki kj kk gu nq np nr ns aw nt bi"><span id="3083" class="nu mp ir np b gz nv nw l nx ny"># step 0: ssh to your production machine. <br/>$ ssh prod</span><span id="4a9c" class="nu mp ir np b gz oa nw l nx ny"># step 1: show your docker container <br/>$ docker ps</span><span id="ae4d" class="nu mp ir np b gz oa nw l nx ny"># step 2: copy a file under specific container ID<br/># Here I'm trying to copy a meltano.db file</span><span id="e454" class="nu mp ir np b gz oa nw l nx ny"># step 3: copy file and store it in temp folder<br/>$ docker cp [container_id]:/projects/.meltano/meltano.db /tmp/meltano.db</span></pre><p id="88c8" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">类似地，您可以打开一个新的终端并使用<code class="fe nm nn no np b">scp</code>将<code class="fe nm nn no np b">meltano.db</code>文件从production temp文件夹下载到您的本地机器。以下是截图:</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj ob"><img src="../Images/acbb119aad5f747d99c17a49fbbdff63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E4jGIIPFQUwQTqvO8nyAPw.png"/></div></div></figure><p id="02ee" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">额外提示:</p><ul class=""><li id="87bb" class="lt lu ir kz b la lb ld le lg lv lk lw lo lx ls nl lz ma mb bi translated">你可以交替使用<code class="fe nm nn no np b">docker container ls</code>和<code class="fe nm nn no np b">docker ps</code></li><li id="fc3c" class="lt lu ir kz b la mc ld md lg me lk mf lo mg ls nl lz ma mb bi translated">Docker容器文件夹可能会变得非常大，有时您可能希望删除旧的未使用的容器来释放空间。您可以这样做:</li></ul><pre class="kh ki kj kk gu nq np nr ns aw nt bi"><span id="8fc7" class="nu mp ir np b gz nv nw l nx ny"># Run both to stop and remove the folder</span><span id="64d7" class="nu mp ir np b gz oa nw l nx ny">$ docker stop [container_id]</span><span id="1761" class="nu mp ir np b gz oa nw l nx ny">$ docker rm [container_id]</span></pre><p id="3768" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">我想导出<code class="fe nm nn no np b">meltano.db</code>的原因是因为我们注意到这个文件的大小以意想不到的速度增长。所以我们想导出这个文件以供进一步分析。下面是显示文件大小的另一个技巧:</p><ul class=""><li id="1120" class="lt lu ir kz b la lb ld le lg lv lk lw lo lx ls nl lz ma mb bi translated"><code class="fe nm nn no np b">du -h --max-depth=1</code>:显示该目录下的文件</li><li id="0a85" class="lt lu ir kz b la mc ld md lg me lk mf lo mg ls nl lz ma mb bi translated"><code class="fe nm nn no np b">ls -alh</code>:这将以人类可读的方式显示<code class="fe nm nn no np b">.</code>下的文件及其大小。</li></ul><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj oc"><img src="../Images/82ffcf683ac55ff6a1365369616bf171.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gnJuAvoOKPpol-F_MiUmDA.png"/></div></div></figure></div><div class="ab cl mh mi hv mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ik il im in io"><h1 id="49b8" class="mo mp ir bd mq mr ms mt mu mv mw mx my jx mz jy na ka nb kb nc kd nd ke ne nf bi translated">如何:设置多个AWS概要文件并将文件上传到s3</h1><p id="33ce" class="pw-post-body-paragraph kx ky ir kz b la ng js lc ld nh jv lf lg ni li lj lk nj lm ln lo nk lq lr ls ik bi translated">例如，我想配置两个配置文件:一个用于我的外部公司，另一个用于访问客户的公司。您需要预先获得两个概要文件的AWS访问密钥和秘密密钥。</p><pre class="kh ki kj kk gu nq np nr ns aw nt bi"><span id="6f2b" class="nu mp ir np b gz nv nw l nx ny"># step0: check your default profile list<br/>$ aws configure list</span><span id="1c67" class="nu mp ir np b gz oa nw l nx ny"># Configure my profile 1: wen_outside<br/>$ aws configure --profile wen_outside<br/># follow the steps to filling the blanks<br/>AWS Access Key ID [None]: [fill your info]<br/>AWS Secret Access Key [None]: [fill your info]<br/>Default region name [None]: [fill your info] # example: us-east-1 <br/>Default output format [None]: json</span><span id="cae0" class="nu mp ir np b gz oa nw l nx ny"># Configure my profile 2: wen_client<br/>$ aws configure --profile wen_client<br/># follow the steps to filling the blanks<br/>AWS Access Key ID [None]: [fill your info]<br/>AWS Secret Access Key [None]: [fill your info]<br/>Default region name [None]: [fill your info] <br/>Default output format [None]: json</span><span id="9edd" class="nu mp ir np b gz oa nw l nx ny"># Now check to see your profile list<br/>$ aws configure list-profiles</span></pre><p id="ca20" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">下一步是如何在配置文件之间切换:</p><pre class="kh ki kj kk gu nq np nr ns aw nt bi"><span id="f615" class="nu mp ir np b gz nv nw l nx ny"># Switch to my outside profile<br/>$ export AWS_DEFAULT_PROFILE=wen_outside</span></pre><p id="82d2" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">最后，假设我需要将<code class="fe nm nn no np b">meltano.db</code>上传到我们客户的s3:</p><pre class="kh ki kj kk gu nq np nr ns aw nt bi"><span id="bd8d" class="nu mp ir np b gz nv nw l nx ny"># switch to my profile wen_client<br/>$ export AWS_PROFILE=wen_client</span><span id="0be5" class="nu mp ir np b gz oa nw l nx ny"># from local to S3: for single file<br/>$ aws s3 cp meltano.db [client's s3 directory]</span><span id="bd90" class="nu mp ir np b gz oa nw l nx ny"># from S3 to current directory<br/>$ aws s3 cp [s3 directory] .</span><span id="9ff3" class="nu mp ir np b gz oa nw l nx ny"># from local to S3: sync the whole folder "forClient"<br/>$ aws s3 sync forClient [client's s3 directory]</span></pre></div><div class="ab cl mh mi hv mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ik il im in io"><h1 id="d90b" class="mo mp ir bd mq mr ms mt mu mv mw mx my jx mz jy na ka nb kb nc kd nd ke ne nf bi translated">摘要</h1><ul class=""><li id="9ded" class="lt lu ir kz b la ng ld nh lg od lk oe lo of ls nl lz ma mb bi translated">和其他一些数据科学家一样，我也有类似的担心，与生产机器(通常是Linus和Ubuntu系统)交互可能会令人生畏。这些任务我做得不够频繁，以至于我建立了肌肉记忆。好消息是，如果您对此类代码片段保持良好的文档记录，这种担心是可以克服的。</li></ul></div></div>    
</body>
</html>