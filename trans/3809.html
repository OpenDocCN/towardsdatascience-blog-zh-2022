<html>
<head>
<title>The Best SQL Template for Customer Lifetime Value</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">客户终身价值的最佳SQL模板</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/the-best-sql-template-for-customer-lifetime-value-56978b062c0b#2022-08-24">https://towardsdatascience.com/the-best-sql-template-for-customer-lifetime-value-56978b062c0b#2022-08-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e988" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">用于RFM和CLV分析的可重用SQL</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/bb07b32c4ff1bb39db8b54f516fb3df2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dAOBOaiGmR19VDLNvHNwJw.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片来自energo epic . com:<a class="ae kv" href="https://www.pexels.com/photo/black-payment-terminal-2988232/" rel="noopener ugc nofollow" target="_blank">https://www . pexels . com/photo/black-payment-terminal-2988232/</a></p></figure><h2 id="484c" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">介绍</h2><p id="bdb5" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated">在过去10年的职业生涯中，我与各种客户、行业和数据集一起研究客户终身价值(CLV)模型。有许多不同的方法来解决这个问题，但是这篇文章不是关于这个的。相反，我想解释一下数据设置，这在博客圈经常被忽视。</p><p id="76d3" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">在我的上一篇博客文章中，<a class="ae kv" href="https://medium.com/@jberry_33001/lets-go-further-with-sql-babf2c5cae4" rel="noopener">让我们用SQL </a>走得更远，我谈到了我对结合jinja和SQL的潜力感到多么兴奋，以便利用SQL代码本身之上的语义抽象。这篇文章是最近在我脑海中出现的许多想法中的第一个。我的目标是(1)向您展示CLV模型的数据准备可以在SQL中完成，但更重要的是，(2)为您提供一个可以在其他地方应用的模板，这样您就不必真正从头开始编写SQL。</p><h2 id="92fe" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">入门指南</h2><p id="6876" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated">预测CLV最常用的概率模型是<strong class="lu ir">贝塔几何/负二项分布</strong>模型(通常缩写为BG/NBD)。它有一个流行的表亲，帕累托/NBD模型。这些模型试图预测给定客户的未来交易。<strong class="lu ir"> Gamma-Gamma </strong>扩展模型关注的是那些交易的金额<em class="ml">货币方面</em>。</p><p id="1935" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">今年，全世界成百上千的数据科学家将建立这种模型。</p><p id="3b0a" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">他们将如何开始？你会如何开始？如果你是诚实的，第一步可能是谷歌它，阅读一些博客，然后跟随你自己的数据。如果你能在网上找到一个足够好的例子，你就能以一种类似于博客文章的方式有条不紊地操作你的数据，直到你足够接近它，你就可以开始运行了。</p><h2 id="fbdd" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">一个熟悉的模式出现了</h2><p id="1bf6" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated">如果你读了足够多的博客，你会开始意识到有一个熟悉的模式。所有这些都是从将数据处理成特定形状开始的——通常称为<a class="ae kv" href="https://en.wikipedia.org/wiki/RFM_%28market_research%29" rel="noopener ugc nofollow" target="_blank"> RFM表</a> <a class="ae kv" href="https://en.wikipedia.org/wiki/RFM_%28market_research%29%29." rel="noopener ugc nofollow" target="_blank">。</a></p><p id="e64e" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">还有其他方法来计算CLV，我不打算讨论这些。我主要关注的是RFM表，因为它不仅是一种非常流行的方法，而且是非常可重复的。如果你不熟悉RFM餐桌，可以看看我的朋友奥卢布库诺拉·阿金索拉在T2的博客文章。</p><p id="df85" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">基本要素是:</p><p id="a646" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated"><strong class="lu ir"> R </strong> —客户从该企业购买的最近日期<br/> <strong class="lu ir"> F </strong> —客户从该企业购买的频率<br/> <strong class="lu ir"> M </strong> —客户购买的货币价值。</p><h2 id="8026" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">选择SQL</h2><p id="dc1f" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated">如果您读过我以前的博客文章，那么您已经知道我热衷于利用SQL来利用数据仓库的处理能力。为了创建RFM表，我们需要从原始事务级别聚集数据，这可能是我们数据库中最大的表之一。虽然确实有很多可用的python解决方案，但当我有一个非常好的数据仓库时，为什么要费心去卸载数百万或数十亿的事务，而这些事务可能甚至不适合我的python内存呢？</p><h2 id="3c72" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">使其可重复</h2><p id="2077" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated">在接下来的几节中，我将演示一个示例，该示例从我在网上找到的销售数据集中创建一个RFM表。然而，这意味着任何人在将来偶然发现这篇文章，仍然要仔细重写SQL以匹配他们自己的数据库。</p><p id="71bf" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">这就是金贾发挥作用的地方。Jinja是一个有14年历史的模板引擎，主要用于动态生成HTML、XML和其他标记格式。最近，它被证明是SQL的强大伙伴，被dbt和Rasgo所利用。如果你想阅读基础知识，<a class="ae kv" href="https://medium.com/@julienkervizic" rel="noopener"> Julien Kervizic </a>在2019年写了一篇名为<a class="ae kv" href="https://medium.com/analytics-and-data/jinja-the-sql-way-of-the-ninja-9a64fc815564" rel="noopener">Jinja the SQL way of the Ninja</a>的预言性文章。</p><p id="5b3d" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">因此，我不只是分享SQL代码和逻辑，而是将它带到下一个层次——我将分享一个模板，您可以使用它来为您的<em class="ml">自己的</em>数据动态创建SQL。</p><h2 id="2e67" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">浏览一个例子</h2><p id="56e2" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated">让我们从<a class="ae kv" href="https://archive.ics.uci.edu/ml/index.php" rel="noopener ugc nofollow" target="_blank"> UCI机器学习库</a>中获取一些销售交易的例子。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mr"><img src="../Images/e84e5164c75b240f90bbb8ff1608e276.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nF-FBvbc_40xIIIHqMjGeQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">原始交易数据的示例</p></figure><p id="d3e5" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">我处理这个问题的方法是首先构建SQL。这一部分显然很有挑战性，但我这样做是为了让你不必如此。下面是工作的SQL。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="bb08" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">这个查询的结果是一个格式正确的RFM表，就像我们需要开始我们的CLV建模一样。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mu"><img src="../Images/f01f8654648e1aa5f418406c15e74def.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z17ZZjJRgPszNzVPw4F4mQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">结果-RFM交易汇总</p></figure><h2 id="9010" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">成为一名忍者</h2><p id="e4f1" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated">为了构建我们的RFM表，我们需要一个要聚合的事务表。在这个表格中，我们需要找到的是:</p><ul class=""><li id="13c3" class="mv mw iq lu b lv mm ly mn lf mx lj my ln mz mk na nb nc nd bi translated">CustomerID —唯一标识客户的列</li><li id="975c" class="mv mw iq lu b lv ne ly nf lf ng lj nh ln ni mk na nb nc nd bi translated">TransactionID —唯一标识交易或购买的列</li><li id="4b68" class="mv mw iq lu b lv ne ly nf lf ng lj nh ln ni mk na nb nc nd bi translated">交易日期—标识交易日期/时间的列</li><li id="4554" class="mv mw iq lu b lv ne ly nf lf ng lj nh ln ni mk na nb nc nd bi translated">TransactionAmount—标识交易的货币值金额的列</li></ul><p id="bdbb" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">由于我们的目标是最终建立一个模型，我们还必须考虑一段时间的培训，以及随后的一段时间的验证/拒绝。</p><ul class=""><li id="96f9" class="mv mw iq lu b lv mm ly mn lf mx lj my ln mz mk na nb nc nd bi translated">观察结束—我们认为数据结束的日期(维持结束)</li><li id="ba45" class="mv mw iq lu b lv ne ly nf lf ng lj nh ln ni mk na nb nc nd bi translated">TrainingPeriodEnd —我们将培训的结束与维持的开始分开的日期</li></ul><p id="8c1a" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">从我们的示例数据中，我们知道这些:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="6417" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">下一步是创建一个与jinja兼容的SQL模板，这样我就可以在不同的项目和客户中重复使用。</p><p id="0600" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">因为代码很长，我将用一个简短的例子来解释这是如何做到的。如果我们最初的查询是:</p><pre class="kg kh ki kj gt nj nk nl nm aw nn bi"><span id="e697" class="kw kx iq nk b gy no np l nq nr">SELECT CustomerID<br/>FROM tblCustomers</span></pre><p id="e606" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">我们想创建一些参数，比如，</p><ul class=""><li id="ca0b" class="mv mw iq lu b lv mm ly mn lf mx lj my ln mz mk na nb nc nd bi translated">列名</li><li id="304c" class="mv mw iq lu b lv ne ly nf lf ng lj nh ln ni mk na nb nc nd bi translated">表名</li></ul><p id="bad4" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">那么我们的jinja模板将是:</p><pre class="kg kh ki kj gt nj nk nl nm aw nn bi"><span id="1d08" class="kw kx iq nk b gy no np l nq nr">SELECT {{ column_name }}<br/>FROM {{ table_name }}</span></pre><p id="ca8c" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">因此，我将整个CLV-RFM查询参数化，以便我们将来可以在任何事务表上运行它。</p><p id="cb17" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">为了渲染jinja，有大量的在线渲染器，或者你可以使用python包<code class="fe ns nt nu nk b">jinja2.</code>个人来说，我使用<a class="ae kv" href="https://app.rasgoml.com/sql" rel="noopener ugc nofollow" target="_blank"> Rasgo </a>来渲染模板。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/fbd575a46509c38f03105b4adb141a32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N_gFncsEXY-friLbMF5CwA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">用Rasgo渲染SQL模板</p></figure><p id="8406" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">这里是完整的代码，准备好了！只需插入您自己的表名、列名，这将动态呈现为您的数据定制的SQL。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ms mt l"/></div></figure><h2 id="643f" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">结论</h2><p id="005b" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated">我真的为SQL模板的可能性感到兴奋。事实上，我已经有了一些其他的想法。例如，时间序列问题通常需要类似的数据准备步骤，</p><ul class=""><li id="a22b" class="mv mw iq lu b lv mm ly mn lf mx lj my ln mz mk na nb nc nd bi translated">删除负销售额</li><li id="8800" class="mv mw iq lu b lv ne ly nf lf ng lj nh ln ni mk na nb nc nd bi translated">为没有销售额的日期添加行</li><li id="e00c" class="mv mw iq lu b lv ne ly nf lf ng lj nh ln ni mk na nb nc nd bi translated">向前填充那些缺失行的最后已知值</li><li id="f507" class="mv mw iq lu b lv ne ly nf lf ng lj nh ln ni mk na nb nc nd bi translated">添加滞后和基于窗口的聚合</li></ul><p id="136e" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">我认为这听起来像是另一个模板的好候选。</p><p id="f6a3" class="pw-post-body-paragraph ls lt iq lu b lv mm jr lx ly mn ju ma lf mo mc md lj mp mf mg ln mq mi mj mk ij bi translated">你能想到什么吗？想投稿？请让我知道！</p></div></div>    
</body>
</html>