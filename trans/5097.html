<html>
<head>
<title>Transforming Probability Distributions &amp; Normalizing Flows</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">转换概率分布和标准化流程</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/transforming-probability-distributions-using-normalizing-flows-bcc5ed6ac2c9#2022-11-14">https://towardsdatascience.com/transforming-probability-distributions-using-normalizing-flows-bcc5ed6ac2c9#2022-11-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7ab4" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用张量流使用简单的双投影变换分布</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/3339b38b4db0015de701fc8c60477e66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DfOxK_2bB9IMcbrHPsVesQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用双射变换的正态到双峰分布。(图片由作者提供)</p></figure><p id="1383" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">你可以从这篇文章中学到/回顾到什么—</p><ol class=""><li id="0f1e" class="lu lv it la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated">开始使用<a class="ae md" href="https://www.tensorflow.org/probability/api_docs/python/tfp/distributions/TransformedDistribution" rel="noopener ugc nofollow" target="_blank"> TransformedDistribution </a>模块(在 TensorFlow Probability library 中)通过双射运算转换基本分布。</li><li id="dc4f" class="lu lv it la b lb me le mf lh mg ll mh lp mi lt lz ma mb mc bi translated">在 TensorFlow 中编写我们自己的自定义双射函数。</li><li id="bcc9" class="lu lv it la b lb me le mf lh mg ll mh lp mi lt lz ma mb mc bi translated">如何在自定义双射函数中定义正向和反向变换？</li><li id="eb42" class="lu lv it la b lb me le mf lh mg ll mh lp mi lt lz ma mb mc bi translated">可视化原始和定制转换的发行版。</li></ol><p id="4c76" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你想回顾双射和微分同胚的基础，作为规范化流程的开始，请查看<a class="ae md" href="https://medium.com/towards-data-science/getting-started-with-normalizing-flows-linear-algebra-probability-f2b863ff427d" rel="noopener">以前的帖子</a>；我们已经学习了双投影、雅可比和变换概率分布的基础知识，并推导了一些逆向和正向变换的数学公式，这些都将在本文中大量使用。所有的代码都可以在我的 GitHub 中找到，查看下面的参考资料。不要耽搁，让我们开始吧！</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h2 id="85be" class="mq mr it bd ms mt mu dn mv mw mx dp my lh mz na nb ll nc nd ne lp nf ng nh ni bi translated">已转换的分发类:</h2><p id="0421" class="pw-post-body-paragraph ky kz it la b lb nj ju ld le nk jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">在上一篇文章中，我们看到了如何定义一个双射体，并调用正向或反向方法来转换张量。在 TensorFlow 概率分布模块(<code class="fe no np nq nr b">tfp.distributions</code>)中，TransformedDistributions 类帮助我们为分布做这件事，让我们看一个例子。让我们从正态分布开始，我们知道该分布的指数函数将遵循对数正态分布。我们将使用<code class="fe no np nq nr b">TransformedDostributions</code>进行验证，我们从<code class="fe no np nq nr b">Normal</code>分布开始，并使用指数双射器，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="fb8d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这里我们从第 16 行(<code class="fe no np nq nr b">tfd.Normal</code>)的正态分布开始，并在第 19 行(<code class="fe no np nq nr b">tfb.Exp()</code>)引入了指数双射体。为了从正态转换到对数正态，我们在第 22 行中称之为 TransformedDistribution。为了确认给定起始正态分布，我们实际得到了对数正态分布，通过调用<code class="fe no np nq nr b">tfd.Normal</code>并绘制这些分布的样本来验证，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/16e33afe82e53b8f4b207f1e210221c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1Tz3j7KBZvDbwtUdegcy3A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 1:转换分布:从正态分布开始，我们达到对数正态分布ϕ(z)并用对数正态分布对数正态(z)进行验证。[图片由作者提供]</p></figure></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h2 id="d443" class="mq mr it bd ms mt mu dn mv mw mx dp my lh mz na nb ll nc nd ne lp nf ng nh ni bi translated">定义自定义对象:</h2><p id="e5d0" class="pw-post-body-paragraph ky kz it la b lb nj ju ld le nk jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">在前面的示例中，我们使用了在 bijector 模块中已经可用的指数 bijector，但是如果我们想要一个在 bijector 模块中不可用的自定义操作呢？我们可以定义一个自定义的 bijector，方法类似于通过 Keras 中的<a class="ae md" href="https://keras.io/guides/making_new_layers_and_models_via_subclassing/" rel="noopener ugc nofollow" target="_blank">子类化来创建新层。让我们编写一个自定义 bijector 类，其中正向映射函数由 f → (ax)给出，其中 a，x ∈ R .为了编写自定义 bijector，我遵循了 GitHub 源代码中描述的<code class="fe no np nq nr b"><a class="ae md" href="https://www.tensorflow.org/probability/api_docs/python/tfp/bijectors/Power" rel="noopener ugc nofollow" target="_blank">tfp.bijectors.power</a></code>类的结构。还提到不支持奇数整数作为幂:</a></p><blockquote class="nv nw nx"><p id="6c0c" class="ky kz ny la b lb lc ju ld le lf jx lg nz li lj lk oa lm ln lo ob lq lr ls lt im bi translated"><strong class="la iu">像 1 这样的奇数的倒数的幂。/ 3 不被支持，因为数值精度问题使该属性难以测试。为了模拟这种行为，我们建议使用反向双向喷射器(即，而不是 tfb)。幂(幂=1。/3)使用 tfb。反转(tfb。幂(幂=3。))).</strong></p></blockquote><p id="bdc3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下面的示例只是为了理解定义自定义 bijector 类的步骤:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">前向方法实现 f → (ax)的 bijector 子类化示例。</p></figure><p id="c729" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">给定这个简单的正向运算:f → (ax ),我们可以很容易地计算出正向 log-det-jacobian，这是上面代码块第 33 行的注释。给定正向 log-det-jacobian 函数，自动实现反向 log-det-jacobian。如果你想再次温习这些定义，请查看<a class="ae md" rel="noopener" target="_blank" href="/getting-started-with-normalizing-flows-linear-algebra-probability-f2b863ff427d">上一篇文章</a>。定义后，现在我们就可以使用该类了，我们可以用 python 绘制正向和反向转换的结果，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/1d1804d9d134549038b86fec3e1c6211.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m23nHUPJzxa5XwFw-z3sRQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 2:给定一个函数 f → (ax ),我们画出正向和反向变换的结果。[图片由作者提供]</p></figure><p id="14ea" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">类似地，可以绘制正向和反向 log-det-Jacobian 的结果动作，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/3e5998cd49cc07dbc2a70ba5e4b29672.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QHkt4PLArXO2MdzNMHVxJg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 3:给定一个函数 f → (ax ),我们画出雅可比行列式的正向和反向对数的结果。[图片由作者提供]</p></figure><h2 id="7c87" class="mq mr it bd ms mt mu dn mv mw mx dp my lh mz na nb ll nc nd ne lp nf ng nh ni bi translated">正态到双峰分布:</h2><p id="e4cf" class="pw-post-body-paragraph ky kz it la b lb nj ju ld le nk jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">除了从正态分布到对数正态分布，另一个重要的基本转换是双峰正态分布。顾名思义，双峰指的是有两个峰值的分布。从正态分布开始，我们可以应用软符号双射运算来达到双峰分布，其中软符号函数定义如下:</p><pre class="kj kk kl km gt od nr oe of aw og bi"><span id="1e5f" class="mq mr it nr b gy oh oi l oj ok">def softsign(x):</span><span id="6d1e" class="mq mr it nr b gy ol oi l oj ok">   return x/(1+abs(x))</span></pre><p id="7a8b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然而，这个双射在张量流概率中已经可用，所以我们可以像以前一样应用<code class="fe no np nq nr b">TransformedDistribution</code>,让我们看看:</p><pre class="kj kk kl km gt od nr oe of aw og bi"><span id="d2ce" class="mq mr it nr b gy oh oi l oj ok">tf.random.set_seed(1234)</span><span id="61b9" class="mq mr it nr b gy ol oi l oj ok">normal_dist = tfd.Normal(loc=0., scale=1.0) <br/># starting base distribution</span><span id="73db" class="mq mr it nr b gy ol oi l oj ok">sample_s = 500</span><span id="abc3" class="mq mr it nr b gy ol oi l oj ok">normal_dist_sample = normal_dist.sample(sample_s, seed=10)</span><span id="85bc" class="mq mr it nr b gy ol oi l oj ok">## bijector</span><span id="49b3" class="mq mr it nr b gy ol oi l oj ok">softsign = tfb.Softsign()</span><span id="04c1" class="mq mr it nr b gy ol oi l oj ok"># tf.random.set_seed(1234)</span><span id="be1a" class="mq mr it nr b gy ol oi l oj ok">bi_modal = tfd.TransformedDistribution(normal_dist, softsign)</span><span id="e17c" class="mq mr it nr b gy ol oi l oj ok">bi_modal_sample = bi_modal.sample(sample_s, seed=10)</span></pre><p id="6916" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们可以根据转换后的分布绘制样本，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/77c2e9a43ab0095231ca43fee080e62b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iNh5B2C-2N-_pIVa-igo3Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 4:从正态分布开始，我们应用软符号双射来达到双峰分布。[图片由作者提供]</p></figure><p id="8012" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们还可以将转换后的分布和原始分布可视化为等值线图，如下图所示，左图显示正态分布，右图显示转换后的分布。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi on"><img src="../Images/658505cd07f4305bb80c01b814fbdc35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wiGA0JecCO-56Q4GYXr8hg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 5:显示了基本分布(正态)和转换分布(双峰)的等值线图。[图片由作者提供]</p></figure><p id="b82b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">除了 2D 等高线图，我们还可以绘制如下 3D 等高线图:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/027b08966d6730216e572202b01f83e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6qqkYYuCi_ak_jue3uS9ew.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 6:与图 5 相同，但是代替 2D 图，我们也可以将它们可视化为 3D 图。[图片由作者提供]</p></figure></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><p id="78e1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们现在已经了解了规范化流程的所有基本要素；双射、转换概率分布、雅可比矩阵的正向和反向对数行列式的概念都在<a class="ae md" rel="noopener" target="_blank" href="/getting-started-with-normalizing-flows-linear-algebra-probability-f2b863ff427d">之前的文章</a>中描述过。在这里，我们学习了如何使用 TensorFlow 概率库来转换分布，以及一些我们自己定义自定义 bijector 类的例子。我们现在已经为深入研究基于正常化流的模型做好了准备，如<a class="ae md" href="https://arxiv.org/abs/1605.08803" rel="noopener ugc nofollow" target="_blank"> RealNVP </a>、<a class="ae md" href="https://arxiv.org/abs/1807.03039" rel="noopener ugc nofollow" target="_blank"> Glow </a>、<a class="ae md" href="https://arxiv.org/abs/1705.07057" rel="noopener ugc nofollow" target="_blank">Masked Auto-Regressive Flow</a>等。更多基于流量的模型即将推出！</p><p id="50b6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">保持坚强！干杯！！</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h2 id="d94b" class="mq mr it bd ms mt mu dn mv mw mx dp my lh mz na nb ll nc nd ne lp nf ng nh ni bi translated">参考资料:</h2><p id="7f41" class="pw-post-body-paragraph ky kz it la b lb nj ju ld le nk jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">[1] <a class="ae md" href="https://arxiv.org/abs/1908.09257" rel="noopener ugc nofollow" target="_blank">标准化流程:当前方法的介绍和回顾</a>。</p><p id="9551" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">[2]张量流<a class="ae md" href="https://www.tensorflow.org/probability/api_docs/python/tfp/distributions/TransformedDistribution" rel="noopener ugc nofollow" target="_blank">变换分布</a>。</p><p id="63a9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">[3]岗位使用的代码:<a class="ae md" href="https://github.com/suvoooo/Learn-TensorFlow/blob/master/TF-Proba/Norm-Flows/NormFlow_TransformDistribution.ipynb" rel="noopener ugc nofollow" target="_blank">笔记本</a>。</p><p id="2bcd" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="ny">除特别注明外，所有图片均为作者所有。</em></p></div></div>    
</body>
</html>