<html>
<head>
<title>Automated Alerts for Airflow with Slack</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">气流松弛的自动警报</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/automated-alerts-for-airflow-with-slack-5c6ec766a823#2022-07-13">https://towardsdatascience.com/automated-alerts-for-airflow-with-slack-5c6ec766a823#2022-07-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="57cb" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">利用Slack API获得DAG任务失败和成功的自动更新和警报</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/82528bd7c41ab3d7a7dd084533aeab90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oifFbsY2fGnmwMM1"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@artturijalli?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Artturi Jalli </a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="f2b3" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">让我们面对现实吧——有时气流Dag需要一段时间才能运行。与其不断地回到Airflow UI来检查dag更新，为什么不开始跟踪电子邮件、消息和待办事项，然后通过Slack获得运行结果的通知呢？</p><p id="379d" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">通过Slack管理气流通知可以方便地监控和调试气流任务。一个专用的slack通道还为其他人(如客户、产品经理和队友)提供了工作流状态的透明度，而无需检查Airflow UI。</p><h1 id="15c3" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">要求</h1><ol class=""><li id="dc59" class="mr ms iq lf b lg mt lj mu lm mv lq mw lu mx ly my mz na nb bi translated">对您的工作区的宽松管理员访问</li><li id="14f1" class="mr ms iq lf b lg nc lj nd lm ne lq nf lu ng ly my mz na nb bi translated">松弛API密钥</li><li id="9ce2" class="mr ms iq lf b lg nc lj nd lm ne lq nf lu ng ly my mz na nb bi translated">气流实例</li></ol></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="4b37" class="lz ma iq bd mb mc nh me mf mg ni mi mj jw nj jx ml jz nk ka mn kc nl kd mp mq bi translated">入门指南</h1><p id="905e" class="pw-post-body-paragraph ld le iq lf b lg mt jr li lj mu ju ll lm nm lo lp lq nn ls lt lu no lw lx ly ij bi translated">为您的Airflow实例安装以下python库</p><pre class="kg kh ki kj gt np nq nr bn ns nt bi"><span id="059b" class="nu ma iq nq b be nv nw l nx ny"># requirements.txt<br/>apache-airflow-providers-http<br/>apache-airflow-providers-slack<br/>apache-airflow-providers-slack[http]</span></pre><h2 id="a557" class="nz ma iq bd mb oa ob dn mf oc od dp mj lm oe of ml lq og oh mn lu oi oj mp ok bi translated">准备松弛</h2><p id="f50d" class="pw-post-body-paragraph ld le iq lf b lg mt jr li lj mu ju ll lm nm lo lp lq nn ls lt lu no lw lx ly ij bi translated">在您的工作区中创建一个通道，供API访问。我把我的叫做“气流”。</p><p id="4ca2" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">转到<code class="fe ol om on nq b">api.slack.com/apps</code>并点击“创建新应用”,供您的airflow实例访问。退出模式后，为您的slack workspace应用程序启用传入webhooks。然后，滚动到底部，选择“添加新的webhook到工作区”。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oo"><img src="../Images/93f1c68a5d62684a685dea8625313841.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YL_SoCC3gowSv3eARHApPg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Slack API webhooks</p></figure><p id="90d4" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">您可以从命令行测试您的webhook/api密钥，以验证所有设置是否正确(用您自己的密钥替换):</p><pre class="kg kh ki kj gt np nq nr bn ns nt bi"><span id="1a91" class="nu ma iq nq b be nv nw l op ny">curl -X POST -H 'Content-type: application/json' --data '{"text":"Hello, World!"}' https://hooks.slack.com/services/00000000000/00000000000/000000000000000000000000</span></pre><h2 id="af5e" class="nz ma iq bd mb oa ob dn mf oc od dp mj lm oe of ml lq og oh mn lu oi oj mp ok bi translated">完成气流设置</h2><p id="20b0" class="pw-post-body-paragraph ld le iq lf b lg mt jr li lj mu ju ll lm nm lo lp lq nn ls lt lu no lw lx ly ij bi translated">一旦启动并运行了Airflow，就在UI中创建新的HTTP连接。将其命名为<code class="fe ol om on nq b">slack</code>，并将webhook url插入到“host”输入中。api密钥的剩余部分将被输入到“密码”中。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oq"><img src="../Images/cf5a2997925e0ff88fcaa0464518f056.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DaQlQP_RyOJ7c3iIrpJpEw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">气流松弛HTTP连接设置</p></figure><p id="076a" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">现在，我们可以使用Airflow的<code class="fe ol om on nq b">BaseHook</code>、<code class="fe ol om on nq b">SlackWebHookOperator</code>和<code class="fe ol om on nq b">Dag Task Instance Context</code>向slack发送有关最新dag运行信息的警报。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="or os l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">宽限预警代码</p></figure><p id="cb42" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">该代码将在气流任务失败时发送消息。自动化该过程的最后一步是将<code class="fe ol om on nq b">slack_fail_alert</code>函数作为参数添加到dag默认参数中:</p><pre class="kg kh ki kj gt np nq nr bn ns nt bi"><span id="0ba5" class="nu ma iq nq b be nv nw l op ny">default_args = {<br/>   ...,<br/>   'on_failure_callback': slack_fail_alert<br/>}</span></pre><p id="5489" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">该代码也可以很容易地修改，以提醒任务成功或其他状态。</p><h2 id="b497" class="nz ma iq bd mb oa ob dn mf oc od dp mj lm oe of ml lq og oh mn lu oi oj mp ok bi translated">测试</h2><p id="1530" class="pw-post-body-paragraph ld le iq lf b lg mt jr li lj mu ju ll lm nm lo lp lq nn ls lt lu no lw lx ly ij bi translated">为了进行测试，有意在代码中写入一个错误，以验证airflow会在任务失败时发送消息。或者，如果不想破坏代码，可以在<code class="fe ol om on nq b">on_success_callback</code>参数中使用这些函数。假设一切都设置正确，您将收到一条消息，其中包含最新任务运行的详细信息。</p><p id="65cc" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">下次您在dag工作流中遇到故障时，将通过slack通知您任务的名称和日志的直接链接，以便您可以开始调试过程。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ot"><img src="../Images/ddfe082f2e503e123168b44f7153a745.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QnHzpgX_RjFryX19uU2cWA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">气流松弛信息警报</p></figure></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="ea26" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">就是这样！只需一点点设置，我们就创建了气流的自动监控和警报。接下来的步骤可能是邀请项目的相关利益相关者到<strong class="lf ir"> #airflow </strong> slack channel，让他们了解当前工作流的状态。如果您的应用程序或数据仓库的最终用户看到任何错误，他们可以在将问题升级到其他人之前，检查气流通道以查看错误是否立即显现。</p><p id="2c50" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">感谢阅读！查看这个<a class="ae kv" href="https://github.com/cyoung43/airflow-demo" rel="noopener ugc nofollow" target="_blank">库</a>，获取额外的代码和上下文，以及其他有用的气流技巧。</p></div></div>    
</body>
</html>