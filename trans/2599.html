<html>
<head>
<title>How to Deploy Scikit-Learn Models to Azure Container Instances</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将Scikit-Learn模型部署到Azure容器实例</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-deploy-scikit-learn-models-to-azure-container-instances-a0a59d0d07a1#2022-06-06">https://towardsdatascience.com/how-to-deploy-scikit-learn-models-to-azure-container-instances-a0a59d0d07a1#2022-06-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5be5" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated"><em class="ki">使用Azure容器实例生产您的Scikit-Learn模型</em></h2></div><h1 id="e6f2" class="kj kk it bd kl km kn ko kp kq kr ks kt jz ku ka kv kc kw kd kx kf ky kg kz la bi translated">1.介绍</h1><p id="67a6" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">现在你已经训练了你的scikit-learn模型，下一步是什么？如何将它作为API提供给下游应用程序？在本文中，我们将研究如何使用MLFlow、Azure机器学习和Azure容器实例将scikit-learn模型作为API进行训练和部署。以下是我们将使用的服务的简要描述。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi lx"><img src="../Images/a1445a6edc140595f5395684323d0a7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZqZVf_NM33yrW_cr"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">由<a class="ae mn" href="https://unsplash.com/@spacex?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> SpaceX </a>在<a class="ae mn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="b572" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu">什么是MLFlow？</strong></p><p id="d07c" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu">ML flow</strong>【1】是一个管理ML生命周期的开源平台，包括实验、可复制性、部署和中央模型注册。MLFlow提供4种不同的组件:</p><ol class=""><li id="8eb7" class="mt mu it ld b le mo lh mp lk mv lo mw ls mx lw my mz na nb bi translated"><strong class="ld iu"> MLFlow Tracking: </strong>记录和查询实验:代码、数据、配置和结果</li><li id="d2ce" class="mt mu it ld b le nc lh nd lk ne lo nf ls ng lw my mz na nb bi translated"><strong class="ld iu"> MLFlow项目:</strong>将数据科学代码打包成可在任何平台上运行的格式</li><li id="e336" class="mt mu it ld b le nc lh nd lk ne lo nf ls ng lw my mz na nb bi translated"><strong class="ld iu"> MLFlow模型:</strong>在不同的服务环境中部署机器学习模型</li><li id="0f2a" class="mt mu it ld b le nc lh nd lk ne lo nf ls ng lw my mz na nb bi translated"><strong class="ld iu">模型注册:</strong>在中央存储库中存储、注释、发现和管理模型</li></ol><p id="20d6" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">我们将使用MLFlow跟踪功能来记录机器学习实验的参数、结果和工件。</p><p id="7efc" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu">什么是Azure机器学习？</strong></p><p id="7985" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">Azure机器学习 [2]是微软Azure云计算平台的一部分，帮助数据科学家和工程师管理他们的机器学习工作流程。</p><p id="009b" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu">什么是Azure容器实例？</strong></p><p id="2b68" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu">Azure Container Instances(ACI)</strong>[3]是微软Azure的托管服务，它允许我们运行负载平衡的容器化服务，并具有带REST API的HTTP端点。</p><h1 id="b392" class="kj kk it bd kl km kn ko kp kq kr ks kt jz ku ka kv kc kw kd kx kf ky kg kz la bi translated">2.安装Azure</h1><h2 id="dec2" class="nh kk it bd kl ni nj dn kp nk nl dp kt lk nm nn kv lo no np kx ls nq nr kz ns bi translated">Azure帐户</h2><p id="51d3" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">我们将使用Azure ML和ACI，因此Azure帐户是强制性的。注册一个免费的Azure帐户，如果你是新用户，头30天可以获得200美元的信用点数。</p><h2 id="d9bf" class="nh kk it bd kl ni nj dn kp nk nl dp kt lk nm nn kv lo no np kx ls nq nr kz ns bi translated">Azure机器学习工作区</h2><blockquote class="nt nu nv"><p id="6e9c" class="lb lc nw ld b le mo ju lg lh mp jx lj nx mq lm ln ny mr lq lr nz ms lu lv lw im bi translated">工作区[4]是Azure机器学习的顶级资源，提供了一个集中的地方来处理您在使用Azure机器学习时创建的所有工件。工作区保存了所有训练运行的历史，包括日志、指标、输出和脚本的快照。您可以使用这些信息来确定哪一次训练能够产生最佳模型。</p></blockquote><p id="fe6b" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">资源组是创建Azure机器学习工作空间的先决条件。</p><p id="38c5" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu"> 1。创建资源组</strong></p><blockquote class="nt nu nv"><p id="0113" class="lb lc nw ld b le mo ju lg lh mp jx lj nx mq lm ln ny mr lq lr nz ms lu lv lw im bi translated"><em class="it">资源组是保存Azure解决方案相关资源的容器。</em></p></blockquote><ul class=""><li id="4ff6" class="mt mu it ld b le mo lh mp lk mv lo mw ls mx lw oa mz na nb bi translated">转到<a class="ae mn" href="https://portal.azure.com/" rel="noopener ugc nofollow" target="_blank">https://portal.azure.com/</a></li><li id="5969" class="mt mu it ld b le nc lh nd lk ne lo nf ls ng lw oa mz na nb bi translated">在Azure Services下或通过搜索栏找到“资源组”</li></ul><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi ob"><img src="../Images/a796909645d812fc05a40be71566f6c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PcmE_x5q4xgNr4WI"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">作者图片</p></figure><ul class=""><li id="0059" class="mt mu it ld b le mo lh mp lk mv lo mw ls mx lw oa mz na nb bi translated">创建新的资源组</li></ul><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi oc"><img src="../Images/7838fa2f1c2799749f656024324b7d7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*s1NpbUQRGXfYz8V4"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">作者图片</p></figure><ul class=""><li id="f8dc" class="mt mu it ld b le mo lh mp lk mv lo mw ls mx lw oa mz na nb bi translated">填写详细信息，如订阅、资源组名称和区域</li></ul><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi od"><img src="../Images/99813031c3f5c79745dc9da509f9edd1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qbMp7IQo_noK_tsp"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">作者图片</p></figure><p id="4ddf" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu"> 2。创建Azure ML工作区</strong></p><ul class=""><li id="3697" class="mt mu it ld b le mo lh mp lk mv lo mw ls mx lw oa mz na nb bi translated">在Azure Services下或者通过搜索栏找到“机器学习”。</li></ul><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi oe"><img src="../Images/1ec59a1c4ed5f700fffbd5924c3de3e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cXAqkqjjGd-YCXjZ"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">作者图片</p></figure><ul class=""><li id="f581" class="mt mu it ld b le mo lh mp lk mv lo mw ls mx lw oa mz na nb bi translated">点击创建</li></ul><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi of"><img src="../Images/ef49a97b1ac7513df148599d9314c7d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-pML9eniGIULX8QX"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">作者图片</p></figure><ul class=""><li id="ca6d" class="mt mu it ld b le mo lh mp lk mv lo mw ls mx lw oa mz na nb bi translated">填空。资源组是我们在上一步中创建的。</li></ul><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi og"><img src="../Images/017022a8df1b25fde975bc85b555d09c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rZdepEroKi-71By9"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">作者图片</p></figure><ul class=""><li id="e2b3" class="mt mu it ld b le mo lh mp lk mv lo mw ls mx lw oa mz na nb bi translated">MLFlow跟踪服务器是作为Azure ML工作区的一部分自动创建的</li></ul><h1 id="2961" class="kj kk it bd kl km kn ko kp kq kr ks kt jz ku ka kv kc kw kd kx kf ky kg kz la bi translated">3.设置培训环境</h1><h2 id="7d8a" class="nh kk it bd kl ni nj dn kp nk nl dp kt lk nm nn kv lo no np kx ls nq nr kz ns bi translated"><strong class="ak"> IDE </strong></h2><p id="a328" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">我使用的是Visual Studio代码，但是你可以使用任何你选择的IDE</p><h2 id="76fb" class="nh kk it bd kl ni nj dn kp nk nl dp kt lk nm nn kv lo no np kx ls nq nr kz ns bi translated"><strong class="ak">康达环境</strong></h2><p id="4dde" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">确保您的机器上安装了miniconda3。从命令行界面创建python 3.7 conda环境。环境名是任意的，我将其命名为<code class="fe oh oi oj ok b">general</code>。</p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="ddb1" class="nh kk it ok b gy op oq l or os">#command line <br/>conda create -n general python=3.7</span></pre><p id="bf6c" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">激活康达环境。我们将在这种环境下进行所有的开发工作。</p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="22f6" class="nh kk it ok b gy op oq l or os">#command line<br/>conda activate general</span></pre><p id="3156" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">安装必要的软件包</p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="b50a" class="nh kk it ok b gy op oq l or os">azureml-core==1.39<br/>pandas==1.3.5<br/>scikit-learn==0.23.2<br/>cloudpickle==2.0.0<br/>psutil==5.9.0<br/>mlflow==1.24.0</span></pre><h2 id="5158" class="nh kk it bd kl ni nj dn kp nk nl dp kt lk nm nn kv lo no np kx ls nq nr kz ns bi translated">码头工人</h2><p id="17a6" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">您的本地机器上需要Docker，因为我们将在本地部署webservice作为docker容器，以便在将其部署到Azure容器实例之前进行调试。</p><h2 id="9734" class="nh kk it bd kl ni nj dn kp nk nl dp kt lk nm nn kv lo no np kx ls nq nr kz ns bi translated"><strong class="ak"> Azure机器学习工作区配置</strong></h2><p id="ca37" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">下载Azure机器学习工作区配置。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi ot"><img src="../Images/2e42355837b2a9856fce15a30c8b113f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RDOuiFGQ0gqZTFxa"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">作者图片</p></figure><p id="28bf" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">配置文件采用JSON格式，包含以下信息:</p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="dd31" class="nh kk it ok b gy op oq l or os"># config.json</span><span id="f8f1" class="nh kk it ok b gy ou oq l or os">{<br/>    "subscription_id": "your-subscription-id",<br/>    "resource_group": "your-resource-group-name",<br/>    "workspace_name": "your-workspace-name"<br/>}</span></pre><p id="ff71" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">我们将需要这些信息来连接到AML workspace以记录实验。</p><h2 id="15ec" class="nh kk it bd kl ni nj dn kp nk nl dp kt lk nm nn kv lo no np kx ls nq nr kz ns bi translated"><strong class="ak">项目结构</strong></h2><p id="d721" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">这些是项目文件夹中的笔记本和脚本。我们将在下一节中逐一介绍。</p><ul class=""><li id="7d48" class="mt mu it ld b le mo lh mp lk mv lo mw ls mx lw oa mz na nb bi translated"><code class="fe oh oi oj ok b">train.ipynb</code>:实验的预处理、训练和记录</li><li id="aa2d" class="mt mu it ld b le nc lh nd lk ne lo nf ls ng lw oa mz na nb bi translated"><code class="fe oh oi oj ok b">register_model.ipynb</code>:向Azure ML注册模型和环境</li><li id="1ab6" class="mt mu it ld b le nc lh nd lk ne lo nf ls ng lw oa mz na nb bi translated"><code class="fe oh oi oj ok b">test_inference.ipynb</code>:调用带有样本数据的web服务(本地或ACI)进行测试</li><li id="649e" class="mt mu it ld b le nc lh nd lk ne lo nf ls ng lw oa mz na nb bi translated"><code class="fe oh oi oj ok b">local_deploy.ipynb</code>:使用Docker在本地部署模型</li><li id="afff" class="mt mu it ld b le nc lh nd lk ne lo nf ls ng lw oa mz na nb bi translated"><code class="fe oh oi oj ok b">aci_deploy.ipynb</code>:模型部署到ACI</li><li id="9911" class="mt mu it ld b le nc lh nd lk ne lo nf ls ng lw oa mz na nb bi translated"><code class="fe oh oi oj ok b">score.py</code>:用于推理的模型的输入脚本</li><li id="6837" class="mt mu it ld b le nc lh nd lk ne lo nf ls ng lw oa mz na nb bi translated"><code class="fe oh oi oj ok b">conda.yaml</code>:包含创建推理环境的依赖关系</li></ul><h1 id="c683" class="kj kk it bd kl km kn ko kp kq kr ks kt jz ku ka kv kc kw kd kx kf ky kg kz la bi translated">4.项目演练</h1><p id="12ec" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">该示例带我们完成了以下步骤:</p><ul class=""><li id="9a9c" class="mt mu it ld b le mo lh mp lk mv lo mw ls mx lw oa mz na nb bi translated">在本地训练scikit-learn模型</li><li id="11ad" class="mt mu it ld b le nc lh nd lk ne lo nf ls ng lw oa mz na nb bi translated">在Azure机器学习上跟踪MLFlow的scikit-learn实验</li><li id="4eac" class="mt mu it ld b le nc lh nd lk ne lo nf ls ng lw oa mz na nb bi translated">在Azure机器学习上注册模型</li><li id="8f09" class="mt mu it ld b le nc lh nd lk ne lo nf ls ng lw oa mz na nb bi translated">将模型作为本地web服务进行部署和测试</li><li id="fb2a" class="mt mu it ld b le nc lh nd lk ne lo nf ls ng lw oa mz na nb bi translated">将模型作为ACI服务进行部署和测试</li></ul><p id="75a1" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">我们将使用来自国家糖尿病、消化和肾脏疾病研究所的Pima印度糖尿病数据集[5]。数据集的目的是基于数据集中包含的某些诊断测量结果，诊断性地预测患者是否患有糖尿病。数据集由几个医学预测变量和一个二元目标变量<code class="fe oh oi oj ok b">Outcome</code>组成。预测变量包括患者的怀孕次数、身体质量指数、胰岛素水平、年龄等。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi ov"><img src="../Images/be4e2b4a9186168a41161928e28b1b97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gFhHSpGncC9DMi_l"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">作者图片</p></figure><h2 id="ceb9" class="nh kk it bd kl ni nj dn kp nk nl dp kt lk nm nn kv lo no np kx ls nq nr kz ns bi translated">4.1.培训sci kit-学习模型</h2><p id="2a54" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">本节中的所有代码都在<code class="fe oh oi oj ok b">train.ipynb</code>中。</p><p id="de9c" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu">导入包</strong></p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="2192" class="nh kk it ok b gy op oq l or os">import mlflow<br/>from azureml.core import Workspace<br/>import pandas as pd<br/>import numpy as np<br/>from sklearn.ensemble import RandomForestClassifier<br/>from sklearn.model_selection import GridSearchCV, train_test_split<br/>from sklearn.pipeline import Pipeline<br/>from sklearn.preprocessing import FunctionTransformer<br/>from sklearn.impute import SimpleImputer</span></pre><p id="3d46" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu">设置工作空间</strong></p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="bc57" class="nh kk it ok b gy op oq l or os">ws = Workspace.from_config()</span></pre><p id="d033" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">运行此单元后，您可能会得到一个URL来执行web身份验证。这是连接到Azure机器学习工作区所必需的。完成后，您可以返回IDE并继续下一步。</p><p id="d373" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu">设置跟踪URI </strong></p><p id="ec50" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">MLFlow跟踪URI是我们可以找到MLFlow跟踪服务器的地址。我们设置跟踪URI来让MLFlow知道在哪里记录实验。</p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="f0a3" class="nh kk it ok b gy op oq l or os">mlflow.set_tracking_uri(ws.get_mlflow_tracking_uri())</span></pre><p id="0be5" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">跟踪URI的格式如下</p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="da47" class="nh kk it ok b gy op oq l or os">azureml://&lt;region&gt;.api.azureml.ms/mlflow/v1.0/subscriptions/&lt;subscription-id&gt;/resourceGroups/&lt;resource-group&gt;/providers/Microsoft.MachineLearningServices/workspaces/&lt;aml-workspace&gt;?</span></pre><p id="94dc" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu">设置MLFlow实验</strong></p><p id="caad" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">下面的代码定义了MLFlow实验的名称。MLFlow实验是组织不同运行的一种方式。一个实验包含多次运行，每次运行都是训练代码的一次执行。我们可以为每次运行定义要存储的参数、结果和工件。如果实验名称不存在，将创建一个新的实验，否则它会将运行记录到同名的现有实验中。</p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="6d3c" class="nh kk it ok b gy op oq l or os">experiment_name = 'diabetes-sklearn'<br/>mlflow.set_experiment(experiment_name)</span></pre><p id="567d" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu">加载数据集</strong></p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="ac33" class="nh kk it ok b gy op oq l or os">input_path = 'path\\to\\data.csv'</span><span id="d02e" class="nh kk it ok b gy ou oq l or os">df = pd.read_csv(input_path, sep = ',')</span><span id="dc38" class="nh kk it ok b gy ou oq l or os">y = df.pop('Outcome')<br/>X = df</span><span id="f00e" class="nh kk it ok b gy ou oq l or os">X_train, X_test, y_train, y_test = train_test_split(X, y)</span></pre><p id="8404" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu">预处理</strong></p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="c7fa" class="nh kk it ok b gy op oq l or os">def change_type(x):</span><span id="6461" class="nh kk it ok b gy ou oq l or os">    x = x.copy()<br/>    for col in ['Pregnancies', 'Glucose', 'BloodPressure', 'SkinThickness', 'Insulin', 'Age']:<br/>        x[col] = x[col].astype('float')</span><span id="139a" class="nh kk it ok b gy ou oq l or os">    return x</span><span id="7c1e" class="nh kk it ok b gy ou oq l or os">def replace_zeros(x):</span><span id="c1f1" class="nh kk it ok b gy ou oq l or os">    x = x.copy()<br/>    x[['Glucose','BloodPressure','SkinThickness','Insulin','BMI']] = x[['Glucose','BloodPressure','SkinThickness','Insulin','BMI']].replace(0,np.NaN)</span><span id="1572" class="nh kk it ok b gy ou oq l or os">    return x</span><span id="1ac9" class="nh kk it ok b gy ou oq l or os">ft_change_type = FunctionTransformer(change_type)<br/>ft_replace_zeros = FunctionTransformer(replace_zeros)<br/>num_imputer = SimpleImputer()</span></pre><p id="49ca" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">我们创建了两个scikit-learn <code class="fe oh oi oj ok b">FunctionTransformer</code>，用于将所选列的数据类型更改为float，并用NaN替换零值。</p><p id="d582" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu">创建一个scikit-learn管道</strong></p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="1377" class="nh kk it ok b gy op oq l or os">rf_clf = RandomForestClassifier()<br/>pipe = Pipeline([('change_type', ft_change_type), ('replace_zeros', ft_replace_zeros), ('fillna', num_imputer), ('clf', rf_clf)])</span></pre><p id="d6a9" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu">超参数调谐</strong></p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="3ac1" class="nh kk it ok b gy op oq l or os">mlflow.sklearn.autolog(max_tuning_runs=None)</span><span id="f091" class="nh kk it ok b gy ou oq l or os">param_grid = {'clf__n_estimators': [10,20,30], 'clf__max_depth':[2,7,10]}</span><span id="13a6" class="nh kk it ok b gy ou oq l or os">clf = GridSearchCV(pipe, param_grid = param_grid, scoring = ['roc_auc', 'precision', 'recall', 'f1', 'accuracy'], refit = 'roc_auc')<br/>clf.fit(X_train, y_train)</span></pre><p id="e1ce" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">记录的结果可以在Azure ML实验中找到。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi ow"><img src="../Images/f007042b131cca6cf9e1b0784fe20b73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*InOyyyJ2yhz-Vpx3"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">作者图片</p></figure><p id="227b" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">最佳模型的模型工件和<code class="fe oh oi oj ok b">run_id</code>可以在<code class="fe oh oi oj ok b">Outputs + logs</code>选项卡中找到。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi ow"><img src="../Images/067627c4b9cb21f31b34d45cf265f065.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RPG84BBFihzFh49l"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">作者图片</p></figure><ul class=""><li id="8486" class="mt mu it ld b le mo lh mp lk mv lo mw ls mx lw oa mz na nb bi translated"><code class="fe oh oi oj ok b">model.pkl</code>是包含scikit-learn模型对象的文件。这个模型的文件路径是<code class="fe oh oi oj ok b">best_estimator/model.pkl</code>,我们将在下一步中需要模型注册的路径。</li><li id="fd1d" class="mt mu it ld b le nc lh nd lk ne lo nf ls ng lw oa mz na nb bi translated"><code class="fe oh oi oj ok b">conda.yaml</code>和<code class="fe oh oi oj ok b">requirements.txt</code>包含训练模型所需的conda和pip包。</li><li id="ce94" class="mt mu it ld b le nc lh nd lk ne lo nf ls ng lw oa mz na nb bi translated"><code class="fe oh oi oj ok b">run_id</code>:ml flow运行的唯一标识符。我们将在下一步中使用它来检索模型文件。</li></ul><h2 id="64f5" class="nh kk it bd kl ni nj dn kp nk nl dp kt lk nm nn kv lo no np kx ls nq nr kz ns bi translated">4.2.注册模型</h2><p id="2c2a" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">将模型注册到Azure Machine Learning的模型注册中心的目的是让用户能够通过模型版本控制来跟踪模型的变化。以下代码写在<code class="fe oh oi oj ok b">register_model.ipynb</code>笔记本上。</p><p id="1a44" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu">检索实验</strong></p><p id="612c" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">我们通过定义工作区和实验名称从工作区中检索实验。</p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="b91f" class="nh kk it ok b gy op oq l or os">from azureml.core import Experiment, Workspace</span><span id="3f66" class="nh kk it ok b gy ou oq l or os">experiment_name = 'diabetes-sklearn'</span><span id="5796" class="nh kk it ok b gy ou oq l or os">ws = Workspace.from_config()<br/>experiment = Experiment(ws, experiment_name)</span></pre><p id="1b30" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu">检索运行</strong></p><p id="2f47" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">使用上一节中获得的<code class="fe oh oi oj ok b">run_id</code>从实验中检索运行。</p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="d481" class="nh kk it ok b gy op oq l or os">run_id = 'e665287a-ce53-41f9-a6c1-d0089a35353a'<br/>run = [r for r in experiment.get_runs() if r.id == run_id][0]</span></pre><p id="27fa" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu">注册型号</strong></p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="a97c" class="nh kk it ok b gy op oq l or os">model = run.register_model(model_name = 'diabetes_model', model_path = 'best_estimator/model.pkl')</span></pre><ul class=""><li id="f99d" class="mt mu it ld b le mo lh mp lk mv lo mw ls mx lw oa mz na nb bi translated"><code class="fe oh oi oj ok b">model_name</code>:赋予注册型号的任意名称</li><li id="f0aa" class="mt mu it ld b le nc lh nd lk ne lo nf ls ng lw oa mz na nb bi translated"><code class="fe oh oi oj ok b">model_path</code>:到<code class="fe oh oi oj ok b">model.pkl</code>文件的路径</li></ul><p id="b435" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">我们可以在Azure机器学习的“模型”选项卡中找到注册的模型。将模型文件注册到相同的模型名称会创建不同版本的模型。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi ox"><img src="../Images/832c6a178f552ac215d6269285341ff0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lgfPLn42jZ4O2SEO"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">作者图片</p></figure><p id="e3d9" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">我们可以通过单击模型名称来查看模型的最新版本的详细信息。详细信息包括生成模型的实验名称和运行id，这对于维护数据链非常有用。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi ox"><img src="../Images/45b0879a0b408f15c6e5a5721db6ce94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ih_p3Pd78MKyTdvQ"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">作者图片</p></figure><h2 id="af99" class="nh kk it bd kl ni nj dn kp nk nl dp kt lk nm nn kv lo no np kx ls nq nr kz ns bi translated">4.3.创建评分脚本</h2><p id="8bd2" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">通常称为<code class="fe oh oi oj ok b">score.py</code>的评分脚本在推理过程中用作模型的入口点。</p><p id="14cf" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><code class="fe oh oi oj ok b">score.py</code>由两个强制功能组成:</p><ol class=""><li id="f340" class="mt mu it ld b le mo lh mp lk mv lo mw ls mx lw my mz na nb bi translated"><code class="fe oh oi oj ok b">init()</code>:将模型作为全局变量加载</li><li id="4e64" class="mt mu it ld b le nc lh nd lk ne lo nf ls ng lw my mz na nb bi translated"><code class="fe oh oi oj ok b">run()</code>:通过<code class="fe oh oi oj ok b">data</code>参数<br/>接收待评分的新数据a .对新数据进行预处理<br/> b .对新数据进行预测<br/> c .对预测进行后处理<br/> d .返回预测结果</li></ol><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="2b33" class="nh kk it ok b gy op oq l or os"># score.py</span><span id="67b2" class="nh kk it ok b gy ou oq l or os">import json<br/>import os<br/>import joblib<br/>import pandas as pd</span><span id="022d" class="nh kk it ok b gy ou oq l or os">def init():<br/>    global model<br/>    model_path = os.path.join(os.getenv('AZUREML_MODEL_DIR'), 'model.pkl')<br/>    model = joblib.load(model_path)</span><span id="bab5" class="nh kk it ok b gy ou oq l or os">def run(data):<br/>    test_data = pd.DataFrame(json.loads(json.loads(data)['input']))<br/>    proba = model.predict_proba(test_data)[:,-1].tolist()<br/>    return json.dumps({'proba':proba})</span></pre><h2 id="b81f" class="nh kk it bd kl ni nj dn kp nk nl dp kt lk nm nn kv lo no np kx ls nq nr kz ns bi translated">4.4.本地部署</h2><p id="01e2" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">在本节中，我们将在部署到ACI之前在本地调试webservice。代码写在<code class="fe oh oi oj ok b">local_deploy.ipynb</code>中。</p><p id="c8d4" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu">定义工作空间</strong></p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="7742" class="nh kk it ok b gy op oq l or os">from azureml.core import Workspace<br/>ws = Workspace.from_config()</span></pre><p id="58fb" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu">检索模型</strong></p><p id="512c" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">通过定义工作空间、模型名称和模型版本来检索注册的模型。</p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="0dce" class="nh kk it ok b gy op oq l or os">from azureml.core.model import Model<br/>model = Model(ws, 'diabetes_model', version=5)</span></pre><p id="5472" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu">创建自定义推理环境</strong></p><p id="5c9f" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">在训练模型时，我们已经将环境依赖性作为一个<code class="fe oh oi oj ok b">conda.yaml</code>文件记录到MLFlow中。我们将使用这个文件来创建一个定制的推理环境。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi oy"><img src="../Images/94ca45133768ac525326e4ee2710522e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pj4AGb3ek273pvmt"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">作者图片</p></figure><p id="cbb8" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">将<code class="fe oh oi oj ok b">conda.yaml</code>文件下载到您的项目文件夹中，并在<code class="fe oh oi oj ok b">pip</code>依赖项下添加<code class="fe oh oi oj ok b">azureml-defaults</code>以及推理过程中需要的任何其他依赖项。下面是<code class="fe oh oi oj ok b">conda.yaml</code>现在的样子。</p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="d042" class="nh kk it ok b gy op oq l or os"># conda.yaml</span><span id="28d9" class="nh kk it ok b gy ou oq l or os">channels:<br/>- conda-forge<br/>dependencies:<br/>- python=3.7.11<br/>- pip<br/>- pip:<br/>  - mlflow<br/>  - cloudpickle==2.0.0<br/>  - psutil==5.9.0<br/>  - scikit-learn==0.23.2<br/>  **- pandas==1.3.5<br/>  - azureml-defaults**<br/>name: mlflow-env</span></pre><p id="1e9f" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">接下来，我们用来自<code class="fe oh oi oj ok b">conda.yaml</code>文件的依赖项创建一个名为<code class="fe oh oi oj ok b">diabetes-env</code>的Azure ML环境，并将其注册到Azure ML Workspace。</p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="238f" class="nh kk it ok b gy op oq l or os">from azureml.core import Environment<br/>env = Environment.from_conda_specification(name='diabetes-env', file_path="./conda.yaml")<br/>env.register(ws)</span></pre><p id="546c" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">我们可以在“自定义环境”下的Azure机器学习“环境”选项卡中查看注册的环境。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi oz"><img src="../Images/0acf9557f1e982dbf02300f00a3f18d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FMLpibWbqv7d7HU9"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">作者图片</p></figure><p id="227c" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu">定义推理配置</strong></p><p id="587a" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">这里我们定义了环境和评分脚本。</p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="3b3b" class="nh kk it ok b gy op oq l or os">from azureml.core.model import InferenceConfig<br/>inference_config = InferenceConfig(<br/>    environment=env,<br/>    source_directory=".",<br/>    entry_script="./score.py",<br/>)</span></pre><p id="c559" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu">定义部署配置</strong></p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="1e8b" class="nh kk it ok b gy op oq l or os">from azureml.core.webservice import LocalWebservice<br/>deployment_config = LocalWebservice.deploy_configuration(port=6789)</span></pre><p id="13a8" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu">部署本地web服务</strong></p><p id="fd58" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">在运行下面的单元之前，确保Docker正在您的本地机器上运行。</p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="d875" class="nh kk it ok b gy op oq l or os">service = Model.deploy(<br/>    workspace = ws,<br/>    name = 'diabetes-prediction-service',<br/>    models = [model],<br/>    inference_config = inference_config,<br/>    deployment_config = deployment_config,<br/>    overwrite=True)<br/>    <br/>service.wait_for_deployment(show_output=True)</span></pre><p id="f242" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><code class="fe oh oi oj ok b">model.pkl</code>文件将从Azure Machine Learning下载到一个临时的本地文件夹中，一个带有依赖关系的docker映像将被创建并注册到Azure Container Registry (ACR)中。该映像将从ACR下载到本地机器上，运行webservice的docker容器将从该映像本地构建。下面显示了成功部署的输出消息。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div class="gh gi pa"><img src="../Images/a8639a8942513f483ddbbb04bfe9a78c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1172/0*ljlDXt3OXnetvTbG"/></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">作者图片</p></figure><p id="d4d2" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">我们可以使用以下公式获得得分URI:</p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="5ef4" class="nh kk it ok b gy op oq l or os">print (service.scoring_uri)</span><span id="7b3c" class="nh kk it ok b gy ou oq l or os">&gt;&gt; '&lt;http://localhost:6789/score&gt;'</span></pre><p id="df3b" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">这是我们将向其发送评分请求的URI。</p><h2 id="6302" class="nh kk it bd kl ni nj dn kp nk nl dp kt lk nm nn kv lo no np kx ls nq nr kz ns bi translated">4.5.测试本地web服务</h2><p id="1d90" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">在本节中，我们将测试本地web服务。代码是用<code class="fe oh oi oj ok b">inference_test.ipynb</code>写的。</p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="2ddd" class="nh kk it ok b gy op oq l or os">import requests<br/>import json<br/>import pandas as pd</span><span id="d118" class="nh kk it ok b gy ou oq l or os">local_deployment = True<br/>scoring_uri = '&lt;http://localhost:6789/score&gt;'<br/>api_key = None<br/>input_path = 'path/to/data.csv'</span><span id="34d8" class="nh kk it ok b gy ou oq l or os"># load the data for testing<br/>df = pd.read_csv(input_path, sep = ',')<br/>y = df.pop('Outcome')<br/>X = df<br/>input_data = json.dumps({'input':X.head(1).to_json(orient = 'records')})</span><span id="2d4c" class="nh kk it ok b gy ou oq l or os">if local_deployment:<br/>    headers = {'Content-Type':'application/json'}<br/>else:<br/>    headers = {'Content-Type':'application/json', 'Authorization':('Bearer '+ api_key)}<br/>resp = requests.post(scoring_uri, input_data, headers=headers)</span><span id="f2a1" class="nh kk it ok b gy ou oq l or os">print("prediction:", resp.text)</span></pre><p id="521b" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">我们向<code class="fe oh oi oj ok b">scoring_uri</code>发送了post请求以及JSON格式的数据。下面是<code class="fe oh oi oj ok b">input_data</code>的样子:</p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="e190" class="nh kk it ok b gy op oq l or os">'{"input": "[{\\\\"Pregnancies\\\\":6,\\\\"Glucose\\\\":148,\\\\"BloodPressure\\\\":72,\\\\"SkinThickness\\\\":35,\\\\"Insulin\\\\":0,\\\\"BMI\\\\":33.6,\\\\"DiabetesPedigreeFunction\\\\":0.627,\\\\"Age\\\\":50}]"}'</span></pre><p id="67f0" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">下面是对单个记录进行推断的响应示例。返回值包含被诊断为糖尿病的人的概率。</p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="c2e4" class="nh kk it ok b gy op oq l or os">&gt;&gt; "{\\"proba\\": [0.6520730332205742]}"</span></pre><p id="844c" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">以下是对3条记录的推断的示例响应。</p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="994b" class="nh kk it ok b gy op oq l or os">&gt;&gt; "{\\"proba\\": [0.5379796003419955, 0.2888339011346382, 0.5526596295928842]}"</span></pre><p id="4875" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">响应格式可以在<code class="fe oh oi oj ok b">score.py</code>文件的<code class="fe oh oi oj ok b">run</code>功能中自定义。</p><p id="3cb3" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu">终止本地web服务</strong></p><p id="47ad" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">通过使用命令提示符终止Docker容器来终止webservice。</p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="5ed0" class="nh kk it ok b gy op oq l or os"># CLI<br/>docker kill &lt;container id&gt;</span></pre><h2 id="d86d" class="nh kk it bd kl ni nj dn kp nk nl dp kt lk nm nn kv lo no np kx ls nq nr kz ns bi translated">4.6.部署到Azure容器实例</h2><p id="f98d" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">在本地成功测试该模型后，就可以部署到ACI了。部署步骤类似于本地部署。在<code class="fe oh oi oj ok b">aci_deploy.ipynb</code>笔记本中:</p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="a7d6" class="nh kk it ok b gy op oq l or os">from azureml.core import Workspace<br/>ws = Workspace.from_config()</span><span id="69bb" class="nh kk it ok b gy ou oq l or os">from azureml.core.model import Model<br/>model = Model(ws, 'diabetes_model', version=5)</span><span id="191b" class="nh kk it ok b gy ou oq l or os">from azureml.core import Environment<br/>env = Environment.get(workspace = ws, name = 'diabetes-env', version = 1)</span></pre><ul class=""><li id="b475" class="mt mu it ld b le mo lh mp lk mv lo mw ls mx lw oa mz na nb bi translated">定义工作空间</li><li id="3965" class="mt mu it ld b le nc lh nd lk ne lo nf ls ng lw oa mz na nb bi translated">从模型注册表中检索模型</li><li id="a1c4" class="mt mu it ld b le nc lh nd lk ne lo nf ls ng lw oa mz na nb bi translated">检索我们以前从环境注册表中注册的环境</li></ul><p id="ae66" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu">定义推理配置</strong></p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="f5f2" class="nh kk it ok b gy op oq l or os">from azureml.core.model import InferenceConfig<br/>inference_config = InferenceConfig(<br/>    environment=env,<br/>    source_directory=".",<br/>    entry_script="./score.py")</span></pre><p id="2f2e" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu">定义部署配置</strong></p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="e209" class="nh kk it ok b gy op oq l or os">from azureml.core.webservice import AciWebservice<br/>deployment_config = AciWebservice.deploy_configuration(cpu_cores=0.1, memory_gb=0.5, auth_enabled=True)</span></pre><p id="c030" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">我们向ACI服务分配资源，如<code class="fe oh oi oj ok b">cpu_cores</code>和<code class="fe oh oi oj ok b">memory_gb</code>。当<code class="fe oh oi oj ok b">auth_enabled</code>为<code class="fe oh oi oj ok b">True</code>时，调用API时，web服务需要一个认证密钥。</p><p id="7627" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated"><strong class="ld iu">部署ACI Webservice </strong></p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="5f4e" class="nh kk it ok b gy op oq l or os">service = Model.deploy(<br/>    workspace = ws,<br/>    name = 'diabetes-prediction-service',<br/>    models = [model],<br/>    inference_config = inference_config,<br/>    deployment_config = deployment_config,<br/>    overwrite=True)<br/>    <br/>service.wait_for_deployment(show_output=True)</span></pre><p id="e50e" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">当部署成功时，将显示以下消息:</p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="333a" class="nh kk it ok b gy op oq l or os">&gt;&gt; ACI service creation operation finished, operation "Succeeded"</span></pre><p id="b659" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">要得到得分的URI:</p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="6f8f" class="nh kk it ok b gy op oq l or os">print (service.scoring_uri)</span><span id="fa31" class="nh kk it ok b gy ou oq l or os">&gt;&gt; &lt;http://7aa232e8-4b0b-4533-8a84-13f1ad3e350a.eastus.azurecontainer.io/score&gt;</span></pre><p id="362f" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">要获取身份验证密钥:</p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="f7a8" class="nh kk it ok b gy op oq l or os">print (service.get_keys())</span><span id="f524" class="nh kk it ok b gy ou oq l or os">&gt;&gt; ('MbrPwtQCkQqGBVcg9SjKCwJjsL3FMFFN', 'bgauLDXRyBMqvL7tBnbLAgTLtLMP7mqe')</span></pre><p id="ac09" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">或者，我们也可以从Azure机器学习的“端点”选项卡中获取评分URI和认证密钥。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi pb"><img src="../Images/5ae6453a78ba3d3b82f2483f8b9aadaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LM5mXvsBoWDV8eyQ"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">作者图片</p></figure><h2 id="cd01" class="nh kk it bd kl ni nj dn kp nk nl dp kt lk nm nn kv lo no np kx ls nq nr kz ns bi translated">4.7.测试ACI服务</h2><p id="0430" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">部署完模型后，让我们再次使用<code class="fe oh oi oj ok b">inference_test.ipynb</code>来测试ACI webservice。更改以下参数，其余代码与本地测试相同。</p><pre class="ly lz ma mb gt ol ok om on aw oo bi"><span id="edf7" class="nh kk it ok b gy op oq l or os">local_deployment = False<br/>scoring_uri = '&lt;http://7aa232e8-4b0b-4533-8a84-13f1ad3e350a.eastus.azurecontainer.io/score&gt;'<br/>api_key = 'MbrPwtQCkQqGBVcg9SjKCwJjsL3FMFFN'</span></pre><p id="8b98" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">ACI的价格表可在<a class="ae mn" href="https://azure.microsoft.com/en-us/pricing/details/container-instances/" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><h1 id="43f4" class="kj kk it bd kl km kn ko kp kq kr ks kt jz ku ka kv kc kw kd kx kf ky kg kz la bi translated">5.摘要</h1><p id="9a74" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">在本文中，我们研究了以下内容:</p><ul class=""><li id="acc6" class="mt mu it ld b le mo lh mp lk mv lo mw ls mx lw oa mz na nb bi translated">在本地训练scikit-learn模型</li><li id="0e94" class="mt mu it ld b le nc lh nd lk ne lo nf ls ng lw oa mz na nb bi translated">在Azure机器学习上跟踪MLFlow的scikit-learn实验</li><li id="ee22" class="mt mu it ld b le nc lh nd lk ne lo nf ls ng lw oa mz na nb bi translated">在Azure机器学习上注册模型</li><li id="174b" class="mt mu it ld b le nc lh nd lk ne lo nf ls ng lw oa mz na nb bi translated">将模型作为本地web服务进行部署和测试</li><li id="45e7" class="mt mu it ld b le nc lh nd lk ne lo nf ls ng lw oa mz na nb bi translated">将模型作为ACI服务进行部署和测试</li></ul><p id="b0ba" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">ACI建议用于测试或小型生产工作负载。对于大型工作负载，请查看<a class="ae mn" href="https://docs.microsoft.com/en-us/azure/machine-learning/how-to-deploy-azure-kubernetes-service" rel="noopener ugc nofollow" target="_blank">如何部署到您的模型Azure Kubernetes服务</a>。</p><h1 id="6127" class="kj kk it bd kl km kn ko kp kq kr ks kt jz ku ka kv kc kw kd kx kf ky kg kz la bi translated">6.参考</h1><p id="43b4" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">[1] <a class="ae mn" href="https://mlflow.org/" rel="noopener ugc nofollow" target="_blank"> MLFlow </a></p><p id="906e" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">[2] <a class="ae mn" href="https://docs.microsoft.com/en-us/azure/machine-learning/overview-what-is-azure-machine-learning" rel="noopener ugc nofollow" target="_blank"> Azure机器学习</a></p><p id="c8fe" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">[3] <a class="ae mn" href="https://docs.microsoft.com/en-us/azure/container-instances/" rel="noopener ugc nofollow" target="_blank"> Azure容器实例</a></p><p id="ecdb" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">[4] <a class="ae mn" href="https://docs.microsoft.com/en-us/azure/machine-learning/concept-workspace" rel="noopener ugc nofollow" target="_blank"> Azure机器学习工作区</a></p><p id="f064" class="pw-post-body-paragraph lb lc it ld b le mo ju lg lh mp jx lj lk mq lm ln lo mr lq lr ls ms lu lv lw im bi translated">[5] <a class="ae mn" href="https://www.kaggle.com/uciml/pima-indians-diabetes-database" rel="noopener ugc nofollow" target="_blank">皮马印第安人糖尿病数据集</a>，特许CC0公共领域</p></div></div>    
</body>
</html>